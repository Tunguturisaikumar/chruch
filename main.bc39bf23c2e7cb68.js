(self.webpackChunkchruch_project=self.webpackChunkchruch_project||[]).push([[792],{165:(pv,cf,uf)=>{"use strict";function er(e){return"function"==typeof e}function Xg(e){const n=e(s=>{Error.call(s),s.stack=(new Error).stack});return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}const mv=Xg(e=>function(n){e(this),this.message=n?`${n.length} errors occurred during unsubscription:\n${n.map((s,d)=>`${d+1}) ${s.toString()}`).join("\n  ")}`:"",this.name="UnsubscriptionError",this.errors=n});function u(e,t){if(e){const n=e.indexOf(t);0<=n&&e.splice(n,1)}}class tr{constructor(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let t;if(!this.closed){this.closed=!0;const{_parentage:n}=this;if(n)if(this._parentage=null,Array.isArray(n))for(const _ of n)_.remove(this);else n.remove(this);const{initialTeardown:s}=this;if(er(s))try{s()}catch(_){t=_ instanceof mv?_.errors:[_]}const{_finalizers:d}=this;if(d){this._finalizers=null;for(const _ of d)try{kd(_)}catch(E){t=t??[],E instanceof mv?t=[...t,...E.errors]:t.push(E)}}if(t)throw new mv(t)}}add(t){var n;if(t&&t!==this)if(this.closed)kd(t);else{if(t instanceof tr){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(n=this._finalizers)&&void 0!==n?n:[]).push(t)}}_hasParent(t){const{_parentage:n}=this;return n===t||Array.isArray(n)&&n.includes(t)}_addParent(t){const{_parentage:n}=this;this._parentage=Array.isArray(n)?(n.push(t),n):n?[n,t]:t}_removeParent(t){const{_parentage:n}=this;n===t?this._parentage=null:Array.isArray(n)&&u(n,t)}remove(t){const{_finalizers:n}=this;n&&u(n,t),t instanceof tr&&t._removeParent(this)}}tr.EMPTY=(()=>{const e=new tr;return e.closed=!0,e})();const ji=tr.EMPTY;function Ca(e){return e instanceof tr||e&&"closed"in e&&er(e.remove)&&er(e.add)&&er(e.unsubscribe)}function kd(e){er(e)?e():e.unsubscribe()}const Fs={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},ks={setTimeout(e,t,...n){const{delegate:s}=ks;return s?.setTimeout?s.setTimeout(e,t,...n):setTimeout(e,t,...n)},clearTimeout(e){const{delegate:t}=ks;return(t?.clearTimeout||clearTimeout)(e)},delegate:void 0};function Nl(e){ks.setTimeout(()=>{const{onUnhandledError:t}=Fs;if(!t)throw e;t(e)})}function fn(){}const es=ro("C",void 0,void 0);function ro(e,t,n){return{kind:e,value:t,error:n}}let ys=null;function Ws(e){if(Fs.useDeprecatedSynchronousErrorHandling){const t=!ys;if(t&&(ys={errorThrown:!1,error:null}),e(),t){const{errorThrown:n,error:s}=ys;if(ys=null,n)throw s}}else e()}class Bl extends tr{constructor(t){super(),this.isStopped=!1,t?(this.destination=t,Ca(t)&&t.add(this)):this.destination=gr}static create(t,n,s){return new Un(t,n,s)}next(t){this.isStopped?mr(function jo(e){return ro("N",e,void 0)}(t),this):this._next(t)}error(t){this.isStopped?mr(function Ui(e){return ro("E",void 0,e)}(t),this):(this.isStopped=!0,this._error(t))}complete(){this.isStopped?mr(es,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(t){this.destination.next(t)}_error(t){try{this.destination.error(t)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}}const da=Function.prototype.bind;function Ia(e,t){return da.call(e,t)}class df{constructor(t){this.partialObserver=t}next(t){const{partialObserver:n}=this;if(n.next)try{n.next(t)}catch(s){qa(s)}}error(t){const{partialObserver:n}=this;if(n.error)try{n.error(t)}catch(s){qa(s)}else qa(t)}complete(){const{partialObserver:t}=this;if(t.complete)try{t.complete()}catch(n){qa(n)}}}class Un extends Bl{constructor(t,n,s){let d;if(super(),er(t)||!t)d={next:t??void 0,error:n??void 0,complete:s??void 0};else{let _;this&&Fs.useDeprecatedNextContext?(_=Object.create(t),_.unsubscribe=()=>this.unsubscribe(),d={next:t.next&&Ia(t.next,_),error:t.error&&Ia(t.error,_),complete:t.complete&&Ia(t.complete,_)}):d=t}this.destination=new df(d)}}function qa(e){Fs.useDeprecatedSynchronousErrorHandling?function zl(e){Fs.useDeprecatedSynchronousErrorHandling&&ys&&(ys.errorThrown=!0,ys.error=e)}(e):Nl(e)}function mr(e,t){const{onStoppedNotification:n}=Fs;n&&ks.setTimeout(()=>n(e,t))}const gr={closed:!0,next:fn,error:function go(e){throw e},complete:fn},Fi="function"==typeof Symbol&&Symbol.observable||"@@observable";function oo(e){return e}let Hi=(()=>{class e{constructor(n){n&&(this._subscribe=n)}lift(n){const s=new e;return s.source=this,s.operator=n,s}subscribe(n,s,d){const _=function Cu(e){return e&&e instanceof Bl||function Uo(e){return e&&er(e.next)&&er(e.error)&&er(e.complete)}(e)&&Ca(e)}(n)?n:new Un(n,s,d);return Ws(()=>{const{operator:E,source:S}=this;_.add(E?E.call(_,S):S?this._subscribe(_):this._trySubscribe(_))}),_}_trySubscribe(n){try{return this._subscribe(n)}catch(s){n.error(s)}}forEach(n,s){return new(s=ki(s))((d,_)=>{const E=new Un({next:S=>{try{n(S)}catch(R){_(R),E.unsubscribe()}},error:_,complete:d});this.subscribe(E)})}_subscribe(n){var s;return null===(s=this.source)||void 0===s?void 0:s.subscribe(n)}[Fi](){return this}pipe(...n){return function Aa(e){return 0===e.length?oo:1===e.length?e[0]:function(n){return e.reduce((s,d)=>d(s),n)}}(n)(this)}toPromise(n){return new(n=ki(n))((s,d)=>{let _;this.subscribe(E=>_=E,E=>d(E),()=>s(_))})}}return e.create=t=>new e(t),e})();function ki(e){var t;return null!==(t=e??Fs.Promise)&&void 0!==t?t:Promise}const ff=Xg(e=>function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});let Gi=(()=>{class e extends Hi{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(n){const s=new Mi(this,this);return s.operator=n,s}_throwIfClosed(){if(this.closed)throw new ff}next(n){Ws(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(const s of this.currentObservers)s.next(n)}})}error(n){Ws(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=n;const{observers:s}=this;for(;s.length;)s.shift().error(n)}})}complete(){Ws(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;const{observers:n}=this;for(;n.length;)n.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var n;return(null===(n=this.observers)||void 0===n?void 0:n.length)>0}_trySubscribe(n){return this._throwIfClosed(),super._trySubscribe(n)}_subscribe(n){return this._throwIfClosed(),this._checkFinalizedStatuses(n),this._innerSubscribe(n)}_innerSubscribe(n){const{hasError:s,isStopped:d,observers:_}=this;return s||d?ji:(this.currentObservers=null,_.push(n),new tr(()=>{this.currentObservers=null,u(_,n)}))}_checkFinalizedStatuses(n){const{hasError:s,thrownError:d,isStopped:_}=this;s?n.error(d):_&&n.complete()}asObservable(){const n=new Hi;return n.source=this,n}}return e.create=(t,n)=>new Mi(t,n),e})();class Mi extends Gi{constructor(t,n){super(),this.destination=t,this.source=n}next(t){var n,s;null===(s=null===(n=this.destination)||void 0===n?void 0:n.next)||void 0===s||s.call(n,t)}error(t){var n,s;null===(s=null===(n=this.destination)||void 0===n?void 0:n.error)||void 0===s||s.call(n,t)}complete(){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.complete)||void 0===n||n.call(t)}_subscribe(t){var n,s;return null!==(s=null===(n=this.source)||void 0===n?void 0:n.subscribe(t))&&void 0!==s?s:ji}}function vi(e){return t=>{if(function ar(e){return er(e?.lift)}(t))return t.lift(function(n){try{return e(n,this)}catch(s){this.error(s)}});throw new TypeError("Unable to lift unknown Observable type")}}function nr(e,t,n,s,d){return new lr(e,t,n,s,d)}class lr extends Bl{constructor(t,n,s,d,_,E){super(t),this.onFinalize=_,this.shouldUnsubscribe=E,this._next=n?function(S){try{n(S)}catch(R){t.error(R)}}:super._next,this._error=d?function(S){try{d(S)}catch(R){t.error(R)}finally{this.unsubscribe()}}:super._error,this._complete=s?function(){try{s()}catch(S){t.error(S)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){const{closed:n}=this;super.unsubscribe(),!n&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}}}function Ls(e,t){return vi((n,s)=>{let d=0;n.subscribe(nr(s,_=>{s.next(e.call(t,_,d++))}))})}function Zr(e){return this instanceof Zr?(this.v=e,this):new Zr(e)}function Qa(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,t=e[Symbol.asyncIterator];return t?t.call(e):(e=function is(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],s=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n);function s(_){n[_]=e[_]&&function(E){return new Promise(function(S,R){!function d(_,E,S,R){Promise.resolve(R).then(function(z){_({value:z,done:S})},E)}(S,R,(E=e[_](E)).done,E.value)})}}}"function"==typeof SuppressedError&&SuppressedError;const Rn=e=>e&&"number"==typeof e.length&&"function"!=typeof e;function Pe(e){return er(e?.then)}function Z(e){return er(e[Fi])}function X(e){return Symbol.asyncIterator&&er(e?.[Symbol.asyncIterator])}function oe(e){return new TypeError(`You provided ${null!==e&&"object"==typeof e?"an invalid object":`'${e}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}const se=function ge(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}();function be(e){return er(e?.[se])}function ke(e){return function Ya(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var d,s=n.apply(e,t||[]),_=[];return d=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),S("next"),S("throw"),S("return",function E(ve){return function(Oe){return Promise.resolve(Oe).then(ve,J)}}),d[Symbol.asyncIterator]=function(){return this},d;function S(ve,Oe){s[ve]&&(d[ve]=function(He){return new Promise(function(mt,Rt){_.push([ve,He,mt,Rt])>1||R(ve,He)})},Oe&&(d[ve]=Oe(d[ve])))}function R(ve,Oe){try{!function z(ve){ve.value instanceof Zr?Promise.resolve(ve.value.v).then($,J):we(_[0][2],ve)}(s[ve](Oe))}catch(He){we(_[0][3],He)}}function $(ve){R("next",ve)}function J(ve){R("throw",ve)}function we(ve,Oe){ve(Oe),_.shift(),_.length&&R(_[0][0],_[0][1])}}(this,arguments,function*(){const n=e.getReader();try{for(;;){const{value:s,done:d}=yield Zr(n.read());if(d)return yield Zr(void 0);yield yield Zr(s)}}finally{n.releaseLock()}})}function Te(e){return er(e?.getReader)}function Ie(e){if(e instanceof Hi)return e;if(null!=e){if(Z(e))return function st(e){return new Hi(t=>{const n=e[Fi]();if(er(n.subscribe))return n.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}(e);if(Rn(e))return function qe(e){return new Hi(t=>{for(let n=0;n<e.length&&!t.closed;n++)t.next(e[n]);t.complete()})}(e);if(Pe(e))return function Lt(e){return new Hi(t=>{e.then(n=>{t.closed||(t.next(n),t.complete())},n=>t.error(n)).then(null,Nl)})}(e);if(X(e))return Zt(e);if(be(e))return function $t(e){return new Hi(t=>{for(const n of e)if(t.next(n),t.closed)return;t.complete()})}(e);if(Te(e))return function bn(e){return Zt(ke(e))}(e)}throw oe(e)}function Zt(e){return new Hi(t=>{(function pn(e,t){var n,s,d,_;return function Pa(e,t,n,s){return new(n||(n=Promise))(function(_,E){function S($){try{z(s.next($))}catch(J){E(J)}}function R($){try{z(s.throw($))}catch(J){E(J)}}function z($){$.done?_($.value):function d(_){return _ instanceof n?_:new n(function(E){E(_)})}($.value).then(S,R)}z((s=s.apply(e,t||[])).next())})}(this,void 0,void 0,function*(){try{for(n=Qa(e);!(s=yield n.next()).done;)if(t.next(s.value),t.closed)return}catch(E){d={error:E}}finally{try{s&&!s.done&&(_=n.return)&&(yield _.call(n))}finally{if(d)throw d.error}}t.complete()})})(e,t).catch(n=>t.error(n))})}function cn(e,t,n,s=0,d=!1){const _=t.schedule(function(){n(),d?e.add(this.schedule(null,s)):this.unsubscribe()},s);if(e.add(_),!d)return _}function yn(e,t,n=1/0){return er(t)?yn((s,d)=>Ls((_,E)=>t(s,_,d,E))(Ie(e(s,d))),n):("number"==typeof t&&(n=t),vi((s,d)=>function mi(e,t,n,s,d,_,E,S){const R=[];let z=0,$=0,J=!1;const we=()=>{J&&!R.length&&!z&&t.complete()},ve=He=>z<s?Oe(He):R.push(He),Oe=He=>{_&&t.next(He),z++;let mt=!1;Ie(n(He,$++)).subscribe(nr(t,Rt=>{d?.(Rt),_?ve(Rt):t.next(Rt)},()=>{mt=!0},void 0,()=>{if(mt)try{for(z--;R.length&&z<s;){const Rt=R.shift();E?cn(t,E,()=>Oe(Rt)):Oe(Rt)}we()}catch(Rt){t.error(Rt)}}))};return e.subscribe(nr(t,ve,()=>{J=!0,we()})),()=>{S?.()}}(s,d,e,n)))}function ir(e=1/0){return yn(oo,e)}const Cr=new Hi(e=>e.complete());function Vn(e){return e&&er(e.schedule)}function $i(e){return e[e.length-1]}function Vi(e){return er($i(e))?e.pop():void 0}function Si(e){return Vn($i(e))?e.pop():void 0}function Ho(e,t=0){return vi((n,s)=>{n.subscribe(nr(s,d=>cn(s,e,()=>s.next(d),t),()=>cn(s,e,()=>s.complete(),t),d=>cn(s,e,()=>s.error(d),t)))})}function _o(e,t=0){return vi((n,s)=>{s.add(e.schedule(()=>n.subscribe(s),t))})}function Ru(e,t){if(!e)throw new Error("Iterable cannot be null");return new Hi(n=>{cn(n,t,()=>{const s=e[Symbol.asyncIterator]();cn(n,t,()=>{s.next().then(d=>{d.done?n.complete():n.next(d.value)})},0,!0)})})}function el(e,t){return t?function gf(e,t){if(null!=e){if(Z(e))return function jd(e,t){return Ie(e).pipe(_o(t),Ho(t))}(e,t);if(Rn(e))return function Hl(e,t){return new Hi(n=>{let s=0;return t.schedule(function(){s===e.length?n.complete():(n.next(e[s++]),n.closed||this.schedule())})})}(e,t);if(Pe(e))return function so(e,t){return Ie(e).pipe(_o(t),Ho(t))}(e,t);if(X(e))return Ru(e,t);if(be(e))return function mf(e,t){return new Hi(n=>{let s;return cn(n,t,()=>{s=e[se](),cn(n,t,()=>{let d,_;try{({value:d,done:_}=s.next())}catch(E){return void n.error(E)}_?n.complete():n.next(d)},0,!0)}),()=>er(s?.return)&&s.return()})}(e,t);if(Te(e))return function Ud(e,t){return Ru(ke(e),t)}(e,t)}throw oe(e)}(e,t):Ie(e)}function tl(...e){const t=Si(e),n=function Xr(e,t){return"number"==typeof $i(e)?e.pop():t}(e,1/0),s=e;return s.length?1===s.length?Ie(s[0]):ir(n)(el(s,t)):Cr}class Ou extends Gi{constructor(t){super(),this._value=t}get value(){return this.getValue()}_subscribe(t){const n=super._subscribe(t);return!n.closed&&t.next(this._value),n}getValue(){const{hasError:t,thrownError:n,_value:s}=this;if(t)throw n;return this._throwIfClosed(),s}next(t){super.next(this._value=t)}}function Dc(...e){return el(e,Si(e))}function Zs(e={}){const{connector:t=(()=>new Gi),resetOnError:n=!0,resetOnComplete:s=!0,resetOnRefCountZero:d=!0}=e;return _=>{let E,S,R,z=0,$=!1,J=!1;const we=()=>{S?.unsubscribe(),S=void 0},ve=()=>{we(),E=R=void 0,$=J=!1},Oe=()=>{const He=E;ve(),He?.unsubscribe()};return vi((He,mt)=>{z++,!J&&!$&&we();const Rt=R=R??t();mt.add(()=>{z--,0===z&&!J&&!$&&(S=rs(Oe,d))}),Rt.subscribe(mt),!E&&z>0&&(E=new Un({next:dt=>Rt.next(dt),error:dt=>{J=!0,we(),S=rs(ve,n,dt),Rt.error(dt)},complete:()=>{$=!0,we(),S=rs(ve,s),Rt.complete()}}),Ie(He).subscribe(E))})(_)}}function rs(e,t,...n){if(!0===t)return void e();if(!1===t)return;const s=new Un({next:()=>{s.unsubscribe(),e()}});return Ie(t(...n)).subscribe(s)}function Ra(e,t=oo){return e=e??ha,vi((n,s)=>{let d,_=!0;n.subscribe(nr(s,E=>{const S=t(E);(_||!e(d,S))&&(_=!1,d=S,s.next(E))}))})}function ha(e,t){return e===t}function Ci(e){for(let t in e)if(e[t]===Ci)return t;throw Error("Could not find renamed property on target object.")}function Gl(e,t){for(const n in t)t.hasOwnProperty(n)&&!e.hasOwnProperty(n)&&(e[n]=t[n])}function ur(e){if("string"==typeof e)return e;if(Array.isArray(e))return"["+e.map(ur).join(", ")+"]";if(null==e)return""+e;if(e.overriddenName)return`${e.overriddenName}`;if(e.name)return`${e.name}`;const t=e.toString();if(null==t)return""+t;const n=t.indexOf("\n");return-1===n?t:t.substring(0,n)}function Sc(e,t){return null==e||""===e?null===t?"":t:null==t||""===t?e:e+" "+t}const Cc=Ci({__forward_ref__:Ci});function Yi(e){return e.__forward_ref__=Yi,e.toString=function(){return ur(this())},e}function Nn(e){return Hd(e)?e():e}function Hd(e){return"function"==typeof e&&e.hasOwnProperty(Cc)&&e.__forward_ref__===Yi}function Po(e){return e&&!!e.\u0275providers}class wt extends Error{constructor(t,n){super(function Gd(e,t){return`NG0${Math.abs(e)}${t?": "+t:""}`}(t,n)),this.code=t}}function qn(e){return"string"==typeof e?e:null==e?"":String(e)}function Ic(e,t){throw new wt(-201,!1)}function Yr(e,t){null==e&&function _n(e,t,n,s){throw new Error(`ASSERTION ERROR: ${e}`+(null==s?"":` [Expected=> ${n} ${s} ${t} <=Actual]`))}(t,e,null,"!=")}function Jt(e){return{token:e.token,providedIn:e.providedIn||null,factory:e.factory,value:void 0}}function Ir(e){return{providers:e.providers||[],imports:e.imports||[]}}function zu(e){return Bu(e,Nt)||Bu(e,ju)}function Bu(e,t){return e.hasOwnProperty(t)?e[t]:null}function Zd(e){return e&&(e.hasOwnProperty(yf)||e.hasOwnProperty(Rc))?e[yf]:null}const Nt=Ci({\u0275prov:Ci}),yf=Ci({\u0275inj:Ci}),ju=Ci({ngInjectableDef:Ci}),Rc=Ci({ngInjectorDef:Ci});var Hn=function(e){return e[e.Default=0]="Default",e[e.Host=1]="Host",e[e.Self=2]="Self",e[e.SkipSelf=4]="SkipSelf",e[e.Optional=8]="Optional",e}(Hn||{});let Xd;function Tt(e){const t=Xd;return Xd=e,t}function Gn(e,t,n){const s=zu(e);return s&&"root"==s.providedIn?void 0===s.value?s.value=s.factory():s.value:n&Hn.Optional?null:void 0!==t?t:void Ic(ur(e))}const gi=globalThis;class Xt{constructor(t,n){this._desc=t,this.ngMetadataName="InjectionToken",this.\u0275prov=void 0,"number"==typeof n?this.__NG_ELEMENT_ID__=n:void 0!==n&&(this.\u0275prov=Jt({token:this,providedIn:n.providedIn||"root",factory:n.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}}const Kr={},pa="__NG_DI_FLAG__",vo="ngTempTokenPath",an=/\n/gm,Vs="__source";let Vt;function Ys(e){const t=Vt;return Vt=e,t}function Bt(e,t=Hn.Default){if(void 0===Vt)throw new wt(-203,!1);return null===Vt?Gn(e,void 0,t):Vt.get(e,t&Hn.Optional?null:void 0,t)}function gt(e,t=Hn.Default){return(function Oc(){return Xd}()||Bt)(Nn(e),t)}function ui(e,t=Hn.Default){return gt(e,Yd(t))}function Yd(e){return typeof e>"u"||"number"==typeof e?e:0|(e.optional&&8)|(e.host&&1)|(e.self&&2)|(e.skipSelf&&4)}function bs(e){const t=[];for(let n=0;n<e.length;n++){const s=Nn(e[n]);if(Array.isArray(s)){if(0===s.length)throw new wt(900,!1);let d,_=Hn.Default;for(let E=0;E<s.length;E++){const S=s[E],R=Kd(S);"number"==typeof R?-1===R?d=S.token:_|=R:d=S}t.push(gt(d,_))}else t.push(gt(s))}return t}function Kd(e){return e[pa]}function xo(e){return{toString:e}.toString()}var eo=function(e){return e[e.OnPush=0]="OnPush",e[e.Default=1]="Default",e}(eo||{}),Go=function(e){return e[e.Emulated=0]="Emulated",e[e.None=2]="None",e[e.ShadowDom=3]="ShadowDom",e}(Go||{});const Oa={},qi=[],ma=Ci({\u0275cmp:Ci}),Wl=Ci({\u0275dir:Ci}),nl=Ci({\u0275pipe:Ci}),Bc=Ci({\u0275mod:Ci}),Fa=Ci({\u0275fac:Ci}),Zl=Ci({__NG_ELEMENT_ID__:Ci}),bf=Ci({__NG_ENV_ID__:Ci});function il(e,t,n){let s=e.length;for(;;){const d=e.indexOf(t,n);if(-1===d)return d;if(0===d||e.charCodeAt(d-1)<=32){const _=t.length;if(d+_===s||e.charCodeAt(d+_)<=32)return d}n=d+1}}function Kp(e,t,n){let s=0;for(;s<n.length;){const d=n[s];if("number"==typeof d){if(0!==d)break;s++;const _=n[s++],E=n[s++],S=n[s++];e.setAttribute(t,E,S,_)}else{const _=d,E=n[++s];Jg(_)?e.setProperty(t,_,E):e.setAttribute(t,_,E),s++}}return s}function Qp(e){return 3===e||4===e||6===e}function Jg(e){return 64===e.charCodeAt(0)}function Uu(e,t){if(null!==t&&0!==t.length)if(null===e||0===e.length)e=t.slice();else{let n=-1;for(let s=0;s<t.length;s++){const d=t[s];"number"==typeof d?n=d:0===n||Jp(e,n,d,null,-1===n||2===n?t[++s]:null)}}return e}function Jp(e,t,n,s,d){let _=0,E=e.length;if(-1===t)E=-1;else for(;_<e.length;){const S=e[_++];if("number"==typeof S){if(S===t){E=-1;break}if(S>t){E=_-1;break}}}for(;_<e.length;){const S=e[_];if("number"==typeof S)break;if(S===n){if(null===s)return void(null!==d&&(e[_+1]=d));if(s===e[_+1])return void(e[_+2]=d)}_++,null!==s&&_++,null!==d&&_++}-1!==E&&(e.splice(E,0,t),_=E+1),e.splice(_++,0,n),null!==s&&e.splice(_++,0,s),null!==d&&e.splice(_++,0,d)}const wf="ng-template";function Xl(e,t,n){let s=0,d=!0;for(;s<e.length;){let _=e[s++];if("string"==typeof _&&d){const E=e[s++];if(n&&"class"===_&&-1!==il(E.toLowerCase(),t,0))return!0}else{if(1===_){for(;s<e.length&&"string"==typeof(_=e[s++]);)if(_.toLowerCase()===t)return!0;return!1}"number"==typeof _&&(d=!1)}}return!1}function em(e){return 4===e.type&&e.value!==wf}function e_(e,t,n){return t===(4!==e.type||n?e.value:wf)}function Ef(e,t,n){let s=4;const d=e.attrs||[],_=function Hu(e){for(let t=0;t<e.length;t++)if(Qp(e[t]))return t;return e.length}(d);let E=!1;for(let S=0;S<t.length;S++){const R=t[S];if("number"!=typeof R){if(!E)if(4&s){if(s=2|1&s,""!==R&&!e_(e,R,n)||""===R&&1===t.length){if(bo(s))return!1;E=!0}}else{const z=8&s?R:t[++S];if(8&s&&null!==e.attrs){if(!Xl(e.attrs,z,n)){if(bo(s))return!1;E=!0}continue}const J=Qd(8&s?"class":R,d,em(e),n);if(-1===J){if(bo(s))return!1;E=!0;continue}if(""!==z){let we;we=J>_?"":d[J+1].toLowerCase();const ve=8&s?we:null;if(ve&&-1!==il(ve,z,0)||2&s&&z!==we){if(bo(s))return!1;E=!0}}}}else{if(!E&&!bo(s)&&!bo(R))return!1;if(E&&bo(R))continue;E=!1,s=R|1&s}}return bo(s)||E}function bo(e){return 0==(1&e)}function Qd(e,t,n,s){if(null===t)return-1;let d=0;if(s||!n){let _=!1;for(;d<t.length;){const E=t[d];if(E===e)return d;if(3===E||6===E)_=!0;else{if(1===E||2===E){let S=t[++d];for(;"string"==typeof S;)S=t[++d];continue}if(4===E)break;if(0===E){d+=4;continue}}d+=_?1:2}return-1}return function Gu(e,t){let n=e.indexOf(4);if(n>-1)for(n++;n<e.length;){const s=e[n];if("number"==typeof s)return-1;if(s===t)return n;n++}return-1}(t,e)}function js(e,t,n=!1){for(let s=0;s<t.length;s++)if(Ef(e,t[s],n))return!0;return!1}function Jd(e,t){return e?":not("+t.trim()+")":t}function Us(e){let t=e[0],n=1,s=2,d="",_=!1;for(;n<e.length;){let E=e[n];if("string"==typeof E)if(2&s){const S=e[++n];d+="["+E+(S.length>0?'="'+S+'"':"")+"]"}else 8&s?d+="."+E:4&s&&(d+=" "+E);else""!==d&&!bo(E)&&(t+=Jd(_,d),d=""),s=E,_=_||!bo(s);n++}return""!==d&&(t+=Jd(_,d)),t}function Yl(e){return xo(()=>{const t=Cf(e),n={...t,decls:e.decls,vars:e.vars,template:e.template,consts:e.consts||null,ngContentSelectors:e.ngContentSelectors,onPush:e.changeDetection===eo.OnPush,directiveDefs:null,pipeDefs:null,dependencies:t.standalone&&e.dependencies||null,getStandaloneInjector:null,signals:e.signals??!1,data:e.data||{},encapsulation:e.encapsulation||Go.Emulated,styles:e.styles||qi,_:null,schemas:e.schemas||null,tView:null,id:""};im(n);const s=e.dependencies;return n.directiveDefs=Ii(s,!1),n.pipeDefs=Ii(s,!0),n.id=function bv(e){let t=0;const n=[e.selectors,e.ngContentSelectors,e.hostVars,e.hostAttrs,e.consts,e.vars,e.decls,e.encapsulation,e.standalone,e.signals,e.exportAs,JSON.stringify(e.inputs),JSON.stringify(e.outputs),Object.getOwnPropertyNames(e.type.prototype),!!e.contentQueries,!!e.viewQuery].join("|");for(const d of n)t=Math.imul(31,t)+d.charCodeAt(0)<<0;return t+=2147483648,"c"+t}(n),n})}function Sf(e){return Jn(e)||nn(e)}function eh(e){return null!==e}function _r(e){return xo(()=>({type:e.type,bootstrap:e.bootstrap||qi,declarations:e.declarations||qi,imports:e.imports||qi,exports:e.exports||qi,transitiveCompileScopes:null,schemas:e.schemas||null,id:e.id||null}))}function th(e,t){if(null==e)return Oa;const n={};for(const s in e)if(e.hasOwnProperty(s)){let d=e[s],_=d;Array.isArray(d)&&(_=d[1],d=d[0]),n[d]=s,t&&(t[d]=_)}return n}function Dn(e){return xo(()=>{const t=Cf(e);return im(t),t})}function Jn(e){return e[ma]||null}function nn(e){return e[Wl]||null}function os(e){return e[nl]||null}function Cf(e){const t={};return{type:e.type,providersResolver:null,factory:null,hostBindings:e.hostBindings||null,hostVars:e.hostVars||0,hostAttrs:e.hostAttrs||null,contentQueries:e.contentQueries||null,declaredInputs:t,inputTransforms:null,inputConfig:e.inputs||Oa,exportAs:e.exportAs||null,standalone:!0===e.standalone,signals:!0===e.signals,selectors:e.selectors||qi,viewQuery:e.viewQuery||null,features:e.features||null,setInput:null,findHostDirectiveDefs:null,hostDirectives:null,inputs:th(e.inputs,t),outputs:th(e.outputs)}}function im(e){e.features?.forEach(t=>t(e))}function Ii(e,t){if(!e)return null;const n=t?os:Sf;return()=>("function"==typeof e?e():e).map(s=>n(s)).filter(eh)}const zr=0,Qt=1,ei=2,Or=3,ws=4,nh=5,Ro=6,Kl=7,Fr=8,ka=9,Qs=10,Fn=11,Ql=12,ih=13,ga=14,Br=15,jc=16,Uc=17,ss=18,Jl=19,rh=20,La=21,Js=22,rl=23,$u=24,xi=25,ec=1,rm=2,ea=7,Hc=9,ao=11;function Oo(e){return Array.isArray(e)&&"object"==typeof e[ec]}function Fo(e){return Array.isArray(e)&&!0===e[ec]}function ol(e){return 0!=(4&e.flags)}function tc(e){return e.componentOffset>-1}function sl(e){return 1==(1&e.flags)}function as(e){return!!e.template}function qu(e){return 0!=(512&e[ei])}function al(e,t){return e.hasOwnProperty(Fa)?e[Fa]:null}let Eo=null,lh=!1;function cs(e){const t=Eo;return Eo=e,t}const cl={version:0,dirty:!1,producerNode:void 0,producerLastReadVersion:void 0,producerIndexOfThis:void 0,nextProducerIndex:0,liveConsumerNode:void 0,liveConsumerIndexOfThis:void 0,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{}};function ul(e){if(!$c(e)||e.dirty){if(!e.producerMustRecompute(e)&&!ch(e))return void(e.dirty=!1);e.producerRecomputeValue(e),e.dirty=!1}}function dm(e){e.dirty=!0,function dl(e){if(void 0===e.liveConsumerNode)return;const t=lh;lh=!0;try{for(const n of e.liveConsumerNode)n.dirty||dm(n)}finally{lh=t}}(e),e.consumerMarkedDirty?.(e)}function Pf(e){return e&&(e.nextProducerIndex=0),cs(e)}function Xu(e,t){if(cs(t),e&&void 0!==e.producerNode&&void 0!==e.producerIndexOfThis&&void 0!==e.producerLastReadVersion){if($c(e))for(let n=e.nextProducerIndex;n<e.producerNode.length;n++)Na(e.producerNode[n],e.producerIndexOfThis[n]);for(;e.producerNode.length>e.nextProducerIndex;)e.producerNode.pop(),e.producerLastReadVersion.pop(),e.producerIndexOfThis.pop()}}function ch(e){qc(e);for(let t=0;t<e.producerNode.length;t++){const n=e.producerNode[t],s=e.producerLastReadVersion[t];if(s!==n.version||(ul(n),s!==n.version))return!0}return!1}function hm(e){if(qc(e),$c(e))for(let t=0;t<e.producerNode.length;t++)Na(e.producerNode[t],e.producerIndexOfThis[t]);e.producerNode.length=e.producerLastReadVersion.length=e.producerIndexOfThis.length=0,e.liveConsumerNode&&(e.liveConsumerNode.length=e.liveConsumerIndexOfThis.length=0)}function Na(e,t){if(function fm(e){e.liveConsumerNode??=[],e.liveConsumerIndexOfThis??=[]}(e),qc(e),1===e.liveConsumerNode.length)for(let s=0;s<e.producerNode.length;s++)Na(e.producerNode[s],e.producerIndexOfThis[s]);const n=e.liveConsumerNode.length-1;if(e.liveConsumerNode[t]=e.liveConsumerNode[n],e.liveConsumerIndexOfThis[t]=e.liveConsumerIndexOfThis[n],e.liveConsumerNode.length--,e.liveConsumerIndexOfThis.length--,t<e.liveConsumerNode.length){const s=e.liveConsumerIndexOfThis[t],d=e.liveConsumerNode[t];qc(d),d.producerIndexOfThis[s]=t}}function $c(e){return e.consumerIsAlwaysLive||(e?.liveConsumerNode?.length??0)>0}function qc(e){e.producerNode??=[],e.producerIndexOfThis??=[],e.producerLastReadVersion??=[]}let Ff=null;const Lf=()=>{},Iv=(()=>({...cl,consumerIsAlwaysLive:!0,consumerAllowSignalWrites:!1,consumerMarkedDirty:e=>{e.schedule(e.ref)},hasRun:!1,cleanupFn:Lf}))();class Nf{constructor(t,n,s){this.previousValue=t,this.currentValue=n,this.firstChange=s}isFirstChange(){return this.firstChange}}function ta(){return pm}function pm(e){return e.type.prototype.ngOnChanges&&(e.setInput=Av),zf}function zf(){const e=us(this),t=e?.current;if(t){const n=e.previous;if(n===Oa)e.previous=t;else for(let s in t)n[s]=t[s];e.current=null,this.ngOnChanges(t)}}function Av(e,t,n,s){const d=this.declaredInputs[n],_=us(e)||function mm(e,t){return e[f_]=t}(e,{previous:Oa,current:null}),E=_.current||(_.current={}),S=_.previous,R=S[d];E[d]=new Nf(R&&R.currentValue,t,S===Oa),e[s]=t}ta.ngInherit=!0;const f_="__ngSimpleChanges__";function us(e){return e[f_]||null}const _a=function(e,t,n){};function dr(e){for(;Array.isArray(e);)e=e[zr];return e}function Gs(e,t){return dr(t[e])}function Tn(e,t){return dr(t[e.index])}function ph(e,t){return e.data[t]}function Es(e,t){const n=t[e];return Oo(n)?n:n[zr]}function Do(e,t){return null==t?null:e[t]}function it(e){e[Uc]=0}function _t(e){1024&e[ei]||(e[ei]|=1024,Ki(e,1))}function Yc(e){1024&e[ei]&&(e[ei]&=-1025,Ki(e,-1))}function Ki(e,t){let n=e[Or];if(null===n)return;n[nh]+=t;let s=n;for(n=n[Or];null!==n&&(1===t&&1===s[nh]||-1===t&&0===s[nh]);)n[nh]+=t,s=n,n=n[Or]}const Sn={lFrame:Jc(null),bindingsEnabled:!0,skipHydrationRootTNode:null};function ya(){return Sn.bindingsEnabled}function At(){return Sn.lFrame.lView}function bi(){return Sn.lFrame.tView}function ko(){let e=So();for(;null!==e&&64===e.type;)e=e.parent;return e}function So(){return Sn.lFrame.currentTNode}function Ts(e,t){const n=Sn.lFrame;n.currentTNode=e,n.isParent=t}function wi(){return Sn.lFrame.isParent}function oc(){return Sn.lFrame.bindingIndex++}function sc(e,t){const n=Sn.lFrame;n.bindingIndex=n.bindingRootIndex=e,nd(t)}function nd(e){Sn.lFrame.currentDirectiveIndex=e}function Qc(){return Sn.lFrame.currentQueryIndex}function Ba(e){Sn.lFrame.currentQueryIndex=e}function xm(e){const t=e[Qt];return 2===t.type?t.declTNode:1===t.type?e[Ro]:null}function va(e,t,n){if(n&Hn.SkipSelf){let d=t,_=e;for(;!(d=d.parent,null!==d||n&Hn.Host||(d=xm(_),null===d||(_=_[ga],10&d.type))););if(null===d)return!1;t=d,e=_}const s=Sn.lFrame=yh();return s.currentTNode=t,s.lView=e,!0}function _h(e){const t=yh(),n=e[Qt];Sn.lFrame=t,t.currentTNode=n.firstChild,t.lView=e,t.tView=n,t.contextLView=e,t.bindingIndex=n.bindingStartIndex,t.inI18n=!1}function yh(){const e=Sn.lFrame,t=null===e?null:e.child;return null===t?Jc(e):t}function Jc(e){const t={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:e,child:null,inI18n:!1};return null!==e&&(e.child=t),t}function eu(){const e=Sn.lFrame;return Sn.lFrame=e.parent,e.currentTNode=null,e.lView=null,e}const Pi=eu;function ac(){const e=eu();e.isParent=!0,e.tView=null,e.selectedIndex=-1,e.contextLView=null,e.elementDepthCount=0,e.currentDirectiveIndex=-1,e.currentNamespace=null,e.bindingRootIndex=-1,e.bindingIndex=-1,e.currentQueryIndex=0}function Hr(){return Sn.lFrame.selectedIndex}function pl(e){Sn.lFrame.selectedIndex=e}function yr(){const e=Sn.lFrame;return ph(e.tView,e.selectedIndex)}let tu=!0;function rd(){return tu}function xa(e){tu=e}function xh(e,t){for(let n=t.directiveStart,s=t.directiveEnd;n<s;n++){const _=e.data[n].type.prototype,{ngAfterContentInit:E,ngAfterContentChecked:S,ngAfterViewInit:R,ngAfterViewChecked:z,ngOnDestroy:$}=_;E&&(e.contentHooks??=[]).push(-n,E),S&&((e.contentHooks??=[]).push(n,S),(e.contentCheckHooks??=[]).push(n,S)),R&&(e.viewHooks??=[]).push(-n,R),z&&((e.viewHooks??=[]).push(n,z),(e.viewCheckHooks??=[]).push(n,z)),null!=$&&(e.destroyHooks??=[]).push(n,$)}}function nu(e,t,n){Cm(e,t,3,n)}function cc(e,t,n,s){(3&e[ei])===n&&Cm(e,t,n,s)}function bh(e,t){let n=e[ei];(3&n)===t&&(n&=8191,n+=1,e[ei]=n)}function Cm(e,t,n,s){const _=s??-1,E=t.length-1;let S=0;for(let R=void 0!==s?65535&e[Uc]:0;R<E;R++)if("number"==typeof t[R+1]){if(S=t[R],null!=s&&S>=s)break}else t[R]<0&&(e[Uc]+=65536),(S<_||-1==_)&&(v_(e,n,t,R),e[Uc]=(4294901760&e[Uc])+R+2),R++}function qf(e,t){_a(4,e,t);const n=cs(null);try{t.call(e)}finally{cs(n),_a(5,e,t)}}function v_(e,t,n,s){const d=n[s]<0,_=n[s+1],S=e[d?-n[s]:n[s]];d?e[ei]>>13<e[Uc]>>16&&(3&e[ei])===t&&(e[ei]+=8192,qf(S,_)):qf(S,_)}const ml=-1;class od{constructor(t,n,s){this.factory=t,this.resolving=!1,this.canSeeViewProviders=n,this.injectImpl=s}}function Im(e){return e!==ml}function iu(e){return 32767&e}function gl(e,t){let n=function kv(e){return e>>16}(e),s=t;for(;n>0;)s=s[ga],n--;return s}let ru=!0;function sd(e){const t=ru;return ru=e,t}const $s=255,wh=5;let vr=0;const lo={};function uc(e,t){const n=Mm(e,t);if(-1!==n)return n;const s=t[Qt];s.firstCreatePass&&(e.injectorIndex=t.length,Eh(s.data,e),Eh(t,null),Eh(s.blueprint,null));const d=dc(e,t),_=e.injectorIndex;if(Im(d)){const E=iu(d),S=gl(d,t),R=S[Qt].data;for(let z=0;z<8;z++)t[_+z]=S[E+z]|R[E+z]}return t[_+8]=d,_}function Eh(e,t){e.push(0,0,0,0,0,0,0,0,t)}function Mm(e,t){return-1===e.injectorIndex||e.parent&&e.parent.injectorIndex===e.injectorIndex||null===t[e.injectorIndex+8]?-1:e.injectorIndex}function dc(e,t){if(e.parent&&-1!==e.parent.injectorIndex)return e.parent.injectorIndex;let n=0,s=null,d=t;for(;null!==d;){if(s=r(d),null===s)return ml;if(n++,d=d[ga],-1!==s.injectorIndex)return s.injectorIndex|n<<16}return ml}function Pm(e,t,n){!function ad(e,t,n){let s;"string"==typeof n?s=n.charCodeAt(0)||0:n.hasOwnProperty(Zl)&&(s=n[Zl]),null==s&&(s=n[Zl]=vr++);const d=s&$s;t.data[e+(d>>wh)]|=1<<d}(e,t,n)}function Zf(e,t,n){if(n&Hn.Optional||void 0!==e)return e;Ic()}function Xf(e,t,n,s){if(n&Hn.Optional&&void 0===s&&(s=null),!(n&(Hn.Self|Hn.Host))){const d=e[ka],_=Tt(void 0);try{return d?d.get(t,s,n&Hn.Optional):Gn(t,s,n&Hn.Optional)}finally{Tt(_)}}return Zf(s,0,n)}function ld(e,t,n,s=Hn.Default,d){if(null!==e){if(2048&t[ei]&&!(s&Hn.Self)){const E=function f(e,t,n,s,d){let _=e,E=t;for(;null!==_&&null!==E&&2048&E[ei]&&!(512&E[ei]);){const S=ou(_,E,n,s|Hn.Self,lo);if(S!==lo)return S;let R=_.parent;if(!R){const z=E[rh];if(z){const $=z.get(n,lo,s);if($!==lo)return $}R=r(E),E=E[ga]}_=R}return d}(e,t,n,s,lo);if(E!==lo)return E}const _=ou(e,t,n,s,lo);if(_!==lo)return _}return Xf(t,n,s,d)}function ou(e,t,n,s,d){const _=function qo(e){if("string"==typeof e)return e.charCodeAt(0)||0;const t=e.hasOwnProperty(Zl)?e[Zl]:void 0;return"number"==typeof t?t>=0?t&$s:E_:t}(n);if("function"==typeof _){if(!va(t,e,s))return s&Hn.Host?Zf(d,0,s):Xf(t,n,s,d);try{let E;if(E=_(s),null!=E||s&Hn.Optional)return E;Ic()}finally{Pi()}}else if("number"==typeof _){let E=null,S=Mm(e,t),R=ml,z=s&Hn.Host?t[Br][Ro]:null;for((-1===S||s&Hn.SkipSelf)&&(R=-1===S?dc(e,t):t[S+8],R!==ml&&w_(s,!1)?(E=t[Qt],S=iu(R),t=gl(R,t)):S=-1);-1!==S;){const $=t[Qt];if(Cs(_,S,$.data)){const J=_l(S,t,n,E,s,z);if(J!==lo)return J}R=t[S+8],R!==ml&&w_(s,t[Qt].data[S+8]===z)&&Cs(_,S,t)?(E=$,S=iu(R),t=gl(R,t)):S=-1}}return d}function _l(e,t,n,s,d,_){const E=t[Qt],S=E.data[e+8],$=hs(S,E,n,null==s?tc(S)&&ru:s!=E&&0!=(3&S.type),d&Hn.Host&&_===S);return null!==$?co(t,E,$,S):lo}function hs(e,t,n,s,d){const _=e.providerIndexes,E=t.data,S=1048575&_,R=e.directiveStart,$=_>>20,we=d?S+$:e.directiveEnd;for(let ve=s?S:S+$;ve<we;ve++){const Oe=E[ve];if(ve<R&&n===Oe||ve>=R&&Oe.type===n)return ve}if(d){const ve=E[R];if(ve&&as(ve)&&ve.type===n)return R}return null}function co(e,t,n,s){let d=e[n];const _=t.data;if(function x_(e){return e instanceof od}(d)){const E=d;E.resolving&&function On(e,t){const n=t?`. Dependency path: ${t.join(" > ")} > ${e}`:"";throw new wt(-200,`Circular dependency in DI detected for ${e}${n}`)}(function Li(e){return"function"==typeof e?e.name||e.toString():"object"==typeof e&&null!=e&&"function"==typeof e.type?e.type.name||e.type.toString():qn(e)}(_[n]));const S=sd(E.canSeeViewProviders);E.resolving=!0;const z=E.injectImpl?Tt(E.injectImpl):null;va(e,s,Hn.Default);try{d=e[n]=E.factory(void 0,_,e,s),t.firstCreatePass&&n>=s.directiveStart&&function Sm(e,t,n){const{ngOnChanges:s,ngOnInit:d,ngDoCheck:_}=t.type.prototype;if(s){const E=pm(t);(n.preOrderHooks??=[]).push(e,E),(n.preOrderCheckHooks??=[]).push(e,E)}d&&(n.preOrderHooks??=[]).push(0-e,d),_&&((n.preOrderHooks??=[]).push(e,_),(n.preOrderCheckHooks??=[]).push(e,_))}(n,_[n],t)}finally{null!==z&&Tt(z),sd(S),E.resolving=!1,Pi()}}return d}function Cs(e,t,n){return!!(n[t+(e>>wh)]&1<<e)}function w_(e,t){return!(e&Hn.Self||e&Hn.Host&&t)}class fs{constructor(t,n){this._tNode=t,this._lView=n}get(t,n,s){return ld(this._tNode,this._lView,t,Yd(s),n)}}function E_(){return new fs(ko(),At())}function Zi(e){return xo(()=>{const t=e.prototype.constructor,n=t[Fa]||Yf(t),s=Object.prototype;let d=Object.getPrototypeOf(e.prototype).constructor;for(;d&&d!==s;){const _=d[Fa]||Yf(d);if(_&&_!==n)return _;d=Object.getPrototypeOf(d)}return _=>new _})}function Yf(e){return Hd(e)?()=>{const t=Yf(Nn(e));return t&&t()}:al(e)}function r(e){const t=e[Qt],n=t.type;return 2===n?t.declTNode:1===n?e[Ro]:null}function ce(e,t){e.forEach(n=>Array.isArray(n)?ce(n,t):t(n))}function ue(e,t,n){t>=e.length?e.push(n):e.splice(t,0,n)}function Me(e,t){return t>=e.length-1?e.pop():e.splice(t,1)[0]}function De(e,t,n){let s=Ne(e,t);return s>=0?e[1|s]=n:(s=~s,function Ge(e,t,n,s){let d=e.length;if(d==t)e.push(n,s);else if(1===d)e.push(s,e[0]),e[0]=n;else{for(d--,e.push(e[d-1],e[d]);d>t;)e[d]=e[d-2],d--;e[t]=n,e[t+1]=s}}(e,s,t,n)),s}function _e(e,t){const n=Ne(e,t);if(n>=0)return e[1|n]}function Ne(e,t){return function We(e,t,n){let s=0,d=e.length>>n;for(;d!==s;){const _=s+(d-s>>1),E=e[_<<n];if(t===E)return _<<n;E>t?d=_:s=_+1}return~(d<<n)}(e,t,1)}function T_(e){return 128==(128&e.flags)}var vl=function(e){return e[e.Important=1]="Important",e[e.DashCase=2]="DashCase",e}(vl||{});const Va=new Map;let au=0;const Nm="__ngContext__";function Zo(e,t){Oo(t)?(e[Nm]=t[Jl],function nb(e){Va.set(e[Jl],e)}(t)):e[Nm]=t}let Bv;function I_(e,t){return Bv(e,t)}function zm(e){const t=e[Or];return Fo(t)?t[Or]:t}function Vv(e){return Uv(e[Ql])}function jv(e){return Uv(e[ws])}function Uv(e){for(;null!==e&&!Fo(e);)e=e[ws];return e}function Dh(e,t,n,s,d){if(null!=s){let _,E=!1;Fo(s)?_=s:Oo(s)&&(E=!0,s=s[zr]);const S=dr(s);0===e&&null!==n?null==d?fb(t,n,S):Ih(t,n,S,d||null,!0):1===e&&null!==n?Ih(t,n,S,d||null,!0):2===e?function dd(e,t,n){const s=Um(e,t);s&&function Gv(e,t,n,s){e.removeChild(t,n,s)}(e,s,t,n)}(t,S,E):3===e&&t.destroyNode(S),null!=_&&function qv(e,t,n,s,d){const _=n[ea];_!==dr(n)&&Dh(t,e,s,_,d);for(let S=ao;S<n.length;S++){const R=n[S];$m(R[Qt],R,e,t,s,_)}}(t,e,_,n,d)}}function $r(e,t,n){return e.createElement(t,n)}function Sh(e,t){const n=e[Hc],s=n.indexOf(t);Yc(t),n.splice(s,1)}function jm(e,t){if(e.length<=ao)return;const n=ao+t,s=e[n];if(s){const d=s[jc];null!==d&&d!==e&&Sh(d,s),t>0&&(e[n-1][ws]=s[ws]);const _=Me(e,ao+t);!function db(e,t){$m(e,t,t[Fn],2,null,null),t[zr]=null,t[Ro]=null}(s[Qt],s);const E=_[ss];null!==E&&E.detachView(_[Qt]),s[Or]=null,s[ws]=null,s[ei]&=-129}return s}function cu(e,t){if(!(256&t[ei])){const n=t[Fn];t[rl]&&hm(t[rl]),t[$u]&&hm(t[$u]),n.destroyNode&&$m(e,t,n,3,null,null),function vE(e){let t=e[Ql];if(!t)return Ch(e[Qt],e);for(;t;){let n=null;if(Oo(t))n=t[Ql];else{const s=t[ao];s&&(n=s)}if(!n){for(;t&&!t[ws]&&t!==e;)Oo(t)&&Ch(t[Qt],t),t=t[Or];null===t&&(t=e),Oo(t)&&Ch(t[Qt],t),n=t&&t[ws]}t=n}}(t)}}function Ch(e,t){if(!(256&t[ei])){t[ei]&=-129,t[ei]|=256,function EE(e,t){let n;if(null!=e&&null!=(n=e.destroyHooks))for(let s=0;s<n.length;s+=2){const d=t[n[s]];if(!(d instanceof od)){const _=n[s+1];if(Array.isArray(_))for(let E=0;E<_.length;E+=2){const S=d[_[E]],R=_[E+1];_a(4,S,R);try{R.call(S)}finally{_a(5,S,R)}}else{_a(4,d,_);try{_.call(d)}finally{_a(5,d,_)}}}}}(e,t),function wE(e,t){const n=e.cleanup,s=t[Kl];if(null!==n)for(let _=0;_<n.length-1;_+=2)if("string"==typeof n[_]){const E=n[_+3];E>=0?s[E]():s[-E].unsubscribe(),_+=2}else n[_].call(s[n[_+1]]);null!==s&&(t[Kl]=null);const d=t[La];if(null!==d){t[La]=null;for(let _=0;_<d.length;_++)(0,d[_])()}}(e,t),1===t[Qt].type&&t[Fn].destroy();const n=t[jc];if(null!==n&&Fo(t[Or])){n!==t[Or]&&Sh(n,t);const s=t[ss];null!==s&&s.detachView(e)}!function Nv(e){Va.delete(e[Jl])}(t)}}function Hv(e,t,n){return function hb(e,t,n){let s=t;for(;null!==s&&40&s.type;)s=(t=s).parent;if(null===s)return n[zr];{const{componentOffset:d}=s;if(d>-1){const{encapsulation:_}=e.data[s.directiveStart+d];if(_===Go.None||_===Go.Emulated)return null}return Tn(s,n)}}(e,t.parent,n)}function Ih(e,t,n,s,d){e.insertBefore(t,n,s,d)}function fb(e,t,n){e.appendChild(t,n)}function pb(e,t,n,s,d){null!==s?Ih(e,t,n,s,d):fb(e,t,n)}function Um(e,t){return e.parentNode(t)}let M_,L_,Ah=function Vr(e,t,n){return 40&e.type?Tn(e,n):null};function Mh(e,t,n,s){const d=Hv(e,s,t),_=t[Fn],S=function mb(e,t,n){return Ah(e,t,n)}(s.parent||t[Ro],s,t);if(null!=d)if(Array.isArray(n))for(let R=0;R<n.length;R++)pb(_,d,n[R],S,!1);else pb(_,d,n,S,!1);void 0!==M_&&M_(_,s,t,n,d)}function uu(e,t){if(null!==t){const n=t.type;if(3&n)return Tn(t,e);if(4&n)return P_(-1,e[t.index]);if(8&n){const s=t.child;if(null!==s)return uu(e,s);{const d=e[t.index];return Fo(d)?P_(-1,d):dr(d)}}if(32&n)return I_(t,e)()||dr(e[t.index]);{const s=$v(e,t);return null!==s?Array.isArray(s)?s[0]:uu(zm(e[Br]),s):uu(e,t.next)}}return null}function $v(e,t){return null!==t?e[Br][Ro].projection[t.projection]:null}function P_(e,t){const n=ao+e+1;if(n<t.length){const s=t[n],d=s[Qt].firstChild;if(null!==d)return uu(s,d)}return t[ea]}function Ph(e,t,n,s,d,_,E){for(;null!=n;){const S=s[n.index],R=n.type;if(E&&0===t&&(S&&Zo(dr(S),s),n.flags|=2),32!=(32&n.flags))if(8&R)Ph(e,t,n.child,s,d,_,!1),Dh(t,e,d,S,_);else if(32&R){const z=I_(n,s);let $;for(;$=z();)Dh(t,e,d,$,_);Dh(t,e,d,S,_)}else 16&R?O_(e,t,s,n,d,_):Dh(t,e,d,S,_);n=E?n.projectionNext:n.next}}function $m(e,t,n,s,d,_){Ph(n,s,e.firstChild,t,d,_,!1)}function O_(e,t,n,s,d,_){const E=n[Br],R=E[Ro].projection[s.projection];if(Array.isArray(R))for(let z=0;z<R.length;z++)Dh(t,e,d,R[z],_);else{let z=R;const $=E[Or];T_(s)&&(z.flags|=128),Ph(e,t,z,$,d,_,!0)}}function yb(e,t,n){""===n?e.removeAttribute(t,"class"):e.setAttribute(t,"class",n)}function As(e,t,n){const{mergedAttrs:s,classes:d,styles:_}=n;null!==s&&Kp(e,t,s),null!==d&&yb(e,t,d),null!==_&&function Rh(e,t,n){e.setAttribute(t,"style",n)}(e,t,_)}class xl{constructor(t){this.changingThisBreaksApplicationSecurity=t}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see https://g.co/ng/security#xss)`}}const pc=new Xt("ENVIRONMENT_INITIALIZER"),s0=new Xt("INJECTOR",-1),a0=new Xt("INJECTOR_DEF_TYPES");class Z_{get(t,n=Kr){if(n===Kr){const s=new Error(`NullInjectorError: No provider for ${ur(t)}!`);throw s.name="NullInjectorError",s}return n}}function NE(...e){return{\u0275providers:l0(0,e),\u0275fromNgModule:!0}}function l0(e,...t){const n=[],s=new Set;let d;const _=E=>{n.push(E)};return ce(t,E=>{const S=E;Jm(S,_,[],s)&&(d||=[],d.push(S))}),void 0!==d&&ep(d,_),n}function ep(e,t){for(let n=0;n<e.length;n++){const{ngModule:s,providers:d}=e[n];c0(d,_=>{t(_,s)})}}function Jm(e,t,n,s){if(!(e=Nn(e)))return!1;let d=null,_=Zd(e);const E=!_&&Jn(e);if(_||E){if(E&&!E.standalone)return!1;d=e}else{const R=e.ngModule;if(_=Zd(R),!_)return!1;d=R}const S=s.has(d);if(E){if(S)return!1;if(s.add(d),E.dependencies){const R="function"==typeof E.dependencies?E.dependencies():E.dependencies;for(const z of R)Jm(z,t,n,s)}}else{if(!_)return!1;{if(null!=_.imports&&!S){let z;s.add(d);try{ce(_.imports,$=>{Jm($,t,n,s)&&(z||=[],z.push($))})}finally{}void 0!==z&&ep(z,t)}if(!S){const z=al(d)||(()=>new d);t({provide:d,useFactory:z,deps:qi},d),t({provide:a0,useValue:d,multi:!0},d),t({provide:pc,useValue:()=>gt(d),multi:!0},d)}const R=_.providers;if(null!=R&&!S){const z=e;c0(R,$=>{t($,z)})}}}return d!==e&&void 0!==e.providers}function c0(e,t){for(let n of e)Po(n)&&(n=n.\u0275providers),Array.isArray(n)?c0(n,t):t(n)}const BE=Ci({provide:String,useValue:Ci});function X_(e){return null!==e&&"object"==typeof e&&BE in e}function mc(e){return"function"==typeof e}const Lh=new Xt("Set Injector scope."),ip={},K_={};let u0;function pd(){return void 0===u0&&(u0=new Z_),u0}class bl{}class Ms extends bl{get destroyed(){return this._destroyed}constructor(t,n,s,d){super(),this.parent=n,this.source=s,this.scopes=d,this.records=new Map,this._ngOnDestroyHooks=new Set,this._onDestroyHooks=[],this._destroyed=!1,h0(t,E=>this.processProvider(E)),this.records.set(s0,zh(void 0,this)),d.has("environment")&&this.records.set(bl,zh(void 0,this));const _=this.records.get(Lh);null!=_&&"string"==typeof _.value&&this.scopes.add(_.value),this.injectorDefTypes=new Set(this.get(a0.multi,qi,Hn.Self))}destroy(){this.assertNotDestroyed(),this._destroyed=!0;try{for(const n of this._ngOnDestroyHooks)n.ngOnDestroy();const t=this._onDestroyHooks;this._onDestroyHooks=[];for(const n of t)n()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear()}}onDestroy(t){return this.assertNotDestroyed(),this._onDestroyHooks.push(t),()=>this.removeOnDestroy(t)}runInContext(t){this.assertNotDestroyed();const n=Ys(this),s=Tt(void 0);try{return t()}finally{Ys(n),Tt(s)}}get(t,n=Kr,s=Hn.Default){if(this.assertNotDestroyed(),t.hasOwnProperty(bf))return t[bf](this);s=Yd(s);const _=Ys(this),E=Tt(void 0);try{if(!(s&Hn.SkipSelf)){let R=this.records.get(t);if(void 0===R){const z=function Mb(e){return"function"==typeof e||"object"==typeof e&&e instanceof Xt}(t)&&zu(t);R=z&&this.injectableDefInScope(z)?zh(md(t),ip):null,this.records.set(t,R)}if(null!=R)return this.hydrate(t,R)}return(s&Hn.Self?pd():this.parent).get(t,n=s&Hn.Optional&&n===Kr?null:n)}catch(S){if("NullInjectorError"===S.name){if((S[vo]=S[vo]||[]).unshift(ur(t)),_)throw S;return function Jr(e,t,n,s){const d=e[vo];throw t[Vs]&&d.unshift(t[Vs]),e.message=function Yp(e,t,n,s=null){e=e&&"\n"===e.charAt(0)&&"\u0275"==e.charAt(1)?e.slice(2):e;let d=ur(t);if(Array.isArray(t))d=t.map(ur).join(" -> ");else if("object"==typeof t){let _=[];for(let E in t)if(t.hasOwnProperty(E)){let S=t[E];_.push(E+":"+("string"==typeof S?JSON.stringify(S):ur(S)))}d=`{${_.join(", ")}}`}return`${n}${s?"("+s+")":""}[${d}]: ${e.replace(an,"\n  ")}`}("\n"+e.message,d,n,s),e.ngTokenPath=d,e[vo]=null,e}(S,t,"R3InjectorError",this.source)}throw S}finally{Tt(E),Ys(_)}}resolveInjectorInitializers(){const t=Ys(this),n=Tt(void 0);try{const d=this.get(pc.multi,qi,Hn.Self);for(const _ of d)_()}finally{Ys(t),Tt(n)}}toString(){const t=[],n=this.records;for(const s of n.keys())t.push(ur(s));return`R3Injector[${t.join(", ")}]`}assertNotDestroyed(){if(this._destroyed)throw new wt(205,!1)}processProvider(t){let n=mc(t=Nn(t))?t:Nn(t&&t.provide);const s=function rp(e){return X_(e)?zh(void 0,e.useValue):zh(Nh(e),ip)}(t);if(mc(t)||!0!==t.multi)this.records.get(n);else{let d=this.records.get(n);d||(d=zh(void 0,ip,!0),d.factory=()=>bs(d.multi),this.records.set(n,d)),n=t,d.multi.push(t)}this.records.set(n,s)}hydrate(t,n){return n.value===ip&&(n.value=K_,n.value=n.factory()),"object"==typeof n.value&&n.value&&function Ab(e){return null!==e&&"object"==typeof e&&"function"==typeof e.ngOnDestroy}(n.value)&&this._ngOnDestroyHooks.add(n.value),n.value}injectableDefInScope(t){if(!t.providedIn)return!1;const n=Nn(t.providedIn);return"string"==typeof n?"any"===n||this.scopes.has(n):this.injectorDefTypes.has(n)}removeOnDestroy(t){const n=this._onDestroyHooks.indexOf(t);-1!==n&&this._onDestroyHooks.splice(n,1)}}function md(e){const t=zu(e),n=null!==t?t.factory:al(e);if(null!==n)return n;if(e instanceof Xt)throw new wt(204,!1);if(e instanceof Function)return function d0(e){const t=e.length;if(t>0)throw function ye(e,t){const n=[];for(let s=0;s<e;s++)n.push(t);return n}(t,"?"),new wt(204,!1);const n=function Vu(e){return e&&(e[Nt]||e[ju])||null}(e);return null!==n?()=>n.factory(e):()=>new e}(e);throw new wt(204,!1)}function Nh(e,t,n){let s;if(mc(e)){const d=Nn(e);return al(d)||md(d)}if(X_(e))s=()=>Nn(e.useValue);else if(function Y_(e){return!(!e||!e.useFactory)}(e))s=()=>e.useFactory(...bs(e.deps||[]));else if(function tp(e){return!(!e||!e.useExisting)}(e))s=()=>gt(Nn(e.useExisting));else{const d=Nn(e&&(e.useClass||e.provide));if(!function Q_(e){return!!e.deps}(e))return al(d)||md(d);s=()=>new d(...bs(e.deps))}return s}function zh(e,t,n=!1){return{factory:e,value:t,multi:n?[]:void 0}}function h0(e,t){for(const n of e)Array.isArray(n)?h0(n,t):n&&Po(n)?h0(n.\u0275providers,t):t(n)}const Bh=new Xt("AppId",{providedIn:"root",factory:()=>VE}),VE="ng",op=new Xt("Platform Initializer"),gd=new Xt("Platform ID",{providedIn:"platform",factory:()=>"unknown"}),eg=new Xt("AnimationModuleType"),sp=new Xt("CSP nonce",{providedIn:"root",factory:()=>function hd(){if(void 0!==L_)return L_;if(typeof document<"u")return document;throw new wt(210,!1)}().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});let _0=(e,t,n)=>null;function og(e,t,n=!1){return _0(e,t,n)}class iy{}class ry{}class Nb{resolveComponentFactory(t){throw function Uh(e){const t=Error(`No component factory found for ${ur(e)}.`);return t.ngComponent=e,t}(t)}}let up=(()=>{class e{static{this.NULL=new Nb}}return e})();function $E(){return dp(ko(),At())}function dp(e,t){return new Xo(Tn(e,t))}let Xo=(()=>{class e{constructor(n){this.nativeElement=n}static{this.__NG_ELEMENT_ID__=$E}}return e})();function qE(e){return e instanceof Xo?e.nativeElement:e}class hp{}let Hh=(()=>{class e{constructor(){this.destroyNode=null}static{this.__NG_ELEMENT_ID__=()=>function zb(){const e=At(),n=Es(ko().index,e);return(Oo(n)?n:e)[Fn]}()}}return e})(),WE=(()=>{class e{static{this.\u0275prov=Jt({token:e,providedIn:"root",factory:()=>null})}}return e})();class Gh{constructor(t){this.full=t,this.major=t.split(".")[0],this.minor=t.split(".")[1],this.patch=t.split(".").slice(2).join(".")}}const ZE=new Gh("16.2.12"),sy={};function Ub(e,t=null,n=null,s){const d=Hb(e,t,n,s);return d.resolveInjectorInitializers(),d}function Hb(e,t=null,n=null,s,d=new Set){const _=[n||qi,NE(e)];return s=s||("object"==typeof e?void 0:ur(e)),new Ms(_,t||pd(),s||null,d)}let Yo=(()=>{class e{static{this.THROW_IF_NOT_FOUND=Kr}static{this.NULL=new Z_}static create(n,s){if(Array.isArray(n))return Ub({name:""},s,n,"");{const d=n.name??"";return Ub({name:d},n.parent,n.providers,d)}}static{this.\u0275prov=Jt({token:e,providedIn:"any",factory:()=>gt(s0)})}static{this.__NG_ELEMENT_ID__=-1}}return e})();function E0(e){return e.ngOriginalError}class wl{constructor(){this._console=console}handleError(t){const n=this._findOriginalError(t);this._console.error("ERROR",t),n&&this._console.error("ORIGINAL ERROR",n)}_findOriginalError(t){let n=t&&E0(t);for(;n&&E0(n);)n=E0(n);return n||null}}function ay(e){return t=>{setTimeout(e,void 0,t)}}const fo=class Wb extends Gi{constructor(t=!1){super(),this.__isAsync=t}emit(t){super.next(t)}subscribe(t,n,s){let d=t,_=n||(()=>null),E=s;if(t&&"object"==typeof t){const R=t;d=R.next?.bind(R),_=R.error?.bind(R),E=R.complete?.bind(R)}this.__isAsync&&(_=ay(_),d&&(d=ay(d)),E&&(E=ay(E)));const S=super.subscribe({next:d,error:_,complete:E});return t instanceof tr&&t.add(S),S}};function T0(...e){}class Ti{constructor({enableLongStackTrace:t=!1,shouldCoalesceEventChangeDetection:n=!1,shouldCoalesceRunChangeDetection:s=!1}){if(this.hasPendingMacrotasks=!1,this.hasPendingMicrotasks=!1,this.isStable=!0,this.onUnstable=new fo(!1),this.onMicrotaskEmpty=new fo(!1),this.onStable=new fo(!1),this.onError=new fo(!1),typeof Zone>"u")throw new wt(908,!1);Zone.assertZonePatched();const d=this;d._nesting=0,d._outer=d._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(d._inner=d._inner.fork(new Zone.TaskTrackingZoneSpec)),t&&Zone.longStackTraceZoneSpec&&(d._inner=d._inner.fork(Zone.longStackTraceZoneSpec)),d.shouldCoalesceEventChangeDetection=!s&&n,d.shouldCoalesceRunChangeDetection=s,d.lastRequestAnimationFrameId=-1,d.nativeRequestAnimationFrame=function Zb(){const e="function"==typeof gi.requestAnimationFrame;let t=gi[e?"requestAnimationFrame":"setTimeout"],n=gi[e?"cancelAnimationFrame":"clearTimeout"];if(typeof Zone<"u"&&t&&n){const s=t[Zone.__symbol__("OriginalDelegate")];s&&(t=s);const d=n[Zone.__symbol__("OriginalDelegate")];d&&(n=d)}return{nativeRequestAnimationFrame:t,nativeCancelAnimationFrame:n}}().nativeRequestAnimationFrame,function Yb(e){const t=()=>{!function sg(e){e.isCheckStableRunning||-1!==e.lastRequestAnimationFrameId||(e.lastRequestAnimationFrameId=e.nativeRequestAnimationFrame.call(gi,()=>{e.fakeTopEventTask||(e.fakeTopEventTask=Zone.root.scheduleEventTask("fakeTopEventTask",()=>{e.lastRequestAnimationFrameId=-1,S0(e),e.isCheckStableRunning=!0,D0(e),e.isCheckStableRunning=!1},void 0,()=>{},()=>{})),e.fakeTopEventTask.invoke()}),S0(e))}(e)};e._inner=e._inner.fork({name:"angular",properties:{isAngularZone:!0},onInvokeTask:(n,s,d,_,E,S)=>{if(function tT(e){return!(!Array.isArray(e)||1!==e.length)&&!0===e[0].data?.__ignore_ng_zone__}(S))return n.invokeTask(d,_,E,S);try{return Kb(e),n.invokeTask(d,_,E,S)}finally{(e.shouldCoalesceEventChangeDetection&&"eventTask"===_.type||e.shouldCoalesceRunChangeDetection)&&t(),Qb(e)}},onInvoke:(n,s,d,_,E,S,R)=>{try{return Kb(e),n.invoke(d,_,E,S,R)}finally{e.shouldCoalesceRunChangeDetection&&t(),Qb(e)}},onHasTask:(n,s,d,_)=>{n.hasTask(d,_),s===d&&("microTask"==_.change?(e._hasPendingMicrotasks=_.microTask,S0(e),D0(e)):"macroTask"==_.change&&(e.hasPendingMacrotasks=_.macroTask))},onHandleError:(n,s,d,_)=>(n.handleError(d,_),e.runOutsideAngular(()=>e.onError.emit(_)),!1)})}(d)}static isInAngularZone(){return typeof Zone<"u"&&!0===Zone.current.get("isAngularZone")}static assertInAngularZone(){if(!Ti.isInAngularZone())throw new wt(909,!1)}static assertNotInAngularZone(){if(Ti.isInAngularZone())throw new wt(909,!1)}run(t,n,s){return this._inner.run(t,n,s)}runTask(t,n,s,d){const _=this._inner,E=_.scheduleEventTask("NgZoneEvent: "+d,t,Xb,T0,T0);try{return _.runTask(E,n,s)}finally{_.cancelTask(E)}}runGuarded(t,n,s){return this._inner.runGuarded(t,n,s)}runOutsideAngular(t){return this._outer.run(t)}}const Xb={};function D0(e){if(0==e._nesting&&!e.hasPendingMicrotasks&&!e.isStable)try{e._nesting++,e.onMicrotaskEmpty.emit(null)}finally{if(e._nesting--,!e.hasPendingMicrotasks)try{e.runOutsideAngular(()=>e.onStable.emit(null))}finally{e.isStable=!0}}}function S0(e){e.hasPendingMicrotasks=!!(e._hasPendingMicrotasks||(e.shouldCoalesceEventChangeDetection||e.shouldCoalesceRunChangeDetection)&&-1!==e.lastRequestAnimationFrameId)}function Kb(e){e._nesting++,e.isStable&&(e.isStable=!1,e.onUnstable.emit(null))}function Qb(e){e._nesting--,D0(e)}class eT{constructor(){this.hasPendingMicrotasks=!1,this.hasPendingMacrotasks=!1,this.isStable=!0,this.onUnstable=new fo,this.onMicrotaskEmpty=new fo,this.onStable=new fo,this.onError=new fo}run(t,n,s){return t.apply(n,s)}runGuarded(t,n,s){return t.apply(n,s)}runOutsideAngular(t){return t()}runTask(t,n,s,d){return t.apply(n,s)}}const Jb=new Xt("",{providedIn:"root",factory:ew});function ew(){const e=ui(Ti);let t=!0;return tl(new Hi(d=>{t=e.isStable&&!e.hasPendingMacrotasks&&!e.hasPendingMicrotasks,e.runOutsideAngular(()=>{d.next(t),d.complete()})}),new Hi(d=>{let _;e.runOutsideAngular(()=>{_=e.onStable.subscribe(()=>{Ti.assertNotInAngularZone(),queueMicrotask(()=>{!t&&!e.hasPendingMacrotasks&&!e.hasPendingMicrotasks&&(t=!0,d.next(!0))})})});const E=e.onUnstable.subscribe(()=>{Ti.assertInAngularZone(),t&&(t=!1,e.runOutsideAngular(()=>{d.next(!1)}))});return()=>{_.unsubscribe(),E.unsubscribe()}}).pipe(Zs()))}let cy=(()=>{class e{constructor(){this.renderDepth=0,this.handler=null}begin(){this.handler?.validateBegin(),this.renderDepth++}end(){this.renderDepth--,0===this.renderDepth&&this.handler?.execute()}ngOnDestroy(){this.handler?.destroy(),this.handler=null}static{this.\u0275prov=Jt({token:e,providedIn:"root",factory:()=>new e})}}return e})();function xd(e){for(;e;){e[ei]|=64;const t=zm(e);if(qu(e)&&!t)return e;e=t}return null}const iw=new Xt("",{providedIn:"root",factory:()=>!1});let ag=null;function Ps(e,t){return e[t]??lg()}function pp(e,t){const n=lg();n.producerNode?.length&&(e[t]=ag,n.lView=e,ag=uy())}const mp={...cl,consumerIsAlwaysLive:!0,consumerMarkedDirty:e=>{xd(e.lView)},lView:null};function uy(){return Object.create(mp)}function lg(){return ag??=uy(),ag}const si={};function dy(e){A0(bi(),At(),Hr()+e,!1)}function A0(e,t,n,s){if(!s)if(3==(3&t[ei])){const _=e.preOrderCheckHooks;null!==_&&nu(t,_,n)}else{const _=e.preOrderHooks;null!==_&&cc(t,_,0,n)}pl(n)}function Dt(e,t=Hn.Default){const n=At();return null===n?gt(e,t):ld(ko(),n,Nn(e),t)}function gp(e,t,n,s,d,_,E,S,R,z,$){const J=t.blueprint.slice();return J[zr]=d,J[ei]=140|s,(null!==z||e&&2048&e[ei])&&(J[ei]|=2048),it(J),J[Or]=J[ga]=e,J[Fr]=n,J[Qs]=E||e&&e[Qs],J[Fn]=S||e&&e[Fn],J[ka]=R||e&&e[ka]||null,J[Ro]=_,J[Jl]=function tb(){return au++}(),J[Js]=$,J[rh]=z,J[Br]=2==t.type?e[Br]:J,J}function $h(e,t,n,s,d){let _=e.data[t];if(null===_)_=function hy(e,t,n,s,d){const _=So(),E=wi(),R=e.data[t]=function uT(e,t,n,s,d,_){let E=t?t.injectorIndex:-1,S=0;return function Ju(){return null!==Sn.skipHydrationRootTNode}()&&(S|=128),{type:n,index:s,insertBeforeIndex:null,injectorIndex:E,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:S,providerIndexes:0,value:d,attrs:_,mergedAttrs:null,localNames:null,initialInputs:void 0,inputs:null,outputs:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:t,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}(0,E?_:_&&_.parent,n,t,s,d);return null===e.firstChild&&(e.firstChild=R),null!==_&&(E?null==_.child&&null!==R.parent&&(_.child=R):null===_.next&&(_.next=R,R.prev=_)),R}(e,t,n,s,d),function $f(){return Sn.lFrame.inI18n}()&&(_.flags|=32);else if(64&_.type){_.type=n,_.value=s,_.attrs=d;const E=function gh(){const e=Sn.lFrame,t=e.currentTNode;return e.isParent?t:t.parent}();_.injectorIndex=null===E?-1:E.injectorIndex}return Ts(_,!0),_}function cg(e,t,n,s){if(0===n)return-1;const d=t.length;for(let _=0;_<n;_++)t.push(s),e.blueprint.push(s),e.data.push(null);return d}function P0(e,t,n,s,d){const _=Ps(t,rl),E=Hr(),S=2&s;try{pl(-1),S&&t.length>xi&&A0(e,t,xi,!1),_a(S?2:0,d);const z=S?_:null,$=Pf(z);try{null!==z&&(z.dirty=!1),n(s,d)}finally{Xu(z,$)}}finally{S&&null===t[rl]&&pp(t,rl),pl(E),_a(S?3:1,d)}}function fy(e,t,n){if(ol(t)){const s=cs(null);try{const _=t.directiveEnd;for(let E=t.directiveStart;E<_;E++){const S=e.data[E];S.contentQueries&&S.contentQueries(1,n[E],E)}}finally{cs(s)}}}function py(e,t,n){ya()&&(function _p(e,t,n,s){const d=n.directiveStart,_=n.directiveEnd;tc(n)&&function hT(e,t,n){const s=Tn(t,e),d=El(n);let E=16;n.signals?E=4096:n.onPush&&(E=64);const S=hg(e,gp(e,d,null,E,s,t,null,e[Qs].rendererFactory.createRenderer(s,n),null,null,null));e[t.index]=S}(t,n,e.data[d+n.componentOffset]),e.firstCreatePass||uc(n,t),Zo(s,t);const E=n.initialInputs;for(let S=d;S<_;S++){const R=e.data[S],z=co(t,e,S,n);Zo(z,t),null!==E&&fT(0,S-d,z,R,0,E),as(R)&&(Es(n.index,t)[Fr]=co(t,e,S,n))}}(e,t,n,Tn(n,t)),64==(64&n.flags)&&mu(e,t,n))}function my(e,t,n=Tn){const s=t.localNames;if(null!==s){let d=t.index+1;for(let _=0;_<s.length;_+=2){const E=s[_+1],S=-1===E?n(t,e):e[E];e[d++]=S}}}function El(e){const t=e.tView;return null===t||t.incompleteFirstPass?e.tView=gy(1,null,e.template,e.decls,e.vars,e.directiveDefs,e.pipeDefs,e.viewQuery,e.schemas,e.consts,e.id):t}function gy(e,t,n,s,d,_,E,S,R,z,$){const J=xi+s,we=J+d,ve=function R0(e,t){const n=[];for(let s=0;s<t;s++)n.push(s<e?null:si);return n}(J,we),Oe="function"==typeof z?z():z;return ve[Qt]={type:e,blueprint:ve,template:n,queries:null,viewQuery:S,declTNode:t,data:ve.slice().fill(null,J),bindingStartIndex:J,expandoStartIndex:we,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:"function"==typeof _?_():_,pipeRegistry:"function"==typeof E?E():E,firstChild:null,schemas:R,consts:Oe,incompleteFirstPass:!1,ssrId:$}}let O0=e=>null;function hw(e,t,n,s){for(let d in e)if(e.hasOwnProperty(d)){n=null===n?{}:n;const _=e[d];null===s?F0(n,t,d,_):s.hasOwnProperty(d)&&F0(n,t,s[d],_)}return n}function F0(e,t,n,s){e.hasOwnProperty(n)?e[n].push(t,s):e[n]=[t,s]}function ms(e,t,n,s,d,_,E,S){const R=Tn(t,n);let $,z=t.inputs;!S&&null!=z&&($=z[s])?(j0(e,n,$,s,d),tc(t)&&function k0(e,t){const n=Es(t,e);16&n[ei]||(n[ei]|=64)}(n,t.index)):3&t.type&&(s=function qh(e){return"class"===e?"className":"for"===e?"htmlFor":"formaction"===e?"formAction":"innerHtml"===e?"innerHTML":"readonly"===e?"readOnly":"tabindex"===e?"tabIndex":e}(s),d=null!=E?E(d,t.value||"",s):d,_.setProperty(R,s,d))}function yy(e,t,n,s){if(ya()){const d=null===s?null:{"":-1},_=function gw(e,t){const n=e.directiveRegistry;let s=null,d=null;if(n)for(let _=0;_<n.length;_++){const E=n[_];if(js(t,E.selectors,!1))if(s||(s=[]),as(E))if(null!==E.findHostDirectiveDefs){const S=[];d=d||new Map,E.findHostDirectiveDefs(E,S,d),s.unshift(...S,E),yp(e,t,S.length)}else s.unshift(E),yp(e,t,0);else d=d||new Map,E.findHostDirectiveDefs?.(E,s,d),s.push(E)}return null===s?null:[s,d]}(e,n);let E,S;null===_?E=S=null:[E,S]=_,null!==E&&L0(e,t,n,E,d,S),d&&function _w(e,t,n){if(t){const s=e.localNames=[];for(let d=0;d<t.length;d+=2){const _=n[t[d+1]];if(null==_)throw new wt(-301,!1);s.push(t[d],_)}}}(n,s,d)}n.mergedAttrs=Uu(n.mergedAttrs,n.attrs)}function L0(e,t,n,s,d,_){for(let z=0;z<s.length;z++)Pm(uc(n,t),e,s[z].type);!function xy(e,t,n){e.flags|=1,e.directiveStart=t,e.directiveEnd=t+n,e.providerIndexes=t}(n,e.data.length,s.length);for(let z=0;z<s.length;z++){const $=s[z];$.providersResolver&&$.providersResolver($)}let E=!1,S=!1,R=cg(e,t,s.length,null);for(let z=0;z<s.length;z++){const $=s[z];n.mergedAttrs=Uu(n.mergedAttrs,$.hostAttrs),dT(e,n,t,R,$),vy(R,$,d),null!==$.contentQueries&&(n.flags|=4),(null!==$.hostBindings||null!==$.hostAttrs||0!==$.hostVars)&&(n.flags|=64);const J=$.type.prototype;!E&&(J.ngOnChanges||J.ngOnInit||J.ngDoCheck)&&((e.preOrderHooks??=[]).push(n.index),E=!0),!S&&(J.ngOnChanges||J.ngDoCheck)&&((e.preOrderCheckHooks??=[]).push(n.index),S=!0),R++}!function fw(e,t,n){const d=t.directiveEnd,_=e.data,E=t.attrs,S=[];let R=null,z=null;for(let $=t.directiveStart;$<d;$++){const J=_[$],we=n?n.get(J):null,Oe=we?we.outputs:null;R=hw(J.inputs,$,R,we?we.inputs:null),z=hw(J.outputs,$,z,Oe);const He=null===R||null===E||em(t)?null:pT(R,$,E);S.push(He)}null!==R&&(R.hasOwnProperty("class")&&(t.flags|=8),R.hasOwnProperty("style")&&(t.flags|=16)),t.initialInputs=S,t.inputs=R,t.outputs=z}(e,n,_)}function mu(e,t,n){const s=n.directiveStart,d=n.directiveEnd,_=n.index,E=function td(){return Sn.lFrame.currentDirectiveIndex}();try{pl(_);for(let S=s;S<d;S++){const R=e.data[S],z=t[S];nd(S),(null!==R.hostBindings||0!==R.hostVars||null!==R.hostAttrs)&&mw(R,z)}}finally{pl(-1),nd(E)}}function mw(e,t){null!==e.hostBindings&&e.hostBindings(1,t)}function yp(e,t,n){t.componentOffset=n,(e.components??=[]).push(t.index)}function vy(e,t,n){if(n){if(t.exportAs)for(let s=0;s<t.exportAs.length;s++)n[t.exportAs[s]]=e;as(t)&&(n[""]=e)}}function dT(e,t,n,s,d){e.data[s]=d;const _=d.factory||(d.factory=al(d.type)),E=new od(_,as(d),Dt);e.blueprint[s]=E,n[s]=E,function Tl(e,t,n,s,d){const _=d.hostBindings;if(_){let E=e.hostBindingOpCodes;null===E&&(E=e.hostBindingOpCodes=[]);const S=~t.index;(function N0(e){let t=e.length;for(;t>0;){const n=e[--t];if("number"==typeof n&&n<0)return n}return 0})(E)!=S&&E.push(S),E.push(n,s,_)}}(e,t,s,cg(e,n,d.hostVars,si),d)}function yc(e,t,n,s,d,_){const E=Tn(e,t);!function bd(e,t,n,s,d,_,E){if(null==_)e.removeAttribute(t,d,n);else{const S=null==E?qn(_):E(_,s||"",d);e.setAttribute(t,d,S,n)}}(t[Fn],E,_,e.value,n,s,d)}function fT(e,t,n,s,d,_){const E=_[t];if(null!==E)for(let S=0;S<E.length;)by(s,n,E[S++],E[S++],E[S++])}function by(e,t,n,s,d){const _=cs(null);try{const E=e.inputTransforms;null!==E&&E.hasOwnProperty(s)&&(d=E[s].call(t,d)),null!==e.setInput?e.setInput(t,d,n,s):t[s]=d}finally{cs(_)}}function pT(e,t,n){let s=null,d=0;for(;d<n.length;){const _=n[d];if(0!==_)if(5!==_){if("number"==typeof _)break;if(e.hasOwnProperty(_)){null===s&&(s=[]);const E=e[_];for(let S=0;S<E.length;S+=2)if(E[S]===t){s.push(_,E[S+1],n[d+1]);break}}d+=2}else d+=2;else d+=4}return s}function z0(e,t,n,s){return[e,!0,!1,t,null,0,s,n,null,null,null]}function dg(e,t){const n=e.contentQueries;if(null!==n)for(let s=0;s<n.length;s+=2){const _=n[s+1];if(-1!==_){const E=e.data[_];Ba(n[s]),E.contentQueries(2,t[_],_)}}}function hg(e,t){return e[Ql]?e[ih][ws]=t:e[Ql]=t,e[ih]=t,t}function wy(e,t,n){Ba(0);const s=cs(null);try{t(e,n)}finally{cs(s)}}function B0(e){return e[Kl]||(e[Kl]=[])}function yw(e){return e.cleanup||(e.cleanup=[])}function Ey(e,t){const n=e[ka],s=n?n.get(wl,null):null;s&&s.handleError(t)}function j0(e,t,n,s,d){for(let _=0;_<n.length;){const E=n[_++],S=n[_++];by(e.data[E],t[E],s,S,d)}}function fg(e,t){const n=Es(t,e),s=n[Qt];!function wd(e,t){for(let n=t.length;n<e.blueprint.length;n++)t.push(e.blueprint[n])}(s,n);const d=n[zr];null!==d&&null===n[Js]&&(n[Js]=og(d,n[ka])),Ty(s,n,n[Fr])}function Ty(e,t,n){_h(t);try{const s=e.viewQuery;null!==s&&wy(1,s,n);const d=e.template;null!==d&&P0(e,t,d,1,n),e.firstCreatePass&&(e.firstCreatePass=!1),e.staticContentQueries&&dg(e,t),e.staticViewQueries&&wy(2,e.viewQuery,n);const _=e.components;null!==_&&function U0(e,t){for(let n=0;n<t.length;n++)fg(e,t[n])}(t,_)}catch(s){throw e.firstCreatePass&&(e.incompleteFirstPass=!0,e.firstCreatePass=!1),s}finally{t[ei]&=-5,ac()}}let pg=(()=>{class e{constructor(){this.all=new Set,this.queue=new Map}create(n,s,d){const _=typeof Zone>"u"?null:Zone.current,E=function jt(e,t,n){const s=Object.create(Iv);n&&(s.consumerAllowSignalWrites=!0),s.fn=e,s.schedule=t;const d=E=>{s.cleanupFn=E};return s.ref={notify:()=>dm(s),run:()=>{if(s.dirty=!1,s.hasRun&&!ch(s))return;s.hasRun=!0;const E=Pf(s);try{s.cleanupFn(),s.cleanupFn=Lf,s.fn(d)}finally{Xu(s,E)}},cleanup:()=>s.cleanupFn()},s.ref}(n,z=>{this.all.has(z)&&this.queue.set(z,_)},d);let S;this.all.add(E),E.notify();const R=()=>{E.cleanup(),S?.(),this.all.delete(E),this.queue.delete(E)};return S=s?.onDestroy(R),{destroy:R}}flush(){if(0!==this.queue.size)for(const[n,s]of this.queue)this.queue.delete(n),s?s.run(()=>n.run()):n.run()}get isQueueEmpty(){return 0===this.queue.size}static{this.\u0275prov=Jt({token:e,providedIn:"root",factory:()=>new e})}}return e})();function Dy(e,t,n){let s=n?e.styles:null,d=n?e.classes:null,_=0;if(null!==t)for(let E=0;E<t.length;E++){const S=t[E];"number"==typeof S?_=S:1==_?d=Sc(d,S):2==_&&(s=Sc(s,S+": "+t[++E]+";"))}n?e.styles=s:e.stylesWithoutHost=s,n?e.classes=d:e.classesWithoutHost=d}function vp(e,t,n,s,d=!1){for(;null!==n;){const _=t[n.index];null!==_&&s.push(dr(_)),Fo(_)&&xp(_,s);const E=n.type;if(8&E)vp(e,t,n.child,s);else if(32&E){const S=I_(n,t);let R;for(;R=S();)s.push(R)}else if(16&E){const S=$v(t,n);if(Array.isArray(S))s.push(...S);else{const R=zm(t[Br]);vp(R[Qt],R,S,s,!0)}}n=d?n.projectionNext:n.next}return s}function xp(e,t){for(let n=ao;n<e.length;n++){const s=e[n],d=s[Qt].firstChild;null!==d&&vp(s[Qt],s,d,t)}e[ea]!==e[zr]&&t.push(e[ea])}function mg(e,t,n,s=!0){const d=t[Qs],_=d.rendererFactory,E=d.afterRenderEventManager;_.begin?.(),E?.begin();try{vw(e,t,e.template,n)}catch(R){throw s&&Ey(t,R),R}finally{_.end?.(),d.effectManager?.flush(),E?.end()}}function vw(e,t,n,s){const d=t[ei];if(256!=(256&d)){t[Qs].effectManager?.flush(),_h(t);try{it(t),function Gf(e){return Sn.lFrame.bindingIndex=e}(e.bindingStartIndex),null!==n&&P0(e,t,n,2,s);const E=3==(3&d);if(E){const z=e.preOrderCheckHooks;null!==z&&nu(t,z,null)}else{const z=e.preOrderHooks;null!==z&&cc(t,z,0,null),bh(t,0)}if(function gg(e){for(let t=Vv(e);null!==t;t=jv(t)){if(!t[rm])continue;const n=t[Hc];for(let s=0;s<n.length;s++){_t(n[s])}}}(t),bp(t,2),null!==e.contentQueries&&dg(e,t),E){const z=e.contentCheckHooks;null!==z&&nu(t,z)}else{const z=e.contentHooks;null!==z&&cc(t,z,1),bh(t,1)}!function lw(e,t){const n=e.hostBindingOpCodes;if(null===n)return;const s=Ps(t,$u);try{for(let d=0;d<n.length;d++){const _=n[d];if(_<0)pl(~_);else{const E=_,S=n[++d],R=n[++d];sc(S,E),s.dirty=!1;const z=Pf(s);try{R(2,t[E])}finally{Xu(s,z)}}}}finally{null===t[$u]&&pp(t,$u),pl(-1)}}(e,t);const S=e.components;null!==S&&yg(t,S,0);const R=e.viewQuery;if(null!==R&&wy(2,R,s),E){const z=e.viewCheckHooks;null!==z&&nu(t,z)}else{const z=e.viewHooks;null!==z&&cc(t,z,2),bh(t,2)}!0===e.firstUpdatePass&&(e.firstUpdatePass=!1),t[ei]&=-73,Yc(t)}finally{ac()}}}function bp(e,t){for(let n=Vv(e);null!==n;n=jv(n))for(let s=ao;s<n.length;s++)wp(n[s],t)}function _g(e,t,n){wp(Es(t,e),n)}function wp(e,t){if(!function rc(e){return 128==(128&e[ei])}(e))return;const n=e[Qt],s=e[ei];if(80&s&&0===t||1024&s||2===t)vw(n,e,n.template,e[Fr]);else if(e[nh]>0){bp(e,1);const d=n.components;null!==d&&yg(e,d,1)}}function yg(e,t,n){for(let s=0;s<t.length;s++)_g(e,t[s],n)}class vg{get rootNodes(){const t=this._lView,n=t[Qt];return vp(n,t,n.firstChild,[])}constructor(t,n){this._lView=t,this._cdRefInjectingView=n,this._appRef=null,this._attachedToViewContainer=!1}get context(){return this._lView[Fr]}set context(t){this._lView[Fr]=t}get destroyed(){return 256==(256&this._lView[ei])}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){const t=this._lView[Or];if(Fo(t)){const n=t[8],s=n?n.indexOf(this):-1;s>-1&&(jm(t,s),Me(n,s))}this._attachedToViewContainer=!1}cu(this._lView[Qt],this._lView)}onDestroy(t){!function Se(e,t){if(256==(256&e[ei]))throw new wt(911,!1);null===e[La]&&(e[La]=[]),e[La].push(t)}(this._lView,t)}markForCheck(){xd(this._cdRefInjectingView||this._lView)}detach(){this._lView[ei]&=-129}reattach(){this._lView[ei]|=128}detectChanges(){mg(this._lView[Qt],this._lView,this.context)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new wt(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null,function yE(e,t){$m(e,t,t[Fn],2,null,null)}(this._lView[Qt],this._lView)}attachToAppRef(t){if(this._attachedToViewContainer)throw new wt(902,!1);this._appRef=t}}class mT extends vg{constructor(t){super(t),this._view=t}detectChanges(){const t=this._view;mg(t[Qt],t,t[Fr],!1)}checkNoChanges(){}get context(){return null}}class Wh extends up{constructor(t){super(),this.ngModule=t}resolveComponentFactory(t){const n=Jn(t);return new Ep(n,this.ngModule)}}function xg(e){const t=[];for(let n in e)e.hasOwnProperty(n)&&t.push({propName:e[n],templateName:n});return t}class xw{constructor(t,n){this.injector=t,this.parentInjector=n}get(t,n,s){s=Yd(s);const d=this.injector.get(t,sy,s);return d!==sy||n===sy?d:this.parentInjector.get(t,n,s)}}class Ep extends ry{get inputs(){const t=this.componentDef,n=t.inputTransforms,s=xg(t.inputs);if(null!==n)for(const d of s)n.hasOwnProperty(d.propName)&&(d.transform=n[d.propName]);return s}get outputs(){return xg(this.componentDef.outputs)}constructor(t,n){super(),this.componentDef=t,this.ngModule=n,this.componentType=t.type,this.selector=function Tf(e){return e.map(Us).join(",")}(t.selectors),this.ngContentSelectors=t.ngContentSelectors?t.ngContentSelectors:[],this.isBoundToModule=!!n}create(t,n,s,d){let _=(d=d||this.ngModule)instanceof bl?d:d?.injector;_&&null!==this.componentDef.getStandaloneInjector&&(_=this.componentDef.getStandaloneInjector(_)||_);const E=_?new xw(t,_):t,S=E.get(hp,null);if(null===S)throw new wt(407,!1);const J={rendererFactory:S,sanitizer:E.get(WE,null),effectManager:E.get(pg,null),afterRenderEventManager:E.get(cy,null)},we=S.createRenderer(null,this.componentDef),ve=this.componentDef.selectors[0][0]||"div",Oe=s?function ug(e,t,n,s){const _=s.get(iw,!1)||n===Go.ShadowDom,E=e.selectRootElement(t,_);return function pu(e){O0(e)}(E),E}(we,s,this.componentDef.encapsulation,E):$r(we,ve,function gT(e){const t=e.toLowerCase();return"svg"===t?"svg":"math"===t?"math":null}(ve)),Rt=this.componentDef.signals?4608:this.componentDef.onPush?576:528;let dt=null;null!==Oe&&(dt=og(Oe,E,!0));const on=gy(0,null,null,1,0,null,null,null,null,null,null),gn=gp(null,on,null,Rt,null,null,J,we,E,null,dt);let yi,qr;_h(gn);try{const Wr=this.componentDef;let ca,kl=null;Wr.findHostDirectiveDefs?(ca=[],kl=new Map,Wr.findHostDirectiveDefs(Wr,ca,kl),ca.push(Wr)):ca=[Wr];const Su=function bw(e,t){const n=e[Qt],s=xi;return e[s]=t,$h(n,s,2,"#host",null)}(gn,Oe),hE=function yT(e,t,n,s,d,_,E){const S=d[Qt];!function ww(e,t,n,s){for(const d of e)t.mergedAttrs=Uu(t.mergedAttrs,d.hostAttrs);null!==t.mergedAttrs&&(Dy(t,t.mergedAttrs,!0),null!==n&&As(s,n,t))}(s,e,t,E);let R=null;null!==t&&(R=og(t,d[ka]));const z=_.rendererFactory.createRenderer(t,n);let $=16;n.signals?$=4096:n.onPush&&($=64);const J=gp(d,El(n),null,$,d[e.index],e,_,z,null,null,R);return S.firstCreatePass&&yp(S,e,s.length-1),hg(d,J),d[e.index]=J}(Su,Oe,Wr,ca,gn,J,we);qr=ph(on,xi),Oe&&function Ew(e,t,n,s){if(s)Kp(e,n,["ng-version",ZE.full]);else{const{attrs:d,classes:_}=function ht(e){const t=[],n=[];let s=1,d=2;for(;s<e.length;){let _=e[s];if("string"==typeof _)2===d?""!==_&&t.push(_,e[++s]):8===d&&n.push(_);else{if(!bo(d))break;d=_}s++}return{attrs:t,classes:n}}(t.selectors[0]);d&&Kp(e,n,d),_&&_.length>0&&yb(e,n,_.join(" "))}}(we,Wr,Oe,s),void 0!==n&&function xT(e,t,n){const s=e.projection=[];for(let d=0;d<t.length;d++){const _=n[d];s.push(null!=_?Array.from(_):null)}}(qr,this.ngContentSelectors,n),yi=function vT(e,t,n,s,d,_){const E=ko(),S=d[Qt],R=Tn(E,d);L0(S,d,E,n,null,s);for(let $=0;$<n.length;$++)Zo(co(d,S,E.directiveStart+$,E),d);mu(S,d,E),R&&Zo(R,d);const z=co(d,S,E.directiveStart+E.componentOffset,E);if(e[Fr]=d[Fr]=z,null!==_)for(const $ of _)$(z,t);return fy(S,E,e),z}(hE,Wr,ca,kl,gn,[bT]),Ty(on,gn,null)}finally{ac()}return new _T(this.componentType,yi,dp(qr,gn),gn,qr)}}class _T extends iy{constructor(t,n,s,d,_){super(),this.location=s,this._rootLView=d,this._tNode=_,this.previousInputValues=null,this.instance=n,this.hostView=this.changeDetectorRef=new mT(d),this.componentType=t}setInput(t,n){const s=this._tNode.inputs;let d;if(null!==s&&(d=s[t])){if(this.previousInputValues??=new Map,this.previousInputValues.has(t)&&Object.is(this.previousInputValues.get(t),n))return;const _=this._rootLView;j0(_[Qt],_,d,t,n),this.previousInputValues.set(t,n),xd(Es(this._tNode.index,_))}}get injector(){return new fs(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(t){this.hostView.onDestroy(t)}}function bT(){const e=ko();xh(At()[Qt],e)}function zi(e){let t=function bg(e){return Object.getPrototypeOf(e.prototype).constructor}(e.type),n=!0;const s=[e];for(;t;){let d;if(as(e))d=t.\u0275cmp||t.\u0275dir;else{if(t.\u0275cmp)throw new wt(903,!1);d=t.\u0275dir}if(d){if(n){s.push(d);const E=e;E.inputs=Zh(e.inputs),E.inputTransforms=Zh(e.inputTransforms),E.declaredInputs=Zh(e.declaredInputs),E.outputs=Zh(e.outputs);const S=d.hostBindings;S&&G0(e,S);const R=d.viewQuery,z=d.contentQueries;if(R&&Cy(e,R),z&&wT(e,z),Gl(e.inputs,d.inputs),Gl(e.declaredInputs,d.declaredInputs),Gl(e.outputs,d.outputs),null!==d.inputTransforms&&(null===E.inputTransforms&&(E.inputTransforms={}),Gl(E.inputTransforms,d.inputTransforms)),as(d)&&d.data.animation){const $=e.data;$.animation=($.animation||[]).concat(d.data.animation)}}const _=d.features;if(_)for(let E=0;E<_.length;E++){const S=_[E];S&&S.ngInherit&&S(e),S===zi&&(n=!1)}}t=Object.getPrototypeOf(t)}!function Sy(e){let t=0,n=null;for(let s=e.length-1;s>=0;s--){const d=e[s];d.hostVars=t+=d.hostVars,d.hostAttrs=Uu(d.hostAttrs,n=Uu(n,d.hostAttrs))}}(s)}function Zh(e){return e===Oa?{}:e===qi?[]:e}function Cy(e,t){const n=e.viewQuery;e.viewQuery=n?(s,d)=>{t(s,d),n(s,d)}:t}function wT(e,t){const n=e.contentQueries;e.contentQueries=n?(s,d,_)=>{t(s,d,_),n(s,d,_)}:t}function G0(e,t){const n=e.hostBindings;e.hostBindings=n?(s,d)=>{t(s,d),n(s,d)}:t}function gs(e,t,n){return!Object.is(e[t],n)&&(e[t]=n,!0)}function ja(e,t,n,s){const d=At();return gs(d,oc(),t)&&(bi(),yc(yr(),d,e,t,n,s)),ja}function ax(e,t,n,s,d,_,E,S){const R=At(),z=bi(),$=e+xi,J=z.firstCreatePass?function RT(e,t,n,s,d,_,E,S,R){const z=t.consts,$=$h(t,e,4,E||null,Do(z,S));yy(t,n,$,Do(z,R)),xh(t,$);const J=$.tView=gy(2,$,s,d,_,t.directiveRegistry,t.pipeRegistry,null,t.schemas,z,null);return null!==t.queries&&(t.queries.template(t,$),J.queries=t.queries.embeddedTView($)),$}($,z,R,t,n,s,d,_,E):z.data[$];Ts(J,!1);const we=Rw(z,R,J,e);rd()&&Mh(z,R,we,J),Zo(we,R),hg(R,R[$]=z0(we,R,we,J)),sl(J)&&py(z,R,J),null!=E&&my(R,J,S)}let Rw=function tf(e,t,n,s){return xa(!0),t[Fn].createComment("")};function $y(e,t,n){const s=At();return gs(s,oc(),t)&&ms(bi(),yr(),s,e,t,s[Fn],n,!1),$y}function qy(e,t,n,s,d){const E=d?"class":"style";j0(e,n,t.inputs[E],E,s)}function Ua(e,t,n,s){const d=At(),_=bi(),E=xi+e,S=d[Fn],R=_.firstCreatePass?function Fw(e,t,n,s,d,_){const E=t.consts,R=$h(t,e,2,s,Do(E,d));return yy(t,n,R,Do(E,_)),null!==R.attrs&&Dy(R,R.attrs,!1),null!==R.mergedAttrs&&Dy(R,R.mergedAttrs,!0),null!==t.queries&&t.queries.elementStart(t,R),R}(E,_,d,t,n,s):_.data[E],z=cx(_,d,R,S,t,e);d[E]=z;const $=sl(R);return Ts(R,!0),As(S,z,R),32!=(32&R.flags)&&rd()&&Mh(_,d,z,R),0===function gm(){return Sn.lFrame.elementDepthCount}()&&Zo(z,d),function Uf(){Sn.lFrame.elementDepthCount++}(),$&&(py(_,d,R),fy(_,R,d)),null!==s&&my(d,R),Ua}function Sl(){let e=ko();wi()?function En(){Sn.lFrame.isParent=!1}():(e=e.parent,Ts(e,!1));const t=e;(function _m(e){return Sn.skipHydrationRootTNode===e})(t)&&function __(){Sn.skipHydrationRootTNode=null}(),function Qu(){Sn.lFrame.elementDepthCount--}();const n=bi();return n.firstCreatePass&&(xh(n,e),ol(e)&&n.queries.elementEnd(e)),null!=t.classesWithoutHost&&function Rv(e){return 0!=(8&e.flags)}(t)&&qy(n,t,At(),t.classesWithoutHost,!0),null!=t.stylesWithoutHost&&function Ov(e){return 0!=(16&e.flags)}(t)&&qy(n,t,At(),t.stylesWithoutHost,!1),Sl}function nf(e,t,n,s){return Ua(e,t,n,s),Sl(),nf}let cx=(e,t,n,s,d,_)=>(xa(!0),$r(s,d,function vh(){return Sn.lFrame.currentNamespace}()));function Ig(e){return!!e&&"function"==typeof e.then}function dx(e){return!!e&&"function"==typeof e.subscribe}function Rs(e,t,n,s){const d=At(),_=bi(),E=ko();return function Vw(e,t,n,s,d,_,E){const S=sl(s),z=e.firstCreatePass&&yw(e),$=t[Fr],J=B0(t);let we=!0;if(3&s.type||E){const He=Tn(s,t),mt=E?E(He):He,Rt=J.length,dt=E?gn=>E(dr(gn[s.index])):s.index;let on=null;if(!E&&S&&(on=function FT(e,t,n,s){const d=e.cleanup;if(null!=d)for(let _=0;_<d.length-1;_+=2){const E=d[_];if(E===n&&d[_+1]===s){const S=t[Kl],R=d[_+2];return S.length>R?S[R]:null}"string"==typeof E&&(_+=2)}return null}(e,t,d,s.index)),null!==on)(on.__ngLastListenerFn__||on).__ngNextListenerFn__=_,on.__ngLastListenerFn__=_,we=!1;else{_=Ag(s,t,$,_,!1);const gn=n.listen(mt,d,_);J.push(_,gn),z&&z.push(d,dt,Rt,Rt+1)}}else _=Ag(s,t,$,_,!1);const ve=s.outputs;let Oe;if(we&&null!==ve&&(Oe=ve[d])){const He=Oe.length;if(He)for(let mt=0;mt<He;mt+=2){const yi=t[Oe[mt]][Oe[mt+1]].subscribe(_),qr=J.length;J.push(_,yi),z&&z.push(d,s.index,qr,-(qr+1))}}}(_,d,d[Fn],E,e,t,s),Rs}function jw(e,t,n,s){try{return _a(6,t,n),!1!==n(s)}catch(d){return Ey(e,d),!1}finally{_a(7,t,n)}}function Ag(e,t,n,s,d){return function _(E){if(E===Function)return s;xd(e.componentOffset>-1?Es(e.index,t):t);let R=jw(t,n,s,E),z=_.__ngNextListenerFn__;for(;z;)R=jw(t,n,z,E)&&R,z=z.__ngNextListenerFn__;return d&&!1===R&&E.preventDefault(),R}}function Mg(e,t){return e<<17|t<<2}function xu(e){return e>>17&32767}function Xy(e){return 2|e}function Id(e){return(131068&e)>>2}function fx(e,t){return-131069&e|t<<2}function Yy(e){return 1|e}function px(e,t,n,s,d){const _=e[n+1],E=null===t;let S=s?xu(_):Id(_),R=!1;for(;0!==S&&(!1===R||E);){const $=e[S+1];jT(e[S],t)&&(R=!0,e[S+1]=s?Yy($):Xy($)),S=s?xu($):Id($)}R&&(e[n+1]=s?Xy(_):Yy(_))}function jT(e,t){return null===e||null==t||(Array.isArray(e)?e[1]:e)===t||!(!Array.isArray(e)||"string"!=typeof t)&&Ne(e,t)>=0}function Mp(e,t){return function Ga(e,t,n,s){const d=At(),_=bi(),E=function na(e){const t=Sn.lFrame,n=t.bindingIndex;return t.bindingIndex=t.bindingIndex+e,n}(2);_.firstUpdatePass&&function Jy(e,t,n,s){const d=e.data;if(null===d[n+1]){const _=d[Hr()],E=function vx(e,t){return t>=e.expandoStartIndex}(e,n);(function T(e,t){return 0!=(e.flags&(t?8:16))})(_,s)&&null===t&&!E&&(t=!1),t=function xx(e,t,n,s){const d=function id(e){const t=Sn.lFrame.currentDirectiveIndex;return-1===t?null:e[t]}(e);let _=s?t.residualClasses:t.residualStyles;if(null===d)0===(s?t.classBindings:t.styleBindings)&&(n=a(n=ev(null,e,t,n,s),t.attrs,s),_=null);else{const E=t.directiveStylingLast;if(-1===E||e[E]!==d)if(n=ev(d,e,t,n,s),null===_){let R=function Jw(e,t,n){const s=n?t.classBindings:t.styleBindings;if(0!==Id(s))return e[xu(s)]}(e,t,s);void 0!==R&&Array.isArray(R)&&(R=ev(null,e,t,R[1],s),R=a(R,t.attrs,s),function Fg(e,t,n,s){e[xu(n?t.classBindings:t.styleBindings)]=s}(e,t,s,R))}else _=function bx(e,t,n){let s;const d=t.directiveEnd;for(let _=1+t.directiveStylingLast;_<d;_++)s=a(s,e[_].hostAttrs,n);return a(s,t.attrs,n)}(e,t,s)}return void 0!==_&&(s?t.residualClasses=_:t.residualStyles=_),n}(d,_,t,s),function Rg(e,t,n,s,d,_){let E=_?t.classBindings:t.styleBindings,S=xu(E),R=Id(E);e[s]=n;let $,z=!1;if(Array.isArray(n)?($=n[1],(null===$||Ne(n,$)>0)&&(z=!0)):$=n,d)if(0!==R){const we=xu(e[S+1]);e[s+1]=Mg(we,S),0!==we&&(e[we+1]=fx(e[we+1],s)),e[S+1]=function Xw(e,t){return 131071&e|t<<17}(e[S+1],s)}else e[s+1]=Mg(S,0),0!==S&&(e[S+1]=fx(e[S+1],s)),S=s;else e[s+1]=Mg(R,0),0===S?S=s:e[R+1]=fx(e[R+1],s),R=s;z&&(e[s+1]=Xy(e[s+1])),px(e,$,s,!0),px(e,$,s,!1),function Og(e,t,n,s,d){const _=d?e.residualClasses:e.residualStyles;null!=_&&"string"==typeof t&&Ne(_,t)>=0&&(n[s+1]=Yy(n[s+1]))}(t,$,e,s,_),E=Mg(S,R),_?t.classBindings=E:t.styleBindings=E}(d,_,t,n,E,s)}}(_,e,E,s),t!==si&&gs(d,E,t)&&function m(e,t,n,s,d,_,E,S){if(!(3&t.type))return;const R=e.data,z=R[S+1],$=function VT(e){return 1==(1&e)}(z)?g(R,t,n,d,Id(z),E):void 0;x($)||(x(_)||function BT(e){return 2==(2&e)}(z)&&(_=g(R,null,n,d,S,E)),function _b(e,t,n,s,d){if(t)d?e.addClass(n,s):e.removeClass(n,s);else{let _=-1===s.indexOf("-")?void 0:vl.DashCase;null==d?e.removeStyle(n,s,_):("string"==typeof d&&d.endsWith("!important")&&(d=d.slice(0,-10),_|=vl.Important),e.setStyle(n,s,d,_))}}(s,E,Gs(Hr(),n),d,_))}(_,_.data[Hr()],d,d[Fn],e,d[E+1]=function w(e,t){return null==e||""===e||("string"==typeof t?e+=t:"object"==typeof e&&(e=ur(function fd(e){return e instanceof xl?e.changingThisBreaksApplicationSecurity:e}(e)))),e}(t,n),s,E)}(e,t,null,!0),Mp}function ev(e,t,n,s,d){let _=null;const E=n.directiveEnd;let S=n.directiveStylingLast;for(-1===S?S=n.directiveStart:S++;S<E&&(_=t[S],s=a(s,_.hostAttrs,d),_!==e);)S++;return null!==e&&(n.directiveStylingLast=S),s}function a(e,t,n){const s=n?1:2;let d=-1;if(null!==t)for(let _=0;_<t.length;_++){const E=t[_];"number"==typeof E?d=E:d===s&&(Array.isArray(e)||(e=void 0===e?[]:["",e]),De(e,E,!!n||t[++_]))}return void 0===e?null:e}function g(e,t,n,s,d,_){const E=null===t;let S;for(;d>0;){const R=e[d],z=Array.isArray(R),$=z?R[1]:R,J=null===$;let we=n[d+1];we===si&&(we=J?qi:void 0);let ve=J?_e(we,s):$===s?we:void 0;if(z&&!x(ve)&&(ve=_e(R,s)),x(ve)&&(S=ve,E))return S;const Oe=e[d+1];d=E?xu(Oe):Id(Oe)}if(null!==t){let R=_?t.residualClasses:t.residualStyles;null!=R&&(S=_e(R,s))}return S}function x(e){return void 0!==e}function I(e,t=""){const n=At(),s=bi(),d=e+xi,_=s.firstCreatePass?$h(s,d,1,t,null):s.data[d],E=A(s,n,_,t,e);n[d]=E,rd()&&Mh(s,n,E,_),Ts(_,!1)}let A=(e,t,n,s,d)=>(xa(!0),function Bm(e,t){return e.createText(t)}(t[Fn],s));function V(e,t,n){const s=At(),d=function Yh(e,t,n,s){return gs(e,oc(),n)?t+qn(n)+s:si}(s,e,t,n);return d!==si&&function gu(e,t,n){const s=Gs(t,e);!function A_(e,t,n){e.setValue(t,n)}(e[Fn],s,n)}(s,Hr(),d),V}function vn(e,t,n){const s=At();return gs(s,oc(),t)&&ms(bi(),yr(),s,e,t,s[Fn],n,!0),vn}const tn="en-US";let fi=tn;function XT(e,t,n,s,d){if(e=Nn(e),Array.isArray(e))for(let _=0;_<e.length;_++)XT(e[_],t,n,s,d);else{const _=bi(),E=At(),S=ko();let R=mc(e)?e:Nn(e.provide);const z=Nh(e),$=1048575&S.providerIndexes,J=S.directiveStart,we=S.providerIndexes>>20;if(mc(e)||!e.multi){const ve=new od(z,d,Dt),Oe=KT(R,t,d?$:$+we,J);-1===Oe?(Pm(uc(S,E),_,R),YT(_,e,t.length),t.push(R),S.directiveStart++,S.directiveEnd++,d&&(S.providerIndexes+=1048576),n.push(ve),E.push(ve)):(n[Oe]=ve,E[Oe]=ve)}else{const ve=KT(R,t,$+we,J),Oe=KT(R,t,$,$+we),mt=Oe>=0&&n[Oe];if(d&&!mt||!d&&!(ve>=0&&n[ve])){Pm(uc(S,E),_,R);const Rt=function $R(e,t,n,s,d){const _=new od(e,n,Dt);return _.multi=[],_.index=t,_.componentProviders=0,KC(_,d,s&&!n),_}(d?GR:HR,n.length,d,s,z);!d&&mt&&(n[Oe].providerFactory=Rt),YT(_,e,t.length,0),t.push(R),S.directiveStart++,S.directiveEnd++,d&&(S.providerIndexes+=1048576),n.push(Rt),E.push(Rt)}else YT(_,e,ve>-1?ve:Oe,KC(n[d?Oe:ve],z,!d&&s));!d&&s&&mt&&n[Oe].componentProviders++}}}function YT(e,t,n,s){const d=mc(t),_=function np(e){return!!e.useClass}(t);if(d||_){const R=(_?Nn(t.useClass):t).prototype.ngOnDestroy;if(R){const z=e.destroyHooks||(e.destroyHooks=[]);if(!d&&t.multi){const $=z.indexOf(n);-1===$?z.push(n,[s,R]):z[$+1].push(s,R)}else z.push(n,R)}}}function KC(e,t,n){return n&&e.componentProviders++,e.multi.push(t)-1}function KT(e,t,n,s){for(let d=n;d<s;d++)if(t[d]===e)return d;return-1}function HR(e,t,n,s){return QT(this.multi,[])}function GR(e,t,n,s){const d=this.multi;let _;if(this.providerFactory){const E=this.providerFactory.componentProviders,S=co(n,n[Qt],this.providerFactory.index,s);_=S.slice(0,E),QT(d,_);for(let R=E;R<S.length;R++)_.push(S[R])}else _=[],QT(d,_);return _}function QT(e,t){for(let n=0;n<e.length;n++)t.push((0,e[n])());return t}function io(e,t=[]){return n=>{n.providersResolver=(s,d)=>function UR(e,t,n){const s=bi();if(s.firstCreatePass){const d=as(e);XT(n,s.data,s.blueprint,d,!0),XT(t,s.data,s.blueprint,d,!1)}}(s,d?d(e):e,t)}}class kg{}class qR{}class JT extends kg{constructor(t,n,s){super(),this._parent=n,this._bootstrapComponents=[],this.destroyCbs=[],this.componentFactoryResolver=new Wh(this);const d=function Hs(e,t){const n=e[Bc]||null;if(!n&&!0===t)throw new Error(`Type ${ur(e)} does not have '\u0275mod' property.`);return n}(t);this._bootstrapComponents=function hu(e){return e instanceof Function?e():e}(d.bootstrap),this._r3Injector=Hb(t,n,[{provide:kg,useValue:this},{provide:up,useValue:this.componentFactoryResolver},...s],ur(t),new Set(["environment"])),this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(t)}get injector(){return this._r3Injector}destroy(){const t=this._r3Injector;!t.destroyed&&t.destroy(),this.destroyCbs.forEach(n=>n()),this.destroyCbs=null}onDestroy(t){this.destroyCbs.push(t)}}class eD extends qR{constructor(t){super(),this.moduleType=t}create(t){return new JT(this.moduleType,t,[])}}function EO(){return this._results[Symbol.iterator]()}class Sx{get changes(){return this._changes||(this._changes=new fo)}constructor(t=!1){this._emitDistinctChangesOnly=t,this.dirty=!0,this._results=[],this._changesDetected=!1,this._changes=null,this.length=0,this.first=void 0,this.last=void 0;const n=Sx.prototype;n[Symbol.iterator]||(n[Symbol.iterator]=EO)}get(t){return this._results[t]}map(t){return this._results.map(t)}filter(t){return this._results.filter(t)}find(t){return this._results.find(t)}reduce(t,n){return this._results.reduce(t,n)}forEach(t){this._results.forEach(t)}some(t){return this._results.some(t)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(t,n){const s=this;s.dirty=!1;const d=function ae(e){return e.flat(Number.POSITIVE_INFINITY)}(t);(this._changesDetected=!function pe(e,t,n){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++){let d=e[s],_=t[s];if(n&&(d=n(d),_=n(_)),_!==d)return!1}return!0}(s._results,d,n))&&(s._results=d,s.length=d.length,s.last=d[this.length-1],s.first=d[0])}notifyOnChanges(){this._changes&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.emit(this)}setDirty(){this.dirty=!0}destroy(){this.changes.complete(),this.changes.unsubscribe()}}function DO(e,t,n,s=!0){const d=t[Qt];if(function xE(e,t,n,s){const d=ao+s,_=n.length;s>0&&(n[d-1][ws]=t),s<_-ao?(t[ws]=n[d],ue(n,ao+s,t)):(n.push(t),t[ws]=null),t[Or]=n;const E=t[jc];null!==E&&n!==E&&function bE(e,t){const n=e[Hc];t[Br]!==t[Or][Or][Br]&&(e[rm]=!0),null===n?e[Hc]=[t]:n.push(t)}(E,t);const S=t[ss];null!==S&&S.insertView(e),t[ei]|=128}(d,t,e,n),s){const _=P_(n,e),E=t[Fn],S=Um(E,e[ea]);null!==S&&function Vm(e,t,n,s,d,_){s[zr]=d,s[Ro]=t,$m(e,s,n,1,d,_)}(d,e[Ro],E,t,S,_)}}let Ad=(()=>{class e{static{this.__NG_ELEMENT_ID__=IO}}return e})();const SO=Ad,CO=class extends SO{constructor(t,n,s){super(),this._declarationLView=t,this._declarationTContainer=n,this.elementRef=s}get ssrId(){return this._declarationTContainer.tView?.ssrId||null}createEmbeddedView(t,n){return this.createEmbeddedViewImpl(t,n)}createEmbeddedViewImpl(t,n,s){const d=function TO(e,t,n,s){const d=t.tView,S=gp(e,d,n,4096&e[ei]?4096:16,null,t,null,null,null,s?.injector??null,s?.hydrationInfo??null);S[jc]=e[t.index];const z=e[ss];return null!==z&&(S[ss]=z.createEmbeddedView(d)),Ty(d,S,n),S}(this._declarationLView,this._declarationTContainer,t,{injector:n,hydrationInfo:s});return new vg(d)}};function IO(){return s1(ko(),At())}function s1(e,t){return 4&e.type?new CO(t,e,dp(e,t)):null}let wu=(()=>{class e{static{this.__NG_ELEMENT_ID__=FO}}return e})();function FO(){return gI(ko(),At())}const kO=wu,pI=class extends kO{constructor(t,n,s){super(),this._lContainer=t,this._hostTNode=n,this._hostLView=s}get element(){return dp(this._hostTNode,this._hostLView)}get injector(){return new fs(this._hostTNode,this._hostLView)}get parentInjector(){const t=dc(this._hostTNode,this._hostLView);if(Im(t)){const n=gl(t,this._hostLView),s=iu(t);return new fs(n[Qt].data[s+8],n)}return new fs(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(t){const n=mI(this._lContainer);return null!==n&&n[t]||null}get length(){return this._lContainer.length-ao}createEmbeddedView(t,n,s){let d,_;"number"==typeof s?d=s:null!=s&&(d=s.index,_=s.injector);const S=t.createEmbeddedViewImpl(n||{},_,null);return this.insertImpl(S,d,false),S}createComponent(t,n,s,d,_){const E=t&&!function de(e){return"function"==typeof e}(t);let S;if(E)S=n;else{const He=n||{};S=He.index,s=He.injector,d=He.projectableNodes,_=He.environmentInjector||He.ngModuleRef}const R=E?t:new Ep(Jn(t)),z=s||this.parentInjector;if(!_&&null==R.ngModule){const mt=(E?z:this.parentInjector).get(bl,null);mt&&(_=mt)}Jn(R.componentType??{});const ve=R.create(z,d,null,_);return this.insertImpl(ve.hostView,S,false),ve}insert(t,n){return this.insertImpl(t,n,!1)}insertImpl(t,n,s){const d=t._lView;if(function Xc(e){return Fo(e[Or])}(d)){const R=this.indexOf(t);if(-1!==R)this.detach(R);else{const z=d[Or],$=new pI(z,z[Ro],z[Or]);$.detach($.indexOf(t))}}const E=this._adjustIndex(n),S=this._lContainer;return DO(S,d,E,!s),t.attachToViewContainerRef(),ue(nD(S),E,t),t}move(t,n){return this.insert(t,n)}indexOf(t){const n=mI(this._lContainer);return null!==n?n.indexOf(t):-1}remove(t){const n=this._adjustIndex(t,-1),s=jm(this._lContainer,n);s&&(Me(nD(this._lContainer),n),cu(s[Qt],s))}detach(t){const n=this._adjustIndex(t,-1),s=jm(this._lContainer,n);return s&&null!=Me(nD(this._lContainer),n)?new vg(s):null}_adjustIndex(t,n=0){return t??this.length+n}};function mI(e){return e[8]}function nD(e){return e[8]||(e[8]=[])}function gI(e,t){let n;const s=t[e.index];return Fo(s)?n=s:(n=z0(s,t,null,e),t[e.index]=n,hg(t,n)),_I(n,t,e,s),new pI(n,e,t)}let _I=function yI(e,t,n,s){if(e[ea])return;let d;d=8&n.type?dr(s):function LO(e,t){const n=e[Fn],s=n.createComment(""),d=Tn(t,e);return Ih(n,Um(n,d),s,function Hm(e,t){return e.nextSibling(t)}(n,d),!1),s}(t,n),e[ea]=d};class iD{constructor(t){this.queryList=t,this.matches=null}clone(){return new iD(this.queryList)}setDirty(){this.queryList.setDirty()}}class rD{constructor(t=[]){this.queries=t}createEmbeddedView(t){const n=t.queries;if(null!==n){const s=null!==t.contentQueries?t.contentQueries[0]:n.length,d=[];for(let _=0;_<s;_++){const E=n.getByIndex(_);d.push(this.queries[E.indexInDeclarationView].clone())}return new rD(d)}return null}insertView(t){this.dirtyQueriesWithMatches(t)}detachView(t){this.dirtyQueriesWithMatches(t)}dirtyQueriesWithMatches(t){for(let n=0;n<this.queries.length;n++)null!==SI(t,n).matches&&this.queries[n].setDirty()}}class vI{constructor(t,n,s=null){this.predicate=t,this.flags=n,this.read=s}}class oD{constructor(t=[]){this.queries=t}elementStart(t,n){for(let s=0;s<this.queries.length;s++)this.queries[s].elementStart(t,n)}elementEnd(t){for(let n=0;n<this.queries.length;n++)this.queries[n].elementEnd(t)}embeddedTView(t){let n=null;for(let s=0;s<this.length;s++){const d=null!==n?n.length:0,_=this.getByIndex(s).embeddedTView(t,d);_&&(_.indexInDeclarationView=s,null!==n?n.push(_):n=[_])}return null!==n?new oD(n):null}template(t,n){for(let s=0;s<this.queries.length;s++)this.queries[s].template(t,n)}getByIndex(t){return this.queries[t]}get length(){return this.queries.length}track(t){this.queries.push(t)}}class sD{constructor(t,n=-1){this.metadata=t,this.matches=null,this.indexInDeclarationView=-1,this.crossesNgTemplate=!1,this._appliesToNextNode=!0,this._declarationNodeIndex=n}elementStart(t,n){this.isApplyingToNode(n)&&this.matchTNode(t,n)}elementEnd(t){this._declarationNodeIndex===t.index&&(this._appliesToNextNode=!1)}template(t,n){this.elementStart(t,n)}embeddedTView(t,n){return this.isApplyingToNode(t)?(this.crossesNgTemplate=!0,this.addMatch(-t.index,n),new sD(this.metadata)):null}isApplyingToNode(t){if(this._appliesToNextNode&&1!=(1&this.metadata.flags)){const n=this._declarationNodeIndex;let s=t.parent;for(;null!==s&&8&s.type&&s.index!==n;)s=s.parent;return n===(null!==s?s.index:-1)}return this._appliesToNextNode}matchTNode(t,n){const s=this.metadata.predicate;if(Array.isArray(s))for(let d=0;d<s.length;d++){const _=s[d];this.matchTNodeWithReadOption(t,n,BO(n,_)),this.matchTNodeWithReadOption(t,n,hs(n,t,_,!1,!1))}else s===Ad?4&n.type&&this.matchTNodeWithReadOption(t,n,-1):this.matchTNodeWithReadOption(t,n,hs(n,t,s,!1,!1))}matchTNodeWithReadOption(t,n,s){if(null!==s){const d=this.metadata.read;if(null!==d)if(d===Xo||d===wu||d===Ad&&4&n.type)this.addMatch(n.index,-2);else{const _=hs(n,t,d,!1,!1);null!==_&&this.addMatch(n.index,_)}else this.addMatch(n.index,s)}}addMatch(t,n){null===this.matches?this.matches=[t,n]:this.matches.push(t,n)}}function BO(e,t){const n=e.localNames;if(null!==n)for(let s=0;s<n.length;s+=2)if(n[s]===t)return n[s+1];return null}function jO(e,t,n,s){return-1===n?function VO(e,t){return 11&e.type?dp(e,t):4&e.type?s1(e,t):null}(t,e):-2===n?function UO(e,t,n){return n===Xo?dp(t,e):n===Ad?s1(t,e):n===wu?gI(t,e):void 0}(e,t,s):co(e,e[Qt],n,t)}function xI(e,t,n,s){const d=t[ss].queries[s];if(null===d.matches){const _=e.data,E=n.matches,S=[];for(let R=0;R<E.length;R+=2){const z=E[R];S.push(z<0?null:jO(t,_[z],E[R+1],n.metadata.read))}d.matches=S}return d.matches}function aD(e,t,n,s){const d=e.queries.getByIndex(n),_=d.matches;if(null!==_){const E=xI(e,t,d,n);for(let S=0;S<_.length;S+=2){const R=_[S];if(R>0)s.push(E[S/2]);else{const z=_[S+1],$=t[-R];for(let J=ao;J<$.length;J++){const we=$[J];we[jc]===we[Or]&&aD(we[Qt],we,z,s)}if(null!==$[Hc]){const J=$[Hc];for(let we=0;we<J.length;we++){const ve=J[we];aD(ve[Qt],ve,z,s)}}}}}return s}function bI(e){const t=At(),n=bi(),s=Qc();Ba(s+1);const d=SI(n,s);if(e.dirty&&function p_(e){return 4==(4&e[ei])}(t)===(2==(2&d.metadata.flags))){if(null===d.matches)e.reset([]);else{const _=d.crossesNgTemplate?aD(n,t,s,[]):xI(n,t,d,s);e.reset(_,qE),e.notifyOnChanges()}return!0}return!1}function wI(e,t,n){const s=bi();s.firstCreatePass&&(function DI(e,t,n){null===e.queries&&(e.queries=new oD),e.queries.track(new sD(t,n))}(s,new vI(e,t,n),-1),2==(2&t)&&(s.staticViewQueries=!0)),function TI(e,t,n){const s=new Sx(4==(4&n));(function dw(e,t,n,s){const d=B0(t);d.push(n),e.firstCreatePass&&yw(e).push(s,d.length-1)})(e,t,s,s.destroy),null===t[ss]&&(t[ss]=new rD),t[ss].queries.push(new iD(s))}(s,At(),t)}function SI(e,t){return e.queries.getByIndex(t)}const fF=new Xt("Application Initializer");let hD=(()=>{class e{constructor(){this.initialized=!1,this.done=!1,this.donePromise=new Promise((n,s)=>{this.resolve=n,this.reject=s}),this.appInits=ui(fF,{optional:!0})??[]}runInitializers(){if(this.initialized)return;const n=[];for(const d of this.appInits){const _=d();if(Ig(_))n.push(_);else if(dx(_)){const E=new Promise((S,R)=>{_.subscribe({complete:S,error:R})});n.push(E)}}const s=()=>{this.done=!0,this.resolve()};Promise.all(n).then(()=>{s()}).catch(d=>{this.reject(d)}),0===n.length&&s(),this.initialized=!0}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();const Md=new Xt("LocaleId",{providedIn:"root",factory:()=>ui(Md,Hn.Optional|Hn.SkipSelf)||function mF(){return typeof $localize<"u"&&$localize.locale||tn}()});let yF=(()=>{class e{constructor(){this.taskId=0,this.pendingTasks=new Set,this.hasPendingTasks=new Ou(!1)}add(){this.hasPendingTasks.next(!0);const n=this.taskId++;return this.pendingTasks.add(n),n}remove(n){this.pendingTasks.delete(n),0===this.pendingTasks.size&&this.hasPendingTasks.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks.next(!1)}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();const WI=new Xt(""),u1=new Xt("");let _D,mD=(()=>{class e{constructor(n,s,d){this._ngZone=n,this.registry=s,this._pendingCount=0,this._isZoneStable=!0,this._didWork=!1,this._callbacks=[],this.taskTrackingZone=null,_D||(function jF(e){_D=e}(d),d.addToWindow(s)),this._watchAngularEvents(),n.run(()=>{this.taskTrackingZone=typeof Zone>"u"?null:Zone.current.get("TaskTrackingZone")})}_watchAngularEvents(){this._ngZone.onUnstable.subscribe({next:()=>{this._didWork=!0,this._isZoneStable=!1}}),this._ngZone.runOutsideAngular(()=>{this._ngZone.onStable.subscribe({next:()=>{Ti.assertNotInAngularZone(),queueMicrotask(()=>{this._isZoneStable=!0,this._runCallbacksIfReady()})}})})}increasePendingRequestCount(){return this._pendingCount+=1,this._didWork=!0,this._pendingCount}decreasePendingRequestCount(){if(this._pendingCount-=1,this._pendingCount<0)throw new Error("pending async requests below zero");return this._runCallbacksIfReady(),this._pendingCount}isStable(){return this._isZoneStable&&0===this._pendingCount&&!this._ngZone.hasPendingMacrotasks}_runCallbacksIfReady(){if(this.isStable())queueMicrotask(()=>{for(;0!==this._callbacks.length;){let n=this._callbacks.pop();clearTimeout(n.timeoutId),n.doneCb(this._didWork)}this._didWork=!1});else{let n=this.getPendingTasks();this._callbacks=this._callbacks.filter(s=>!s.updateCb||!s.updateCb(n)||(clearTimeout(s.timeoutId),!1)),this._didWork=!0}}getPendingTasks(){return this.taskTrackingZone?this.taskTrackingZone.macroTasks.map(n=>({source:n.source,creationLocation:n.creationLocation,data:n.data})):[]}addCallback(n,s,d){let _=-1;s&&s>0&&(_=setTimeout(()=>{this._callbacks=this._callbacks.filter(E=>E.timeoutId!==_),n(this._didWork,this.getPendingTasks())},s)),this._callbacks.push({doneCb:n,timeoutId:_,updateCb:d})}whenStable(n,s,d){if(d&&!this.taskTrackingZone)throw new Error('Task tracking zone is required when passing an update callback to whenStable(). Is "zone.js/plugins/task-tracking" loaded?');this.addCallback(n,s,d),this._runCallbacksIfReady()}getPendingRequestCount(){return this._pendingCount}registerApplication(n){this.registry.registerApplication(n,this)}unregisterApplication(n){this.registry.unregisterApplication(n)}findProviders(n,s,d){return[]}static{this.\u0275fac=function(s){return new(s||e)(gt(Ti),gt(gD),gt(u1))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})(),gD=(()=>{class e{constructor(){this._applications=new Map}registerApplication(n,s){this._applications.set(n,s)}unregisterApplication(n){this._applications.delete(n)}unregisterAllApplications(){this._applications.clear()}getTestability(n){return this._applications.get(n)||null}getAllTestabilities(){return Array.from(this._applications.values())}getAllRootElements(){return Array.from(this._applications.keys())}findTestabilityInTree(n,s=!0){return _D?.findTestabilityInTree(this,n,s)??null}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"platform"})}}return e})(),Op=null;const ZI=new Xt("AllowMultipleToken"),yD=new Xt("PlatformDestroyListeners"),XI=new Xt("appBootstrapListener");function QI(e,t,n=[]){const s=`Platform: ${t}`,d=new Xt(s);return(_=[])=>{let E=vD();if(!E||E.injector.get(ZI,!1)){const S=[...n,..._,{provide:d,useValue:!0}];e?e(S):function GF(e){if(Op&&!Op.get(ZI,!1))throw new wt(400,!1);(function YI(){!function uh(e){Ff=e}(()=>{throw new wt(600,!1)})})(),Op=e;const t=e.get(eA);(function KI(e){e.get(op,null)?.forEach(n=>n())})(e)}(function JI(e=[],t){return Yo.create({name:t,providers:[{provide:Lh,useValue:"platform"},{provide:yD,useValue:new Set([()=>Op=null])},...e]})}(S,s))}return function qF(e){const t=vD();if(!t)throw new wt(401,!1);return t}()}}function vD(){return Op?.get(eA)??null}let eA=(()=>{class e{constructor(n){this._injector=n,this._modules=[],this._destroyListeners=[],this._destroyed=!1}bootstrapModuleFactory(n,s){const d=function WF(e="zone.js",t){return"noop"===e?new eT:"zone.js"===e?new Ti(t):e}(s?.ngZone,function tA(e){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:e?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:e?.runCoalescing??!1}}({eventCoalescing:s?.ngZoneEventCoalescing,runCoalescing:s?.ngZoneRunCoalescing}));return d.run(()=>{const _=function ZR(e,t,n){return new JT(e,t,n)}(n.moduleType,this.injector,function sA(e){return[{provide:Ti,useFactory:e},{provide:pc,multi:!0,useFactory:()=>{const t=ui(XF,{optional:!0});return()=>t.initialize()}},{provide:oA,useFactory:ZF},{provide:Jb,useFactory:ew}]}(()=>d)),E=_.injector.get(wl,null);return d.runOutsideAngular(()=>{const S=d.onError.subscribe({next:R=>{E.handleError(R)}});_.onDestroy(()=>{d1(this._modules,_),S.unsubscribe()})}),function nA(e,t,n){try{const s=n();return Ig(s)?s.catch(d=>{throw t.runOutsideAngular(()=>e.handleError(d)),d}):s}catch(s){throw t.runOutsideAngular(()=>e.handleError(s)),s}}(E,d,()=>{const S=_.injector.get(hD);return S.runInitializers(),S.donePromise.then(()=>(function _i(e){Yr(e,"Expected localeId to be defined"),"string"==typeof e&&(fi=e.toLowerCase().replace(/_/g,"-"))}(_.injector.get(Md,tn)||tn),this._moduleDoBootstrap(_),_))})})}bootstrapModule(n,s=[]){const d=iA({},s);return function UF(e,t,n){const s=new eD(n);return Promise.resolve(s)}(0,0,n).then(_=>this.bootstrapModuleFactory(_,d))}_moduleDoBootstrap(n){const s=n.injector.get(Lg);if(n._bootstrapComponents.length>0)n._bootstrapComponents.forEach(d=>s.bootstrap(d));else{if(!n.instance.ngDoBootstrap)throw new wt(-403,!1);n.instance.ngDoBootstrap(s)}this._modules.push(n)}onDestroy(n){this._destroyListeners.push(n)}get injector(){return this._injector}destroy(){if(this._destroyed)throw new wt(404,!1);this._modules.slice().forEach(s=>s.destroy()),this._destroyListeners.forEach(s=>s());const n=this._injector.get(yD,null);n&&(n.forEach(s=>s()),n.clear()),this._destroyed=!0}get destroyed(){return this._destroyed}static{this.\u0275fac=function(s){return new(s||e)(gt(Yo))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"platform"})}}return e})();function iA(e,t){return Array.isArray(t)?t.reduce(iA,e):{...e,...t}}let Lg=(()=>{class e{constructor(){this._bootstrapListeners=[],this._runningTick=!1,this._destroyed=!1,this._destroyListeners=[],this._views=[],this.internalErrorHandler=ui(oA),this.zoneIsStable=ui(Jb),this.componentTypes=[],this.components=[],this.isStable=ui(yF).hasPendingTasks.pipe(function Xs(e,t){return vi((n,s)=>{let d=null,_=0,E=!1;const S=()=>E&&!d&&s.complete();n.subscribe(nr(s,R=>{d?.unsubscribe();let z=0;const $=_++;Ie(e(R,$)).subscribe(d=nr(s,J=>s.next(t?t(R,J,$,z++):J),()=>{d=null,S()}))},()=>{E=!0,S()}))})}(n=>n?Dc(!1):this.zoneIsStable),Ra(),Zs()),this._injector=ui(bl)}get destroyed(){return this._destroyed}get injector(){return this._injector}bootstrap(n,s){const d=n instanceof ry;if(!this._injector.get(hD).done)throw!d&&function Vc(e){const t=Jn(e)||nn(e)||os(e);return null!==t&&t.standalone}(n),new wt(405,!1);let E;E=d?n:this._injector.get(up).resolveComponentFactory(n),this.componentTypes.push(E.componentType);const S=function HF(e){return e.isBoundToModule}(E)?void 0:this._injector.get(kg),z=E.create(Yo.NULL,[],s||E.selector,S),$=z.location.nativeElement,J=z.injector.get(WI,null);return J?.registerApplication($),z.onDestroy(()=>{this.detachView(z.hostView),d1(this.components,z),J?.unregisterApplication($)}),this._loadComponent(z),z}tick(){if(this._runningTick)throw new wt(101,!1);try{this._runningTick=!0;for(let n of this._views)n.detectChanges()}catch(n){this.internalErrorHandler(n)}finally{this._runningTick=!1}}attachView(n){const s=n;this._views.push(s),s.attachToAppRef(this)}detachView(n){const s=n;d1(this._views,s),s.detachFromAppRef()}_loadComponent(n){this.attachView(n.hostView),this.tick(),this.components.push(n);const s=this._injector.get(XI,[]);s.push(...this._bootstrapListeners),s.forEach(d=>d(n))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(n=>n()),this._views.slice().forEach(n=>n.destroy())}finally{this._destroyed=!0,this._views=[],this._bootstrapListeners=[],this._destroyListeners=[]}}onDestroy(n){return this._destroyListeners.push(n),()=>d1(this._destroyListeners,n)}destroy(){if(this._destroyed)throw new wt(406,!1);const n=this._injector;n.destroy&&!n.destroyed&&n.destroy()}get viewCount(){return this._views.length}warnIfDestroyed(){}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();function d1(e,t){const n=e.indexOf(t);n>-1&&e.splice(n,1)}const oA=new Xt("",{providedIn:"root",factory:()=>ui(wl).handleError.bind(void 0)});function ZF(){const e=ui(Ti),t=ui(wl);return n=>e.runOutsideAngular(()=>t.handleError(n))}let XF=(()=>{class e{constructor(){this.zone=ui(Ti),this.applicationRef=ui(Lg)}initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.zone.run(()=>{this.applicationRef.tick()})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();let lA=(()=>{class e{static{this.__NG_ELEMENT_ID__=KF}}return e})();function KF(e){return function QF(e,t,n){if(tc(e)&&!n){const s=Es(e.index,t);return new vg(s,s)}return 47&e.type?new vg(t[Br],t):null}(ko(),At(),16==(16&e))}const uk=QI(null,"core",[]);let dk=(()=>{class e{constructor(n){}static{this.\u0275fac=function(s){return new(s||e)(gt(Lg))}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({})}}return e})();let SD=null;function Fp(){return SD}class Tk{}const Sr=new Xt("DocumentToken");let SA=(()=>{class e{historyGo(n){throw new Error("Not implemented")}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:function(){return ui(Dk)},providedIn:"platform"})}}return e})(),Dk=(()=>{class e extends SA{constructor(){super(),this._doc=ui(Sr),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return Fp().getBaseHref(this._doc)}onPopState(n){const s=Fp().getGlobalEventTarget(this._doc,"window");return s.addEventListener("popstate",n,!1),()=>s.removeEventListener("popstate",n)}onHashChange(n){const s=Fp().getGlobalEventTarget(this._doc,"window");return s.addEventListener("hashchange",n,!1),()=>s.removeEventListener("hashchange",n)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(n){this._location.pathname=n}pushState(n,s,d){this._history.pushState(n,s,d)}replaceState(n,s,d){this._history.replaceState(n,s,d)}forward(){this._history.forward()}back(){this._history.back()}historyGo(n=0){this._history.go(n)}getState(){return this._history.state}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:function(){return new e},providedIn:"platform"})}}return e})();function CA(e,t){if(0==e.length)return t;if(0==t.length)return e;let n=0;return e.endsWith("/")&&n++,t.startsWith("/")&&n++,2==n?e+t.substring(1):1==n?e+t:e+"/"+t}function IA(e){const t=e.match(/#|\?|$/),n=t&&t.index||e.length;return e.slice(0,n-("/"===e[n-1]?1:0))+e.slice(n)}function zg(e){return e&&"?"!==e[0]?"?"+e:e}let CD=(()=>{class e{historyGo(n){throw new Error("Not implemented")}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:function(){return ui(Ck)},providedIn:"root"})}}return e})();const Sk=new Xt("appBaseHref");let Ck=(()=>{class e extends CD{constructor(n,s){super(),this._platformLocation=n,this._removeListenerFns=[],this._baseHref=s??this._platformLocation.getBaseHrefFromDOM()??ui(Sr).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(n){this._removeListenerFns.push(this._platformLocation.onPopState(n),this._platformLocation.onHashChange(n))}getBaseHref(){return this._baseHref}prepareExternalUrl(n){return CA(this._baseHref,n)}path(n=!1){const s=this._platformLocation.pathname+zg(this._platformLocation.search),d=this._platformLocation.hash;return d&&n?`${s}${d}`:s}pushState(n,s,d,_){const E=this.prepareExternalUrl(d+zg(_));this._platformLocation.pushState(n,s,E)}replaceState(n,s,d,_){const E=this.prepareExternalUrl(d+zg(_));this._platformLocation.replaceState(n,s,E)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(n=0){this._platformLocation.historyGo?.(n)}static{this.\u0275fac=function(s){return new(s||e)(gt(SA),gt(Sk,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),ID=(()=>{class e{constructor(n){this._subject=new fo,this._urlChangeListeners=[],this._urlChangeSubscription=null,this._locationStrategy=n;const s=this._locationStrategy.getBaseHref();this._basePath=function Mk(e){if(new RegExp("^(https?:)?//").test(e)){const[,n]=e.split(/\/\/[^\/]+/);return n}return e}(IA(AA(s))),this._locationStrategy.onPopState(d=>{this._subject.emit({url:this.path(!0),pop:!0,state:d.state,type:d.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(n=!1){return this.normalize(this._locationStrategy.path(n))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(n,s=""){return this.path()==this.normalize(n+zg(s))}normalize(n){return e.stripTrailingSlash(function Ak(e,t){if(!e||!t.startsWith(e))return t;const n=t.substring(e.length);return""===n||["/",";","?","#"].includes(n[0])?n:t}(this._basePath,AA(n)))}prepareExternalUrl(n){return n&&"/"!==n[0]&&(n="/"+n),this._locationStrategy.prepareExternalUrl(n)}go(n,s="",d=null){this._locationStrategy.pushState(d,"",n,s),this._notifyUrlChangeListeners(this.prepareExternalUrl(n+zg(s)),d)}replaceState(n,s="",d=null){this._locationStrategy.replaceState(d,"",n,s),this._notifyUrlChangeListeners(this.prepareExternalUrl(n+zg(s)),d)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(n=0){this._locationStrategy.historyGo?.(n)}onUrlChange(n){return this._urlChangeListeners.push(n),this._urlChangeSubscription||(this._urlChangeSubscription=this.subscribe(s=>{this._notifyUrlChangeListeners(s.url,s.state)})),()=>{const s=this._urlChangeListeners.indexOf(n);this._urlChangeListeners.splice(s,1),0===this._urlChangeListeners.length&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(n="",s){this._urlChangeListeners.forEach(d=>d(n,s))}subscribe(n,s,d){return this._subject.subscribe({next:n,error:s,complete:d})}static{this.normalizeQueryParams=zg}static{this.joinWithSlash=CA}static{this.stripTrailingSlash=IA}static{this.\u0275fac=function(s){return new(s||e)(gt(CD))}}static{this.\u0275prov=Jt({token:e,factory:function(){return function Ik(){return new ID(gt(CD))}()},providedIn:"root"})}}return e})();function AA(e){return e.replace(/\/index.html$/,"")}let $L=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({})}}return e})();const GA="browser";function $A(e){return"server"===e}class xN extends Tk{constructor(){super(...arguments),this.supportsDOMEvents=!0}}class $D extends xN{static makeCurrent(){!function Ek(e){SD||(SD=e)}(new $D)}onAndCancel(t,n,s){return t.addEventListener(n,s),()=>{t.removeEventListener(n,s)}}dispatchEvent(t,n){t.dispatchEvent(n)}remove(t){t.parentNode&&t.parentNode.removeChild(t)}createElement(t,n){return(n=n||this.getDefaultDocument()).createElement(t)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(t){return t.nodeType===Node.ELEMENT_NODE}isShadowRoot(t){return t instanceof DocumentFragment}getGlobalEventTarget(t,n){return"window"===n?window:"document"===n?t:"body"===n?t.body:null}getBaseHref(t){const n=function bN(){return Ox=Ox||document.querySelector("base"),Ox?Ox.getAttribute("href"):null}();return null==n?null:function wN(e){I1=I1||document.createElement("a"),I1.setAttribute("href",e);const t=I1.pathname;return"/"===t.charAt(0)?t:`/${t}`}(n)}resetBaseElement(){Ox=null}getUserAgent(){return window.navigator.userAgent}getCookie(t){return function pL(e,t){t=encodeURIComponent(t);for(const n of e.split(";")){const s=n.indexOf("="),[d,_]=-1==s?[n,""]:[n.slice(0,s),n.slice(s+1)];if(d.trim()===t)return decodeURIComponent(_)}return null}(document.cookie,t)}}let I1,Ox=null,TN=(()=>{class e{build(){return new XMLHttpRequest}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();const qD=new Xt("EventManagerPlugins");let YA=(()=>{class e{constructor(n,s){this._zone=s,this._eventNameToPlugin=new Map,n.forEach(d=>{d.manager=this}),this._plugins=n.slice().reverse()}addEventListener(n,s,d){return this._findPluginFor(s).addEventListener(n,s,d)}getZone(){return this._zone}_findPluginFor(n){let s=this._eventNameToPlugin.get(n);if(s)return s;if(s=this._plugins.find(_=>_.supports(n)),!s)throw new wt(5101,!1);return this._eventNameToPlugin.set(n,s),s}static{this.\u0275fac=function(s){return new(s||e)(gt(qD),gt(Ti))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();class KA{constructor(t){this._doc=t}}const WD="ng-app-id";let QA=(()=>{class e{constructor(n,s,d,_={}){this.doc=n,this.appId=s,this.nonce=d,this.platformId=_,this.styleRef=new Map,this.hostNodes=new Set,this.styleNodesInDOM=this.collectServerRenderedStyles(),this.platformIsServer=$A(_),this.resetHostNodes()}addStyles(n){for(const s of n)1===this.changeUsageCount(s,1)&&this.onStyleAdded(s)}removeStyles(n){for(const s of n)this.changeUsageCount(s,-1)<=0&&this.onStyleRemoved(s)}ngOnDestroy(){const n=this.styleNodesInDOM;n&&(n.forEach(s=>s.remove()),n.clear());for(const s of this.getAllStyles())this.onStyleRemoved(s);this.resetHostNodes()}addHost(n){this.hostNodes.add(n);for(const s of this.getAllStyles())this.addStyleToHost(n,s)}removeHost(n){this.hostNodes.delete(n)}getAllStyles(){return this.styleRef.keys()}onStyleAdded(n){for(const s of this.hostNodes)this.addStyleToHost(s,n)}onStyleRemoved(n){const s=this.styleRef;s.get(n)?.elements?.forEach(d=>d.remove()),s.delete(n)}collectServerRenderedStyles(){const n=this.doc.head?.querySelectorAll(`style[${WD}="${this.appId}"]`);if(n?.length){const s=new Map;return n.forEach(d=>{null!=d.textContent&&s.set(d.textContent,d)}),s}return null}changeUsageCount(n,s){const d=this.styleRef;if(d.has(n)){const _=d.get(n);return _.usage+=s,_.usage}return d.set(n,{usage:s,elements:[]}),s}getStyleElement(n,s){const d=this.styleNodesInDOM,_=d?.get(s);if(_?.parentNode===n)return d.delete(s),_.removeAttribute(WD),_;{const E=this.doc.createElement("style");return this.nonce&&E.setAttribute("nonce",this.nonce),E.textContent=s,this.platformIsServer&&E.setAttribute(WD,this.appId),E}}addStyleToHost(n,s){const d=this.getStyleElement(n,s);n.appendChild(d);const _=this.styleRef,E=_.get(s)?.elements;E?E.push(d):_.set(s,{elements:[d],usage:1})}resetHostNodes(){const n=this.hostNodes;n.clear(),n.add(this.doc.head)}static{this.\u0275fac=function(s){return new(s||e)(gt(Sr),gt(Bh),gt(sp,8),gt(gd))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();const ZD={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/MathML/"},XD=/%COMP%/g,IN=new Xt("RemoveStylesOnCompDestroy",{providedIn:"root",factory:()=>!1});function eM(e,t){return t.map(n=>n.replace(XD,e))}let YD=(()=>{class e{constructor(n,s,d,_,E,S,R,z=null){this.eventManager=n,this.sharedStylesHost=s,this.appId=d,this.removeStylesOnCompDestroy=_,this.doc=E,this.platformId=S,this.ngZone=R,this.nonce=z,this.rendererByCompId=new Map,this.platformIsServer=$A(S),this.defaultRenderer=new KD(n,E,R,this.platformIsServer)}createRenderer(n,s){if(!n||!s)return this.defaultRenderer;this.platformIsServer&&s.encapsulation===Go.ShadowDom&&(s={...s,encapsulation:Go.Emulated});const d=this.getOrCreateRenderer(n,s);return d instanceof nM?d.applyToHost(n):d instanceof QD&&d.applyStyles(),d}getOrCreateRenderer(n,s){const d=this.rendererByCompId;let _=d.get(s.id);if(!_){const E=this.doc,S=this.ngZone,R=this.eventManager,z=this.sharedStylesHost,$=this.removeStylesOnCompDestroy,J=this.platformIsServer;switch(s.encapsulation){case Go.Emulated:_=new nM(R,z,s,this.appId,$,E,S,J);break;case Go.ShadowDom:return new RN(R,z,n,s,E,S,this.nonce,J);default:_=new QD(R,z,s,$,E,S,J)}d.set(s.id,_)}return _}ngOnDestroy(){this.rendererByCompId.clear()}static{this.\u0275fac=function(s){return new(s||e)(gt(YA),gt(QA),gt(Bh),gt(IN),gt(Sr),gt(gd),gt(Ti),gt(sp))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();class KD{constructor(t,n,s,d){this.eventManager=t,this.doc=n,this.ngZone=s,this.platformIsServer=d,this.data=Object.create(null),this.destroyNode=null}destroy(){}createElement(t,n){return n?this.doc.createElementNS(ZD[n]||n,t):this.doc.createElement(t)}createComment(t){return this.doc.createComment(t)}createText(t){return this.doc.createTextNode(t)}appendChild(t,n){(tM(t)?t.content:t).appendChild(n)}insertBefore(t,n,s){t&&(tM(t)?t.content:t).insertBefore(n,s)}removeChild(t,n){t&&t.removeChild(n)}selectRootElement(t,n){let s="string"==typeof t?this.doc.querySelector(t):t;if(!s)throw new wt(-5104,!1);return n||(s.textContent=""),s}parentNode(t){return t.parentNode}nextSibling(t){return t.nextSibling}setAttribute(t,n,s,d){if(d){n=d+":"+n;const _=ZD[d];_?t.setAttributeNS(_,n,s):t.setAttribute(n,s)}else t.setAttribute(n,s)}removeAttribute(t,n,s){if(s){const d=ZD[s];d?t.removeAttributeNS(d,n):t.removeAttribute(`${s}:${n}`)}else t.removeAttribute(n)}addClass(t,n){t.classList.add(n)}removeClass(t,n){t.classList.remove(n)}setStyle(t,n,s,d){d&(vl.DashCase|vl.Important)?t.style.setProperty(n,s,d&vl.Important?"important":""):t.style[n]=s}removeStyle(t,n,s){s&vl.DashCase?t.style.removeProperty(n):t.style[n]=""}setProperty(t,n,s){t[n]=s}setValue(t,n){t.nodeValue=n}listen(t,n,s){if("string"==typeof t&&!(t=Fp().getGlobalEventTarget(this.doc,t)))throw new Error(`Unsupported event target ${t} for event ${n}`);return this.eventManager.addEventListener(t,n,this.decoratePreventDefault(s))}decoratePreventDefault(t){return n=>{if("__ngUnwrap__"===n)return t;!1===(this.platformIsServer?this.ngZone.runGuarded(()=>t(n)):t(n))&&n.preventDefault()}}}function tM(e){return"TEMPLATE"===e.tagName&&void 0!==e.content}class RN extends KD{constructor(t,n,s,d,_,E,S,R){super(t,_,E,R),this.sharedStylesHost=n,this.hostEl=s,this.shadowRoot=s.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);const z=eM(d.id,d.styles);for(const $ of z){const J=document.createElement("style");S&&J.setAttribute("nonce",S),J.textContent=$,this.shadowRoot.appendChild(J)}}nodeOrShadowRoot(t){return t===this.hostEl?this.shadowRoot:t}appendChild(t,n){return super.appendChild(this.nodeOrShadowRoot(t),n)}insertBefore(t,n,s){return super.insertBefore(this.nodeOrShadowRoot(t),n,s)}removeChild(t,n){return super.removeChild(this.nodeOrShadowRoot(t),n)}parentNode(t){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(t)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}}class QD extends KD{constructor(t,n,s,d,_,E,S,R){super(t,_,E,S),this.sharedStylesHost=n,this.removeStylesOnCompDestroy=d,this.styles=R?eM(R,s.styles):s.styles}applyStyles(){this.sharedStylesHost.addStyles(this.styles)}destroy(){this.removeStylesOnCompDestroy&&this.sharedStylesHost.removeStyles(this.styles)}}class nM extends QD{constructor(t,n,s,d,_,E,S,R){const z=d+"-"+s.id;super(t,n,s,_,E,S,R,z),this.contentAttr=function AN(e){return"_ngcontent-%COMP%".replace(XD,e)}(z),this.hostAttr=function MN(e){return"_nghost-%COMP%".replace(XD,e)}(z)}applyToHost(t){this.applyStyles(),this.setAttribute(t,this.hostAttr,"")}createElement(t,n){const s=super.createElement(t,n);return super.setAttribute(s,this.contentAttr,""),s}}let ON=(()=>{class e extends KA{constructor(n){super(n)}supports(n){return!0}addEventListener(n,s,d){return n.addEventListener(s,d,!1),()=>this.removeEventListener(n,s,d)}removeEventListener(n,s,d){return n.removeEventListener(s,d)}static{this.\u0275fac=function(s){return new(s||e)(gt(Sr))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();const iM=["alt","control","meta","shift"],FN={"\b":"Backspace","\t":"Tab","\x7f":"Delete","\x1b":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},kN={alt:e=>e.altKey,control:e=>e.ctrlKey,meta:e=>e.metaKey,shift:e=>e.shiftKey};let LN=(()=>{class e extends KA{constructor(n){super(n)}supports(n){return null!=e.parseEventName(n)}addEventListener(n,s,d){const _=e.parseEventName(s),E=e.eventCallback(_.fullKey,d,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>Fp().onAndCancel(n,_.domEventName,E))}static parseEventName(n){const s=n.toLowerCase().split("."),d=s.shift();if(0===s.length||"keydown"!==d&&"keyup"!==d)return null;const _=e._normalizeKey(s.pop());let E="",S=s.indexOf("code");if(S>-1&&(s.splice(S,1),E="code."),iM.forEach(z=>{const $=s.indexOf(z);$>-1&&(s.splice($,1),E+=z+".")}),E+=_,0!=s.length||0===_.length)return null;const R={};return R.domEventName=d,R.fullKey=E,R}static matchEventFullKeyCode(n,s){let d=FN[n.key]||n.key,_="";return s.indexOf("code.")>-1&&(d=n.code,_="code."),!(null==d||!d)&&(d=d.toLowerCase()," "===d?d="space":"."===d&&(d="dot"),iM.forEach(E=>{E!==d&&(0,kN[E])(n)&&(_+=E+".")}),_+=d,_===s)}static eventCallback(n,s,d){return _=>{e.matchEventFullKeyCode(_,n)&&d.runGuarded(()=>s(_))}}static _normalizeKey(n){return"esc"===n?"escape":n}static{this.\u0275fac=function(s){return new(s||e)(gt(Sr))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();const VN=QI(uk,"browser",[{provide:gd,useValue:GA},{provide:op,useValue:function NN(){$D.makeCurrent()},multi:!0},{provide:Sr,useFactory:function BN(){return function Zv(e){L_=e}(document),document},deps:[]}]),jN=new Xt(""),sM=[{provide:u1,useClass:class EN{addToWindow(t){gi.getAngularTestability=(s,d=!0)=>{const _=t.findTestabilityInTree(s,d);if(null==_)throw new wt(5103,!1);return _},gi.getAllAngularTestabilities=()=>t.getAllTestabilities(),gi.getAllAngularRootElements=()=>t.getAllRootElements(),gi.frameworkStabilizers||(gi.frameworkStabilizers=[]),gi.frameworkStabilizers.push(s=>{const d=gi.getAllAngularTestabilities();let _=d.length,E=!1;const S=function(R){E=E||R,_--,0==_&&s(E)};d.forEach(R=>{R.whenStable(S)})})}findTestabilityInTree(t,n,s){return null==n?null:t.getTestability(n)??(s?Fp().isShadowRoot(n)?this.findTestabilityInTree(t,n.host,!0):this.findTestabilityInTree(t,n.parentElement,!0):null)}},deps:[]},{provide:WI,useClass:mD,deps:[Ti,gD,u1]},{provide:mD,useClass:mD,deps:[Ti,gD,u1]}],aM=[{provide:Lh,useValue:"root"},{provide:wl,useFactory:function zN(){return new wl},deps:[]},{provide:qD,useClass:ON,multi:!0,deps:[Sr,Ti,gd]},{provide:qD,useClass:LN,multi:!0,deps:[Sr]},YD,QA,YA,{provide:hp,useExisting:YD},{provide:class KL{},useClass:TN,deps:[]},[]];let lM=(()=>{class e{constructor(n){}static withServerTransition(n){return{ngModule:e,providers:[{provide:Bh,useValue:n.appId}]}}static{this.\u0275fac=function(s){return new(s||e)(gt(jN,12))}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({providers:[...aM,...sM],imports:[$L,dk]})}}return e})();typeof window<"u"&&window;class hM{}class ZN{}const af="*";function mM(e,t=null){return{type:2,steps:e,options:t}}function rv(e){return{type:6,styles:e,offset:null}}class Fx{constructor(t=0,n=0){this._onDoneFns=[],this._onStartFns=[],this._onDestroyFns=[],this._originalOnDoneFns=[],this._originalOnStartFns=[],this._started=!1,this._destroyed=!1,this._finished=!1,this._position=0,this.parentPlayer=null,this.totalTime=t+n}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(t=>t()),this._onDoneFns=[])}onStart(t){this._originalOnStartFns.push(t),this._onStartFns.push(t)}onDone(t){this._originalOnDoneFns.push(t),this._onDoneFns.push(t)}onDestroy(t){this._onDestroyFns.push(t)}hasStarted(){return this._started}init(){}play(){this.hasStarted()||(this._onStart(),this.triggerMicrotask()),this._started=!0}triggerMicrotask(){queueMicrotask(()=>this._onFinish())}_onStart(){this._onStartFns.forEach(t=>t()),this._onStartFns=[]}pause(){}restart(){}finish(){this._onFinish()}destroy(){this._destroyed||(this._destroyed=!0,this.hasStarted()||this._onStart(),this.finish(),this._onDestroyFns.forEach(t=>t()),this._onDestroyFns=[])}reset(){this._started=!1,this._finished=!1,this._onStartFns=this._originalOnStartFns,this._onDoneFns=this._originalOnDoneFns}setPosition(t){this._position=this.totalTime?t*this.totalTime:1}getPosition(){return this.totalTime?this._position/this.totalTime:1}triggerCallback(t){const n="start"==t?this._onStartFns:this._onDoneFns;n.forEach(s=>s()),n.length=0}}class xM{constructor(t){this._onDoneFns=[],this._onStartFns=[],this._finished=!1,this._started=!1,this._destroyed=!1,this._onDestroyFns=[],this.parentPlayer=null,this.totalTime=0,this.players=t;let n=0,s=0,d=0;const _=this.players.length;0==_?queueMicrotask(()=>this._onFinish()):this.players.forEach(E=>{E.onDone(()=>{++n==_&&this._onFinish()}),E.onDestroy(()=>{++s==_&&this._onDestroy()}),E.onStart(()=>{++d==_&&this._onStart()})}),this.totalTime=this.players.reduce((E,S)=>Math.max(E,S.totalTime),0)}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(t=>t()),this._onDoneFns=[])}init(){this.players.forEach(t=>t.init())}onStart(t){this._onStartFns.push(t)}_onStart(){this.hasStarted()||(this._started=!0,this._onStartFns.forEach(t=>t()),this._onStartFns=[])}onDone(t){this._onDoneFns.push(t)}onDestroy(t){this._onDestroyFns.push(t)}hasStarted(){return this._started}play(){this.parentPlayer||this.init(),this._onStart(),this.players.forEach(t=>t.play())}pause(){this.players.forEach(t=>t.pause())}restart(){this.players.forEach(t=>t.restart())}finish(){this._onFinish(),this.players.forEach(t=>t.finish())}destroy(){this._onDestroy()}_onDestroy(){this._destroyed||(this._destroyed=!0,this._onFinish(),this.players.forEach(t=>t.destroy()),this._onDestroyFns.forEach(t=>t()),this._onDestroyFns=[])}reset(){this.players.forEach(t=>t.reset()),this._destroyed=!1,this._finished=!1,this._started=!1}setPosition(t){const n=t*this.totalTime;this.players.forEach(s=>{const d=s.totalTime?Math.min(1,n/s.totalTime):1;s.setPosition(d)})}getPosition(){const t=this.players.reduce((n,s)=>null===n||s.totalTime>n.totalTime?s:n,null);return null!=t?t.getPosition():0}beforeDestroy(){this.players.forEach(t=>{t.beforeDestroy&&t.beforeDestroy()})}triggerCallback(t){const n="start"==t?this._onStartFns:this._onDoneFns;n.forEach(s=>s()),n.length=0}}function bM(e){return new wt(3e3,!1)}function Lp(e){switch(e.length){case 0:return new Fx;case 1:return e[0];default:return new xM(e)}}function wM(e,t,n=new Map,s=new Map){const d=[],_=[];let E=-1,S=null;if(t.forEach(R=>{const z=R.get("offset"),$=z==E,J=$&&S||new Map;R.forEach((we,ve)=>{let Oe=ve,He=we;if("offset"!==ve)switch(Oe=e.normalizePropertyName(Oe,d),He){case"!":He=n.get(ve);break;case af:He=s.get(ve);break;default:He=e.normalizeStyleValue(ve,Oe,He,d)}J.set(Oe,He)}),$||_.push(J),S=J,E=z}),d.length)throw function yz(e){return new wt(3502,!1)}();return _}function tS(e,t,n,s){switch(t){case"start":e.onStart(()=>s(n&&nS(n,"start",e)));break;case"done":e.onDone(()=>s(n&&nS(n,"done",e)));break;case"destroy":e.onDestroy(()=>s(n&&nS(n,"destroy",e)))}}function nS(e,t,n){const _=iS(e.element,e.triggerName,e.fromState,e.toState,t||e.phaseName,n.totalTime??e.totalTime,!!n.disabled),E=e._data;return null!=E&&(_._data=E),_}function iS(e,t,n,s,d="",_=0,E){return{element:e,triggerName:t,fromState:n,toState:s,phaseName:d,totalTime:_,disabled:!!E}}function Ol(e,t,n){let s=e.get(t);return s||e.set(t,s=n),s}function EM(e){const t=e.indexOf(":");return[e.substring(1,t),e.slice(t+1)]}const Mz=(()=>typeof document>"u"?null:document.documentElement)();function rS(e){const t=e.parentNode||e.host||null;return t===Mz?null:t}let Bg=null,TM=!1;function DM(e,t){for(;t;){if(t===e)return!0;t=rS(t)}return!1}function SM(e,t,n){if(n)return Array.from(e.querySelectorAll(t));const s=e.querySelector(t);return s?[s]:[]}let CM=(()=>{class e{validateStyleProperty(n){return function Rz(e){Bg||(Bg=function Oz(){return typeof document<"u"?document.body:null}()||{},TM=!!Bg.style&&"WebkitAppearance"in Bg.style);let t=!0;return Bg.style&&!function Pz(e){return"ebkit"==e.substring(1,6)}(e)&&(t=e in Bg.style,!t&&TM&&(t="Webkit"+e.charAt(0).toUpperCase()+e.slice(1)in Bg.style)),t}(n)}matchesElement(n,s){return!1}containsElement(n,s){return DM(n,s)}getParentElement(n){return rS(n)}query(n,s,d){return SM(n,s,d)}computeStyle(n,s,d){return d||""}animate(n,s,d,_,E,S=[],R){return new Fx(d,_)}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})(),oS=(()=>{class e{static{this.NOOP=new CM}}return e})();const Fz=1e3,sS="ng-enter",A1="ng-leave",M1="ng-trigger",P1=".ng-trigger",AM="ng-animating",aS=".ng-animating";function lf(e){if("number"==typeof e)return e;const t=e.match(/^(-?[\.\d]+)(m?s)/);return!t||t.length<2?0:lS(parseFloat(t[1]),t[2])}function lS(e,t){return"s"===t?e*Fz:e}function R1(e,t,n){return e.hasOwnProperty("duration")?e:function Lz(e,t,n){let d,_=0,E="";if("string"==typeof e){const S=e.match(/^(-?[\.\d]+)(m?s)(?:\s+(-?[\.\d]+)(m?s))?(?:\s+([-a-z]+(?:\(.+?\))?))?$/i);if(null===S)return t.push(bM()),{duration:0,delay:0,easing:""};d=lS(parseFloat(S[1]),S[2]);const R=S[3];null!=R&&(_=lS(parseFloat(R),S[4]));const z=S[5];z&&(E=z)}else d=e;if(!n){let S=!1,R=t.length;d<0&&(t.push(function YN(){return new wt(3100,!1)}()),S=!0),_<0&&(t.push(function KN(){return new wt(3101,!1)}()),S=!0),S&&t.splice(R,0,bM())}return{duration:d,delay:_,easing:E}}(e,t,n)}function kx(e,t={}){return Object.keys(e).forEach(n=>{t[n]=e[n]}),t}function MM(e){const t=new Map;return Object.keys(e).forEach(n=>{t.set(n,e[n])}),t}function Np(e,t=new Map,n){if(n)for(let[s,d]of n)t.set(s,d);for(let[s,d]of e)t.set(s,d);return t}function Pd(e,t,n){t.forEach((s,d)=>{const _=uS(d);n&&!n.has(d)&&n.set(d,e.style[_]),e.style[_]=s})}function Vg(e,t){t.forEach((n,s)=>{const d=uS(s);e.style[d]=""})}function Lx(e){return Array.isArray(e)?1==e.length?e[0]:mM(e):e}const cS=new RegExp("{{\\s*(.+?)\\s*}}","g");function RM(e){let t=[];if("string"==typeof e){let n;for(;n=cS.exec(e);)t.push(n[1]);cS.lastIndex=0}return t}function Nx(e,t,n){const s=e.toString(),d=s.replace(cS,(_,E)=>{let S=t[E];return null==S&&(n.push(function JN(e){return new wt(3003,!1)}()),S=""),S.toString()});return d==s?e:d}function O1(e){const t=[];let n=e.next();for(;!n.done;)t.push(n.value),n=e.next();return t}const Bz=/-+([a-z0-9])/g;function uS(e){return e.replace(Bz,(...t)=>t[1].toUpperCase())}function Fl(e,t,n){switch(t.type){case 7:return e.visitTrigger(t,n);case 0:return e.visitState(t,n);case 1:return e.visitTransition(t,n);case 2:return e.visitSequence(t,n);case 3:return e.visitGroup(t,n);case 4:return e.visitAnimate(t,n);case 5:return e.visitKeyframes(t,n);case 6:return e.visitStyle(t,n);case 8:return e.visitReference(t,n);case 9:return e.visitAnimateChild(t,n);case 10:return e.visitAnimateRef(t,n);case 11:return e.visitQuery(t,n);case 12:return e.visitStagger(t,n);default:throw function ez(e){return new wt(3004,!1)}()}}function OM(e,t){return window.getComputedStyle(e)[t]}const F1="*";function Uz(e,t){const n=[];return"string"==typeof e?e.split(/\s*,\s*/).forEach(s=>function Hz(e,t,n){if(":"==e[0]){const R=function Gz(e,t){switch(e){case":enter":return"void => *";case":leave":return"* => void";case":increment":return(n,s)=>parseFloat(s)>parseFloat(n);case":decrement":return(n,s)=>parseFloat(s)<parseFloat(n);default:return t.push(function pz(e){return new wt(3016,!1)}()),"* => *"}}(e,n);if("function"==typeof R)return void t.push(R);e=R}const s=e.match(/^(\*|[-\w]+)\s*(<?[=-]>)\s*(\*|[-\w]+)$/);if(null==s||s.length<4)return n.push(function fz(e){return new wt(3015,!1)}()),t;const d=s[1],_=s[2],E=s[3];t.push(FM(d,E));"<"==_[0]&&!(d==F1&&E==F1)&&t.push(FM(E,d))}(s,n,t)):n.push(e),n}const k1=new Set(["true","1"]),L1=new Set(["false","0"]);function FM(e,t){const n=k1.has(e)||L1.has(e),s=k1.has(t)||L1.has(t);return(d,_)=>{let E=e==F1||e==d,S=t==F1||t==_;return!E&&n&&"boolean"==typeof d&&(E=d?k1.has(e):L1.has(e)),!S&&s&&"boolean"==typeof _&&(S=_?k1.has(t):L1.has(t)),E&&S}}const $z=new RegExp("s*:selfs*,?","g");function dS(e,t,n,s){return new qz(e).build(t,n,s)}class qz{constructor(t){this._driver=t}build(t,n,s){const d=new Xz(n);return this._resetContextStyleTimingState(d),Fl(this,Lx(t),d)}_resetContextStyleTimingState(t){t.currentQuerySelector="",t.collectedStyles=new Map,t.collectedStyles.set("",new Map),t.currentTime=0}visitTrigger(t,n){let s=n.queryCount=0,d=n.depCount=0;const _=[],E=[];return"@"==t.name.charAt(0)&&n.errors.push(function nz(){return new wt(3006,!1)}()),t.definitions.forEach(S=>{if(this._resetContextStyleTimingState(n),0==S.type){const R=S,z=R.name;z.toString().split(/\s*,\s*/).forEach($=>{R.name=$,_.push(this.visitState(R,n))}),R.name=z}else if(1==S.type){const R=this.visitTransition(S,n);s+=R.queryCount,d+=R.depCount,E.push(R)}else n.errors.push(function iz(){return new wt(3007,!1)}())}),{type:7,name:t.name,states:_,transitions:E,queryCount:s,depCount:d,options:null}}visitState(t,n){const s=this.visitStyle(t.styles,n),d=t.options&&t.options.params||null;if(s.containsDynamicStyles){const _=new Set,E=d||{};s.styles.forEach(S=>{S instanceof Map&&S.forEach(R=>{RM(R).forEach(z=>{E.hasOwnProperty(z)||_.add(z)})})}),_.size&&(O1(_.values()),n.errors.push(function rz(e,t){return new wt(3008,!1)}()))}return{type:0,name:t.name,style:s,options:d?{params:d}:null}}visitTransition(t,n){n.queryCount=0,n.depCount=0;const s=Fl(this,Lx(t.animation),n);return{type:1,matchers:Uz(t.expr,n.errors),animation:s,queryCount:n.queryCount,depCount:n.depCount,options:jg(t.options)}}visitSequence(t,n){return{type:2,steps:t.steps.map(s=>Fl(this,s,n)),options:jg(t.options)}}visitGroup(t,n){const s=n.currentTime;let d=0;const _=t.steps.map(E=>{n.currentTime=s;const S=Fl(this,E,n);return d=Math.max(d,n.currentTime),S});return n.currentTime=d,{type:3,steps:_,options:jg(t.options)}}visitAnimate(t,n){const s=function Kz(e,t){if(e.hasOwnProperty("duration"))return e;if("number"==typeof e)return hS(R1(e,t).duration,0,"");const n=e;if(n.split(/\s+/).some(_=>"{"==_.charAt(0)&&"{"==_.charAt(1))){const _=hS(0,0,"");return _.dynamic=!0,_.strValue=n,_}const d=R1(n,t);return hS(d.duration,d.delay,d.easing)}(t.timings,n.errors);n.currentAnimateTimings=s;let d,_=t.styles?t.styles:rv({});if(5==_.type)d=this.visitKeyframes(_,n);else{let E=t.styles,S=!1;if(!E){S=!0;const z={};s.easing&&(z.easing=s.easing),E=rv(z)}n.currentTime+=s.duration+s.delay;const R=this.visitStyle(E,n);R.isEmptyStep=S,d=R}return n.currentAnimateTimings=null,{type:4,timings:s,style:d,options:null}}visitStyle(t,n){const s=this._makeStyleAst(t,n);return this._validateStyleAst(s,n),s}_makeStyleAst(t,n){const s=[],d=Array.isArray(t.styles)?t.styles:[t.styles];for(let S of d)"string"==typeof S?S===af?s.push(S):n.errors.push(new wt(3002,!1)):s.push(MM(S));let _=!1,E=null;return s.forEach(S=>{if(S instanceof Map&&(S.has("easing")&&(E=S.get("easing"),S.delete("easing")),!_))for(let R of S.values())if(R.toString().indexOf("{{")>=0){_=!0;break}}),{type:6,styles:s,easing:E,offset:t.offset,containsDynamicStyles:_,options:null}}_validateStyleAst(t,n){const s=n.currentAnimateTimings;let d=n.currentTime,_=n.currentTime;s&&_>0&&(_-=s.duration+s.delay),t.styles.forEach(E=>{"string"!=typeof E&&E.forEach((S,R)=>{const z=n.collectedStyles.get(n.currentQuerySelector),$=z.get(R);let J=!0;$&&(_!=d&&_>=$.startTime&&d<=$.endTime&&(n.errors.push(function sz(e,t,n,s,d){return new wt(3010,!1)}()),J=!1),_=$.startTime),J&&z.set(R,{startTime:_,endTime:d}),n.options&&function zz(e,t,n){const s=t.params||{},d=RM(e);d.length&&d.forEach(_=>{s.hasOwnProperty(_)||n.push(function QN(e){return new wt(3001,!1)}())})}(S,n.options,n.errors)})})}visitKeyframes(t,n){const s={type:5,styles:[],options:null};if(!n.currentAnimateTimings)return n.errors.push(function az(){return new wt(3011,!1)}()),s;let _=0;const E=[];let S=!1,R=!1,z=0;const $=t.steps.map(Rt=>{const dt=this._makeStyleAst(Rt,n);let on=null!=dt.offset?dt.offset:function Yz(e){if("string"==typeof e)return null;let t=null;if(Array.isArray(e))e.forEach(n=>{if(n instanceof Map&&n.has("offset")){const s=n;t=parseFloat(s.get("offset")),s.delete("offset")}});else if(e instanceof Map&&e.has("offset")){const n=e;t=parseFloat(n.get("offset")),n.delete("offset")}return t}(dt.styles),gn=0;return null!=on&&(_++,gn=dt.offset=on),R=R||gn<0||gn>1,S=S||gn<z,z=gn,E.push(gn),dt});R&&n.errors.push(function lz(){return new wt(3012,!1)}()),S&&n.errors.push(function cz(){return new wt(3200,!1)}());const J=t.steps.length;let we=0;_>0&&_<J?n.errors.push(function uz(){return new wt(3202,!1)}()):0==_&&(we=1/(J-1));const ve=J-1,Oe=n.currentTime,He=n.currentAnimateTimings,mt=He.duration;return $.forEach((Rt,dt)=>{const on=we>0?dt==ve?1:we*dt:E[dt],gn=on*mt;n.currentTime=Oe+He.delay+gn,He.duration=gn,this._validateStyleAst(Rt,n),Rt.offset=on,s.styles.push(Rt)}),s}visitReference(t,n){return{type:8,animation:Fl(this,Lx(t.animation),n),options:jg(t.options)}}visitAnimateChild(t,n){return n.depCount++,{type:9,options:jg(t.options)}}visitAnimateRef(t,n){return{type:10,animation:this.visitReference(t.animation,n),options:jg(t.options)}}visitQuery(t,n){const s=n.currentQuerySelector,d=t.options||{};n.queryCount++,n.currentQuery=t;const[_,E]=function Wz(e){const t=!!e.split(/\s*,\s*/).find(n=>":self"==n);return t&&(e=e.replace($z,"")),e=e.replace(/@\*/g,P1).replace(/@\w+/g,n=>P1+"-"+n.slice(1)).replace(/:animating/g,aS),[e,t]}(t.selector);n.currentQuerySelector=s.length?s+" "+_:_,Ol(n.collectedStyles,n.currentQuerySelector,new Map);const S=Fl(this,Lx(t.animation),n);return n.currentQuery=null,n.currentQuerySelector=s,{type:11,selector:_,limit:d.limit||0,optional:!!d.optional,includeSelf:E,animation:S,originalSelector:t.selector,options:jg(t.options)}}visitStagger(t,n){n.currentQuery||n.errors.push(function dz(){return new wt(3013,!1)}());const s="full"===t.timings?{duration:0,delay:0,easing:"full"}:R1(t.timings,n.errors,!0);return{type:12,animation:Fl(this,Lx(t.animation),n),timings:s,options:null}}}class Xz{constructor(t){this.errors=t,this.queryCount=0,this.depCount=0,this.currentTransition=null,this.currentQuery=null,this.currentQuerySelector=null,this.currentAnimateTimings=null,this.currentTime=0,this.collectedStyles=new Map,this.options=null,this.unsupportedCSSPropertiesFound=new Set}}function jg(e){return e?(e=kx(e)).params&&(e.params=function Zz(e){return e?kx(e):null}(e.params)):e={},e}function hS(e,t,n){return{duration:e,delay:t,easing:n}}function fS(e,t,n,s,d,_,E=null,S=!1){return{type:1,element:e,keyframes:t,preStyleProps:n,postStyleProps:s,duration:d,delay:_,totalTime:d+_,easing:E,subTimeline:S}}class N1{constructor(){this._map=new Map}get(t){return this._map.get(t)||[]}append(t,n){let s=this._map.get(t);s||this._map.set(t,s=[]),s.push(...n)}has(t){return this._map.has(t)}clear(){this._map.clear()}}const eB=new RegExp(":enter","g"),nB=new RegExp(":leave","g");function pS(e,t,n,s,d,_=new Map,E=new Map,S,R,z=[]){return(new iB).buildKeyframes(e,t,n,s,d,_,E,S,R,z)}class iB{buildKeyframes(t,n,s,d,_,E,S,R,z,$=[]){z=z||new N1;const J=new mS(t,n,z,d,_,$,[]);J.options=R;const we=R.delay?lf(R.delay):0;J.currentTimeline.delayNextStep(we),J.currentTimeline.setStyles([E],null,J.errors,R),Fl(this,s,J);const ve=J.timelines.filter(Oe=>Oe.containsAnimation());if(ve.length&&S.size){let Oe;for(let He=ve.length-1;He>=0;He--){const mt=ve[He];if(mt.element===n){Oe=mt;break}}Oe&&!Oe.allowOnlyTimelineStyles()&&Oe.setStyles([S],null,J.errors,R)}return ve.length?ve.map(Oe=>Oe.buildKeyframes()):[fS(n,[],[],[],0,we,"",!1)]}visitTrigger(t,n){}visitState(t,n){}visitTransition(t,n){}visitAnimateChild(t,n){const s=n.subInstructions.get(n.element);if(s){const d=n.createSubContext(t.options),_=n.currentTimeline.currentTime,E=this._visitSubInstructions(s,d,d.options);_!=E&&n.transformIntoNewTimeline(E)}n.previousNode=t}visitAnimateRef(t,n){const s=n.createSubContext(t.options);s.transformIntoNewTimeline(),this._applyAnimationRefDelays([t.options,t.animation.options],n,s),this.visitReference(t.animation,s),n.transformIntoNewTimeline(s.currentTimeline.currentTime),n.previousNode=t}_applyAnimationRefDelays(t,n,s){for(const d of t){const _=d?.delay;if(_){const E="number"==typeof _?_:lf(Nx(_,d?.params??{},n.errors));s.delayNextStep(E)}}}_visitSubInstructions(t,n,s){let _=n.currentTimeline.currentTime;const E=null!=s.duration?lf(s.duration):null,S=null!=s.delay?lf(s.delay):null;return 0!==E&&t.forEach(R=>{const z=n.appendInstructionToTimeline(R,E,S);_=Math.max(_,z.duration+z.delay)}),_}visitReference(t,n){n.updateOptions(t.options,!0),Fl(this,t.animation,n),n.previousNode=t}visitSequence(t,n){const s=n.subContextCount;let d=n;const _=t.options;if(_&&(_.params||_.delay)&&(d=n.createSubContext(_),d.transformIntoNewTimeline(),null!=_.delay)){6==d.previousNode.type&&(d.currentTimeline.snapshotCurrentStyles(),d.previousNode=z1);const E=lf(_.delay);d.delayNextStep(E)}t.steps.length&&(t.steps.forEach(E=>Fl(this,E,d)),d.currentTimeline.applyStylesToKeyframe(),d.subContextCount>s&&d.transformIntoNewTimeline()),n.previousNode=t}visitGroup(t,n){const s=[];let d=n.currentTimeline.currentTime;const _=t.options&&t.options.delay?lf(t.options.delay):0;t.steps.forEach(E=>{const S=n.createSubContext(t.options);_&&S.delayNextStep(_),Fl(this,E,S),d=Math.max(d,S.currentTimeline.currentTime),s.push(S.currentTimeline)}),s.forEach(E=>n.currentTimeline.mergeTimelineCollectedStyles(E)),n.transformIntoNewTimeline(d),n.previousNode=t}_visitTiming(t,n){if(t.dynamic){const s=t.strValue;return R1(n.params?Nx(s,n.params,n.errors):s,n.errors)}return{duration:t.duration,delay:t.delay,easing:t.easing}}visitAnimate(t,n){const s=n.currentAnimateTimings=this._visitTiming(t.timings,n),d=n.currentTimeline;s.delay&&(n.incrementTime(s.delay),d.snapshotCurrentStyles());const _=t.style;5==_.type?this.visitKeyframes(_,n):(n.incrementTime(s.duration),this.visitStyle(_,n),d.applyStylesToKeyframe()),n.currentAnimateTimings=null,n.previousNode=t}visitStyle(t,n){const s=n.currentTimeline,d=n.currentAnimateTimings;!d&&s.hasCurrentStyleProperties()&&s.forwardFrame();const _=d&&d.easing||t.easing;t.isEmptyStep?s.applyEmptyStep(_):s.setStyles(t.styles,_,n.errors,n.options),n.previousNode=t}visitKeyframes(t,n){const s=n.currentAnimateTimings,d=n.currentTimeline.duration,_=s.duration,S=n.createSubContext().currentTimeline;S.easing=s.easing,t.styles.forEach(R=>{S.forwardTime((R.offset||0)*_),S.setStyles(R.styles,R.easing,n.errors,n.options),S.applyStylesToKeyframe()}),n.currentTimeline.mergeTimelineCollectedStyles(S),n.transformIntoNewTimeline(d+_),n.previousNode=t}visitQuery(t,n){const s=n.currentTimeline.currentTime,d=t.options||{},_=d.delay?lf(d.delay):0;_&&(6===n.previousNode.type||0==s&&n.currentTimeline.hasCurrentStyleProperties())&&(n.currentTimeline.snapshotCurrentStyles(),n.previousNode=z1);let E=s;const S=n.invokeQuery(t.selector,t.originalSelector,t.limit,t.includeSelf,!!d.optional,n.errors);n.currentQueryTotal=S.length;let R=null;S.forEach((z,$)=>{n.currentQueryIndex=$;const J=n.createSubContext(t.options,z);_&&J.delayNextStep(_),z===n.element&&(R=J.currentTimeline),Fl(this,t.animation,J),J.currentTimeline.applyStylesToKeyframe(),E=Math.max(E,J.currentTimeline.currentTime)}),n.currentQueryIndex=0,n.currentQueryTotal=0,n.transformIntoNewTimeline(E),R&&(n.currentTimeline.mergeTimelineCollectedStyles(R),n.currentTimeline.snapshotCurrentStyles()),n.previousNode=t}visitStagger(t,n){const s=n.parentContext,d=n.currentTimeline,_=t.timings,E=Math.abs(_.duration),S=E*(n.currentQueryTotal-1);let R=E*n.currentQueryIndex;switch(_.duration<0?"reverse":_.easing){case"reverse":R=S-R;break;case"full":R=s.currentStaggerTime}const $=n.currentTimeline;R&&$.delayNextStep(R);const J=$.currentTime;Fl(this,t.animation,n),n.previousNode=t,s.currentStaggerTime=d.currentTime-J+(d.startTime-s.currentTimeline.startTime)}}const z1={};class mS{constructor(t,n,s,d,_,E,S,R){this._driver=t,this.element=n,this.subInstructions=s,this._enterClassName=d,this._leaveClassName=_,this.errors=E,this.timelines=S,this.parentContext=null,this.currentAnimateTimings=null,this.previousNode=z1,this.subContextCount=0,this.options={},this.currentQueryIndex=0,this.currentQueryTotal=0,this.currentStaggerTime=0,this.currentTimeline=R||new B1(this._driver,n,0),S.push(this.currentTimeline)}get params(){return this.options.params}updateOptions(t,n){if(!t)return;const s=t;let d=this.options;null!=s.duration&&(d.duration=lf(s.duration)),null!=s.delay&&(d.delay=lf(s.delay));const _=s.params;if(_){let E=d.params;E||(E=this.options.params={}),Object.keys(_).forEach(S=>{(!n||!E.hasOwnProperty(S))&&(E[S]=Nx(_[S],E,this.errors))})}}_copyOptions(){const t={};if(this.options){const n=this.options.params;if(n){const s=t.params={};Object.keys(n).forEach(d=>{s[d]=n[d]})}}return t}createSubContext(t=null,n,s){const d=n||this.element,_=new mS(this._driver,d,this.subInstructions,this._enterClassName,this._leaveClassName,this.errors,this.timelines,this.currentTimeline.fork(d,s||0));return _.previousNode=this.previousNode,_.currentAnimateTimings=this.currentAnimateTimings,_.options=this._copyOptions(),_.updateOptions(t),_.currentQueryIndex=this.currentQueryIndex,_.currentQueryTotal=this.currentQueryTotal,_.parentContext=this,this.subContextCount++,_}transformIntoNewTimeline(t){return this.previousNode=z1,this.currentTimeline=this.currentTimeline.fork(this.element,t),this.timelines.push(this.currentTimeline),this.currentTimeline}appendInstructionToTimeline(t,n,s){const d={duration:n??t.duration,delay:this.currentTimeline.currentTime+(s??0)+t.delay,easing:""},_=new rB(this._driver,t.element,t.keyframes,t.preStyleProps,t.postStyleProps,d,t.stretchStartingKeyframe);return this.timelines.push(_),d}incrementTime(t){this.currentTimeline.forwardTime(this.currentTimeline.duration+t)}delayNextStep(t){t>0&&this.currentTimeline.delayNextStep(t)}invokeQuery(t,n,s,d,_,E){let S=[];if(d&&S.push(this.element),t.length>0){t=(t=t.replace(eB,"."+this._enterClassName)).replace(nB,"."+this._leaveClassName);let z=this._driver.query(this.element,t,1!=s);0!==s&&(z=s<0?z.slice(z.length+s,z.length):z.slice(0,s)),S.push(...z)}return!_&&0==S.length&&E.push(function hz(e){return new wt(3014,!1)}()),S}}class B1{constructor(t,n,s,d){this._driver=t,this.element=n,this.startTime=s,this._elementTimelineStylesLookup=d,this.duration=0,this.easing=null,this._previousKeyframe=new Map,this._currentKeyframe=new Map,this._keyframes=new Map,this._styleSummary=new Map,this._localTimelineStyles=new Map,this._pendingStyles=new Map,this._backFill=new Map,this._currentEmptyStepKeyframe=null,this._elementTimelineStylesLookup||(this._elementTimelineStylesLookup=new Map),this._globalTimelineStyles=this._elementTimelineStylesLookup.get(n),this._globalTimelineStyles||(this._globalTimelineStyles=this._localTimelineStyles,this._elementTimelineStylesLookup.set(n,this._localTimelineStyles)),this._loadKeyframe()}containsAnimation(){switch(this._keyframes.size){case 0:return!1;case 1:return this.hasCurrentStyleProperties();default:return!0}}hasCurrentStyleProperties(){return this._currentKeyframe.size>0}get currentTime(){return this.startTime+this.duration}delayNextStep(t){const n=1===this._keyframes.size&&this._pendingStyles.size;this.duration||n?(this.forwardTime(this.currentTime+t),n&&this.snapshotCurrentStyles()):this.startTime+=t}fork(t,n){return this.applyStylesToKeyframe(),new B1(this._driver,t,n||this.currentTime,this._elementTimelineStylesLookup)}_loadKeyframe(){this._currentKeyframe&&(this._previousKeyframe=this._currentKeyframe),this._currentKeyframe=this._keyframes.get(this.duration),this._currentKeyframe||(this._currentKeyframe=new Map,this._keyframes.set(this.duration,this._currentKeyframe))}forwardFrame(){this.duration+=1,this._loadKeyframe()}forwardTime(t){this.applyStylesToKeyframe(),this.duration=t,this._loadKeyframe()}_updateStyle(t,n){this._localTimelineStyles.set(t,n),this._globalTimelineStyles.set(t,n),this._styleSummary.set(t,{time:this.currentTime,value:n})}allowOnlyTimelineStyles(){return this._currentEmptyStepKeyframe!==this._currentKeyframe}applyEmptyStep(t){t&&this._previousKeyframe.set("easing",t);for(let[n,s]of this._globalTimelineStyles)this._backFill.set(n,s||af),this._currentKeyframe.set(n,af);this._currentEmptyStepKeyframe=this._currentKeyframe}setStyles(t,n,s,d){n&&this._previousKeyframe.set("easing",n);const _=d&&d.params||{},E=function oB(e,t){const n=new Map;let s;return e.forEach(d=>{if("*"===d){s=s||t.keys();for(let _ of s)n.set(_,af)}else Np(d,n)}),n}(t,this._globalTimelineStyles);for(let[S,R]of E){const z=Nx(R,_,s);this._pendingStyles.set(S,z),this._localTimelineStyles.has(S)||this._backFill.set(S,this._globalTimelineStyles.get(S)??af),this._updateStyle(S,z)}}applyStylesToKeyframe(){0!=this._pendingStyles.size&&(this._pendingStyles.forEach((t,n)=>{this._currentKeyframe.set(n,t)}),this._pendingStyles.clear(),this._localTimelineStyles.forEach((t,n)=>{this._currentKeyframe.has(n)||this._currentKeyframe.set(n,t)}))}snapshotCurrentStyles(){for(let[t,n]of this._localTimelineStyles)this._pendingStyles.set(t,n),this._updateStyle(t,n)}getFinalKeyframe(){return this._keyframes.get(this.duration)}get properties(){const t=[];for(let n in this._currentKeyframe)t.push(n);return t}mergeTimelineCollectedStyles(t){t._styleSummary.forEach((n,s)=>{const d=this._styleSummary.get(s);(!d||n.time>d.time)&&this._updateStyle(s,n.value)})}buildKeyframes(){this.applyStylesToKeyframe();const t=new Set,n=new Set,s=1===this._keyframes.size&&0===this.duration;let d=[];this._keyframes.forEach((S,R)=>{const z=Np(S,new Map,this._backFill);z.forEach(($,J)=>{"!"===$?t.add(J):$===af&&n.add(J)}),s||z.set("offset",R/this.duration),d.push(z)});const _=t.size?O1(t.values()):[],E=n.size?O1(n.values()):[];if(s){const S=d[0],R=new Map(S);S.set("offset",0),R.set("offset",1),d=[S,R]}return fS(this.element,d,_,E,this.duration,this.startTime,this.easing,!1)}}class rB extends B1{constructor(t,n,s,d,_,E,S=!1){super(t,n,E.delay),this.keyframes=s,this.preStyleProps=d,this.postStyleProps=_,this._stretchStartingKeyframe=S,this.timings={duration:E.duration,delay:E.delay,easing:E.easing}}containsAnimation(){return this.keyframes.length>1}buildKeyframes(){let t=this.keyframes,{delay:n,duration:s,easing:d}=this.timings;if(this._stretchStartingKeyframe&&n){const _=[],E=s+n,S=n/E,R=Np(t[0]);R.set("offset",0),_.push(R);const z=Np(t[0]);z.set("offset",NM(S)),_.push(z);const $=t.length-1;for(let J=1;J<=$;J++){let we=Np(t[J]);const ve=we.get("offset");we.set("offset",NM((n+ve*s)/E)),_.push(we)}s=E,n=0,d="",t=_}return fS(this.element,t,this.preStyleProps,this.postStyleProps,s,n,d,!0)}}function NM(e,t=3){const n=Math.pow(10,t-1);return Math.round(e*n)/n}class gS{}const sB=new Set(["width","height","minWidth","minHeight","maxWidth","maxHeight","left","top","bottom","right","fontSize","outlineWidth","outlineOffset","paddingTop","paddingLeft","paddingBottom","paddingRight","marginTop","marginLeft","marginBottom","marginRight","borderRadius","borderWidth","borderTopWidth","borderLeftWidth","borderRightWidth","borderBottomWidth","textIndent","perspective"]);class aB extends gS{normalizePropertyName(t,n){return uS(t)}normalizeStyleValue(t,n,s,d){let _="";const E=s.toString().trim();if(sB.has(n)&&0!==s&&"0"!==s)if("number"==typeof s)_="px";else{const S=s.match(/^[+-]?[\d\.]+([a-z]*)$/);S&&0==S[1].length&&d.push(function tz(e,t){return new wt(3005,!1)}())}return E+_}}function zM(e,t,n,s,d,_,E,S,R,z,$,J,we){return{type:0,element:e,triggerName:t,isRemovalTransition:d,fromState:n,fromStyles:_,toState:s,toStyles:E,timelines:S,queriedElements:R,preStyleProps:z,postStyleProps:$,totalTime:J,errors:we}}const _S={};class BM{constructor(t,n,s){this._triggerName=t,this.ast=n,this._stateStyles=s}match(t,n,s,d){return function lB(e,t,n,s,d){return e.some(_=>_(t,n,s,d))}(this.ast.matchers,t,n,s,d)}buildStyles(t,n,s){let d=this._stateStyles.get("*");return void 0!==t&&(d=this._stateStyles.get(t?.toString())||d),d?d.buildStyles(n,s):new Map}build(t,n,s,d,_,E,S,R,z,$){const J=[],we=this.ast.options&&this.ast.options.params||_S,Oe=this.buildStyles(s,S&&S.params||_S,J),He=R&&R.params||_S,mt=this.buildStyles(d,He,J),Rt=new Set,dt=new Map,on=new Map,gn="void"===d,yi={params:cB(He,we),delay:this.ast.options?.delay},qr=$?[]:pS(t,n,this.ast.animation,_,E,Oe,mt,yi,z,J);let Wr=0;if(qr.forEach(kl=>{Wr=Math.max(kl.duration+kl.delay,Wr)}),J.length)return zM(n,this._triggerName,s,d,gn,Oe,mt,[],[],dt,on,Wr,J);qr.forEach(kl=>{const Su=kl.element,hE=Ol(dt,Su,new Set);kl.preStyleProps.forEach(Wg=>hE.add(Wg));const Yx=Ol(on,Su,new Set);kl.postStyleProps.forEach(Wg=>Yx.add(Wg)),Su!==n&&Rt.add(Su)});const ca=O1(Rt.values());return zM(n,this._triggerName,s,d,gn,Oe,mt,qr,ca,dt,on,Wr)}}function cB(e,t){const n=kx(t);for(const s in e)e.hasOwnProperty(s)&&null!=e[s]&&(n[s]=e[s]);return n}class uB{constructor(t,n,s){this.styles=t,this.defaultParams=n,this.normalizer=s}buildStyles(t,n){const s=new Map,d=kx(this.defaultParams);return Object.keys(t).forEach(_=>{const E=t[_];null!==E&&(d[_]=E)}),this.styles.styles.forEach(_=>{"string"!=typeof _&&_.forEach((E,S)=>{E&&(E=Nx(E,d,n));const R=this.normalizer.normalizePropertyName(S,n);E=this.normalizer.normalizeStyleValue(S,R,E,n),s.set(S,E)})}),s}}class hB{constructor(t,n,s){this.name=t,this.ast=n,this._normalizer=s,this.transitionFactories=[],this.states=new Map,n.states.forEach(d=>{this.states.set(d.name,new uB(d.style,d.options&&d.options.params||{},s))}),VM(this.states,"true","1"),VM(this.states,"false","0"),n.transitions.forEach(d=>{this.transitionFactories.push(new BM(t,d,this.states))}),this.fallbackTransition=function fB(e,t,n){return new BM(e,{type:1,animation:{type:2,steps:[],options:null},matchers:[(E,S)=>!0],options:null,queryCount:0,depCount:0},t)}(t,this.states)}get containsQueries(){return this.ast.queryCount>0}matchTransition(t,n,s,d){return this.transitionFactories.find(E=>E.match(t,n,s,d))||null}matchStyles(t,n,s){return this.fallbackTransition.buildStyles(t,n,s)}}function VM(e,t,n){e.has(t)?e.has(n)||e.set(n,e.get(t)):e.has(n)&&e.set(t,e.get(n))}const pB=new N1;class mB{constructor(t,n,s){this.bodyNode=t,this._driver=n,this._normalizer=s,this._animations=new Map,this._playersById=new Map,this.players=[]}register(t,n){const s=[],_=dS(this._driver,n,s,[]);if(s.length)throw function vz(e){return new wt(3503,!1)}();this._animations.set(t,_)}_buildPlayer(t,n,s){const d=t.element,_=wM(this._normalizer,t.keyframes,n,s);return this._driver.animate(d,_,t.duration,t.delay,t.easing,[],!0)}create(t,n,s={}){const d=[],_=this._animations.get(t);let E;const S=new Map;if(_?(E=pS(this._driver,n,_,sS,A1,new Map,new Map,s,pB,d),E.forEach($=>{const J=Ol(S,$.element,new Map);$.postStyleProps.forEach(we=>J.set(we,null))})):(d.push(function xz(){return new wt(3300,!1)}()),E=[]),d.length)throw function bz(e){return new wt(3504,!1)}();S.forEach(($,J)=>{$.forEach((we,ve)=>{$.set(ve,this._driver.computeStyle(J,ve,af))})});const z=Lp(E.map($=>{const J=S.get($.element);return this._buildPlayer($,new Map,J)}));return this._playersById.set(t,z),z.onDestroy(()=>this.destroy(t)),this.players.push(z),z}destroy(t){const n=this._getPlayer(t);n.destroy(),this._playersById.delete(t);const s=this.players.indexOf(n);s>=0&&this.players.splice(s,1)}_getPlayer(t){const n=this._playersById.get(t);if(!n)throw function wz(e){return new wt(3301,!1)}();return n}listen(t,n,s,d){const _=iS(n,"","","");return tS(this._getPlayer(t),s,_,d),()=>{}}command(t,n,s,d){if("register"==s)return void this.register(t,d[0]);if("create"==s)return void this.create(t,n,d[0]||{});const _=this._getPlayer(t);switch(s){case"play":_.play();break;case"pause":_.pause();break;case"reset":_.reset();break;case"restart":_.restart();break;case"finish":_.finish();break;case"init":_.init();break;case"setPosition":_.setPosition(parseFloat(d[0]));break;case"destroy":this.destroy(t)}}}const jM="ng-animate-queued",yS="ng-animate-disabled",xB=[],UM={namespaceId:"",setForRemoval:!1,setForMove:!1,hasAnimation:!1,removedBeforeQueried:!1},bB={namespaceId:"",setForMove:!1,setForRemoval:!1,hasAnimation:!1,removedBeforeQueried:!0},Du="__ng_removed";class vS{get params(){return this.options.params}constructor(t,n=""){this.namespaceId=n;const s=t&&t.hasOwnProperty("value");if(this.value=function DB(e){return e??null}(s?t.value:t),s){const _=kx(t);delete _.value,this.options=_}else this.options={};this.options.params||(this.options.params={})}absorbOptions(t){const n=t.params;if(n){const s=this.options.params;Object.keys(n).forEach(d=>{null==s[d]&&(s[d]=n[d])})}}}const zx="void",xS=new vS(zx);class wB{constructor(t,n,s){this.id=t,this.hostElement=n,this._engine=s,this.players=[],this._triggers=new Map,this._queue=[],this._elementListeners=new Map,this._hostClassName="ng-tns-"+t,wc(n,this._hostClassName)}listen(t,n,s,d){if(!this._triggers.has(n))throw function Ez(e,t){return new wt(3302,!1)}();if(null==s||0==s.length)throw function Tz(e){return new wt(3303,!1)}();if(!function SB(e){return"start"==e||"done"==e}(s))throw function Dz(e,t){return new wt(3400,!1)}();const _=Ol(this._elementListeners,t,[]),E={name:n,phase:s,callback:d};_.push(E);const S=Ol(this._engine.statesByElement,t,new Map);return S.has(n)||(wc(t,M1),wc(t,M1+"-"+n),S.set(n,xS)),()=>{this._engine.afterFlush(()=>{const R=_.indexOf(E);R>=0&&_.splice(R,1),this._triggers.has(n)||S.delete(n)})}}register(t,n){return!this._triggers.has(t)&&(this._triggers.set(t,n),!0)}_getTrigger(t){const n=this._triggers.get(t);if(!n)throw function Sz(e){return new wt(3401,!1)}();return n}trigger(t,n,s,d=!0){const _=this._getTrigger(n),E=new bS(this.id,n,t);let S=this._engine.statesByElement.get(t);S||(wc(t,M1),wc(t,M1+"-"+n),this._engine.statesByElement.set(t,S=new Map));let R=S.get(n);const z=new vS(s,this.id);if(!(s&&s.hasOwnProperty("value"))&&R&&z.absorbOptions(R.options),S.set(n,z),R||(R=xS),z.value!==zx&&R.value===z.value){if(!function AB(e,t){const n=Object.keys(e),s=Object.keys(t);if(n.length!=s.length)return!1;for(let d=0;d<n.length;d++){const _=n[d];if(!t.hasOwnProperty(_)||e[_]!==t[_])return!1}return!0}(R.params,z.params)){const He=[],mt=_.matchStyles(R.value,R.params,He),Rt=_.matchStyles(z.value,z.params,He);He.length?this._engine.reportError(He):this._engine.afterFlush(()=>{Vg(t,mt),Pd(t,Rt)})}return}const we=Ol(this._engine.playersByElement,t,[]);we.forEach(He=>{He.namespaceId==this.id&&He.triggerName==n&&He.queued&&He.destroy()});let ve=_.matchTransition(R.value,z.value,t,z.params),Oe=!1;if(!ve){if(!d)return;ve=_.fallbackTransition,Oe=!0}return this._engine.totalQueuedPlayers++,this._queue.push({element:t,triggerName:n,transition:ve,fromState:R,toState:z,player:E,isFallbackTransition:Oe}),Oe||(wc(t,jM),E.onStart(()=>{ov(t,jM)})),E.onDone(()=>{let He=this.players.indexOf(E);He>=0&&this.players.splice(He,1);const mt=this._engine.playersByElement.get(t);if(mt){let Rt=mt.indexOf(E);Rt>=0&&mt.splice(Rt,1)}}),this.players.push(E),we.push(E),E}deregister(t){this._triggers.delete(t),this._engine.statesByElement.forEach(n=>n.delete(t)),this._elementListeners.forEach((n,s)=>{this._elementListeners.set(s,n.filter(d=>d.name!=t))})}clearElementCache(t){this._engine.statesByElement.delete(t),this._elementListeners.delete(t);const n=this._engine.playersByElement.get(t);n&&(n.forEach(s=>s.destroy()),this._engine.playersByElement.delete(t))}_signalRemovalForInnerTriggers(t,n){const s=this._engine.driver.query(t,P1,!0);s.forEach(d=>{if(d[Du])return;const _=this._engine.fetchNamespacesByElement(d);_.size?_.forEach(E=>E.triggerLeaveAnimation(d,n,!1,!0)):this.clearElementCache(d)}),this._engine.afterFlushAnimationsDone(()=>s.forEach(d=>this.clearElementCache(d)))}triggerLeaveAnimation(t,n,s,d){const _=this._engine.statesByElement.get(t),E=new Map;if(_){const S=[];if(_.forEach((R,z)=>{if(E.set(z,R.value),this._triggers.has(z)){const $=this.trigger(t,z,zx,d);$&&S.push($)}}),S.length)return this._engine.markElementAsRemoved(this.id,t,!0,n,E),s&&Lp(S).onDone(()=>this._engine.processLeaveNode(t)),!0}return!1}prepareLeaveAnimationListeners(t){const n=this._elementListeners.get(t),s=this._engine.statesByElement.get(t);if(n&&s){const d=new Set;n.forEach(_=>{const E=_.name;if(d.has(E))return;d.add(E);const R=this._triggers.get(E).fallbackTransition,z=s.get(E)||xS,$=new vS(zx),J=new bS(this.id,E,t);this._engine.totalQueuedPlayers++,this._queue.push({element:t,triggerName:E,transition:R,fromState:z,toState:$,player:J,isFallbackTransition:!0})})}}removeNode(t,n){const s=this._engine;if(t.childElementCount&&this._signalRemovalForInnerTriggers(t,n),this.triggerLeaveAnimation(t,n,!0))return;let d=!1;if(s.totalAnimations){const _=s.players.length?s.playersByQueriedElement.get(t):[];if(_&&_.length)d=!0;else{let E=t;for(;E=E.parentNode;)if(s.statesByElement.get(E)){d=!0;break}}}if(this.prepareLeaveAnimationListeners(t),d)s.markElementAsRemoved(this.id,t,!1,n);else{const _=t[Du];(!_||_===UM)&&(s.afterFlush(()=>this.clearElementCache(t)),s.destroyInnerAnimations(t),s._onRemovalComplete(t,n))}}insertNode(t,n){wc(t,this._hostClassName)}drainQueuedTransitions(t){const n=[];return this._queue.forEach(s=>{const d=s.player;if(d.destroyed)return;const _=s.element,E=this._elementListeners.get(_);E&&E.forEach(S=>{if(S.name==s.triggerName){const R=iS(_,s.triggerName,s.fromState.value,s.toState.value);R._data=t,tS(s.player,S.phase,R,S.callback)}}),d.markedForDestroy?this._engine.afterFlush(()=>{d.destroy()}):n.push(s)}),this._queue=[],n.sort((s,d)=>{const _=s.transition.ast.depCount,E=d.transition.ast.depCount;return 0==_||0==E?_-E:this._engine.driver.containsElement(s.element,d.element)?1:-1})}destroy(t){this.players.forEach(n=>n.destroy()),this._signalRemovalForInnerTriggers(this.hostElement,t)}}class EB{_onRemovalComplete(t,n){this.onRemovalComplete(t,n)}constructor(t,n,s){this.bodyNode=t,this.driver=n,this._normalizer=s,this.players=[],this.newHostElements=new Map,this.playersByElement=new Map,this.playersByQueriedElement=new Map,this.statesByElement=new Map,this.disabledNodes=new Set,this.totalAnimations=0,this.totalQueuedPlayers=0,this._namespaceLookup={},this._namespaceList=[],this._flushFns=[],this._whenQuietFns=[],this.namespacesByHostElement=new Map,this.collectedEnterElements=[],this.collectedLeaveElements=[],this.onRemovalComplete=(d,_)=>{}}get queuedPlayers(){const t=[];return this._namespaceList.forEach(n=>{n.players.forEach(s=>{s.queued&&t.push(s)})}),t}createNamespace(t,n){const s=new wB(t,n,this);return this.bodyNode&&this.driver.containsElement(this.bodyNode,n)?this._balanceNamespaceList(s,n):(this.newHostElements.set(n,s),this.collectEnterElement(n)),this._namespaceLookup[t]=s}_balanceNamespaceList(t,n){const s=this._namespaceList,d=this.namespacesByHostElement;if(s.length-1>=0){let E=!1,S=this.driver.getParentElement(n);for(;S;){const R=d.get(S);if(R){const z=s.indexOf(R);s.splice(z+1,0,t),E=!0;break}S=this.driver.getParentElement(S)}E||s.unshift(t)}else s.push(t);return d.set(n,t),t}register(t,n){let s=this._namespaceLookup[t];return s||(s=this.createNamespace(t,n)),s}registerTrigger(t,n,s){let d=this._namespaceLookup[t];d&&d.register(n,s)&&this.totalAnimations++}destroy(t,n){t&&(this.afterFlush(()=>{}),this.afterFlushAnimationsDone(()=>{const s=this._fetchNamespace(t);this.namespacesByHostElement.delete(s.hostElement);const d=this._namespaceList.indexOf(s);d>=0&&this._namespaceList.splice(d,1),s.destroy(n),delete this._namespaceLookup[t]}))}_fetchNamespace(t){return this._namespaceLookup[t]}fetchNamespacesByElement(t){const n=new Set,s=this.statesByElement.get(t);if(s)for(let d of s.values())if(d.namespaceId){const _=this._fetchNamespace(d.namespaceId);_&&n.add(_)}return n}trigger(t,n,s,d){if(V1(n)){const _=this._fetchNamespace(t);if(_)return _.trigger(n,s,d),!0}return!1}insertNode(t,n,s,d){if(!V1(n))return;const _=n[Du];if(_&&_.setForRemoval){_.setForRemoval=!1,_.setForMove=!0;const E=this.collectedLeaveElements.indexOf(n);E>=0&&this.collectedLeaveElements.splice(E,1)}if(t){const E=this._fetchNamespace(t);E&&E.insertNode(n,s)}d&&this.collectEnterElement(n)}collectEnterElement(t){this.collectedEnterElements.push(t)}markElementAsDisabled(t,n){n?this.disabledNodes.has(t)||(this.disabledNodes.add(t),wc(t,yS)):this.disabledNodes.has(t)&&(this.disabledNodes.delete(t),ov(t,yS))}removeNode(t,n,s){if(V1(n)){const d=t?this._fetchNamespace(t):null;d?d.removeNode(n,s):this.markElementAsRemoved(t,n,!1,s);const _=this.namespacesByHostElement.get(n);_&&_.id!==t&&_.removeNode(n,s)}else this._onRemovalComplete(n,s)}markElementAsRemoved(t,n,s,d,_){this.collectedLeaveElements.push(n),n[Du]={namespaceId:t,setForRemoval:d,hasAnimation:s,removedBeforeQueried:!1,previousTriggersValues:_}}listen(t,n,s,d,_){return V1(n)?this._fetchNamespace(t).listen(n,s,d,_):()=>{}}_buildInstruction(t,n,s,d,_){return t.transition.build(this.driver,t.element,t.fromState.value,t.toState.value,s,d,t.fromState.options,t.toState.options,n,_)}destroyInnerAnimations(t){let n=this.driver.query(t,P1,!0);n.forEach(s=>this.destroyActiveAnimationsForElement(s)),0!=this.playersByQueriedElement.size&&(n=this.driver.query(t,aS,!0),n.forEach(s=>this.finishActiveQueriedAnimationOnElement(s)))}destroyActiveAnimationsForElement(t){const n=this.playersByElement.get(t);n&&n.forEach(s=>{s.queued?s.markedForDestroy=!0:s.destroy()})}finishActiveQueriedAnimationOnElement(t){const n=this.playersByQueriedElement.get(t);n&&n.forEach(s=>s.finish())}whenRenderingDone(){return new Promise(t=>{if(this.players.length)return Lp(this.players).onDone(()=>t());t()})}processLeaveNode(t){const n=t[Du];if(n&&n.setForRemoval){if(t[Du]=UM,n.namespaceId){this.destroyInnerAnimations(t);const s=this._fetchNamespace(n.namespaceId);s&&s.clearElementCache(t)}this._onRemovalComplete(t,n.setForRemoval)}t.classList?.contains(yS)&&this.markElementAsDisabled(t,!1),this.driver.query(t,".ng-animate-disabled",!0).forEach(s=>{this.markElementAsDisabled(s,!1)})}flush(t=-1){let n=[];if(this.newHostElements.size&&(this.newHostElements.forEach((s,d)=>this._balanceNamespaceList(s,d)),this.newHostElements.clear()),this.totalAnimations&&this.collectedEnterElements.length)for(let s=0;s<this.collectedEnterElements.length;s++)wc(this.collectedEnterElements[s],"ng-star-inserted");if(this._namespaceList.length&&(this.totalQueuedPlayers||this.collectedLeaveElements.length)){const s=[];try{n=this._flushAnimations(s,t)}finally{for(let d=0;d<s.length;d++)s[d]()}}else for(let s=0;s<this.collectedLeaveElements.length;s++)this.processLeaveNode(this.collectedLeaveElements[s]);if(this.totalQueuedPlayers=0,this.collectedEnterElements.length=0,this.collectedLeaveElements.length=0,this._flushFns.forEach(s=>s()),this._flushFns=[],this._whenQuietFns.length){const s=this._whenQuietFns;this._whenQuietFns=[],n.length?Lp(n).onDone(()=>{s.forEach(d=>d())}):s.forEach(d=>d())}}reportError(t){throw function Cz(e){return new wt(3402,!1)}()}_flushAnimations(t,n){const s=new N1,d=[],_=new Map,E=[],S=new Map,R=new Map,z=new Map,$=new Set;this.disabledNodes.forEach(xn=>{$.add(xn);const Bn=this.driver.query(xn,".ng-animate-queued",!0);for(let Yn=0;Yn<Bn.length;Yn++)$.add(Bn[Yn])});const J=this.bodyNode,we=Array.from(this.statesByElement.keys()),ve=$M(we,this.collectedEnterElements),Oe=new Map;let He=0;ve.forEach((xn,Bn)=>{const Yn=sS+He++;Oe.set(Bn,Yn),xn.forEach(sr=>wc(sr,Yn))});const mt=[],Rt=new Set,dt=new Set;for(let xn=0;xn<this.collectedLeaveElements.length;xn++){const Bn=this.collectedLeaveElements[xn],Yn=Bn[Du];Yn&&Yn.setForRemoval&&(mt.push(Bn),Rt.add(Bn),Yn.hasAnimation?this.driver.query(Bn,".ng-star-inserted",!0).forEach(sr=>Rt.add(sr)):dt.add(Bn))}const on=new Map,gn=$M(we,Array.from(Rt));gn.forEach((xn,Bn)=>{const Yn=A1+He++;on.set(Bn,Yn),xn.forEach(sr=>wc(sr,Yn))}),t.push(()=>{ve.forEach((xn,Bn)=>{const Yn=Oe.get(Bn);xn.forEach(sr=>ov(sr,Yn))}),gn.forEach((xn,Bn)=>{const Yn=on.get(Bn);xn.forEach(sr=>ov(sr,Yn))}),mt.forEach(xn=>{this.processLeaveNode(xn)})});const yi=[],qr=[];for(let xn=this._namespaceList.length-1;xn>=0;xn--)this._namespaceList[xn].drainQueuedTransitions(n).forEach(Yn=>{const sr=Yn.player,Os=Yn.element;if(yi.push(sr),this.collectedEnterElements.length){const ua=Os[Du];if(ua&&ua.setForMove){if(ua.previousTriggersValues&&ua.previousTriggersValues.has(Yn.triggerName)){const Zg=ua.previousTriggersValues.get(Yn.triggerName),Ec=this.statesByElement.get(Yn.element);if(Ec&&Ec.has(Yn.triggerName)){const fE=Ec.get(Yn.triggerName);fE.value=Zg,Ec.set(Yn.triggerName,fE)}}return void sr.destroy()}}const Fd=!J||!this.driver.containsElement(J,Os),Ll=on.get(Os),Hp=Oe.get(Os),mo=this._buildInstruction(Yn,s,Hp,Ll,Fd);if(mo.errors&&mo.errors.length)return void qr.push(mo);if(Fd)return sr.onStart(()=>Vg(Os,mo.fromStyles)),sr.onDestroy(()=>Pd(Os,mo.toStyles)),void d.push(sr);if(Yn.isFallbackTransition)return sr.onStart(()=>Vg(Os,mo.fromStyles)),sr.onDestroy(()=>Pd(Os,mo.toStyles)),void d.push(sr);const cR=[];mo.timelines.forEach(ua=>{ua.stretchStartingKeyframe=!0,this.disabledNodes.has(ua.element)||cR.push(ua)}),mo.timelines=cR,s.append(Os,mo.timelines),E.push({instruction:mo,player:sr,element:Os}),mo.queriedElements.forEach(ua=>Ol(S,ua,[]).push(sr)),mo.preStyleProps.forEach((ua,Zg)=>{if(ua.size){let Ec=R.get(Zg);Ec||R.set(Zg,Ec=new Set),ua.forEach((fE,vC)=>Ec.add(vC))}}),mo.postStyleProps.forEach((ua,Zg)=>{let Ec=z.get(Zg);Ec||z.set(Zg,Ec=new Set),ua.forEach((fE,vC)=>Ec.add(vC))})});if(qr.length){const xn=[];qr.forEach(Bn=>{xn.push(function Iz(e,t){return new wt(3505,!1)}())}),yi.forEach(Bn=>Bn.destroy()),this.reportError(xn)}const Wr=new Map,ca=new Map;E.forEach(xn=>{const Bn=xn.element;s.has(Bn)&&(ca.set(Bn,Bn),this._beforeAnimationBuild(xn.player.namespaceId,xn.instruction,Wr))}),d.forEach(xn=>{const Bn=xn.element;this._getPreviousPlayers(Bn,!1,xn.namespaceId,xn.triggerName,null).forEach(sr=>{Ol(Wr,Bn,[]).push(sr),sr.destroy()})});const kl=mt.filter(xn=>WM(xn,R,z)),Su=new Map;GM(Su,this.driver,dt,z,af).forEach(xn=>{WM(xn,R,z)&&kl.push(xn)});const Yx=new Map;ve.forEach((xn,Bn)=>{GM(Yx,this.driver,new Set(xn),R,"!")}),kl.forEach(xn=>{const Bn=Su.get(xn),Yn=Yx.get(xn);Su.set(xn,new Map([...Bn?.entries()??[],...Yn?.entries()??[]]))});const Wg=[],aR=[],lR={};E.forEach(xn=>{const{element:Bn,player:Yn,instruction:sr}=xn;if(s.has(Bn)){if($.has(Bn))return Yn.onDestroy(()=>Pd(Bn,sr.toStyles)),Yn.disabled=!0,Yn.overrideTotalTime(sr.totalTime),void d.push(Yn);let Os=lR;if(ca.size>1){let Ll=Bn;const Hp=[];for(;Ll=Ll.parentNode;){const mo=ca.get(Ll);if(mo){Os=mo;break}Hp.push(Ll)}Hp.forEach(mo=>ca.set(mo,Os))}const Fd=this._buildAnimation(Yn.namespaceId,sr,Wr,_,Yx,Su);if(Yn.setRealPlayer(Fd),Os===lR)Wg.push(Yn);else{const Ll=this.playersByElement.get(Os);Ll&&Ll.length&&(Yn.parentPlayer=Lp(Ll)),d.push(Yn)}}else Vg(Bn,sr.fromStyles),Yn.onDestroy(()=>Pd(Bn,sr.toStyles)),aR.push(Yn),$.has(Bn)&&d.push(Yn)}),aR.forEach(xn=>{const Bn=_.get(xn.element);if(Bn&&Bn.length){const Yn=Lp(Bn);xn.setRealPlayer(Yn)}}),d.forEach(xn=>{xn.parentPlayer?xn.syncPlayerEvents(xn.parentPlayer):xn.destroy()});for(let xn=0;xn<mt.length;xn++){const Bn=mt[xn],Yn=Bn[Du];if(ov(Bn,A1),Yn&&Yn.hasAnimation)continue;let sr=[];if(S.size){let Fd=S.get(Bn);Fd&&Fd.length&&sr.push(...Fd);let Ll=this.driver.query(Bn,aS,!0);for(let Hp=0;Hp<Ll.length;Hp++){let mo=S.get(Ll[Hp]);mo&&mo.length&&sr.push(...mo)}}const Os=sr.filter(Fd=>!Fd.destroyed);Os.length?CB(this,Bn,Os):this.processLeaveNode(Bn)}return mt.length=0,Wg.forEach(xn=>{this.players.push(xn),xn.onDone(()=>{xn.destroy();const Bn=this.players.indexOf(xn);this.players.splice(Bn,1)}),xn.play()}),Wg}afterFlush(t){this._flushFns.push(t)}afterFlushAnimationsDone(t){this._whenQuietFns.push(t)}_getPreviousPlayers(t,n,s,d,_){let E=[];if(n){const S=this.playersByQueriedElement.get(t);S&&(E=S)}else{const S=this.playersByElement.get(t);if(S){const R=!_||_==zx;S.forEach(z=>{z.queued||!R&&z.triggerName!=d||E.push(z)})}}return(s||d)&&(E=E.filter(S=>!(s&&s!=S.namespaceId||d&&d!=S.triggerName))),E}_beforeAnimationBuild(t,n,s){const _=n.element,E=n.isRemovalTransition?void 0:t,S=n.isRemovalTransition?void 0:n.triggerName;for(const R of n.timelines){const z=R.element,$=z!==_,J=Ol(s,z,[]);this._getPreviousPlayers(z,$,E,S,n.toState).forEach(ve=>{const Oe=ve.getRealPlayer();Oe.beforeDestroy&&Oe.beforeDestroy(),ve.destroy(),J.push(ve)})}Vg(_,n.fromStyles)}_buildAnimation(t,n,s,d,_,E){const S=n.triggerName,R=n.element,z=[],$=new Set,J=new Set,we=n.timelines.map(Oe=>{const He=Oe.element;$.add(He);const mt=He[Du];if(mt&&mt.removedBeforeQueried)return new Fx(Oe.duration,Oe.delay);const Rt=He!==R,dt=function IB(e){const t=[];return qM(e,t),t}((s.get(He)||xB).map(Wr=>Wr.getRealPlayer())).filter(Wr=>!!Wr.element&&Wr.element===He),on=_.get(He),gn=E.get(He),yi=wM(this._normalizer,Oe.keyframes,on,gn),qr=this._buildPlayer(Oe,yi,dt);if(Oe.subTimeline&&d&&J.add(He),Rt){const Wr=new bS(t,S,He);Wr.setRealPlayer(qr),z.push(Wr)}return qr});z.forEach(Oe=>{Ol(this.playersByQueriedElement,Oe.element,[]).push(Oe),Oe.onDone(()=>function TB(e,t,n){let s=e.get(t);if(s){if(s.length){const d=s.indexOf(n);s.splice(d,1)}0==s.length&&e.delete(t)}return s}(this.playersByQueriedElement,Oe.element,Oe))}),$.forEach(Oe=>wc(Oe,AM));const ve=Lp(we);return ve.onDestroy(()=>{$.forEach(Oe=>ov(Oe,AM)),Pd(R,n.toStyles)}),J.forEach(Oe=>{Ol(d,Oe,[]).push(ve)}),ve}_buildPlayer(t,n,s){return n.length>0?this.driver.animate(t.element,n,t.duration,t.delay,t.easing,s):new Fx(t.duration,t.delay)}}class bS{constructor(t,n,s){this.namespaceId=t,this.triggerName=n,this.element=s,this._player=new Fx,this._containsRealPlayer=!1,this._queuedCallbacks=new Map,this.destroyed=!1,this.parentPlayer=null,this.markedForDestroy=!1,this.disabled=!1,this.queued=!0,this.totalTime=0}setRealPlayer(t){this._containsRealPlayer||(this._player=t,this._queuedCallbacks.forEach((n,s)=>{n.forEach(d=>tS(t,s,void 0,d))}),this._queuedCallbacks.clear(),this._containsRealPlayer=!0,this.overrideTotalTime(t.totalTime),this.queued=!1)}getRealPlayer(){return this._player}overrideTotalTime(t){this.totalTime=t}syncPlayerEvents(t){const n=this._player;n.triggerCallback&&t.onStart(()=>n.triggerCallback("start")),t.onDone(()=>this.finish()),t.onDestroy(()=>this.destroy())}_queueEvent(t,n){Ol(this._queuedCallbacks,t,[]).push(n)}onDone(t){this.queued&&this._queueEvent("done",t),this._player.onDone(t)}onStart(t){this.queued&&this._queueEvent("start",t),this._player.onStart(t)}onDestroy(t){this.queued&&this._queueEvent("destroy",t),this._player.onDestroy(t)}init(){this._player.init()}hasStarted(){return!this.queued&&this._player.hasStarted()}play(){!this.queued&&this._player.play()}pause(){!this.queued&&this._player.pause()}restart(){!this.queued&&this._player.restart()}finish(){this._player.finish()}destroy(){this.destroyed=!0,this._player.destroy()}reset(){!this.queued&&this._player.reset()}setPosition(t){this.queued||this._player.setPosition(t)}getPosition(){return this.queued?0:this._player.getPosition()}triggerCallback(t){const n=this._player;n.triggerCallback&&n.triggerCallback(t)}}function V1(e){return e&&1===e.nodeType}function HM(e,t){const n=e.style.display;return e.style.display=t??"none",n}function GM(e,t,n,s,d){const _=[];n.forEach(R=>_.push(HM(R)));const E=[];s.forEach((R,z)=>{const $=new Map;R.forEach(J=>{const we=t.computeStyle(z,J,d);$.set(J,we),(!we||0==we.length)&&(z[Du]=bB,E.push(z))}),e.set(z,$)});let S=0;return n.forEach(R=>HM(R,_[S++])),E}function $M(e,t){const n=new Map;if(e.forEach(S=>n.set(S,[])),0==t.length)return n;const d=new Set(t),_=new Map;function E(S){if(!S)return 1;let R=_.get(S);if(R)return R;const z=S.parentNode;return R=n.has(z)?z:d.has(z)?1:E(z),_.set(S,R),R}return t.forEach(S=>{const R=E(S);1!==R&&n.get(R).push(S)}),n}function wc(e,t){e.classList?.add(t)}function ov(e,t){e.classList?.remove(t)}function CB(e,t,n){Lp(n).onDone(()=>e.processLeaveNode(t))}function qM(e,t){for(let n=0;n<e.length;n++){const s=e[n];s instanceof xM?qM(s.players,t):t.push(s)}}function WM(e,t,n){const s=n.get(e);if(!s)return!1;let d=t.get(e);return d?s.forEach(_=>d.add(_)):t.set(e,s),n.delete(e),!0}class j1{constructor(t,n,s){this.bodyNode=t,this._driver=n,this._normalizer=s,this._triggerCache={},this.onRemovalComplete=(d,_)=>{},this._transitionEngine=new EB(t,n,s),this._timelineEngine=new mB(t,n,s),this._transitionEngine.onRemovalComplete=(d,_)=>this.onRemovalComplete(d,_)}registerTrigger(t,n,s,d,_){const E=t+"-"+d;let S=this._triggerCache[E];if(!S){const R=[],$=dS(this._driver,_,R,[]);if(R.length)throw function _z(e,t){return new wt(3404,!1)}();S=function dB(e,t,n){return new hB(e,t,n)}(d,$,this._normalizer),this._triggerCache[E]=S}this._transitionEngine.registerTrigger(n,d,S)}register(t,n){this._transitionEngine.register(t,n)}destroy(t,n){this._transitionEngine.destroy(t,n)}onInsert(t,n,s,d){this._transitionEngine.insertNode(t,n,s,d)}onRemove(t,n,s){this._transitionEngine.removeNode(t,n,s)}disableAnimations(t,n){this._transitionEngine.markElementAsDisabled(t,n)}process(t,n,s,d){if("@"==s.charAt(0)){const[_,E]=EM(s);this._timelineEngine.command(_,n,E,d)}else this._transitionEngine.trigger(t,n,s,d)}listen(t,n,s,d,_){if("@"==s.charAt(0)){const[E,S]=EM(s);return this._timelineEngine.listen(E,n,S,_)}return this._transitionEngine.listen(t,n,s,d,_)}flush(t=-1){this._transitionEngine.flush(t)}get players(){return[...this._transitionEngine.players,...this._timelineEngine.players]}whenRenderingDone(){return this._transitionEngine.whenRenderingDone()}afterFlushAnimationsDone(t){this._transitionEngine.afterFlushAnimationsDone(t)}}let PB=(()=>{class e{static{this.initialStylesByElement=new WeakMap}constructor(n,s,d){this._element=n,this._startStyles=s,this._endStyles=d,this._state=0;let _=e.initialStylesByElement.get(n);_||e.initialStylesByElement.set(n,_=new Map),this._initialStyles=_}start(){this._state<1&&(this._startStyles&&Pd(this._element,this._startStyles,this._initialStyles),this._state=1)}finish(){this.start(),this._state<2&&(Pd(this._element,this._initialStyles),this._endStyles&&(Pd(this._element,this._endStyles),this._endStyles=null),this._state=1)}destroy(){this.finish(),this._state<3&&(e.initialStylesByElement.delete(this._element),this._startStyles&&(Vg(this._element,this._startStyles),this._endStyles=null),this._endStyles&&(Vg(this._element,this._endStyles),this._endStyles=null),Pd(this._element,this._initialStyles),this._state=3)}}return e})();function wS(e){let t=null;return e.forEach((n,s)=>{(function RB(e){return"display"===e||"position"===e})(s)&&(t=t||new Map,t.set(s,n))}),t}class ZM{constructor(t,n,s,d){this.element=t,this.keyframes=n,this.options=s,this._specialStyles=d,this._onDoneFns=[],this._onStartFns=[],this._onDestroyFns=[],this._initialized=!1,this._finished=!1,this._started=!1,this._destroyed=!1,this._originalOnDoneFns=[],this._originalOnStartFns=[],this.time=0,this.parentPlayer=null,this.currentSnapshot=new Map,this._duration=s.duration,this._delay=s.delay||0,this.time=this._duration+this._delay}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(t=>t()),this._onDoneFns=[])}init(){this._buildPlayer(),this._preparePlayerBeforeStart()}_buildPlayer(){if(this._initialized)return;this._initialized=!0;const t=this.keyframes;this.domPlayer=this._triggerWebAnimation(this.element,t,this.options),this._finalKeyframe=t.length?t[t.length-1]:new Map;const n=()=>this._onFinish();this.domPlayer.addEventListener("finish",n),this.onDestroy(()=>{this.domPlayer.removeEventListener("finish",n)})}_preparePlayerBeforeStart(){this._delay?this._resetDomPlayerState():this.domPlayer.pause()}_convertKeyframesToObject(t){const n=[];return t.forEach(s=>{n.push(Object.fromEntries(s))}),n}_triggerWebAnimation(t,n,s){return t.animate(this._convertKeyframesToObject(n),s)}onStart(t){this._originalOnStartFns.push(t),this._onStartFns.push(t)}onDone(t){this._originalOnDoneFns.push(t),this._onDoneFns.push(t)}onDestroy(t){this._onDestroyFns.push(t)}play(){this._buildPlayer(),this.hasStarted()||(this._onStartFns.forEach(t=>t()),this._onStartFns=[],this._started=!0,this._specialStyles&&this._specialStyles.start()),this.domPlayer.play()}pause(){this.init(),this.domPlayer.pause()}finish(){this.init(),this._specialStyles&&this._specialStyles.finish(),this._onFinish(),this.domPlayer.finish()}reset(){this._resetDomPlayerState(),this._destroyed=!1,this._finished=!1,this._started=!1,this._onStartFns=this._originalOnStartFns,this._onDoneFns=this._originalOnDoneFns}_resetDomPlayerState(){this.domPlayer&&this.domPlayer.cancel()}restart(){this.reset(),this.play()}hasStarted(){return this._started}destroy(){this._destroyed||(this._destroyed=!0,this._resetDomPlayerState(),this._onFinish(),this._specialStyles&&this._specialStyles.destroy(),this._onDestroyFns.forEach(t=>t()),this._onDestroyFns=[])}setPosition(t){void 0===this.domPlayer&&this.init(),this.domPlayer.currentTime=t*this.time}getPosition(){return+(this.domPlayer.currentTime??0)/this.time}get totalTime(){return this._delay+this._duration}beforeDestroy(){const t=new Map;this.hasStarted()&&this._finalKeyframe.forEach((s,d)=>{"offset"!==d&&t.set(d,this._finished?s:OM(this.element,d))}),this.currentSnapshot=t}triggerCallback(t){const n="start"===t?this._onStartFns:this._onDoneFns;n.forEach(s=>s()),n.length=0}}class OB{validateStyleProperty(t){return!0}validateAnimatableStyleProperty(t){return!0}matchesElement(t,n){return!1}containsElement(t,n){return DM(t,n)}getParentElement(t){return rS(t)}query(t,n,s){return SM(t,n,s)}computeStyle(t,n,s){return window.getComputedStyle(t)[n]}animate(t,n,s,d,_,E=[]){const R={duration:s,delay:d,fill:0==d?"both":"forwards"};_&&(R.easing=_);const z=new Map,$=E.filter(ve=>ve instanceof ZM);(function Vz(e,t){return 0===e||0===t})(s,d)&&$.forEach(ve=>{ve.currentSnapshot.forEach((Oe,He)=>z.set(He,Oe))});let J=function Nz(e){return e.length?e[0]instanceof Map?e:e.map(t=>MM(t)):[]}(n).map(ve=>Np(ve));J=function jz(e,t,n){if(n.size&&t.length){let s=t[0],d=[];if(n.forEach((_,E)=>{s.has(E)||d.push(E),s.set(E,_)}),d.length)for(let _=1;_<t.length;_++){let E=t[_];d.forEach(S=>E.set(S,OM(e,S)))}}return t}(t,J,z);const we=function MB(e,t){let n=null,s=null;return Array.isArray(t)&&t.length?(n=wS(t[0]),t.length>1&&(s=wS(t[t.length-1]))):t instanceof Map&&(n=wS(t)),n||s?new PB(e,n,s):null}(t,J);return new ZM(t,J,R,we)}}let FB=(()=>{class e extends hM{constructor(n,s){super(),this._nextAnimationId=0,this._renderer=n.createRenderer(s.body,{id:"0",encapsulation:Go.None,styles:[],data:{animation:[]}})}build(n){const s=this._nextAnimationId.toString();this._nextAnimationId++;const d=Array.isArray(n)?mM(n):n;return XM(this._renderer,null,s,"register",[d]),new kB(s,this._renderer)}static{this.\u0275fac=function(s){return new(s||e)(gt(hp),gt(Sr))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();class kB extends ZN{constructor(t,n){super(),this._id=t,this._renderer=n}create(t,n){return new LB(this._id,t,n||{},this._renderer)}}class LB{constructor(t,n,s,d){this.id=t,this.element=n,this._renderer=d,this.parentPlayer=null,this._started=!1,this.totalTime=0,this._command("create",s)}_listen(t,n){return this._renderer.listen(this.element,`@@${this.id}:${t}`,n)}_command(t,...n){return XM(this._renderer,this.element,this.id,t,n)}onDone(t){this._listen("done",t)}onStart(t){this._listen("start",t)}onDestroy(t){this._listen("destroy",t)}init(){this._command("init")}hasStarted(){return this._started}play(){this._command("play"),this._started=!0}pause(){this._command("pause")}restart(){this._command("restart")}finish(){this._command("finish")}destroy(){this._command("destroy")}reset(){this._command("reset"),this._started=!1}setPosition(t){this._command("setPosition",t)}getPosition(){return this._renderer.engine.players[+this.id]?.getPosition()??0}}function XM(e,t,n,s,d){return e.setProperty(t,`@@${n}:${s}`,d)}const YM="@.disabled";let NB=(()=>{class e{constructor(n,s,d){this.delegate=n,this.engine=s,this._zone=d,this._currentId=0,this._microtaskId=1,this._animationCallbacksBuffer=[],this._rendererCache=new Map,this._cdRecurDepth=0,s.onRemovalComplete=(_,E)=>{const S=E?.parentNode(_);S&&E.removeChild(S,_)}}createRenderer(n,s){const _=this.delegate.createRenderer(n,s);if(!(n&&s&&s.data&&s.data.animation)){let $=this._rendererCache.get(_);return $||($=new KM("",_,this.engine,()=>this._rendererCache.delete(_)),this._rendererCache.set(_,$)),$}const E=s.id,S=s.id+"-"+this._currentId;this._currentId++,this.engine.register(S,n);const R=$=>{Array.isArray($)?$.forEach(R):this.engine.registerTrigger(E,S,n,$.name,$)};return s.data.animation.forEach(R),new zB(this,S,_,this.engine)}begin(){this._cdRecurDepth++,this.delegate.begin&&this.delegate.begin()}_scheduleCountTask(){queueMicrotask(()=>{this._microtaskId++})}scheduleListenerCallback(n,s,d){n>=0&&n<this._microtaskId?this._zone.run(()=>s(d)):(0==this._animationCallbacksBuffer.length&&queueMicrotask(()=>{this._zone.run(()=>{this._animationCallbacksBuffer.forEach(_=>{const[E,S]=_;E(S)}),this._animationCallbacksBuffer=[]})}),this._animationCallbacksBuffer.push([s,d]))}end(){this._cdRecurDepth--,0==this._cdRecurDepth&&this._zone.runOutsideAngular(()=>{this._scheduleCountTask(),this.engine.flush(this._microtaskId)}),this.delegate.end&&this.delegate.end()}whenRenderingDone(){return this.engine.whenRenderingDone()}static{this.\u0275fac=function(s){return new(s||e)(gt(hp),gt(j1),gt(Ti))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();class KM{constructor(t,n,s,d){this.namespaceId=t,this.delegate=n,this.engine=s,this._onDestroy=d}get data(){return this.delegate.data}destroyNode(t){this.delegate.destroyNode?.(t)}destroy(){this.engine.destroy(this.namespaceId,this.delegate),this.engine.afterFlushAnimationsDone(()=>{queueMicrotask(()=>{this.delegate.destroy()})}),this._onDestroy?.()}createElement(t,n){return this.delegate.createElement(t,n)}createComment(t){return this.delegate.createComment(t)}createText(t){return this.delegate.createText(t)}appendChild(t,n){this.delegate.appendChild(t,n),this.engine.onInsert(this.namespaceId,n,t,!1)}insertBefore(t,n,s,d=!0){this.delegate.insertBefore(t,n,s),this.engine.onInsert(this.namespaceId,n,t,d)}removeChild(t,n,s){this.engine.onRemove(this.namespaceId,n,this.delegate)}selectRootElement(t,n){return this.delegate.selectRootElement(t,n)}parentNode(t){return this.delegate.parentNode(t)}nextSibling(t){return this.delegate.nextSibling(t)}setAttribute(t,n,s,d){this.delegate.setAttribute(t,n,s,d)}removeAttribute(t,n,s){this.delegate.removeAttribute(t,n,s)}addClass(t,n){this.delegate.addClass(t,n)}removeClass(t,n){this.delegate.removeClass(t,n)}setStyle(t,n,s,d){this.delegate.setStyle(t,n,s,d)}removeStyle(t,n,s){this.delegate.removeStyle(t,n,s)}setProperty(t,n,s){"@"==n.charAt(0)&&n==YM?this.disableAnimations(t,!!s):this.delegate.setProperty(t,n,s)}setValue(t,n){this.delegate.setValue(t,n)}listen(t,n,s){return this.delegate.listen(t,n,s)}disableAnimations(t,n){this.engine.disableAnimations(t,n)}}class zB extends KM{constructor(t,n,s,d,_){super(n,s,d,_),this.factory=t,this.namespaceId=n}setProperty(t,n,s){"@"==n.charAt(0)?"."==n.charAt(1)&&n==YM?this.disableAnimations(t,s=void 0===s||!!s):this.engine.process(this.namespaceId,t,n.slice(1),s):this.delegate.setProperty(t,n,s)}listen(t,n,s){if("@"==n.charAt(0)){const d=function BB(e){switch(e){case"body":return document.body;case"document":return document;case"window":return window;default:return e}}(t);let _=n.slice(1),E="";return"@"!=_.charAt(0)&&([_,E]=function VB(e){const t=e.indexOf(".");return[e.substring(0,t),e.slice(t+1)]}(_)),this.engine.listen(this.namespaceId,d,_,E,S=>{this.factory.scheduleListenerCallback(S._data||-1,s,S)})}return this.delegate.listen(t,n,s)}}const QM=[{provide:hM,useClass:FB},{provide:gS,useFactory:function UB(){return new aB}},{provide:j1,useClass:(()=>{class e extends j1{constructor(n,s,d,_){super(n.body,s,d)}ngOnDestroy(){this.flush()}static{this.\u0275fac=function(s){return new(s||e)(gt(Sr),gt(oS),gt(gS),gt(Lg))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})()},{provide:hp,useFactory:function HB(e,t,n){return new NB(e,t,n)},deps:[YD,j1,Ti]}],ES=[{provide:oS,useFactory:()=>new OB},{provide:eg,useValue:"BrowserAnimations"},...QM],JM=[{provide:oS,useClass:CM},{provide:eg,useValue:"NoopAnimations"},...QM];let GB=(()=>{class e{static withConfig(n){return{ngModule:e,providers:n.disableAnimations?JM:ES}}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({providers:ES,imports:[lM]})}}return e})();function e2(e,t=0){return function $B(e){return!isNaN(parseFloat(e))&&!isNaN(Number(e))}(e)?Number(e):t}function H1(e){return Array.isArray(e)?e:[e]}function Jo(e){return null==e?"":"string"==typeof e?e:`${e}px`}function sv(e){return e instanceof Xo?e.nativeElement:e}const{isArray:qB}=Array;function TS(e){return Ls(t=>function WB(e,t){return qB(t)?e(...t):e(t)}(e,t))}const ZB=["addListener","removeListener"],XB=["addEventListener","removeEventListener"],YB=["on","off"];function DS(e,t,n,s){if(er(n)&&(s=n,n=void 0),s)return DS(e,t,n).pipe(TS(s));const[d,_]=function JB(e){return er(e.addEventListener)&&er(e.removeEventListener)}(e)?XB.map(E=>S=>e[E](t,S,n)):function KB(e){return er(e.addListener)&&er(e.removeListener)}(e)?ZB.map(t2(e,t)):function QB(e){return er(e.on)&&er(e.off)}(e)?YB.map(t2(e,t)):[];if(!d&&Rn(e))return yn(E=>DS(E,t,n))(Ie(e));if(!d)throw new TypeError("Invalid event target");return new Hi(E=>{const S=(...R)=>E.next(1<R.length?R:R[0]);return d(S),()=>_(S)})}function t2(e,t){return n=>s=>e[n](t,s)}class e3 extends tr{constructor(t,n){super()}schedule(t,n=0){return this}}const G1={setInterval(e,t,...n){const{delegate:s}=G1;return s?.setInterval?s.setInterval(e,t,...n):setInterval(e,t,...n)},clearInterval(e){const{delegate:t}=G1;return(t?.clearInterval||clearInterval)(e)},delegate:void 0};class SS extends e3{constructor(t,n){super(t,n),this.scheduler=t,this.work=n,this.pending=!1}schedule(t,n=0){var s;if(this.closed)return this;this.state=t;const d=this.id,_=this.scheduler;return null!=d&&(this.id=this.recycleAsyncId(_,d,n)),this.pending=!0,this.delay=n,this.id=null!==(s=this.id)&&void 0!==s?s:this.requestAsyncId(_,this.id,n),this}requestAsyncId(t,n,s=0){return G1.setInterval(t.flush.bind(t,this),s)}recycleAsyncId(t,n,s=0){if(null!=s&&this.delay===s&&!1===this.pending)return n;null!=n&&G1.clearInterval(n)}execute(t,n){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;const s=this._execute(t,n);if(s)return s;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(t,n){let d,s=!1;try{this.work(t)}catch(_){s=!0,d=_||new Error("Scheduled action threw falsy error")}if(s)return this.unsubscribe(),d}unsubscribe(){if(!this.closed){const{id:t,scheduler:n}=this,{actions:s}=n;this.work=this.state=this.scheduler=null,this.pending=!1,u(s,this),null!=t&&(this.id=this.recycleAsyncId(n,t,null)),this.delay=null,super.unsubscribe()}}}const Bx={schedule(e){let t=requestAnimationFrame,n=cancelAnimationFrame;const{delegate:s}=Bx;s&&(t=s.requestAnimationFrame,n=s.cancelAnimationFrame);const d=t(_=>{n=void 0,e(_)});return new tr(()=>n?.(d))},requestAnimationFrame(...e){const{delegate:t}=Bx;return(t?.requestAnimationFrame||requestAnimationFrame)(...e)},cancelAnimationFrame(...e){const{delegate:t}=Bx;return(t?.cancelAnimationFrame||cancelAnimationFrame)(...e)},delegate:void 0},n2={now:()=>(n2.delegate||Date).now(),delegate:void 0};class Vx{constructor(t,n=Vx.now){this.schedulerActionCtor=t,this.now=n}schedule(t,n=0,s){return new this.schedulerActionCtor(this,t).schedule(s,n)}}Vx.now=n2.now;class CS extends Vx{constructor(t,n=Vx.now){super(t,n),this.actions=[],this._active=!1}flush(t){const{actions:n}=this;if(this._active)return void n.push(t);let s;this._active=!0;do{if(s=t.execute(t.state,t.delay))break}while(t=n.shift());if(this._active=!1,s){for(;t=n.shift();)t.unsubscribe();throw s}}}new class n3 extends CS{flush(t){let n;this._active=!0,t?n=t.id:(n=this._scheduled,this._scheduled=void 0);const{actions:s}=this;let d;t=t||s.shift();do{if(d=t.execute(t.state,t.delay))break}while((t=s[0])&&t.id===n&&s.shift());if(this._active=!1,d){for(;(t=s[0])&&t.id===n&&s.shift();)t.unsubscribe();throw d}}}(class t3 extends SS{constructor(t,n){super(t,n),this.scheduler=t,this.work=n}requestAsyncId(t,n,s=0){return null!==s&&s>0?super.requestAsyncId(t,n,s):(t.actions.push(this),t._scheduled||(t._scheduled=Bx.requestAnimationFrame(()=>t.flush(void 0))))}recycleAsyncId(t,n,s=0){var d;if(null!=s?s>0:this.delay>0)return super.recycleAsyncId(t,n,s);const{actions:_}=t;null!=n&&n===t._scheduled&&(null===(d=_[_.length-1])||void 0===d?void 0:d.id)!==n&&(Bx.cancelAnimationFrame(n),t._scheduled=void 0)}});let IS,o3=1;const $1={};function r2(e){return e in $1&&(delete $1[e],!0)}const s3={setImmediate(e){const t=o3++;return $1[t]=!0,IS||(IS=Promise.resolve()),IS.then(()=>r2(t)&&e()),t},clearImmediate(e){r2(e)}},{setImmediate:a3,clearImmediate:l3}=s3,q1={setImmediate(...e){const{delegate:t}=q1;return(t?.setImmediate||a3)(...e)},clearImmediate(e){const{delegate:t}=q1;return(t?.clearImmediate||l3)(e)},delegate:void 0},AS=(new class u3 extends CS{flush(t){this._active=!0;const n=this._scheduled;this._scheduled=void 0;const{actions:s}=this;let d;t=t||s.shift();do{if(d=t.execute(t.state,t.delay))break}while((t=s[0])&&t.id===n&&s.shift());if(this._active=!1,d){for(;(t=s[0])&&t.id===n&&s.shift();)t.unsubscribe();throw d}}}(class c3 extends SS{constructor(t,n){super(t,n),this.scheduler=t,this.work=n}requestAsyncId(t,n,s=0){return null!==s&&s>0?super.requestAsyncId(t,n,s):(t.actions.push(this),t._scheduled||(t._scheduled=q1.setImmediate(t.flush.bind(t,void 0))))}recycleAsyncId(t,n,s=0){var d;if(null!=s?s>0:this.delay>0)return super.recycleAsyncId(t,n,s);const{actions:_}=t;null!=n&&(null===(d=_[_.length-1])||void 0===d?void 0:d.id)!==n&&(q1.clearImmediate(n),t._scheduled===n&&(t._scheduled=void 0))}}),new CS(SS)),h3=AS;function o2(e,t=AS){return function f3(e){return vi((t,n)=>{let s=!1,d=null,_=null,E=!1;const S=()=>{if(_?.unsubscribe(),_=null,s){s=!1;const z=d;d=null,n.next(z)}E&&n.complete()},R=()=>{_=null,E&&n.complete()};t.subscribe(nr(n,z=>{s=!0,d=z,_||Ie(e(z)).subscribe(_=nr(n,S,R))},()=>{E=!0,(!s||!_||_.closed)&&n.complete()}))})}(()=>function m3(e=0,t,n=h3){let s=-1;return null!=t&&(Vn(t)?n=t:s=t),new Hi(d=>{let _=function p3(e){return e instanceof Date&&!isNaN(e)}(e)?+e-n.now():e;_<0&&(_=0);let E=0;return n.schedule(function(){d.closed||(d.next(E++),0<=s?this.schedule(void 0,s):d.complete())},_)})}(e,t))}function zp(e,t){return vi((n,s)=>{let d=0;n.subscribe(nr(s,_=>e.call(t,_,d++)&&s.next(_)))})}let MS;try{MS=typeof Intl<"u"&&Intl.v8BreakIterator}catch{MS=!1}let jx,Ug,PS,Rd=(()=>{class e{constructor(n){this._platformId=n,this.isBrowser=this._platformId?function XL(e){return e===GA}(this._platformId):"object"==typeof document&&!!document,this.EDGE=this.isBrowser&&/(edge)/i.test(navigator.userAgent),this.TRIDENT=this.isBrowser&&/(msie|trident)/i.test(navigator.userAgent),this.BLINK=this.isBrowser&&!(!window.chrome&&!MS)&&typeof CSS<"u"&&!this.EDGE&&!this.TRIDENT,this.WEBKIT=this.isBrowser&&/AppleWebKit/i.test(navigator.userAgent)&&!this.BLINK&&!this.EDGE&&!this.TRIDENT,this.IOS=this.isBrowser&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!("MSStream"in window),this.FIREFOX=this.isBrowser&&/(firefox|minefield)/i.test(navigator.userAgent),this.ANDROID=this.isBrowser&&/android/i.test(navigator.userAgent)&&!this.TRIDENT,this.SAFARI=this.isBrowser&&/safari/i.test(navigator.userAgent)&&this.WEBKIT}static{this.\u0275fac=function(s){return new(s||e)(gt(gd))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();function W1(e){return function g3(){if(null==jx&&typeof window<"u")try{window.addEventListener("test",null,Object.defineProperty({},"passive",{get:()=>jx=!0}))}finally{jx=jx||!1}return jx}()?e:!!e.capture}function _3(){if(null==Ug){if("object"!=typeof document||!document||"function"!=typeof Element||!Element)return Ug=!1,Ug;if("scrollBehavior"in document.documentElement.style)Ug=!0;else{const e=Element.prototype.scrollTo;Ug=!!e&&!/\{\s*\[native code\]\s*\}/.test(e.toString())}}return Ug}function RS(){let e=typeof document<"u"&&document?document.activeElement:null;for(;e&&e.shadowRoot;){const t=e.shadowRoot.activeElement;if(t===e)break;e=t}return e}function Bp(e){return e.composedPath?e.composedPath()[0]:e.target}function OS(){return typeof __karma__<"u"&&!!__karma__||typeof jasmine<"u"&&!!jasmine||typeof jest<"u"&&!!jest||typeof Mocha<"u"&&!!Mocha}const x3=new Xt("cdk-dir-doc",{providedIn:"root",factory:function b3(){return ui(Sr)}}),w3=/^(ar|ckb|dv|he|iw|fa|nqo|ps|sd|ug|ur|yi|.*[-_](Adlm|Arab|Hebr|Nkoo|Rohg|Thaa))(?!.*[-_](Latn|Cyrl)($|-|_))($|-|_)/i;let FS=(()=>{class e{constructor(n){this.value="ltr",this.change=new fo,n&&(this.value=function E3(e){const t=e?.toLowerCase()||"";return"auto"===t&&typeof navigator<"u"&&navigator?.language?w3.test(navigator.language)?"rtl":"ltr":"rtl"===t?"rtl":"ltr"}((n.body?n.body.dir:null)||(n.documentElement?n.documentElement.dir:null)||"ltr"))}ngOnDestroy(){this.change.complete()}static{this.\u0275fac=function(s){return new(s||e)(gt(x3,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),Ux=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({})}}return e})(),D3=(()=>{class e{constructor(n,s,d){this._ngZone=n,this._platform=s,this._scrolled=new Gi,this._globalSubscription=null,this._scrolledCount=0,this.scrollContainers=new Map,this._document=d}register(n){this.scrollContainers.has(n)||this.scrollContainers.set(n,n.elementScrolled().subscribe(()=>this._scrolled.next(n)))}deregister(n){const s=this.scrollContainers.get(n);s&&(s.unsubscribe(),this.scrollContainers.delete(n))}scrolled(n=20){return this._platform.isBrowser?new Hi(s=>{this._globalSubscription||this._addGlobalListener();const d=n>0?this._scrolled.pipe(o2(n)).subscribe(s):this._scrolled.subscribe(s);return this._scrolledCount++,()=>{d.unsubscribe(),this._scrolledCount--,this._scrolledCount||this._removeGlobalListener()}}):Dc()}ngOnDestroy(){this._removeGlobalListener(),this.scrollContainers.forEach((n,s)=>this.deregister(s)),this._scrolled.complete()}ancestorScrolled(n,s){const d=this.getAncestorScrollContainers(n);return this.scrolled(s).pipe(zp(_=>!_||d.indexOf(_)>-1))}getAncestorScrollContainers(n){const s=[];return this.scrollContainers.forEach((d,_)=>{this._scrollableContainsElement(_,n)&&s.push(_)}),s}_getWindow(){return this._document.defaultView||window}_scrollableContainsElement(n,s){let d=sv(s),_=n.getElementRef().nativeElement;do{if(d==_)return!0}while(d=d.parentElement);return!1}_addGlobalListener(){this._globalSubscription=this._ngZone.runOutsideAngular(()=>DS(this._getWindow().document,"scroll").subscribe(()=>this._scrolled.next()))}_removeGlobalListener(){this._globalSubscription&&(this._globalSubscription.unsubscribe(),this._globalSubscription=null)}static{this.\u0275fac=function(s){return new(s||e)(gt(Ti),gt(Rd),gt(Sr,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),a2=(()=>{class e{constructor(n,s,d){this._platform=n,this._change=new Gi,this._changeListener=_=>{this._change.next(_)},this._document=d,s.runOutsideAngular(()=>{if(n.isBrowser){const _=this._getWindow();_.addEventListener("resize",this._changeListener),_.addEventListener("orientationchange",this._changeListener)}this.change().subscribe(()=>this._viewportSize=null)})}ngOnDestroy(){if(this._platform.isBrowser){const n=this._getWindow();n.removeEventListener("resize",this._changeListener),n.removeEventListener("orientationchange",this._changeListener)}this._change.complete()}getViewportSize(){this._viewportSize||this._updateViewportSize();const n={width:this._viewportSize.width,height:this._viewportSize.height};return this._platform.isBrowser||(this._viewportSize=null),n}getViewportRect(){const n=this.getViewportScrollPosition(),{width:s,height:d}=this.getViewportSize();return{top:n.top,left:n.left,bottom:n.top+d,right:n.left+s,height:d,width:s}}getViewportScrollPosition(){if(!this._platform.isBrowser)return{top:0,left:0};const n=this._document,s=this._getWindow(),d=n.documentElement,_=d.getBoundingClientRect();return{top:-_.top||n.body.scrollTop||s.scrollY||d.scrollTop||0,left:-_.left||n.body.scrollLeft||s.scrollX||d.scrollLeft||0}}change(n=20){return n>0?this._change.pipe(o2(n)):this._change}_getWindow(){return this._document.defaultView||window}_updateViewportSize(){const n=this._getWindow();this._viewportSize=this._platform.isBrowser?{width:n.innerWidth,height:n.innerHeight}:{width:0,height:0}}static{this.\u0275fac=function(s){return new(s||e)(gt(Rd),gt(Ti),gt(Sr,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),l2=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({})}}return e})(),c2=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({imports:[Ux,l2,Ux,l2]})}}return e})();function lv(e){return e<=0?()=>Cr:vi((t,n)=>{let s=0;t.subscribe(nr(n,d=>{++s<=e&&(n.next(d),e<=s&&n.complete())}))})}function kS(e){return vi((t,n)=>{Ie(e).subscribe(nr(n,()=>n.complete(),fn)),!n.closed&&t.subscribe(n)})}class LS{attach(t){return this._attachedHost=t,t.attach(this)}detach(){let t=this._attachedHost;null!=t&&(this._attachedHost=null,t.detach())}get isAttached(){return null!=this._attachedHost}setAttachedHost(t){this._attachedHost=t}}class NS extends LS{constructor(t,n,s,d,_){super(),this.component=t,this.viewContainerRef=n,this.injector=s,this.componentFactoryResolver=d,this.projectableNodes=_}}class u2 extends LS{constructor(t,n,s,d){super(),this.templateRef=t,this.viewContainerRef=n,this.context=s,this.injector=d}get origin(){return this.templateRef.elementRef}attach(t,n=this.context){return this.context=n,super.attach(t)}detach(){return this.context=void 0,super.detach()}}class C3 extends LS{constructor(t){super(),this.element=t instanceof Xo?t.nativeElement:t}}class zS{constructor(){this._isDisposed=!1,this.attachDomPortal=null}hasAttached(){return!!this._attachedPortal}attach(t){return t instanceof NS?(this._attachedPortal=t,this.attachComponentPortal(t)):t instanceof u2?(this._attachedPortal=t,this.attachTemplatePortal(t)):this.attachDomPortal&&t instanceof C3?(this._attachedPortal=t,this.attachDomPortal(t)):void 0}detach(){this._attachedPortal&&(this._attachedPortal.setAttachedHost(null),this._attachedPortal=null),this._invokeDisposeFn()}dispose(){this.hasAttached()&&this.detach(),this._invokeDisposeFn(),this._isDisposed=!0}setDisposeFn(t){this._disposeFn=t}_invokeDisposeFn(){this._disposeFn&&(this._disposeFn(),this._disposeFn=null)}}class I3 extends zS{constructor(t,n,s,d,_){super(),this.outletElement=t,this._componentFactoryResolver=n,this._appRef=s,this._defaultInjector=d,this.attachDomPortal=E=>{const S=E.element,R=this._document.createComment("dom-portal");S.parentNode.insertBefore(R,S),this.outletElement.appendChild(S),this._attachedPortal=E,super.setDisposeFn(()=>{R.parentNode&&R.parentNode.replaceChild(S,R)})},this._document=_}attachComponentPortal(t){const s=(t.componentFactoryResolver||this._componentFactoryResolver).resolveComponentFactory(t.component);let d;return t.viewContainerRef?(d=t.viewContainerRef.createComponent(s,t.viewContainerRef.length,t.injector||t.viewContainerRef.injector,t.projectableNodes||void 0),this.setDisposeFn(()=>d.destroy())):(d=s.create(t.injector||this._defaultInjector||Yo.NULL),this._appRef.attachView(d.hostView),this.setDisposeFn(()=>{this._appRef.viewCount>0&&this._appRef.detachView(d.hostView),d.destroy()})),this.outletElement.appendChild(this._getComponentRootNode(d)),this._attachedPortal=t,d}attachTemplatePortal(t){let n=t.viewContainerRef,s=n.createEmbeddedView(t.templateRef,t.context,{injector:t.injector});return s.rootNodes.forEach(d=>this.outletElement.appendChild(d)),s.detectChanges(),this.setDisposeFn(()=>{let d=n.indexOf(s);-1!==d&&n.remove(d)}),this._attachedPortal=t,s}dispose(){super.dispose(),this.outletElement.remove()}_getComponentRootNode(t){return t.hostView.rootNodes[0]}}let BS=(()=>{class e extends zS{constructor(n,s,d){super(),this._componentFactoryResolver=n,this._viewContainerRef=s,this._isInitialized=!1,this.attached=new fo,this.attachDomPortal=_=>{const E=_.element,S=this._document.createComment("dom-portal");_.setAttachedHost(this),E.parentNode.insertBefore(S,E),this._getRootNode().appendChild(E),this._attachedPortal=_,super.setDisposeFn(()=>{S.parentNode&&S.parentNode.replaceChild(E,S)})},this._document=d}get portal(){return this._attachedPortal}set portal(n){this.hasAttached()&&!n&&!this._isInitialized||(this.hasAttached()&&super.detach(),n&&super.attach(n),this._attachedPortal=n||null)}get attachedRef(){return this._attachedRef}ngOnInit(){this._isInitialized=!0}ngOnDestroy(){super.dispose(),this._attachedRef=this._attachedPortal=null}attachComponentPortal(n){n.setAttachedHost(this);const s=null!=n.viewContainerRef?n.viewContainerRef:this._viewContainerRef,_=(n.componentFactoryResolver||this._componentFactoryResolver).resolveComponentFactory(n.component),E=s.createComponent(_,s.length,n.injector||s.injector,n.projectableNodes||void 0);return s!==this._viewContainerRef&&this._getRootNode().appendChild(E.hostView.rootNodes[0]),super.setDisposeFn(()=>E.destroy()),this._attachedPortal=n,this._attachedRef=E,this.attached.emit(E),E}attachTemplatePortal(n){n.setAttachedHost(this);const s=this._viewContainerRef.createEmbeddedView(n.templateRef,n.context,{injector:n.injector});return super.setDisposeFn(()=>this._viewContainerRef.clear()),this._attachedPortal=n,this._attachedRef=s,this.attached.emit(s),s}_getRootNode(){const n=this._viewContainerRef.element.nativeElement;return n.nodeType===n.ELEMENT_NODE?n:n.parentNode}static{this.\u0275fac=function(s){return new(s||e)(Dt(up),Dt(wu),Dt(Sr))}}static{this.\u0275dir=Dn({type:e,selectors:[["","cdkPortalOutlet",""]],inputs:{portal:["cdkPortalOutlet","portal"]},outputs:{attached:"attached"},exportAs:["cdkPortalOutlet"],features:[zi]})}}return e})(),X1=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({})}}return e})();const d2=_3();class A3{constructor(t,n){this._viewportRuler=t,this._previousHTMLStyles={top:"",left:""},this._isEnabled=!1,this._document=n}attach(){}enable(){if(this._canBeEnabled()){const t=this._document.documentElement;this._previousScrollPosition=this._viewportRuler.getViewportScrollPosition(),this._previousHTMLStyles.left=t.style.left||"",this._previousHTMLStyles.top=t.style.top||"",t.style.left=Jo(-this._previousScrollPosition.left),t.style.top=Jo(-this._previousScrollPosition.top),t.classList.add("cdk-global-scrollblock"),this._isEnabled=!0}}disable(){if(this._isEnabled){const t=this._document.documentElement,s=t.style,d=this._document.body.style,_=s.scrollBehavior||"",E=d.scrollBehavior||"";this._isEnabled=!1,s.left=this._previousHTMLStyles.left,s.top=this._previousHTMLStyles.top,t.classList.remove("cdk-global-scrollblock"),d2&&(s.scrollBehavior=d.scrollBehavior="auto"),window.scroll(this._previousScrollPosition.left,this._previousScrollPosition.top),d2&&(s.scrollBehavior=_,d.scrollBehavior=E)}}_canBeEnabled(){if(this._document.documentElement.classList.contains("cdk-global-scrollblock")||this._isEnabled)return!1;const n=this._document.body,s=this._viewportRuler.getViewportSize();return n.scrollHeight>s.height||n.scrollWidth>s.width}}class M3{constructor(t,n,s,d){this._scrollDispatcher=t,this._ngZone=n,this._viewportRuler=s,this._config=d,this._scrollSubscription=null,this._detach=()=>{this.disable(),this._overlayRef.hasAttached()&&this._ngZone.run(()=>this._overlayRef.detach())}}attach(t){this._overlayRef=t}enable(){if(this._scrollSubscription)return;const t=this._scrollDispatcher.scrolled(0).pipe(zp(n=>!n||!this._overlayRef.overlayElement.contains(n.getElementRef().nativeElement)));this._config&&this._config.threshold&&this._config.threshold>1?(this._initialScrollPosition=this._viewportRuler.getViewportScrollPosition().top,this._scrollSubscription=t.subscribe(()=>{const n=this._viewportRuler.getViewportScrollPosition().top;Math.abs(n-this._initialScrollPosition)>this._config.threshold?this._detach():this._overlayRef.updatePosition()})):this._scrollSubscription=t.subscribe(this._detach)}disable(){this._scrollSubscription&&(this._scrollSubscription.unsubscribe(),this._scrollSubscription=null)}detach(){this.disable(),this._overlayRef=null}}class h2{enable(){}disable(){}attach(){}}function VS(e,t){return t.some(n=>e.bottom<n.top||e.top>n.bottom||e.right<n.left||e.left>n.right)}function f2(e,t){return t.some(n=>e.top<n.top||e.bottom>n.bottom||e.left<n.left||e.right>n.right)}class P3{constructor(t,n,s,d){this._scrollDispatcher=t,this._viewportRuler=n,this._ngZone=s,this._config=d,this._scrollSubscription=null}attach(t){this._overlayRef=t}enable(){this._scrollSubscription||(this._scrollSubscription=this._scrollDispatcher.scrolled(this._config?this._config.scrollThrottle:0).subscribe(()=>{if(this._overlayRef.updatePosition(),this._config&&this._config.autoClose){const n=this._overlayRef.overlayElement.getBoundingClientRect(),{width:s,height:d}=this._viewportRuler.getViewportSize();VS(n,[{width:s,height:d,bottom:d,right:s,top:0,left:0}])&&(this.disable(),this._ngZone.run(()=>this._overlayRef.detach()))}}))}disable(){this._scrollSubscription&&(this._scrollSubscription.unsubscribe(),this._scrollSubscription=null)}detach(){this.disable(),this._overlayRef=null}}let R3=(()=>{class e{constructor(n,s,d,_){this._scrollDispatcher=n,this._viewportRuler=s,this._ngZone=d,this.noop=()=>new h2,this.close=E=>new M3(this._scrollDispatcher,this._ngZone,this._viewportRuler,E),this.block=()=>new A3(this._viewportRuler,this._document),this.reposition=E=>new P3(this._scrollDispatcher,this._viewportRuler,this._ngZone,E),this._document=_}static{this.\u0275fac=function(s){return new(s||e)(gt(D3),gt(a2),gt(Ti),gt(Sr))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();class p2{constructor(t){if(this.scrollStrategy=new h2,this.panelClass="",this.hasBackdrop=!1,this.backdropClass="cdk-overlay-dark-backdrop",this.disposeOnNavigation=!1,t){const n=Object.keys(t);for(const s of n)void 0!==t[s]&&(this[s]=t[s])}}}class O3{constructor(t,n){this.connectionPair=t,this.scrollableViewProperties=n}}let m2=(()=>{class e{constructor(n){this._attachedOverlays=[],this._document=n}ngOnDestroy(){this.detach()}add(n){this.remove(n),this._attachedOverlays.push(n)}remove(n){const s=this._attachedOverlays.indexOf(n);s>-1&&this._attachedOverlays.splice(s,1),0===this._attachedOverlays.length&&this.detach()}static{this.\u0275fac=function(s){return new(s||e)(gt(Sr))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),F3=(()=>{class e extends m2{constructor(n,s){super(n),this._ngZone=s,this._keydownListener=d=>{const _=this._attachedOverlays;for(let E=_.length-1;E>-1;E--)if(_[E]._keydownEvents.observers.length>0){const S=_[E]._keydownEvents;this._ngZone?this._ngZone.run(()=>S.next(d)):S.next(d);break}}}add(n){super.add(n),this._isAttached||(this._ngZone?this._ngZone.runOutsideAngular(()=>this._document.body.addEventListener("keydown",this._keydownListener)):this._document.body.addEventListener("keydown",this._keydownListener),this._isAttached=!0)}detach(){this._isAttached&&(this._document.body.removeEventListener("keydown",this._keydownListener),this._isAttached=!1)}static{this.\u0275fac=function(s){return new(s||e)(gt(Sr),gt(Ti,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),k3=(()=>{class e extends m2{constructor(n,s,d){super(n),this._platform=s,this._ngZone=d,this._cursorStyleIsSet=!1,this._pointerDownListener=_=>{this._pointerDownEventTarget=Bp(_)},this._clickListener=_=>{const E=Bp(_),S="click"===_.type&&this._pointerDownEventTarget?this._pointerDownEventTarget:E;this._pointerDownEventTarget=null;const R=this._attachedOverlays.slice();for(let z=R.length-1;z>-1;z--){const $=R[z];if($._outsidePointerEvents.observers.length<1||!$.hasAttached())continue;if($.overlayElement.contains(E)||$.overlayElement.contains(S))break;const J=$._outsidePointerEvents;this._ngZone?this._ngZone.run(()=>J.next(_)):J.next(_)}}}add(n){if(super.add(n),!this._isAttached){const s=this._document.body;this._ngZone?this._ngZone.runOutsideAngular(()=>this._addEventListeners(s)):this._addEventListeners(s),this._platform.IOS&&!this._cursorStyleIsSet&&(this._cursorOriginalValue=s.style.cursor,s.style.cursor="pointer",this._cursorStyleIsSet=!0),this._isAttached=!0}}detach(){if(this._isAttached){const n=this._document.body;n.removeEventListener("pointerdown",this._pointerDownListener,!0),n.removeEventListener("click",this._clickListener,!0),n.removeEventListener("auxclick",this._clickListener,!0),n.removeEventListener("contextmenu",this._clickListener,!0),this._platform.IOS&&this._cursorStyleIsSet&&(n.style.cursor=this._cursorOriginalValue,this._cursorStyleIsSet=!1),this._isAttached=!1}}_addEventListeners(n){n.addEventListener("pointerdown",this._pointerDownListener,!0),n.addEventListener("click",this._clickListener,!0),n.addEventListener("auxclick",this._clickListener,!0),n.addEventListener("contextmenu",this._clickListener,!0)}static{this.\u0275fac=function(s){return new(s||e)(gt(Sr),gt(Rd),gt(Ti,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),Y1=(()=>{class e{constructor(n,s){this._platform=s,this._document=n}ngOnDestroy(){this._containerElement?.remove()}getContainerElement(){return this._containerElement||this._createContainer(),this._containerElement}_createContainer(){const n="cdk-overlay-container";if(this._platform.isBrowser||OS()){const d=this._document.querySelectorAll(`.${n}[platform="server"], .${n}[platform="test"]`);for(let _=0;_<d.length;_++)d[_].remove()}const s=this._document.createElement("div");s.classList.add(n),OS()?s.setAttribute("platform","test"):this._platform.isBrowser||s.setAttribute("platform","server"),this._document.body.appendChild(s),this._containerElement=s}static{this.\u0275fac=function(s){return new(s||e)(gt(Sr),gt(Rd))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();class Hx{constructor(t,n,s,d,_,E,S,R,z,$=!1){this._portalOutlet=t,this._host=n,this._pane=s,this._config=d,this._ngZone=_,this._keyboardDispatcher=E,this._document=S,this._location=R,this._outsideClickDispatcher=z,this._animationsDisabled=$,this._backdropElement=null,this._backdropClick=new Gi,this._attachments=new Gi,this._detachments=new Gi,this._locationChanges=tr.EMPTY,this._backdropClickHandler=J=>this._backdropClick.next(J),this._backdropTransitionendHandler=J=>{this._disposeBackdrop(J.target)},this._keydownEvents=new Gi,this._outsidePointerEvents=new Gi,d.scrollStrategy&&(this._scrollStrategy=d.scrollStrategy,this._scrollStrategy.attach(this)),this._positionStrategy=d.positionStrategy}get overlayElement(){return this._pane}get backdropElement(){return this._backdropElement}get hostElement(){return this._host}attach(t){!this._host.parentElement&&this._previousHostParent&&this._previousHostParent.appendChild(this._host);const n=this._portalOutlet.attach(t);return this._positionStrategy&&this._positionStrategy.attach(this),this._updateStackingOrder(),this._updateElementSize(),this._updateElementDirection(),this._scrollStrategy&&this._scrollStrategy.enable(),this._ngZone.onStable.pipe(lv(1)).subscribe(()=>{this.hasAttached()&&this.updatePosition()}),this._togglePointerEvents(!0),this._config.hasBackdrop&&this._attachBackdrop(),this._config.panelClass&&this._toggleClasses(this._pane,this._config.panelClass,!0),this._attachments.next(),this._keyboardDispatcher.add(this),this._config.disposeOnNavigation&&(this._locationChanges=this._location.subscribe(()=>this.dispose())),this._outsideClickDispatcher.add(this),"function"==typeof n?.onDestroy&&n.onDestroy(()=>{this.hasAttached()&&this._ngZone.runOutsideAngular(()=>Promise.resolve().then(()=>this.detach()))}),n}detach(){if(!this.hasAttached())return;this.detachBackdrop(),this._togglePointerEvents(!1),this._positionStrategy&&this._positionStrategy.detach&&this._positionStrategy.detach(),this._scrollStrategy&&this._scrollStrategy.disable();const t=this._portalOutlet.detach();return this._detachments.next(),this._keyboardDispatcher.remove(this),this._detachContentWhenStable(),this._locationChanges.unsubscribe(),this._outsideClickDispatcher.remove(this),t}dispose(){const t=this.hasAttached();this._positionStrategy&&this._positionStrategy.dispose(),this._disposeScrollStrategy(),this._disposeBackdrop(this._backdropElement),this._locationChanges.unsubscribe(),this._keyboardDispatcher.remove(this),this._portalOutlet.dispose(),this._attachments.complete(),this._backdropClick.complete(),this._keydownEvents.complete(),this._outsidePointerEvents.complete(),this._outsideClickDispatcher.remove(this),this._host?.remove(),this._previousHostParent=this._pane=this._host=null,t&&this._detachments.next(),this._detachments.complete()}hasAttached(){return this._portalOutlet.hasAttached()}backdropClick(){return this._backdropClick}attachments(){return this._attachments}detachments(){return this._detachments}keydownEvents(){return this._keydownEvents}outsidePointerEvents(){return this._outsidePointerEvents}getConfig(){return this._config}updatePosition(){this._positionStrategy&&this._positionStrategy.apply()}updatePositionStrategy(t){t!==this._positionStrategy&&(this._positionStrategy&&this._positionStrategy.dispose(),this._positionStrategy=t,this.hasAttached()&&(t.attach(this),this.updatePosition()))}updateSize(t){this._config={...this._config,...t},this._updateElementSize()}setDirection(t){this._config={...this._config,direction:t},this._updateElementDirection()}addPanelClass(t){this._pane&&this._toggleClasses(this._pane,t,!0)}removePanelClass(t){this._pane&&this._toggleClasses(this._pane,t,!1)}getDirection(){const t=this._config.direction;return t?"string"==typeof t?t:t.value:"ltr"}updateScrollStrategy(t){t!==this._scrollStrategy&&(this._disposeScrollStrategy(),this._scrollStrategy=t,this.hasAttached()&&(t.attach(this),t.enable()))}_updateElementDirection(){this._host.setAttribute("dir",this.getDirection())}_updateElementSize(){if(!this._pane)return;const t=this._pane.style;t.width=Jo(this._config.width),t.height=Jo(this._config.height),t.minWidth=Jo(this._config.minWidth),t.minHeight=Jo(this._config.minHeight),t.maxWidth=Jo(this._config.maxWidth),t.maxHeight=Jo(this._config.maxHeight)}_togglePointerEvents(t){this._pane.style.pointerEvents=t?"":"none"}_attachBackdrop(){const t="cdk-overlay-backdrop-showing";this._backdropElement=this._document.createElement("div"),this._backdropElement.classList.add("cdk-overlay-backdrop"),this._animationsDisabled&&this._backdropElement.classList.add("cdk-overlay-backdrop-noop-animation"),this._config.backdropClass&&this._toggleClasses(this._backdropElement,this._config.backdropClass,!0),this._host.parentElement.insertBefore(this._backdropElement,this._host),this._backdropElement.addEventListener("click",this._backdropClickHandler),!this._animationsDisabled&&typeof requestAnimationFrame<"u"?this._ngZone.runOutsideAngular(()=>{requestAnimationFrame(()=>{this._backdropElement&&this._backdropElement.classList.add(t)})}):this._backdropElement.classList.add(t)}_updateStackingOrder(){this._host.nextSibling&&this._host.parentNode.appendChild(this._host)}detachBackdrop(){const t=this._backdropElement;if(t){if(this._animationsDisabled)return void this._disposeBackdrop(t);t.classList.remove("cdk-overlay-backdrop-showing"),this._ngZone.runOutsideAngular(()=>{t.addEventListener("transitionend",this._backdropTransitionendHandler)}),t.style.pointerEvents="none",this._backdropTimeout=this._ngZone.runOutsideAngular(()=>setTimeout(()=>{this._disposeBackdrop(t)},500))}}_toggleClasses(t,n,s){const d=H1(n||[]).filter(_=>!!_);d.length&&(s?t.classList.add(...d):t.classList.remove(...d))}_detachContentWhenStable(){this._ngZone.runOutsideAngular(()=>{const t=this._ngZone.onStable.pipe(kS(tl(this._attachments,this._detachments))).subscribe(()=>{(!this._pane||!this._host||0===this._pane.children.length)&&(this._pane&&this._config.panelClass&&this._toggleClasses(this._pane,this._config.panelClass,!1),this._host&&this._host.parentElement&&(this._previousHostParent=this._host.parentElement,this._host.remove()),t.unsubscribe())})})}_disposeScrollStrategy(){const t=this._scrollStrategy;t&&(t.disable(),t.detach&&t.detach())}_disposeBackdrop(t){t&&(t.removeEventListener("click",this._backdropClickHandler),t.removeEventListener("transitionend",this._backdropTransitionendHandler),t.remove(),this._backdropElement===t&&(this._backdropElement=null)),this._backdropTimeout&&(clearTimeout(this._backdropTimeout),this._backdropTimeout=void 0)}}const g2="cdk-overlay-connected-position-bounding-box",L3=/([A-Za-z%]+)$/;class N3{get positions(){return this._preferredPositions}constructor(t,n,s,d,_){this._viewportRuler=n,this._document=s,this._platform=d,this._overlayContainer=_,this._lastBoundingBoxSize={width:0,height:0},this._isPushed=!1,this._canPush=!0,this._growAfterOpen=!1,this._hasFlexibleDimensions=!0,this._positionLocked=!1,this._viewportMargin=0,this._scrollables=[],this._preferredPositions=[],this._positionChanges=new Gi,this._resizeSubscription=tr.EMPTY,this._offsetX=0,this._offsetY=0,this._appliedPanelClasses=[],this.positionChanges=this._positionChanges,this.setOrigin(t)}attach(t){this._validatePositions(),t.hostElement.classList.add(g2),this._overlayRef=t,this._boundingBox=t.hostElement,this._pane=t.overlayElement,this._isDisposed=!1,this._isInitialRender=!0,this._lastPosition=null,this._resizeSubscription.unsubscribe(),this._resizeSubscription=this._viewportRuler.change().subscribe(()=>{this._isInitialRender=!0,this.apply()})}apply(){if(this._isDisposed||!this._platform.isBrowser)return;if(!this._isInitialRender&&this._positionLocked&&this._lastPosition)return void this.reapplyLastPosition();this._clearPanelClasses(),this._resetOverlayElementStyles(),this._resetBoundingBoxStyles(),this._viewportRect=this._getNarrowedViewportRect(),this._originRect=this._getOriginRect(),this._overlayRect=this._pane.getBoundingClientRect(),this._containerRect=this._overlayContainer.getContainerElement().getBoundingClientRect();const t=this._originRect,n=this._overlayRect,s=this._viewportRect,d=this._containerRect,_=[];let E;for(let S of this._preferredPositions){let R=this._getOriginPoint(t,d,S),z=this._getOverlayPoint(R,n,S),$=this._getOverlayFit(z,n,s,S);if($.isCompletelyWithinViewport)return this._isPushed=!1,void this._applyPosition(S,R);this._canFitWithFlexibleDimensions($,z,s)?_.push({position:S,origin:R,overlayRect:n,boundingBoxRect:this._calculateBoundingBoxRect(R,S)}):(!E||E.overlayFit.visibleArea<$.visibleArea)&&(E={overlayFit:$,overlayPoint:z,originPoint:R,position:S,overlayRect:n})}if(_.length){let S=null,R=-1;for(const z of _){const $=z.boundingBoxRect.width*z.boundingBoxRect.height*(z.position.weight||1);$>R&&(R=$,S=z)}return this._isPushed=!1,void this._applyPosition(S.position,S.origin)}if(this._canPush)return this._isPushed=!0,void this._applyPosition(E.position,E.originPoint);this._applyPosition(E.position,E.originPoint)}detach(){this._clearPanelClasses(),this._lastPosition=null,this._previousPushAmount=null,this._resizeSubscription.unsubscribe()}dispose(){this._isDisposed||(this._boundingBox&&Hg(this._boundingBox.style,{top:"",left:"",right:"",bottom:"",height:"",width:"",alignItems:"",justifyContent:""}),this._pane&&this._resetOverlayElementStyles(),this._overlayRef&&this._overlayRef.hostElement.classList.remove(g2),this.detach(),this._positionChanges.complete(),this._overlayRef=this._boundingBox=null,this._isDisposed=!0)}reapplyLastPosition(){if(this._isDisposed||!this._platform.isBrowser)return;const t=this._lastPosition;if(t){this._originRect=this._getOriginRect(),this._overlayRect=this._pane.getBoundingClientRect(),this._viewportRect=this._getNarrowedViewportRect(),this._containerRect=this._overlayContainer.getContainerElement().getBoundingClientRect();const n=this._getOriginPoint(this._originRect,this._containerRect,t);this._applyPosition(t,n)}else this.apply()}withScrollableContainers(t){return this._scrollables=t,this}withPositions(t){return this._preferredPositions=t,-1===t.indexOf(this._lastPosition)&&(this._lastPosition=null),this._validatePositions(),this}withViewportMargin(t){return this._viewportMargin=t,this}withFlexibleDimensions(t=!0){return this._hasFlexibleDimensions=t,this}withGrowAfterOpen(t=!0){return this._growAfterOpen=t,this}withPush(t=!0){return this._canPush=t,this}withLockedPosition(t=!0){return this._positionLocked=t,this}setOrigin(t){return this._origin=t,this}withDefaultOffsetX(t){return this._offsetX=t,this}withDefaultOffsetY(t){return this._offsetY=t,this}withTransformOriginOn(t){return this._transformOriginSelector=t,this}_getOriginPoint(t,n,s){let d,_;if("center"==s.originX)d=t.left+t.width/2;else{const E=this._isRtl()?t.right:t.left,S=this._isRtl()?t.left:t.right;d="start"==s.originX?E:S}return n.left<0&&(d-=n.left),_="center"==s.originY?t.top+t.height/2:"top"==s.originY?t.top:t.bottom,n.top<0&&(_-=n.top),{x:d,y:_}}_getOverlayPoint(t,n,s){let d,_;return d="center"==s.overlayX?-n.width/2:"start"===s.overlayX?this._isRtl()?-n.width:0:this._isRtl()?0:-n.width,_="center"==s.overlayY?-n.height/2:"top"==s.overlayY?0:-n.height,{x:t.x+d,y:t.y+_}}_getOverlayFit(t,n,s,d){const _=y2(n);let{x:E,y:S}=t,R=this._getOffset(d,"x"),z=this._getOffset(d,"y");R&&(E+=R),z&&(S+=z);let we=0-S,ve=S+_.height-s.height,Oe=this._subtractOverflows(_.width,0-E,E+_.width-s.width),He=this._subtractOverflows(_.height,we,ve),mt=Oe*He;return{visibleArea:mt,isCompletelyWithinViewport:_.width*_.height===mt,fitsInViewportVertically:He===_.height,fitsInViewportHorizontally:Oe==_.width}}_canFitWithFlexibleDimensions(t,n,s){if(this._hasFlexibleDimensions){const d=s.bottom-n.y,_=s.right-n.x,E=_2(this._overlayRef.getConfig().minHeight),S=_2(this._overlayRef.getConfig().minWidth);return(t.fitsInViewportVertically||null!=E&&E<=d)&&(t.fitsInViewportHorizontally||null!=S&&S<=_)}return!1}_pushOverlayOnScreen(t,n,s){if(this._previousPushAmount&&this._positionLocked)return{x:t.x+this._previousPushAmount.x,y:t.y+this._previousPushAmount.y};const d=y2(n),_=this._viewportRect,E=Math.max(t.x+d.width-_.width,0),S=Math.max(t.y+d.height-_.height,0),R=Math.max(_.top-s.top-t.y,0),z=Math.max(_.left-s.left-t.x,0);let $=0,J=0;return $=d.width<=_.width?z||-E:t.x<this._viewportMargin?_.left-s.left-t.x:0,J=d.height<=_.height?R||-S:t.y<this._viewportMargin?_.top-s.top-t.y:0,this._previousPushAmount={x:$,y:J},{x:t.x+$,y:t.y+J}}_applyPosition(t,n){if(this._setTransformOrigin(t),this._setOverlayElementStyles(n,t),this._setBoundingBoxStyles(n,t),t.panelClass&&this._addPanelClasses(t.panelClass),this._lastPosition=t,this._positionChanges.observers.length){const s=this._getScrollVisibility(),d=new O3(t,s);this._positionChanges.next(d)}this._isInitialRender=!1}_setTransformOrigin(t){if(!this._transformOriginSelector)return;const n=this._boundingBox.querySelectorAll(this._transformOriginSelector);let s,d=t.overlayY;s="center"===t.overlayX?"center":this._isRtl()?"start"===t.overlayX?"right":"left":"start"===t.overlayX?"left":"right";for(let _=0;_<n.length;_++)n[_].style.transformOrigin=`${s} ${d}`}_calculateBoundingBoxRect(t,n){const s=this._viewportRect,d=this._isRtl();let _,E,S,$,J,we;if("top"===n.overlayY)E=t.y,_=s.height-E+this._viewportMargin;else if("bottom"===n.overlayY)S=s.height-t.y+2*this._viewportMargin,_=s.height-S+this._viewportMargin;else{const ve=Math.min(s.bottom-t.y+s.top,t.y),Oe=this._lastBoundingBoxSize.height;_=2*ve,E=t.y-ve,_>Oe&&!this._isInitialRender&&!this._growAfterOpen&&(E=t.y-Oe/2)}if("end"===n.overlayX&&!d||"start"===n.overlayX&&d)we=s.width-t.x+this._viewportMargin,$=t.x-this._viewportMargin;else if("start"===n.overlayX&&!d||"end"===n.overlayX&&d)J=t.x,$=s.right-t.x;else{const ve=Math.min(s.right-t.x+s.left,t.x),Oe=this._lastBoundingBoxSize.width;$=2*ve,J=t.x-ve,$>Oe&&!this._isInitialRender&&!this._growAfterOpen&&(J=t.x-Oe/2)}return{top:E,left:J,bottom:S,right:we,width:$,height:_}}_setBoundingBoxStyles(t,n){const s=this._calculateBoundingBoxRect(t,n);!this._isInitialRender&&!this._growAfterOpen&&(s.height=Math.min(s.height,this._lastBoundingBoxSize.height),s.width=Math.min(s.width,this._lastBoundingBoxSize.width));const d={};if(this._hasExactPosition())d.top=d.left="0",d.bottom=d.right=d.maxHeight=d.maxWidth="",d.width=d.height="100%";else{const _=this._overlayRef.getConfig().maxHeight,E=this._overlayRef.getConfig().maxWidth;d.height=Jo(s.height),d.top=Jo(s.top),d.bottom=Jo(s.bottom),d.width=Jo(s.width),d.left=Jo(s.left),d.right=Jo(s.right),d.alignItems="center"===n.overlayX?"center":"end"===n.overlayX?"flex-end":"flex-start",d.justifyContent="center"===n.overlayY?"center":"bottom"===n.overlayY?"flex-end":"flex-start",_&&(d.maxHeight=Jo(_)),E&&(d.maxWidth=Jo(E))}this._lastBoundingBoxSize=s,Hg(this._boundingBox.style,d)}_resetBoundingBoxStyles(){Hg(this._boundingBox.style,{top:"0",left:"0",right:"0",bottom:"0",height:"",width:"",alignItems:"",justifyContent:""})}_resetOverlayElementStyles(){Hg(this._pane.style,{top:"",left:"",bottom:"",right:"",position:"",transform:""})}_setOverlayElementStyles(t,n){const s={},d=this._hasExactPosition(),_=this._hasFlexibleDimensions,E=this._overlayRef.getConfig();if(d){const $=this._viewportRuler.getViewportScrollPosition();Hg(s,this._getExactOverlayY(n,t,$)),Hg(s,this._getExactOverlayX(n,t,$))}else s.position="static";let S="",R=this._getOffset(n,"x"),z=this._getOffset(n,"y");R&&(S+=`translateX(${R}px) `),z&&(S+=`translateY(${z}px)`),s.transform=S.trim(),E.maxHeight&&(d?s.maxHeight=Jo(E.maxHeight):_&&(s.maxHeight="")),E.maxWidth&&(d?s.maxWidth=Jo(E.maxWidth):_&&(s.maxWidth="")),Hg(this._pane.style,s)}_getExactOverlayY(t,n,s){let d={top:"",bottom:""},_=this._getOverlayPoint(n,this._overlayRect,t);return this._isPushed&&(_=this._pushOverlayOnScreen(_,this._overlayRect,s)),"bottom"===t.overlayY?d.bottom=this._document.documentElement.clientHeight-(_.y+this._overlayRect.height)+"px":d.top=Jo(_.y),d}_getExactOverlayX(t,n,s){let E,d={left:"",right:""},_=this._getOverlayPoint(n,this._overlayRect,t);return this._isPushed&&(_=this._pushOverlayOnScreen(_,this._overlayRect,s)),E=this._isRtl()?"end"===t.overlayX?"left":"right":"end"===t.overlayX?"right":"left","right"===E?d.right=this._document.documentElement.clientWidth-(_.x+this._overlayRect.width)+"px":d.left=Jo(_.x),d}_getScrollVisibility(){const t=this._getOriginRect(),n=this._pane.getBoundingClientRect(),s=this._scrollables.map(d=>d.getElementRef().nativeElement.getBoundingClientRect());return{isOriginClipped:f2(t,s),isOriginOutsideView:VS(t,s),isOverlayClipped:f2(n,s),isOverlayOutsideView:VS(n,s)}}_subtractOverflows(t,...n){return n.reduce((s,d)=>s-Math.max(d,0),t)}_getNarrowedViewportRect(){const t=this._document.documentElement.clientWidth,n=this._document.documentElement.clientHeight,s=this._viewportRuler.getViewportScrollPosition();return{top:s.top+this._viewportMargin,left:s.left+this._viewportMargin,right:s.left+t-this._viewportMargin,bottom:s.top+n-this._viewportMargin,width:t-2*this._viewportMargin,height:n-2*this._viewportMargin}}_isRtl(){return"rtl"===this._overlayRef.getDirection()}_hasExactPosition(){return!this._hasFlexibleDimensions||this._isPushed}_getOffset(t,n){return"x"===n?null==t.offsetX?this._offsetX:t.offsetX:null==t.offsetY?this._offsetY:t.offsetY}_validatePositions(){}_addPanelClasses(t){this._pane&&H1(t).forEach(n=>{""!==n&&-1===this._appliedPanelClasses.indexOf(n)&&(this._appliedPanelClasses.push(n),this._pane.classList.add(n))})}_clearPanelClasses(){this._pane&&(this._appliedPanelClasses.forEach(t=>{this._pane.classList.remove(t)}),this._appliedPanelClasses=[])}_getOriginRect(){const t=this._origin;if(t instanceof Xo)return t.nativeElement.getBoundingClientRect();if(t instanceof Element)return t.getBoundingClientRect();const n=t.width||0,s=t.height||0;return{top:t.y,bottom:t.y+s,left:t.x,right:t.x+n,height:s,width:n}}}function Hg(e,t){for(let n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function _2(e){if("number"!=typeof e&&null!=e){const[t,n]=e.split(L3);return n&&"px"!==n?null:parseFloat(t)}return e||null}function y2(e){return{top:Math.floor(e.top),right:Math.floor(e.right),bottom:Math.floor(e.bottom),left:Math.floor(e.left),width:Math.floor(e.width),height:Math.floor(e.height)}}const v2="cdk-global-overlay-wrapper";class z3{constructor(){this._cssPosition="static",this._topOffset="",this._bottomOffset="",this._alignItems="",this._xPosition="",this._xOffset="",this._width="",this._height="",this._isDisposed=!1}attach(t){const n=t.getConfig();this._overlayRef=t,this._width&&!n.width&&t.updateSize({width:this._width}),this._height&&!n.height&&t.updateSize({height:this._height}),t.hostElement.classList.add(v2),this._isDisposed=!1}top(t=""){return this._bottomOffset="",this._topOffset=t,this._alignItems="flex-start",this}left(t=""){return this._xOffset=t,this._xPosition="left",this}bottom(t=""){return this._topOffset="",this._bottomOffset=t,this._alignItems="flex-end",this}right(t=""){return this._xOffset=t,this._xPosition="right",this}start(t=""){return this._xOffset=t,this._xPosition="start",this}end(t=""){return this._xOffset=t,this._xPosition="end",this}width(t=""){return this._overlayRef?this._overlayRef.updateSize({width:t}):this._width=t,this}height(t=""){return this._overlayRef?this._overlayRef.updateSize({height:t}):this._height=t,this}centerHorizontally(t=""){return this.left(t),this._xPosition="center",this}centerVertically(t=""){return this.top(t),this._alignItems="center",this}apply(){if(!this._overlayRef||!this._overlayRef.hasAttached())return;const t=this._overlayRef.overlayElement.style,n=this._overlayRef.hostElement.style,s=this._overlayRef.getConfig(),{width:d,height:_,maxWidth:E,maxHeight:S}=s,R=!("100%"!==d&&"100vw"!==d||E&&"100%"!==E&&"100vw"!==E),z=!("100%"!==_&&"100vh"!==_||S&&"100%"!==S&&"100vh"!==S),$=this._xPosition,J=this._xOffset,we="rtl"===this._overlayRef.getConfig().direction;let ve="",Oe="",He="";R?He="flex-start":"center"===$?(He="center",we?Oe=J:ve=J):we?"left"===$||"end"===$?(He="flex-end",ve=J):("right"===$||"start"===$)&&(He="flex-start",Oe=J):"left"===$||"start"===$?(He="flex-start",ve=J):("right"===$||"end"===$)&&(He="flex-end",Oe=J),t.position=this._cssPosition,t.marginLeft=R?"0":ve,t.marginTop=z?"0":this._topOffset,t.marginBottom=this._bottomOffset,t.marginRight=R?"0":Oe,n.justifyContent=He,n.alignItems=z?"flex-start":this._alignItems}dispose(){if(this._isDisposed||!this._overlayRef)return;const t=this._overlayRef.overlayElement.style,n=this._overlayRef.hostElement,s=n.style;n.classList.remove(v2),s.justifyContent=s.alignItems=t.marginTop=t.marginBottom=t.marginLeft=t.marginRight=t.position="",this._overlayRef=null,this._isDisposed=!0}}let B3=(()=>{class e{constructor(n,s,d,_){this._viewportRuler=n,this._document=s,this._platform=d,this._overlayContainer=_}global(){return new z3}flexibleConnectedTo(n){return new N3(n,this._viewportRuler,this._document,this._platform,this._overlayContainer)}static{this.\u0275fac=function(s){return new(s||e)(gt(a2),gt(Sr),gt(Rd),gt(Y1))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),V3=0,cv=(()=>{class e{constructor(n,s,d,_,E,S,R,z,$,J,we,ve){this.scrollStrategies=n,this._overlayContainer=s,this._componentFactoryResolver=d,this._positionBuilder=_,this._keyboardDispatcher=E,this._injector=S,this._ngZone=R,this._document=z,this._directionality=$,this._location=J,this._outsideClickDispatcher=we,this._animationsModuleType=ve}create(n){const s=this._createHostElement(),d=this._createPaneElement(s),_=this._createPortalOutlet(d),E=new p2(n);return E.direction=E.direction||this._directionality.value,new Hx(_,s,d,E,this._ngZone,this._keyboardDispatcher,this._document,this._location,this._outsideClickDispatcher,"NoopAnimations"===this._animationsModuleType)}position(){return this._positionBuilder}_createPaneElement(n){const s=this._document.createElement("div");return s.id="cdk-overlay-"+V3++,s.classList.add("cdk-overlay-pane"),n.appendChild(s),s}_createHostElement(){const n=this._document.createElement("div");return this._overlayContainer.getContainerElement().appendChild(n),n}_createPortalOutlet(n){return this._appRef||(this._appRef=this._injector.get(Lg)),new I3(n,this._componentFactoryResolver,this._appRef,this._injector,this._document)}static{this.\u0275fac=function(s){return new(s||e)(gt(R3),gt(Y1),gt(up),gt(B3),gt(F3),gt(Yo),gt(Ti),gt(Sr),gt(FS),gt(ID),gt(k3),gt(eg,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();const H3={provide:new Xt("cdk-connected-overlay-scroll-strategy"),deps:[cv],useFactory:function U3(e){return()=>e.scrollStrategies.reposition()}};let x2=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({providers:[cv,H3],imports:[Ux,X1,c2,c2]})}}return e})();function jS(e,...t){return t.length?t.some(n=>e[n]):e.altKey||e.shiftKey||e.ctrlKey||e.metaKey}function E2(e){return zp((t,n)=>e<=n)}let cV=(()=>{class e{create(n){return typeof MutationObserver>"u"?null:new MutationObserver(n)}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),uV=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({providers:[cV]})}}return e})();const{isArray:dV}=Array,{getPrototypeOf:hV,prototype:fV,keys:pV}=Object;function T2(e){if(1===e.length){const t=e[0];if(dV(t))return{args:t,keys:null};if(function mV(e){return e&&"object"==typeof e&&hV(e)===fV}(t)){const n=pV(t);return{args:n.map(s=>t[s]),keys:n}}}return{args:e,keys:null}}function D2(e,t){return e.reduce((n,s,d)=>(n[s]=t[d],n),{})}function S2(e,t,n){e?cn(n,e,t):t()}function US(...e){return function yV(){return ir(1)}()(el(e,Si(e)))}function HS(...e){const t=Si(e);return vi((n,s)=>{(t?US(e,n,t):US(e,n)).subscribe(s)})}const C2=new Set;let Gg,vV=(()=>{class e{constructor(n,s){this._platform=n,this._nonce=s,this._matchMedia=this._platform.isBrowser&&window.matchMedia?window.matchMedia.bind(window):bV}matchMedia(n){return(this._platform.WEBKIT||this._platform.BLINK)&&function xV(e,t){if(!C2.has(e))try{Gg||(Gg=document.createElement("style"),t&&(Gg.nonce=t),Gg.setAttribute("type","text/css"),document.head.appendChild(Gg)),Gg.sheet&&(Gg.sheet.insertRule(`@media ${e} {body{ }}`,0),C2.add(e))}catch(n){console.error(n)}}(n,this._nonce),this._matchMedia(n)}static{this.\u0275fac=function(s){return new(s||e)(gt(Rd),gt(sp,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();function bV(e){return{matches:"all"===e||""===e,media:e,addListener:()=>{},removeListener:()=>{}}}let wV=(()=>{class e{constructor(n,s){this._mediaMatcher=n,this._zone=s,this._queries=new Map,this._destroySubject=new Gi}ngOnDestroy(){this._destroySubject.next(),this._destroySubject.complete()}isMatched(n){return I2(H1(n)).some(d=>this._registerQuery(d).mql.matches)}observe(n){let _=function gV(...e){const t=Si(e),n=Vi(e),{args:s,keys:d}=T2(e);if(0===s.length)return el([],t);const _=new Hi(function _V(e,t,n=oo){return s=>{S2(t,()=>{const{length:d}=e,_=new Array(d);let E=d,S=d;for(let R=0;R<d;R++)S2(t,()=>{const z=el(e[R],t);let $=!1;z.subscribe(nr(s,J=>{_[R]=J,$||($=!0,S--),S||s.next(n(_.slice()))},()=>{--E||s.complete()}))},s)},s)}}(s,t,d?E=>D2(d,E):oo));return n?_.pipe(TS(n)):_}(I2(H1(n)).map(E=>this._registerQuery(E).observable));return _=US(_.pipe(lv(1)),_.pipe(E2(1),function w2(e,t=AS){return vi((n,s)=>{let d=null,_=null,E=null;const S=()=>{if(d){d.unsubscribe(),d=null;const z=_;_=null,s.next(z)}};function R(){const z=E+e,$=t.now();if($<z)return d=this.schedule(void 0,z-$),void s.add(d);S()}n.subscribe(nr(s,z=>{_=z,E=t.now(),d||(d=t.schedule(R,e),s.add(d))},()=>{S(),s.complete()},void 0,()=>{_=d=null}))})}(0))),_.pipe(Ls(E=>{const S={matches:!1,breakpoints:{}};return E.forEach(({matches:R,query:z})=>{S.matches=S.matches||R,S.breakpoints[z]=R}),S}))}_registerQuery(n){if(this._queries.has(n))return this._queries.get(n);const s=this._mediaMatcher.matchMedia(n),_={observable:new Hi(E=>{const S=R=>this._zone.run(()=>E.next(R));return s.addListener(S),()=>{s.removeListener(S)}}).pipe(HS(s),Ls(({matches:E})=>({query:n,matches:E})),kS(this._destroySubject)),mql:s};return this._queries.set(n,_),_}static{this.\u0275fac=function(s){return new(s||e)(gt(vV),gt(Ti))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();function I2(e){return e.map(t=>t.split(",")).reduce((t,n)=>t.concat(n)).map(t=>t.trim())}let K1=(()=>{class e{constructor(n){this._platform=n}isDisabled(n){return n.hasAttribute("disabled")}isVisible(n){return function CV(e){return!!(e.offsetWidth||e.offsetHeight||"function"==typeof e.getClientRects&&e.getClientRects().length)}(n)&&"visible"===getComputedStyle(n).visibility}isTabbable(n){if(!this._platform.isBrowser)return!1;const s=function SV(e){try{return e.frameElement}catch{return null}}(function kV(e){return e.ownerDocument&&e.ownerDocument.defaultView||window}(n));if(s&&(-1===R2(s)||!this.isVisible(s)))return!1;let d=n.nodeName.toLowerCase(),_=R2(n);return n.hasAttribute("contenteditable")?-1!==_:!("iframe"===d||"object"===d||this._platform.WEBKIT&&this._platform.IOS&&!function OV(e){let t=e.nodeName.toLowerCase(),n="input"===t&&e.type;return"text"===n||"password"===n||"select"===t||"textarea"===t}(n))&&("audio"===d?!!n.hasAttribute("controls")&&-1!==_:"video"===d?-1!==_&&(null!==_||this._platform.FIREFOX||n.hasAttribute("controls")):n.tabIndex>=0)}isFocusable(n,s){return function FV(e){return!function AV(e){return function PV(e){return"input"==e.nodeName.toLowerCase()}(e)&&"hidden"==e.type}(e)&&(function IV(e){let t=e.nodeName.toLowerCase();return"input"===t||"select"===t||"button"===t||"textarea"===t}(e)||function MV(e){return function RV(e){return"a"==e.nodeName.toLowerCase()}(e)&&e.hasAttribute("href")}(e)||e.hasAttribute("contenteditable")||P2(e))}(n)&&!this.isDisabled(n)&&(s?.ignoreVisibility||this.isVisible(n))}static{this.\u0275fac=function(s){return new(s||e)(gt(Rd))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();function P2(e){if(!e.hasAttribute("tabindex")||void 0===e.tabIndex)return!1;let t=e.getAttribute("tabindex");return!(!t||isNaN(parseInt(t,10)))}function R2(e){if(!P2(e))return null;const t=parseInt(e.getAttribute("tabindex")||"",10);return isNaN(t)?-1:t}class O2{get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._startAnchor&&this._endAnchor&&(this._toggleAnchorTabIndex(t,this._startAnchor),this._toggleAnchorTabIndex(t,this._endAnchor))}constructor(t,n,s,d,_=!1){this._element=t,this._checker=n,this._ngZone=s,this._document=d,this._hasAttached=!1,this.startAnchorListener=()=>this.focusLastTabbableElement(),this.endAnchorListener=()=>this.focusFirstTabbableElement(),this._enabled=!0,_||this.attachAnchors()}destroy(){const t=this._startAnchor,n=this._endAnchor;t&&(t.removeEventListener("focus",this.startAnchorListener),t.remove()),n&&(n.removeEventListener("focus",this.endAnchorListener),n.remove()),this._startAnchor=this._endAnchor=null,this._hasAttached=!1}attachAnchors(){return!!this._hasAttached||(this._ngZone.runOutsideAngular(()=>{this._startAnchor||(this._startAnchor=this._createAnchor(),this._startAnchor.addEventListener("focus",this.startAnchorListener)),this._endAnchor||(this._endAnchor=this._createAnchor(),this._endAnchor.addEventListener("focus",this.endAnchorListener))}),this._element.parentNode&&(this._element.parentNode.insertBefore(this._startAnchor,this._element),this._element.parentNode.insertBefore(this._endAnchor,this._element.nextSibling),this._hasAttached=!0),this._hasAttached)}focusInitialElementWhenReady(t){return new Promise(n=>{this._executeOnStable(()=>n(this.focusInitialElement(t)))})}focusFirstTabbableElementWhenReady(t){return new Promise(n=>{this._executeOnStable(()=>n(this.focusFirstTabbableElement(t)))})}focusLastTabbableElementWhenReady(t){return new Promise(n=>{this._executeOnStable(()=>n(this.focusLastTabbableElement(t)))})}_getRegionBoundary(t){const n=this._element.querySelectorAll(`[cdk-focus-region-${t}], [cdkFocusRegion${t}], [cdk-focus-${t}]`);return"start"==t?n.length?n[0]:this._getFirstTabbableElement(this._element):n.length?n[n.length-1]:this._getLastTabbableElement(this._element)}focusInitialElement(t){const n=this._element.querySelector("[cdk-focus-initial], [cdkFocusInitial]");if(n){if(!this._checker.isFocusable(n)){const s=this._getFirstTabbableElement(n);return s?.focus(t),!!s}return n.focus(t),!0}return this.focusFirstTabbableElement(t)}focusFirstTabbableElement(t){const n=this._getRegionBoundary("start");return n&&n.focus(t),!!n}focusLastTabbableElement(t){const n=this._getRegionBoundary("end");return n&&n.focus(t),!!n}hasAttached(){return this._hasAttached}_getFirstTabbableElement(t){if(this._checker.isFocusable(t)&&this._checker.isTabbable(t))return t;const n=t.children;for(let s=0;s<n.length;s++){const d=n[s].nodeType===this._document.ELEMENT_NODE?this._getFirstTabbableElement(n[s]):null;if(d)return d}return null}_getLastTabbableElement(t){if(this._checker.isFocusable(t)&&this._checker.isTabbable(t))return t;const n=t.children;for(let s=n.length-1;s>=0;s--){const d=n[s].nodeType===this._document.ELEMENT_NODE?this._getLastTabbableElement(n[s]):null;if(d)return d}return null}_createAnchor(){const t=this._document.createElement("div");return this._toggleAnchorTabIndex(this._enabled,t),t.classList.add("cdk-visually-hidden"),t.classList.add("cdk-focus-trap-anchor"),t.setAttribute("aria-hidden","true"),t}_toggleAnchorTabIndex(t,n){t?n.setAttribute("tabindex","0"):n.removeAttribute("tabindex")}toggleAnchors(t){this._startAnchor&&this._endAnchor&&(this._toggleAnchorTabIndex(t,this._startAnchor),this._toggleAnchorTabIndex(t,this._endAnchor))}_executeOnStable(t){this._ngZone.isStable?t():this._ngZone.onStable.pipe(lv(1)).subscribe(t)}}let GS=(()=>{class e{constructor(n,s,d){this._checker=n,this._ngZone=s,this._document=d}create(n,s=!1){return new O2(n,this._checker,this._ngZone,this._document,s)}static{this.\u0275fac=function(s){return new(s||e)(gt(K1),gt(Ti),gt(Sr))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();function F2(e){return 0===e.buttons||0===e.detail}function k2(e){const t=e.touches&&e.touches[0]||e.changedTouches&&e.changedTouches[0];return!(!t||-1!==t.identifier||null!=t.radiusX&&1!==t.radiusX||null!=t.radiusY&&1!==t.radiusY)}const LV=new Xt("cdk-input-modality-detector-options"),NV={ignoreKeys:[18,17,224,91,16]},uv=W1({passive:!0,capture:!0});let zV=(()=>{class e{get mostRecentModality(){return this._modality.value}constructor(n,s,d,_){this._platform=n,this._mostRecentTarget=null,this._modality=new Ou(null),this._lastTouchMs=0,this._onKeydown=E=>{this._options?.ignoreKeys?.some(S=>S===E.keyCode)||(this._modality.next("keyboard"),this._mostRecentTarget=Bp(E))},this._onMousedown=E=>{Date.now()-this._lastTouchMs<650||(this._modality.next(F2(E)?"keyboard":"mouse"),this._mostRecentTarget=Bp(E))},this._onTouchstart=E=>{k2(E)?this._modality.next("keyboard"):(this._lastTouchMs=Date.now(),this._modality.next("touch"),this._mostRecentTarget=Bp(E))},this._options={...NV,..._},this.modalityDetected=this._modality.pipe(E2(1)),this.modalityChanged=this.modalityDetected.pipe(Ra()),n.isBrowser&&s.runOutsideAngular(()=>{d.addEventListener("keydown",this._onKeydown,uv),d.addEventListener("mousedown",this._onMousedown,uv),d.addEventListener("touchstart",this._onTouchstart,uv)})}ngOnDestroy(){this._modality.complete(),this._platform.isBrowser&&(document.removeEventListener("keydown",this._onKeydown,uv),document.removeEventListener("mousedown",this._onMousedown,uv),document.removeEventListener("touchstart",this._onTouchstart,uv))}static{this.\u0275fac=function(s){return new(s||e)(gt(Rd),gt(Ti),gt(Sr),gt(LV,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();const VV=new Xt("cdk-focus-monitor-default-options"),Q1=W1({passive:!0,capture:!0});let $S=(()=>{class e{constructor(n,s,d,_,E){this._ngZone=n,this._platform=s,this._inputModalityDetector=d,this._origin=null,this._windowFocused=!1,this._originFromTouchInteraction=!1,this._elementInfo=new Map,this._monitoredElementCount=0,this._rootNodeFocusListenerCount=new Map,this._windowFocusListener=()=>{this._windowFocused=!0,this._windowFocusTimeoutId=window.setTimeout(()=>this._windowFocused=!1)},this._stopInputModalityDetector=new Gi,this._rootNodeFocusAndBlurListener=S=>{for(let z=Bp(S);z;z=z.parentElement)"focus"===S.type?this._onFocus(S,z):this._onBlur(S,z)},this._document=_,this._detectionMode=E?.detectionMode||0}monitor(n,s=!1){const d=sv(n);if(!this._platform.isBrowser||1!==d.nodeType)return Dc();const _=function v3(e){if(function y3(){if(null==PS){const e=typeof document<"u"?document.head:null;PS=!(!e||!e.createShadowRoot&&!e.attachShadow)}return PS}()){const t=e.getRootNode?e.getRootNode():null;if(typeof ShadowRoot<"u"&&ShadowRoot&&t instanceof ShadowRoot)return t}return null}(d)||this._getDocument(),E=this._elementInfo.get(d);if(E)return s&&(E.checkChildren=!0),E.subject;const S={checkChildren:s,subject:new Gi,rootNode:_};return this._elementInfo.set(d,S),this._registerGlobalListeners(S),S.subject}stopMonitoring(n){const s=sv(n),d=this._elementInfo.get(s);d&&(d.subject.complete(),this._setClasses(s),this._elementInfo.delete(s),this._removeGlobalListeners(d))}focusVia(n,s,d){const _=sv(n);_===this._getDocument().activeElement?this._getClosestElementsInfo(_).forEach(([S,R])=>this._originChanged(S,s,R)):(this._setOrigin(s),"function"==typeof _.focus&&_.focus(d))}ngOnDestroy(){this._elementInfo.forEach((n,s)=>this.stopMonitoring(s))}_getDocument(){return this._document||document}_getWindow(){return this._getDocument().defaultView||window}_getFocusOrigin(n){return this._origin?this._originFromTouchInteraction?this._shouldBeAttributedToTouch(n)?"touch":"program":this._origin:this._windowFocused&&this._lastFocusOrigin?this._lastFocusOrigin:n&&this._isLastInteractionFromInputLabel(n)?"mouse":"program"}_shouldBeAttributedToTouch(n){return 1===this._detectionMode||!!n?.contains(this._inputModalityDetector._mostRecentTarget)}_setClasses(n,s){n.classList.toggle("cdk-focused",!!s),n.classList.toggle("cdk-touch-focused","touch"===s),n.classList.toggle("cdk-keyboard-focused","keyboard"===s),n.classList.toggle("cdk-mouse-focused","mouse"===s),n.classList.toggle("cdk-program-focused","program"===s)}_setOrigin(n,s=!1){this._ngZone.runOutsideAngular(()=>{this._origin=n,this._originFromTouchInteraction="touch"===n&&s,0===this._detectionMode&&(clearTimeout(this._originTimeoutId),this._originTimeoutId=setTimeout(()=>this._origin=null,this._originFromTouchInteraction?650:1))})}_onFocus(n,s){const d=this._elementInfo.get(s),_=Bp(n);!d||!d.checkChildren&&s!==_||this._originChanged(s,this._getFocusOrigin(_),d)}_onBlur(n,s){const d=this._elementInfo.get(s);!d||d.checkChildren&&n.relatedTarget instanceof Node&&s.contains(n.relatedTarget)||(this._setClasses(s),this._emitOrigin(d,null))}_emitOrigin(n,s){n.subject.observers.length&&this._ngZone.run(()=>n.subject.next(s))}_registerGlobalListeners(n){if(!this._platform.isBrowser)return;const s=n.rootNode,d=this._rootNodeFocusListenerCount.get(s)||0;d||this._ngZone.runOutsideAngular(()=>{s.addEventListener("focus",this._rootNodeFocusAndBlurListener,Q1),s.addEventListener("blur",this._rootNodeFocusAndBlurListener,Q1)}),this._rootNodeFocusListenerCount.set(s,d+1),1==++this._monitoredElementCount&&(this._ngZone.runOutsideAngular(()=>{this._getWindow().addEventListener("focus",this._windowFocusListener)}),this._inputModalityDetector.modalityDetected.pipe(kS(this._stopInputModalityDetector)).subscribe(_=>{this._setOrigin(_,!0)}))}_removeGlobalListeners(n){const s=n.rootNode;if(this._rootNodeFocusListenerCount.has(s)){const d=this._rootNodeFocusListenerCount.get(s);d>1?this._rootNodeFocusListenerCount.set(s,d-1):(s.removeEventListener("focus",this._rootNodeFocusAndBlurListener,Q1),s.removeEventListener("blur",this._rootNodeFocusAndBlurListener,Q1),this._rootNodeFocusListenerCount.delete(s))}--this._monitoredElementCount||(this._getWindow().removeEventListener("focus",this._windowFocusListener),this._stopInputModalityDetector.next(),clearTimeout(this._windowFocusTimeoutId),clearTimeout(this._originTimeoutId))}_originChanged(n,s,d){this._setClasses(n,s),this._emitOrigin(d,s),this._lastFocusOrigin=s}_getClosestElementsInfo(n){const s=[];return this._elementInfo.forEach((d,_)=>{(_===n||d.checkChildren&&_.contains(n))&&s.push([_,d])}),s}_isLastInteractionFromInputLabel(n){const{_mostRecentTarget:s,mostRecentModality:d}=this._inputModalityDetector;if("mouse"!==d||!s||s===n||"INPUT"!==n.nodeName&&"TEXTAREA"!==n.nodeName||n.disabled)return!1;const _=n.labels;if(_)for(let E=0;E<_.length;E++)if(_[E].contains(s))return!0;return!1}static{this.\u0275fac=function(s){return new(s||e)(gt(Ti),gt(Rd),gt(zV),gt(Sr,8),gt(VV,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();const N2="cdk-high-contrast-black-on-white",z2="cdk-high-contrast-white-on-black",qS="cdk-high-contrast-active";let B2=(()=>{class e{constructor(n,s){this._platform=n,this._document=s,this._breakpointSubscription=ui(wV).observe("(forced-colors: active)").subscribe(()=>{this._hasCheckedHighContrastMode&&(this._hasCheckedHighContrastMode=!1,this._applyBodyHighContrastModeCssClasses())})}getHighContrastMode(){if(!this._platform.isBrowser)return 0;const n=this._document.createElement("div");n.style.backgroundColor="rgb(1,2,3)",n.style.position="absolute",this._document.body.appendChild(n);const s=this._document.defaultView||window,d=s&&s.getComputedStyle?s.getComputedStyle(n):null,_=(d&&d.backgroundColor||"").replace(/ /g,"");switch(n.remove(),_){case"rgb(0,0,0)":case"rgb(45,50,54)":case"rgb(32,32,32)":return 2;case"rgb(255,255,255)":case"rgb(255,250,239)":return 1}return 0}ngOnDestroy(){this._breakpointSubscription.unsubscribe()}_applyBodyHighContrastModeCssClasses(){if(!this._hasCheckedHighContrastMode&&this._platform.isBrowser&&this._document.body){const n=this._document.body.classList;n.remove(qS,N2,z2),this._hasCheckedHighContrastMode=!0;const s=this.getHighContrastMode();1===s?n.add(qS,N2):2===s&&n.add(qS,z2)}}static{this.\u0275fac=function(s){return new(s||e)(gt(Rd),gt(Sr))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),jV=(()=>{class e{constructor(n){n._applyBodyHighContrastModeCssClasses()}static{this.\u0275fac=function(s){return new(s||e)(gt(B2))}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({imports:[uV]})}}return e})();function V2(e){return new Hi(t=>{Ie(e()).subscribe(t)})}function UV(e,t){}class J1{constructor(){this.role="dialog",this.panelClass="",this.hasBackdrop=!0,this.backdropClass="",this.disableClose=!1,this.width="",this.height="",this.data=null,this.ariaDescribedBy=null,this.ariaLabelledBy=null,this.ariaLabel=null,this.ariaModal=!0,this.autoFocus="first-tabbable",this.restoreFocus=!0,this.closeOnNavigation=!0,this.closeOnDestroy=!0,this.closeOnOverlayDetachments=!0}}let j2=(()=>{class e extends zS{constructor(n,s,d,_,E,S,R,z){super(),this._elementRef=n,this._focusTrapFactory=s,this._config=_,this._interactivityChecker=E,this._ngZone=S,this._overlayRef=R,this._focusMonitor=z,this._elementFocusedBeforeDialogWasOpened=null,this._closeInteractionType=null,this._ariaLabelledByQueue=[],this.attachDomPortal=$=>{this._portalOutlet.hasAttached();const J=this._portalOutlet.attachDomPortal($);return this._contentAttached(),J},this._document=d,this._config.ariaLabelledBy&&this._ariaLabelledByQueue.push(this._config.ariaLabelledBy)}_contentAttached(){this._initializeFocusTrap(),this._handleBackdropClicks(),this._captureInitialFocus()}_captureInitialFocus(){this._trapFocus()}ngOnDestroy(){this._restoreFocus()}attachComponentPortal(n){this._portalOutlet.hasAttached();const s=this._portalOutlet.attachComponentPortal(n);return this._contentAttached(),s}attachTemplatePortal(n){this._portalOutlet.hasAttached();const s=this._portalOutlet.attachTemplatePortal(n);return this._contentAttached(),s}_recaptureFocus(){this._containsFocus()||this._trapFocus()}_forceFocus(n,s){this._interactivityChecker.isFocusable(n)||(n.tabIndex=-1,this._ngZone.runOutsideAngular(()=>{const d=()=>{n.removeEventListener("blur",d),n.removeEventListener("mousedown",d),n.removeAttribute("tabindex")};n.addEventListener("blur",d),n.addEventListener("mousedown",d)})),n.focus(s)}_focusByCssSelector(n,s){let d=this._elementRef.nativeElement.querySelector(n);d&&this._forceFocus(d,s)}_trapFocus(){const n=this._elementRef.nativeElement;switch(this._config.autoFocus){case!1:case"dialog":this._containsFocus()||n.focus();break;case!0:case"first-tabbable":this._focusTrap.focusInitialElementWhenReady().then(s=>{s||this._focusDialogContainer()});break;case"first-heading":this._focusByCssSelector('h1, h2, h3, h4, h5, h6, [role="heading"]');break;default:this._focusByCssSelector(this._config.autoFocus)}}_restoreFocus(){const n=this._config.restoreFocus;let s=null;if("string"==typeof n?s=this._document.querySelector(n):"boolean"==typeof n?s=n?this._elementFocusedBeforeDialogWasOpened:null:n&&(s=n),this._config.restoreFocus&&s&&"function"==typeof s.focus){const d=RS(),_=this._elementRef.nativeElement;(!d||d===this._document.body||d===_||_.contains(d))&&(this._focusMonitor?(this._focusMonitor.focusVia(s,this._closeInteractionType),this._closeInteractionType=null):s.focus())}this._focusTrap&&this._focusTrap.destroy()}_focusDialogContainer(){this._elementRef.nativeElement.focus&&this._elementRef.nativeElement.focus()}_containsFocus(){const n=this._elementRef.nativeElement,s=RS();return n===s||n.contains(s)}_initializeFocusTrap(){this._focusTrap=this._focusTrapFactory.create(this._elementRef.nativeElement),this._document&&(this._elementFocusedBeforeDialogWasOpened=RS())}_handleBackdropClicks(){this._overlayRef.backdropClick().subscribe(()=>{this._config.disableClose&&this._recaptureFocus()})}static{this.\u0275fac=function(s){return new(s||e)(Dt(Xo),Dt(GS),Dt(Sr,8),Dt(J1),Dt(K1),Dt(Ti),Dt(Hx),Dt($S))}}static{this.\u0275cmp=Yl({type:e,selectors:[["cdk-dialog-container"]],viewQuery:function(s,d){if(1&s&&wI(BS,7),2&s){let _;bI(_=function EI(){return function GO(e,t){return e[ss].queries[t].queryList}(At(),Qc())}())&&(d._portalOutlet=_.first)}},hostAttrs:["tabindex","-1",1,"cdk-dialog-container"],hostVars:6,hostBindings:function(s,d){2&s&&ja("id",d._config.id||null)("role",d._config.role)("aria-modal",d._config.ariaModal)("aria-labelledby",d._config.ariaLabel?null:d._ariaLabelledByQueue[0])("aria-label",d._config.ariaLabel)("aria-describedby",d._config.ariaDescribedBy||null)},features:[zi],decls:1,vars:0,consts:[["cdkPortalOutlet",""]],template:function(s,d){1&s&&ax(0,UV,0,0,"ng-template",0)},dependencies:[BS],styles:[".cdk-dialog-container{display:block;width:100%;height:100%;min-height:inherit;max-height:inherit}"],encapsulation:2})}}return e})();class WS{constructor(t,n){this.overlayRef=t,this.config=n,this.closed=new Gi,this.disableClose=n.disableClose,this.backdropClick=t.backdropClick(),this.keydownEvents=t.keydownEvents(),this.outsidePointerEvents=t.outsidePointerEvents(),this.id=n.id,this.keydownEvents.subscribe(s=>{27===s.keyCode&&!this.disableClose&&!jS(s)&&(s.preventDefault(),this.close(void 0,{focusOrigin:"keyboard"}))}),this.backdropClick.subscribe(()=>{this.disableClose||this.close(void 0,{focusOrigin:"mouse"})}),this._detachSubscription=t.detachments().subscribe(()=>{!1!==n.closeOnOverlayDetachments&&this.close()})}close(t,n){if(this.containerInstance){const s=this.closed;this.containerInstance._closeInteractionType=n?.focusOrigin||"program",this._detachSubscription.unsubscribe(),this.overlayRef.dispose(),s.next(t),s.complete(),this.componentInstance=this.containerInstance=null}}updatePosition(){return this.overlayRef.updatePosition(),this}updateSize(t="",n=""){return this.overlayRef.updateSize({width:t,height:n}),this}addPanelClass(t){return this.overlayRef.addPanelClass(t),this}removePanelClass(t){return this.overlayRef.removePanelClass(t),this}}const U2=new Xt("DialogScrollStrategy"),HV=new Xt("DialogData"),GV=new Xt("DefaultDialogConfig"),qV={provide:U2,deps:[cv],useFactory:function $V(e){return()=>e.scrollStrategies.block()}};let WV=0,H2=(()=>{class e{get openDialogs(){return this._parentDialog?this._parentDialog.openDialogs:this._openDialogsAtThisLevel}get afterOpened(){return this._parentDialog?this._parentDialog.afterOpened:this._afterOpenedAtThisLevel}constructor(n,s,d,_,E,S){this._overlay=n,this._injector=s,this._defaultOptions=d,this._parentDialog=_,this._overlayContainer=E,this._openDialogsAtThisLevel=[],this._afterAllClosedAtThisLevel=new Gi,this._afterOpenedAtThisLevel=new Gi,this._ariaHiddenElements=new Map,this.afterAllClosed=V2(()=>this.openDialogs.length?this._getAfterAllClosed():this._getAfterAllClosed().pipe(HS(void 0))),this._scrollStrategy=S}open(n,s){(s={...this._defaultOptions||new J1,...s}).id=s.id||"cdk-dialog-"+WV++,s.id&&this.getDialogById(s.id);const _=this._getOverlayConfig(s),E=this._overlay.create(_),S=new WS(E,s),R=this._attachContainer(E,S,s);return S.containerInstance=R,this._attachDialogContent(n,S,R,s),this.openDialogs.length||this._hideNonDialogContentFromAssistiveTechnology(),this.openDialogs.push(S),S.closed.subscribe(()=>this._removeOpenDialog(S,!0)),this.afterOpened.next(S),S}closeAll(){ZS(this.openDialogs,n=>n.close())}getDialogById(n){return this.openDialogs.find(s=>s.id===n)}ngOnDestroy(){ZS(this._openDialogsAtThisLevel,n=>{!1===n.config.closeOnDestroy&&this._removeOpenDialog(n,!1)}),ZS(this._openDialogsAtThisLevel,n=>n.close()),this._afterAllClosedAtThisLevel.complete(),this._afterOpenedAtThisLevel.complete(),this._openDialogsAtThisLevel=[]}_getOverlayConfig(n){const s=new p2({positionStrategy:n.positionStrategy||this._overlay.position().global().centerHorizontally().centerVertically(),scrollStrategy:n.scrollStrategy||this._scrollStrategy(),panelClass:n.panelClass,hasBackdrop:n.hasBackdrop,direction:n.direction,minWidth:n.minWidth,minHeight:n.minHeight,maxWidth:n.maxWidth,maxHeight:n.maxHeight,width:n.width,height:n.height,disposeOnNavigation:n.closeOnNavigation});return n.backdropClass&&(s.backdropClass=n.backdropClass),s}_attachContainer(n,s,d){const _=d.injector||d.viewContainerRef?.injector,E=[{provide:J1,useValue:d},{provide:WS,useValue:s},{provide:Hx,useValue:n}];let S;d.container?"function"==typeof d.container?S=d.container:(S=d.container.type,E.push(...d.container.providers(d))):S=j2;const R=new NS(S,d.viewContainerRef,Yo.create({parent:_||this._injector,providers:E}),d.componentFactoryResolver);return n.attach(R).instance}_attachDialogContent(n,s,d,_){if(n instanceof Ad){const E=this._createInjector(_,s,d,void 0);let S={$implicit:_.data,dialogRef:s};_.templateContext&&(S={...S,..."function"==typeof _.templateContext?_.templateContext():_.templateContext}),d.attachTemplatePortal(new u2(n,null,S,E))}else{const E=this._createInjector(_,s,d,this._injector),S=d.attachComponentPortal(new NS(n,_.viewContainerRef,E,_.componentFactoryResolver));s.componentRef=S,s.componentInstance=S.instance}}_createInjector(n,s,d,_){const E=n.injector||n.viewContainerRef?.injector,S=[{provide:HV,useValue:n.data},{provide:WS,useValue:s}];return n.providers&&("function"==typeof n.providers?S.push(...n.providers(s,n,d)):S.push(...n.providers)),n.direction&&(!E||!E.get(FS,null,{optional:!0}))&&S.push({provide:FS,useValue:{value:n.direction,change:Dc()}}),Yo.create({parent:E||_,providers:S})}_removeOpenDialog(n,s){const d=this.openDialogs.indexOf(n);d>-1&&(this.openDialogs.splice(d,1),this.openDialogs.length||(this._ariaHiddenElements.forEach((_,E)=>{_?E.setAttribute("aria-hidden",_):E.removeAttribute("aria-hidden")}),this._ariaHiddenElements.clear(),s&&this._getAfterAllClosed().next()))}_hideNonDialogContentFromAssistiveTechnology(){const n=this._overlayContainer.getContainerElement();if(n.parentElement){const s=n.parentElement.children;for(let d=s.length-1;d>-1;d--){const _=s[d];_!==n&&"SCRIPT"!==_.nodeName&&"STYLE"!==_.nodeName&&!_.hasAttribute("aria-live")&&(this._ariaHiddenElements.set(_,_.getAttribute("aria-hidden")),_.setAttribute("aria-hidden","true"))}}}_getAfterAllClosed(){const n=this._parentDialog;return n?n._getAfterAllClosed():this._afterAllClosedAtThisLevel}static{this.\u0275fac=function(s){return new(s||e)(gt(cv),gt(Yo),gt(GV,8),gt(e,12),gt(Y1),gt(U2))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})();function ZS(e,t){let n=e.length;for(;n--;)t(e[n])}let ZV=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({providers:[H2,qV],imports:[x2,X1,jV,X1]})}}return e})();const YV=new Xt("mat-sanity-checks",{providedIn:"root",factory:function XV(){return!0}});let dv=(()=>{class e{constructor(n,s,d){this._sanityChecks=s,this._document=d,this._hasDoneGlobalChecks=!1,n._applyBodyHighContrastModeCssClasses(),this._hasDoneGlobalChecks||(this._hasDoneGlobalChecks=!0)}_checkIsEnabled(n){return!OS()&&("boolean"==typeof this._sanityChecks?this._sanityChecks:!!this._sanityChecks[n])}static{this.\u0275fac=function(s){return new(s||e)(gt(B2),gt(YV,8),gt(Sr))}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({imports:[Ux,Ux]})}}return e})();const q2=W1({passive:!0,capture:!0});class JV{constructor(){this._events=new Map,this._delegateEventHandler=t=>{const n=Bp(t);n&&this._events.get(t.type)?.forEach((s,d)=>{(d===n||d.contains(n))&&s.forEach(_=>_.handleEvent(t))})}}addHandler(t,n,s,d){const _=this._events.get(n);if(_){const E=_.get(s);E?E.add(d):_.set(s,new Set([d]))}else this._events.set(n,new Map([[s,new Set([d])]])),t.runOutsideAngular(()=>{document.addEventListener(n,this._delegateEventHandler,q2)})}removeHandler(t,n,s){const d=this._events.get(t);if(!d)return;const _=d.get(n);_&&(_.delete(s),0===_.size&&d.delete(n),0===d.size&&(this._events.delete(t),document.removeEventListener(t,this._delegateEventHandler,q2)))}}class XS{static{this._eventManager=new JV}constructor(t,n,s,d){this._target=t,this._ngZone=n,this._platform=d,this._isPointerDown=!1,this._activeRipples=new Map,this._pointerUpEventsRegistered=!1,d.isBrowser&&(this._containerElement=sv(s))}fadeInRipple(t,n,s={}){const d=this._containerRect=this._containerRect||this._containerElement.getBoundingClientRect(),_={...W2,...s.animation},E=s.radius||function t5(e,t,n){const s=Math.max(Math.abs(e-n.left),Math.abs(e-n.right)),d=Math.max(Math.abs(t-n.top),Math.abs(t-n.bottom));return Math.sqrt(s*s+d*d)}(t,n,d),S=t-d.left,R=n-d.top,z=_.enterDuration,$=document.createElement("div");$.classList.add("mat-ripple-element"),$.style.left=S-E+"px",$.style.top=R-E+"px",$.style.height=2*E+"px",$.style.width=2*E+"px",null!=s.color&&($.style.backgroundColor=s.color),$.style.transitionDuration=`${z}ms`,this._containerElement.appendChild($);const J=window.getComputedStyle($),ve=J.transitionDuration,Oe="none"===J.transitionProperty||"0s"===ve||"0s, 0s"===ve||0===d.width&&0===d.height,He=new QV(this,$,s,Oe);$.style.transform="scale3d(1, 1, 1)",He.state=0,s.persistent||(this._mostRecentTransientRipple=He);return!Oe&&(z||_.exitDuration)&&this._ngZone.runOutsideAngular(()=>{const Rt=()=>this._finishRippleTransition(He),dt=()=>this._destroyRipple(He);$.addEventListener("transitionend",Rt),$.addEventListener("transitioncancel",dt)}),this._activeRipples.set(He,null),(Oe||!z)&&this._finishRippleTransition(He),He}fadeOutRipple(t){if(2===t.state||3===t.state)return;const n=t.element,s={...W2,...t.config.animation};n.style.transitionDuration=`${s.exitDuration}ms`,n.style.opacity="0",t.state=2,(t._animationForciblyDisabledThroughCss||!s.exitDuration)&&this._finishRippleTransition(t)}fadeOutAll(){this._getActiveRipples().forEach(t=>t.fadeOut())}fadeOutAllNonPersistent(){this._getActiveRipples().forEach(t=>{t.config.persistent||t.fadeOut()})}setupTriggerEvents(t){const n=sv(t);!this._platform.isBrowser||!n||n===this._triggerElement||(this._removeTriggerEvents(),this._triggerElement=n,X2.forEach(s=>{XS._eventManager.addHandler(this._ngZone,s,n,this)}))}handleEvent(t){"mousedown"===t.type?this._onMousedown(t):"touchstart"===t.type?this._onTouchStart(t):this._onPointerUp(),this._pointerUpEventsRegistered||(this._ngZone.runOutsideAngular(()=>{Y2.forEach(n=>{this._triggerElement.addEventListener(n,this,Z2)})}),this._pointerUpEventsRegistered=!0)}_finishRippleTransition(t){0===t.state?this._startFadeOutTransition(t):2===t.state&&this._destroyRipple(t)}_startFadeOutTransition(t){const n=t===this._mostRecentTransientRipple,{persistent:s}=t.config;t.state=1,!s&&(!n||!this._isPointerDown)&&t.fadeOut()}_destroyRipple(t){const n=this._activeRipples.get(t)??null;this._activeRipples.delete(t),this._activeRipples.size||(this._containerRect=null),t===this._mostRecentTransientRipple&&(this._mostRecentTransientRipple=null),t.state=3,null!==n&&(t.element.removeEventListener("transitionend",n.onTransitionEnd),t.element.removeEventListener("transitioncancel",n.onTransitionCancel)),t.element.remove()}_onMousedown(t){const n=F2(t),s=this._lastTouchStartEvent&&Date.now()<this._lastTouchStartEvent+800;!this._target.rippleDisabled&&!n&&!s&&(this._isPointerDown=!0,this.fadeInRipple(t.clientX,t.clientY,this._target.rippleConfig))}_onTouchStart(t){if(!this._target.rippleDisabled&&!k2(t)){this._lastTouchStartEvent=Date.now(),this._isPointerDown=!0;const n=t.changedTouches;if(n)for(let s=0;s<n.length;s++)this.fadeInRipple(n[s].clientX,n[s].clientY,this._target.rippleConfig)}}_onPointerUp(){this._isPointerDown&&(this._isPointerDown=!1,this._getActiveRipples().forEach(t=>{!t.config.persistent&&(1===t.state||t.config.terminateOnPointerUp&&0===t.state)&&t.fadeOut()}))}_getActiveRipples(){return Array.from(this._activeRipples.keys())}_removeTriggerEvents(){const t=this._triggerElement;t&&(X2.forEach(n=>XS._eventManager.removeHandler(n,t,this)),this._pointerUpEventsRegistered&&Y2.forEach(n=>t.removeEventListener(n,this,Z2)))}}let n5=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({imports:[dv,dv]})}}return e})();function r5(e,t){}class eE{constructor(){this.role="dialog",this.panelClass="",this.hasBackdrop=!0,this.backdropClass="",this.disableClose=!1,this.width="",this.height="",this.maxWidth="80vw",this.data=null,this.ariaDescribedBy=null,this.ariaLabelledBy=null,this.ariaLabel=null,this.ariaModal=!0,this.autoFocus="first-tabbable",this.restoreFocus=!0,this.delayFocusTrap=!0,this.closeOnNavigation=!0}}const YS="mdc-dialog--open",K2="mdc-dialog--opening",Q2="mdc-dialog--closing";let a5=(()=>{class e extends j2{constructor(n,s,d,_,E,S,R,z){super(n,s,d,_,E,S,R,z),this._animationStateChanged=new fo}_captureInitialFocus(){this._config.delayFocusTrap||this._trapFocus()}_openAnimationDone(n){this._config.delayFocusTrap&&this._trapFocus(),this._animationStateChanged.next({state:"opened",totalTime:n})}static{this.\u0275fac=function(s){return new(s||e)(Dt(Xo),Dt(GS),Dt(Sr,8),Dt(eE),Dt(K1),Dt(Ti),Dt(Hx),Dt($S))}}static{this.\u0275cmp=Yl({type:e,selectors:[["ng-component"]],features:[zi],decls:0,vars:0,template:function(s,d){},encapsulation:2})}}return e})();const J2="--mat-dialog-transition-duration";function eP(e){return null==e?null:"number"==typeof e?e:e.endsWith("ms")?e2(e.substring(0,e.length-2)):e.endsWith("s")?1e3*e2(e.substring(0,e.length-1)):"0"===e?0:null}let l5=(()=>{class e extends a5{constructor(n,s,d,_,E,S,R,z,$){super(n,s,d,_,E,S,R,$),this._animationMode=z,this._animationsEnabled="NoopAnimations"!==this._animationMode,this._hostElement=this._elementRef.nativeElement,this._enterAnimationDuration=this._animationsEnabled?eP(this._config.enterAnimationDuration)??150:0,this._exitAnimationDuration=this._animationsEnabled?eP(this._config.exitAnimationDuration)??75:0,this._animationTimer=null,this._finishDialogOpen=()=>{this._clearAnimationClasses(),this._openAnimationDone(this._enterAnimationDuration)},this._finishDialogClose=()=>{this._clearAnimationClasses(),this._animationStateChanged.emit({state:"closed",totalTime:this._exitAnimationDuration})}}_contentAttached(){super._contentAttached(),this._startOpenAnimation()}ngOnDestroy(){super.ngOnDestroy(),null!==this._animationTimer&&clearTimeout(this._animationTimer)}_startOpenAnimation(){this._animationStateChanged.emit({state:"opening",totalTime:this._enterAnimationDuration}),this._animationsEnabled?(this._hostElement.style.setProperty(J2,`${this._enterAnimationDuration}ms`),this._requestAnimationFrame(()=>this._hostElement.classList.add(K2,YS)),this._waitForAnimationToComplete(this._enterAnimationDuration,this._finishDialogOpen)):(this._hostElement.classList.add(YS),Promise.resolve().then(()=>this._finishDialogOpen()))}_startExitAnimation(){this._animationStateChanged.emit({state:"closing",totalTime:this._exitAnimationDuration}),this._hostElement.classList.remove(YS),this._animationsEnabled?(this._hostElement.style.setProperty(J2,`${this._exitAnimationDuration}ms`),this._requestAnimationFrame(()=>this._hostElement.classList.add(Q2)),this._waitForAnimationToComplete(this._exitAnimationDuration,this._finishDialogClose)):Promise.resolve().then(()=>this._finishDialogClose())}_clearAnimationClasses(){this._hostElement.classList.remove(K2,Q2)}_waitForAnimationToComplete(n,s){null!==this._animationTimer&&clearTimeout(this._animationTimer),this._animationTimer=setTimeout(s,n)}_requestAnimationFrame(n){this._ngZone.runOutsideAngular(()=>{"function"==typeof requestAnimationFrame?requestAnimationFrame(n):n()})}static{this.\u0275fac=function(s){return new(s||e)(Dt(Xo),Dt(GS),Dt(Sr,8),Dt(eE),Dt(K1),Dt(Ti),Dt(Hx),Dt(eg,8),Dt($S))}}static{this.\u0275cmp=Yl({type:e,selectors:[["mat-dialog-container"]],hostAttrs:["tabindex","-1",1,"mat-mdc-dialog-container","mdc-dialog"],hostVars:8,hostBindings:function(s,d){2&s&&(vn("id",d._config.id),ja("aria-modal",d._config.ariaModal)("role",d._config.role)("aria-labelledby",d._config.ariaLabel?null:d._ariaLabelledByQueue[0])("aria-label",d._config.ariaLabel)("aria-describedby",d._config.ariaDescribedBy||null),Mp("_mat-animation-noopable",!d._animationsEnabled))},features:[zi],decls:3,vars:0,consts:[[1,"mdc-dialog__container"],[1,"mat-mdc-dialog-surface","mdc-dialog__surface"],["cdkPortalOutlet",""]],template:function(s,d){1&s&&(Ua(0,"div",0)(1,"div",1),ax(2,r5,0,0,"ng-template",2),Sl()())},dependencies:[BS],styles:['.mdc-elevation-overlay{position:absolute;border-radius:inherit;pointer-events:none;opacity:var(--mdc-elevation-overlay-opacity, 0);transition:opacity 280ms cubic-bezier(0.4, 0, 0.2, 1)}.mdc-dialog,.mdc-dialog__scrim{position:fixed;top:0;left:0;align-items:center;justify-content:center;box-sizing:border-box;width:100%;height:100%}.mdc-dialog{display:none;z-index:var(--mdc-dialog-z-index, 7)}.mdc-dialog .mdc-dialog__content{padding:20px 24px 20px 24px}.mdc-dialog .mdc-dialog__surface{min-width:280px}@media(max-width: 592px){.mdc-dialog .mdc-dialog__surface{max-width:calc(100vw - 32px)}}@media(min-width: 592px){.mdc-dialog .mdc-dialog__surface{max-width:560px}}.mdc-dialog .mdc-dialog__surface{max-height:calc(100% - 32px)}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{max-width:none}@media(max-width: 960px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{max-height:560px;width:560px}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__close{right:-12px}}@media(max-width: 720px)and (max-width: 672px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{width:calc(100vw - 112px)}}@media(max-width: 720px)and (min-width: 672px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{width:560px}}@media(max-width: 720px)and (max-height: 720px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{max-height:calc(100vh - 160px)}}@media(max-width: 720px)and (min-height: 720px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{max-height:560px}}@media(max-width: 720px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__close{right:-12px}}@media(max-width: 720px)and (max-height: 400px),(max-width: 600px),(min-width: 720px)and (max-height: 400px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{height:100%;max-height:100vh;max-width:100vw;width:100vw;border-radius:0}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__close{order:-1;left:-12px}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__header{padding:0 16px 9px;justify-content:flex-start}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__title{margin-left:calc(16px - 2 * 12px)}}@media(min-width: 960px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{width:calc(100vw - 400px)}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__close{right:-12px}}.mdc-dialog.mdc-dialog__scrim--hidden .mdc-dialog__scrim{opacity:0}.mdc-dialog__scrim{opacity:0;z-index:-1}.mdc-dialog__container{display:flex;flex-direction:row;align-items:center;justify-content:space-around;box-sizing:border-box;height:100%;transform:scale(0.8);opacity:0;pointer-events:none}.mdc-dialog__surface{position:relative;display:flex;flex-direction:column;flex-grow:0;flex-shrink:0;box-sizing:border-box;max-width:100%;max-height:100%;pointer-events:auto;overflow-y:auto;outline:0}.mdc-dialog__surface .mdc-elevation-overlay{width:100%;height:100%;top:0;left:0}[dir=rtl] .mdc-dialog__surface,.mdc-dialog__surface[dir=rtl]{text-align:right}@media screen and (forced-colors: active),(-ms-high-contrast: active){.mdc-dialog__surface{outline:2px solid windowText}}.mdc-dialog__surface::before{position:absolute;box-sizing:border-box;width:100%;height:100%;top:0;left:0;border:2px solid rgba(0,0,0,0);border-radius:inherit;content:"";pointer-events:none}@media screen and (forced-colors: active){.mdc-dialog__surface::before{border-color:CanvasText}}@media screen and (-ms-high-contrast: active),screen and (-ms-high-contrast: none){.mdc-dialog__surface::before{content:none}}.mdc-dialog__title{display:block;margin-top:0;position:relative;flex-shrink:0;box-sizing:border-box;margin:0 0 1px;padding:0 24px 9px}.mdc-dialog__title::before{display:inline-block;width:0;height:40px;content:"";vertical-align:0}[dir=rtl] .mdc-dialog__title,.mdc-dialog__title[dir=rtl]{text-align:right}.mdc-dialog--scrollable .mdc-dialog__title{margin-bottom:1px;padding-bottom:15px}.mdc-dialog--fullscreen .mdc-dialog__header{align-items:baseline;border-bottom:1px solid rgba(0,0,0,0);display:inline-flex;justify-content:space-between;padding:0 24px 9px;z-index:1}@media screen and (forced-colors: active){.mdc-dialog--fullscreen .mdc-dialog__header{border-bottom-color:CanvasText}}.mdc-dialog--fullscreen .mdc-dialog__header .mdc-dialog__close{right:-12px}.mdc-dialog--fullscreen .mdc-dialog__title{margin-bottom:0;padding:0;border-bottom:0}.mdc-dialog--fullscreen.mdc-dialog--scrollable .mdc-dialog__title{border-bottom:0;margin-bottom:0}.mdc-dialog--fullscreen .mdc-dialog__close{top:5px}.mdc-dialog--fullscreen.mdc-dialog--scrollable .mdc-dialog__actions{border-top:1px solid rgba(0,0,0,0)}@media screen and (forced-colors: active){.mdc-dialog--fullscreen.mdc-dialog--scrollable .mdc-dialog__actions{border-top-color:CanvasText}}.mdc-dialog--fullscreen--titleless .mdc-dialog__close{margin-top:4px}.mdc-dialog--fullscreen--titleless.mdc-dialog--scrollable .mdc-dialog__close{margin-top:0}.mdc-dialog__content{flex-grow:1;box-sizing:border-box;margin:0;overflow:auto}.mdc-dialog__content>:first-child{margin-top:0}.mdc-dialog__content>:last-child{margin-bottom:0}.mdc-dialog__title+.mdc-dialog__content,.mdc-dialog__header+.mdc-dialog__content{padding-top:0}.mdc-dialog--scrollable .mdc-dialog__title+.mdc-dialog__content{padding-top:8px;padding-bottom:8px}.mdc-dialog__content .mdc-deprecated-list:first-child:last-child{padding:6px 0 0}.mdc-dialog--scrollable .mdc-dialog__content .mdc-deprecated-list:first-child:last-child{padding:0}.mdc-dialog__actions{display:flex;position:relative;flex-shrink:0;flex-wrap:wrap;align-items:center;justify-content:flex-end;box-sizing:border-box;min-height:52px;margin:0;padding:8px;border-top:1px solid rgba(0,0,0,0)}@media screen and (forced-colors: active){.mdc-dialog__actions{border-top-color:CanvasText}}.mdc-dialog--stacked .mdc-dialog__actions{flex-direction:column;align-items:flex-end}.mdc-dialog__button{margin-left:8px;margin-right:0;max-width:100%;text-align:right}[dir=rtl] .mdc-dialog__button,.mdc-dialog__button[dir=rtl]{margin-left:0;margin-right:8px}.mdc-dialog__button:first-child{margin-left:0;margin-right:0}[dir=rtl] .mdc-dialog__button:first-child,.mdc-dialog__button:first-child[dir=rtl]{margin-left:0;margin-right:0}[dir=rtl] .mdc-dialog__button,.mdc-dialog__button[dir=rtl]{text-align:left}.mdc-dialog--stacked .mdc-dialog__button:not(:first-child){margin-top:12px}.mdc-dialog--open,.mdc-dialog--opening,.mdc-dialog--closing{display:flex}.mdc-dialog--opening .mdc-dialog__scrim{transition:opacity 150ms linear}.mdc-dialog--opening .mdc-dialog__container{transition:opacity 75ms linear,transform 150ms 0ms cubic-bezier(0, 0, 0.2, 1)}.mdc-dialog--closing .mdc-dialog__scrim,.mdc-dialog--closing .mdc-dialog__container{transition:opacity 75ms linear}.mdc-dialog--closing .mdc-dialog__container{transform:none}.mdc-dialog--open .mdc-dialog__scrim{opacity:1}.mdc-dialog--open .mdc-dialog__container{transform:none;opacity:1}.mdc-dialog--open.mdc-dialog__surface-scrim--shown .mdc-dialog__surface-scrim{opacity:1}.mdc-dialog--open.mdc-dialog__surface-scrim--hiding .mdc-dialog__surface-scrim{transition:opacity 75ms linear}.mdc-dialog--open.mdc-dialog__surface-scrim--showing .mdc-dialog__surface-scrim{transition:opacity 150ms linear}.mdc-dialog__surface-scrim{display:none;opacity:0;position:absolute;width:100%;height:100%;z-index:1}.mdc-dialog__surface-scrim--shown .mdc-dialog__surface-scrim,.mdc-dialog__surface-scrim--showing .mdc-dialog__surface-scrim,.mdc-dialog__surface-scrim--hiding .mdc-dialog__surface-scrim{display:block}.mdc-dialog-scroll-lock{overflow:hidden}.mdc-dialog--no-content-padding .mdc-dialog__content{padding:0}.mdc-dialog--sheet .mdc-dialog__container .mdc-dialog__close{right:12px;top:9px;position:absolute;z-index:1}.mdc-dialog__scrim--removed{pointer-events:none}.mdc-dialog__scrim--removed .mdc-dialog__scrim,.mdc-dialog__scrim--removed .mdc-dialog__surface-scrim{display:none}.mat-mdc-dialog-content{max-height:65vh}.mat-mdc-dialog-container{position:static;display:block}.mat-mdc-dialog-container,.mat-mdc-dialog-container .mdc-dialog__container,.mat-mdc-dialog-container .mdc-dialog__surface{max-height:inherit;min-height:inherit;min-width:inherit;max-width:inherit}.mat-mdc-dialog-container .mdc-dialog__surface{display:block;width:100%;height:100%}.mat-mdc-dialog-container{--mdc-dialog-container-elevation-shadow:0px 11px 15px -7px rgba(0, 0, 0, 0.2), 0px 24px 38px 3px rgba(0, 0, 0, 0.14), 0px 9px 46px 8px rgba(0, 0, 0, 0.12);--mdc-dialog-container-shadow-color:#000;--mdc-dialog-container-shape:4px;--mdc-dialog-container-elevation: var(--mdc-dialog-container-elevation-shadow);outline:0}.mat-mdc-dialog-container .mdc-dialog__surface{background-color:var(--mdc-dialog-container-color, white)}.mat-mdc-dialog-container .mdc-dialog__surface{box-shadow:var(--mdc-dialog-container-elevation, 0px 11px 15px -7px rgba(0, 0, 0, 0.2), 0px 24px 38px 3px rgba(0, 0, 0, 0.14), 0px 9px 46px 8px rgba(0, 0, 0, 0.12))}.mat-mdc-dialog-container .mdc-dialog__surface{border-radius:var(--mdc-dialog-container-shape, 4px)}.mat-mdc-dialog-container .mdc-dialog__title{font-family:var(--mdc-dialog-subhead-font, Roboto, sans-serif);line-height:var(--mdc-dialog-subhead-line-height, 1.5rem);font-size:var(--mdc-dialog-subhead-size, 1rem);font-weight:var(--mdc-dialog-subhead-weight, 400);letter-spacing:var(--mdc-dialog-subhead-tracking, 0.03125em)}.mat-mdc-dialog-container .mdc-dialog__title{color:var(--mdc-dialog-subhead-color, rgba(0, 0, 0, 0.87))}.mat-mdc-dialog-container .mdc-dialog__content{font-family:var(--mdc-dialog-supporting-text-font, Roboto, sans-serif);line-height:var(--mdc-dialog-supporting-text-line-height, 1.5rem);font-size:var(--mdc-dialog-supporting-text-size, 1rem);font-weight:var(--mdc-dialog-supporting-text-weight, 400);letter-spacing:var(--mdc-dialog-supporting-text-tracking, 0.03125em)}.mat-mdc-dialog-container .mdc-dialog__content{color:var(--mdc-dialog-supporting-text-color, rgba(0, 0, 0, 0.6))}.mat-mdc-dialog-container .mdc-dialog__container{transition-duration:var(--mat-dialog-transition-duration, 0ms)}.mat-mdc-dialog-container._mat-animation-noopable .mdc-dialog__container{transition:none}.mat-mdc-dialog-content{display:block}.mat-mdc-dialog-actions{justify-content:start}.mat-mdc-dialog-actions.mat-mdc-dialog-actions-align-center,.mat-mdc-dialog-actions[align=center]{justify-content:center}.mat-mdc-dialog-actions.mat-mdc-dialog-actions-align-end,.mat-mdc-dialog-actions[align=end]{justify-content:flex-end}.mat-mdc-dialog-actions .mat-button-base+.mat-button-base,.mat-mdc-dialog-actions .mat-mdc-button-base+.mat-mdc-button-base{margin-left:8px}[dir=rtl] .mat-mdc-dialog-actions .mat-button-base+.mat-button-base,[dir=rtl] .mat-mdc-dialog-actions .mat-mdc-button-base+.mat-mdc-button-base{margin-left:0;margin-right:8px}'],encapsulation:2})}}return e})();class c5{constructor(t,n,s){this._ref=t,this._containerInstance=s,this._afterOpened=new Gi,this._beforeClosed=new Gi,this._state=0,this.disableClose=n.disableClose,this.id=t.id,s._animationStateChanged.pipe(zp(d=>"opened"===d.state),lv(1)).subscribe(()=>{this._afterOpened.next(),this._afterOpened.complete()}),s._animationStateChanged.pipe(zp(d=>"closed"===d.state),lv(1)).subscribe(()=>{clearTimeout(this._closeFallbackTimeout),this._finishDialogClose()}),t.overlayRef.detachments().subscribe(()=>{this._beforeClosed.next(this._result),this._beforeClosed.complete(),this._finishDialogClose()}),tl(this.backdropClick(),this.keydownEvents().pipe(zp(d=>27===d.keyCode&&!this.disableClose&&!jS(d)))).subscribe(d=>{this.disableClose||(d.preventDefault(),function u5(e,t,n){e._closeInteractionType=t,e.close(n)}(this,"keydown"===d.type?"keyboard":"mouse"))})}close(t){this._result=t,this._containerInstance._animationStateChanged.pipe(zp(n=>"closing"===n.state),lv(1)).subscribe(n=>{this._beforeClosed.next(t),this._beforeClosed.complete(),this._ref.overlayRef.detachBackdrop(),this._closeFallbackTimeout=setTimeout(()=>this._finishDialogClose(),n.totalTime+100)}),this._state=1,this._containerInstance._startExitAnimation()}afterOpened(){return this._afterOpened}afterClosed(){return this._ref.closed}beforeClosed(){return this._beforeClosed}backdropClick(){return this._ref.backdropClick}keydownEvents(){return this._ref.keydownEvents}updatePosition(t){let n=this._ref.config.positionStrategy;return t&&(t.left||t.right)?t.left?n.left(t.left):n.right(t.right):n.centerHorizontally(),t&&(t.top||t.bottom)?t.top?n.top(t.top):n.bottom(t.bottom):n.centerVertically(),this._ref.updatePosition(),this}updateSize(t="",n=""){return this._ref.updateSize(t,n),this}addPanelClass(t){return this._ref.addPanelClass(t),this}removePanelClass(t){return this._ref.removePanelClass(t),this}getState(){return this._state}_finishDialogClose(){this._state=2,this._ref.close(this._result,{focusOrigin:this._closeInteractionType}),this.componentInstance=null}}const d5=new Xt("MatMdcDialogData"),h5=new Xt("mat-mdc-dialog-default-options"),tP=new Xt("mat-mdc-dialog-scroll-strategy"),p5={provide:tP,deps:[cv],useFactory:function f5(e){return()=>e.scrollStrategies.block()}};let m5=0,g5=(()=>{class e{get openDialogs(){return this._parentDialog?this._parentDialog.openDialogs:this._openDialogsAtThisLevel}get afterOpened(){return this._parentDialog?this._parentDialog.afterOpened:this._afterOpenedAtThisLevel}_getAfterAllClosed(){const n=this._parentDialog;return n?n._getAfterAllClosed():this._afterAllClosedAtThisLevel}constructor(n,s,d,_,E,S,R,z,$,J){this._overlay=n,this._defaultOptions=d,this._parentDialog=_,this._dialogRefConstructor=R,this._dialogContainerType=z,this._dialogDataToken=$,this._openDialogsAtThisLevel=[],this._afterAllClosedAtThisLevel=new Gi,this._afterOpenedAtThisLevel=new Gi,this._idPrefix="mat-dialog-",this.dialogConfigClass=eE,this.afterAllClosed=V2(()=>this.openDialogs.length?this._getAfterAllClosed():this._getAfterAllClosed().pipe(HS(void 0))),this._scrollStrategy=S,this._dialog=s.get(H2)}open(n,s){let d;(s={...this._defaultOptions||new eE,...s}).id=s.id||`${this._idPrefix}${m5++}`,s.scrollStrategy=s.scrollStrategy||this._scrollStrategy();const _=this._dialog.open(n,{...s,positionStrategy:this._overlay.position().global().centerHorizontally().centerVertically(),disableClose:!0,closeOnDestroy:!1,closeOnOverlayDetachments:!1,container:{type:this._dialogContainerType,providers:()=>[{provide:this.dialogConfigClass,useValue:s},{provide:J1,useValue:s}]},templateContext:()=>({dialogRef:d}),providers:(E,S,R)=>(d=new this._dialogRefConstructor(E,s,R),d.updatePosition(s?.position),[{provide:this._dialogContainerType,useValue:R},{provide:this._dialogDataToken,useValue:S.data},{provide:this._dialogRefConstructor,useValue:d}])});return d.componentRef=_.componentRef,d.componentInstance=_.componentInstance,this.openDialogs.push(d),this.afterOpened.next(d),d.afterClosed().subscribe(()=>{const E=this.openDialogs.indexOf(d);E>-1&&(this.openDialogs.splice(E,1),this.openDialogs.length||this._getAfterAllClosed().next())}),d}closeAll(){this._closeDialogs(this.openDialogs)}getDialogById(n){return this.openDialogs.find(s=>s.id===n)}ngOnDestroy(){this._closeDialogs(this._openDialogsAtThisLevel),this._afterAllClosedAtThisLevel.complete(),this._afterOpenedAtThisLevel.complete()}_closeDialogs(n){let s=n.length;for(;s--;)n[s].close()}static{this.\u0275fac=function(s){!function M0(){throw new Error("invalid")}()}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})(),_5=(()=>{class e extends g5{constructor(n,s,d,_,E,S,R,z){super(n,s,_,S,R,E,c5,l5,d5,z),this._idPrefix="mat-mdc-dialog-"}static{this.\u0275fac=function(s){return new(s||e)(gt(cv),gt(Yo),gt(ID,8),gt(h5,8),gt(tP),gt(e,12),gt(Y1),gt(eg,8))}}static{this.\u0275prov=Jt({token:e,factory:e.\u0275fac})}}return e})(),y5=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({providers:[_5,p5],imports:[ZV,x2,X1,dv,dv]})}}return e})(),b5=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({imports:[dv,n5,dv]})}}return e})();function iP(e,t,n,s,d,_,E){try{var S=e[_](E),R=S.value}catch(z){return void n(z)}S.done?t(R):Promise.resolve(R).then(s,d)}function rP(e){return function(){var t=this,n=arguments;return new Promise(function(s,d){var _=e.apply(t,n);function E(R){iP(_,s,d,E,S,"next",R)}function S(R){iP(_,s,d,E,S,"throw",R)}E(void 0)})}}var $x=uf(247);let oP=(()=>{class e{constructor(n,s){this._renderer=n,this._elementRef=s,this.onChange=d=>{},this.onTouched=()=>{}}setProperty(n,s){this._renderer.setProperty(this._elementRef.nativeElement,n,s)}registerOnTouched(n){this.onTouched=n}registerOnChange(n){this.onChange=n}setDisabledState(n){this.setProperty("disabled",n)}static{this.\u0275fac=function(s){return new(s||e)(Dt(Hh),Dt(Xo))}}static{this.\u0275dir=Dn({type:e})}}return e})(),$g=(()=>{class e extends oP{static{this.\u0275fac=function(){let n;return function(d){return(n||(n=Zi(e)))(d||e)}}()}static{this.\u0275dir=Dn({type:e,features:[zi]})}}return e})();const Od=new Xt("NgValueAccessor"),T5={provide:Od,useExisting:Yi(()=>tE),multi:!0},S5=new Xt("CompositionEventMode");let tE=(()=>{class e extends oP{constructor(n,s,d){super(n,s),this._compositionMode=d,this._composing=!1,null==this._compositionMode&&(this._compositionMode=!function D5(){const e=Fp()?Fp().getUserAgent():"";return/android (\d+)/.test(e.toLowerCase())}())}writeValue(n){this.setProperty("value",n??"")}_handleInput(n){(!this._compositionMode||this._compositionMode&&!this._composing)&&this.onChange(n)}_compositionStart(){this._composing=!0}_compositionEnd(n){this._composing=!1,this._compositionMode&&this.onChange(n)}static{this.\u0275fac=function(s){return new(s||e)(Dt(Hh),Dt(Xo),Dt(S5,8))}}static{this.\u0275dir=Dn({type:e,selectors:[["input","formControlName","",3,"type","checkbox"],["textarea","formControlName",""],["input","formControl","",3,"type","checkbox"],["textarea","formControl",""],["input","ngModel","",3,"type","checkbox"],["textarea","ngModel",""],["","ngDefaultControl",""]],hostBindings:function(s,d){1&s&&Rs("input",function(E){return d._handleInput(E.target.value)})("blur",function(){return d.onTouched()})("compositionstart",function(){return d._compositionStart()})("compositionend",function(E){return d._compositionEnd(E.target.value)})},features:[io([T5]),zi]})}}return e})();const la=new Xt("NgValidators"),jp=new Xt("NgAsyncValidators");function gP(e){return null!=e}function _P(e){return Ig(e)?el(e):e}function yP(e){let t={};return e.forEach(n=>{t=null!=n?{...t,...n}:t}),0===Object.keys(t).length?null:t}function vP(e,t){return t.map(n=>n(e))}function xP(e){return e.map(t=>function I5(e){return!e.validate}(t)?t:n=>t.validate(n))}function KS(e){return null!=e?function bP(e){if(!e)return null;const t=e.filter(gP);return 0==t.length?null:function(n){return yP(vP(n,t))}}(xP(e)):null}function QS(e){return null!=e?function wP(e){if(!e)return null;const t=e.filter(gP);return 0==t.length?null:function(n){return function w5(...e){const t=Vi(e),{args:n,keys:s}=T2(e),d=new Hi(_=>{const{length:E}=n;if(!E)return void _.complete();const S=new Array(E);let R=E,z=E;for(let $=0;$<E;$++){let J=!1;Ie(n[$]).subscribe(nr(_,we=>{J||(J=!0,z--),S[$]=we},()=>R--,void 0,()=>{(!R||!J)&&(z||_.next(s?D2(s,S):S),_.complete())}))}});return t?d.pipe(TS(t)):d}(vP(n,t).map(_P)).pipe(Ls(yP))}}(xP(e)):null}function EP(e,t){return null===e?[t]:Array.isArray(e)?[...e,t]:[e,t]}function JS(e){return e?Array.isArray(e)?e:[e]:[]}function iE(e,t){return Array.isArray(e)?e.includes(t):e===t}function SP(e,t){const n=JS(t);return JS(e).forEach(d=>{iE(n,d)||n.push(d)}),n}function CP(e,t){return JS(t).filter(n=>!iE(e,n))}class IP{constructor(){this._rawValidators=[],this._rawAsyncValidators=[],this._onDestroyCallbacks=[]}get value(){return this.control?this.control.value:null}get valid(){return this.control?this.control.valid:null}get invalid(){return this.control?this.control.invalid:null}get pending(){return this.control?this.control.pending:null}get disabled(){return this.control?this.control.disabled:null}get enabled(){return this.control?this.control.enabled:null}get errors(){return this.control?this.control.errors:null}get pristine(){return this.control?this.control.pristine:null}get dirty(){return this.control?this.control.dirty:null}get touched(){return this.control?this.control.touched:null}get status(){return this.control?this.control.status:null}get untouched(){return this.control?this.control.untouched:null}get statusChanges(){return this.control?this.control.statusChanges:null}get valueChanges(){return this.control?this.control.valueChanges:null}get path(){return null}_setValidators(t){this._rawValidators=t||[],this._composedValidatorFn=KS(this._rawValidators)}_setAsyncValidators(t){this._rawAsyncValidators=t||[],this._composedAsyncValidatorFn=QS(this._rawAsyncValidators)}get validator(){return this._composedValidatorFn||null}get asyncValidator(){return this._composedAsyncValidatorFn||null}_registerOnDestroy(t){this._onDestroyCallbacks.push(t)}_invokeOnDestroyCallbacks(){this._onDestroyCallbacks.forEach(t=>t()),this._onDestroyCallbacks=[]}reset(t=void 0){this.control&&this.control.reset(t)}hasError(t,n){return!!this.control&&this.control.hasError(t,n)}getError(t,n){return this.control?this.control.getError(t,n):null}}class Sa extends IP{get formDirective(){return null}get path(){return null}}class Up extends IP{constructor(){super(...arguments),this._parent=null,this.name=null,this.valueAccessor=null}}class AP{constructor(t){this._cd=t}get isTouched(){return!!this._cd?.control?.touched}get isUntouched(){return!!this._cd?.control?.untouched}get isPristine(){return!!this._cd?.control?.pristine}get isDirty(){return!!this._cd?.control?.dirty}get isValid(){return!!this._cd?.control?.valid}get isInvalid(){return!!this._cd?.control?.invalid}get isPending(){return!!this._cd?.control?.pending}get isSubmitted(){return!!this._cd?.submitted}}let MP=(()=>{class e extends AP{constructor(n){super(n)}static{this.\u0275fac=function(s){return new(s||e)(Dt(Up,2))}}static{this.\u0275dir=Dn({type:e,selectors:[["","formControlName",""],["","ngModel",""],["","formControl",""]],hostVars:14,hostBindings:function(s,d){2&s&&Mp("ng-untouched",d.isUntouched)("ng-touched",d.isTouched)("ng-pristine",d.isPristine)("ng-dirty",d.isDirty)("ng-valid",d.isValid)("ng-invalid",d.isInvalid)("ng-pending",d.isPending)},features:[zi]})}}return e})();const qx="VALID",oE="INVALID",hv="PENDING",Wx="DISABLED";function sE(e){return null!=e&&!Array.isArray(e)&&"object"==typeof e}class rC{constructor(t,n){this._pendingDirty=!1,this._hasOwnPendingAsyncValidator=!1,this._pendingTouched=!1,this._onCollectionChange=()=>{},this._parent=null,this.pristine=!0,this.touched=!1,this._onDisabledChange=[],this._assignValidators(t),this._assignAsyncValidators(n)}get validator(){return this._composedValidatorFn}set validator(t){this._rawValidators=this._composedValidatorFn=t}get asyncValidator(){return this._composedAsyncValidatorFn}set asyncValidator(t){this._rawAsyncValidators=this._composedAsyncValidatorFn=t}get parent(){return this._parent}get valid(){return this.status===qx}get invalid(){return this.status===oE}get pending(){return this.status==hv}get disabled(){return this.status===Wx}get enabled(){return this.status!==Wx}get dirty(){return!this.pristine}get untouched(){return!this.touched}get updateOn(){return this._updateOn?this._updateOn:this.parent?this.parent.updateOn:"change"}setValidators(t){this._assignValidators(t)}setAsyncValidators(t){this._assignAsyncValidators(t)}addValidators(t){this.setValidators(SP(t,this._rawValidators))}addAsyncValidators(t){this.setAsyncValidators(SP(t,this._rawAsyncValidators))}removeValidators(t){this.setValidators(CP(t,this._rawValidators))}removeAsyncValidators(t){this.setAsyncValidators(CP(t,this._rawAsyncValidators))}hasValidator(t){return iE(this._rawValidators,t)}hasAsyncValidator(t){return iE(this._rawAsyncValidators,t)}clearValidators(){this.validator=null}clearAsyncValidators(){this.asyncValidator=null}markAsTouched(t={}){this.touched=!0,this._parent&&!t.onlySelf&&this._parent.markAsTouched(t)}markAllAsTouched(){this.markAsTouched({onlySelf:!0}),this._forEachChild(t=>t.markAllAsTouched())}markAsUntouched(t={}){this.touched=!1,this._pendingTouched=!1,this._forEachChild(n=>{n.markAsUntouched({onlySelf:!0})}),this._parent&&!t.onlySelf&&this._parent._updateTouched(t)}markAsDirty(t={}){this.pristine=!1,this._parent&&!t.onlySelf&&this._parent.markAsDirty(t)}markAsPristine(t={}){this.pristine=!0,this._pendingDirty=!1,this._forEachChild(n=>{n.markAsPristine({onlySelf:!0})}),this._parent&&!t.onlySelf&&this._parent._updatePristine(t)}markAsPending(t={}){this.status=hv,!1!==t.emitEvent&&this.statusChanges.emit(this.status),this._parent&&!t.onlySelf&&this._parent.markAsPending(t)}disable(t={}){const n=this._parentMarkedDirty(t.onlySelf);this.status=Wx,this.errors=null,this._forEachChild(s=>{s.disable({...t,onlySelf:!0})}),this._updateValue(),!1!==t.emitEvent&&(this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._updateAncestors({...t,skipPristineCheck:n}),this._onDisabledChange.forEach(s=>s(!0))}enable(t={}){const n=this._parentMarkedDirty(t.onlySelf);this.status=qx,this._forEachChild(s=>{s.enable({...t,onlySelf:!0})}),this.updateValueAndValidity({onlySelf:!0,emitEvent:t.emitEvent}),this._updateAncestors({...t,skipPristineCheck:n}),this._onDisabledChange.forEach(s=>s(!1))}_updateAncestors(t){this._parent&&!t.onlySelf&&(this._parent.updateValueAndValidity(t),t.skipPristineCheck||this._parent._updatePristine(),this._parent._updateTouched())}setParent(t){this._parent=t}getRawValue(){return this.value}updateValueAndValidity(t={}){this._setInitialStatus(),this._updateValue(),this.enabled&&(this._cancelExistingSubscription(),this.errors=this._runValidator(),this.status=this._calculateStatus(),(this.status===qx||this.status===hv)&&this._runAsyncValidator(t.emitEvent)),!1!==t.emitEvent&&(this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._parent&&!t.onlySelf&&this._parent.updateValueAndValidity(t)}_updateTreeValidity(t={emitEvent:!0}){this._forEachChild(n=>n._updateTreeValidity(t)),this.updateValueAndValidity({onlySelf:!0,emitEvent:t.emitEvent})}_setInitialStatus(){this.status=this._allControlsDisabled()?Wx:qx}_runValidator(){return this.validator?this.validator(this):null}_runAsyncValidator(t){if(this.asyncValidator){this.status=hv,this._hasOwnPendingAsyncValidator=!0;const n=_P(this.asyncValidator(this));this._asyncValidationSubscription=n.subscribe(s=>{this._hasOwnPendingAsyncValidator=!1,this.setErrors(s,{emitEvent:t})})}}_cancelExistingSubscription(){this._asyncValidationSubscription&&(this._asyncValidationSubscription.unsubscribe(),this._hasOwnPendingAsyncValidator=!1)}setErrors(t,n={}){this.errors=t,this._updateControlsErrors(!1!==n.emitEvent)}get(t){let n=t;return null==n||(Array.isArray(n)||(n=n.split(".")),0===n.length)?null:n.reduce((s,d)=>s&&s._find(d),this)}getError(t,n){const s=n?this.get(n):this;return s&&s.errors?s.errors[t]:null}hasError(t,n){return!!this.getError(t,n)}get root(){let t=this;for(;t._parent;)t=t._parent;return t}_updateControlsErrors(t){this.status=this._calculateStatus(),t&&this.statusChanges.emit(this.status),this._parent&&this._parent._updateControlsErrors(t)}_initObservables(){this.valueChanges=new fo,this.statusChanges=new fo}_calculateStatus(){return this._allControlsDisabled()?Wx:this.errors?oE:this._hasOwnPendingAsyncValidator||this._anyControlsHaveStatus(hv)?hv:this._anyControlsHaveStatus(oE)?oE:qx}_anyControlsHaveStatus(t){return this._anyControls(n=>n.status===t)}_anyControlsDirty(){return this._anyControls(t=>t.dirty)}_anyControlsTouched(){return this._anyControls(t=>t.touched)}_updatePristine(t={}){this.pristine=!this._anyControlsDirty(),this._parent&&!t.onlySelf&&this._parent._updatePristine(t)}_updateTouched(t={}){this.touched=this._anyControlsTouched(),this._parent&&!t.onlySelf&&this._parent._updateTouched(t)}_registerOnCollectionChange(t){this._onCollectionChange=t}_setUpdateStrategy(t){sE(t)&&null!=t.updateOn&&(this._updateOn=t.updateOn)}_parentMarkedDirty(t){return!t&&!(!this._parent||!this._parent.dirty)&&!this._parent._anyControlsDirty()}_find(t){return null}_assignValidators(t){this._rawValidators=Array.isArray(t)?t.slice():t,this._composedValidatorFn=function O5(e){return Array.isArray(e)?KS(e):e||null}(this._rawValidators)}_assignAsyncValidators(t){this._rawAsyncValidators=Array.isArray(t)?t.slice():t,this._composedAsyncValidatorFn=function F5(e){return Array.isArray(e)?QS(e):e||null}(this._rawAsyncValidators)}}const fv=new Xt("CallSetDisabledState",{providedIn:"root",factory:()=>aE}),aE="always";function Zx(e,t,n=aE){(function sC(e,t){const n=function TP(e){return e._rawValidators}(e);null!==t.validator?e.setValidators(EP(n,t.validator)):"function"==typeof n&&e.setValidators([n]);const s=function DP(e){return e._rawAsyncValidators}(e);null!==t.asyncValidator?e.setAsyncValidators(EP(s,t.asyncValidator)):"function"==typeof s&&e.setAsyncValidators([s]);const d=()=>e.updateValueAndValidity();uE(t._rawValidators,d),uE(t._rawAsyncValidators,d)})(e,t),t.valueAccessor.writeValue(e.value),(e.disabled||"always"===n)&&t.valueAccessor.setDisabledState?.(e.disabled),function N5(e,t){t.valueAccessor.registerOnChange(n=>{e._pendingValue=n,e._pendingChange=!0,e._pendingDirty=!0,"change"===e.updateOn&&FP(e,t)})}(e,t),function B5(e,t){const n=(s,d)=>{t.valueAccessor.writeValue(s),d&&t.viewToModelUpdate(s)};e.registerOnChange(n),t._registerOnDestroy(()=>{e._unregisterOnChange(n)})}(e,t),function z5(e,t){t.valueAccessor.registerOnTouched(()=>{e._pendingTouched=!0,"blur"===e.updateOn&&e._pendingChange&&FP(e,t),"submit"!==e.updateOn&&e.markAsTouched()})}(e,t),function L5(e,t){if(t.valueAccessor.setDisabledState){const n=s=>{t.valueAccessor.setDisabledState(s)};e.registerOnDisabledChange(n),t._registerOnDestroy(()=>{e._unregisterOnDisabledChange(n)})}}(e,t)}function uE(e,t){e.forEach(n=>{n.registerOnValidatorChange&&n.registerOnValidatorChange(t)})}function FP(e,t){e._pendingDirty&&e.markAsDirty(),e.setValue(e._pendingValue,{emitModelToViewChange:!1}),t.viewToModelUpdate(e._pendingValue),e._pendingChange=!1}function NP(e,t){const n=e.indexOf(t);n>-1&&e.splice(n,1)}function zP(e){return"object"==typeof e&&null!==e&&2===Object.keys(e).length&&"value"in e&&"disabled"in e}const BP=class extends rC{constructor(t=null,n,s){super(function nC(e){return(sE(e)?e.validators:e)||null}(n),function iC(e,t){return(sE(t)?t.asyncValidators:e)||null}(s,n)),this.defaultValue=null,this._onChange=[],this._pendingChange=!1,this._applyFormState(t),this._setUpdateStrategy(n),this._initObservables(),this.updateValueAndValidity({onlySelf:!0,emitEvent:!!this.asyncValidator}),sE(n)&&(n.nonNullable||n.initialValueIsDefault)&&(this.defaultValue=zP(t)?t.value:t)}setValue(t,n={}){this.value=this._pendingValue=t,this._onChange.length&&!1!==n.emitModelToViewChange&&this._onChange.forEach(s=>s(this.value,!1!==n.emitViewToModelChange)),this.updateValueAndValidity(n)}patchValue(t,n={}){this.setValue(t,n)}reset(t=this.defaultValue,n={}){this._applyFormState(t),this.markAsPristine(n),this.markAsUntouched(n),this.setValue(this.value,n),this._pendingChange=!1}_updateValue(){}_anyControls(t){return!1}_allControlsDisabled(){return this.disabled}registerOnChange(t){this._onChange.push(t)}_unregisterOnChange(t){NP(this._onChange,t)}registerOnDisabledChange(t){this._onDisabledChange.push(t)}_unregisterOnDisabledChange(t){NP(this._onDisabledChange,t)}_forEachChild(t){}_syncPendingControls(){return!("submit"!==this.updateOn||(this._pendingDirty&&this.markAsDirty(),this._pendingTouched&&this.markAsTouched(),!this._pendingChange)||(this.setValue(this._pendingValue,{onlySelf:!0,emitModelToViewChange:!1}),0))}_applyFormState(t){zP(t)?(this.value=this._pendingValue=t.value,t.disabled?this.disable({onlySelf:!0,emitEvent:!1}):this.enable({onlySelf:!0,emitEvent:!1})):this.value=this._pendingValue=t}},W5={provide:Up,useExisting:Yi(()=>dC)},UP=(()=>Promise.resolve())();let dC=(()=>{class e extends Up{constructor(n,s,d,_,E,S){super(),this._changeDetectorRef=E,this.callSetDisabledState=S,this.control=new BP,this._registered=!1,this.name="",this.update=new fo,this._parent=n,this._setValidators(s),this._setAsyncValidators(d),this.valueAccessor=function cC(e,t){if(!t)return null;let n,s,d;return Array.isArray(t),t.forEach(_=>{_.constructor===tE?n=_:function U5(e){return Object.getPrototypeOf(e.constructor)===$g}(_)?s=_:d=_}),d||s||n||null}(0,_)}ngOnChanges(n){if(this._checkForErrors(),!this._registered||"name"in n){if(this._registered&&(this._checkName(),this.formDirective)){const s=n.name.previousValue;this.formDirective.removeControl({name:s,path:this._getPath(s)})}this._setUpControl()}"isDisabled"in n&&this._updateDisabled(n),function lC(e,t){if(!e.hasOwnProperty("model"))return!1;const n=e.model;return!!n.isFirstChange()||!Object.is(t,n.currentValue)}(n,this.viewModel)&&(this._updateValue(this.model),this.viewModel=this.model)}ngOnDestroy(){this.formDirective&&this.formDirective.removeControl(this)}get path(){return this._getPath(this.name)}get formDirective(){return this._parent?this._parent.formDirective:null}viewToModelUpdate(n){this.viewModel=n,this.update.emit(n)}_setUpControl(){this._setUpdateStrategy(),this._isStandalone()?this._setUpStandalone():this.formDirective.addControl(this),this._registered=!0}_setUpdateStrategy(){this.options&&null!=this.options.updateOn&&(this.control._updateOn=this.options.updateOn)}_isStandalone(){return!this._parent||!(!this.options||!this.options.standalone)}_setUpStandalone(){Zx(this.control,this,this.callSetDisabledState),this.control.updateValueAndValidity({emitEvent:!1})}_checkForErrors(){this._isStandalone()||this._checkParentType(),this._checkName()}_checkParentType(){}_checkName(){this.options&&this.options.name&&(this.name=this.options.name),this._isStandalone()}_updateValue(n){UP.then(()=>{this.control.setValue(n,{emitViewToModelChange:!1}),this._changeDetectorRef?.markForCheck()})}_updateDisabled(n){const s=n.isDisabled.currentValue,d=0!==s&&function DD(e){return"boolean"==typeof e?e:null!=e&&"false"!==e}(s);UP.then(()=>{d&&!this.control.disabled?this.control.disable():!d&&this.control.disabled&&this.control.enable(),this._changeDetectorRef?.markForCheck()})}_getPath(n){return this._parent?function lE(e,t){return[...t.path,e]}(n,this._parent):[n]}static{this.\u0275fac=function(s){return new(s||e)(Dt(Sa,9),Dt(la,10),Dt(jp,10),Dt(Od,10),Dt(lA,8),Dt(fv,8))}}static{this.\u0275dir=Dn({type:e,selectors:[["","ngModel","",3,"formControlName","",3,"formControl",""]],inputs:{name:"name",isDisabled:["disabled","isDisabled"],model:["ngModel","model"],options:["ngModelOptions","options"]},outputs:{update:"ngModelChange"},exportAs:["ngModel"],features:[io([W5]),zi,ta]})}}return e})(),GP=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({})}}return e})();const Q5={provide:Od,useExisting:Yi(()=>hC),multi:!0};let hC=(()=>{class e extends $g{writeValue(n){this.setProperty("value",parseFloat(n))}registerOnChange(n){this.onChange=s=>{n(""==s?null:parseFloat(s))}}static{this.\u0275fac=function(){let n;return function(d){return(n||(n=Zi(e)))(d||e)}}()}static{this.\u0275dir=Dn({type:e,selectors:[["input","type","range","formControlName",""],["input","type","range","formControl",""],["input","type","range","ngModel",""]],hostBindings:function(s,d){1&s&&Rs("change",function(E){return d.onChange(E.target.value)})("input",function(E){return d.onChange(E.target.value)})("blur",function(){return d.onTouched()})},features:[io([Q5]),zi]})}}return e})(),y4=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({imports:[GP]})}}return e})(),x4=(()=>{class e{static withConfig(n){return{ngModule:e,providers:[{provide:fv,useValue:n.callSetDisabledState??aE}]}}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e})}static{this.\u0275inj=Ir({imports:[y4]})}}return e})(),b4=(()=>{class e{constructor(n){this.ngZone=n,this.churches=[{name:"St. Patrick\u2019s Cathedral",description:"Famous church in New York",coordinates:[-73.975,40.758],personName:"Father John Doe",personPhoto:"assets/person.jpg"},{name:"Westminster Abbey",description:"Historic church in London",coordinates:[-.1273,51.4993],personName:"Bishop Richard Roe",personPhoto:"assets/person1.jpg"},{name:"St. Mary\u2019s Cathedral",description:"Famous church in Tokyo",coordinates:[139.715,35.693],personName:"Archbishop Kenji Tanaka",personPhoto:"assets/person.jpg"},{name:"Notre Dame Cathedral",description:"Iconic Gothic cathedral in Paris",coordinates:[2.3499,48.853],personName:"Father Pierre Dubois",personPhoto:"assets/person1.jpg"},{name:"St. Peter\u2019s Basilica",description:"Major basilica in Vatican City",coordinates:[12.4534,41.9029],personName:"Pope Francis",personPhoto:"assets/person.jpg"}],this.rotationDuration=2e3,this.churchMarkers=[],this.animationId=null,this.bearing=0,this.slideshowTimeout=null,this.INITIAL_CENTER=[0,20],this.INITIAL_ZOOM=1.5}ngOnInit(){this.initializeMap()}applyChanges(){this.animationId&&cancelAnimationFrame(this.animationId),this.slideshowTimeout&&clearTimeout(this.slideshowTimeout),this.map&&this.map.remove(),this.initializeMap()}initializeMap(){var n=this;$x.accessToken="pk.eyJ1Ijoic2Fpa3VtYXJ0dW5ndXR1cmkiLCJhIjoiY21laDkzMGR0MDUycjJrcDZqN2xleXc3biJ9.73urhh9weHk5tslJYZ0vhQ",this.map=new $x.Map({container:"globe-map",style:{version:8,sources:{"osm-tiles":{type:"raster",tiles:["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png","https://b.tile.openstreetmap.org/{z}/{x}/{y}.png","https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"osm-tiles",minzoom:0,maxzoom:19}]},center:this.INITIAL_CENTER,zoom:this.INITIAL_ZOOM,projection:"globe"}),this.map.on("style.load",()=>{this.map.setFog({})}),this.map.on("load",rP(function*(){n.churches.forEach(s=>n.addMarkerWithClick(s,"assets/marker.png")),yield n.startInitialRotation(),n.startChurchSlideshow()}))}startInitialRotation(){return this.startRotationStep()}resetToGlobe(){return new Promise(n=>{this.map.flyTo({center:this.INITIAL_CENTER,zoom:this.INITIAL_ZOOM,bearing:0,speed:.6,curve:1,essential:!0}),setTimeout(n,2e3)})}startChurchSlideshow(){var n=this;let s=0;const d=function(){var _=rP(function*(){if(!n.map)return;const E=n.churches[s];yield n.resetToGlobe(),yield n.startRotationStep(),n.map.flyTo({center:E.coordinates,zoom:5,speed:2,curve:1,essential:!0});const S=new $x.Popup({offset:25,closeOnClick:!1}).setHTML(n.buildPopupCard(E)).setLngLat(E.coordinates).addTo(n.map);n.slideshowTimeout=setTimeout(()=>{S.remove(),s=(s+1)%n.churches.length,n.slideshowTimeout=setTimeout(d,1e3)},5e3)});return function(){return _.apply(this,arguments)}}();d()}startRotationStep(){return new Promise(n=>{const s=performance.now(),d=_=>{_-s<this.rotationDuration?(this.bearing-=.5,this.map.easeTo({bearing:this.bearing,duration:50,easing:S=>S}),this.animationId=requestAnimationFrame(d)):(this.animationId&&cancelAnimationFrame(this.animationId),n())};this.ngZone.runOutsideAngular(()=>requestAnimationFrame(d))})}buildPopupCard(n){return`\n      <div style="width:220px; padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.2); font-family:sans-serif; background:#fff;">\n        <img src="${n.personPhoto}" alt="${n.personName}" \n             style="width:100%; height:150px; object-fit:cover; border-radius:8px;"/>\n        <h3 style="margin:8px 0 4px; font-size:16px; color:#333;">${n.name}</h3>\n        <p style="margin:0; font-size:13px; color:#555;">${n.description}</p>\n        <p style="margin:6px 0 0; font-size:14px; font-weight:bold; color:#222;">\n          \u{1f464} ${n.personName}\n        </p>\n      </div>\n    `}addMarkerWithClick(n,s){const d=document.createElement("div");d.className="marker",d.style.backgroundImage=`url(${s})`,d.style.width="30px",d.style.height="30px",d.style.backgroundSize="cover",d.style.cursor="pointer";const _=new $x.Popup({offset:25}).setHTML(this.buildPopupCard(n));return new $x.Marker(d).setLngLat(n.coordinates).setPopup(_).addTo(this.map)}zoomIn(){this.map&&this.map.zoomIn({duration:500})}zoomOut(){this.map&&this.map.zoomOut({duration:500})}ngOnDestroy(){this.map&&this.map.remove(),this.animationId&&cancelAnimationFrame(this.animationId),this.slideshowTimeout&&clearTimeout(this.slideshowTimeout)}static{this.\u0275fac=function(s){return new(s||e)(Dt(Ti))}}static{this.\u0275cmp=Yl({type:e,selectors:[["app-globe-view"]],decls:17,vars:2,consts:[[1,"header"],[1,"logo"],[1,"fas","fa-church"],[1,"profile"],[1,"fas","fa-user-circle"],[1,"controls"],["type","range","min","500","max","10000","step","500",3,"ngModel","ngModelChange"],[3,"click"],["id","globe-map"]],template:function(s,d){1&s&&(Ua(0,"div",0)(1,"div",1),nf(2,"i",2),I(3," Church "),Sl(),Ua(4,"div",3),nf(5,"i",4),Sl()(),Ua(6,"div",5)(7,"label"),I(8),Ua(9,"input",6),Rs("ngModelChange",function(E){return d.rotationDuration=E}),Sl()(),Ua(10,"button",7),Rs("click",function(){return d.applyChanges()}),I(11,"Apply Changes"),Sl(),Ua(12,"button",7),Rs("click",function(){return d.zoomIn()}),I(13,"\u2795 Zoom In"),Sl(),Ua(14,"button",7),Rs("click",function(){return d.zoomOut()}),I(15,"\u2796 Zoom Out"),Sl()(),nf(16,"div",8)),2&s&&(dy(8),V(" \u23f1\ufe0f Rotation Duration (ms): ",d.rotationDuration," "),dy(1),$y("ngModel",d.rotationDuration))},dependencies:[tE,hC,MP,dC],styles:["[_nghost-%COMP%]{display:block;height:100vh;width:100%}.header[_ngcontent-%COMP%]{position:absolute;top:0;left:0;right:0;height:60px;background:transparent;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:10}.logo[_ngcontent-%COMP%]{font-size:40px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px}.logo[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff;font-size:22px}.profile[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:30px;color:#fff;cursor:pointer;transition:opacity .3s ease}.profile[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]:hover{opacity:.7}#globe-map[_ngcontent-%COMP%]{position:absolute;inset:0}  .mapboxgl-popup-content{background:transparent!important;box-shadow:none!important;padding:0!important;border-radius:0!important}  .mapboxgl-popup-close-button{display:none!important}.controls[_ngcontent-%COMP%]{position:absolute;bottom:20px;left:50%;transform:translate(-50%);display:flex;flex-direction:column;gap:10px;z-index:20;background:rgba(0,0,0,.6);padding:12px;border-radius:8px;color:#fff;font-size:14px}.controls[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.controls[_ngcontent-%COMP%]   input[type=range][_ngcontent-%COMP%]{width:200px;cursor:pointer}.controls[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin-top:6px;padding:6px 12px;font-size:14px;border:none;border-radius:6px;background:rgba(255,255,255,.2);color:#fff;cursor:pointer;transition:background .3s ease}.controls[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:rgba(255,255,255,.4)}"]})}}return e})(),w4=(()=>{class e{constructor(){this.title="chruch-project"}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275cmp=Yl({type:e,selectors:[["app-root"]],decls:1,vars:0,template:function(s,d){1&s&&nf(0,"app-globe-view")},dependencies:[b4]})}}return e})(),E4=(()=>{class e{static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275mod=_r({type:e,bootstrap:[w4]})}static{this.\u0275inj=Ir({imports:[lM,GB,y5,b5,x4]})}}return e})();VN().bootstrapModule(E4).catch(e=>console.error(e))},247:function(pv){pv.exports=function(){"use strict";var cf,uf,er;function Xg(u,tr){if(cf)if(uf){var ji="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+cf+")(sharedChunk); ("+uf+")(sharedChunk); self.onerror = null;",Ca={};cf(Ca),er=tr(Ca),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(er.workerUrl=window.URL.createObjectURL(new Blob([ji],{type:"text/javascript"})))}else uf=tr;else cf=tr}return Xg(0,function(u){var tr=1e-6,ji=typeof Float32Array<"u"?Float32Array:Array;function Ca(a,i){var o=i[0],c=i[1],h=i[2],m=i[3],g=o*m-h*c;return g?(a[0]=m*(g=1/g),a[1]=-c*g,a[2]=-h*g,a[3]=o*g,a):null}function kd(){var a=new ji(9);return ji!=Float32Array&&(a[1]=0,a[2]=0,a[3]=0,a[5]=0,a[6]=0,a[7]=0),a[0]=1,a[4]=1,a[8]=1,a}function Fs(a,i){var o=i[0],c=i[1],h=i[2],m=i[3],g=i[4],x=i[5],w=i[6],T=i[7],I=i[8];return a[0]=g*I-x*T,a[1]=h*T-c*I,a[2]=c*x-h*g,a[3]=x*w-m*I,a[4]=o*I-h*w,a[5]=h*m-o*x,a[6]=m*T-g*w,a[7]=c*w-o*T,a[8]=o*g-c*m,a}function ks(a,i,o){var c=i[0],h=i[1],m=i[2],g=i[3],x=i[4],w=i[5],T=i[6],I=i[7],A=i[8],M=o[0],k=o[1],L=o[2],V=o[3],j=o[4],W=o[5],Q=o[6],K=o[7],te=o[8];return a[0]=M*c+k*g+L*T,a[1]=M*h+k*x+L*I,a[2]=M*m+k*w+L*A,a[3]=V*c+j*g+W*T,a[4]=V*h+j*x+W*I,a[5]=V*m+j*w+W*A,a[6]=Q*c+K*g+te*T,a[7]=Q*h+K*x+te*I,a[8]=Q*m+K*w+te*A,a}function Nl(){var a=new ji(16);return ji!=Float32Array&&(a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=0,a[12]=0,a[13]=0,a[14]=0),a[0]=1,a[5]=1,a[10]=1,a[15]=1,a}function fn(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function es(a,i){var o=i[0],c=i[1],h=i[2],m=i[3],g=i[4],x=i[5],w=i[6],T=i[7],I=i[8],A=i[9],M=i[10],k=i[11],L=i[12],V=i[13],j=i[14],W=i[15],Q=o*x-c*g,K=o*w-h*g,te=o*T-m*g,me=c*w-h*x,he=c*T-m*x,fe=h*T-m*w,xe=I*V-A*L,Ee=I*j-M*L,Ve=I*W-k*L,Ce=A*j-M*V,Ue=A*W-k*V,ot=M*W-k*j,$e=Q*ot-K*Ue+te*Ce+me*Ve-he*Ee+fe*xe;return $e?(a[0]=(x*ot-w*Ue+T*Ce)*($e=1/$e),a[1]=(h*Ue-c*ot-m*Ce)*$e,a[2]=(V*fe-j*he+W*me)*$e,a[3]=(M*he-A*fe-k*me)*$e,a[4]=(w*Ve-g*ot-T*Ee)*$e,a[5]=(o*ot-h*Ve+m*Ee)*$e,a[6]=(j*te-L*fe-W*K)*$e,a[7]=(I*fe-M*te+k*K)*$e,a[8]=(g*Ue-x*Ve+T*xe)*$e,a[9]=(c*Ve-o*Ue-m*xe)*$e,a[10]=(L*he-V*te+W*Q)*$e,a[11]=(A*te-I*he-k*Q)*$e,a[12]=(x*Ee-g*Ce-w*xe)*$e,a[13]=(o*Ce-c*Ee+h*xe)*$e,a[14]=(V*K-L*me-j*Q)*$e,a[15]=(I*me-A*K+M*Q)*$e,a):null}function Ui(a,i,o){var c=i[0],h=i[1],m=i[2],g=i[3],x=i[4],w=i[5],T=i[6],I=i[7],A=i[8],M=i[9],k=i[10],L=i[11],V=i[12],j=i[13],W=i[14],Q=i[15],K=o[0],te=o[1],me=o[2],he=o[3];return a[0]=K*c+te*x+me*A+he*V,a[1]=K*h+te*w+me*M+he*j,a[2]=K*m+te*T+me*k+he*W,a[3]=K*g+te*I+me*L+he*Q,a[4]=(K=o[4])*c+(te=o[5])*x+(me=o[6])*A+(he=o[7])*V,a[5]=K*h+te*w+me*M+he*j,a[6]=K*m+te*T+me*k+he*W,a[7]=K*g+te*I+me*L+he*Q,a[8]=(K=o[8])*c+(te=o[9])*x+(me=o[10])*A+(he=o[11])*V,a[9]=K*h+te*w+me*M+he*j,a[10]=K*m+te*T+me*k+he*W,a[11]=K*g+te*I+me*L+he*Q,a[12]=(K=o[12])*c+(te=o[13])*x+(me=o[14])*A+(he=o[15])*V,a[13]=K*h+te*w+me*M+he*j,a[14]=K*m+te*T+me*k+he*W,a[15]=K*g+te*I+me*L+he*Q,a}function jo(a,i,o){var c,h,m,g,x,w,T,I,A,M,k,L,V=o[0],j=o[1],W=o[2];return i===a?(a[12]=i[0]*V+i[4]*j+i[8]*W+i[12],a[13]=i[1]*V+i[5]*j+i[9]*W+i[13],a[14]=i[2]*V+i[6]*j+i[10]*W+i[14],a[15]=i[3]*V+i[7]*j+i[11]*W+i[15]):(h=i[1],m=i[2],g=i[3],x=i[4],w=i[5],T=i[6],I=i[7],A=i[8],M=i[9],k=i[10],L=i[11],a[0]=c=i[0],a[1]=h,a[2]=m,a[3]=g,a[4]=x,a[5]=w,a[6]=T,a[7]=I,a[8]=A,a[9]=M,a[10]=k,a[11]=L,a[12]=c*V+x*j+A*W+i[12],a[13]=h*V+w*j+M*W+i[13],a[14]=m*V+T*j+k*W+i[14],a[15]=g*V+I*j+L*W+i[15]),a}function ro(a,i,o){var c=o[0],h=o[1],m=o[2];return a[0]=i[0]*c,a[1]=i[1]*c,a[2]=i[2]*c,a[3]=i[3]*c,a[4]=i[4]*h,a[5]=i[5]*h,a[6]=i[6]*h,a[7]=i[7]*h,a[8]=i[8]*m,a[9]=i[9]*m,a[10]=i[10]*m,a[11]=i[11]*m,a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15],a}function ys(a,i,o){var c=Math.sin(o),h=Math.cos(o),m=i[4],g=i[5],x=i[6],w=i[7],T=i[8],I=i[9],A=i[10],M=i[11];return i!==a&&(a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=i[3],a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15]),a[4]=m*h+T*c,a[5]=g*h+I*c,a[6]=x*h+A*c,a[7]=w*h+M*c,a[8]=T*h-m*c,a[9]=I*h-g*c,a[10]=A*h-x*c,a[11]=M*h-w*c,a}function Ws(a,i,o){var c=Math.sin(o),h=Math.cos(o),m=i[0],g=i[1],x=i[2],w=i[3],T=i[8],I=i[9],A=i[10],M=i[11];return i!==a&&(a[4]=i[4],a[5]=i[5],a[6]=i[6],a[7]=i[7],a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15]),a[0]=m*h-T*c,a[1]=g*h-I*c,a[2]=x*h-A*c,a[3]=w*h-M*c,a[8]=m*c+T*h,a[9]=g*c+I*h,a[10]=x*c+A*h,a[11]=w*c+M*h,a}function zl(a,i,o){var c=Math.sin(o),h=Math.cos(o),m=i[0],g=i[1],x=i[2],w=i[3],T=i[4],I=i[5],A=i[6],M=i[7];return i!==a&&(a[8]=i[8],a[9]=i[9],a[10]=i[10],a[11]=i[11],a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15]),a[0]=m*h+T*c,a[1]=g*h+I*c,a[2]=x*h+A*c,a[3]=w*h+M*c,a[4]=T*h-m*c,a[5]=I*h-g*c,a[6]=A*h-x*c,a[7]=M*h-w*c,a}function Bl(a,i){return a[0]=i[0],a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=i[1],a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=i[2],a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function da(a,i,o){var c,h,m,g=o[0],x=o[1],w=o[2],T=Math.hypot(g,x,w);return T<tr?null:(g*=T=1/T,x*=T,w*=T,c=Math.sin(i),h=Math.cos(i),a[0]=g*g*(m=1-h)+h,a[1]=x*g*m+w*c,a[2]=w*g*m-x*c,a[3]=0,a[4]=g*x*m-w*c,a[5]=x*x*m+h,a[6]=w*x*m+g*c,a[7]=0,a[8]=g*w*m+x*c,a[9]=x*w*m-g*c,a[10]=w*w*m+h,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a)}function Ia(a,i){var o=i[0],c=i[1],h=i[2],m=i[3],g=o+o,x=c+c,w=h+h,T=o*g,I=c*g,A=c*x,M=h*g,k=h*x,L=h*w,V=m*g,j=m*x,W=m*w;return a[0]=1-A-L,a[1]=I+W,a[2]=M-j,a[3]=0,a[4]=I-W,a[5]=1-T-L,a[6]=k+V,a[7]=0,a[8]=M+j,a[9]=k-V,a[10]=1-T-A,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}Math.hypot||(Math.hypot=function(){for(var a=0,i=arguments.length;i--;)a+=arguments[i]*arguments[i];return Math.sqrt(a)});var df=Ui;function Un(){var a=new ji(3);return ji!=Float32Array&&(a[0]=0,a[1]=0,a[2]=0),a}function qa(a){var i=new ji(3);return i[0]=a[0],i[1]=a[1],i[2]=a[2],i}function go(a){return Math.hypot(a[0],a[1],a[2])}function mr(a,i,o){var c=new ji(3);return c[0]=a,c[1]=i,c[2]=o,c}function gr(a,i,o,c){return a[0]=i,a[1]=o,a[2]=c,a}function Fi(a,i,o){return a[0]=i[0]+o[0],a[1]=i[1]+o[1],a[2]=i[2]+o[2],a}function oo(a,i,o){return a[0]=i[0]-o[0],a[1]=i[1]-o[1],a[2]=i[2]-o[2],a}function hf(a,i,o){return a[0]=i[0]*o[0],a[1]=i[1]*o[1],a[2]=i[2]*o[2],a}function Aa(a,i,o){return a[0]=Math.min(i[0],o[0]),a[1]=Math.min(i[1],o[1]),a[2]=Math.min(i[2],o[2]),a}function Hi(a,i,o){return a[0]=Math.max(i[0],o[0]),a[1]=Math.max(i[1],o[1]),a[2]=Math.max(i[2],o[2]),a}function ki(a,i,o){return a[0]=i[0]*o,a[1]=i[1]*o,a[2]=i[2]*o,a}function Uo(a,i,o,c){return a[0]=i[0]+o[0]*c,a[1]=i[1]+o[1]*c,a[2]=i[2]+o[2]*c,a}function Cu(a,i){var o=i[0]-a[0],c=i[1]-a[1],h=i[2]-a[2];return o*o+c*c+h*h}function ff(a){var i=a[0],o=a[1],c=a[2];return i*i+o*o+c*c}function Gi(a,i){return a[0]=-i[0],a[1]=-i[1],a[2]=-i[2],a}function Mi(a,i){var o=i[0],c=i[1],h=i[2],m=o*o+c*c+h*h;return m>0&&(m=1/Math.sqrt(m)),a[0]=i[0]*m,a[1]=i[1]*m,a[2]=i[2]*m,a}function ar(a,i){return a[0]*i[0]+a[1]*i[1]+a[2]*i[2]}function vi(a,i,o){var c=i[0],h=i[1],m=i[2],g=o[0],x=o[1],w=o[2];return a[0]=h*w-m*x,a[1]=m*g-c*w,a[2]=c*x-h*g,a}function nr(a,i,o,c){var h=i[0],m=i[1],g=i[2];return a[0]=h+c*(o[0]-h),a[1]=m+c*(o[1]-m),a[2]=g+c*(o[2]-g),a}function lr(a,i,o){var c=i[0],h=i[1],m=i[2],g=o[3]*c+o[7]*h+o[11]*m+o[15];return a[0]=(o[0]*c+o[4]*h+o[8]*m+o[12])/(g=g||1),a[1]=(o[1]*c+o[5]*h+o[9]*m+o[13])/g,a[2]=(o[2]*c+o[6]*h+o[10]*m+o[14])/g,a}function Ls(a,i,o){var c=i[0],h=i[1],m=i[2];return a[0]=c*o[0]+h*o[3]+m*o[6],a[1]=c*o[1]+h*o[4]+m*o[7],a[2]=c*o[2]+h*o[5]+m*o[8],a}function Ma(a,i,o){var c=o[0],h=o[1],m=o[2],g=i[0],x=i[1],w=i[2],T=h*w-m*x,I=m*g-c*w,A=c*x-h*g,M=h*A-m*I,k=m*T-c*A,L=c*I-h*T,V=2*o[3];return I*=V,A*=V,k*=2,L*=2,a[0]=g+(T*=V)+(M*=2),a[1]=x+I+k,a[2]=w+A+L,a}function Ld(a){return a[0]=0,a[1]=0,a[2]=0,a}function vs(a,i){return a[0]===i[0]&&a[1]===i[1]&&a[2]===i[2]}var cr=oo,ts=hf,Vl=go;function Nd(){var a=new ji(4);return ji!=Float32Array&&(a[0]=0,a[1]=0,a[2]=0,a[3]=0),a}function Wa(a,i,o){return a[0]=i[0]*o,a[1]=i[1]*o,a[2]=i[2]*o,a[3]=i[3]*o,a}function Ns(a,i){var o=i[0],c=i[1],h=i[2],m=i[3],g=o*o+c*c+h*h+m*m;return g>0&&(g=1/Math.sqrt(g)),a[0]=o*g,a[1]=c*g,a[2]=h*g,a[3]=m*g,a}function xs(a,i,o){var c=i[0],h=i[1],m=i[2],g=i[3];return a[0]=o[0]*c+o[4]*h+o[8]*m+o[12]*g,a[1]=o[1]*c+o[5]*h+o[9]*m+o[13]*g,a[2]=o[2]*c+o[6]*h+o[10]*m+o[14]*g,a[3]=o[3]*c+o[7]*h+o[11]*m+o[15]*g,a}function Za(){var a=new ji(4);return ji!=Float32Array&&(a[0]=0,a[1]=0,a[2]=0),a[3]=1,a}function Pa(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a}function Tc(a,i,o){o*=.5;var c=i[0],h=i[1],m=i[2],g=i[3],x=Math.sin(o),w=Math.cos(o);return a[0]=c*w+g*x,a[1]=h*w+m*x,a[2]=m*w-h*x,a[3]=g*w-c*x,a}function jl(a,i,o){o*=.5;var c=i[0],h=i[1],m=i[2],g=i[3],x=Math.sin(o),w=Math.cos(o);return a[0]=c*w-m*x,a[1]=h*w+g*x,a[2]=m*w+c*x,a[3]=g*w-h*x,a}Un(),Nd();var ns,is,Iu,Xa=Ns,Au=(ns=Un(),is=mr(1,0,0),Iu=mr(0,1,0),function(a,i,o){var c=ar(i,o);return c<-.999999?(vi(ns,is,i),Vl(ns)<1e-6&&vi(ns,Iu,i),Mi(ns,ns),function(h,m,g){g*=.5;var x=Math.sin(g);h[0]=x*m[0],h[1]=x*m[1],h[2]=x*m[2],h[3]=Math.cos(g)}(a,ns,Math.PI),a):c>.999999?(a[0]=0,a[1]=0,a[2]=0,a[3]=1,a):(vi(ns,i,o),a[0]=ns[0],a[1]=ns[1],a[2]=ns[2],a[3]=1+c,Xa(a,a))});function Mo(){var a=new ji(2);return ji!=Float32Array&&(a[0]=0,a[1]=0),a}function Zr(a,i){var o=new ji(2);return o[0]=a,o[1]=i,o}function Ya(a,i,o){return a[0]=i[0]+o[0],a[1]=i[1]+o[1],a}function Ka(a,i,o){return a[0]=i[0]-o[0],a[1]=i[1]-o[1],a}function Qa(a,i,o){return a[0]=i[0]*o,a[1]=i[1]*o,a}function Ul(a){return Math.hypot(a[0],a[1])}function Mu(a,i){var o=i[0],c=i[1],h=o*o+c*c;return h>0&&(h=1/Math.sqrt(h)),a[0]=i[0]*h,a[1]=i[1]*h,a}function Di(a,i){return a[0]*i[0]+a[1]*i[1]}Za(),Za(),kd();var zd,Bd,zs=Ka;function Vd(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}Mo();var Pu=Vd(function(){if(Bd)return zd;function a(i,o,c,h){this.cx=3*i,this.bx=3*(c-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*o,this.by=3*(h-o)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=o,this.p2x=c,this.p2y=h}return Bd=1,zd=a,a.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,o){if(void 0===o&&(o=1e-6),i<0)return 0;if(i>1)return 1;for(var c=i,h=0;h<8;h++){var m=this.sampleCurveX(c)-i;if(Math.abs(m)<o)return c;var g=this.sampleCurveDerivativeX(c);if(Math.abs(g)<1e-6)break;c-=m/g}var x=0,w=1;for(c=i,h=0;h<20&&(m=this.sampleCurveX(c),!(Math.abs(m-i)<o));h++)i>m?x=c:w=c,c=.5*(w-x)+x;return c},solve:function(i,o){return this.sampleCurveY(this.solveCurveX(i,o))}},zd}());function Je(a,i){this.x=a,this.y=i}function Ja(a,i){if(Array.isArray(a)){if(!Array.isArray(i)||a.length!==i.length)return!1;for(let o=0;o<a.length;o++)if(!Ja(a[o],i[o]))return!1;return!0}if("object"==typeof a&&null!==a&&null!==i){if("object"!=typeof i||Object.keys(a).length!==Object.keys(i).length)return!1;for(const o in a)if(!Ja(a[o],i[o]))return!1;return!0}return a===i}Je.prototype={clone(){return new Je(this.x,this.y)},add(a){return this.clone()._add(a)},sub(a){return this.clone()._sub(a)},multByPoint(a){return this.clone()._multByPoint(a)},divByPoint(a){return this.clone()._divByPoint(a)},mult(a){return this.clone()._mult(a)},div(a){return this.clone()._div(a)},rotate(a){return this.clone()._rotate(a)},rotateAround(a,i){return this.clone()._rotateAround(a,i)},matMult(a){return this.clone()._matMult(a)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(a){return this.x===a.x&&this.y===a.y},dist(a){return Math.sqrt(this.distSqr(a))},distSqr(a){const i=a.x-this.x,o=a.y-this.y;return i*i+o*o},angle(){return Math.atan2(this.y,this.x)},angleTo(a){return Math.atan2(this.y-a.y,this.x-a.x)},angleWith(a){return this.angleWithSep(a.x,a.y)},angleWithSep(a,i){return Math.atan2(this.x*i-this.y*a,this.x*a+this.y*i)},_matMult(a){const i=a[2]*this.x+a[3]*this.y;return this.x=a[0]*this.x+a[1]*this.y,this.y=i,this},_add(a){return this.x+=a.x,this.y+=a.y,this},_sub(a){return this.x-=a.x,this.y-=a.y,this},_mult(a){return this.x*=a,this.y*=a,this},_div(a){return this.x/=a,this.y/=a,this},_multByPoint(a){return this.x*=a.x,this.y*=a.y,this},_divByPoint(a){return this.x/=a.x,this.y/=a.y,this},_unit(){return this._div(this.mag()),this},_perp(){const a=this.y;return this.y=this.x,this.x=-a,this},_rotate(a){const i=Math.cos(a),o=Math.sin(a),c=o*this.x+i*this.y;return this.x=i*this.x-o*this.y,this.y=c,this},_rotateAround(a,i){const o=Math.cos(a),c=Math.sin(a),h=i.y+c*(this.x-i.x)+o*(this.y-i.y);return this.x=i.x+o*(this.x-i.x)-c*(this.y-i.y),this.y=h,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Je},Je.convert=function(a){if(a instanceof Je)return a;if(Array.isArray(a))return new Je(+a[0],+a[1]);if(void 0!==a.x&&void 0!==a.y)return new Je(+a.x,+a.y);throw new Error("Expected [x, y] or {x, y} point format")};const $p=Math.PI/180,pf=180/Math.PI;function Rn(a){return a*$p}function Pe(a){return a*pf}const Z=[[0,0],[1,0],[1,1],[0,1]];function X(a){if(a<=0)return 0;if(a>=1)return 1;const i=a*a,o=i*a;return 4*(a<.5?o:3*(a-i)+o-.75)}function oe(a,i,o,c){const h=new Pu(a,i,o,c);return function(m){return h.solve(m)}}const ge=oe(.25,.1,.25,1);function se(a,i,o){return Math.min(o,Math.max(i,a))}function be(a,i,o){return(o=se((o-a)/(i-a),0,1))*o*(3-2*o)}function ke(a,i,o){const c=o-i,h=((a-i)%c+c)%c+i;return h===i?o:h}function Te(a,i,o){if(!a.length)return o(null,[]);let c=a.length;const h=new Array(a.length);let m=null;a.forEach((g,x)=>{i(g,(w,T)=>{w&&(m=w),h[x]=T,0==--c&&o(m,h)})})}function Ie(a,...i){for(const o of i)for(const c in o)a[c]=o[c];return a}let st=1;function qe(){return st++}function Lt(a){return a<=1?1:Math.pow(2,Math.ceil(Math.log(a)/Math.LN2))}function $t(a,i){a.forEach(o=>{i[o]&&(i[o]=i[o].bind(i))})}function Zt(a,i,o){const c={};for(const h in a)c[h]=i.call(this,a[h],h,a);return c}function bn(a,i,o){const c={};for(const h in a)i.call(this,a[h],h,a)&&(c[h]=a[h]);return c}function pn(a){return Array.isArray(a)?a.map(pn):"object"==typeof a&&a?Zt(a,pn):a}function cn(a,i){for(let o=0;o<a.length;o++)if(i.indexOf(a[o])>=0)return!0;return!1}const mi={};function yn(a){mi[a]||(typeof console<"u"&&console.warn(a),mi[a]=!0)}function ir(a,i,o){return(o.y-a.y)*(i.x-a.x)>(i.y-a.y)*(o.x-a.x)}function Cr(a){let i=0;for(let o,c,h=0,m=a.length,g=m-1;h<m;g=h++)o=a[h],c=a[g],i+=(c.x-o.x)*(o.y+c.y);return i}function Lr([a,i,o]){const c=Rn(i+90),h=Rn(o);return{x:a*Math.cos(c)*Math.sin(h),y:a*Math.sin(c)*Math.sin(h),z:a*Math.cos(h),azimuthal:i,polar:o}}function ci(a){return(typeof self<"u"||void 0!==a)&&typeof WorkerGlobalScope<"u"&&(void 0!==a?a:self)instanceof WorkerGlobalScope}function Vn(a){const i={};if(a.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(o,c,h,m)=>{const g=h||m;return i[c]=!g||g.toLowerCase(),""}),i["max-age"]){const o=parseInt(i["max-age"],10);isNaN(o)?delete i["max-age"]:i["max-age"]=o}return i}let $i=null;function Vi(a,i){return[a[4*i],a[4*i+1],a[4*i+2],a[4*i+3]]}function Si(a,i,o,c){for(;i<o;){const h=i+o>>1;a[h]<c?i=h+1:o=h}return i}function Xr(a,i,o,c){for(;i<o;){const h=i+o>>1;a[h]<=c?i=h+1:o=h}return i}function Ho(a){return a>0?1/(1.001-a):1+a}function _o(a){return a>0?1-1/(1.001-a):-a}function jd(a,i,o){return(a-i.min)*(o.max-o.min)/(i.max-i.min)+o.min}const so={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!so.API_URL)return null;try{const a=new URL(so.API_URL);return"api.mapbox.cn"===a.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===a.hostname?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.1.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Hl(a){return so.API_URL_REGEX.test(a)}function mf(a){return so.API_SPRITE_REGEX.test(a)}let Ru,Ud,gf,el,tl,Ou;function Dc(){return null==Ru&&(Ru=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),Ru}const Zs={now:()=>void 0!==el?el:performance.now(),setNow(a){el=a},restoreNow(){el=void 0},frame(a){const i=requestAnimationFrame(a);return{cancel:()=>cancelAnimationFrame(i)}},getImageData(a,i=0){const{width:o,height:c}=a;tl||(tl=document.createElement("canvas"));const h=tl.getContext("2d",{willReadFrequently:!0});if(!h)throw new Error("failed to create canvas 2d context");return(o>tl.width||c>tl.height)&&(tl.width=o,tl.height=c),h.clearRect(-i,-i,o+2*i,c+2*i),h.drawImage(a,0,0,o,c),h.getImageData(-i,-i,o+2*i,c+2*i)},resolveURL:a=>(Ud||(Ud=document.createElement("a")),Ud.href=a,Ud.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==gf&&(gf=window.matchMedia("(prefers-reduced-motion: reduce)")),gf.matches)},hasCanvasFingerprintNoise(){if(void 0!==Ou)return Ou;if(!Dc())return Ou=!1,!1;const a=new OffscreenCanvas(85,1),i=a.getContext("2d",{willReadFrequently:!0});let o=0;for(let h=0;h<a.width;++h)i.fillStyle=`rgba(${o++},${o++},${o++}, 255)`,i.fillRect(h,0,1,1);const c=i.getImageData(0,0,a.width,a.height);o=0;for(let h=0;h<c.data.length;++h)if(h%4!=3&&o++!==c.data[h])return Ou=!0,!0;return Ou=!1,!1}};function rs(a,i){const o=a.indexOf("?");if(o<0)return`${a}?${new URLSearchParams(i).toString()}`;const c=new URLSearchParams(a.slice(o));for(const h in i)c.set(h,i[h]);return`${a.slice(0,o)}?${c.toString()}`}function Xs(a,i={persistentParams:[]}){const o=a.indexOf("?");if(o<0)return a;const c=new URLSearchParams,h=new URLSearchParams(a.slice(o));for(const g of i.persistentParams){const x=h.get(g);x&&c.set(g,x)}const m=c.toString();return`${a.slice(0,o)}${m.length>0?`?${m}`:""}`}const Ra="mapbox-tiles";let ha=500,Ci=50;const Gl=["language","worldview","jobid"];let ur,Sc;function Cc(){try{return caches}catch{}}function Yi(){const a=Cc();a&&null==ur&&(ur=a.open(Ra))}let Nn=1/0;const Hd={supported:!1,testSupport:function(a){!ku&&Fu&&(wt?qn(a):Po=a)}};let Po,Fu,ku=!1,wt=!1;const Gd=typeof self<"u"?self:{};function qn(a){const i=a.createTexture();a.bindTexture(a.TEXTURE_2D,i);try{if(a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,Fu),a.isContextLost())return;Hd.supported=!0}catch{}a.deleteTexture(i),ku=!0}Gd.document&&(Fu=Gd.document.createElement("img"),Fu.onload=function(){Po&&qn(Po),Po=null,wt=!0},Fu.onerror=function(){ku=!0,Po=null},Fu.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Li={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(Li);class On extends Error{constructor(i,o,c){401===o&&Hl(c)&&(i+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(i),this.status=o,this.url=c}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const qp=ci()?()=>self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href,Lu=function(a,i){if(!(/^file:/.test(o=a.url)||/^file:/.test(qp())&&!/^\w+:/.test(o))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(c,h){const m=new AbortController,g=new Request(c.url,{method:c.method||"GET",body:c.body,credentials:c.credentials,headers:c.headers,referrer:qp(),referrerPolicy:c.referrerPolicy,signal:m.signal});let x=!1,w=!1;const T=(I=g.url).indexOf("sku=")>0&&Hl(I);var I;"json"===c.type&&g.headers.set("Accept","application/json");const A=(k,L,V)=>{if(w)return;if(k&&"SecurityError"!==k.message&&yn(k.toString()),L&&V)return M(L);const j=Date.now();fetch(g).then(W=>{if(W.ok){const Q=T?W.clone():null;return M(W,Q,j)}return h(new On(W.statusText,W.status,c.url))}).catch(W=>{"AbortError"!==W.name&&h(new Error(`${W.message} ${c.url}`))})},M=(k,L,V)=>{("arrayBuffer"===c.type?k.arrayBuffer():"json"===c.type?k.json():k.text()).then(j=>{w||(L&&V&&function(W,Q,K){if(Yi(),null==ur)return;const te=Vn(Q.headers.get("Cache-Control")||"");if(te["no-store"])return;const me={status:Q.status,statusText:Q.statusText,headers:new Headers};Q.headers.forEach((xe,Ee)=>me.headers.set(Ee,xe)),te["max-age"]&&me.headers.set("Expires",new Date(K+1e3*te["max-age"]).toUTCString());const he=me.headers.get("Expires");if(!he||new Date(he).getTime()-K<42e4)return;let fe=Xs(W.url,{persistentParams:Gl});if(206===Q.status){const xe=W.headers.get("Range");if(!xe)return;me.status=200,fe=rs(fe,{range:xe})}!function(xe,Ee){if(void 0===Sc)try{new Response(new ReadableStream),Sc=!0}catch{Sc=!1}Sc?Ee(xe.body):xe.blob().then(Ee).catch(Ve=>yn(Ve.message))}(Q,xe=>{const Ee=new Response(200!==(Ve=Q.status)&&404!==Ve&&[101,103,204,205,304].includes(Ve)?null:xe,me);var Ve;Yi(),ur?.then(Ce=>Ce.put(fe,Ee)).catch(Ce=>yn(Ce.message))})}(g,L,V),x=!0,h(null,j,k.headers.get("Cache-Control"),k.headers.get("Expires")))}).catch(j=>{w||h(new Error(j.message))})};return T?function(k,L){if(Yi(),null==ur)return L(null);ur.then(V=>{let j=Xs(k.url,{persistentParams:Gl});const W=k.headers.get("Range");W&&(j=rs(j,{range:W})),V.match(j).then(Q=>{const K=function(te){if(!te)return!1;const me=new Date(te.headers.get("Expires")||0),he=Vn(te.headers.get("Cache-Control")||"");return Number(me)>Date.now()&&!he["no-cache"]}(Q);V.delete(j).catch(L),K&&V.put(j,Q.clone()).catch(L),L(null,Q,K)}).catch(L)}).catch(L)}(g,A):A(null,null),{cancel:()=>{w=!0,x||m.abort()}}}(a,i);if(ci(self)&&self.worker.actor)return self.worker.actor.send("getResource",a,i,void 0,!0)}var o;return function(c,h){const m=new XMLHttpRequest;m.open(c.method||"GET",c.url,!0),"arrayBuffer"===c.type&&(m.responseType="arraybuffer");for(const g in c.headers)m.setRequestHeader(g,c.headers[g]);return"json"===c.type&&(m.responseType="text",m.setRequestHeader("Accept","application/json")),m.withCredentials="include"===c.credentials,m.onerror=()=>{h(new Error(m.statusText))},m.onload=()=>{if((m.status>=200&&m.status<300||0===m.status)&&null!==m.response){let g=m.response;if("json"===c.type)try{g=JSON.parse(m.response)}catch(x){return h(x)}h(null,g,m.getResponseHeader("Cache-Control"),m.getResponseHeader("Expires"))}else h(new On(m.statusText,m.status,c.url))},m.send(c.body),{cancel:()=>m.abort()}}(a,i)},Ic=function(a,i){return Lu(Ie(a,{type:"arrayBuffer"}),i)};function Bs(a){const i=document.createElement("a");return i.href=a,i.protocol===location.protocol&&i.host===location.host}const _f="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Ac,Mc;Ac=[],Mc=0;const fa=function(a,i){if(Hd.supported&&(a.headers||(a.headers={}),a.headers.accept="image/webp,*/*"),Mc>=so.MAX_PARALLEL_IMAGE_REQUESTS){const m={requestParameters:a,callback:i,cancelled:!1,cancel(){this.cancelled=!0}};return Ac.push(m),m}Mc++;let o=!1;const c=()=>{if(!o)for(o=!0,Mc--;Ac.length&&Mc<so.MAX_PARALLEL_IMAGE_REQUESTS;){const m=Ac.shift(),{requestParameters:g,callback:x,cancelled:w}=m;w||(m.cancel=fa(g,x).cancel)}},h=Ic(a,(m,g,x,w)=>{c(),m?i(m):g&&(self.createImageBitmap?function(T,I){const A=new Blob([new Uint8Array(T)],{type:"image/png"});createImageBitmap(A).then(M=>{I(null,M)}).catch(M=>{I(new Error(`Could not load image because of ${M.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(g,(T,I)=>i(T,I,x,w)):function(T,I){const A=new Image;A.onload=()=>{I(null,A),URL.revokeObjectURL(A.src),A.onload=null,requestAnimationFrame(()=>{A.src=_f})},A.onerror=()=>I(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const M=new Blob([new Uint8Array(T)],{type:"image/png"});A.src=T.byteLength?URL.createObjectURL(M):_f}(g,(T,I)=>i(T,I,x,w)))});return{cancel:()=>{h.cancel(),c()}}};var gv,Wp,_v,$d={exports:{}},Pc={exports:{}},yv={exports:{}},Wd=Vd(function(){if(_v)return $d.exports;_v=1;var a=(gv||(gv=1,Pc.exports=function(o,c){var h,m,g,x,w,T,I,A;for(m=o.length-(h=3&o.length),g=c,w=3432918353,T=461845907,A=0;A<m;)I=255&o.charCodeAt(A)|(255&o.charCodeAt(++A))<<8|(255&o.charCodeAt(++A))<<16|(255&o.charCodeAt(++A))<<24,++A,g=27492+(65535&(x=5*(65535&(g=(g^=I=(65535&(I=(I=(65535&I)*w+(((I>>>16)*w&65535)<<16)&4294967295)<<15|I>>>17))*T+(((I>>>16)*T&65535)<<16)&4294967295)<<13|g>>>19))+((5*(g>>>16)&65535)<<16)&4294967295))+((58964+(x>>>16)&65535)<<16);switch(I=0,h){case 3:I^=(255&o.charCodeAt(A+2))<<16;case 2:I^=(255&o.charCodeAt(A+1))<<8;case 1:g^=I=(65535&(I=(I=(65535&(I^=255&o.charCodeAt(A)))*w+(((I>>>16)*w&65535)<<16)&4294967295)<<15|I>>>17))*T+(((I>>>16)*T&65535)<<16)&4294967295}return g^=o.length,g=2246822507*(65535&(g^=g>>>16))+((2246822507*(g>>>16)&65535)<<16)&4294967295,g=3266489909*(65535&(g^=g>>>13))+((3266489909*(g>>>16)&65535)<<16)&4294967295,(g^=g>>>16)>>>0}),Pc.exports),i=(Wp||(Wp=1,yv.exports=function(o,c){for(var h,m=o.length,g=c^m,x=0;m>=4;)h=1540483477*(65535&(h=255&o.charCodeAt(x)|(255&o.charCodeAt(++x))<<8|(255&o.charCodeAt(++x))<<16|(255&o.charCodeAt(++x))<<24))+((1540483477*(h>>>16)&65535)<<16),g=1540483477*(65535&g)+((1540483477*(g>>>16)&65535)<<16)^(h=1540483477*(65535&(h^=h>>>24))+((1540483477*(h>>>16)&65535)<<16)),m-=4,++x;switch(m){case 3:g^=(255&o.charCodeAt(x+2))<<16;case 2:g^=(255&o.charCodeAt(x+1))<<8;case 1:g=1540483477*(65535&(g^=255&o.charCodeAt(x)))+((1540483477*(g>>>16)&65535)<<16)}return g=1540483477*(65535&(g^=g>>>13))+((1540483477*(g>>>16)&65535)<<16),(g^=g>>>15)>>>0}),yv.exports);return $d.exports=a,$d.exports.murmur3=a,$d.exports.murmur2=i,$d.exports}());class Yr{constructor(i,...o){Ie(this,o[0]||{}),this.type=i}}class _n extends Yr{constructor(i,o={}){super("error",Ie({error:i},o))}}function Yg(a,i,o){o[a]&&-1!==o[a].indexOf(i)||(o[a]=o[a]||[],o[a].push(i))}function Kg(a,i,o){if(o&&o[a]){const c=o[a].indexOf(i);-1!==c&&o[a].splice(c,1)}}class Nu{on(i,o){return this._listeners=this._listeners||{},Yg(i,o,this._listeners),this}off(i,o){return Kg(i,o,this._listeners),Kg(i,o,this._oneTimeListeners),this}once(i,o){return o?(this._oneTimeListeners=this._oneTimeListeners||{},Yg(i,o,this._oneTimeListeners),this):new Promise(c=>{this.once(i,c)})}fire(i,o){const c="string"==typeof i?new Yr(i,o):i,h=c.type;if(this.listens(h)){c.target=this;const m=this._listeners&&this._listeners[h]?this._listeners[h].slice():[];for(const w of m)w.call(this,c);const g=this._oneTimeListeners&&this._oneTimeListeners[h]?this._oneTimeListeners[h].slice():[];for(const w of g)Kg(h,w,this._oneTimeListeners),w.call(this,c);const x=this._eventedParent;x&&(Ie(c,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),x.fire(c))}else c instanceof _n&&console.error(c.error);return this}listens(i){return!!(this._listeners&&this._listeners[i]&&this._listeners[i].length>0||this._oneTimeListeners&&this._oneTimeListeners[i]&&this._oneTimeListeners[i].length>0||this._eventedParent&&this._eventedParent.listens(i))}setEventedParent(i,o){return this._eventedParent=i,this._eventedParentData=o,this}}class Jt{constructor(i){"string"==typeof i?this.name=i:(this.name=i.name,this.iconsetId=i.iconsetId)}static from(i){return new Jt(i)}static toString(i){return i.iconsetId?`${i.name}\x1f${i.iconsetId}`:i.name}static parse(i){const[o,c]=i.split("\x1f");return new Jt({name:o,iconsetId:c})}static isEqual(i,o){return i.name===o.name&&i.iconsetId===o.iconsetId}toString(){return Jt.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Qg,Ir={},zu=function(){if(Qg)return Ir;Qg=1;var a={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function i(m){return(m=Math.round(m))<0?0:m>255?255:m}function o(m){return i("%"===m[m.length-1]?parseFloat(m)/100*255:parseInt(m))}function c(m){return(g="%"===m[m.length-1]?parseFloat(m)/100:parseFloat(m))<0?0:g>1?1:g;var g}function h(m,g,x){return x<0?x+=1:x>1&&(x-=1),6*x<1?m+(g-m)*x*6:2*x<1?g:3*x<2?m+(g-m)*(2/3-x)*6:m}try{Ir.parseCSSColor=function(m){var g,x=m.replace(/ /g,"").toLowerCase();if(x in a)return a[x].slice();if("#"===x[0])return 4===x.length?(g=parseInt(x.substr(1),16))>=0&&g<=4095?[(3840&g)>>4|(3840&g)>>8,240&g|(240&g)>>4,15&g|(15&g)<<4,1]:null:7===x.length&&(g=parseInt(x.substr(1),16))>=0&&g<=16777215?[(16711680&g)>>16,(65280&g)>>8,255&g,1]:null;var w=x.indexOf("("),T=x.indexOf(")");if(-1!==w&&T+1===x.length){var I=x.substr(0,w),A=x.substr(w+1,T-(w+1)).split(","),M=1;switch(I){case"rgba":if(4!==A.length)return null;M=c(A.pop());case"rgb":return 3!==A.length?null:[o(A[0]),o(A[1]),o(A[2]),M];case"hsla":if(4!==A.length)return null;M=c(A.pop());case"hsl":if(3!==A.length)return null;var k=(parseFloat(A[0])%360+360)%360/360,L=c(A[1]),V=c(A[2]),j=V<=.5?V*(L+1):V+L-V*L,W=2*V-j;return[i(255*h(W,j,k+1/3)),i(255*h(W,j,k)),i(255*h(W,j,k-1/3)),M];default:return null}}return null}}catch{}return Ir}();class Kn{constructor(i,o,c,h=1){this.r=i,this.g=o,this.b=c,this.a=h}static parse(i){if(!i)return;if(i instanceof Kn)return i;if("string"!=typeof i)return;const o=zu.parseCSSColor(i);return o?new Kn(o[0]/255,o[1]/255,o[2]/255,o[3]):void 0}toString(){const[i,o,c,h]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*i)},${Math.round(255*o)},${Math.round(255*c)},${h})`}toNonPremultipliedRenderColor(i){const{r:o,g:c,b:h,a:m}=this;return new Vu(i,o,c,h,m)}toPremultipliedRenderColor(i){const{r:o,g:c,b:h,a:m}=this;return new Zd(i,o*m,c*m,h*m,m)}clone(){return new Kn(this.r,this.g,this.b,this.a)}}class Bu{constructor(i,o,c,h,m,g=!1){if(this.premultiplied=!1,this.premultiplied=g,i){const x=i.image.height,w=x*x;this.premultiplied?(o=0===m?0:o/m*(x-1),c=0===m?0:c/m*(x-1),h=0===m?0:h/m*(x-1)):(o*=x-1,c*=x-1,h*=x-1);const T=Math.floor(o),I=Math.floor(c),A=Math.floor(h),M=Math.ceil(o),k=Math.ceil(c),L=Math.ceil(h),V=o-T,j=c-I,W=h-A,Q=i.image.data,K=4*(T+I*w+A*x),te=4*(T+I*w+L*x),me=4*(T+k*w+A*x),he=4*(T+k*w+L*x),fe=4*(M+I*w+A*x),xe=4*(M+I*w+L*x),Ee=4*(M+k*w+A*x),Ve=4*(M+k*w+L*x);if(K<0||Ve>=Q.length)throw new Error("out of range");this.r=Nt(Nt(Nt(Q[K],Q[te],W),Nt(Q[me],Q[he],W),j),Nt(Nt(Q[fe],Q[xe],W),Nt(Q[Ee],Q[Ve],W),j),V)/255*(this.premultiplied?m:1),this.g=Nt(Nt(Nt(Q[K+1],Q[te+1],W),Nt(Q[me+1],Q[he+1],W),j),Nt(Nt(Q[fe+1],Q[xe+1],W),Nt(Q[Ee+1],Q[Ve+1],W),j),V)/255*(this.premultiplied?m:1),this.b=Nt(Nt(Nt(Q[K+2],Q[te+2],W),Nt(Q[me+2],Q[he+2],W),j),Nt(Nt(Q[fe+2],Q[xe+2],W),Nt(Q[Ee+2],Q[Ve+2],W),j),V)/255*(this.premultiplied?m:1),this.a=m}else this.r=o,this.g=c,this.b=h,this.a=m}toArray(){const{r:i,g:o,b:c,a:h}=this;return[255*i,255*o,255*c,h]}toHslaArray(){let{r:i,g:o,b:c,a:h}=this;if(this.premultiplied){if(0===h)return[0,0,0,0];i/=h,o/=h,c/=h}const m=Math.min(Math.max(i,0),1),g=Math.min(Math.max(o,0),1),x=Math.min(Math.max(c,0),1),w=Math.min(m,g,x),T=Math.max(m,g,x),I=(w+T)/2;if(w===T)return[0,0,100*I,h];const A=T-w,M=I>.5?A/(2-T-w):A/(T+w);let k=0;return T===m?k=(g-x)/A+(g<x?6:0):T===g?k=(x-m)/A+2:T===x&&(k=(m-g)/A+4),k*=60,[Math.min(Math.max(k,0),360),Math.min(Math.max(100*M,0),100),Math.min(Math.max(100*I,0),100),h]}toArray01(){const{r:i,g:o,b:c,a:h}=this;return[i,o,c,h]}toArray01Scaled(i){const{r:o,g:c,b:h}=this;return[o*i,c*i,h*i]}toArray01Linear(){const{r:i,g:o,b:c,a:h}=this;return[Math.pow(i,2.2),Math.pow(o,2.2),Math.pow(c,2.2),h]}}class Vu extends Bu{constructor(i,o,c,h,m){super(i,o,c,h,m,!1)}}class Zd extends Bu{constructor(i,o,c,h,m){super(i,o,c,h,m,!0)}}function Nt(a,i,o){return a*(1-o)+i*o}function yf(a,i,o){return a.map((c,h)=>Nt(c,i[h],o))}Kn.black=new Kn(0,0,0,1),Kn.white=new Kn(1,1,1,1),Kn.transparent=new Kn(0,0,0,0),Kn.red=new Kn(1,0,0,1),Kn.blue=new Kn(0,0,1,1);var ju=Object.freeze({__proto__:null,array:yf,color:function(a,i,o){return new Kn(Nt(a.r,i.r,o),Nt(a.g,i.g,o),Nt(a.b,i.b,o),Nt(a.a,i.a,o))},number:Nt});function Rc(a,...i){for(const o of i)for(const c in o)a[c]=o[c];return a}class Hn extends Error{constructor(i,o){super(o),this.message=o,this.key=i}}class Xd{constructor(i,o=[]){this.parent=i,this.bindings={};for(const[c,h]of o)this.bindings[c]=h}concat(i){return new Xd(this,i)}get(i){if(this.bindings[i])return this.bindings[i];if(this.parent)return this.parent.get(i);throw new Error(`${i} not found in scope.`)}has(i){return!!this.bindings[i]||!!this.parent&&this.parent.has(i)}}const Oc={kind:"null"},Tt={kind:"number"},Gn={kind:"string"},Xn={kind:"boolean"},gi={kind:"color"},$l={kind:"object"},Qn={kind:"value"},Xt={kind:"collator"},Fc={kind:"formatted"},kc={kind:"resolvedImage"};function yo(a,i){return{kind:"array",itemType:a,N:i}}function Er(a){if("array"===a.kind){const i=Er(a.itemType);return"number"==typeof a.N?`array<${i}, ${a.N}>`:"value"===a.itemType.kind?"array":`array<${i}>`}return a.kind}const vv=[Oc,Tt,Gn,Xn,gi,Fc,$l,yo(Qn),kc];function ql(a,i){if("error"===i.kind)return null;if("array"===a.kind){if("array"===i.kind&&(0===i.N&&"value"===i.itemType.kind||!ql(a.itemType,i.itemType))&&("number"!=typeof a.N||a.N===i.N))return null}else{if(a.kind===i.kind)return null;if("value"===a.kind)for(const o of vv)if(!ql(o,i))return null}return`Expected ${Er(a)} but found ${Er(i)} instead.`}function Lc(a,i){return i.some(o=>o.kind===a.kind)}function vf(a,i){return i.some(o=>"null"===o?null===a:"array"===o?Array.isArray(a):"object"===o?a&&!Array.isArray(a)&&"object"==typeof a:o===typeof a)}function Zp(a,i){return"array"===a.kind&&"array"===i.kind?a.N===i.N&&Zp(a.itemType,i.itemType):a.kind===i.kind}class xf{constructor(i,o,c){this.sensitivity=i?o?"variant":"case":o?"accent":"base",this.locale=c,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(i,o){return this.collator.compare(i,o)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Xp{constructor(i,o,c,h,m){this.text=i.normalize?i.normalize():i,this.image=o,this.scale=c,this.fontStack=h,this.textColor=m}}class Kr{constructor(i){this.sections=i}static fromString(i){return new Kr([new Xp(i,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(i=>0!==i.text.length||!!i.image&&i.image.hasPrimary())}static factory(i){return i instanceof Kr?i:Kr.fromString(i)}toString(){return 0===this.sections.length?"":this.sections.map(i=>i.text).join("")}serialize(){const i=["format"];for(const o of this.sections){if(o.image){const h=o.image.getPrimary().id.toString();i.push(["image",h]);continue}i.push(o.text);const c={};o.fontStack&&(c["text-font"]=["literal",o.fontStack.split(",")]),o.scale&&(c["font-scale"]=o.scale),o.textColor&&(c["text-color"]=["rgba"].concat(o.textColor.toNonPremultipliedRenderColor(null).toArray())),i.push(c)}return i}}class pa{constructor(i,o={}){if(this.id=Jt.from(i),this.options=Object.assign({},o),o.transform){const{a:c,b:h,c:m,d:g,e:x,f:w}=o.transform;this.options.transform=new DOMMatrix([c,h,m,g,x,w])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:i,b:o,c,d:h,e:m,f:g}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:i,b:o,c,d:h,e:m,f:g}})}static parse(i){let o,c,h,m;try{({name:o,iconsetId:c,params:h,transform:m}=JSON.parse(i)||{})}catch{return null}if(!o)return null;const{a:g,b:x,c:w,d:T,e:I,f:A}=m||{};return new pa({name:o,iconsetId:c},{params:h,transform:new DOMMatrix([g,x,w,T,I,A])})}scaleSelf(i,o){return this.options.transform.scaleSelf(i,o),this}}class vo{constructor(i,o,c,h,m=!1){this.primaryId=Jt.from(i),this.primaryOptions=o,c&&(this.secondaryId=Jt.from(c)),this.secondaryOptions=h,this.available=m}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new pa(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new pa(this.secondaryId,this.secondaryOptions):null}static from(i){return"string"==typeof i?vo.build({name:i}):i}static build(i,o,c,h){return!i||"object"==typeof i&&!("name"in i)?null:new vo(i,c,o,h)}}function Nc(a,i,o,c){return"number"==typeof a&&a>=0&&a<=255&&"number"==typeof i&&i>=0&&i<=255&&"number"==typeof o&&o>=0&&o<=255?void 0===c||"number"==typeof c&&c>=0&&c<=1?null:`Invalid rgba value [${[a,i,o,c].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof c?[a,i,o,c]:[a,i,o]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function an(a){if(null===a||"string"==typeof a||"boolean"==typeof a||"number"==typeof a||a instanceof Kn||a instanceof xf||a instanceof Kr||a instanceof vo)return!0;if(Array.isArray(a)){for(const i of a)if(!an(i))return!1;return!0}if("object"==typeof a){for(const i in a)if(!an(a[i]))return!1;return!0}return!1}function bt(a){if(null===a)return Oc;if("string"==typeof a)return Gn;if("boolean"==typeof a)return Xn;if("number"==typeof a)return Tt;if(a instanceof Kn)return gi;if(a instanceof xf)return Xt;if(a instanceof Kr)return Fc;if(a instanceof vo)return kc;if(Array.isArray(a)){const i=a.length;let o;for(const c of a){const h=bt(c);if(o){if(o===h)continue;o=Qn;break}o=h}return yo(o||Qn,i)}return $l}function Vs(a){const i=typeof a;return null===a?"":"string"===i||"number"===i||"boolean"===i?String(a):a instanceof Kr||a instanceof vo||a instanceof Kn?a.toString():JSON.stringify(a)}class Vt{constructor(i,o){this.type=i,this.value=o}static parse(i,o){if(2!==i.length)return o.error(`'literal' expression requires exactly one argument, but found ${i.length-1} instead.`);if(!an(i[1]))return o.error("invalid value");const c=i[1];let h=bt(c);const m=o.expectedType;return"array"!==h.kind||0!==h.N||!m||"array"!==m.kind||"number"==typeof m.N&&0!==m.N||(h=m),new Vt(h,c)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Kn?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Kr?this.value.serialize():this.value}}class Ar{constructor(i){this.name="ExpressionEvaluationError",this.message=i}toJSON(){return this.message}}const Ys={string:Gn,number:Tt,boolean:Xn,object:$l};class Bt{constructor(i,o){this.type=i,this.args=o}static parse(i,o){if(i.length<2)return o.error("Expected at least one argument.");let c,h=1;const m=i[0];if("array"===m){let x,w;if(i.length>2){const T=i[1];if("string"!=typeof T||!(T in Ys)||"object"===T)return o.error('The item type argument of "array" must be one of string, number, boolean',1);x=Ys[T],h++}else x=Qn;if(i.length>3){if(null!==i[2]&&("number"!=typeof i[2]||i[2]<0||i[2]!==Math.floor(i[2])))return o.error('The length argument to "array" must be a positive integer literal',2);w=i[2],h++}c=yo(x,w)}else c=Ys[m];const g=[];for(;h<i.length;h++){const x=o.parse(i[h],h,Qn);if(!x)return null;g.push(x)}return new Bt(c,g)}evaluate(i){for(let o=0;o<this.args.length;o++){const c=this.args[o].evaluate(i);if(!ql(this.type,bt(c)))return c;if(o===this.args.length-1)throw new Ar(`The expression ${JSON.stringify(this.args[o].serialize())} evaluated to ${Er(bt(c))} but was expected to be of type ${Er(this.type)}.`)}return null}eachChild(i){this.args.forEach(i)}outputDefined(){return this.args.every(i=>i.outputDefined())}serialize(){const i=this.type,o=[i.kind];if("array"===i.kind){const c=i.itemType;if("string"===c.kind||"number"===c.kind||"boolean"===c.kind){o.push(c.kind);const h=i.N;("number"==typeof h||this.args.length>1)&&o.push(h)}}return o.concat(this.args.map(c=>c.serialize()))}}class gt{constructor(i){this.type=Fc,this.sections=i}static parse(i,o){if(i.length<2)return o.error("Expected at least one argument.");const c=i[1];if(!Array.isArray(c)&&"object"==typeof c)return o.error("First argument must be an image or text section.");const h=[];let m=!1;for(let g=1;g<=i.length-1;++g){const x=i[g];if(m&&"object"==typeof x&&!Array.isArray(x)){m=!1;let w=null;if(x["font-scale"]&&(w=o.parseObjectValue(x["font-scale"],g,"font-scale",Tt),!w))return null;let T=null;if(x["text-font"]&&(T=o.parseObjectValue(x["text-font"],g,"text-font",yo(Gn)),!T))return null;let I=null;if(x["text-color"]&&(I=o.parseObjectValue(x["text-color"],g,"text-color",gi),!I))return null;const A=h[h.length-1];A.scale=w,A.font=T,A.textColor=I}else{const w=o.parse(i[g],g,Qn);if(!w)return null;const T=w.type.kind;if("string"!==T&&"value"!==T&&"null"!==T&&"resolvedImage"!==T)return o.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");m=!0,h.push({content:w,scale:null,font:null,textColor:null})}}return new gt(h)}evaluate(i){return new Kr(this.sections.map(o=>{const c=o.content.evaluate(i);return Zp(bt(c),kc)?new Xp("",c,null,null,null):new Xp(Vs(c),null,o.scale?o.scale.evaluate(i):null,o.font?o.font.evaluate(i).join(","):null,o.textColor?o.textColor.evaluate(i):null)}))}eachChild(i){for(const o of this.sections)i(o.content),o.scale&&i(o.scale),o.font&&i(o.font),o.textColor&&i(o.textColor)}outputDefined(){return!1}serialize(){const i=["format"];for(const o of this.sections){i.push(o.content.serialize());const c={};o.scale&&(c["font-scale"]=o.scale.serialize()),o.font&&(c["text-font"]=o.font.serialize()),o.textColor&&(c["text-color"]=o.textColor.serialize()),i.push(c)}return i}}class zc{constructor(i,o,c,h){this._imageWarnHistory={},this.type=kc,this.namePrimary=i,this.nameSecondary=o,c&&(this.paramsPrimary=c.params,this.iconsetIdPrimary=c.iconset?c.iconset.id:void 0),h&&(this.paramsSecondary=h.params,this.iconsetIdSecondary=h.iconset?h.iconset.id:void 0)}static parse(i,o){if(i.length<2)return o.error("Expected two or more arguments.");let c=1;const h=[];function m(){if(c<i.length){const x=o.parse(i[c],c++,Gn);return x?(h.push({image:x,options:{}}),!0):(o.error(h.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function g(){if(c<i.length){const w=i[c];if(null===(x=w)||"object"!=typeof x||Array.isArray(x))return!0;const T=w.params,I=w.iconset,A=o.concat(c);if(!T&&!I)return c++,!0;if(T){if("object"!=typeof T||T.constructor!==Object)return A.error('Image options "params" should be an object'),!1;const M={},k=A.concat(void 0,"params");for(const L in T){if(!L)return k.error("Image parameter name should be non-empty"),!1;const V=k.concat(void 0,L).parse(T[L],void 0,gi,void 0,{typeAnnotation:"coerce"});if(!V)return!1;M[L]=V}h[h.length-1].options.params=M}if(I){if("object"!=typeof I||I.constructor!==Object)return A.error('Image options "iconset" should be an object'),!1;if(!I.id)return A.error('Image options "iconset" should have an "id" property'),!1;h[h.length-1].options.iconset=I}return c++,!0}var x;return!0}for(let x=0;x<2;x++)if(!m()||!g())return;return new zc(h[0].image,h[1]?h[1].image:void 0,h[0].options,h[1]?h[1].options:void 0)}evaluateParams(i,o){const c={};if(o){for(const h in o)if(o[h])try{c[h]=o[h].evaluate(i)}catch{continue}if(0!==Object.keys(c).length)return{params:c}}}evaluate(i){const o={name:this.namePrimary.evaluate(i),iconsetId:this.iconsetIdPrimary},c=this.nameSecondary?{name:this.nameSecondary.evaluate(i),iconsetId:this.iconsetIdSecondary}:void 0,h=vo.build(o,c,this.paramsPrimary?this.evaluateParams(i,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(i,this.paramsSecondary):void 0);if(h&&i.availableImages){const m=h.getPrimary().id;if(h.available=i.availableImages.some(g=>Jt.isEqual(g,m)),h.available){const g=h.getSecondary()?h.getSecondary().id:null;g&&(h.available=i.availableImages.some(x=>Jt.isEqual(x,g)))}}return h}eachChild(i){if(i(this.namePrimary),this.paramsPrimary)for(const o in this.paramsPrimary)this.paramsPrimary[o]&&i(this.paramsPrimary[o]);if(this.nameSecondary&&(i(this.nameSecondary),this.paramsSecondary))for(const o in this.paramsSecondary)this.paramsSecondary[o]&&i(this.paramsSecondary[o])}outputDefined(){return!1}serializeOptions(i,o){const c={};if(o&&(c.iconset={id:o}),i){c.params={};for(const h in i)i[h]&&(c.params[h]=i[h].serialize())}return Object.keys(c).length>0?c:void 0}serialize(){const i=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const o=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);o&&i.push(o)}if(this.nameSecondary&&(i.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const o=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);o&&i.push(o)}return i}}function ui(a){return a instanceof Number?"number":a instanceof String?"string":a instanceof Boolean?"boolean":Array.isArray(a)?"array":null===a?"null":typeof a}const Yd={"to-boolean":Xn,"to-color":gi,"to-number":Tt,"to-string":Gn};class bs{constructor(i,o){this.type=i,this.args=o}static parse(i,o){if(i.length<2)return o.error("Expected at least one argument.");const c=i[0],h=[];let m=Oc;if("to-array"===c){if(!Array.isArray(i[1]))return null;const g=i[1].length;if(o.expectedType){if("array"!==o.expectedType.kind)return o.error(`Expected ${o.expectedType.kind} but found array.`);m=yo(o.expectedType.itemType,g)}else{if(!(g>0&&an(i[1][0])))return null;m=yo(bt(i[1][0]),g)}for(let x=0;x<g;x++){const w=i[1][x];let T;if("array"===ui(w))T=o.parse(w,void 0,m.itemType);else{const I=ui(w);if(I!==m.itemType.kind)return o.error(`Expected ${m.itemType.kind} but found ${I}.`);T=o.registry.literal.parse(["literal",void 0===w?null:w],o)}if(!T)return null;h.push(T)}}else{if(("to-boolean"===c||"to-string"===c)&&2!==i.length)return o.error("Expected one argument.");m=Yd[c];for(let g=1;g<i.length;g++){const x=o.parse(i[g],g,Qn);if(!x)return null;h.push(x)}}return new bs(m,h)}evaluate(i){if("boolean"===this.type.kind)return!!this.args[0].evaluate(i);if("color"===this.type.kind){let o,c;for(const h of this.args){if(o=h.evaluate(i),c=null,o instanceof Kn)return o;if("string"==typeof o){const m=i.parseColor(o);if(m)return m}else if(Array.isArray(o)&&(c=o.length<3||o.length>4?`Invalid rbga value ${JSON.stringify(o)}: expected an array containing either three or four numeric values.`:Nc(o[0],o[1],o[2],o[3]),!c))return new Kn(o[0]/255,o[1]/255,o[2]/255,o[3])}throw new Ar(c||`Could not parse color from value '${"string"==typeof o?o:String(JSON.stringify(o))}'`)}if("number"===this.type.kind){let o=null;for(const c of this.args){if(o=c.evaluate(i),null===o)return 0;const h=Number(o);if(!isNaN(h))return h}throw new Ar(`Could not convert ${JSON.stringify(o)} to number.`)}return"formatted"===this.type.kind?Kr.fromString(Vs(this.args[0].evaluate(i))):"resolvedImage"===this.type.kind?vo.build(Vs(this.args[0].evaluate(i))):"array"===this.type.kind?this.args.map(o=>o.evaluate(i)):Vs(this.args[0].evaluate(i))}eachChild(i){this.args.forEach(i)}outputDefined(){return this.args.every(i=>i.outputDefined())}serialize(){if("formatted"===this.type.kind)return new gt([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new zc(this.args[0]).serialize();const i="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild(o=>{i.push(o.serialize())}),i}}const Qr=["Unknown","Point","LineString","Polygon"];class Kd{constructor(i,o){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=i,this.options=o}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Qr[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(i){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const i=this.featureDistanceData.center,o=this.featureDistanceData.scale,{x:c,y:h}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(c*o-i[0])+this.featureDistanceData.bearing[1]*(h*o-i[1])}return 0}parseColor(i){let o=this._parseColorCache[i];return o||(o=this._parseColorCache[i]=Kn.parse(i)),o}getConfig(i){return this.options?this.options.get(i):null}}class Jr{constructor(i,o,c,h,m){this.name=i,this.type=o,this._evaluate=c,this.args=h,this._overloadIndex=m}evaluate(i){if(!this._evaluate){const o=Jr.definitions[this.name];this._evaluate=Array.isArray(o)?o[2]:o.overloads[this._overloadIndex][1]}return this._evaluate(i,this.args)}eachChild(i){this.args.forEach(i)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(i=>i.serialize()))}static parse(i,o){const c=i[0],h=Jr.definitions[c];if(!h)return o.error(`Unknown expression "${c}". If you wanted a literal array, use ["literal", [...]].`,0);const m=Array.isArray(h)?h[0]:h.type,g=Array.isArray(h)?[[h[1],h[2]]]:h.overloads,x=[];let w=null,T=-1;for(const[I,A]of g){if(Array.isArray(I)&&I.length!==i.length-1)continue;x.push(I),T++,w=new rh(o.registry,o.path,null,o.scope,void 0,o._scope,o.options);const M=[];let k=!1;for(let L=1;L<i.length;L++){const V=i[L],j=Array.isArray(I)?I[L-1]:I.type,W=w.parse(V,1+M.length,j);if(!W){k=!0;break}M.push(W)}if(!k)if(Array.isArray(I)&&I.length!==M.length)w.error(`Expected ${I.length} arguments, but found ${M.length} instead.`);else{for(let L=0;L<M.length;L++){const V=Array.isArray(I)?I[L]:I.type,j=M[L];w.concat(L+1).checkSubtype(V,j.type)}if(0===w.errors.length)return new Jr(c,m,A,M,T)}}if(1===x.length)o.errors.push(...w.errors);else{const I=(x.length?x:g.map(([M])=>M)).map(Yp).join(" | "),A=[];for(let M=1;M<i.length;M++){const k=o.parse(i[M],1+A.length);if(!k)return null;A.push(Er(k.type))}o.error(`Expected arguments of type ${I}, but found (${A.join(", ")}) instead.`)}return null}static register(i,o){Jr.definitions=o;for(const c in o)i[c]=Jr}}function Yp(a){return Array.isArray(a)?`(${a.map(Er).join(", ")})`:`(${Er(a.type)}...)`}class xo{constructor(i,o,c){this.type=Xt,this.locale=c,this.caseSensitive=i,this.diacriticSensitive=o}static parse(i,o){if(2!==i.length)return o.error("Expected one argument.");const c=i[1];if("object"!=typeof c||Array.isArray(c))return o.error("Collator options argument must be an object.");const h=void 0===c["case-sensitive"]?o.parse(!1,1,Xn):o.parseObjectValue(c["case-sensitive"],1,"case-sensitive",Xn);if(!h)return null;const m=void 0===c["diacritic-sensitive"]?o.parse(!1,1,Xn):o.parseObjectValue(c["diacritic-sensitive"],1,"diacritic-sensitive",Xn);if(!m)return null;let g=null;return c.locale&&(g=o.parseObjectValue(c.locale,1,"locale",Gn),!g)?null:new xo(h,m,g)}evaluate(i){return new xf(this.caseSensitive.evaluate(i),this.diacriticSensitive.evaluate(i),this.locale?this.locale.evaluate(i):null)}eachChild(i){i(this.caseSensitive),i(this.diacriticSensitive),this.locale&&i(this.locale)}outputDefined(){return!1}serialize(){const i={};return i["case-sensitive"]=this.caseSensitive.serialize(),i["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(i.locale=this.locale.serialize()),["collator",i]}}function eo(a,i,o=0,c=a.length-1,h=Oa){for(;c>o;){if(c-o>600){const w=c-o+1,T=i-o+1,I=Math.log(w),A=.5*Math.exp(2*I/3),M=.5*Math.sqrt(I*A*(w-A)/w)*(T-w/2<0?-1:1);eo(a,i,Math.max(o,Math.floor(i-T*A/w+M)),Math.min(c,Math.floor(i+(w-T)*A/w+M)),h)}const m=a[i];let g=o,x=c;for(Go(a,o,i),h(a[c],m)>0&&Go(a,o,c);g<x;){for(Go(a,g,x),g++,x--;h(a[g],m)<0;)g++;for(;h(a[x],m)>0;)x--}0===h(a[o],m)?Go(a,o,x):(x++,Go(a,x,c)),x<=i&&(o=x+1),i<=x&&(c=x-1)}}function Go(a,i,o){const c=a[i];a[i]=a[o],a[o]=c}function Oa(a,i){return a<i?-1:a>i?1:0}function qi(a){let i=0;for(let o,c,h=0,m=a.length,g=m-1;h<m;g=h++)o=a[h],c=a[g],i+=(c.x-o.x)*(o.y+c.y);return i}function ma(a,i){a[0]=Math.min(a[0],i[0]),a[1]=Math.min(a[1],i[1]),a[2]=Math.max(a[2],i[0]),a[3]=Math.max(a[3],i[1])}function Wl(a,i){return!(a[0]<=i[0]||a[2]>=i[2]||a[1]<=i[1]||a[3]>=i[3])}function nl(a,i,o){const c=a[0]-i[0],h=a[1]-i[1],m=a[0]-o[0],g=a[1]-o[1];return c*g-m*h==0&&c*m<=0&&h*g<=0}function Bc(a,i,o=!1){let c=!1;for(let x=0,w=i.length;x<w;x++){const T=i[x];for(let I=0,A=T.length,M=A-1;I<A;M=I++){const k=T[M],L=T[I];if(nl(a,k,L))return o;(m=k)[1]>(h=a)[1]!=(g=L)[1]>h[1]&&h[0]<(g[0]-m[0])*(h[1]-m[1])/(g[1]-m[1])+m[0]&&(c=!c)}}var h,m,g;return c}function Fa(a,i,o,c){const h=c[0]-o[0],m=c[1]-o[1],g=(a[0]-o[0])*m-h*(a[1]-o[1]),x=(i[0]-o[0])*m-h*(i[1]-o[1]);return g>0&&x<0||g<0&&x>0}function Zl(a,i,o,c){return(h=[c[0]-o[0],c[1]-o[1]])[0]*(m=[i[0]-a[0],i[1]-a[1]])[1]-h[1]*m[0]!=0&&!(!Fa(a,i,o,c)||!Fa(o,c,a,i));var h,m}function bf(a){const i=new Je(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),o=new Je(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const c of a[0])i.x>c.x&&(i.x=c.x),i.y>c.y&&(i.y=c.y),o.x<c.x&&(o.x=c.x),o.y<c.y&&(o.y=c.y);return{min:i,max:o}}const il=8192;function Kp(a,i){const o=(180+a[0])/360,c=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+a[1]*Math.PI/360)))/360,h=Math.pow(2,i.z);return[Math.round(o*h*il),Math.round(c*h*il)]}function Qp(a,i){for(let o=0;o<i.length;o++)if(Bc(a,i[o]))return!0;return!1}function Jg(a,i,o){for(const c of o)for(let h=0,m=c.length,g=m-1;h<m;g=h++)if(Zl(a,i,c[g],c[h]))return!0;return!1}function Uu(a,i){for(let o=0;o<a.length;++o)if(!Bc(a[o],i))return!1;for(let o=0;o<a.length-1;++o)if(Jg(a[o],a[o+1],i))return!1;return!0}function Jp(a,i){for(let o=0;o<i.length;o++)if(Uu(a,i[o]))return!0;return!1}function wf(a,i,o){const c=[];for(let h=0;h<a.length;h++){const m=[];for(let g=0;g<a[h].length;g++){const x=Kp(a[h][g],o);ma(i,x),m.push(x)}c.push(m)}return c}function Xl(a,i,o){const c=[];for(let h=0;h<a.length;h++){const m=wf(a[h],i,o);c.push(m)}return c}function em(a,i,o,c){if(a[0]<o[0]||a[0]>o[2]){const h=.5*c;let m=a[0]-o[0]>h?-c:o[0]-a[0]>h?c:0;0===m&&(m=a[0]-o[2]>h?-c:o[2]-a[0]>h?c:0),a[0]+=m}ma(i,a)}function e_(a,i,o,c){const h=Math.pow(2,c.z)*il,m=[c.x*il,c.y*il],g=[];if(!a)return g;for(const x of a)for(const w of x){const T=[w.x+m[0],w.y+m[1]];em(T,i,o,h),g.push(T)}return g}function Ef(a,i,o,c){const h=Math.pow(2,c.z)*il,m=[c.x*il,c.y*il],g=[];if(!a)return g;for(const w of a){const T=[];for(const I of w){const A=[I.x+m[0],I.y+m[1]];ma(i,A),T.push(A)}g.push(T)}if(i[2]-i[0]<=h/2){(x=i)[0]=x[1]=1/0,x[2]=x[3]=-1/0;for(const w of g)for(const T of w)em(T,i,o,h)}var x;return g}class bo{constructor(i,o){this.type=Xn,this.geojson=i,this.geometries=o}static parse(i,o){if(2!==i.length)return o.error(`'within' expression requires exactly one argument, but found ${i.length-1} instead.`);if(an(i[1])){const c=i[1];if("FeatureCollection"===c.type)for(let h=0;h<c.features.length;++h){const m=c.features[h].geometry.type;if("Polygon"===m||"MultiPolygon"===m)return new bo(c,c.features[h].geometry)}else if("Feature"===c.type){const h=c.geometry.type;if("Polygon"===h||"MultiPolygon"===h)return new bo(c,c.geometry)}else if("Polygon"===c.type||"MultiPolygon"===c.type)return new bo(c,c)}return o.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(i){if(null!=i.geometry()&&null!=i.canonicalID()){if("Point"===i.geometryType())return function(o,c){const h=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],g=o.canonicalID();if(!g)return!1;if("Polygon"===c.type){const x=wf(c.coordinates,m,g),w=e_(o.geometry(),h,m,g);if(!Wl(h,m))return!1;for(const T of w)if(!Bc(T,x))return!1}if("MultiPolygon"===c.type){const x=Xl(c.coordinates,m,g),w=e_(o.geometry(),h,m,g);if(!Wl(h,m))return!1;for(const T of w)if(!Qp(T,x))return!1}return!0}(i,this.geometries);if("LineString"===i.geometryType())return function(o,c){const h=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],g=o.canonicalID();if(!g)return!1;if("Polygon"===c.type){const x=wf(c.coordinates,m,g),w=Ef(o.geometry(),h,m,g);if(!Wl(h,m))return!1;for(const T of w)if(!Uu(T,x))return!1}if("MultiPolygon"===c.type){const x=Xl(c.coordinates,m,g),w=Ef(o.geometry(),h,m,g);if(!Wl(h,m))return!1;for(const T of w)if(!Jp(T,x))return!1}return!0}(i,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Qd={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},js=1/298.257223563,tm=js*(2-js),Hu=Math.PI/180;class Gu{static fromTile(i,o,c){const h=Math.PI*(1-2*(i+.5)/Math.pow(2,o)),m=Math.atan(.5*(Math.exp(h)-Math.exp(-h)))/Hu;return new Gu(m,c)}static get units(){return Qd}constructor(i,o){if(void 0===i)throw new Error("No latitude given.");if(o&&!Qd[o])throw new Error(`Unknown unit ${o}. Use one of: ${Object.keys(Qd).join(", ")}`);const c=6378.137*Hu*(o?Qd[o]:1),h=Math.cos(i*Hu),m=1/(1-tm*(1-h*h)),g=Math.sqrt(m);this.kx=c*g*h,this.ky=c*g*m*(1-tm)}distance(i,o){const c=Us(i[0]-o[0])*this.kx,h=(i[1]-o[1])*this.ky;return Math.sqrt(c*c+h*h)}bearing(i,o){const c=Us(o[0]-i[0])*this.kx;return Math.atan2(c,(o[1]-i[1])*this.ky)/Hu}destination(i,o,c){const h=c*Hu;return this.offset(i,Math.sin(h)*o,Math.cos(h)*o)}offset(i,o,c){return[i[0]+o/this.kx,i[1]+c/this.ky]}lineDistance(i){let o=0;for(let c=0;c<i.length-1;c++)o+=this.distance(i[c],i[c+1]);return o}area(i){let o=0;for(let c=0;c<i.length;c++){const h=i[c];for(let m=0,g=h.length,x=g-1;m<g;x=m++)o+=Us(h[m][0]-h[x][0])*(h[m][1]+h[x][1])*(c?-1:1)}return Math.abs(o)/2*this.kx*this.ky}along(i,o){let c=0;if(o<=0)return i[0];for(let h=0;h<i.length-1;h++){const m=i[h],g=i[h+1],x=this.distance(m,g);if(c+=x,c>o)return Jd(m,g,(o-(c-x))/x)}return i[i.length-1]}pointToSegmentDistance(i,o,c){let[h,m]=o,g=Us(c[0]-h)*this.kx,x=(c[1]-m)*this.ky;if(0!==g||0!==x){const w=(Us(i[0]-h)*this.kx*g+(i[1]-m)*this.ky*x)/(g*g+x*x);w>1?(h=c[0],m=c[1]):w>0&&(h+=g/this.kx*w,m+=x/this.ky*w)}return g=Us(i[0]-h)*this.kx,x=(i[1]-m)*this.ky,Math.sqrt(g*g+x*x)}pointOnLine(i,o){let c=1/0,h=i[0][0],m=i[0][1],g=0,x=0;for(let w=0;w<i.length-1;w++){let T=i[w][0],I=i[w][1],A=Us(i[w+1][0]-T)*this.kx,M=(i[w+1][1]-I)*this.ky,k=0;0===A&&0===M||(k=(Us(o[0]-T)*this.kx*A+(o[1]-I)*this.ky*M)/(A*A+M*M),k>1?(T=i[w+1][0],I=i[w+1][1]):k>0&&(T+=A/this.kx*k,I+=M/this.ky*k)),A=Us(o[0]-T)*this.kx,M=(o[1]-I)*this.ky;const L=A*A+M*M;L<c&&(c=L,h=T,m=I,g=w,x=k)}return{point:[h,m],index:g,t:Math.max(0,Math.min(1,x))}}lineSlice(i,o,c){let h=this.pointOnLine(c,i),m=this.pointOnLine(c,o);if(h.index>m.index||h.index===m.index&&h.t>m.t){const T=h;h=m,m=T}const g=[h.point],x=h.index+1,w=m.index;!nm(c[x],g[0])&&x<=w&&g.push(c[x]);for(let T=x+1;T<=w;T++)g.push(c[T]);return nm(c[w],m.point)||g.push(m.point),g}lineSliceAlong(i,o,c){let h=0;const m=[];for(let g=0;g<c.length-1;g++){const x=c[g],w=c[g+1],T=this.distance(x,w);if(h+=T,h>i&&0===m.length&&m.push(Jd(x,w,(i-(h-T))/T)),h>=o)return m.push(Jd(x,w,(o-(h-T))/T)),m;h>i&&m.push(w)}return m}bufferPoint(i,o){const c=o/this.ky,h=o/this.kx;return[i[0]-h,i[1]-c,i[0]+h,i[1]+c]}bufferBBox(i,o){const c=o/this.ky,h=o/this.kx;return[i[0]-h,i[1]-c,i[2]+h,i[3]+c]}insideBBox(i,o){return Us(i[0]-o[0])>=0&&Us(i[0]-o[2])<=0&&i[1]>=o[1]&&i[1]<=o[3]}}function nm(a,i){return a[0]===i[0]&&a[1]===i[1]}function Jd(a,i,o){const c=Us(i[0]-a[0]);return[a[0]+c*o,a[1]+(i[1]-a[1])*o]}function Us(a){for(;a<-180;)a+=360;for(;a>180;)a-=360;return a}class Tf{constructor(i=[],o=((c,h)=>c<h?-1:c>h?1:0)){if(this.data=i,this.length=this.data.length,this.compare=o,this.length>0)for(let c=(this.length>>1)-1;c>=0;c--)this._down(c)}push(i){this.data.push(i),this._up(this.length++)}pop(){if(0===this.length)return;const i=this.data[0],o=this.data.pop();return--this.length>0&&(this.data[0]=o,this._down(0)),i}peek(){return this.data[0]}_up(i){const{data:o,compare:c}=this,h=o[i];for(;i>0;){const m=i-1>>1,g=o[m];if(c(h,g)>=0)break;o[i]=g,i=m}o[i]=h}_down(i){const{data:o,compare:c}=this,h=this.length>>1,m=o[i];for(;i<h;){let g=1+(i<<1);const x=g+1;if(x<this.length&&c(o[x],o[g])<0&&(g=x),c(o[g],m)>=0)break;o[i]=o[g],i=g}o[i]=m}}var ht=8192;function Yl(a,i){return i.dist-a.dist}const Df=100,Sf=50;function eh(a){const i=[1/0,1/0,-1/0,-1/0];if(i.length!==a.length)return!1;for(let o=0;o<i.length;o++)if(i[o]!==a[o])return!1;return!0}function _r(a){return a[1]-a[0]+1}function Ks(a,i){const o=a[1]>=a[0]&&a[1]<i;return o||console.warn("Distance Expression: Index is out of range"),o}function th(a,i){if(a[0]>a[1])return[null,null];const o=_r(a);if(i){if(2===o)return[a,null];const c=Math.floor(o/2);return[[a[0],a[0]+c],[a[0]+c,a[1]]]}{if(1===o)return[a,null];const c=Math.floor(o/2)-1;return[[a[0],a[0]+c],[a[0]+c+1,a[1]]]}}function Dn(a,i){const o=[1/0,1/0,-1/0,-1/0];if(!Ks(i,a.length))return o;for(let c=i[0];c<=i[1];++c)ma(o,a[c]);return o}function wo(a){const i=[1/0,1/0,-1/0,-1/0];for(let o=0;o<a.length;++o)for(let c=0;c<a[o].length;++c)ma(i,a[o][c]);return i}function Jn(a,i,o){if(eh(a)||eh(i))return NaN;let c=0,h=0;return a[2]<i[0]&&(c=i[0]-a[2]),a[0]>i[2]&&(c=a[0]-i[2]),a[1]>i[3]&&(h=a[1]-i[3]),a[3]<i[1]&&(h=i[1]-a[3]),o.distance([0,0],[c,h])}function nn(a){return 360*a-180}function os(a){return 360/Math.PI*Math.atan(Math.exp((180-360*a)*Math.PI/180))-90}function Vc(a,i){const o=Math.pow(2,i.z),c=(a.y/ht+i.y)/o;return[nn((a.x/ht+i.x)/o),os(c)]}function Hs(a,i){const o=[];for(let c=0;c<a.length;++c)o.push(Vc(a[c],i));return o}function Cf(a,i,o){const c=o.pointOnLine(i,a).point;return o.distance(a,c)}function im(a,i,o,c,h){const m=o.slice(c[0],c[1]+1);let g=1/0;for(let x=i[0];x<=i[1];++x)if(0===(g=Math.min(g,Cf(a[x],m,h))))return 0;return g}function Ii(a,i,o,c,h){const m=Math.min(h.pointToSegmentDistance(a,o,c),h.pointToSegmentDistance(i,o,c)),g=Math.min(h.pointToSegmentDistance(o,a,i),h.pointToSegmentDistance(c,a,i));return Math.min(m,g)}function xv(a,i,o,c,h){if(!Ks(i,a.length)||!Ks(c,o.length))return NaN;let m=1/0;for(let g=i[0];g<i[1];++g)for(let x=c[0];x<c[1];++x){if(Zl(a[g],a[g+1],o[x],o[x+1]))return 0;m=Math.min(m,Ii(a[g],a[g+1],o[x],o[x+1],h))}return m}function bv(a,i,o,c,h){if(!Ks(i,a.length)||!Ks(c,o.length))return NaN;let m=1/0;for(let g=i[0];g<=i[1];++g)for(let x=c[0];x<=c[1];++x)if(0===(m=Math.min(m,h.distance(a[g],o[x]))))return m;return m}function zr(a,i,o){if(Bc(a,i,!0))return 0;let c=1/0;for(const h of i){const m=h.length;if(m<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(h[0]!==h[m-1]&&0===(c=Math.min(c,o.pointToSegmentDistance(a,h[m-1],h[0])))||0===(c=Math.min(c,Cf(a,h,o))))return c}return c}function Qt(a,i,o,c){if(!Ks(i,a.length))return NaN;for(let m=i[0];m<=i[1];++m)if(Bc(a[m],o,!0))return 0;let h=1/0;for(let m=i[0];m<i[1];++m)for(const g of o)for(let x=0,w=g.length,T=w-1;x<w;T=x++){if(Zl(a[m],a[m+1],g[T],g[x]))return 0;h=Math.min(h,Ii(a[m],a[m+1],g[T],g[x],c))}return h}function ei(a,i){for(const o of a)for(let c=0;c<=o.length-1;++c)if(Bc(o[c],i,!0))return!0;return!1}function Or(a,i,o,c=1/0){const h=wo(a),m=wo(i);if(c!==1/0&&Jn(h,m,o)>=c)return c;if(Wl(h,m)){if(ei(a,i))return 0}else if(ei(i,a))return 0;let g=c;for(const x of a)for(let w=0,T=x.length,I=T-1;w<T;I=w++)for(const A of i)for(let M=0,k=A.length,L=k-1;M<k;L=M++){if(Zl(x[I],x[w],A[L],A[M]))return 0;g=Math.min(g,Ii(x[I],x[w],A[L],A[M],o))}return g}function ws(a,i,o,c,h,m,g){if(null===m||null===g)return;const x=Jn(Dn(c,m),Dn(h,g),o);x<i&&a.push({dist:x,range1:m,range2:g})}function nh(a,i,o,c,h=1/0){let m=Math.min(c.distance(a[0],o[0][0]),h);if(0===m)return m;const g=new Tf([{dist:0,range1:[0,a.length-1],range2:[0,0]}],Yl),x=i?Sf:Df,w=wo(o);for(;g.length;){const T=g.pop();if(T.dist>=m)continue;const I=T.range1;if(_r(I)<=x){if(!Ks(I,a.length))return NaN;if(i){const A=Qt(a,I,o,c);if(0===(m=Math.min(m,A)))return m}else for(let A=I[0];A<=I[1];++A){const M=zr(a[A],o,c);if(0===(m=Math.min(m,M)))return m}}else{const A=th(I,i);if(null!==A[0]){const M=Jn(Dn(a,A[0]),w,c);M<m&&g.push({dist:M,range1:A[0],range2:[0,0]})}if(null!==A[1]){const M=Jn(Dn(a,A[1]),w,c);M<m&&g.push({dist:M,range1:A[1],range2:[0,0]})}}}return m}function Ro(a,i,o,c,h,m=1/0){let g=Math.min(m,h.distance(a[0],o[0]));if(0===g)return g;const x=new Tf([{dist:0,range1:[0,a.length-1],range2:[0,o.length-1]}],Yl),w=i?Sf:Df,T=c?Sf:Df;for(;x.length;){const I=x.pop();if(I.dist>=g)continue;const A=I.range1,M=I.range2;if(_r(A)<=w&&_r(M)<=T){if(!Ks(A,a.length)||!Ks(M,o.length))return NaN;if(i&&c?g=Math.min(g,xv(a,A,o,M,h)):i||c?i&&!c?g=Math.min(g,im(o,M,a,A,h)):!i&&c&&(g=Math.min(g,im(a,A,o,M,h))):g=Math.min(g,bv(a,A,o,M,h)),0===g)return g}else{const k=th(A,i),L=th(M,c);ws(x,g,h,a,o,k[0],L[0]),ws(x,g,h,a,o,k[0],L[1]),ws(x,g,h,a,o,k[1],L[0]),ws(x,g,h,a,o,k[1],L[1])}}return g}function Kl(a,i,o,c,h=1/0){let m=h;const g=Dn(a,[0,a.length-1]);for(const x of o)if(!(m!==1/0&&Jn(g,Dn(x,[0,x.length-1]),c)>=m)&&(m=Math.min(m,Ro(a,i,x,!0,c,m)),0===m))return m;return m}function Fr(a,i,o,c,h=1/0){let m=h;const g=Dn(a,[0,a.length-1]);for(const x of o){if(m!==1/0&&Jn(g,wo(x),c)>=m)continue;const w=nh(a,i,x,c,m);if(isNaN(w))return w;if(0===(m=Math.min(m,w)))return m}return m}function ka(a){return"Point"===a||"MultiPoint"===a||"LineString"===a||"MultiLineString"===a||"Polygon"===a||"MultiPolygon"===a}class Qs{constructor(i,o){this.type=Tt,this.geojson=i,this.geometries=o}static parse(i,o){if(2!==i.length)return o.error(`'distance' expression requires either one argument, but found ' ${i.length-1} instead.`);if(an(i[1])){const c=i[1];if("FeatureCollection"===c.type){for(let h=0;h<c.features.length;++h)if(ka(c.features[h].geometry.type))return new Qs(c,c.features[h].geometry)}else if("Feature"===c.type){if(ka(c.geometry.type))return new Qs(c,c.geometry)}else if(ka(c.type))return new Qs(c,c)}return o.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(i){const o=i.geometry(),c=i.canonicalID();if(null!=o&&null!=c){if("Point"===i.geometryType())return function(h,m,g){const x=[];for(const T of h)for(const I of T)x.push(Vc(I,m));const w=new Gu(x[0][1],"meters");return"Point"===g.type||"MultiPoint"===g.type||"LineString"===g.type?Ro(x,!1,"Point"===g.type?[g.coordinates]:g.coordinates,"LineString"===g.type,w):"MultiLineString"===g.type?Kl(x,!1,g.coordinates,w):"Polygon"===g.type||"MultiPolygon"===g.type?Fr(x,!1,"Polygon"===g.type?[g.coordinates]:g.coordinates,w):null}(o,c,this.geometries);if("LineString"===i.geometryType())return function(h,m,g){const x=[];for(const T of h){const I=[];for(const A of T)I.push(Vc(A,m));x.push(I)}const w=new Gu(x[0][0][1],"meters");if("Point"===g.type||"MultiPoint"===g.type||"LineString"===g.type)return Kl("Point"===g.type?[g.coordinates]:g.coordinates,"LineString"===g.type,x,w);if("MultiLineString"===g.type){let T=1/0;for(let I=0;I<g.coordinates.length;I++){const A=Kl(g.coordinates[I],!0,x,w,T);if(isNaN(A))return A;if(0===(T=Math.min(T,A)))return T}return T}if("Polygon"===g.type||"MultiPolygon"===g.type){let T=1/0;for(let I=0;I<x.length;I++){const A=Fr(x[I],!0,"Polygon"===g.type?[g.coordinates]:g.coordinates,w,T);if(isNaN(A))return A;if(0===(T=Math.min(T,A)))return T}return T}return null}(o,c,this.geometries);if("Polygon"===i.geometryType())return function(h,m,g){const x=[];for(const T of function(I,A){const M=I.length;if(M<=1)return[I];const k=[];let L,V;for(let j=0;j<M;j++){const W=qi(I[j]);0!==W&&(I[j].area=Math.abs(W),void 0===V&&(V=W<0),V===W<0?(L&&k.push(L),L=[I[j]]):L.push(I[j]))}return L&&k.push(L),k}(h)){const I=[];for(let A=0;A<T.length;++A)I.push(Hs(T[A],m));x.push(I)}const w=new Gu(x[0][0][0][1],"meters");if("Point"===g.type||"MultiPoint"===g.type||"LineString"===g.type)return Fr("Point"===g.type?[g.coordinates]:g.coordinates,"LineString"===g.type,x,w);if("MultiLineString"===g.type){let T=1/0;for(let I=0;I<g.coordinates.length;I++){const A=Fr(g.coordinates[I],!0,x,w,T);if(isNaN(A))return A;if(0===(T=Math.min(T,A)))return T}return T}return"Polygon"===g.type||"MultiPolygon"===g.type?function(T,I,A){let M=1/0;for(const k of T)for(const L of I){const V=Or(k,L,A,M);if(isNaN(V))return V;if(0===(M=Math.min(M,V)))return M}return M}("Polygon"===g.type?[g.coordinates]:g.coordinates,x,w):null}(o,c,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function Fn(a){if(a instanceof Jr&&("get"===a.name&&1===a.args.length||"feature-state"===a.name||"has"===a.name&&1===a.args.length||"properties"===a.name||"geometry-type"===a.name||"id"===a.name||/^filter-/.test(a.name))||a instanceof bo||a instanceof Qs)return!1;if(a instanceof ss)return a.featureConstant;let i=!0;return a.eachChild(o=>{i&&!Fn(o)&&(i=!1)}),i}function Ql(a){if(a instanceof Jr&&"feature-state"===a.name)return!1;let i=!0;return a.eachChild(o=>{i&&!Ql(o)&&(i=!1)}),i}function ih(a){if(a instanceof ss)return new Set([a.key]);let i=new Set;return a.eachChild(o=>{i=new Set([...i,...ih(o)])}),i}function ga(a,i){if(a instanceof Jr&&i.indexOf(a.name)>=0)return!1;let o=!0;return a.eachChild(c=>{o&&!ga(c,i)&&(o=!1)}),o}function Br(a,i,o){return[a,i,o].filter(Boolean).join("\x1f")}function jc(a,i){switch(a){case"string":return Vs(i);case"number":return+i;case"boolean":return!!i;case"color":return Kn.parse(i);case"formatted":return Kr.fromString(Vs(i));case"resolvedImage":return vo.build(Vs(i))}return i}function Uc(a,i,o,c){return void 0!==c&&(a=c*Math.round(a/c)),void 0!==i&&a<i&&(a=i),void 0!==o&&a>o&&(a=o),a}class ss{constructor(i,o,c,h=!1){this.type=i,this.key=o,this.scope=c,this.featureConstant=h}static parse(i,o){let c=o.expectedType;if(null==c&&(c=Qn),i.length<2||i.length>3)return o.error("Invalid number of arguments for 'config' expression.");const h=o.parse(i[1],1);if(!(h instanceof Vt))return o.error("Key name of 'config' expression must be a string literal.");let m,g=!0;const x=Vs(h.value);if(i.length>=3){const w=o.parse(i[2],2);if(!(w instanceof Vt))return o.error("Scope of 'config' expression must be a string literal.");m=Vs(w.value)}if(o.options){const w=Br(x,m,o._scope),T=o.options.get(w);T&&(g=Fn(T.value||T.default))}return new ss(c,x,m,g)}evaluate(i){const o=Br(this.key,this.scope,i.scope),c=i.getConfig(o);if(!c)return null;const{type:h,value:m,values:g,minValue:x,maxValue:w,stepValue:T}=c,I=c.default.evaluate(i);let A=I;if(m){const M=i.scope;i.scope=(M||"").split("\x1f").slice(1).join("\x1f"),A=m.evaluate(i),i.scope=M}return h&&(A=jc(h,A)),void 0===A||void 0===x&&void 0===w&&void 0===T||("number"==typeof A?A=Uc(A,x,w,T):Array.isArray(A)&&(A=A.map(M=>"number"==typeof M?Uc(M,x,w,T):M))),void 0!==m&&void 0!==A&&g&&!g.includes(A)&&(A=I,h&&(A=jc(h,A))),(h&&h!==this.type||void 0!==A&&!Zp(bt(A),this.type))&&(A=jc(this.type.kind,A)),A}eachChild(){}outputDefined(){return!1}serialize(){const i=["config",this.key];return this.scope&&i.concat(this.scope),i}}class Jl{constructor(i,o){this.type=o.type,this.name=i,this.boundExpression=o}static parse(i,o){if(2!==i.length||"string"!=typeof i[1])return o.error("'var' expression requires exactly one string literal argument.");const c=i[1];return o.scope.has(c)?new Jl(c,o.scope.get(c)):o.error(`Unknown variable "${c}". Make sure "${c}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(i){return this.boundExpression.evaluate(i)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class rh{constructor(i,o=[],c,h=new Xd,m=[],g,x){this.registry=i,this.path=o,this.key=o.map(w=>"string"==typeof w?`['${w}']`:`[${w}]`).join(""),this.scope=h,this.errors=m,this.expectedType=c,this._scope=g,this.options=x}parse(i,o,c,h,m={}){return o||c?this.concat(o,null,c,h)._parse(i,m):this._parse(i,m)}parseObjectValue(i,o,c,h,m,g={}){return this.concat(o,c,h,m)._parse(i,g)}_parse(i,o){function c(h,m,g){return"assert"===g?new Bt(m,[h]):"coerce"===g?new bs(m,[h]):h}if(null!==i&&"string"!=typeof i&&"boolean"!=typeof i&&"number"!=typeof i||(i=["literal",i]),Array.isArray(i)){if(0===i.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const h="string"==typeof i[0]?this.registry[i[0]]:void 0;if(h){let m=h.parse(i,this);if(!m)return null;if(this.expectedType){const g=this.expectedType,x=m.type;if("string"!==g.kind&&"number"!==g.kind&&"boolean"!==g.kind&&"object"!==g.kind&&"array"!==g.kind||"value"!==x.kind)if("color"!==g.kind&&"formatted"!==g.kind&&"resolvedImage"!==g.kind||"value"!==x.kind&&"string"!==x.kind){if(this.checkSubtype(g,x))return null}else m=c(m,g,o.typeAnnotation||"coerce");else m=c(m,g,o.typeAnnotation||"assert")}if(!(m instanceof Vt)&&"resolvedImage"!==m.type.kind&&La(m)){const g=new Kd(this._scope,this.options);try{m=new Vt(m.type,m.evaluate(g))}catch(x){return this.error(x.message),null}}return m}return bs.parse(["to-array",i],this)}return this.error(void 0===i?"'undefined' value invalid. Use null instead.":"object"==typeof i?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof i} instead.`)}concat(i,o,c,h){let m="number"==typeof i?this.path.concat(i):this.path;m="string"==typeof o?m.concat(o):m;const g=h?this.scope.concat(h):this.scope;return new rh(this.registry,m,c||null,g,this.errors,this._scope,this.options)}error(i,...o){const c=`${this.key}${o.map(h=>`[${h}]`).join("")}`;this.errors.push(new Hn(c,i))}checkSubtype(i,o){const c=ql(i,o);return c&&this.error(c),c}}function La(a){if(a instanceof Jl)return La(a.boundExpression);if(a instanceof Jr&&"error"===a.name||a instanceof xo||a instanceof bo||a instanceof Qs||a instanceof ss)return!1;const i=a instanceof bs||a instanceof Bt;let o=!0;return a.eachChild(c=>{o=i?o&&La(c):o&&c instanceof Vt}),!!o&&Fn(a)&&ga(a,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Js(a,i){const o=a.length-1;let c,h,m=0,g=o,x=0;for(;m<=g;)if(x=Math.floor((m+g)/2),c=a[x],h=a[x+1],c<=i){if(x===o||i<h)return x;m=x+1}else{if(!(c>i))throw new Ar("Input is not a number.");g=x-1}return 0}class rl{constructor(i,o,c){this.type=i,this.input=o,this.labels=[],this.outputs=[];for(const[h,m]of c)this.labels.push(h),this.outputs.push(m)}static parse(i,o){if(i.length-1<4)return o.error(`Expected at least 4 arguments, but found only ${i.length-1}.`);if((i.length-1)%2!=0)return o.error("Expected an even number of arguments.");const c=o.parse(i[1],1,Tt);if(!c)return null;const h=[];let m=null;o.expectedType&&"value"!==o.expectedType.kind&&(m=o.expectedType);for(let g=1;g<i.length;g+=2){const x=1===g?-1/0:i[g],w=i[g+1],T=g,I=g+1;if("number"!=typeof x)return o.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',T);if(h.length&&h[h.length-1][0]>=x)return o.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',T);const A=o.parse(w,I,m);if(!A)return null;m=m||A.type,h.push([x,A])}return new rl(m,c,h)}evaluate(i){const o=this.labels,c=this.outputs;if(1===o.length)return c[0].evaluate(i);const h=this.input.evaluate(i);if(h<=o[0])return c[0].evaluate(i);const m=o.length;return h>=o[m-1]?c[m-1].evaluate(i):c[Js(o,h)].evaluate(i)}eachChild(i){i(this.input);for(const o of this.outputs)i(o)}outputDefined(){return this.outputs.every(i=>i.outputDefined())}serialize(){const i=["step",this.input.serialize()];for(let o=0;o<this.labels.length;o++)o>0&&i.push(this.labels[o]),i.push(this.outputs[o].serialize());return i}}const wv=4/29,ec=6/29,rm=3*ec*ec,ea=ec*ec*ec,If=Math.PI/180,Hc=180/Math.PI;function Gc(a){return a>ea?Math.pow(a,1/3):a/rm+wv}function ao(a){return a>ec?a*a*a:rm*(a-wv)}function t_(a){return 255*(a<=.0031308?12.92*a:1.055*Math.pow(a,1/2.4)-.055)}function Oo(a){return(a/=255)<=.04045?a/12.92:Math.pow((a+.055)/1.055,2.4)}function Fo(a){const i=Oo(a.r),o=Oo(a.g),c=Oo(a.b),h=Gc((.4124564*i+.3575761*o+.1804375*c)/.95047),m=Gc((.2126729*i+.7151522*o+.072175*c)/1);return{l:116*m-16,a:500*(h-m),b:200*(m-Gc((.0193339*i+.119192*o+.9503041*c)/1.08883)),alpha:a.a}}function ol(a){let i=(a.l+16)/116,o=isNaN(a.a)?i:i+a.a/500,c=isNaN(a.b)?i:i-a.b/200;return i=1*ao(i),o=.95047*ao(o),c=1.08883*ao(c),new Kn(t_(3.2404542*o-1.5371385*i-.4985314*c),t_(-.969266*o+1.8760108*i+.041556*c),t_(.0556434*o-.2040259*i+1.0572252*c),a.alpha)}function tc(a,i,o){const c=i-a;return a+o*(c>180||c<-180?c-360*Math.round(c/360):c)}const sl={forward:Fo,reverse:ol,interpolate:function(a,i,o){return{l:Nt(a.l,i.l,o),a:Nt(a.a,i.a,o),b:Nt(a.b,i.b,o),alpha:Nt(a.alpha,i.alpha,o)}}},as={forward:function(a){const{l:i,a:o,b:c}=Fo(a),h=Math.atan2(c,o)*Hc;return{h:h<0?h+360:h,c:Math.sqrt(o*o+c*c),l:i,alpha:a.a}},reverse:function(a){const i=a.h*If,o=a.c;return ol({l:a.l,a:Math.cos(i)*o,b:Math.sin(i)*o,alpha:a.alpha})},interpolate:function(a,i,o){return{h:tc(a.h,i.h,o),c:Nt(a.c,i.c,o),l:Nt(a.l,i.l,o),alpha:Nt(a.alpha,i.alpha,o)}}};var qu=Object.freeze({__proto__:null,hcl:as,lab:sl});class ls{constructor(i,o,c,h,m){this.type=i,this.operator=o,this.interpolation=c,this.input=h,this.labels=[],this.outputs=[];for(const[g,x]of m)this.labels.push(g),this.outputs.push(x)}static interpolationFactor(i,o,c,h){let m=0;if("exponential"===i.name)m=om(o,i.base,c,h);else if("linear"===i.name)m=om(o,1,c,h);else if("cubic-bezier"===i.name){const g=i.controlPoints;m=new Pu(g[0],g[1],g[2],g[3]).solve(om(o,1,c,h))}return m}static parse(i,o){let[c,h,m,...g]=i;if(!Array.isArray(h)||0===h.length)return o.error("Expected an interpolation type expression.",1);if("linear"===h[0])h={name:"linear"};else if("exponential"===h[0]){const T=h[1];if("number"!=typeof T)return o.error("Exponential interpolation requires a numeric base.",1,1);h={name:"exponential",base:T}}else{if("cubic-bezier"!==h[0])return o.error(`Unknown interpolation type ${String(h[0])}`,1,0);{const T=h.slice(1);if(4!==T.length||T.some(I=>"number"!=typeof I||I<0||I>1))return o.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);h={name:"cubic-bezier",controlPoints:T}}}if(i.length-1<4)return o.error(`Expected at least 4 arguments, but found only ${i.length-1}.`);if(i.length-1>3&&(i.length-1)%2!=0)return o.error("Expected an even number of arguments.");if(m=o.parse(m,2,Tt),!m)return null;const x=[];let w=null;"interpolate-hcl"===c||"interpolate-lab"===c?w=gi:o.expectedType&&"value"!==o.expectedType.kind&&(w=o.expectedType);for(let T=0;T<g.length;T+=2){const I=g[T],A=g[T+1],M=T+3,k=T+4;if("number"!=typeof I)return o.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',M);if(x.length&&x[x.length-1][0]>=I)return o.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',M);const L=o.parse(A,k,w);if(!L)return null;w=w||L.type,x.push([I,L])}return"number"===w.kind||"color"===w.kind||"array"===w.kind&&"number"===w.itemType.kind&&"number"==typeof w.N?new ls(w,c,h,m,x):o.error(`Type ${Er(w)} is not interpolatable.`)}evaluate(i){const o=this.labels,c=this.outputs;if(1===o.length)return c[0].evaluate(i);const h=this.input.evaluate(i);if(h<=o[0])return c[0].evaluate(i);const m=o.length;if(h>=o[m-1])return c[m-1].evaluate(i);const g=Js(o,h),x=ls.interpolationFactor(this.interpolation,h,o[g],o[g+1]),w=c[g].evaluate(i),T=c[g+1].evaluate(i);return"interpolate"===this.operator?ju[this.type.kind.toLowerCase()](w,T,x):"interpolate-hcl"===this.operator?as.reverse(as.interpolate(as.forward(w),as.forward(T),x)):sl.reverse(sl.interpolate(sl.forward(w),sl.forward(T),x))}eachChild(i){i(this.input);for(const o of this.outputs)i(o)}outputDefined(){return this.outputs.every(i=>i.outputDefined())}serialize(){let i;i="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const o=[this.operator,i,this.input.serialize()];for(let c=0;c<this.labels.length;c++)o.push(this.labels[c],this.outputs[c].serialize());return o}}function om(a,i,o,c){const h=c-o,m=a-o;return 0===h?0:1===i?m/h:(Math.pow(i,m)-1)/(Math.pow(i,h)-1)}class sm{constructor(i,o){this.type=i,this.args=o}static parse(i,o){if(i.length<2)return o.error("Expectected at least one argument.");let c=null;const h=o.expectedType;h&&"value"!==h.kind&&(c=h);const m=[];for(const x of i.slice(1)){const w=o.parse(x,1+m.length,c,void 0,{typeAnnotation:"omit"});if(!w)return null;c=c||w.type,m.push(w)}const g=h&&m.some(x=>ql(h,x.type));return new sm(g?Qn:c,m)}evaluate(i){let o,c=null,h=0;for(const m of this.args){if(h++,c=m.evaluate(i),c&&c instanceof vo&&!c.available&&(o||(o=c),c=null,h===this.args.length))return o;if(null!==c)break}return c}eachChild(i){this.args.forEach(i)}outputDefined(){return this.args.every(i=>i.outputDefined())}serialize(){const i=["coalesce"];return this.eachChild(o=>{i.push(o.serialize())}),i}}class oh{constructor(i,o){this.type=o.type,this.bindings=[].concat(i),this.result=o}evaluate(i){return this.result.evaluate(i)}eachChild(i){for(const o of this.bindings)i(o[1]);i(this.result)}static parse(i,o){if(i.length<4)return o.error(`Expected at least 3 arguments, but found ${i.length-1} instead.`);const c=[];for(let m=1;m<i.length-1;m+=2){const g=i[m];if("string"!=typeof g)return o.error(`Expected string, but found ${typeof g} instead.`,m);if(/[^a-zA-Z0-9_]/.test(g))return o.error("Variable names must contain only alphanumeric characters or '_'.",m);const x=o.parse(i[m+1],m+1);if(!x)return null;c.push([g,x])}const h=o.parse(i[i.length-1],i.length-1,o.expectedType,c);return h?new oh(c,h):null}outputDefined(){return this.result.outputDefined()}serialize(){const i=["let"];for(const[o,c]of this.bindings)i.push(o,c.serialize());return i.push(this.result.serialize()),i}}class Af{constructor(i,o,c){this.type=i,this.index=o,this.input=c}static parse(i,o){if(3!==i.length)return o.error(`Expected 2 arguments, but found ${i.length-1} instead.`);const c=o.parse(i[1],1,Tt),h=o.parse(i[2],2,yo(o.expectedType||Qn));return c&&h?new Af(h.type.itemType,c,h):null}evaluate(i){const o=this.index.evaluate(i),c=this.input.evaluate(i);if(o<0)throw new Ar(`Array index out of bounds: ${o} < 0.`);if(o>=c.length)throw new Ar(`Array index out of bounds: ${o} > ${c.length-1}.`);if(o!==Math.floor(o))throw new Ar(`Array index must be an integer, but found ${o} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return c[o]}eachChild(i){i(this.index),i(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class n_{constructor(i,o,c){this.type=i,this.index=o,this.input=c}static parse(i,o){if(3!==i.length)return o.error(`Expected 2 arguments, but found ${i.length-1} instead.`);const c=o.parse(i[1],1,Tt),h=o.parse(i[2],2,yo(o.expectedType||Qn));return c&&h?new n_(h.type.itemType,c,h):null}evaluate(i){const o=this.index.evaluate(i),c=this.input.evaluate(i);if(o<0)throw new Ar(`Array index out of bounds: ${o} < 0.`);if(o>c.length-1)throw new Ar(`Array index out of bounds: ${o} > ${c.length-1}.`);if(o===Math.floor(o))return c[o];const h=Math.floor(o),m=Math.ceil(o),g=c[h],x=c[m];if("number"!=typeof g||"number"!=typeof x)throw new Ar(`Cannot interpolate between non-number values at index ${o}.`);const w=o-h;return g*(1-w)+x*w}eachChild(i){i(this.index),i(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class i_{constructor(i,o){this.type=Xn,this.needle=i,this.haystack=o}static parse(i,o){if(3!==i.length)return o.error(`Expected 2 arguments, but found ${i.length-1} instead.`);const c=o.parse(i[1],1,Qn),h=o.parse(i[2],2,Qn);return c&&h?Lc(c.type,[Xn,Gn,Tt,Oc,Qn])?new i_(c,h):o.error(`Expected first argument to be of type boolean, string, number or null, but found ${Er(c.type)} instead`):null}evaluate(i){const o=this.needle.evaluate(i),c=this.haystack.evaluate(i);if(null==c)return!1;if(!vf(o,["boolean","string","number","null"]))throw new Ar(`Expected first argument to be of type boolean, string, number or null, but found ${Er(bt(o))} instead.`);if(!vf(c,["string","array"]))throw new Ar(`Expected second argument to be of type array or string, but found ${Er(bt(c))} instead.`);return c.indexOf(o)>=0}eachChild(i){i(this.needle),i(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class am{constructor(i,o,c){this.type=Tt,this.needle=i,this.haystack=o,this.fromIndex=c}static parse(i,o){if(i.length<=2||i.length>=5)return o.error(`Expected 3 or 4 arguments, but found ${i.length-1} instead.`);const c=o.parse(i[1],1,Qn),h=o.parse(i[2],2,Qn);if(!c||!h)return null;if(!Lc(c.type,[Xn,Gn,Tt,Oc,Qn]))return o.error(`Expected first argument to be of type boolean, string, number or null, but found ${Er(c.type)} instead`);if(4===i.length){const m=o.parse(i[3],3,Tt);return m?new am(c,h,m):null}return new am(c,h)}evaluate(i){const o=this.needle.evaluate(i),c=this.haystack.evaluate(i);if(!vf(o,["boolean","string","number","null"]))throw new Ar(`Expected first argument to be of type boolean, string, number or null, but found ${Er(bt(o))} instead.`);if(!vf(c,["string","array"]))throw new Ar(`Expected second argument to be of type array or string, but found ${Er(bt(c))} instead.`);if(this.fromIndex){const h=this.fromIndex.evaluate(i);return c.indexOf(o,h)}return c.indexOf(o)}eachChild(i){i(this.needle),i(this.haystack),this.fromIndex&&i(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const i=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),i]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class lm{constructor(i,o,c,h,m,g){this.inputType=i,this.type=o,this.input=c,this.cases=h,this.outputs=m,this.otherwise=g}static parse(i,o){if(i.length<5)return o.error(`Expected at least 4 arguments, but found only ${i.length-1}.`);if(i.length%2!=1)return o.error("Expected an even number of arguments.");let c,h;o.expectedType&&"value"!==o.expectedType.kind&&(h=o.expectedType);const m={},g=[];for(let T=2;T<i.length-1;T+=2){let I=i[T];const A=i[T+1];Array.isArray(I)||(I=[I]);const M=o.concat(T);if(0===I.length)return M.error("Expected at least one branch label.");for(const L of I){if("number"!=typeof L&&"string"!=typeof L)return M.error("Branch labels must be numbers or strings.");if("number"==typeof L&&Math.abs(L)>Number.MAX_SAFE_INTEGER)return M.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof L&&Math.floor(L)!==L)return M.error("Numeric branch labels must be integer values.");if(c){if(M.checkSubtype(c,bt(L)))return null}else c=bt(L);if(void 0!==m[String(L)])return M.error("Branch labels must be unique.");m[String(L)]=g.length}const k=o.parse(A,T,h);if(!k)return null;h=h||k.type,g.push(k)}const x=o.parse(i[1],1,Qn);if(!x)return null;const w=o.parse(i[i.length-1],i.length-1,h);return w?"value"!==x.type.kind&&o.concat(1).checkSubtype(c,x.type)?null:new lm(c,h,x,m,g,w):null}evaluate(i){const o=this.input.evaluate(i);return(Zp(bt(o),this.inputType)&&this.outputs[this.cases[o]]||this.otherwise).evaluate(i)}eachChild(i){i(this.input),this.outputs.forEach(i),i(this.otherwise)}outputDefined(){return this.outputs.every(i=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const i=["match",this.input.serialize()],o=Object.keys(this.cases).sort(),c=[],h={};for(const g of o){const x=h[this.cases[g]];void 0===x?(h[this.cases[g]]=c.length,c.push([this.cases[g],[g]])):c[x][1].push(g)}const m=g=>"number"===this.inputType.kind?Number(g):g;for(const[g,x]of c)i.push(1===x.length?m(x[0]):x.map(m)),i.push(this.outputs[g].serialize());return i.push(this.otherwise.serialize()),i}}class cm{constructor(i,o,c){this.type=i,this.branches=o,this.otherwise=c}static parse(i,o){if(i.length<4)return o.error(`Expected at least 3 arguments, but found only ${i.length-1}.`);if(i.length%2!=0)return o.error("Expected an odd number of arguments.");let c;o.expectedType&&"value"!==o.expectedType.kind&&(c=o.expectedType);const h=[];for(let g=1;g<i.length-1;g+=2){const x=o.parse(i[g],g,Xn);if(!x)return null;const w=o.parse(i[g+1],g+1,c);if(!w)return null;h.push([x,w]),c=c||w.type}const m=o.parse(i[i.length-1],i.length-1,c);return m?new cm(c,h,m):null}evaluate(i){for(const[o,c]of this.branches)if(o.evaluate(i))return c.evaluate(i);return this.otherwise.evaluate(i)}eachChild(i){for(const[o,c]of this.branches)i(o),i(c);i(this.otherwise)}outputDefined(){return this.branches.every(([i,o])=>o.outputDefined())&&this.otherwise.outputDefined()}serialize(){const i=["case"];return this.eachChild(o=>{i.push(o.serialize())}),i}}class Wu{constructor(i,o,c,h){this.type=i,this.input=o,this.beginIndex=c,this.endIndex=h}static parse(i,o){if(i.length<=2||i.length>=5)return o.error(`Expected 3 or 4 arguments, but found ${i.length-1} instead.`);const c=o.parse(i[1],1,Qn),h=o.parse(i[2],2,Tt);if(!c||!h)return null;if(!Lc(c.type,[yo(Qn),Gn,Qn]))return o.error(`Expected first argument to be of type array or string, but found ${Er(c.type)} instead`);if(4===i.length){const m=o.parse(i[3],3,Tt);return m?new Wu(c.type,c,h,m):null}return new Wu(c.type,c,h)}evaluate(i){const o=this.input.evaluate(i),c=this.beginIndex.evaluate(i);if(!vf(o,["string","array"]))throw new Ar(`Expected first argument to be of type array or string, but found ${Er(bt(o))} instead.`);if(this.endIndex){const h=this.endIndex.evaluate(i);return o.slice(c,h)}return o.slice(c)}eachChild(i){i(this.input),i(this.beginIndex),this.endIndex&&i(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const i=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),i]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class r_{constructor(i,o){this.type=yo(Gn),this.str=i,this.delimiter=o}static parse(i,o){if(3!==i.length)return o.error(`Expected 2 arguments, but found ${i.length-1} instead.`);const c=o.parse(i[1],1,Gn),h=o.parse(i[2],2,Gn);return c&&h?new r_(c,h):void 0}evaluate(i){const o=this.str.evaluate(i),c=this.delimiter.evaluate(i);return o.split(c)}eachChild(i){i(this.str),i(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function o_(a,i){return"=="===a||"!="===a?"boolean"===i.kind||"string"===i.kind||"number"===i.kind||"null"===i.kind||"value"===i.kind:"string"===i.kind||"number"===i.kind||"value"===i.kind}function Ev(a,i,o,c){return 0===c.compare(i,o)}function sh(a,i,o){const c="=="!==a&&"!="!==a;return class uR{constructor(m,g,x){this.type=Xn,this.lhs=m,this.rhs=g,this.collator=x,this.hasUntypedArgument="value"===m.type.kind||"value"===g.type.kind}static parse(m,g){if(3!==m.length&&4!==m.length)return g.error("Expected two or three arguments.");const x=m[0];let w=g.parse(m[1],1,Qn);if(!w)return null;if(!o_(x,w.type))return g.concat(1).error(`"${x}" comparisons are not supported for type '${Er(w.type)}'.`);let T=g.parse(m[2],2,Qn);if(!T)return null;if(!o_(x,T.type))return g.concat(2).error(`"${x}" comparisons are not supported for type '${Er(T.type)}'.`);if(w.type.kind!==T.type.kind&&"value"!==w.type.kind&&"value"!==T.type.kind)return g.error(`Cannot compare types '${Er(w.type)}' and '${Er(T.type)}'.`);c&&("value"===w.type.kind&&"value"!==T.type.kind?w=new Bt(T.type,[w]):"value"!==w.type.kind&&"value"===T.type.kind&&(T=new Bt(w.type,[T])));let I=null;if(4===m.length){if("string"!==w.type.kind&&"string"!==T.type.kind&&"value"!==w.type.kind&&"value"!==T.type.kind)return g.error("Cannot use collator to compare non-string types.");if(I=g.parse(m[3],3,Xt),!I)return null}return new uR(w,T,I)}evaluate(m){const g=this.lhs.evaluate(m),x=this.rhs.evaluate(m);if(c&&this.hasUntypedArgument){const w=bt(g),T=bt(x);if(w.kind!==T.kind||"string"!==w.kind&&"number"!==w.kind)throw new Ar(`Expected arguments for "${a}" to be (string, string) or (number, number), but found (${w.kind}, ${T.kind}) instead.`)}if(this.collator&&!c&&this.hasUntypedArgument){const w=bt(g),T=bt(x);if("string"!==w.kind||"string"!==T.kind)return i(m,g,x)}return this.collator?o(m,g,x,this.collator.evaluate(m)):i(m,g,x)}eachChild(m){m(this.lhs),m(this.rhs),this.collator&&m(this.collator)}outputDefined(){return!0}serialize(){const m=[a];return this.eachChild(g=>{m.push(g.serialize())}),m}}}const Tv=sh("==",function(a,i,o){return i===o},Ev),Dv=sh("!=",function(a,i,o){return i!==o},function(a,i,o,c){return!Ev(0,i,o,c)}),s_=sh("<",function(a,i,o){return i<o},function(a,i,o,c){return c.compare(i,o)<0}),a_=sh(">",function(a,i,o){return i>o},function(a,i,o,c){return c.compare(i,o)>0}),Kx=sh("<=",function(a,i,o){return i<=o},function(a,i,o,c){return c.compare(i,o)<=0}),um=sh(">=",function(a,i,o){return i>=o},function(a,i,o,c){return c.compare(i,o)>=0});class l_{constructor(i,o,c,h,m,g){this.type=Gn,this.number=i,this.locale=o,this.currency=c,this.unit=h,this.minFractionDigits=m,this.maxFractionDigits=g}static parse(i,o){if(3!==i.length)return o.error("Expected two arguments.");const c=o.parse(i[1],1,Tt);if(!c)return null;const h=i[2];if("object"!=typeof h||Array.isArray(h))return o.error("NumberFormat options argument must be an object.");let m=null;if(h.locale&&(m=o.parseObjectValue(h.locale,2,"locale",Gn),!m))return null;let g=null;if(h.currency&&(g=o.parseObjectValue(h.currency,2,"currency",Gn),!g))return null;let x=null;if(h.unit&&(x=o.parseObjectValue(h.unit,2,"unit",Gn),!x))return null;let w=null;if(h["min-fraction-digits"]&&(w=o.parseObjectValue(h["min-fraction-digits"],2,"min-fraction-digits",Tt),!w))return null;let T=null;return h["max-fraction-digits"]&&(T=o.parseObjectValue(h["max-fraction-digits"],2,"max-fraction-digits",Tt),!T)?null:new l_(c,m,g,x,w,T)}evaluate(i){return new Intl.NumberFormat(this.locale?this.locale.evaluate(i):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(i):void 0,unit:this.unit?this.unit.evaluate(i):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(i):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(i):void 0}).format(this.number.evaluate(i))}eachChild(i){i(this.number),this.locale&&i(this.locale),this.currency&&i(this.currency),this.unit&&i(this.unit),this.minFractionDigits&&i(this.minFractionDigits),this.maxFractionDigits&&i(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const i={};return this.locale&&(i.locale=this.locale.serialize()),this.currency&&(i.currency=this.currency.serialize()),this.unit&&(i.unit=this.unit.serialize()),this.minFractionDigits&&(i["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(i["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),i]}}class al{constructor(i){this.type=Tt,this.input=i}static parse(i,o){if(2!==i.length)return o.error(`Expected 1 argument, but found ${i.length-1} instead.`);const c=o.parse(i[1],1);return c?"array"!==c.type.kind&&"string"!==c.type.kind&&"value"!==c.type.kind?o.error(`Expected argument of type string or array, but found ${Er(c.type)} instead.`):new al(c):null}evaluate(i){const o=this.input.evaluate(i);if("string"==typeof o||Array.isArray(o))return o.length;throw new Ar(`Expected value to be of type string or array, but found ${Er(bt(o))} instead.`)}eachChild(i){i(this.input)}outputDefined(){return!1}serialize(){const i=["length"];return this.eachChild(o=>{i.push(o.serialize())}),i}}function ll(a){return function(){a=1831565813+(a|=0)|0;let i=Math.imul(a^a>>>15,1|a);return i=i+Math.imul(i^i>>>7,61|i)^i,((i^i>>>14)>>>0)/4294967296}}const ah={"==":Tv,"!=":Dv,">":a_,"<":s_,">=":um,"<=":Kx,array:Bt,at:Af,"at-interpolated":n_,boolean:Bt,case:cm,coalesce:sm,collator:xo,format:gt,image:zc,in:i_,"index-of":am,interpolate:ls,"interpolate-hcl":ls,"interpolate-lab":ls,length:al,let:oh,literal:Vt,match:lm,number:Bt,"number-format":l_,object:Bt,slice:Wu,step:rl,string:Bt,"to-boolean":bs,"to-color":bs,"to-number":bs,"to-string":bs,var:Jl,within:bo,distance:Qs,config:ss,split:r_};function c_(a,[i,o,c,h]){i=i.evaluate(a),o=o.evaluate(a),c=c.evaluate(a);const m=h?h.evaluate(a):1,g=Nc(i,o,c,m);if(g)throw new Ar(g);return new Kn(i/255,o/255,c/255,m)}function Eo(a,[i,o,c,h]){i=i.evaluate(a),o=o.evaluate(a),c=c.evaluate(a);const m=h?h.evaluate(a):1,g=(I=o,A=c,M=m,"number"==typeof(T=i)&&T>=0&&T<=360?"number"==typeof I&&I>=0&&I<=100&&"number"==typeof A&&A>=0&&A<=100?void 0===M||"number"==typeof M&&M>=0&&M<=1?null:`Invalid hsla value [${[T,I,A,M].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof M?[T,I,A,M]:[T,I,A]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof M?[T,I,A,M]:[T,I,A]).join(", ")}]: 'h' must be between 0 and 360.`);var T,I,A,M;if(g)throw new Ar(g);const x=`hsla(${i}, ${o}%, ${c}%, ${m})`,w=Kn.parse(x);if(!w)throw new Ar(`Failed to parse HSLA color: ${x}`);return w}function lh(a,i){return a in i}function cs(a,i){const o=i[a];return void 0===o?null:o}function cl(a){return{type:a}}function Mf(a){return{result:"success",value:a}}function ul(a){return{result:"error",value:a}}function dl(a,i){return!!a&&!!a.parameters&&a.parameters.indexOf(i)>-1}function Zu(a){return"data-driven"===a["property-type"]}function dm(a){return dl(a.expression,"measure-light")}function Pf(a){return dl(a.expression,"zoom")}function Xu(a){return!!a.expression&&a.expression.interpolated}function ch(a){return"object"==typeof a&&null!==a&&!Array.isArray(a)}function hm(a){return a}function Rf(a,i){const o="color"===i.type,c=a.stops&&"object"==typeof a.stops[0][0],h=c||!(c||void 0!==a.property),m=a.type||(Xu(i)?"exponential":"interval");if(o&&((a=Rc({},a)).stops&&(a.stops=a.stops.map(T=>[T[0],Kn.parse(T[1])])),a.default=Kn.parse(a.default?a.default:i.default)),a.colorSpace&&"rgb"!==a.colorSpace&&!qu[a.colorSpace])throw new Error(`Unknown color space: ${a.colorSpace}`);let g,x,w;if("exponential"===m)g=fm;else if("interval"===m)g=qc;else if("categorical"===m){g=$c,x=Object.create(null);for(const T of a.stops)x[T[0]]=T[1];w=typeof a.stops[0][0]}else{if("identity"!==m)throw new Error(`Unknown function type "${m}"`);g=Sv}if(c){const T={},I=[];for(let k=0;k<a.stops.length;k++){const L=a.stops[k],V=L[0].zoom;void 0===T[V]&&(T[V]={zoom:V,type:a.type,property:a.property,default:a.default,stops:[]},I.push(V)),T[V].stops.push([L[0].value,L[1]])}const A=[];for(const k of I)A.push([T[k].zoom,Rf(T[k],i)]);const M={name:"linear"};return{kind:"composite",interpolationType:M,interpolationFactor:ls.interpolationFactor.bind(void 0,M),zoomStops:A.map(k=>k[0]),evaluate:({zoom:k},L)=>fm({stops:A,base:a.base},i,k).evaluate(k,L)}}if(h){const T="exponential"===m?{name:"exponential",base:void 0!==a.base?a.base:1}:null;return{kind:"camera",interpolationType:T,interpolationFactor:ls.interpolationFactor.bind(void 0,T),zoomStops:a.stops.map(I=>I[0]),evaluate:({zoom:I})=>g(a,i,I,x,w)}}return{kind:"source",evaluate(T,I){const A=I&&I.properties?I.properties[a.property]:void 0;return void 0===A?Na(a.default,i.default):g(a,i,A,x,w)}}}function Na(a,i,o){return void 0!==a?a:void 0!==i?i:void 0!==o?o:void 0}function $c(a,i,o,c,h){return Na(typeof o===h?c[o]:void 0,a.default,i.default)}function qc(a,i,o){if("number"!==ui(o))return Na(a.default,i.default);const c=a.stops.length;if(1===c||o<=a.stops[0][0])return a.stops[0][1];if(o>=a.stops[c-1][0])return a.stops[c-1][1];const h=Js(a.stops.map(m=>m[0]),o);return a.stops[h][1]}function fm(a,i,o){const c=void 0!==a.base?a.base:1;if("number"!==ui(o))return Na(a.default,i.default);const h=a.stops.length;if(1===h||o<=a.stops[0][0])return a.stops[0][1];if(o>=a.stops[h-1][0])return a.stops[h-1][1];const m=Js(a.stops.map(I=>I[0]),o),g=function(I,A,M,k){const L=k-M,V=I-M;return 0===L?0:1===A?V/L:(Math.pow(A,V)-1)/(Math.pow(A,L)-1)}(o,c,a.stops[m][0],a.stops[m+1][0]),x=a.stops[m][1],w=a.stops[m+1][1];let T=ju[i.type]||hm;if(a.colorSpace&&"rgb"!==a.colorSpace){const I=qu[a.colorSpace];T=(A,M)=>I.reverse(I.interpolate(I.forward(A),I.forward(M),g))}return"function"==typeof x.evaluate?{evaluate(...I){const A=x.evaluate.apply(void 0,I),M=w.evaluate.apply(void 0,I);if(void 0!==A&&void 0!==M)return T(A,M,g)}}:T(x,w,g)}function Sv(a,i,o){return"color"===i.type?o=Kn.parse(o):"formatted"===i.type?o=Kr.fromString(o.toString()):"resolvedImage"===i.type?o=vo.build(o.toString()):ui(o)===i.type||"enum"===i.type&&i.values[o]||(o=void 0),Na(o,a.default,i.default)}Jr.register(ah,{error:[{kind:"error"},[Gn],(a,[i])=>{throw new Ar(i.evaluate(a))}],typeof:[Gn,[Qn],(a,[i])=>Er(bt(i.evaluate(a)))],"to-rgba":[yo(Tt,4),[gi],(a,[i])=>i.evaluate(a).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[yo(Tt,4),[gi],(a,[i])=>i.evaluate(a).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[gi,[Tt,Tt,Tt],c_],rgba:[gi,[Tt,Tt,Tt,Tt],c_],hsl:[gi,[Tt,Tt,Tt],Eo],hsla:[gi,[Tt,Tt,Tt,Tt],Eo],has:{type:Xn,overloads:[[[Gn],(a,[i])=>lh(i.evaluate(a),a.properties())],[[Gn,$l],(a,[i,o])=>lh(i.evaluate(a),o.evaluate(a))]]},get:{type:Qn,overloads:[[[Gn],(a,[i])=>cs(i.evaluate(a),a.properties())],[[Gn,$l],(a,[i,o])=>cs(i.evaluate(a),o.evaluate(a))]]},"feature-state":[Qn,[Gn],(a,[i])=>cs(i.evaluate(a),a.featureState||{})],properties:[$l,[],a=>a.properties()],"geometry-type":[Gn,[],a=>a.geometryType()],worldview:[Gn,[],a=>a.globals.worldview||""],id:[Qn,[],a=>a.id()],zoom:[Tt,[],a=>a.globals.zoom],pitch:[Tt,[],a=>a.globals.pitch||0],"distance-from-center":[Tt,[],a=>a.distanceFromCenter()],"measure-light":[Tt,[Gn],(a,[i])=>a.measureLight(i.evaluate(a))],"heatmap-density":[Tt,[],a=>a.globals.heatmapDensity||0],"line-progress":[Tt,[],a=>a.globals.lineProgress||0],"raster-value":[Tt,[],a=>a.globals.rasterValue||0],"raster-particle-speed":[Tt,[],a=>a.globals.rasterParticleSpeed||0],"sky-radial-progress":[Tt,[],a=>a.globals.skyRadialProgress||0],accumulated:[Qn,[],a=>void 0===a.globals.accumulated?null:a.globals.accumulated],"+":[Tt,cl(Tt),(a,i)=>{let o=0;for(const c of i)o+=c.evaluate(a);return o}],"*":[Tt,cl(Tt),(a,i)=>{let o=1;for(const c of i)o*=c.evaluate(a);return o}],"-":{type:Tt,overloads:[[[Tt,Tt],(a,[i,o])=>i.evaluate(a)-o.evaluate(a)],[[Tt],(a,[i])=>-i.evaluate(a)]]},"/":[Tt,[Tt,Tt],(a,[i,o])=>i.evaluate(a)/o.evaluate(a)],"%":[Tt,[Tt,Tt],(a,[i,o])=>i.evaluate(a)%o.evaluate(a)],ln2:[Tt,[],()=>Math.LN2],pi:[Tt,[],()=>Math.PI],e:[Tt,[],()=>Math.E],"^":[Tt,[Tt,Tt],(a,[i,o])=>Math.pow(i.evaluate(a),o.evaluate(a))],sqrt:[Tt,[Tt],(a,[i])=>Math.sqrt(i.evaluate(a))],log10:[Tt,[Tt],(a,[i])=>Math.log(i.evaluate(a))/Math.LN10],ln:[Tt,[Tt],(a,[i])=>Math.log(i.evaluate(a))],log2:[Tt,[Tt],(a,[i])=>Math.log(i.evaluate(a))/Math.LN2],sin:[Tt,[Tt],(a,[i])=>Math.sin(i.evaluate(a))],cos:[Tt,[Tt],(a,[i])=>Math.cos(i.evaluate(a))],tan:[Tt,[Tt],(a,[i])=>Math.tan(i.evaluate(a))],asin:[Tt,[Tt],(a,[i])=>Math.asin(i.evaluate(a))],acos:[Tt,[Tt],(a,[i])=>Math.acos(i.evaluate(a))],atan:[Tt,[Tt],(a,[i])=>Math.atan(i.evaluate(a))],min:[Tt,cl(Tt),(a,i)=>Math.min(...i.map(o=>o.evaluate(a)))],max:[Tt,cl(Tt),(a,i)=>Math.max(...i.map(o=>o.evaluate(a)))],abs:[Tt,[Tt],(a,[i])=>Math.abs(i.evaluate(a))],round:[Tt,[Tt],(a,[i])=>{const o=i.evaluate(a);return o<0?-Math.round(-o):Math.round(o)}],floor:[Tt,[Tt],(a,[i])=>Math.floor(i.evaluate(a))],ceil:[Tt,[Tt],(a,[i])=>Math.ceil(i.evaluate(a))],"filter-==":[Xn,[Gn,Qn],(a,[i,o])=>a.properties()[i.value]===o.value],"filter-id-==":[Xn,[Qn],(a,[i])=>a.id()===i.value],"filter-type-==":[Xn,[Gn],(a,[i])=>a.geometryType()===i.value],"filter-<":[Xn,[Gn,Qn],(a,[i,o])=>{const c=a.properties()[i.value],h=o.value;return typeof c==typeof h&&c<h}],"filter-id-<":[Xn,[Qn],(a,[i])=>{const o=a.id(),c=i.value;return typeof o==typeof c&&o<c}],"filter->":[Xn,[Gn,Qn],(a,[i,o])=>{const c=a.properties()[i.value],h=o.value;return typeof c==typeof h&&c>h}],"filter-id->":[Xn,[Qn],(a,[i])=>{const o=a.id(),c=i.value;return typeof o==typeof c&&o>c}],"filter-<=":[Xn,[Gn,Qn],(a,[i,o])=>{const c=a.properties()[i.value],h=o.value;return typeof c==typeof h&&c<=h}],"filter-id-<=":[Xn,[Qn],(a,[i])=>{const o=a.id(),c=i.value;return typeof o==typeof c&&o<=c}],"filter->=":[Xn,[Gn,Qn],(a,[i,o])=>{const c=a.properties()[i.value],h=o.value;return typeof c==typeof h&&c>=h}],"filter-id->=":[Xn,[Qn],(a,[i])=>{const o=a.id(),c=i.value;return typeof o==typeof c&&o>=c}],"filter-has":[Xn,[Qn],(a,[i])=>i.value in a.properties()],"filter-has-id":[Xn,[],a=>null!==a.id()&&void 0!==a.id()],"filter-type-in":[Xn,[yo(Gn)],(a,[i])=>i.value.indexOf(a.geometryType())>=0],"filter-id-in":[Xn,[yo(Qn)],(a,[i])=>i.value.indexOf(a.id())>=0],"filter-in-small":[Xn,[Gn,yo(Qn)],(a,[i,o])=>o.value.indexOf(a.properties()[i.value])>=0],"filter-in-large":[Xn,[Gn,yo(Qn)],(a,[i,o])=>function(c,h,m,g){for(;m<=g;){const x=m+g>>1;if(h[x]===c)return!0;h[x]>c?g=x-1:m=x+1}return!1}(a.properties()[i.value],o.value,0,o.value.length-1)],all:{type:Xn,overloads:[[[Xn,Xn],(a,[i,o])=>i.evaluate(a)&&o.evaluate(a)],[cl(Xn),(a,i)=>{for(const o of i)if(!o.evaluate(a))return!1;return!0}]]},any:{type:Xn,overloads:[[[Xn,Xn],(a,[i,o])=>i.evaluate(a)||o.evaluate(a)],[cl(Xn),(a,i)=>{for(const o of i)if(o.evaluate(a))return!0;return!1}]]},"!":[Xn,[Xn],(a,[i])=>!i.evaluate(a)],"is-supported-script":[Xn,[Gn],(a,[i])=>{const o=a.globals&&a.globals.isSupportedScript;return!o||o(i.evaluate(a))}],upcase:[Gn,[Gn],(a,[i])=>i.evaluate(a).toUpperCase()],downcase:[Gn,[Gn],(a,[i])=>i.evaluate(a).toLowerCase()],concat:[Gn,cl(Qn),(a,i)=>i.map(o=>Vs(o.evaluate(a))).join("")],"resolved-locale":[Gn,[Xt],(a,[i])=>i.evaluate(a).resolvedLocale()],random:[Tt,[Tt,Tt,Qn],(a,i)=>{const[o,c,h]=i.map(g=>g.evaluate(a));if(o>c||o===c)return o;let m;if("string"==typeof h)m=function(g){let x=0;if(0===g.length)return x;for(let w=0;w<g.length;w++)x=(x<<5)-x+g.charCodeAt(w),x|=0;return x}(h);else{if("number"!=typeof h)throw new Ar(`Invalid seed input: ${h}`);m=h}return o+ll(m)()*(c-o)}]});class u_{constructor(i,o,c,h){var m;this.expression=i,this._warningHistory={},this._evaluator=new Kd(c,h),this._defaultValue=o?"color"===(m=o).type&&(ch(m.default)||Array.isArray(m.default))?new Kn(0,0,0,0):"color"===m.type?Kn.parse(m.default)||null:void 0===m.default?null:m.default:null,this._enumValues=o&&"enum"===o.type?o.values:null,this.configDependencies=ih(i)}evaluateWithoutErrorHandling(i,o,c,h,m,g,x,w){return this._evaluator.globals=i,this._evaluator.feature=o,this._evaluator.featureState=c,this._evaluator.canonical=h||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=g,this._evaluator.featureTileCoord=x||null,this._evaluator.featureDistanceData=w||null,this.expression.evaluate(this._evaluator)}evaluate(i,o,c,h,m,g,x,w){this._evaluator.globals=i,this._evaluator.feature=o||null,this._evaluator.featureState=c||null,this._evaluator.canonical=h||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=g||null,this._evaluator.featureTileCoord=x||null,this._evaluator.featureDistanceData=w||null;try{const T=this.expression.evaluate(this._evaluator);if(null==T||"number"==typeof T&&T!=T)return this._defaultValue;if(this._enumValues&&!(T in this._enumValues))throw new Ar(`Expected value to be one of ${Object.keys(this._enumValues).map(I=>JSON.stringify(I)).join(", ")}, but found ${JSON.stringify(T)} instead.`);return T}catch(T){return this._warningHistory[T.message]||(this._warningHistory[T.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${T.message}`)),this._defaultValue}}}function d_(a){return Array.isArray(a)&&a.length>0&&"string"==typeof a[0]&&a[0]in ah}function Wc(a,i,o,c){const h=new rh(ah,[],i?function(g){const x={color:gi,string:Gn,number:Tt,enum:Gn,boolean:Xn,formatted:Fc,resolvedImage:kc};return"array"===g.type?yo(x[g.value]||Qn,g.length):x[g.type]}(i):void 0,void 0,void 0,o,c),m=h.parse(a,void 0,void 0,void 0,i&&"string"===i.type?{typeAnnotation:"coerce"}:void 0);return m?Mf(new u_(m,i,o,c)):ul(h.errors)}class Of{constructor(i,o,c,h){this.kind=i,this._styleExpression=o,this.isLightConstant=c,this.isLineProgressConstant=h,this.isStateDependent="constant"!==i&&!Ql(o.expression),this.configDependencies=ih(o.expression)}evaluateWithoutErrorHandling(i,o,c,h,m,g){return this._styleExpression.evaluateWithoutErrorHandling(i,o,c,h,m,g)}evaluate(i,o,c,h,m,g){return this._styleExpression.evaluate(i,o,c,h,m,g)}}class Zc{constructor(i,o,c,h,m,g){this.kind=i,this.zoomStops=c,this._styleExpression=o,this.isStateDependent="camera"!==i&&!Ql(o.expression),this.isLightConstant=m,this.isLineProgressConstant=g,this.configDependencies=ih(o.expression),this.interpolationType=h}evaluateWithoutErrorHandling(i,o,c,h,m,g){return this._styleExpression.evaluateWithoutErrorHandling(i,o,c,h,m,g)}evaluate(i,o,c,h,m,g){return this._styleExpression.evaluate(i,o,c,h,m,g)}interpolationFactor(i,o,c){return this.interpolationType?ls.interpolationFactor(this.interpolationType,i,o,c):0}}function Ff(a,i,o,c){if("error"===(a=Wc(a,i,o,c)).result)return a;const h=a.value.expression,m=Fn(h);if(!m&&!Zu(i))return ul([new Hn("","data expressions not supported")]);const g=ga(h,["zoom","pitch","distance-from-center"]);if(!g&&!Pf(i))return ul([new Hn("","zoom expressions not supported")]);const x=ga(h,["measure-light"]);if(!x&&!dm(i))return ul([new Hn("","measure-light expression not supported")]);const w=ga(h,["line-progress"]);if(!w&&!dl(i.expression,"line-progress"))return ul([new Hn("","line-progress expression not supported")]);const T=i.expression&&i.expression.relaxZoomRestriction,I=uh(h);return I||g||T?I instanceof Hn?ul([I]):I instanceof ls&&!Xu(i)?ul([new Hn("",'"interpolate" expressions cannot be used with this property')]):Mf(I?new Zc(m&&w?"camera":"composite",a.value,I.labels,I instanceof ls?I.interpolation:void 0,x,w):new Of(m&&w?"constant":"source",a.value,x,w)):ul([new Hn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class hl{constructor(i,o){this._parameters=i,this._specification=o,Rc(this,Rf(this._parameters,this._specification))}static deserialize(i){return new hl(i._parameters,i._specification)}static serialize(i){return{_parameters:i._parameters,_specification:i._specification}}}function uh(a){let i=null;if(a instanceof oh)i=uh(a.result);else if(a instanceof sm){for(const o of a.args)if(i=uh(o),i)break}else(a instanceof rl||a instanceof ls)&&a.input instanceof Jr&&"zoom"===a.input.name&&(i=a);return i instanceof Hn||a.eachChild(o=>{const c=uh(o);c instanceof Hn?i=c:i&&c&&i!==c&&(i=new Hn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),i}var dh,Cv,nc=Vd(function(){if(Cv)return dh;Cv=1,dh=i;var a=3;function i(o,c,h){var m=this.cells=[];if(o instanceof ArrayBuffer){this.arrayBuffer=o;var g=new Int32Array(this.arrayBuffer);o=g[0],this.d=(c=g[1])+2*(h=g[2]);for(var x=0;x<this.d*this.d;x++){var w=g[a+x],T=g[a+x+1];m.push(w===T?null:g.subarray(w,T))}var I=g[a+m.length+1];this.keys=g.subarray(g[a+m.length],I),this.bboxes=g.subarray(I),this.insert=this._insertReadonly}else{this.d=c+2*h;for(var A=0;A<this.d*this.d;A++)m.push([]);this.keys=[],this.bboxes=[]}this.n=c,this.extent=o,this.padding=h,this.scale=c/o,this.uid=0;var M=h/c*o;this.min=-M,this.max=o+M}return i.prototype.insert=function(o,c,h,m,g){this._forEachCell(c,h,m,g,this._insertCell,this.uid++),this.keys.push(o),this.bboxes.push(c),this.bboxes.push(h),this.bboxes.push(m),this.bboxes.push(g)},i.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},i.prototype._insertCell=function(o,c,h,m,g,x){this.cells[g].push(x)},i.prototype.query=function(o,c,h,m,g){var x=this.min,w=this.max;if(o<=x&&c<=x&&w<=h&&w<=m&&!g)return Array.prototype.slice.call(this.keys);var T=[];return this._forEachCell(o,c,h,m,this._queryCell,T,{},g),T},i.prototype._queryCell=function(o,c,h,m,g,x,w,T){var I=this.cells[g];if(null!==I)for(var A=this.keys,M=this.bboxes,k=0;k<I.length;k++){var L=I[k];if(void 0===w[L]){var V=4*L;(T?T(M[V+0],M[V+1],M[V+2],M[V+3]):o<=M[V+2]&&c<=M[V+3]&&h>=M[V+0]&&m>=M[V+1])?(w[L]=!0,x.push(A[L])):w[L]=!1}}},i.prototype._forEachCell=function(o,c,h,m,g,x,w,T){for(var I=this._convertToCellCoord(o),A=this._convertToCellCoord(c),M=this._convertToCellCoord(h),k=this._convertToCellCoord(m),L=I;L<=M;L++)for(var V=A;V<=k;V++){var j=this.d*V+L;if((!T||T(this._convertFromCellCoord(L),this._convertFromCellCoord(V),this._convertFromCellCoord(L+1),this._convertFromCellCoord(V+1)))&&g.call(this,o,c,h,m,j,x,w,T))return}},i.prototype._convertFromCellCoord=function(o){return(o-this.padding)/this.scale},i.prototype._convertToCellCoord=function(o){return Math.max(0,Math.min(this.d-1,Math.floor(o*this.scale)+this.padding))},i.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var o=this.cells,c=a+this.cells.length+1+1,h=0,m=0;m<this.cells.length;m++)h+=this.cells[m].length;var g=new Int32Array(c+h+this.keys.length+this.bboxes.length);g[0]=this.extent,g[1]=this.n,g[2]=this.padding;for(var x=c,w=0;w<o.length;w++){var T=o[w];g[a+w]=x,g.set(T,x),x+=T.length}return g[a+o.length]=x,g.set(this.keys,x),g[a+o.length+1]=x+=this.keys.length,g.set(this.bboxes,x),x+=this.bboxes.length,g.buffer},dh}());const Yu={};function Et(a,i,o={}){Object.defineProperty(a,"_classRegistryKey",{value:i,writable:!1}),Yu[i]={klass:a,omit:o.omit||[]}}Et(Object,"Object"),nc.serialize=function(a,i){const o=a.toArrayBuffer();return i&&i.add(o),{buffer:o}},nc.deserialize=function(a){return new nc(a.buffer)},Object.defineProperty(nc,"name",{value:"Grid"}),Et(nc,"Grid"),delete Je.prototype.constructor,typeof DOMMatrix<"u"&&Et(DOMMatrix,"DOMMatrix"),Et(Kn,"Color"),Et(Error,"Error"),Et(Kr,"Formatted"),Et(Xp,"FormattedSection"),Et(On,"AJAXError"),Et(vo,"ResolvedImage"),Et(hl,"StylePropertyFunction"),Et(u_,"StyleExpression",{omit:["_evaluator"]}),Et(Jt,"ImageId"),Et(pa,"ImageVariant"),Et(Zc,"ZoomDependentExpression"),Et(Of,"ZoomConstantExpression"),Et(Jr,"CompoundExpression",{omit:["_evaluate"]});for(const a in ah)Yu[ah[a]._classRegistryKey]||Et(ah[a],`Expression${a}`);function kf(a){return a&&typeof ArrayBuffer<"u"&&(a instanceof ArrayBuffer||a.constructor&&"ArrayBuffer"===a.constructor.name)}function hh(a){return self.ImageBitmap&&a instanceof ImageBitmap}function fl(a,i){if(null==a||"boolean"==typeof a||"number"==typeof a||"string"==typeof a||a instanceof Boolean||a instanceof Number||a instanceof String||a instanceof Date||a instanceof RegExp)return a;if(kf(a)||hh(a))return i&&i.add(a),a;if(ArrayBuffer.isView(a))return i&&i.add(a.buffer),a;if(a instanceof ImageData)return i&&i.add(a.data.buffer),a;if(Array.isArray(a)){const o=[];for(const c of a)o.push(fl(c,i));return o}if(a instanceof Map){const o={$name:"Map",entries:[]};for(const[c,h]of a.entries())o.entries.push(fl(c),fl(h,i));return o}if(a instanceof Set){const o={$name:"Set"};let c=0;for(const h of a.values())o[++c]=fl(h);return o}if(a instanceof DOMMatrix){const o={$name:"DOMMatrix"},c=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const h of c)o[h]=a[h];return o}if("bigint"==typeof a)return{$name:"BigInt",value:a.toString()};if("object"==typeof a){const o=a.constructor,c=o._classRegistryKey;if(!c)throw new Error(`Can't serialize object of unregistered class "${o.name}".`);const h=o.serialize?o.serialize(a,i):{};if(!o.serialize){for(const m in a)a.hasOwnProperty(m)&&(Yu[c].omit.indexOf(m)>=0||(h[m]=fl(a[m],i)));a instanceof Error&&(h.message=a.message)}if(h.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==c&&(h.$name=c),h}throw new Error("can't serialize object of type "+typeof a)}function $o(a){if(null==a||"boolean"==typeof a||"number"==typeof a||"string"==typeof a||a instanceof Boolean||a instanceof Number||a instanceof String||a instanceof Date||a instanceof RegExp||kf(a)||hh(a)||ArrayBuffer.isView(a)||a instanceof ImageData)return a;if(Array.isArray(a))return a.map($o);if("object"==typeof a){const i=a.$name||"Object";if("Map"===i){const h=a.entries||[],m=new Map;for(let g=0;g<h.length;g+=2)m.set($o(h[g]),$o(h[g+1]));return m}if("Set"===i){const h=new Set;for(const m of Object.keys(a))"$name"!==m&&h.add($o(a[m]));return h}if("DOMMatrix"===i){let h;return h=a.is2D?[a.a,a.b,a.c,a.d,a.e,a.f]:[a.m11,a.m12,a.m13,a.m14,a.m21,a.m22,a.m23,a.m24,a.m31,a.m32,a.m33,a.m34,a.m41,a.m42,a.m43,a.m44],new DOMMatrix(h)}if("BigInt"===i)return BigInt(a.value);const{klass:o}=Yu[i];if(!o)throw new Error(`Can't deserialize unregistered class "${i}".`);if(o.deserialize)return o.deserialize(a);const c=Object.create(o.prototype);for(const h of Object.keys(a))"$name"!==h&&(c[h]=$o(a[h]));return c}throw new Error("can't deserialize object of type "+typeof a)}const jt={"Latin-1 Supplement":a=>a>=128&&a<=255,Arabic:a=>a>=1536&&a<=1791,"Arabic Supplement":a=>a>=1872&&a<=1919,"Arabic Extended-A":a=>a>=2208&&a<=2303,"Hangul Jamo":a=>a>=4352&&a<=4607,"Unified Canadian Aboriginal Syllabics":a=>a>=5120&&a<=5759,Khmer:a=>a>=6016&&a<=6143,"Unified Canadian Aboriginal Syllabics Extended":a=>a>=6320&&a<=6399,"General Punctuation":a=>a>=8192&&a<=8303,"Letterlike Symbols":a=>a>=8448&&a<=8527,"Number Forms":a=>a>=8528&&a<=8591,"Miscellaneous Technical":a=>a>=8960&&a<=9215,"Control Pictures":a=>a>=9216&&a<=9279,"Optical Character Recognition":a=>a>=9280&&a<=9311,"Enclosed Alphanumerics":a=>a>=9312&&a<=9471,"Geometric Shapes":a=>a>=9632&&a<=9727,"Miscellaneous Symbols":a=>a>=9728&&a<=9983,"Miscellaneous Symbols and Arrows":a=>a>=11008&&a<=11263,"CJK Radicals Supplement":a=>a>=11904&&a<=12031,"Kangxi Radicals":a=>a>=12032&&a<=12255,"Ideographic Description Characters":a=>a>=12272&&a<=12287,"CJK Symbols and Punctuation":a=>a>=12288&&a<=12351,Hiragana:a=>a>=12352&&a<=12447,Katakana:a=>a>=12448&&a<=12543,Bopomofo:a=>a>=12544&&a<=12591,"Hangul Compatibility Jamo":a=>a>=12592&&a<=12687,Kanbun:a=>a>=12688&&a<=12703,"Bopomofo Extended":a=>a>=12704&&a<=12735,"CJK Strokes":a=>a>=12736&&a<=12783,"Katakana Phonetic Extensions":a=>a>=12784&&a<=12799,"Enclosed CJK Letters and Months":a=>a>=12800&&a<=13055,"CJK Compatibility":a=>a>=13056&&a<=13311,"CJK Unified Ideographs Extension A":a=>a>=13312&&a<=19903,"Yijing Hexagram Symbols":a=>a>=19904&&a<=19967,"CJK Unified Ideographs":a=>a>=19968&&a<=40959,"Yi Syllables":a=>a>=40960&&a<=42127,"Yi Radicals":a=>a>=42128&&a<=42191,"Hangul Jamo Extended-A":a=>a>=43360&&a<=43391,"Hangul Syllables":a=>a>=44032&&a<=55215,"Hangul Jamo Extended-B":a=>a>=55216&&a<=55295,"Private Use Area":a=>a>=57344&&a<=63743,"CJK Compatibility Ideographs":a=>a>=63744&&a<=64255,"Arabic Presentation Forms-A":a=>a>=64336&&a<=65023,"Vertical Forms":a=>a>=65040&&a<=65055,"CJK Compatibility Forms":a=>a>=65072&&a<=65103,"Small Form Variants":a=>a>=65104&&a<=65135,"Arabic Presentation Forms-B":a=>a>=65136&&a<=65279,"Halfwidth and Fullwidth Forms":a=>a>=65280&&a<=65519,Osage:a=>a>=66736&&a<=66815,"CJK Unified Ideographs Extension B":a=>a>=131072&&a<=173791};function Lf(a){for(const i of a)if(Nf(i.charCodeAt(0)))return!0;return!1}function Iv(a){for(const i of a)if(!Qx(i.charCodeAt(0)))return!1;return!0}function Qx(a){return!(jt.Arabic(a)||jt["Arabic Supplement"](a)||jt["Arabic Extended-A"](a)||jt["Arabic Presentation Forms-A"](a)||jt["Arabic Presentation Forms-B"](a))}function Nf(a){return!(746!==a&&747!==a&&(a<4352||!(jt["Bopomofo Extended"](a)||jt.Bopomofo(a)||jt["CJK Compatibility Forms"](a)&&!(a>=65097&&a<=65103)||jt["CJK Compatibility Ideographs"](a)||jt["CJK Compatibility"](a)||jt["CJK Radicals Supplement"](a)||jt["CJK Strokes"](a)||!(!jt["CJK Symbols and Punctuation"](a)||a>=12296&&a<=12305||a>=12308&&a<=12319||12336===a)||jt["CJK Unified Ideographs Extension A"](a)||jt["CJK Unified Ideographs"](a)||jt["Enclosed CJK Letters and Months"](a)||jt["Hangul Compatibility Jamo"](a)||jt["Hangul Jamo Extended-A"](a)||jt["Hangul Jamo Extended-B"](a)||jt["Hangul Jamo"](a)||jt["Hangul Syllables"](a)||jt.Hiragana(a)||jt["Ideographic Description Characters"](a)||jt.Kanbun(a)||jt["Kangxi Radicals"](a)||jt["Katakana Phonetic Extensions"](a)||jt.Katakana(a)&&12540!==a||!(!jt["Halfwidth and Fullwidth Forms"](a)||65288===a||65289===a||65293===a||a>=65306&&a<=65310||65339===a||65341===a||65343===a||a>=65371&&a<=65503||65507===a||a>=65512&&a<=65519)||!(!jt["Small Form Variants"](a)||a>=65112&&a<=65118||a>=65123&&a<=65126)||jt["Unified Canadian Aboriginal Syllabics"](a)||jt["Unified Canadian Aboriginal Syllabics Extended"](a)||jt["Vertical Forms"](a)||jt["Yijing Hexagram Symbols"](a)||jt["Yi Syllables"](a)||jt["Yi Radicals"](a))))}function ta(a){return!(Nf(a)||(i=a,jt["Latin-1 Supplement"](i)&&(167===i||169===i||174===i||177===i||188===i||189===i||190===i||215===i||247===i)||jt["General Punctuation"](i)&&(8214===i||8224===i||8225===i||8240===i||8241===i||8251===i||8252===i||8258===i||8263===i||8264===i||8265===i||8273===i)||jt["Letterlike Symbols"](i)||jt["Number Forms"](i)||jt["Miscellaneous Technical"](i)&&(i>=8960&&i<=8967||i>=8972&&i<=8991||i>=8996&&i<=9e3||9003===i||i>=9085&&i<=9114||i>=9150&&i<=9165||9167===i||i>=9169&&i<=9179||i>=9186&&i<=9215)||jt["Control Pictures"](i)&&9251!==i||jt["Optical Character Recognition"](i)||jt["Enclosed Alphanumerics"](i)||jt["Geometric Shapes"](i)||jt["Miscellaneous Symbols"](i)&&!(i>=9754&&i<=9759)||jt["Miscellaneous Symbols and Arrows"](i)&&(i>=11026&&i<=11055||i>=11088&&i<=11097||i>=11192&&i<=11243)||jt["CJK Symbols and Punctuation"](i)||jt.Katakana(i)||jt["Private Use Area"](i)||jt["CJK Compatibility Forms"](i)||jt["Small Form Variants"](i)||jt["Halfwidth and Fullwidth Forms"](i)||8734===i||8756===i||8757===i||i>=9984&&i<=10087||i>=10102&&i<=10131||65532===i||65533===i));var i}function pm(a){return jt.Arabic(a)||jt["Arabic Supplement"](a)||jt["Arabic Extended-A"](a)||jt["Arabic Presentation Forms-A"](a)||jt["Arabic Presentation Forms-B"](a)}function zf(a){return a>=1424&&a<=2303||jt["Arabic Presentation Forms-A"](a)||jt["Arabic Presentation Forms-B"](a)}function Av(a,i){return!(!i&&zf(a)||a>=2304&&a<=3583||a>=3840&&a<=4255||jt.Khmer(a))}function f_(a){for(const i of a)if(zf(i.charCodeAt(0)))return!0;return!1}const us={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let mm=null,To=us.unavailable,ic=null;const _a=function(a){a&&"string"==typeof a&&a.indexOf("NetworkError")>-1&&(To=us.error),mm&&mm(a)};function Bf(){Vf.fire(new Yr("pluginStateChange",{pluginStatus:To,pluginURL:ic}))}const Vf=new Nu,dr=function(){return To},jf=function(){if(To!==us.deferred||!ic)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");To=us.loading,Bf(),ic&&Ic({url:ic},a=>{a?_a(a):(To=us.loaded,Bf())})},Gs={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>To===us.loaded||null!=Gs.applyArabicShaping,isLoading:()=>To===us.loading,setState(a){To=a.pluginStatus,ic=a.pluginURL},isParsing:()=>To===us.parsing,isParsed:()=>To===us.parsed,getPluginURL:()=>ic};class Tn{constructor(i,o){this.zoom=i,o?(this.now=o.now,this.fadeDuration=o.fadeDuration,this.transition=o.transition,this.pitch=o.pitch,this.brightness=o.brightness,this.worldview=o.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(i){return function(o,c){for(const h of o)if(!Av(h.charCodeAt(0),c))return!1;return!0}(i,Gs.isLoaded())}}class fh{constructor(i,o,c,h){this.property=i,this.value=o,this.expression=function(m,g,x,w){if(ch(m))return new hl(m,g);if(d_(m)||Array.isArray(m)&&m.length>0){const T=Ff(m,g,x,w);if("error"===T.result)throw new Error(T.value.map(I=>`${I.key}: ${I.message}`).join(", "));return T.value}{let T=m;return"string"==typeof m&&"color"===g.type&&(T=Kn.parse(m)),{kind:"constant",configDependencies:new Set,evaluate:()=>T}}}(void 0===o?i.specification.default:o,i.specification,c,h)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(i,o,c){return this.property.possiblyEvaluate(this,i,o,c)}}class ph{constructor(i,o,c){this.property=i,this.value=new fh(i,void 0,o,c)}transitioned(i,o){return new Es(this.property,this.value,o,Ie({},i.transition,this.transition),i.now)}untransitioned(){return new Es(this.property,this.value,null,{},0)}}class za{constructor(i,o,c){this._properties=i,this._values=Object.create(i.defaultTransitionablePropertyValues),this._scope=o,this._options=c,this.configDependencies=new Set}getValue(i){return pn(this._values[i].value.value)}setValue(i,o){this._values.hasOwnProperty(i)||(this._values[i]=new ph(this._values[i].property,this._scope,this._options)),this._values[i].value=new fh(this._values[i].property,null===o?void 0:pn(o),this._scope,this._options),this._values[i].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[i].value.expression.configDependencies]))}setTransitionOrValue(i,o){o&&(this._options=o);const c=this._properties.properties;if(i)for(const h in i){const m=i[h];if(h.endsWith("-transition")){const g=h.slice(0,-11);c[g]&&this.setTransition(g,m)}else c.hasOwnProperty(h)&&this.setValue(h,m)}}getTransition(i){return pn(this._values[i].transition)}setTransition(i,o){this._values.hasOwnProperty(i)||(this._values[i]=new ph(this._values[i].property)),this._values[i].transition=pn(o)||void 0}serialize(){const i={};for(const o of Object.keys(this._values)){const c=this.getValue(o);void 0!==c&&(i[o]=c);const h=this.getTransition(o);void 0!==h&&(i[`${o}-transition`]=h)}return i}transitioned(i,o){const c=new p_(this._properties);for(const h of Object.keys(this._values))c._values[h]=this._values[h].transitioned(i,o._values[h]);return c}untransitioned(){const i=new p_(this._properties);for(const o of Object.keys(this._values))i._values[o]=this._values[o].untransitioned();return i}}class Es{constructor(i,o,c,h,m){const g=h.delay||0,x=h.duration||0;m=m||0,this.property=i,this.value=o,this.begin=m+g,this.end=this.begin+x,i.specification.transition&&(h.delay||h.duration)&&(this.prior=c)}possiblyEvaluate(i,o,c){const h=i.now||0,m=this.value.possiblyEvaluate(i,o,c),g=this.prior;if(g){if(h>this.end)return this.prior=null,m;if(this.value.isDataDriven())return this.prior=null,m;if(h<this.begin)return g.possiblyEvaluate(i,o,c);{const x=(h-this.begin)/(this.end-this.begin);return this.property.interpolate(g.possiblyEvaluate(i,o,c),m,X(x))}}return m}}class p_{constructor(i){this._properties=i,this._values=Object.create(i.defaultTransitioningPropertyValues)}possiblyEvaluate(i,o,c){const h=new Do(this._properties);for(const m of Object.keys(this._values))h._values[m]=this._values[m].possiblyEvaluate(i,o,c);return h}hasTransition(){for(const i of Object.keys(this._values))if(this._values[i].prior)return!0;return!1}}class rc{constructor(i,o,c){this._properties=i,this._values=Object.create(i.defaultPropertyValues),this._scope=o,this._options=c,this.configDependencies=new Set}getValue(i){return pn(this._values[i].value)}setValue(i,o){this._values[i]=new fh(this._values[i].property,null===o?void 0:pn(o),this._scope,this._options),this._values[i].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[i].expression.configDependencies]))}serialize(){const i={};for(const o of Object.keys(this._values)){const c=this.getValue(o);void 0!==c&&(i[o]=c)}return i}possiblyEvaluate(i,o,c){const h=new Do(this._properties);for(const m of Object.keys(this._values))h._values[m]=this._values[m].possiblyEvaluate(i,o,c);return h}}class Xc{constructor(i,o,c){this.property=i,this.value=o,this.parameters=c}isConstant(){return"constant"===this.value.kind}constantOr(i){return"constant"===this.value.kind?this.value.value:i}evaluate(i,o,c,h){return this.property.evaluate(this.value,this.parameters,i,o,c,h)}}class Do{constructor(i){this._properties=i,this._values=Object.create(i.defaultPossiblyEvaluatedValues)}get(i){return this._values[i]}}class it{constructor(i){this.specification=i}possiblyEvaluate(i,o){return i.expression.evaluate(o)}interpolate(i,o,c){const h=ju[this.specification.type];return h?h(i,o,c):i}}class _t{constructor(i,o){this.specification=i,this.overrides=o}possiblyEvaluate(i,o,c,h){return new Xc(this,"constant"===i.expression.kind||"camera"===i.expression.kind?{kind:"constant",value:i.expression.evaluate(o,null,{},c,h)}:i.expression,o)}interpolate(i,o,c){if("constant"!==i.value.kind||"constant"!==o.value.kind)return i;if(void 0===i.value.value||void 0===o.value.value)return new Xc(this,{kind:"constant",value:void 0},i.parameters);const h=ju[this.specification.type];return h?new Xc(this,{kind:"constant",value:h(i.value.value,o.value.value,c)},i.parameters):i}evaluate(i,o,c,h,m,g){return"constant"===i.kind?i.value:i.evaluate(o,c,h,m,g)}}class Yc{constructor(i){this.specification=i}possiblyEvaluate(i,o,c,h){return!!i.expression.evaluate(o,null,{},c,h)}interpolate(){return!1}}class Ki{constructor(i){this.properties=i,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const o=new Tn(0,{});for(const c in i){const h=i[c];h.specification.overridable&&this.overridableProperties.push(c);const m=this.defaultPropertyValues[c]=new fh(h,void 0),g=this.defaultTransitionablePropertyValues[c]=new ph(h);this.defaultTransitioningPropertyValues[c]=g.untransitioned(),this.defaultPossiblyEvaluatedValues[c]=m.possiblyEvaluate(o)}}}Et(_t,"DataDrivenProperty"),Et(it,"DataConstantProperty"),Et(Yc,"ColorRampProperty");var Se=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"expression"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function m_(a){return a instanceof Number||a instanceof String||a instanceof Boolean?a.valueOf():a}function Sn(a){if(Array.isArray(a))return a.map(Sn);if(a instanceof Object&&!(a instanceof Number||a instanceof String||a instanceof Boolean)){const i={};for(const o in a)i[o]=Sn(a[o]);return i}return m_(a)}function Ku(a){if(!0===a||!1===a)return!0;if(!Array.isArray(a)||0===a.length)return!1;switch(a[0]){case"has":return a.length>=2&&"$id"!==a[1]&&"$type"!==a[1];case"in":return a.length>=3&&("string"!=typeof a[1]||Array.isArray(a[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==a.length||Array.isArray(a[1])||Array.isArray(a[2]);case"any":case"all":for(const i of a.slice(1))if(!Ku(i)&&"boolean"!=typeof i)return!1;return!0;default:return!0}}function mh(a,i="",o=null,c="fill"){if(null==a)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Ku(a)||(a=Hf(a));const h=a;let m=!0;try{m=function(I){if(!Qu(I))return I;let A=Sn(I);return Uf(A),A=gm(A),A}(h)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(h,null,2)}\n        `)}let g=null,x=null;if("background"!==c&&"sky"!==c&&"slot"!==c){x=Se[`filter_${c}`];const I=Wc(m,x,i,o);if("error"===I.result)throw new Error(I.value.map(A=>`${A.key}: ${A.message}`).join(", "));g=(A,M,k)=>I.value.evaluate(A,M,{},k)}let w=null,T=null;if(m!==h){const I=Wc(h,x,i,o);if("error"===I.result)throw new Error(I.value.map(A=>`${A.key}: ${A.message}`).join(", "));w=(A,M,k,L,V)=>I.value.evaluate(A,M,{},k,void 0,void 0,L,V),T=!Fn(I.value.expression)}return{filter:g,dynamicFilter:w||void 0,needGeometry:_m(m),needFeature:!!T}}function gm(a){if(!Array.isArray(a))return a;const i=function(o){if(ya.has(o[0]))for(let c=1;c<o.length;c++)if(Qu(o[c]))return!0;return o}(a);return!0===i?i:i.map(o=>gm(o))}function Uf(a){let i=!1;const o=[];if("case"===a[0]){for(let c=1;c<a.length-1;c+=2)i=i||Qu(a[c]),o.push(a[c+1]);o.push(a[a.length-1])}else if("match"===a[0]){i=i||Qu(a[1]);for(let c=2;c<a.length-1;c+=2)o.push(a[c+1]);o.push(a[a.length-1])}else if("step"===a[0]){i=i||Qu(a[1]);for(let c=1;c<a.length-1;c+=2)o.push(a[c+1])}i&&(a.length=0,a.push("any",...o));for(let c=1;c<a.length;c++)Uf(a[c])}function Qu(a){if(!Array.isArray(a))return!1;if("pitch"===(i=a[0])||"distance-from-center"===i)return!0;var i;for(let o=1;o<a.length;o++)if(Qu(a[o]))return!0;return!1}const ya=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Ju(a,i){return a<i?-1:a>i?1:0}function _m(a){if(!Array.isArray(a))return!1;if("within"===a[0]||"distance"===a[0])return!0;for(let i=1;i<a.length;i++)if(_m(a[i]))return!0;return!1}function Hf(a){if(!a)return!0;const i=a[0];return a.length<=1?"any"!==i:"=="===i?ym(a[1],a[2],"=="):"!="===i?At(ym(a[1],a[2],"==")):"<"===i||">"===i||"<="===i||">="===i?ym(a[1],a[2],i):"any"===i?(o=a.slice(1),["any"].concat(o.map(Hf))):"all"===i?["all"].concat(a.slice(1).map(Hf)):"none"===i?["all"].concat(a.slice(1).map(Hf).map(At)):"in"===i?g_(a[1],a.slice(2)):"!in"===i?At(g_(a[1],a.slice(2))):"has"===i?__(a[1]):"!has"!==i||At(__(a[1]));var o}function ym(a,i,o){switch(a){case"$type":return[`filter-type-${o}`,i];case"$id":return[`filter-id-${o}`,i];default:return[`filter-${o}`,a,i]}}function g_(a,i){if(0===i.length)return!1;switch(a){case"$type":return["filter-type-in",["literal",i]];case"$id":return["filter-id-in",["literal",i]];default:return i.length>200&&!i.some(o=>typeof o!=typeof i[0])?["filter-in-large",a,["literal",i.sort(Ju)]]:["filter-in-small",a,["literal",i]]}}function __(a){switch(a){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",a]}}function At(a){return["!",a]}function ed(a,i){return i?`${a}\x1f${i}`:a}const y_="-transition",ko=new Set(["fill","line","background","hillshade","raster"]);class So extends Nu{constructor(i,o,c,h,m){if(super(),this.id=i.id,this.fqid=ed(this.id,c),this.type=i.type,this.scope=c,this.lut=h,this.options=m,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,"custom"!==i.type){if(this.metadata=i.metadata,this.minzoom=i.minzoom,this.maxzoom=i.maxzoom,i.type&&"background"!==i.type&&"sky"!==i.type&&"slot"!==i.type){this.source=i.source,this.sourceLayer=i["source-layer"],this.filter=i.filter;const g=Wc(this.filter,Se[`filter_${i.type}`]);"error"!==g.result&&(this.configDependencies=new Set([...this.configDependencies,...g.value.configDependencies]))}if(i.slot&&(this.slot=i.slot),o.layout&&(this._unevaluatedLayout=new rc(o.layout,this.scope,m),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),o.paint){this._transitionablePaint=new za(o.paint,this.scope,m);for(const g in i.paint)this.setPaintProperty(g,i.paint[g]);for(const g in i.layout)this.setLayoutProperty(g,i.layout[g]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Do(o.paint)}}}onAdd(i){}onRemove(i){}isDraped(i){return!this.is3D(!0)&&ko.has(this.type)}getLayoutProperty(i){return"visibility"===i?this.visibility:this._unevaluatedLayout.getValue(i)}setLayoutProperty(i,o){if("custom"===this.type&&"visibility"===i)return void(this.visibility=o);const c=this._unevaluatedLayout;c._properties.properties[i]&&(c.setValue(i,o),this.configDependencies=new Set([...this.configDependencies,...c.configDependencies]),"visibility"===i&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(i){return i.endsWith(y_)?this._transitionablePaint.getTransition(i.slice(0,-11)):this._transitionablePaint.getValue(i)}setPaintProperty(i,o){const c=this._transitionablePaint,h=c._properties.properties;if(i.endsWith(y_)){const A=i.slice(0,-11);return h[A]&&c.setTransition(A,o||void 0),!1}if(!h[i])return!1;const m=c._values[i],g=m.value.isDataDriven(),x=m.value;c.setValue(i,o),this.configDependencies=new Set([...this.configDependencies,...c.configDependencies]),this._handleSpecialPaintPropertyUpdate(i);const w=c._values[i].value,T=w.isDataDriven(),I=i.endsWith("pattern")||"line-dasharray"===i;return T||g||I||this._handleOverridablePaintPropertyUpdate(i,x,w)}_handleSpecialPaintPropertyUpdate(i){}getProgramIds(){return null}getDefaultProgramParams(i,o,c){return null}_handleOverridablePaintPropertyUpdate(i,o,c){return!1}isHidden(i){return!!(this.minzoom&&i<this.minzoom)||!!(this.maxzoom&&i>=this.maxzoom)||"none"===this.visibility}updateTransitions(i){this._transitioningPaint=this._transitionablePaint.transitioned(i,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(i,o){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(i,void 0,o)),this.paint=this._transitioningPaint.possiblyEvaluate(i,void 0,o)}serialize(){return bn({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(i,o)=>!(void 0===i||"layout"===o&&!Object.keys(i).length||"paint"===o&&!Object.keys(i).length))}is3D(i){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const i in this.paint._values){const o=this.paint.get(i);if(o instanceof Xc&&Zu(o.property.specification)&&("source"===o.value.kind||"composite"===o.value.kind)&&o.value.isStateDependent)return!0}return!1}compileFilter(i){this._filterCompiled||(this._featureFilter=mh(this.filter,this.scope,i),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(i){this._stats&&("shadow"===i.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(i){}queryIntersectsFeature(i,o,c,h,m,g,x,w,T){}}const gh={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Ts{constructor(i,o){this._structArray=i,this._pos1=o*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class wi{constructor(){this.capacity=-1,this.resize(0)}static serialize(i,o){return i._trim(),o&&o.add(i.arrayBuffer),{length:i.length,arrayBuffer:i.arrayBuffer}}static deserialize(i){const o=Object.create(this.prototype);return o.arrayBuffer=i.arrayBuffer,o.length=i.length,o.capacity=i.arrayBuffer.byteLength/o.bytesPerElement,o._refreshViews(),o}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(i){this.reserve(i),this.length=i}reserve(i){if(i>this.capacity){this.capacity=Math.max(i,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const o=this.uint8;this._refreshViews(),o&&this.uint8.set(o)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...i){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...i){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function En(a,i=1){let o=0,c=0;return{members:a.map(h=>{const m=gh[h.type].BYTES_PER_ELEMENT,g=o=vm(o,Math.max(i,m)),x=h.components||1;return c=Math.max(c,m),o+=m*x,{name:h.name,type:h.type,components:x,offset:g}}),size:vm(o,Math.max(c,i)),alignment:i}}function vm(a,i){return Math.ceil(a/i)*i}class Ds extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,o){const c=this.length;return this.resize(c+1),this.emplace(c,i,o)}emplace(i,o,c){const h=2*i;return this.int16[h+0]=o,this.int16[h+1]=c,i}}Ds.prototype.bytesPerElement=4,Et(Ds,"StructArrayLayout2i4");class Kc extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,o,c){const h=this.length;return this.resize(h+1),this.emplace(h,i,o,c)}emplace(i,o,c,h){const m=3*i;return this.int16[m+0]=o,this.int16[m+1]=c,this.int16[m+2]=h,i}}Kc.prototype.bytesPerElement=6,Et(Kc,"StructArrayLayout3i6");class to extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,o,c,h){const m=this.length;return this.resize(m+1),this.emplace(m,i,o,c,h)}emplace(i,o,c,h,m){const g=4*i;return this.int16[g+0]=o,this.int16[g+1]=c,this.int16[g+2]=h,this.int16[g+3]=m,i}}to.prototype.bytesPerElement=8,Et(to,"StructArrayLayout4i8");class ds extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i){const o=this.length;return this.resize(o+1),this.emplace(o,i)}emplace(i,o){return this.float32[1*i+0]=o,i}}ds.prototype.bytesPerElement=4,Et(ds,"StructArrayLayout1f4");class Gf extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c){const h=this.length;return this.resize(h+1),this.emplace(h,i,o,c)}emplace(i,o,c,h){const m=4*i,g=2*i;return this.int16[m+0]=o,this.int16[m+1]=c,this.float32[g+1]=h,i}}Gf.prototype.bytesPerElement=8,Et(Gf,"StructArrayLayout2i1f8");class oc extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,o,c){const h=this.length;return this.resize(h+1),this.emplace(h,i,o,c)}emplace(i,o,c,h){const m=4*i;return this.int16[m+0]=o,this.int16[m+1]=c,this.int16[m+2]=h,i}}oc.prototype.bytesPerElement=8,Et(oc,"StructArrayLayout3i8");class na extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m){const g=this.length;return this.resize(g+1),this.emplace(g,i,o,c,h,m)}emplace(i,o,c,h,m,g){const x=5*i;return this.int16[x+0]=o,this.int16[x+1]=c,this.int16[x+2]=h,this.int16[x+3]=m,this.int16[x+4]=g,i}}na.prototype.bytesPerElement=10,Et(na,"StructArrayLayout5i10");class $f extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,i,o,c,h,m,g,x)}emplace(i,o,c,h,m,g,x,w){const T=6*i,I=12*i,A=3*i;return this.int16[T+0]=o,this.int16[T+1]=c,this.uint8[I+4]=h,this.uint8[I+5]=m,this.uint8[I+6]=g,this.uint8[I+7]=x,this.float32[A+2]=w,i}}$f.prototype.bytesPerElement=12,Et($f,"StructArrayLayout2i4ub1f12");class Ss extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c){const h=this.length;return this.resize(h+1),this.emplace(h,i,o,c)}emplace(i,o,c,h){const m=3*i;return this.float32[m+0]=o,this.float32[m+1]=c,this.float32[m+2]=h,i}}Ss.prototype.bytesPerElement=12,Et(Ss,"StructArrayLayout3f12");class sc extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m){const g=this.length;return this.resize(g+1),this.emplace(g,i,o,c,h,m)}emplace(i,o,c,h,m,g){const x=6*i,w=3*i;return this.uint16[x+0]=o,this.uint16[x+1]=c,this.uint16[x+2]=h,this.uint16[x+3]=m,this.float32[w+2]=g,i}}sc.prototype.bytesPerElement=12,Et(sc,"StructArrayLayout4ui1f12");class td extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,o,c,h){const m=this.length;return this.resize(m+1),this.emplace(m,i,o,c,h)}emplace(i,o,c,h,m){const g=4*i;return this.uint16[g+0]=o,this.uint16[g+1]=c,this.uint16[g+2]=h,this.uint16[g+3]=m,i}}td.prototype.bytesPerElement=8,Et(td,"StructArrayLayout4ui8");class nd extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g){const x=this.length;return this.resize(x+1),this.emplace(x,i,o,c,h,m,g)}emplace(i,o,c,h,m,g,x){const w=6*i;return this.int16[w+0]=o,this.int16[w+1]=c,this.int16[w+2]=h,this.int16[w+3]=m,this.int16[w+4]=g,this.int16[w+5]=x,i}}nd.prototype.bytesPerElement=12,Et(nd,"StructArrayLayout6i12");class id extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x,w,T,I,A,M){const k=this.length;return this.resize(k+1),this.emplace(k,i,o,c,h,m,g,x,w,T,I,A,M)}emplace(i,o,c,h,m,g,x,w,T,I,A,M,k){const L=12*i;return this.int16[L+0]=o,this.int16[L+1]=c,this.int16[L+2]=h,this.int16[L+3]=m,this.uint16[L+4]=g,this.uint16[L+5]=x,this.uint16[L+6]=w,this.uint16[L+7]=T,this.int16[L+8]=I,this.int16[L+9]=A,this.int16[L+10]=M,this.int16[L+11]=k,i}}id.prototype.bytesPerElement=24,Et(id,"StructArrayLayout4i4ui4i24");class Qc extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g){const x=this.length;return this.resize(x+1),this.emplace(x,i,o,c,h,m,g)}emplace(i,o,c,h,m,g,x){const w=10*i,T=5*i;return this.int16[w+0]=o,this.int16[w+1]=c,this.int16[w+2]=h,this.float32[T+2]=m,this.float32[T+3]=g,this.float32[T+4]=x,i}}Qc.prototype.bytesPerElement=20,Et(Qc,"StructArrayLayout3i3f20");class Ba extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h){const m=this.length;return this.resize(m+1),this.emplace(m,i,o,c,h)}emplace(i,o,c,h,m){const g=4*i;return this.float32[g+0]=o,this.float32[g+1]=c,this.float32[g+2]=h,this.float32[g+3]=m,i}}Ba.prototype.bytesPerElement=16,Et(Ba,"StructArrayLayout4f16");class xm extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(i){const o=this.length;return this.resize(o+1),this.emplace(o,i)}emplace(i,o){return this.uint32[1*i+0]=o,i}}xm.prototype.bytesPerElement=4,Et(xm,"StructArrayLayout1ul4");class va extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,o){const c=this.length;return this.resize(c+1),this.emplace(c,i,o)}emplace(i,o,c){const h=2*i;return this.uint16[h+0]=o,this.uint16[h+1]=c,i}}va.prototype.bytesPerElement=4,Et(va,"StructArrayLayout2ui4");class _h extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x,w,T,I,A,M,k){const L=this.length;return this.resize(L+1),this.emplace(L,i,o,c,h,m,g,x,w,T,I,A,M,k)}emplace(i,o,c,h,m,g,x,w,T,I,A,M,k,L){const V=20*i,j=10*i;return this.int16[V+0]=o,this.int16[V+1]=c,this.int16[V+2]=h,this.int16[V+3]=m,this.int16[V+4]=g,this.float32[j+3]=x,this.float32[j+4]=w,this.float32[j+5]=T,this.float32[j+6]=I,this.int16[V+14]=A,this.uint32[j+8]=M,this.uint16[V+18]=k,this.uint16[V+19]=L,i}}_h.prototype.bytesPerElement=40,Et(_h,"StructArrayLayout5i4f1i1ul2ui40");class yh extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,i,o,c,h,m,g,x)}emplace(i,o,c,h,m,g,x,w){const T=8*i;return this.int16[T+0]=o,this.int16[T+1]=c,this.int16[T+2]=h,this.int16[T+4]=m,this.int16[T+5]=g,this.int16[T+6]=x,this.int16[T+7]=w,i}}yh.prototype.bytesPerElement=16,Et(yh,"StructArrayLayout3i2i2i16");class Jc extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m){const g=this.length;return this.resize(g+1),this.emplace(g,i,o,c,h,m)}emplace(i,o,c,h,m,g){const x=4*i,w=8*i;return this.float32[x+0]=o,this.float32[x+1]=c,this.float32[x+2]=h,this.int16[w+6]=m,this.int16[w+7]=g,i}}Jc.prototype.bytesPerElement=16,Et(Jc,"StructArrayLayout2f1f2i16");class eu extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g){const x=this.length;return this.resize(x+1),this.emplace(x,i,o,c,h,m,g)}emplace(i,o,c,h,m,g,x){const w=20*i,T=5*i;return this.uint8[w+0]=o,this.uint8[w+1]=c,this.float32[T+1]=h,this.float32[T+2]=m,this.float32[T+3]=g,this.float32[T+4]=x,i}}eu.prototype.bytesPerElement=20,Et(eu,"StructArrayLayout2ub4f20");class Pi extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,o,c){const h=this.length;return this.resize(h+1),this.emplace(h,i,o,c)}emplace(i,o,c,h){const m=3*i;return this.uint16[m+0]=o,this.uint16[m+1]=c,this.uint16[m+2]=h,i}}Pi.prototype.bytesPerElement=6,Et(Pi,"StructArrayLayout3ui6");class ac extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W,Q,K,te,me){const he=this.length;return this.resize(he+1),this.emplace(he,i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W,Q,K,te,me)}emplace(i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W,Q,K,te,me,he){const fe=30*i,xe=15*i,Ee=60*i;return this.int16[fe+0]=o,this.int16[fe+1]=c,this.int16[fe+2]=h,this.float32[xe+2]=m,this.float32[xe+3]=g,this.uint16[fe+8]=x,this.uint16[fe+9]=w,this.uint32[xe+5]=T,this.uint32[xe+6]=I,this.uint32[xe+7]=A,this.uint16[fe+16]=M,this.uint16[fe+17]=k,this.uint16[fe+18]=L,this.float32[xe+10]=V,this.float32[xe+11]=j,this.uint8[Ee+48]=W,this.uint8[Ee+49]=Q,this.uint8[Ee+50]=K,this.uint32[xe+13]=te,this.int16[fe+28]=me,this.uint8[Ee+58]=he,i}}ac.prototype.bytesPerElement=60,Et(ac,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class bm extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W,Q,K,te,me,he,fe,xe,Ee,Ve,Ce,Ue,ot,$e,Ke,nt,ze){const Qe=this.length;return this.resize(Qe+1),this.emplace(Qe,i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W,Q,K,te,me,he,fe,xe,Ee,Ve,Ce,Ue,ot,$e,Ke,nt,ze)}emplace(i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W,Q,K,te,me,he,fe,xe,Ee,Ve,Ce,Ue,ot,$e,Ke,nt,ze,Qe){const Ae=20*i,Be=40*i,at=80*i;return this.float32[Ae+0]=o,this.float32[Ae+1]=c,this.int16[Be+4]=h,this.int16[Be+5]=m,this.int16[Be+6]=g,this.int16[Be+7]=x,this.int16[Be+8]=w,this.int16[Be+9]=T,this.int16[Be+10]=I,this.int16[Be+11]=A,this.int16[Be+12]=M,this.uint16[Be+13]=k,this.uint16[Be+14]=L,this.uint16[Be+15]=V,this.uint16[Be+16]=j,this.uint16[Be+17]=W,this.uint16[Be+18]=Q,this.uint16[Be+19]=K,this.uint16[Be+20]=te,this.uint16[Be+21]=me,this.uint16[Be+22]=he,this.uint16[Be+23]=fe,this.uint16[Be+24]=xe,this.uint16[Be+25]=Ee,this.uint16[Be+26]=Ve,this.uint16[Be+27]=Ce,this.uint32[Ae+14]=Ue,this.float32[Ae+15]=ot,this.float32[Ae+16]=$e,this.float32[Ae+17]=Ke,this.float32[Ae+18]=nt,this.uint8[at+76]=ze,this.uint16[Be+39]=Qe,i}}bm.prototype.bytesPerElement=80,Et(bm,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class wm extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g){const x=this.length;return this.resize(x+1),this.emplace(x,i,o,c,h,m,g)}emplace(i,o,c,h,m,g,x){const w=6*i;return this.float32[w+0]=o,this.float32[w+1]=c,this.float32[w+2]=h,this.float32[w+3]=m,this.float32[w+4]=g,this.float32[w+5]=x,i}}wm.prototype.bytesPerElement=24,Et(wm,"StructArrayLayout6f24");class Hr extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m){const g=this.length;return this.resize(g+1),this.emplace(g,i,o,c,h,m)}emplace(i,o,c,h,m,g){const x=5*i;return this.float32[x+0]=o,this.float32[x+1]=c,this.float32[x+2]=h,this.float32[x+3]=m,this.float32[x+4]=g,i}}Hr.prototype.bytesPerElement=20,Et(Hr,"StructArrayLayout5f20");class pl extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,i,o,c,h,m,g,x)}emplace(i,o,c,h,m,g,x,w){const T=7*i;return this.float32[T+0]=o,this.float32[T+1]=c,this.float32[T+2]=h,this.float32[T+3]=m,this.float32[T+4]=g,this.float32[T+5]=x,this.float32[T+6]=w,i}}pl.prototype.bytesPerElement=28,Et(pl,"StructArrayLayout7f28");class yr extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x,w,T,I,A){const M=this.length;return this.resize(M+1),this.emplace(M,i,o,c,h,m,g,x,w,T,I,A)}emplace(i,o,c,h,m,g,x,w,T,I,A,M){const k=11*i;return this.float32[k+0]=o,this.float32[k+1]=c,this.float32[k+2]=h,this.float32[k+3]=m,this.float32[k+4]=g,this.float32[k+5]=x,this.float32[k+6]=w,this.float32[k+7]=T,this.float32[k+8]=I,this.float32[k+9]=A,this.float32[k+10]=M,i}}yr.prototype.bytesPerElement=44,Et(yr,"StructArrayLayout11f44");class Em extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x,w,T){const I=this.length;return this.resize(I+1),this.emplace(I,i,o,c,h,m,g,x,w,T)}emplace(i,o,c,h,m,g,x,w,T,I){const A=9*i;return this.float32[A+0]=o,this.float32[A+1]=c,this.float32[A+2]=h,this.float32[A+3]=m,this.float32[A+4]=g,this.float32[A+5]=x,this.float32[A+6]=w,this.float32[A+7]=T,this.float32[A+8]=I,i}}Em.prototype.bytesPerElement=36,Et(Em,"StructArrayLayout9f36");class lc extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o){const c=this.length;return this.resize(c+1),this.emplace(c,i,o)}emplace(i,o,c){const h=2*i;return this.float32[h+0]=o,this.float32[h+1]=c,i}}lc.prototype.bytesPerElement=8,Et(lc,"StructArrayLayout2f8");class Tm extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i,o,c,h){const m=this.length;return this.resize(m+1),this.emplace(m,i,o,c,h)}emplace(i,o,c,h,m){const g=6*i;return this.uint32[3*i+0]=o,this.uint16[g+2]=c,this.uint16[g+3]=h,this.uint16[g+4]=m,i}}Tm.prototype.bytesPerElement=12,Et(Tm,"StructArrayLayout1ul3ui12");class Dm extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(i){const o=this.length;return this.resize(o+1),this.emplace(o,i)}emplace(i,o){return this.uint16[1*i+0]=o,i}}Dm.prototype.bytesPerElement=2,Et(Dm,"StructArrayLayout1ui2");class vh extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j){const W=this.length;return this.resize(W+1),this.emplace(W,i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j)}emplace(i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W){const Q=16*i;return this.float32[Q+0]=o,this.float32[Q+1]=c,this.float32[Q+2]=h,this.float32[Q+3]=m,this.float32[Q+4]=g,this.float32[Q+5]=x,this.float32[Q+6]=w,this.float32[Q+7]=T,this.float32[Q+8]=I,this.float32[Q+9]=A,this.float32[Q+10]=M,this.float32[Q+11]=k,this.float32[Q+12]=L,this.float32[Q+13]=V,this.float32[Q+14]=j,this.float32[Q+15]=W,i}}vh.prototype.bytesPerElement=64,Et(vh,"StructArrayLayout16f64");class tu extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(i,o,c,h,m,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,i,o,c,h,m,g,x)}emplace(i,o,c,h,m,g,x,w){const T=10*i,I=5*i;return this.uint16[T+0]=o,this.uint16[T+1]=c,this.uint16[T+2]=h,this.uint16[T+3]=m,this.float32[I+2]=g,this.float32[I+3]=x,this.float32[I+4]=w,i}}tu.prototype.bytesPerElement=20,Et(tu,"StructArrayLayout4ui3f20");class rd extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(i){const o=this.length;return this.resize(o+1),this.emplace(o,i)}emplace(i,o){return this.int16[1*i+0]=o,i}}rd.prototype.bytesPerElement=2,Et(rd,"StructArrayLayout1i2");class xa extends wi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(i){const o=this.length;return this.resize(o+1),this.emplace(o,i)}emplace(i,o){return this.uint8[1*i+0]=o,i}}xa.prototype.bytesPerElement=1,Et(xa,"StructArrayLayout1ub1");class Sm extends Ts{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Sm.prototype.size=40;class xh extends _h{get(i){return new Sm(this,i)}}Et(xh,"CollisionBoxArray");class nu extends Ts{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(i){this._structArray.uint8[this._pos1+49]=i}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(i){this._structArray.uint8[this._pos1+50]=i}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(i){this._structArray.uint32[this._pos4+13]=i}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(i){this._structArray.uint8[this._pos1+58]=i}}nu.prototype.size=60;class cc extends ac{get(i){return new nu(this,i)}}Et(cc,"PlacedSymbolArray");class bh extends Ts{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(i){this._structArray.uint32[this._pos4+14]=i}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(i){this._structArray.float32[this._pos4+18]=i}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}bh.prototype.size=80;class Cm extends bm{get(i){return new bh(this,i)}}Et(Cm,"SymbolInstanceArray");class qf extends ds{getoffsetX(i){return this.float32[1*i+0]}}Et(qf,"GlyphOffsetArray");class v_ extends Ds{getx(i){return this.int16[2*i+0]}gety(i){return this.int16[2*i+1]}}Et(v_,"SymbolLineVertexArray");class ml extends Ts{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}ml.prototype.size=12;class od extends Tm{get(i){return new ml(this,i)}}Et(od,"FeatureIndexArray");class x_ extends va{geta_centroid_pos0(i){return this.uint16[2*i+0]}geta_centroid_pos1(i){return this.uint16[2*i+1]}}Et(x_,"FillExtrusionCentroidArray");class Mv extends Ts{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Mv.prototype.size=6;class Wf extends Kc{get(i){return new Mv(this,i)}}Et(Wf,"FillExtrusionWallArray");const Pv=En([{name:"a_pos",components:2,type:"Int16"}],4),Rv=En([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Ov=En([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Wi{constructor(i=[]){this.segments=i}_prepareSegment(i,o,c,h){let m=this.segments[this.segments.length-1];return i>Wi.MAX_VERTEX_ARRAY_LENGTH&&yn(`Max vertices per segment is ${Wi.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${i}`),(!m||m.vertexLength+i>Wi.MAX_VERTEX_ARRAY_LENGTH||m.sortKey!==h)&&(m={vertexOffset:o,primitiveOffset:c,vertexLength:0,primitiveLength:0},void 0!==h&&(m.sortKey=h),this.segments.push(m)),m}prepareSegment(i,o,c,h){return this._prepareSegment(i,o.length,c.length,h)}get(){return this.segments}destroy(){for(const i of this.segments)for(const o in i.vaos)i.vaos[o].destroy()}static simpleSegment(i,o,c,h){return new Wi([{vertexOffset:i,primitiveOffset:o,vertexLength:c,primitiveLength:h,vaos:{},sortKey:0}])}}function Fv(a,i){return 256*(a=se(Math.floor(a),0,255))+se(Math.floor(i),0,255)}Wi.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Et(Wi,"SegmentVector");const Im=En([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),iu=En([{name:"a_pattern_b",components:4,type:"Uint16"}]),kv=En([{name:"a_dash",components:4,type:"Uint16"}]);class gl{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(i,o,c,h){this.ids.push(ru(i)),this.positions.push(o,c,h)}eachPosition(i,o){const c=ru(i);let h=0,m=this.ids.length-1;for(;h<m;){const g=h+m>>1;this.ids[g]>=c?m=g:h=g+1}for(;this.ids[h]===c;)o(this.positions[3*h],this.positions[3*h+1],this.positions[3*h+2]),h++}static serialize(i,o){const c=new Float64Array(i.ids),h=new Uint32Array(i.positions);return sd(c,h,0,c.length-1),o&&(o.add(c.buffer),o.add(h.buffer)),{ids:c,positions:h}}static deserialize(i){const o=new gl;let c;o.ids=i.ids,o.positions=i.positions;for(const h of o.ids)h!==c&&o.uniqueIds.push(h),c=h;return o.indexed=!0,o}}function ru(a){const i=+a;return!isNaN(i)&&Number.MIN_SAFE_INTEGER<=i&&i<=Number.MAX_SAFE_INTEGER?i:Wd(String(a))}function sd(a,i,o,c){for(;o<c;){const h=a[o+c>>1];let m=o-1,g=c+1;for(;;){do{m++}while(a[m]<h);do{g--}while(a[g]>h);if(m>=g)break;Am(a,m,g),Am(i,3*m,3*g),Am(i,3*m+1,3*g+1),Am(i,3*m+2,3*g+2)}g-o<c-g?(sd(a,i,o,g),o=g+1):(sd(a,i,g+1,c),c=g)}}function Am(a,i,o){const c=a[i];a[i]=a[o],a[o]=c}Et(gl,"FeaturePositionMap");class $s{constructor(i){this.gl=i.gl,this.initialized=!1}fetchUniformLocation(i,o){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(i,o),this.initialized=!0),!!this.location}set(i,o,c){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class wh extends $s{constructor(i){super(i),this.current=0}set(i,o,c){this.fetchUniformLocation(i,o)&&this.current!==c&&(this.current=c,this.gl.uniform1i(this.location,c))}}class vr extends $s{constructor(i){super(i),this.current=0}set(i,o,c){this.fetchUniformLocation(i,o)&&this.current!==c&&(this.current=c,this.gl.uniform1f(this.location,c))}}class lo extends $s{constructor(i){super(i),this.current=[0,0]}set(i,o,c){this.fetchUniformLocation(i,o)&&(c[0]===this.current[0]&&c[1]===this.current[1]||(this.current=c,this.gl.uniform2f(this.location,c[0],c[1])))}}class ad extends $s{constructor(i){super(i),this.current=[0,0,0]}set(i,o,c){this.fetchUniformLocation(i,o)&&(c[0]===this.current[0]&&c[1]===this.current[1]&&c[2]===this.current[2]||(this.current=c,this.gl.uniform3f(this.location,c[0],c[1],c[2])))}}class uc extends $s{constructor(i){super(i),this.current=[0,0,0,0]}set(i,o,c){this.fetchUniformLocation(i,o)&&(c[0]===this.current[0]&&c[1]===this.current[1]&&c[2]===this.current[2]&&c[3]===this.current[3]||(this.current=c,this.gl.uniform4f(this.location,c[0],c[1],c[2],c[3])))}}class Eh extends $s{constructor(i){super(i),this.current=Kn.transparent.toPremultipliedRenderColor(null)}set(i,o,c){this.fetchUniformLocation(i,o)&&(c.r===this.current.r&&c.g===this.current.g&&c.b===this.current.b&&c.a===this.current.a||(this.current=c,this.gl.uniform4f(this.location,c.r,c.g,c.b,c.a)))}}const Mm=new Float32Array(16);class dc extends $s{constructor(i){super(i),this.current=Mm}set(i,o,c){if(this.fetchUniformLocation(i,o)){if(c[12]!==this.current[12]||c[0]!==this.current[0])return this.current=c,void this.gl.uniformMatrix4fv(this.location,!1,c);for(let h=1;h<16;h++)if(c[h]!==this.current[h]){this.current=c,this.gl.uniformMatrix4fv(this.location,!1,c);break}}}}const Pm=new Float32Array(9),b_=new Float32Array(4);class Zf extends $s{constructor(i){super(i),this.current=b_}set(i,o,c){if(this.fetchUniformLocation(i,o))for(let h=0;h<4;h++)if(c[h]!==this.current[h]){this.current=c,this.gl.uniformMatrix2fv(this.location,!1,c);break}}}function Xf(a){return[Fv(255*a.r,255*a.g),Fv(255*a.b,255*a.a)]}class ld{constructor(i,o,c,h){this.value=i,this.uniformNames=o.map(m=>`u_${m}`),this.type=c,this.context=h}setUniform(i,o,c,h,m){const g=h.constantOr(this.value);o.set(i,m,g instanceof Kn?g.toPremultipliedRenderColor(this.lutExpression&&"none"===this.lutExpression.value?null:this.context.lut):g)}getBinding(i,o){return"color"===this.type?new Eh(i):new vr(i)}}class ou{constructor(i,o){this.uniformNames=o.map(c=>`u_${c}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(i,o){this.pixelRatio=i.pixelRatio||1,this.pattern=i.tl.concat(i.br),this.patternTransition=o?o.tl.concat(o.br):this.pattern}setUniform(i,o,c,h,m){let g=null;"u_pattern"!==m&&"u_dash"!==m||(g=this.pattern),"u_pattern_b"===m&&(g=this.patternTransition),"u_pixel_ratio"===m&&(g=this.pixelRatio),g&&o.set(i,m,g)}getBinding(i,o){return"u_pattern"===o||"u_pattern_b"===o||"u_dash"===o?new uc(i):new vr(i)}}class _l{constructor(i,o,c,h){this.expression=i,this.type=c,this.maxValue=0,this.paintVertexAttributes=o.map(m=>({name:`a_${m}`,type:"Float32",components:"color"===c?2:1,offset:0})),this.paintVertexArray=new h}populatePaintArray(i,o,c,h,m,g,x,w){const T=this.paintVertexArray.length,I="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Tn(0,{brightness:g,worldview:w}),o,{},m,h,x):"constant"===this.expression.kind&&this.expression.value,A=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Tn(0,{brightness:g,worldview:w}),o,{},m,h,x):this.lutExpression.value);this.paintVertexArray.resize(i),this._setPaintValue(T,i,I,A?null:this.context.lut)}updatePaintArray(i,o,c,h,m,g,x,w){const T="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:x,worldview:w},c,h,void 0,m):"constant"===this.expression.kind&&this.expression.value,I=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Tn(0,{brightness:x,worldview:w}),c,h,void 0,m):this.lutExpression.value);this._setPaintValue(i,o,T,I?null:this.context.lut)}_setPaintValue(i,o,c,h){if("color"===this.type){const m=Xf(c.toPremultipliedRenderColor(h));for(let g=i;g<o;g++)this.paintVertexArray.emplace(g,m[0],m[1])}else{for(let m=i;m<o;m++)this.paintVertexArray.emplace(m,c);this.maxValue=Math.max(this.maxValue,Math.abs(c))}}upload(i){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=i.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class hs{constructor(i,o,c,h,m,g){this.expression=i,this.uniformNames=o.map(x=>`u_${x}_t`),this.type=c,this.useIntegerZoom=h,this.context=m,this.maxValue=0,this.paintVertexAttributes=o.map(x=>({name:`a_${x}`,type:"Float32",components:"color"===c?4:2,offset:0})),this.paintVertexArray=new g}populatePaintArray(i,o,c,h,m,g,x,w){const T=this.expression.evaluate(new Tn(this.context.zoom,{brightness:g,worldview:w}),o,{},m,h,x),I=this.expression.evaluate(new Tn(this.context.zoom+1,{brightness:g,worldview:w}),o,{},m,h,x),A=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Tn(0,{brightness:g,worldview:w}),o,{},m,h,x):this.lutExpression.value),M=this.paintVertexArray.length;this.paintVertexArray.resize(i),this._setPaintValue(M,i,T,I,A?null:this.context.lut)}updatePaintArray(i,o,c,h,m,g,x,w){const T=this.expression.evaluate({zoom:this.context.zoom,brightness:x,worldview:w},c,h,void 0,m),I=this.expression.evaluate({zoom:this.context.zoom+1,brightness:x,worldview:w},c,h,void 0,m),A=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Tn(0,{brightness:x,worldview:w}),c,h,void 0,m):this.lutExpression.value);this._setPaintValue(i,o,T,I,A?null:this.context.lut)}_setPaintValue(i,o,c,h,m){if("color"===this.type){const g=Xf(c.toPremultipliedRenderColor(m)),x=Xf(c.toPremultipliedRenderColor(m));for(let w=i;w<o;w++)this.paintVertexArray.emplace(w,g[0],g[1],x[0],x[1])}else{for(let g=i;g<o;g++)this.paintVertexArray.emplace(g,c,h);this.maxValue=Math.max(this.maxValue,Math.abs(c),Math.abs(h))}}upload(i){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=i.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(i,o,c,h,m){const g=this.useIntegerZoom?Math.floor(c.zoom):c.zoom,x=se(this.expression.interpolationFactor(g,this.context.zoom,this.context.zoom+1),0,1);o.set(i,m,x)}getBinding(i,o){return new vr(i)}}class co{constructor(i,o,c,h,m){this.expression=i,this.layerId=m,this.paintVertexAttributes=("array"===c?kv:Im).members;for(let g=0;g<o.length;++g);this.paintVertexArray=new h,this.paintTransitionVertexArray=new td}populatePaintArray(i,o,c,h){const m=this.paintVertexArray.length;this.paintVertexArray.resize(i),this._setPaintValues(m,i,o.patterns&&o.patterns[this.layerId],c)}updatePaintArray(i,o,c,h,m,g,x){this._setPaintValues(i,o,c.patterns&&c.patterns[this.layerId],g)}_setPaintValues(i,o,c,h){if(!h||!c)return;const m=h[c[0]],g=h[c[1]];if(m){if(m){const{tl:x,br:w,pixelRatio:T}=m;for(let I=i;I<o;I++)this.paintVertexArray.emplace(I,x[0],x[1],w[0],w[1],T)}if(g){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:x,br:w}=g;for(let T=i;T<o;T++)this.paintTransitionVertexArray.emplace(T,x[0],x[1],w[0],w[1])}}}upload(i){const o=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=i.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,o)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=i.createVertexBuffer(this.paintTransitionVertexArray,iu.members,o))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class qo{constructor(i,o,c=(()=>!0)){this.binders={},this._buffers=[],this.context=o;const h=[];for(const m in i.paint._values){const g=i.paint.get(m);if(m.endsWith("-use-theme")||!c(m)||!(g instanceof Xc&&Zu(g.property.specification)))continue;const x=Th(m,i.type),w=g.value,T=g.property.specification.type,I=!!g.property.useIntegerZoom,A="line-dasharray"===m||m.endsWith("pattern"),M=i.paint.get(`${m}-use-theme`),k="line-dasharray"===m&&"constant"!==i.layout.get("line-cap").value.kind||M&&"constant"!==M.value.kind;if("constant"!==w.kind||k)if("source"===w.kind||k||A){const L=E_(m,T,"source");this.binders[m]=A?new co(w,x,T,L,i.id):new _l(w,x,T,L),h.push(`/a_${m}`)}else{const L=E_(m,T,"composite");this.binders[m]=new hs(w,x,T,I,o,L),h.push(`/z_${m}`)}else this.binders[m]=A?new ou(w.value,x):new ld(w.value,x,T,o),h.push(`/u_${m}`);M&&(this.binders[m].lutExpression=M.value)}this.cacheKey=h.sort().join("")}getMaxValue(i){const o=this.binders[i];return o instanceof _l||o instanceof hs?o.maxValue:0}populatePaintArrays(i,o,c,h,m,g,x,w){for(const T in this.binders){const I=this.binders[T];I.context=this.context,(I instanceof _l||I instanceof hs||I instanceof co)&&I.populatePaintArray(i,o,c,h,m,g,x,w)}}setConstantPatternPositions(i,o){for(const c in this.binders){const h=this.binders[c];h instanceof ou&&h.setConstantPatternPositions(i,o)}}getPatternTransitionVertexBuffer(i){const o=this.binders[i];return o instanceof co?o.paintTransitionVertexBuffer:null}updatePaintArrays(i,o,c,h,m,g,x,w,T,I){let A=!1;const M=Object.keys(i),k=0!==M.length&&!w,L=k?M:o.uniqueIds;this.context.lut=m.lut;for(const V in this.binders){const j=this.binders[V];if(j.context=this.context,(j instanceof _l||j instanceof hs||j instanceof co)&&j.expression&&j.expression.kind&&"constant"!==j.expression.kind&&(!0===j.expression.isStateDependent||!1===j.expression.isLightConstant)){const W=m.paint.get(V);j.expression=W.value;for(const Q of L){const K=i[Q.toString()];o.eachPosition(Q,(te,me,he)=>{const fe=h.feature(te);j.updatePaintArray(me,he,fe,K,g,x,T,I)})}if(!k)for(const Q of c.uniqueIds){const K=i[Q.toString()];c.eachPosition(Q,(te,me,he)=>{const fe=h.feature(te);j.updatePaintArray(me,he,fe,K,g,x,T,I)})}A=!0}}return A}defines(){const i=[];for(const o in this.binders){const c=this.binders[o];(c instanceof ld||c instanceof ou)&&i.push(...c.uniformNames.map(h=>`#define HAS_UNIFORM_${h}`))}return i}getBinderAttributes(){const i=[];for(const o in this.binders){const c=this.binders[o];if(c instanceof _l||c instanceof hs||c instanceof co)for(let h=0;h<c.paintVertexAttributes.length;h++)i.push(c.paintVertexAttributes[h].name);if(c instanceof co)for(let h=0;h<iu.members.length;h++)i.push(iu.members[h].name)}return i}getBinderUniforms(){const i=[];for(const o in this.binders){const c=this.binders[o];if(c instanceof ld||c instanceof ou||c instanceof hs)for(const h of c.uniformNames)i.push(h)}return i}getPaintVertexBuffers(){return this._buffers}getUniforms(i){const o=[];for(const c in this.binders){const h=this.binders[c];if(h instanceof ld||h instanceof ou||h instanceof hs)for(const m of h.uniformNames)o.push({name:m,property:c,binding:h.getBinding(i,m)})}return o}setUniforms(i,o,c,h,m){for(const{name:g,property:x,binding:w}of c)this.binders[x].setUniform(i,w,m,h.get(x),g)}updatePaintBuffers(){this._buffers=[];for(const i in this.binders){const o=this.binders[i];(o instanceof _l||o instanceof hs||o instanceof co)&&o.paintVertexBuffer&&this._buffers.push(o.paintVertexBuffer),o instanceof co&&o.paintTransitionVertexBuffer&&this._buffers.push(o.paintTransitionVertexBuffer)}}upload(i){for(const o in this.binders){const c=this.binders[o];(c instanceof _l||c instanceof hs||c instanceof co)&&c.upload(i)}this.updatePaintBuffers()}destroy(){for(const i in this.binders){const o=this.binders[i];(o instanceof _l||o instanceof hs||o instanceof co)&&o.destroy()}}}class Cs{constructor(i,o,c=(()=>!0)){this.programConfigurations={};for(const h of i)this.programConfigurations[h.id]=new qo(h,o,c);this.needsUpload=!1,this._featureMap=new gl,this._featureMapWithoutIds=new gl,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(i,o,c,h,m,g,x,w,T){for(const I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(i,o,h,m,g,x,w,T);void 0!==o.id?this._featureMap.add(o.id,c,this._bufferOffset,i):(this._featureMapWithoutIds.add(this._idlessCounter,c,this._bufferOffset,i),this._idlessCounter+=1),this._bufferOffset=i,this.needsUpload=!0}updatePaintArrays(i,o,c,h,m,g,x,w){for(const T of c)this.needsUpload=this.programConfigurations[T.id].updatePaintArrays(i,this._featureMap,this._featureMapWithoutIds,o,T,h,m,g,x||0,w)||this.needsUpload}get(i){return this.programConfigurations[i]}upload(i){if(this.needsUpload){for(const o in this.programConfigurations)this.programConfigurations[o].upload(i);this.needsUpload=!1}}destroy(){for(const i in this.programConfigurations)this.programConfigurations[i].destroy()}}const w_={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function Th(a,i){return w_[a]||[a.replace(`${i}-`,"").replace(/-/g,"_")]}const Lv={"line-pattern":{source:sc,composite:sc},"fill-pattern":{source:sc,composite:sc},"fill-extrusion-pattern":{source:sc,composite:sc},"line-dasharray":{source:td,composite:td}},fs={color:{source:lc,composite:Ba},number:{source:ds,composite:lc}};function E_(a,i,o){const c=Lv[a];return c&&c[o]||fs[i][o]}Et(ld,"ConstantBinder"),Et(ou,"PatternConstantBinder"),Et(_l,"SourceExpressionBinder"),Et(co,"PatternCompositeBinder"),Et(hs,"CompositeExpressionBinder"),Et(qo,"ProgramConfiguration",{omit:["_buffers"]}),Et(Cs,"ProgramConfigurationSet");const Zi=ht/Math.PI/2,Yf=5,f=6,r=16383,l=64,p=[l,32,16],y=-Zi,v=Zi;function b(a,i,o,c=Zi){return o=Rn(o),[a*Math.sin(o)*c,-i*c,a*Math.cos(o)*c]}function D(a,i,o){return b(Math.cos(Rn(a)),Math.sin(Rn(a)),i,o)}const C=6371008.8,P=2*Math.PI*C;class O{constructor(i,o){if(isNaN(i)||isNaN(o))throw new Error(`Invalid LngLat object: (${i}, ${o})`);if(this.lng=+i,this.lat=+o,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new O(ke(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(i){const o=Math.PI/180,c=this.lat*o,h=i.lat*o,m=Math.sin(c)*Math.sin(h)+Math.cos(c)*Math.cos(h)*Math.cos((i.lng-this.lng)*o);return C*Math.acos(Math.min(m,1))}toBounds(i=0){const o=360*i/40075017,c=o/Math.cos(Math.PI/180*this.lat);return new N({lng:this.lng-c,lat:this.lat-o},{lng:this.lng+c,lat:this.lat+o})}toEcef(i){return D(this.lat,this.lng,Zi+i*Zi/C)}static convert(i){if(i instanceof O)return i;if(Array.isArray(i)&&(2===i.length||3===i.length))return new O(Number(i[0]),Number(i[1]));if(!Array.isArray(i)&&"object"==typeof i&&null!==i)return new O(Number("lng"in i?i.lng:i.lon),Number(i.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class N{constructor(i,o){if(i)if(o)this.setSouthWest(i).setNorthEast(o);else if(4===i.length){const c=i;this.setSouthWest([c[0],c[1]]).setNorthEast([c[2],c[3]])}else{const c=i;this.setSouthWest(c[0]).setNorthEast(c[1])}}setNorthEast(i){return this._ne=i instanceof O?new O(i.lng,i.lat):O.convert(i),this}setSouthWest(i){return this._sw=i instanceof O?new O(i.lng,i.lat):O.convert(i),this}extend(i){const o=this._sw,c=this._ne;let h,m;if(i instanceof O)h=i,m=i;else{if(!(i instanceof N))return Array.isArray(i)?4===i.length||i.every(Array.isArray)?this.extend(N.convert(i)):this.extend(O.convert(i)):"object"==typeof i&&null!==i&&i.hasOwnProperty("lat")&&(i.hasOwnProperty("lon")||i.hasOwnProperty("lng"))?this.extend(O.convert(i)):this;if(h=i._sw,m=i._ne,!h||!m)return this}return o||c?(o.lng=Math.min(h.lng,o.lng),o.lat=Math.min(h.lat,o.lat),c.lng=Math.max(m.lng,c.lng),c.lat=Math.max(m.lat,c.lat)):(this._sw=new O(h.lng,h.lat),this._ne=new O(m.lng,m.lat)),this}getCenter(){return new O((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new O(this.getWest(),this.getNorth())}getSouthEast(){return new O(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(i){const{lng:o,lat:c}=O.convert(i);let h=this._sw.lng<=o&&o<=this._ne.lng;return this._sw.lng>this._ne.lng&&(h=this._sw.lng>=o&&o>=this._ne.lng),this._sw.lat<=c&&c<=this._ne.lat&&h}static convert(i){if(i)return i instanceof N?i:new N(i)}}const F=0,B=25.5;function H(a){return P*Math.cos(a*Math.PI/180)}function U(a){return(180+a)/360}function q(a){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+a*Math.PI/360)))/360}function G(a,i){return a/H(i)}function Y(a){return 360*a-180}function ee(a){return 360/Math.PI*Math.atan(Math.exp((180-360*a)*Math.PI/180))-90}function ne(a,i){return a*H(ee(i))}const le=85.051129;function de(a){return Math.cos(Rn(se(a,-le,le)))}function pe(a,i){const o=se(i,F,B),c=Math.pow(2,o);return de(a)*P/(512*c)}function ae(a){return 1/Math.cos(a*Math.PI/180)}function ce(a,i=0){const o=Math.exp(Math.PI*(1-(a.y+i/ht)/(1<<a.z)*2));return 80150034*o/(o*o+1)/ht/(1<<a.z)}class ue{constructor(i,o,c=0){this.x=+i,this.y=+o,this.z=+c}static fromLngLat(i,o=0){const c=O.convert(i);return new ue(U(c.lng),q(c.lat),G(o,c.lat))}toLngLat(){return new O(Y(this.x),ee(this.y))}toAltitude(){return ne(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/P*ae(ee(this.y))}}function Me(a,i,o,c,h,m,g,x,w){const T=(i+c)/2,I=(o+h)/2,A=new Je(T,I);x(A),function(M,k,L,V,j,W){const Q=L-j,K=V-W;return Math.abs((V-k)*Q-(L-M)*K)/Math.hypot(Q,K)}(A.x,A.y,m.x,m.y,g.x,g.y)>=w?(Me(a,i,o,T,I,m,A,x,w),Me(a,T,I,c,h,A,g,x,w)):a.push(g)}function ye(a,i,o){let c=a[0],h=c.x,m=c.y;i(c);const g=[c];for(let x=1;x<a.length;x++){const w=a[x],{x:T,y:I}=w;i(w),Me(g,h,m,T,I,c,w,i,o),h=T,m=I,c=w}return g}function je(a,i,o,c){if(c(i,o)){const h=i.add(o)._mult(.5);je(a,i,h,c),je(a,h,o,c)}else a.push(o)}function Fe(a,i){let o=a[0];const c=[o];for(let h=1;h<a.length;h++){const m=a[h];je(c,o,m,i),o=m}return c}const Ge=Math.pow(2,14)-1,rt=-Ge-1;function De(a,i){const o=Math.round(a.x*i),c=Math.round(a.y*i);return a.x=se(o,rt,Ge),a.y=se(c,rt,Ge),(o<a.x||o>a.x+1||c<a.y||c>a.y+1)&&yn("Geometry exceeds allowed extent, reduce your vector tile buffer size"),a}function _e(a,i,o){const c=a.loadGeometry(),h=a.extent,m=ht/h;if(i&&o&&o.projection.isReprojectedInTileSpace){const g=1<<i.z,{scale:x,x:w,y:T,projection:I}=o,A=M=>{const k=Y((i.x+M.x/h)/g),L=ee((i.y+M.y/h)/g),V=I.project(k,L);M.x=(V.x*x-w)*h,M.y=(V.y*x-T)*h};for(let M=0;M<c.length;M++)if(1!==a.type)c[M]=ye(c[M],A,1);else{const k=[];for(const L of c[M])L.x<0||L.x>=h||L.y<0||L.y>=h||(A(L),k.push(L));c[M]=k}}for(const g of c)for(const x of g)De(x,m);return c}function Ne(a,i){return{type:a.type,id:a.id,properties:a.properties,geometry:i?_e(a):[]}}class Re{constructor(i,o,c,h,m){this.properties={},this.extent=c,this.type=0,this.id=void 0,this._pbf=i,this._geometry=-1,this._keys=h,this._values=m,i.readFields(We,this,o)}loadGeometry(){const i=this._pbf;i.pos=this._geometry;const o=i.readVarint()+i.pos,c=[];let h,m=1,g=0,x=0,w=0;for(;i.pos<o;){if(g<=0){const T=i.readVarint();m=7&T,g=T>>3}if(g--,1===m||2===m)x+=i.readSVarint(),w+=i.readSVarint(),1===m&&(h&&c.push(h),h=[]),h&&h.push(new Je(x,w));else{if(7!==m)throw new Error(`unknown command ${m}`);h&&h.push(h[0].clone())}}return h&&c.push(h),c}bbox(){const i=this._pbf;i.pos=this._geometry;const o=i.readVarint()+i.pos;let c=1,h=0,m=0,g=0,x=1/0,w=-1/0,T=1/0,I=-1/0;for(;i.pos<o;){if(h<=0){const A=i.readVarint();c=7&A,h=A>>3}if(h--,1===c||2===c)m+=i.readSVarint(),g+=i.readSVarint(),m<x&&(x=m),m>w&&(w=m),g<T&&(T=g),g>I&&(I=g);else if(7!==c)throw new Error(`unknown command ${c}`)}return[x,T,w,I]}toGeoJSON(i,o,c){const h=this.extent*Math.pow(2,c),m=this.extent*i,g=this.extent*o,x=this.loadGeometry();function w(M){return[360*(M.x+m)/h-180,360/Math.PI*Math.atan(Math.exp((1-2*(M.y+g)/h)*Math.PI))-90]}function T(M){return M.map(w)}let I;if(1===this.type){const M=[];for(const L of x)M.push(L[0]);const k=T(M);I=1===M.length?{type:"Point",coordinates:k[0]}:{type:"MultiPoint",coordinates:k}}else if(2===this.type){const M=x.map(T);I=1===M.length?{type:"LineString",coordinates:M[0]}:{type:"MultiLineString",coordinates:M}}else{if(3!==this.type)throw new Error("unknown feature type");{const M=function(L){const V=L.length;if(V<=1)return[L];const j=[];let W,Q;for(let K=0;K<V;K++){const te=Ze(L[K]);0!==te&&(void 0===Q&&(Q=te<0),Q===te<0?(W&&j.push(W),W=[L[K]]):W&&W.push(L[K]))}return W&&j.push(W),j}(x),k=[];for(const L of M)k.push(L.map(T));I=1===k.length?{type:"Polygon",coordinates:k[0]}:{type:"MultiPolygon",coordinates:k}}}const A={type:"Feature",geometry:I,properties:this.properties};return null!=this.id&&(A.id=this.id),A}}function We(a,i,o){1===a?i.id=o.readVarint():2===a?function(c,h){const m=c.readVarint()+c.pos;for(;c.pos<m;){const g=h._keys[c.readVarint()],x=h._values[c.readVarint()];h.properties[g]=x}}(o,i):3===a?i.type=o.readVarint():4===a&&(i._geometry=o.pos)}function Ze(a){let i=0;for(let o,c,h=0,m=a.length,g=m-1;h<m;g=h++)o=a[h],c=a[g],i+=(c.x-o.x)*(o.y+c.y);return i}Re.types=["Unknown","Point","LineString","Polygon"];class Ye{constructor(i,o){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=i,this._keys=[],this._values=[],this._features=[],i.readFields(ct,this,o),this.length=this._features.length}feature(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];const o=this._pbf.readVarint()+this._pbf.pos;return new Re(this._pbf,o,this.extent,this._keys,this._values)}}function ct(a,i,o){15===a?i.version=o.readVarint():1===a?i.name=o.readString():5===a?i.extent=o.readVarint():2===a?i._features.push(o.pos):3===a?i._keys.push(o.readString()):4===a&&i._values.push(function(c){let h=null;const m=c.readVarint()+c.pos;for(;c.pos<m;){const g=c.readVarint()>>3;h=1===g?c.readString():2===g?c.readFloat():3===g?c.readDouble():4===g?c.readVarint64():5===g?c.readVarint():6===g?c.readSVarint():7===g?c.readBoolean():null}if(null==h)throw new Error("unknown feature value");return h}(o))}class Mt{constructor(i,o){this.layers=i.readFields(kt,{},o)}}function kt(a,i,o){if(3===a){const c=new Ye(o,o.readVarint()+o.pos);c.length&&(i[c.name]=c)}}const vt="3d_elevation_id";class Pt{constructor(){this._valid=!1}reset(i){return this.feature=i,this._valid=!0,this._geometry=i.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry(i,o){return this._valid&&i(o(this._geometry)),this}require(i,o,c){return this.get(i,!0,o,c)}optional(i,o,c){return this.get(i,!1,o,c)}success(){return this._valid}get(i,o,c,h){const m=this.feature.properties.hasOwnProperty(i)?+this.feature.properties[i]:void 0;return this._valid&&void 0!==m&&!Number.isNaN(m)?c(h?h(m):m):o&&(this._valid=!1),this}}class Wt{constructor(i,o){this.featureFunc=i,this.vertexFunc=o}parseFeature(i,o,c){return this.featureFunc(i,o,c)}parseVertex(i,o,c){return this.vertexFunc(i,o,c)}}const en=new Wt((a,i,o)=>a.reset(i).require(vt,c=>{o.id=c}).optional("fixed_height_relative",c=>{o.constantHeight=c},Cn.decodeRelativeHeight).geometry(c=>{o.bounds=c},bf).success(),(a,i,o)=>a.reset(i).require(vt,c=>{o.id=c}).require("elevation_idx",c=>{o.idx=c}).require("extent",c=>{o.extent=c}).require("height_relative",c=>{o.height=c},Cn.decodeRelativeHeight).geometry(c=>{o.position=c},Cn.getPoint).success()),mn=new Wt((a,i,o)=>a.reset(i).require(vt,c=>{o.id=c}).optional("fixed_height",c=>{o.constantHeight=c},Cn.decodeMetricHeight).geometry(c=>{o.bounds=c},bf).success(),(a,i,o)=>a.reset(i).require(vt,c=>{o.id=c}).require("elevation_idx",c=>{o.idx=c}).require("extent",c=>{o.extent=c}).require("height",c=>{o.height=c},Cn.decodeMetricHeight).geometry(c=>{o.position=c},Cn.getPoint).success());class Cn{static getPoint(i){return Zr(i[0][0].x,i[0][0].y)}static decodeRelativeHeight(i){return 1e-4*i*5}static decodeMetricHeight(i){return 1e-4*i}static parse(i){const o=[],c=[],h=i.length,m=new Pt;for(let x=0;x<h;x++){const w=i.feature(x),T=w.properties.version,I=(g=T)?"1.0.1"===g?mn:void 0:en;if(void 0===I){yn(`Unknown elevation feature version number ${T||"(unknown)"}`);continue}const A=w.properties.hasOwnProperty("type")?w.properties.type:void 0;if(A)if("Point"===Re.types[w.type]&&"curve_point"===A){const M={};I.parseVertex(m,w,M)&&o.push(M)}else if("Polygon"===Re.types[w.type]&&"curve_meta"===A){const M={};I.parseFeature(m,w,M)&&c.push(M)}}var g;return{vertices:o,features:c}}}class Yt{constructor(i,o){this.pos=i,this.dir=o}intersectsPlane(i,o,c){const h=Di(o,this.dir);if(Math.abs(h)<1e-6)return!1;const m=((i[0]-this.pos[0])*o[0]+(i[1]-this.pos[1])*o[1])/h;return c[0]=this.pos[0]+this.dir[0]*m,c[1]=this.pos[1]+this.dir[1]*m,!0}}class Mn{constructor(i,o){this.pos=i,this.dir=o}intersectsPlane(i,o,c){const h=ar(o,this.dir);if(Math.abs(h)<1e-6)return!1;const m=((i[0]-this.pos[0])*o[0]+(i[1]-this.pos[1])*o[1]+(i[2]-this.pos[2])*o[2])/h;return c[0]=this.pos[0]+this.dir[0]*m,c[1]=this.pos[1]+this.dir[1]*m,c[2]=this.pos[2]+this.dir[2]*m,!0}closestPointOnSphere(i,o,c){if(V=(k=this.pos)[0],j=k[1],W=k[2],Q=(L=i)[0],K=L[1],te=L[2],Math.abs(V-Q)<=tr*Math.max(1,Math.abs(V),Math.abs(Q))&&Math.abs(j-K)<=tr*Math.max(1,Math.abs(j),Math.abs(K))&&Math.abs(W-te)<=tr*Math.max(1,Math.abs(W),Math.abs(te))||0===o)return c[0]=c[1]=c[2]=0,!1;var k,L,V,j,W,Q,K,te;const[h,m,g]=this.dir,x=this.pos[0]-i[0],w=this.pos[1]-i[1],T=this.pos[2]-i[2],I=h*h+m*m+g*g,A=2*(x*h+w*m+T*g),M=A*A-4*I*(x*x+w*w+T*T-o*o);if(M<0){const k=Math.max(-A/2,0),L=x+h*k,V=w+m*k,j=T+g*k,W=Math.hypot(L,V,j);return c[0]=L*o/W,c[1]=V*o/W,c[2]=j*o/W,!1}{const k=(-A-Math.sqrt(M))/(2*I);if(k<0){const L=Math.hypot(x,w,T);return c[0]=x*o/L,c[1]=w*o/L,c[2]=T*o/L,!1}return c[0]=x+h*k,c[1]=w+m*k,c[2]=T+g*k,!0}}}class kn{constructor(i,o,c,h,m){this.TL=i,this.TR=o,this.BR=c,this.BL=h,this.horizon=m}static fromInvProjectionMatrix(i,o,c){const h=[-1,1,1],m=[1,1,1],g=[1,-1,1],x=[-1,-1,1],w=lr(h,h,i),T=lr(m,m,i),I=lr(g,g,i),A=lr(x,x,i);return new kn(w,T,I,A,o/c)}}function ti(a,i,o){let c=1/0,h=-1/0;const m=[];for(const g of a){cr(m,g,i);const x=ar(m,o);c=Math.min(c,x),h=Math.max(h,x)}return[c,h]}function un(a,i){let o=!0;for(let c=0;c<a.planes.length;c++){const h=a.planes[c];let m=0;for(let g=0;g<i.length;g++)m+=ar(h,i[g])+h[3]>=0;if(0===m)return 0;m!==i.length&&(o=!1)}return o?2:1}function Ln(a,i){for(const o of a.projections){const c=ti(i,a.points[0],o.axis);if(o.projection[1]<c[0]||o.projection[0]>c[1])return 0}return 1}function zn(a,i){let o=0;const c=[0,0,0,0];for(let g=0;g<a.length;g++)c[0]=a[g][0],c[1]=a[g][1],c[2]=a[g][2],c[3]=1,(h=c)[0]*(m=i)[0]+h[1]*m[1]+h[2]*m[2]+h[3]*m[3]>=0&&o++;var h,m;return o}class In{constructor(i,o){this.points=i||new Array(8).fill([0,0,0]),this.planes=o||new Array(6).fill([0,0,0,0]),this.bounds=sn.fromPoints(this.points),this.projections=[],this.frustumEdges=[cr([],this.points[2],this.points[3]),cr([],this.points[0],this.points[3]),cr([],this.points[4],this.points[0]),cr([],this.points[5],this.points[1]),cr([],this.points[6],this.points[2]),cr([],this.points[7],this.points[3])];for(const c of this.frustumEdges){const h=[0,-c[2],c[1]],m=[c[2],0,-c[0]];this.projections.push({axis:h,projection:ti(this.points,this.points[0],h)}),this.projections.push({axis:m,projection:ti(this.points,this.points[0],m)})}}static fromInvProjectionMatrix(i,o,c,h){const m=Math.pow(2,c),g=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(T=>{const I=xs([],T,i),A=1/I[3]/o*m;return(M=I)[0]=(k=I)[0]*(L=[A,A,h?1/I[3]:A,A])[0],M[1]=k[1]*L[1],M[2]=k[2]*L[2],M[3]=k[3]*L[3],M;var M,k,L}),x=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(T=>{const I=Mi([],vi([],cr([],g[T[0]],g[T[1]]),cr([],g[T[2]],g[T[1]]))),A=-ar(I,g[T[1]]);return I.concat(A)}),w=[];for(let T=0;T<g.length;T++)w.push([g[T][0],g[T][1],g[T][2]]);return new In(w,x)}intersectsPrecise(i,o,c){for(let h=0;h<o.length;h++)if(!zn(i,o[h]))return 0;for(let h=0;h<this.planes.length;h++)if(!zn(i,this.planes[h]))return 0;for(const h of c)for(const m of this.frustumEdges){const g=vi([],h,m),x=go(g);if(0===x)continue;ki(g,g,1/x);const w=ti(this.points,this.points[0],g),T=ti(i,this.points[0],g);if(w[0]>T[1]||T[0]>w[1])return 0}return 1}containsPoint(i){for(const o of this.planes){const c=o[3];if(ar([o[0],o[1],o[2]],i)+c<0)return!1}return!0}}class sn{static fromPoints(i){const o=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(const h of i)Aa(o,o,h),Hi(c,c,h);return new sn(o,c)}static fromTileIdAndHeight(i,o,c){const h=1<<i.canonical.z,m=i.canonical.x,g=i.canonical.y;return new sn([m/h,g/h,o],[(m+1)/h,(g+1)/h,c])}static applyTransform(i,o){const c=i.getCorners();for(let h=0;h<c.length;++h)lr(c[h],c[h],o);return sn.fromPoints(c)}static applyTransformFast(i,o){const c=[o[12],o[13],o[14]],h=[...c];for(let m=0;m<3;m++)for(let g=0;g<3;g++){const x=o[4*g+m],w=x*i.min[g],T=x*i.max[g];c[m]+=Math.min(w,T),h[m]+=Math.max(w,T)}return new sn(c,h)}static projectAabbCorners(i,o){const c=i.getCorners();for(let h=0;h<c.length;++h)lr(c[h],c[h],o);return c}constructor(i,o){this.min=i,this.max=o,this.center=ki([],Fi([],this.min,this.max),.5)}quadrant(i){const o=[i%2==0,i<2],c=qa(this.min),h=qa(this.max);for(let m=0;m<o.length;m++)c[m]=o[m]?this.min[m]:this.center[m],h[m]=o[m]?this.center[m]:this.max[m];return h[2]=this.max[2],new sn(c,h)}distanceX(i){return Math.max(Math.min(this.max[0],i[0]),this.min[0])-i[0]}distanceY(i){return Math.max(Math.min(this.max[1],i[1]),this.min[1])-i[1]}distanceZ(i){return Math.max(Math.min(this.max[2],i[2]),this.min[2])-i[2]}getCorners(){const i=this.min,o=this.max;return[[i[0],i[1],i[2]],[o[0],i[1],i[2]],[o[0],o[1],i[2]],[i[0],o[1],i[2]],[i[0],i[1],o[2]],[o[0],i[1],o[2]],[o[0],o[1],o[2]],[i[0],o[1],o[2]]]}intersects(i){return this.intersectsAabb(i.bounds)?un(i,this.getCorners()):0}intersectsFlat(i){return this.intersectsAabb(i.bounds)?un(i,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(i,o){return o||this.intersects(i)?Ln(i,this.getCorners()):0}intersectsPreciseFlat(i,o){return o||this.intersectsFlat(i)?Ln(i,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(i){for(let o=0;o<3;++o)if(this.min[o]>i.max[o]||i.min[o]>this.max[o])return!1;return!0}intersectsAabbXY(i){return!(this.min[0]>i.max[0]||i.min[0]>this.max[0]||this.min[1]>i.max[1]||i.min[1]>this.max[1])}encapsulate(i){for(let o=0;o<3;o++)this.min[o]=Math.min(this.min[o],i.min[o]),this.max[o]=Math.max(this.max[o],i.max[o])}encapsulatePoint(i){for(let o=0;o<3;o++)this.min[o]=Math.min(this.min[o],i[o]),this.max[o]=Math.max(this.max[o],i[o])}closestPoint(i){return[Math.max(Math.min(this.max[0],i[0]),this.min[0]),Math.max(Math.min(this.max[1],i[1]),this.min[1]),Math.max(Math.min(this.max[2],i[2]),this.min[2])]}}Et(sn,"Aabb");class ni{constructor(i,o){this.feature=i,this.metersToTile=o,this.index=0}get(){const i=this.feature.vertices[this.index],o=this.feature.vertexProps[this.index].dir,c=o[1],h=-o[0],m=(i.extent+1)*this.metersToTile;return[new Je(Math.trunc(i.position[0]+c*m),Math.trunc(i.position[1]+h*m)),new Je(Math.trunc(i.position[0]-c*m),Math.trunc(i.position[1]-h*m))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class $n{constructor(i,o,c,h,m,g){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=i,this.heightRange={min:c,max:c},this.safeArea=o,this.constantHeight=c,null==this.constantHeight&&(null!=this.constantHeight||0!==h.length)){this.vertices=h,this.edges=m,this.edges=this.edges.filter(x=>{return x.a<this.vertices.length&&x.b<this.vertices.length&&!((w=this.vertices[x.a].position)[0]===(T=this.vertices[x.b].position)[0]&&w[1]===T[1]);var w,T}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const x of this.vertices)this.vertexProps.push({dir:Zr(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,x.height),this.heightRange.max=Math.max(this.heightRange.max,x.height);for(const x of this.edges){const w=this.vertices[x.a].position,T=this.vertices[x.b].position,I=Ka(Mo(),T,w),A=Ul(I),M=Qa(Mo(),I,1/A);this.edgeProps.push({vec:I,dir:M,len:A});const k=this.vertexProps[x.a].dir,L=this.vertexProps[x.b].dir;Ya(k,k,M),Ya(L,L,M)}for(const x of this.vertexProps)0===x.dir[0]&&0===x.dir[1]||Mu(x.dir,x.dir);this.tessellate(g)}}pointElevation(i){if(null!=this.constantHeight)return this.constantHeight;const o=this.getClosestEdge(i);if(null==o)return 0;const[c,h]=o;return Nt(this.vertices[this.edges[c].a].height,this.vertices[this.edges[c].b].height,h)}computeSlopeNormal(i,o){const c=this.getClosestEdge(i);if(!c)return mr(0,0,1);const h=c[0],m=this.edges[h],g=this.edgeProps[h].vec,x=mr(g[0],g[1],(this.vertices[m.b].height-this.vertices[m.a].height)*o),w=mr(x[1],-x[0],0);vi(w,w,x);const T=go(w);return T>0?ki(w,w,1/T):mr(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(i){if(0===this.edges.length)return;let o=0,c=Number.POSITIVE_INFINITY,h=0;const m=Zr(i.x,i.y);for(let g=0;g<this.edges.length;g++){const x=this.edges[g],w=this.edgeProps[g].dir,T=new Yt(m,this.edgeProps[g].dir),I=this.vertices[x.a].position,A=this.vertices[x.b].position,M=Mo(),k=Mo(),L=T.intersectsPlane(I,this.vertexProps[x.a].dir,M),V=T.intersectsPlane(A,this.vertexProps[x.b].dir,k);if(!L||!V)continue;const j=Ka(Mo(),k,M),W=Ka(Mo(),m,M),Q=Di(j,j),K=Q>0?Di(W,j)/Q:0,te=se(K,0,1),me=Math.abs((K-te)*this.edgeProps[g].len),he=Ka(Mo(),m,I),fe=me+Math.abs(Di(he,Zr(w[1],-w[0])));fe<c&&(o=g,c=fe,h=te)}return[o,h]}tessellate(i){for(let o=this.edges.length-1;o>=0;--o){const c=this.edges[o].a,h=this.edges[o].b,{position:m,height:g,extent:x}=this.vertices[c],{position:w,height:T,extent:I}=this.vertices[h],A=this.vertexProps[c].dir,M=this.vertexProps[h].dir,k=mr(m[0]/i,m[1]/i,g),L=mr(w[0]/i,w[1]/i,T),V=mr(A[1],-A[0],0);ki(V,V,x);const j=mr(M[1],-M[0],0);if(ki(j,j,I),this.distSqLines(mr(k[0]+.5*V[0],k[1]+.5*V[1],k[2]+.5*V[2]),mr(L[0]-.5*j[0],L[1]-.5*j[1],L[2]-.5*j[2]),mr(k[0]-.5*V[0],k[1]-.5*V[1],k[2]-.5*V[2]),mr(L[0]+.5*j[0],L[1]+.5*j[1],L[2]+.5*j[2]))<=.0025000000000000005)continue;const W=this.vertices.length,Q=Ya(Mo(),m,w);this.vertices.push({position:Qa(Q,Q,.5),height:.5*(g+T),extent:.5*(x+I)});const K=Ya(Mo(),A,M);this.vertexProps.push({dir:Mu(K,K)}),this.edges.splice(o,1),this.edgeProps.splice(o,1),this.edges.push({a:c,b:W}),this.edges.push({a:W,b:h});const te=Ka(Mo(),this.vertices[W].position,m),me=Ul(te),he={vec:te,dir:Qa(Mo(),te,1/me),len:me};this.edgeProps.push(he),this.edgeProps.push(he)}}distSqLines(i,o,c,h){const m=oo(Un(),o,i),g=oo(Un(),h,c),x=oo(Un(),i,c),w=ar(m,m),T=ar(m,g),I=ar(m,x),A=ar(g,g),M=ar(g,x),k=w*A-T*T;if(0===k){const j=ar(x,g)/ar(g,g);return Cu(nr(Un(),c,h,j),i)}const L=(T*M-I*A)/k,V=(w*M-T*I)/k;return Cu(nr(Un(),i,o,L),nr(Un(),c,h,V))}}class Ni{static parseFrom(i,o){const c=Cn.parse(i);if(!c)return[];let{vertices:h,features:m}=c;const g=1/ce(o);m.sort((I,A)=>I.id-A.id),h.sort((I,A)=>I.id-A.id||I.idx-A.idx),h=h.filter((I,A,M)=>A===M.findIndex(k=>k.id===I.id&&k.idx===I.idx));const x=new Array;let w=0;const T=h.length;for(const I of m){if(I.constantHeight){x.push(new $n(I.id,I.bounds,I.constantHeight));continue}for(;w!==T&&h[w].id<I.id;)w++;if(w===T||h[w].id!==I.id)continue;const A=new Array,M=new Array,k=w;for(;w!==T&&h[w].id===I.id;){const L=h[w];if(A.push({position:L.position,height:L.height,extent:L.extent}),w!==k&&h[w-1].idx===L.idx-1){const V=w-k;M.push({a:V-1,b:V})}w++}x.push(new $n(I.id,I.bounds,void 0,A,M,g))}return x}static getElevationFeature(i,o){if(!o)return;const c=+i.properties[vt];return Number.isNaN(c)?void 0:o.find(h=>h.id===c)}}class Pn{constructor(i,o){this.zScale=1,this.xOffset=0,this.yOffset=0,i.equals(o)||(this.zScale=Math.pow(2,o.z-i.z),this.xOffset=(i.x*this.zScale-o.x)*ht,this.yOffset=(i.y*this.zScale-o.y)*ht)}constantElevation(i,o){if(null!=i.constantHeight)return this.computeBiasedHeight(i.constantHeight,o)}pointElevation(i,o,c){return this.constantElevation(o,c)??(i.x=i.x*this.zScale+this.xOffset,i.y=i.y*this.zScale+this.yOffset,this.computeBiasedHeight(o.pointElevation(i),c))}computeBiasedHeight(i,o){return o<=0?i:i+o*be(0,o,i>=0?i:Math.abs(.5*i))}}Et($n,"ElevationFeature");class Wn{constructor(i){this.zoom=i.zoom,this.overscaling=i.overscaling,this.layers=i.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=i.index,this.hasPattern=!1,this.projection=i.projection,this.layoutVertexArray=new Ds,this.indexArray=new Pi,this.segments=new Wi,this.programConfigurations=new Cs(i.layers,{zoom:i.zoom,lut:i.lut}),this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,"none"!==this.elevationMode&&(this.elevatedLayoutVertexArray=new ds),this.worldview=i.worldview}updateFootprints(i,o){}populate(i,o,c,h){const m=this.layers[0],g=[];let x=null;"circle"===m.type&&(x=m.layout.get("circle-sort-key"));for(const{feature:T,id:I,index:A,sourceLayerIndex:M}of i){const k=this.layers[0]._featureFilter.needGeometry,L=Ne(T,k);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),L,c))continue;const V=x?x.evaluate(L,{},c):void 0,j={id:I,properties:T.properties,type:T.type,sourceLayerIndex:M,index:A,geometry:k?L.geometry:_e(T,c,h),patterns:{},sortKey:V};g.push(j)}x&&g.sort((T,I)=>T.sortKey-I.sortKey);let w=null;"globe"===h.projection.name&&(this.globeExtVertexArray=new nd,w=h.projection);for(const T of g){const{geometry:I,index:A,sourceLayerIndex:M}=T,k=i[A].feature;this.addFeature(T,I,A,o.availableImages,c,w,o.brightness,o.elevationFeatures),o.featureIndex.insert(k,I,A,M,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(i,o,c,h,m,g,x){this.programConfigurations.updatePaintArrays(i,o,m,c,h,g,x,this.worldview)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(i){this.uploaded||(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,Pv.members),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=i.createVertexBuffer(this.globeExtVertexArray,Ov.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=i.createVertexBuffer(this.elevatedLayoutVertexArray,Rv.members))),this.programConfigurations.upload(i),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(i,o,c,h,m,g,x,w){let T;"none"!==this.elevationMode&&(T=Ni.getElevationFeature(i,w));for(const I of o)for(const A of I){const M=A.x,k=A.y;if(M<0||M>=ht||k<0||k>=ht)continue;if(g){const j=g.projectTilePoint(M,k,m),W=g.upVector(m,M,k);this.addGlobeExtVertex(j,W),this.addGlobeExtVertex(j,W),this.addGlobeExtVertex(j,W),this.addGlobeExtVertex(j,W)}const L=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,i.sortKey),V=L.vertexLength;if(this.addCircleVertex(M,k,-1,-1),this.addCircleVertex(M,k,1,-1),this.addCircleVertex(M,k,1,1),this.addCircleVertex(M,k,-1,1),"none"!==this.elevationMode){const j=T?T.pointElevation(new Je(M,k)):0;this.hasElevation=this.hasElevation||0!==j;for(let W=0;W<4;W++)this.elevatedLayoutVertexArray.emplaceBack(j)}this.indexArray.emplaceBack(V,V+1,V+2),this.indexArray.emplaceBack(V,V+2,V+3),L.vertexLength+=4,L.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,c,{},h,m,x,void 0,this.worldview)}addCircleVertex(i,o,c,h){this.layoutVertexArray.emplaceBack(2*i+(c+1)/2,2*o+(h+1)/2)}addGlobeExtVertex(i,o){this.globeExtVertexArray.emplaceBack(i.x,i.y,i.z,16384*o[0],16384*o[1],16384*o[2])}}function di(a,i){for(let o=0;o<a.length;o++)if(Co(i,a[o]))return!0;for(let o=0;o<i.length;o++)if(Co(a,i[o]))return!0;return!!Gr(a,i)}function xr(a,i,o){return!!Co(a,i)||!!uo(i,a,o)}function hr(a,i){if(1===a.length)return ra(i,a[0]);for(let o=0;o<i.length;o++){const c=i[o];for(let h=0;h<c.length;h++)if(Co(a,c[h]))return!0}for(let o=0;o<a.length;o++)if(ra(i,a[o]))return!0;for(let o=0;o<i.length;o++)if(Gr(a,i[o]))return!0;return!1}function or(a,i,o){if(a.length>1){if(Gr(a,i))return!0;for(let c=0;c<i.length;c++)if(uo(i[c],a,o))return!0}for(let c=0;c<a.length;c++)if(uo(a[c],i,o))return!0;return!1}function Gr(a,i){if(0===a.length||0===i.length)return!1;for(let o=0;o<a.length-1;o++){const c=a[o],h=a[o+1];for(let m=0;m<i.length-1;m++)if(ba(c,h,i[m],i[m+1]))return!0}return!1}function ba(a,i,o,c){return ir(a,o,c)!==ir(i,o,c)&&ir(a,i,o)!==ir(a,i,c)}function Lo(a,i,o){return(a.x-o.x)*(i.y-o.y)-(a.y-o.y)*(i.x-o.x)}function qs(a,i,o,c){const h=Lo(a,i,c),m=Lo(a,i,o);if(Math.sign(h)===Math.sign(m))return;const g=Lo(o,c,a),x=g+m-h;return Math.sign(g)!==Math.sign(x)?[g/(g-x),m/(m-h)]:void 0}function uo(a,i,o){const c=o*o;if(1===i.length)return a.distSqr(i[0])<c;for(let h=1;h<i.length;h++)if(ia(a,i[h-1],i[h])<c)return!0;return!1}function ia(a,i,o){const c=i.distSqr(o);if(0===c)return a.distSqr(i);const h=((a.x-i.x)*(o.x-i.x)+(a.y-i.y)*(o.y-i.y))/c;return a.distSqr(h<0?i:h>1?o:o.sub(i)._mult(h)._add(i))}function ra(a,i){let o,c,h,m=!1;for(let g=0;g<a.length;g++){o=a[g];for(let x=0,w=o.length-1;x<o.length;w=x++)c=o[x],h=o[w],c.y>i.y!=h.y>i.y&&i.x<(h.x-c.x)*(i.y-c.y)/(h.y-c.y)+c.x&&(m=!m)}return m}function Co(a,i){let o=!1;for(let c=0,h=a.length-1;c<a.length;h=c++){const m=a[c],g=a[h];m.y>i.y!=g.y>i.y&&i.x<(g.x-m.x)*(i.y-m.y)/(g.y-m.y)+m.x&&(o=!o)}return o}function Qi(a,i,o,c,h){for(const g of a)if(i<=g.x&&o<=g.y&&c>=g.x&&h>=g.y)return!0;const m=[new Je(i,o),new Je(i,h),new Je(c,h),new Je(c,o)];if(a.length>2)for(const g of m)if(Co(a,g))return!0;for(let g=0;g<a.length-1;g++)if(rr(a[g],a[g+1],m))return!0;return!1}function rr(a,i,o){const c=o[0],h=o[2];if(a.x<c.x&&i.x<c.x||a.x>h.x&&i.x>h.x||a.y<c.y&&i.y<c.y||a.y>h.y&&i.y>h.y)return!1;const m=ir(a,i,o[0]);return m!==ir(a,i,o[1])||m!==ir(a,i,o[2])||m!==ir(a,i,o[3])}function Ei(a,i,o,c,h,m){let g=i.y-a.y,x=a.x-i.x;if(m=m||0){const w=g*g+x*x;if(0===w)return!0;const T=Math.sqrt(w);g/=T,x/=T}return!((o.x-a.x)*g+(o.y-a.y)*x-m<0||(c.x-a.x)*g+(c.y-a.y)*x-m<0||(h.x-a.x)*g+(h.y-a.y)*x-m<0)}function Tr(a,i,o,c,h,m,g){return!(Ei(a,i,c,h,m,g)||Ei(i,o,c,h,m,g)||Ei(o,a,c,h,m,g)||Ei(c,h,a,i,o,g)||Ei(h,m,a,i,o,g)||Ei(m,c,a,i,o,g))}function ho(a,i,o){const c=i.paint.get(a).value;return"constant"===c.kind?c.value:o.programConfigurations.get(i.id).getMaxValue(a)}function fr(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])}function oa(a,i,o,c,h){if(!i[0]&&!i[1])return a;const m=Je.convert(i)._mult(h);"viewport"===o&&m._rotate(-c);const g=[];for(let x=0;x<a.length;x++)g.push(a[x].sub(m));return g}function cd(a,i,o,c){const h=Je.convert(a)._mult(c);return"viewport"===i&&h._rotate(-o),h}let su,ud;function yl(a,i,o){var c=2*Math.PI*6378137/256/Math.pow(2,o);return[a*c-2*Math.PI*6378137/2,i*c-2*Math.PI*6378137/2]}Et(Wn,"CircleBucket",{omit:["layers"]});class Wo{constructor(i,o,c){this.z=i,this.x=o,this.y=c,this.key=Is(0,i,i,o,c)}equals(i){return this.z===i.z&&this.x===i.x&&this.y===i.y}isChildOf(i){const o=this.z-i.z;return 0===i.z||i.z<this.z&&i.x===this.x>>o&&i.y===this.y>>o}url(i,o){const c=(g=this.y,x=this.z,w=yl(256*(m=this.x),256*(g=Math.pow(2,x)-g-1),x),T=yl(256*(m+1),256*(g+1),x),w[0]+","+w[1]+","+T[0]+","+T[1]),h=function(m,g,x){let w,T="";for(let I=m;I>0;I--)w=1<<I-1,T+=(g&w?1:0)+(x&w?2:0);return T}(this.z,this.x,this.y);var m,g,x,w,T;return i[(this.x+this.y)%i.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===o?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",h).replace("{bbox-epsg-3857}",c)}toString(){return`${this.z}/${this.x}/${this.y}`}}class wa{constructor(i,o){this.wrap=i,this.canonical=o,this.key=Is(i,o.z,o.z,o.x,o.y)}}class Mr{constructor(i,o,c,h,m){this.overscaledZ=i,this.wrap=o,this.canonical=new Wo(c,+h,+m),this.key=0===o&&i===c?this.canonical.key:Is(o,i,c,h,m)}equals(i){return this.overscaledZ===i.overscaledZ&&this.wrap===i.wrap&&this.canonical.equals(i.canonical)}scaledTo(i){const o=this.canonical.z-i;return i>this.canonical.z?new Mr(i,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Mr(i,this.wrap,i,this.canonical.x>>o,this.canonical.y>>o)}calculateScaledKey(i,o=!0){if(this.overscaledZ===i&&o)return this.key;if(i>this.canonical.z)return Is(this.wrap*+o,i,this.canonical.z,this.canonical.x,this.canonical.y);{const c=this.canonical.z-i;return Is(this.wrap*+o,i,i,this.canonical.x>>c,this.canonical.y>>c)}}isChildOf(i){if(i.wrap!==this.wrap)return!1;const o=this.canonical.z-i.canonical.z;return 0===i.overscaledZ||i.overscaledZ<this.overscaledZ&&i.canonical.z<this.canonical.z&&i.canonical.x===this.canonical.x>>o&&i.canonical.y===this.canonical.y>>o}children(i){if(this.overscaledZ>=i)return[new Mr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const o=this.canonical.z+1,c=2*this.canonical.x,h=2*this.canonical.y;return[new Mr(o,this.wrap,o,c,h),new Mr(o,this.wrap,o,c+1,h),new Mr(o,this.wrap,o,c,h+1),new Mr(o,this.wrap,o,c+1,h+1)]}isLessThan(i){return this.wrap<i.wrap||!(this.wrap>i.wrap)&&(this.overscaledZ<i.overscaledZ||!(this.overscaledZ>i.overscaledZ)&&(this.canonical.x<i.canonical.x||!(this.canonical.x>i.canonical.x)&&this.canonical.y<i.canonical.y))}wrapped(){return new Mr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(i){return new Mr(this.overscaledZ,i,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new wa(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Is(a,i,o,c,h){const m=1<<Math.min(o,22);let g=m*(h%m)+c%m;return a&&o<22&&(g+=m*m*((a<0?-2*a-1:2*a)%(1<<2*(22-o)))),16*(32*g+o)+(i-o)}const sa=[a=>{let i=a.canonical.x-1,o=a.wrap;return i<0&&(i=(1<<a.canonical.z)-1,o--),new Mr(a.overscaledZ,o,a.canonical.z,i,a.canonical.y)},a=>{let i=a.canonical.x+1,o=a.wrap;return i===1<<a.canonical.z&&(i=0,o++),new Mr(a.overscaledZ,o,a.canonical.z,i,a.canonical.y)},a=>new Mr(a.overscaledZ,a.wrap,a.canonical.z,a.canonical.x,(0===a.canonical.y?1<<a.canonical.z:a.canonical.y)-1),a=>new Mr(a.overscaledZ,a.wrap,a.canonical.z,a.canonical.x,a.canonical.y===(1<<a.canonical.z)-1?0:a.canonical.y+1)];Et(Wo,"CanonicalTileID"),Et(Mr,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Jx=En([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Rm}=Jx,T_=En([{name:"a_pos_3",components:3,type:"Int16"}]);var Om=En([{name:"a_pos",type:"Int16",components:2}]);function vl(a){return a*Zi/C}const pE=[new sn([y,y,y],[v,v,v]),new sn([y,y,y],[0,0,v]),new sn([0,y,y],[v,0,v]),new sn([y,0,y],[0,v,v]),new sn([0,0,y],[v,v,v])];function eb(a,i,o,c=!0){const h=ki([],a._camera.position,a.worldSize),m=[i,o,1,1];xs(m,m,a.pixelMatrixInverse),Wa(m,m,1/m[3]);const g=Mi([],cr([],m,h)),x=a.globeMatrix,w=[x[12],x[13],x[14]],T=cr([],w,h),I=go(T),A=Mi([],T),M=a.worldSize/(2*Math.PI),k=ar(A,g),L=Math.asin(M/I);if(L<Math.acos(k)){if(!c)return null;const Ve=[],Ce=[];ki(Ve,g,I/k),Mi(Ce,cr(Ce,Ve,T)),Mi(g,Fi(g,T,ki(g,Ce,Math.tan(L)*I)))}const V=[];new Mn(h,g).closestPointOnSphere(w,M,V);const j=Mi([],Vi(x,0)),W=Mi([],Vi(x,1)),Q=Mi([],Vi(x,2)),K=ar(j,V),te=ar(W,V),me=ar(Q,V),he=Pe(Math.asin(-te/M));let fe=Pe(Math.atan2(K,me));fe=a.center.lng+function(Ve,Ce){const Ue=(Ce-Ve+180)%360-180;return Ue<-180?Ue+360:Ue}(a.center.lng,fe);const xe=U(fe),Ee=se(q(he),0,1);return new ue(xe,Ee)}class mE{constructor(i,o,c){this.a=cr([],i,c),this.b=cr([],o,c),this.center=c;const h=Mi([],this.a),m=Mi([],this.b);this.angle=Math.acos(ar(h,m))}}function D_(a,i){if(0===a.angle)return null;let o;return o=0===a.a[i]?1/a.angle*.5*Math.PI:1/a.angle*Math.atan(a.b[i]/a.a[i]/Math.sin(a.angle)-1/Math.tan(a.angle)),o<0||o>1?null:function(c,h,m,g){const x=Math.sin(m);return c*(Math.sin((1-g)*m)/x)+h*(Math.sin(g*m)/x)}(a.a[i],a.b[i],a.angle,se(o,0,1))+a.center[i]}function Va(a){if(a.z<=1)return pE[a.z+2*a.y+a.x];const i=Nv(Fm(a));return sn.fromPoints(i)}function au(a,i,o){return ki(a,a,1-o),Uo(a,a,i,o)}function tb(a,i,o){for(const c of a)lr(c,c,i),ki(c,c,o)}function nb(a,i,o,c){const h=i/a.worldSize,m=a.globeMatrix;if(o.z<=1){const Ee=Va(o).getCorners();return tb(Ee,m,h),sn.fromPoints(Ee)}const g=Fm(o,c),x=Nv(g,Zi+vl(a._tileCoverLift));tb(x,m,h);const w=Number.MAX_VALUE,T=[-w,-w,-w],I=[w,w,w];if(g.contains(a.center)){for(const Ce of x)Aa(I,I,Ce),Hi(T,T,Ce);T[2]=0;const Ee=a.point,Ve=[Ee.x*h,Ee.y*h,0];return Aa(I,I,Ve),Hi(T,T,Ve),new sn(I,T)}if(a._tileCoverLift>0){for(const Ee of x)Aa(I,I,Ee),Hi(T,T,Ee);return new sn(I,T)}const A=[m[12]*h,m[13]*h,m[14]*h],M=g.getCenter(),k=se(a.center.lat,-le,le),L=se(M.lat,-le,le),V=U(a.center.lng),j=q(k);let W=V-U(M.lng);const Q=j-q(L);W>.5?W-=1:W<-.5&&(W+=1);let K=0;Math.abs(W)>Math.abs(Q)?K=W>=0?1:3:(K=Q>=0?0:2,Uo(A,A,[m[4]*h,m[5]*h,m[6]*h],-Math.sin(Rn(Q>=0?g.getSouth():g.getNorth()))*Zi));const te=x[K],me=x[(K+1)%4],he=new mE(te,me,A),fe=[D_(he,0)||te[0],D_(he,1)||te[1],D_(he,2)||te[2]],xe=lu(a.zoom);if(xe>0){const Ee=function({x:Ce,y:Ue,z:ot},$e,Ke,nt,ze){const Qe=1/(1<<ot);let Ae=Ce*Qe,Be=Ae+Qe,at=Ue*Qe,et=at+Qe,Ft=0;const St=(Ae+Be)/2-nt;return St>.5?Ft=-1:St<-.5&&(Ft=1),Ae=((Ae+Ft)*$e-(nt*=$e))*Ke+nt,Be=((Be+Ft)*$e-nt)*Ke+nt,at=(at*$e-(ze*=$e))*Ke+ze,et=(et*$e-ze)*Ke+ze,[[Ae,et,0],[Be,et,0],[Be,at,0],[Ae,at,0]]}(o,i,a._pixelsPerMercatorPixel,V,j);for(let Ce=0;Ce<x.length;Ce++)au(x[Ce],Ee[Ce],xe);const Ve=Fi([],Ee[K],Ee[(K+1)%4]);ki(Ve,Ve,.5),au(fe,Ve,xe)}for(const Ee of x)Aa(I,I,Ee),Hi(T,T,Ee);return I[2]=Math.min(te[2],me[2]),Aa(I,I,fe),Hi(T,T,fe),new sn(I,T)}function Fm({x:a,y:i,z:o},c=!1){const h=1/(1<<o),m=new O(Y(a*h),i===(1<<o)-1&&c?-90:ee((i+1)*h)),g=new O(Y((a+1)*h),0===i&&c?90:ee(i*h));return new N(m,g)}function Nv(a,i=Zi){const o=Rn(a.getNorth()),c=Rn(a.getSouth()),h=Math.cos(o),m=Math.cos(c),g=Math.sin(o),x=Math.sin(c),w=a.getWest(),T=a.getEast();return[b(m,x,w,i),b(m,x,T,i),b(h,g,T,i),b(h,g,w,i)]}function km(a,i,o,c){const h=1<<o.z,m=(a/ht+o.x)/h;return D(ee((i/ht+o.y)/h),Y(m),c)}function ps({min:a,max:i}){return r/Math.max(i[0]-a[0],i[1]-a[1],i[2]-a[2])}const S_=new Float64Array(16);function Lm(a){const i=ps(a),o=Bl(S_,[i,i,i]);return jo(o,o,Gi([],a.min))}function Nm(a){const i=(c=a.min,(o=S_)[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=1,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=c[0],o[13]=c[1],o[14]=c[2],o[15]=1,o);var o,c;const h=1/ps(a);return ro(i,i,[h,h,h])}function Zo(a){const i=ht/(2*Math.PI);return a/(2*Math.PI)/i}function Kf(a,i){return ht/(512*Math.pow(2,a))*ps(Va(i))}function zv(a,i,o,c,h){const m=Zo(o),g=[a,i,-o/(2*Math.PI)],x=fn(new Float64Array(16));return jo(x,x,g),ro(x,x,[m,m,m]),ys(x,x,Rn(-h)),Ws(x,x,Rn(-c)),x}function lu(a){return be(Yf,f,a)}function ib(a,i){const o=D(i.lat,i.lng);return g=(h=oo([],function(L){const V=D(L._center.lat,L._center.lng);let j=vi([],mr(0,1,0),V);const W=da([],-L.angle,V);j=lr(j,j,W),da(W,-L._pitch,j);const Q=Mi([],V);return ki(Q,Q,vl(L.cameraToCenterDistance/L.pixelsPerMeter)),lr(Q,Q,W),Fi([],V,Q)}(a),o))[0],x=h[1],w=h[2],T=(m=o)[0],I=m[1],A=m[2],k=(M=Math.sqrt(g*g+x*x+w*w)*Math.sqrt(T*T+I*I+A*A))&&ar(h,m)/M,Math.acos(Math.min(Math.max(k,-1),1));var h,m,g,x,w,T,I,A,M,k}function C_(a,i){return ib(a,i)>Math.PI/2*1.01}const rb=Rn(85),ob=Math.cos(rb),gE=Math.sin(rb),sb=Nl(),ab=a=>{const i=[];return"map"===a.paint.get("circle-pitch-alignment")&&i.push("PITCH_WITH_MAP"),"map"===a.paint.get("circle-pitch-scale")&&i.push("SCALE_WITH_MAP"),i};function lb(a,i,o,c,h,m,g,x,w){if(m&&a.queryGeometry.isAboveHorizon)return!1;m&&(w*=a.pixelToTileUnitsFactor);const T=a.tileID.canonical,I=o.projection.upVectorScale(T,o.center.lat,o.worldSize).metersToTile;for(const A of i)for(const M of A){const k=M.add(x),L=h&&o.elevation?o.elevation.exaggeration()*h.getElevationAt(k.x,k.y,!0):0,V=o.projection.projectTilePoint(k.x,k.y,T);if(L>0){const K=o.projection.upVector(T,k.x,k.y);V.x+=K[0]*I*L,V.y+=K[1]*I*L,V.z+=K[2]*I*L}const j=m?k:Bv(V.x,V.y,V.z,c),W=m?a.tilespaceRays.map(K=>zm(K,L)):a.queryGeometry.screenGeometry,Q=xs([],[V.x,V.y,V.z,1],c);if(!g&&m?w*=Q[3]/o.cameraToCenterDistance:g&&!m&&(w*=o.cameraToCenterDistance/Q[3]),m){const K=ee((M.y/ht+T.y)/(1<<T.z));w/=o.projection.pixelsPerMeter(K,1)/G(1,K)}if(xr(W,j,w))return!0}return!1}function Bv(a,i,o,c){const h=xs([],[a,i,o,1],c);return new Je(h[0]/h[3],h[1]/h[3])}const I_=mr(0,0,0),_E=mr(0,0,1);function zm(a,i){const o=Un();return I_[2]=i,a.intersectsPlane(I_,_E,o),new Je(o[0],o[1])}class cb extends Wn{}let ub,Vv,jv,Uv;function Dh(a,{width:i,height:o},c,h){if(h){if(h instanceof Uint8ClampedArray)h=new Uint8Array(h.buffer);else if(h.length!==i*o*c)throw new RangeError("mismatched image size")}else h=new Uint8Array(i*o*c);return a.width=i,a.height=o,a.data=h,a}function Bm(a,i,o){const{width:c,height:h}=i;c===a.width&&h===a.height||(A_(a,i,{x:0,y:0},{x:0,y:0},{width:Math.min(a.width,c),height:Math.min(a.height,h)},o,null),a.width=c,a.height=h,a.data=i.data)}function A_(a,i,o,c,h,m,g,x){if(0===h.width||0===h.height)return i;if(h.width>a.width||h.height>a.height||o.x>a.width-h.width||o.y>a.height-h.height)throw new RangeError("out of range source coordinates for image copy");if(h.width>i.width||h.height>i.height||c.x>i.width-h.width||c.y>i.height-h.height)throw new RangeError("out of range destination coordinates for image copy");const w=a.data,T=i.data,I=4===m&&x;for(let A=0;A<h.height;A++){const M=((o.y+A)*a.width+o.x)*m,k=((c.y+A)*i.width+c.x)*m;if(I)for(let L=0;L<h.width;L++){const V=M+L*m+3,j=k+L*m;T[j+0]=255,T[j+1]=255,T[j+2]=255,T[j+3]=w[V]}else if(g)for(let L=0;L<h.width;L++){const V=M+L*m,j=k+L*m,W=new Kn(w[V+0]/255,w[V+1]/255,w[V+2]/255,w[V+3]).toNonPremultipliedRenderColor(g).toArray();T[j+0]=W[0],T[j+1]=W[1],T[j+2]=W[2],T[j+3]=W[3]}else for(let L=0;L<h.width*m;L++)T[k+L]=w[M+L]}return i}Et(cb,"HeatmapBucket",{omit:["layers"]});class hc{constructor(i,o){Dh(this,i,1,o)}resize(i){Bm(this,new hc(i),1)}clone(){return new hc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(i,o,c,h,m){A_(i,o,c,h,m,1,null)}}class $r{constructor(i,o){Dh(this,i,4,o)}resize(i){Bm(this,new $r(i),4)}replace(i,o){o?this.data.set(i):this.data=i instanceof Uint8ClampedArray?new Uint8Array(i.buffer):i}clone(){return new $r({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(i,o,c,h,m,g,x){A_(i,o,c,h,m,4,g,x)}}class db{constructor(i,o){this.width=i.width,this.height=i.height,this.data=o instanceof Uint8Array?new Float32Array(o.buffer):o}}function Vm(a){const i={},o=a.resolution||256,c=a.clips?a.clips.length:1,h=a.image||new $r({width:o,height:c}),m=(g,x,w)=>{i[a.evaluationKey]=w;const T=a.expression.evaluate(i),I=T?T.toNonPremultipliedRenderColor(null):null;I&&(h.data[g+x+0]=Math.floor(255*I.r),h.data[g+x+1]=Math.floor(255*I.g),h.data[g+x+2]=Math.floor(255*I.b),h.data[g+x+3]=Math.floor(255*I.a))};if(a.clips)for(let g=0,x=0;g<c;++g,x+=4*o)for(let w=0,T=0;w<o;w++,T+=4){const I=w/(o-1),{start:A,end:M}=a.clips[g];m(x,T,A*(1-I)+M*I)}else for(let g=0,x=0;g<o;g++,x+=4)m(0,x,g/(o-1));return h}Et(hc,"AlphaImage"),Et($r,"RGBAImage");const yE=En([{name:"a_pos",components:2,type:"Int16"}],4),vE=En([{name:"a_road_z_offset",components:1,type:"Float32"}],4),xE=En([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),bE=En([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Sh(a,i,o=2){const c=i&&i.length,h=c?i[0]*o:a.length;let m=jm(a,0,h,o,!0);const g=[];if(!m||m.next===m.prev)return g;let x,w,T;if(c&&(m=function(I,A,M,k){const L=[];for(let V=0,j=A.length;V<j;V++){const W=jm(I,A[V]*k,V<j-1?A[V+1]*k:I.length,k,!1);W===W.next&&(W.steiner=!0),L.push(xC(W))}L.sort(Ih);for(let V=0;V<L.length;V++)M=fb(L[V],M);return M}(a,i,m,o)),a.length>80*o){x=a[0],w=a[1];let I=x,A=w;for(let M=o;M<h;M+=o){const k=a[M],L=a[M+1];k<x&&(x=k),L<w&&(w=L),k>I&&(I=k),L>A&&(A=L)}T=Math.max(I-x,A-w),T=0!==T?32767/T:0}return Ch(m,g,o,x,w,T,0),g}function jm(a,i,o,c,h){let m;if(h===function(g,x,w,T){let I=0;for(let A=x,M=w-T;A<w;A+=T)I+=(g[M]-g[A])*(g[A+1]+g[M+1]),M=A;return I}(a,i,o,c)>0)for(let g=i;g<o;g+=c)m=P_(g/c|0,a[g],a[g+1],m);else for(let g=o-c;g>=i;g-=c)m=P_(g/c|0,a[g],a[g+1],m);return m&&Ah(m,m.next)&&(dd(m),m=m.next),m}function cu(a,i){if(!a)return a;i||(i=a);let o,c=a;do{if(o=!1,c.steiner||!Ah(c,c.next)&&0!==Vr(c.prev,c,c.next))c=c.next;else{if(dd(c),c=i=c.prev,c===c.next)break;o=!0}}while(o||c!==i);return i}function Ch(a,i,o,c,h,m,g){if(!a)return;!g&&m&&function(w,T,I,A){let M=w;do{0===M.z&&(M.z=Gv(M.x,M.y,T,I,A)),M.prevZ=M.prev,M.nextZ=M.next,M=M.next}while(M!==w);M.prevZ.nextZ=null,M.prevZ=null,function(k){let L,V=1;do{let j,W=k;k=null;let Q=null;for(L=0;W;){L++;let K=W,te=0;for(let he=0;he<V&&(te++,K=K.nextZ,K);he++);let me=V;for(;te>0||me>0&&K;)0!==te&&(0===me||!K||W.z<=K.z)?(j=W,W=W.nextZ,te--):(j=K,K=K.nextZ,me--),Q?Q.nextZ=j:k=j,j.prevZ=Q,Q=j;W=K}Q.nextZ=null,V*=2}while(L>1)}(M)}(a,c,h,m);let x=a;for(;a.prev!==a.next;){const w=a.prev,T=a.next;if(m?EE(a,c,h,m):wE(a))i.push(w.i,a.i,T.i),dd(a),a=T.next,x=T.next;else if((a=T)===x){g?1===g?Ch(a=Hv(cu(a),i),i,o,c,h,m,2):2===g&&hb(a,i,o,c,h,m):Ch(cu(a),i,o,c,h,m,1);break}}}function wE(a){const i=a.prev,o=a,c=a.next;if(Vr(i,o,c)>=0)return!1;const h=i.x,m=o.x,g=c.x,x=i.y,w=o.y,T=c.y,I=Math.min(h,m,g),A=Math.min(x,w,T),M=Math.max(h,m,g),k=Math.max(x,w,T);let L=c.next;for(;L!==i;){if(L.x>=I&&L.x<=M&&L.y>=A&&L.y<=k&&Hm(h,x,m,w,g,T,L.x,L.y)&&Vr(L.prev,L,L.next)>=0)return!1;L=L.next}return!0}function EE(a,i,o,c){const h=a.prev,m=a,g=a.next;if(Vr(h,m,g)>=0)return!1;const x=h.x,w=m.x,T=g.x,I=h.y,A=m.y,M=g.y,k=Math.min(x,w,T),L=Math.min(I,A,M),V=Math.max(x,w,T),j=Math.max(I,A,M),W=Gv(k,L,i,o,c),Q=Gv(V,j,i,o,c);let K=a.prevZ,te=a.nextZ;for(;K&&K.z>=W&&te&&te.z<=Q;){if(K.x>=k&&K.x<=V&&K.y>=L&&K.y<=j&&K!==h&&K!==g&&Hm(x,I,w,A,T,M,K.x,K.y)&&Vr(K.prev,K,K.next)>=0||(K=K.prevZ,te.x>=k&&te.x<=V&&te.y>=L&&te.y<=j&&te!==h&&te!==g&&Hm(x,I,w,A,T,M,te.x,te.y)&&Vr(te.prev,te,te.next)>=0))return!1;te=te.nextZ}for(;K&&K.z>=W;){if(K.x>=k&&K.x<=V&&K.y>=L&&K.y<=j&&K!==h&&K!==g&&Hm(x,I,w,A,T,M,K.x,K.y)&&Vr(K.prev,K,K.next)>=0)return!1;K=K.prevZ}for(;te&&te.z<=Q;){if(te.x>=k&&te.x<=V&&te.y>=L&&te.y<=j&&te!==h&&te!==g&&Hm(x,I,w,A,T,M,te.x,te.y)&&Vr(te.prev,te,te.next)>=0)return!1;te=te.nextZ}return!0}function Hv(a,i){let o=a;do{const c=o.prev,h=o.next.next;!Ah(c,h)&&M_(c,o,o.next,h)&&uu(c,h)&&uu(h,c)&&(i.push(c.i,o.i,h.i),dd(o),dd(o.next),o=a=h),o=o.next}while(o!==a);return cu(o)}function hb(a,i,o,c,h,m){let g=a;do{let x=g.next.next;for(;x!==g.prev;){if(g.i!==x.i&&mb(g,x)){let w=$v(g,x);return g=cu(g,g.next),w=cu(w,w.next),Ch(g,i,o,c,h,m,0),void Ch(w,i,o,c,h,m,0)}x=x.next}g=g.next}while(g!==a)}function Ih(a,i){let o=a.x-i.x;return 0===o&&(o=a.y-i.y,0===o)&&(o=(a.next.y-a.y)/(a.next.x-a.x)-(i.next.y-i.y)/(i.next.x-i.x)),o}function fb(a,i){const o=function(h,m){let g=m;const x=h.x,w=h.y;let T,I=-1/0;if(Ah(h,g))return g;do{if(Ah(h,g.next))return g.next;if(w<=g.y&&w>=g.next.y&&g.next.y!==g.y){const V=g.x+(w-g.y)*(g.next.x-g.x)/(g.next.y-g.y);if(V<=x&&V>I&&(I=V,T=g.x<g.next.x?g:g.next,V===x))return T}g=g.next}while(g!==m);if(!T)return null;const A=T,M=T.x,k=T.y;let L=1/0;g=T;do{if(x>=g.x&&g.x>=M&&x!==g.x&&Um(w<k?x:I,w,M,k,w<k?I:x,w,g.x,g.y)){const V=Math.abs(w-g.y)/(x-g.x);uu(g,h)&&(V<L||V===L&&(g.x>T.x||g.x===T.x&&pb(T,g)))&&(T=g,L=V)}g=g.next}while(g!==A);return T}(a,i);if(!o)return i;const c=$v(o,a);return cu(c,c.next),cu(o,o.next)}function pb(a,i){return Vr(a.prev,a,i.prev)<0&&Vr(i.next,a,a.next)<0}function Gv(a,i,o,c,h){return(a=1431655765&((a=858993459&((a=252645135&((a=16711935&((a=(a-o)*h|0)|a<<8))|a<<4))|a<<2))|a<<1))|(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-c)*h|0)|i<<8))|i<<4))|i<<2))|i<<1))<<1}function xC(a){let i=a,o=a;do{(i.x<o.x||i.x===o.x&&i.y<o.y)&&(o=i),i=i.next}while(i!==a);return o}function Um(a,i,o,c,h,m,g,x){return(h-g)*(i-x)>=(a-g)*(m-x)&&(a-g)*(c-x)>=(o-g)*(i-x)&&(o-g)*(m-x)>=(h-g)*(c-x)}function Hm(a,i,o,c,h,m,g,x){return!(a===g&&i===x)&&Um(a,i,o,c,h,m,g,x)}function mb(a,i){return a.next.i!==i.i&&a.prev.i!==i.i&&!function(o,c){let h=o;do{if(h.i!==o.i&&h.next.i!==o.i&&h.i!==c.i&&h.next.i!==c.i&&M_(h,h.next,o,c))return!0;h=h.next}while(h!==o);return!1}(a,i)&&(uu(a,i)&&uu(i,a)&&function(o,c){let h=o,m=!1;const g=(o.x+c.x)/2,x=(o.y+c.y)/2;do{h.y>x!=h.next.y>x&&h.next.y!==h.y&&g<(h.next.x-h.x)*(x-h.y)/(h.next.y-h.y)+h.x&&(m=!m),h=h.next}while(h!==o);return m}(a,i)&&(Vr(a.prev,a,i.prev)||Vr(a,i.prev,i))||Ah(a,i)&&Vr(a.prev,a,a.next)>0&&Vr(i.prev,i,i.next)>0)}function Vr(a,i,o){return(i.y-a.y)*(o.x-i.x)-(i.x-a.x)*(o.y-i.y)}function Ah(a,i){return a.x===i.x&&a.y===i.y}function M_(a,i,o,c){const h=Mh(Vr(a,i,o)),m=Mh(Vr(a,i,c)),g=Mh(Vr(o,c,a)),x=Mh(Vr(o,c,i));return h!==m&&g!==x||!(0!==h||!Gm(a,o,i))||!(0!==m||!Gm(a,c,i))||!(0!==g||!Gm(o,a,c))||!(0!==x||!Gm(o,i,c))}function Gm(a,i,o){return i.x<=Math.max(a.x,o.x)&&i.x>=Math.min(a.x,o.x)&&i.y<=Math.max(a.y,o.y)&&i.y>=Math.min(a.y,o.y)}function Mh(a){return a>0?1:a<0?-1:0}function uu(a,i){return Vr(a.prev,a,a.next)<0?Vr(a,i,a.next)>=0&&Vr(a,a.prev,i)>=0:Vr(a,i,a.prev)<0||Vr(a,a.next,i)<0}function $v(a,i){const o=R_(a.i,a.x,a.y),c=R_(i.i,i.x,i.y),h=a.next,m=i.prev;return a.next=i,i.prev=a,o.next=h,h.prev=o,c.next=o,o.prev=c,m.next=c,c.prev=m,c}function P_(a,i,o,c){const h=R_(a,i,o);return c?(h.next=c.next,h.prev=c,c.next.prev=h,c.next=h):(h.prev=h,h.next=h),h}function dd(a){a.next.prev=a.prev,a.prev.next=a.next,a.prevZ&&(a.prevZ.nextZ=a.nextZ),a.nextZ&&(a.nextZ.prevZ=a.prevZ)}function R_(a,i,o){return{i:a,x:i,y:o,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Ph(a,i){const o=a.length;if(o<=1)return[a];const c=[];let h,m;for(let g=0;g<o;g++){const x=Cr(a[g]);0!==x&&(a[g].area=Math.abs(x),void 0===m&&(m=x<0),m===x<0?(h&&c.push(h),h=[a[g]]):h.push(a[g]))}if(h&&c.push(h),i>1)for(let g=0;g<c.length;g++)c[g].length<=i||(eo(c[g],i,1,c[g].length-1,$m),c[g]=c[g].slice(0,i));return c}function $m(a,i){return i.area-a.area}function gb(a,i,o=1){if(!a)return null;const c="string"==typeof a?vo.from(a).getPrimary():a.getPrimary(),h="string"==typeof a?null:a.getSecondary();for(const m of[c,h]){if(!m)continue;const g=m.id.toString();i.has(g)||i.set(g,[]),m.scaleSelf(o),i.get(g).push(m)}return{primary:c.toString(),secondary:h?h.toString():null}}function O_(a,i,o,c){const h=c.patternDependencies;let m=!1;for(const g of i){const x=g.paint.get(`${a}-pattern`);x.isConstant()||(m=!0),gb(x.constantOr(null),h,o)&&(m=!0)}return m}function qv(a,i,o,c,h,m){const g=m.patternDependencies;for(const x of i){const w=x.paint.get(`${a}-pattern`).value;if("constant"!==w.kind){let T=w.evaluate({zoom:c},o,{},m.availableImages);T=T&&T.name?T.name:T;const I=gb(T,g,h);if(!I)continue;const{primary:A,secondary:M}=I;A&&(o.patterns[x.id]=[A,M].filter(Boolean))}}return o}class _b{constructor(){this.polygons=new Map}add(i,...o){this.polygons.has(i)?this.polygons.get(i).push(...o):this.polygons.set(i,o)}merge(i){for(const[o,c]of i.polygons)this.add(o,...c)}}class Rh{constructor(){this.portals=[]}static evaluate(i){if(0===i.length)return new Rh;let o=[];for(const T of i)o.push(...T.portals);if(0===o.length)return new Rh;const c=(T,I)=>T<=0&&I<=0||T>=ht&&I>=ht;for(const T of o){const I=T.va,A=T.vb;(c(I.x,A.x)||c(I.y,A.y))&&(T.type="border")}const h=o.filter(T=>"unevaluated"!==T.type),m=o.filter(T=>"unevaluated"===T.type);if(0===m.length)return new Rh;m.sort((T,I)=>T.hash===I.hash?T.isTunnel===I.isTunnel?0:T.isTunnel?-1:1:T.hash<I.hash?1:-1),o=h.concat(m);let g=h.length,x=g,w=g;do{if(x++,x===o.length||o[g].hash!==o[x].hash){if(x-g==2){w<g&&(o[w]=o[g],o[g]=null);const T=o[w],I=o[x-1];T.type=T.isTunnel!==I.isTunnel?"tunnel":"polygon",T.connection={a:T.connection.a,b:I.connection.a},w++}g=x}}while(g!==o.length);return o.splice(w),o.sort((T,I)=>T.hash<I.hash?1:-1),{portals:o}}}Et(Rh,"ElevationPortalGraph"),Et(_b,"ElevationPolygons");class yb{constructor(i,o,c){this.outPositions=i,this.outNormals=o,this.outIndices=c,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(i,o,c){let h=i[2];null!=c&&(h*=c);const m=this.getVec3Bits(i)<<96n|this.getVec3Bits(o),g=this.vertexLookup.get(m);if(null!=g)return g;const x=this.outPositions.length;this.vertexLookup.set(m,x);const w=Math.trunc(16384*o[0]),T=Math.trunc(16384*o[1]),I=Math.trunc(16384*o[2]);return this.outPositions.emplaceBack(i[0],i[1],h),this.outNormals.emplaceBack(w,T,I),x}addTriangle(i,o,c){this.outIndices.emplaceBack(i,o,c)}addTriangles(i,o,c){if(0===i.length)return;const h=1===c.length,m=Un(),g=Un();for(let x=0;x<i.length;x+=3){const w=o[i[x+0]],T=o[i[x+1]],I=o[i[x+2]],A=h?c[0]:c[i[x+1]],M=h?c[0]:c[i[x+2]];gr(m,w.x,w.y,h?c[0]:c[i[x+0]]);const k=this.addVertex(m,g);gr(m,T.x,T.y,A);const L=this.addVertex(m,g);gr(m,I.x,I.y,M);const V=this.addVertex(m,g);this.outIndices.emplaceBack(k,L,V)}}addQuad(i,o,c,h,m,g){const x=this.addVertex(i,m,g),w=this.addVertex(o,m,g),T=this.addVertex(c,m,g),I=this.addVertex(h,m,g);this.addTriangle(x,w,T),this.addTriangle(T,I,x)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(i){return this.view.setFloat32(0,i),BigInt(this.view.getUint32(0))}getVec3Bits(i){return this.getBits(i[0])<<64n|this.getBits(i[1])<<32n|this.getBits(i[2])}}class As{constructor(i,o,c,h){this.unevaluatedPortals=new Rh,this.portalPolygons=new _b,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Gf,this.vertexNormals=new oc,this.indexArray=new Pi,this.tileToMeters=ce(i),this.bridgeProgramConfigurations=new Cs(o,{zoom:c,lut:h},m=>"fill-tunnel-structure-color"!==m),this.tunnelProgramConfigurations=new Cs(o,{zoom:c,lut:h},m=>"fill-bridge-guard-rail-color"!==m)}addVertices(i,o){const c=this.unevalVertices.length;for(let h=0;h<i.length;h++)this.unevalVertices.push(i[h]),this.unevalHeights.push(o[h]);return c}addTriangles(i,o,c){const h=c?this.unevalTunnelTriangles:this.unevalTriangles;for(const m of i)h.push(m+o)}addRenderableRing(i,o,c,h,m,g){const x=[new Je(m.min.x,m.min.y),new Je(m.max.x,m.min.y),new Je(m.max.x,m.max.y),new Je(m.min.x,m.max.y)];for(let w=0;w<c-1;w++){const T=o+w,I=T+1,A=this.unevalVertices[T],M=this.unevalVertices[I];if(!(A.x>=m.min.x&&A.x<=m.max.x&&A.y>=m.min.y&&A.y<=m.max.y||M.x>=m.min.x&&M.x<=m.max.x&&M.y>=m.min.y&&M.y<=m.max.y||rr(A,M,x))||this.isOnBorder(A.x,M.x)||this.isOnBorder(A.y,M.y))continue;const k=As.computeEdgeHash(this.unevalVertices[T],this.unevalVertices[I]);let L,V=this.vertexHashLookup.get(As.computePosHash(A));null!=V?L=V.next:(V=this.vertexHashLookup.get(As.computePosHash(M)),L=null!=V?V.prev:k),this.unevalEdges.push({polygonIdx:i,a:T,b:I,hash:k,portalHash:L,isTunnel:h,type:"unevaluated",featureInfo:g})}}addPortalCandidates(i,o,c,h,m){if(0===o.length)return;this.portalPolygons.add(i,{geometry:o,zLevel:m});const g=o[0];this.vertexHashLookup.clear();let x=As.computeEdgeHash(g[g.length-2],g[g.length-1]);for(let w=0;w<g.length-1;w++){const T=g[w+0],I=g[w+1],A=Zr(I.x-T.x,I.y-T.y),M=Ul(A);if(0===M)continue;let k="unevaluated";const L=h.pointElevation(T),V=h.pointElevation(I);Math.abs(L)<.01&&Math.abs(V)<.01?k="entrance":(this.isOnBorder(T.x,I.x)||this.isOnBorder(T.y,I.y))&&(k="border");const j=As.computeEdgeHash(T,I);this.unevaluatedPortals.portals.push({connection:{a:i,b:void 0},va:T,vb:I,vab:A,length:M,hash:j,isTunnel:c,type:k});const W=As.computePosHash(T);this.vertexHashLookup.set(W,{prev:x,next:j}),x=j}}construct(i){if(0===this.unevalVertices.length)return;const o=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),c=M=>{M.primitiveLength=this.indexArray.length-M.primitiveOffset},h=new yb(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(i.portals,this.unevalEdges);const m=o(),g=o(),x=o(),w=(M,k)=>{M.sort((V,j)=>V.type===k&&j.type!==k?-1:V.type!==k&&j.type===k?1:0);const L=M.findIndex(V=>V.type!==k);return L>=0?L:M.length};let T=0;this.unevalEdges.length>0&&(T=w(this.unevalEdges,"none"),this.constructBridgeStructures(h,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:T},this.tileToMeters)),c(x);const I=o(),A=o();if(this.unevalEdges.length>0){const M=this.unevalEdges.splice(T),k=w(M,"tunnel")+T;this.unevalEdges.push(...M),this.constructTunnelStructures(h,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:T},{min:T,max:k})}c(I),h.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),c(A),h.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),c(g),h.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),c(m),this.maskSegments=Wi.simpleSegment(0,A.primitiveOffset,0,A.primitiveLength),this.depthSegments=Wi.simpleSegment(0,g.primitiveOffset,0,g.primitiveLength),this.renderableBridgeSegments=Wi.simpleSegment(0,x.primitiveOffset,0,x.primitiveLength),this.renderableTunnelSegments=Wi.simpleSegment(0,I.primitiveOffset,0,I.primitiveLength),this.shadowCasterSegments=Wi.simpleSegment(0,m.primitiveOffset,0,m.primitiveLength)}update(i,o,c,h,m,g,x,w){this.bridgeProgramConfigurations.updatePaintArrays(i,o,m,c,h,g,x,w),this.tunnelProgramConfigurations.updatePaintArrays(i,o,m,c,h,g,x,w)}upload(i){this.vertexBuffer||0===this.vertexPositions.length||0===this.vertexNormals.length||0===this.indexArray.length||(this.vertexBuffer=i.createVertexBuffer(this.vertexPositions,xE.members),this.vertexBufferNormal=i.createVertexBuffer(this.vertexNormals,bE.members),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(i),this.tunnelProgramConfigurations.upload(i))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(i,o,c,h,m){const g=(x,w)=>{for(let T=0;T<w.length-1;T++){const I=w[T].featureIndex,A=w[T+1].vertexStart,M=i.feature(I);x.populatePaintArrays(A,M,I,{},c,o,h,void 0,m)}};g(this.bridgeProgramConfigurations,this.bridgeFeatureSections),g(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(i,o,c,h,m){const g=new Map;for(let x=h;x<m;x++){const w=c[x],T=w.a,I=w.b,A=As.computePosHash(i[T]),M=As.computePosHash(i[I]);let k=g.get(A);k||(k={},g.set(A,k));let L=g.get(M);L||(L={},g.set(M,L)),o[T]<=0&&o[I]<=0||(k.to=I,L.from=T)}return g}isTerminalVertex(i,o){const c=As.computePosHash(this.unevalVertices[i]),h=o.get(c);return!h||!h.from||!h.to}constructBridgeStructures(i,o,c,h,m,g){i.clearVertexLookup();const x=this.computeVertexConnections(o,c,h,m.min,m.max),w=1/g,T=.5*w,I=(Ke,nt)=>gr(Ke,o[nt].x,o[nt].y,c[nt]*w),A=Un(),M=Un(),k=Un(),L=Un(),V=Un(),j=(Ke,nt)=>{const ze=x.get(As.computePosHash(o[nt])),Qe=ze.from,Ae=ze.to;if(!Qe||!Ae)return;I(A,Qe),I(M,nt),I(k,Ae),Ld(L),vs(A,M)||(cr(V,M,A),Mi(L,V)),vs(k,M)||(cr(V,k,M),Fi(L,L,Mi(V,V)));const Be=Vl(L);return Be>0?ki(Ke,L,1/Be):void 0};let W=Number.POSITIVE_INFINITY;this.sortSubarray(h,m.min,m.max,(Ke,nt)=>Ke.featureInfo.featureIndex-nt.featureInfo.featureIndex);const Q=Un(),K=Un(),te=Un(),me=Un(),he=Un(),fe=Un(),xe=Un(),Ee=Un(),Ve=Un(),Ce=[Un(),Un(),Un(),Un()],Ue=[Un(),Un(),Un(),Un()],ot=[{coord:new Je(0,0),height:0},{coord:new Je(0,0),height:0}],$e=(Ke,nt)=>Ke>nt;for(let Ke=m.min;Ke<m.max;Ke++){const nt=h[Ke];if(!nt.featureInfo.guardRailEnabled||!this.prepareEdgePoints(ot,o,c,nt,$e))continue;const[ze,Qe]=ot;if(gr(Q,ze.coord.x,ze.coord.y,w*ze.height),gr(K,Qe.coord.x,Qe.coord.y,w*Qe.height),vs(Q,K))continue;cr(te,K,Q),Mi(te,te);const Ae=j(Ee,nt.a)||te,Be=j(Ve,nt.b)||te;gr(me,Ae[1],-Ae[0],0),Mi(me,me),gr(he,Be[1],-Be[0],0),Mi(he,he),vi(Ee,me,Ae),Mi(fe,Ee),vi(Ee,he,Be),Mi(xe,Ee),Fi(Ce[0],Q,ki(Ee,cr(Ee,me,fe),T)),Fi(Ce[1],Q,ki(Ee,Fi(Ee,me,fe),T)),Fi(Ce[2],Q,ki(Ee,fe,T)),Ce[3]=Q,Fi(Ue[0],K,ki(Ee,cr(Ee,he,xe),T)),Fi(Ue[1],K,ki(Ee,Fi(Ee,he,xe),T)),Fi(Ue[2],K,ki(Ee,xe,T)),Ue[3]=K,W=this.addFeatureSection(nt.featureInfo.featureIndex,W,this.bridgeFeatureSections,i);const at=i.addVertex(Ce[0],me,g),et=i.addVertex(Ce[1],me,g),Ft=i.addVertex(Ue[0],he,g),St=i.addVertex(Ue[1],he,g);i.addTriangle(at,et,Ft),i.addTriangle(et,St,Ft);const Xe=i.addVertex(Ce[1],fe,g),tt=i.addVertex(Ce[2],fe,g),It=i.addVertex(Ue[1],xe,g),yt=i.addVertex(Ue[2],xe,g);i.addTriangle(Xe,tt,It),i.addTriangle(tt,yt,It),Gi(me,me),Gi(he,he);const ft=i.addVertex(Ce[2],me,g),xt=i.addVertex(Ce[3],me,g),zt=i.addVertex(Ue[2],he,g),qt=i.addVertex(Ue[3],he,g);i.addTriangle(ft,xt,zt),i.addTriangle(xt,qt,zt);const rn=this.isTerminalVertex(nt.a,x),Kt=this.isTerminalVertex(nt.b,x);ze.height<.01&&rn&&i.addQuad(Ce[3],Ce[2],Ce[1],Ce[0],Gi(Ae,Ae),g),Qe.height<.01&&Kt&&i.addQuad(Ue[0],Ue[1],Ue[2],Ue[3],Be,g)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:i.getVertexCount()})}constructTunnelStructures(i,o,c,h,m,g){i.clearVertexLookup();let x=Number.POSITIVE_INFINITY;const w=(W,Q)=>W.featureInfo.featureIndex-Q.featureInfo.featureIndex;this.sortSubarray(h,m.min,m.max,w),this.sortSubarray(h,g.min,g.max,w);const T=W=>Mi(W,W),I=[{coord:new Je(0,0),height:0},{coord:new Je(0,0),height:0}],A=(W,Q)=>W<Q,M=Un(),k=Un(),L=Un(),V=Un(),j=Un();for(let W=m.min;W<m.max;W++){if(!this.prepareEdgePoints(I,o,c,h[W],A))continue;const[Q,K]=I,te=T(gr(j,-(K.coord.y-Q.coord.y),K.coord.x-Q.coord.x,0));x=this.addFeatureSection(h[W].featureInfo.featureIndex,x,this.tunnelFeatureSections,i),i.addQuad(gr(M,Q.coord.x,Q.coord.y,Q.height),gr(k,K.coord.x,K.coord.y,K.height),gr(L,K.coord.x,K.coord.y,h[W].isTunnel?-.1:0),gr(V,Q.coord.x,Q.coord.y,h[W].isTunnel?-.1:0),te)}for(let W=g.min;W<g.max;W++){const Q=h[W];Q.isTunnel&&([Q.a,Q.b]=[Q.b,Q.a]);const K=o[Q.a],te=o[Q.b],me=T(gr(j,-(te.y-K.y),te.x-K.x,0));x=this.addFeatureSection(Q.featureInfo.featureIndex,x,this.tunnelFeatureSections,i),i.addQuad(gr(M,te.x,te.y,0),gr(k,K.x,K.y,0),gr(L,K.x,K.y,c[Q.a]+4),gr(V,te.x,te.y,c[Q.b]+4),me),i.addQuad(gr(M,K.x,K.y,0),gr(k,te.x,te.y,0),gr(L,te.x,te.y,c[Q.b]+4),gr(V,K.x,K.y,c[Q.a]+4),me)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:i.getVertexCount()})}setElevatedPoint(i,o,c,h){i.coord.x=o,i.coord.y=c,i.height=h}prepareEdgePoints(i,o,c,h,m){let g=o[h.a].x,x=o[h.a].y,w=o[h.b].x,T=o[h.b].y,I=c[h.a],A=c[h.b];const M=m(I,0),k=m(A,0);if(M&&k)return this.setElevatedPoint(i[0],g,x,I),this.setElevatedPoint(i[1],w,T,A),!0;if(!M&&!k)return!1;if(M){if(!k){const L=A/(A-I);w=Nt(w,g,L),T=Nt(T,x,L),A=Nt(A,I,L)}}else{const L=I/(I-A);g=Nt(g,w,L),x=Nt(x,T,L),I=Nt(I,A,L)}return this.setElevatedPoint(i[0],g,x,I),this.setElevatedPoint(i[1],w,T,A),!0}prepareEdges(i,o){if(0===o.length)return;o.sort((x,w)=>x.hash===w.hash?w.polygonIdx-x.polygonIdx:w.hash>x.hash?1:-1);let c=0,h=0,m=0,g=o[c].polygonIdx;do{h++,(h===o.length||o[c].hash!==o[h].hash)&&((h-c==1||o[h-1].polygonIdx!==g)&&(m<c&&(o[m]=o[c],o[c]=null),o[m].type="none",m++),c=h,c!==o.length&&(g=o[c].polygonIdx))}while(c!==o.length);if(o.splice(m),0!==o.length&&0!==i.length){o.sort((T,I)=>T.portalHash<I.portalHash?1:-1);let x=0,w=0;for(;x!==o.length&&w!==i.length;){const T=o[x],I=i[w];T.portalHash>I.hash?x++:I.hash>T.portalHash?w++:(T.type=I.type,x++)}}}isOnBorder(i,o){return i<=0&&o<=0||i>=ht&&o>=ht}addFeatureSection(i,o,c,h){return i!==o&&(o=i,c.push({featureIndex:i,vertexStart:h.getVertexCount()}),h.clearVertexLookup()),o}sortSubarray(i,o,c,h){const m=i.slice(o,c);m.sort(h),i.splice(o,m.length,...m)}static computeEdgeHash(i,o){return(i.y===o.y&&i.x>o.x||i.y>o.y)&&([i,o]=[o,i]),BigInt(As.computePosHash(i))<<32n|BigInt(As.computePosHash(o))}static computePosHash(i){return((65535&i.x)<<16|65535&i.y)>>>0}}var qm,F_={exports:{}},Oh=(qm||(qm=1,function(o){function c(ie,re){return ie>re?1:ie<re?-1:0}var h=function(ie,re){void 0===ie&&(ie=c),void 0===re&&(re=!1),this._compare=ie,this._root=null,this._size=0,this._noDuplicates=!!re},m={size:{configurable:!0}};function g(ie,re,Le,lt,ut){var pt=ut-lt;if(pt>0){var Ct=lt+Math.floor(pt/2),Ht={key:re[Ct],data:Le[Ct],parent:ie};return Ht.left=g(Ht,re,Le,lt,Ct),Ht.right=g(Ht,re,Le,Ct+1,ut),Ht}return null}function x(ie,re,Le,lt,ut){if(!(Le>=lt)){for(var pt=ie[Le+lt>>1],Ct=Le-1,Ht=lt+1;;){do{Ct++}while(ut(ie[Ct],pt)<0);do{Ht--}while(ut(ie[Ht],pt)>0);if(Ct>=Ht)break;var wn=ie[Ct];ie[Ct]=ie[Ht],ie[Ht]=wn,wn=re[Ct],re[Ct]=re[Ht],re[Ht]=wn}x(ie,re,Le,Ht,ut),x(ie,re,Ht+1,lt,ut)}}h.prototype.rotateLeft=function(ie){var re=ie.right;re&&(ie.right=re.left,re.left&&(re.left.parent=ie),re.parent=ie.parent),ie.parent?ie===ie.parent.left?ie.parent.left=re:ie.parent.right=re:this._root=re,re&&(re.left=ie),ie.parent=re},h.prototype.rotateRight=function(ie){var re=ie.left;re&&(ie.left=re.right,re.right&&(re.right.parent=ie),re.parent=ie.parent),ie.parent?ie===ie.parent.left?ie.parent.left=re:ie.parent.right=re:this._root=re,re&&(re.right=ie),ie.parent=re},h.prototype._splay=function(ie){for(;ie.parent;){var re=ie.parent;re.parent?re.left===ie&&re.parent.left===re?(this.rotateRight(re.parent),this.rotateRight(re)):re.right===ie&&re.parent.right===re?(this.rotateLeft(re.parent),this.rotateLeft(re)):re.left===ie&&re.parent.right===re?(this.rotateRight(re),this.rotateLeft(re)):(this.rotateLeft(re),this.rotateRight(re)):re.left===ie?this.rotateRight(re):this.rotateLeft(re)}},h.prototype.splay=function(ie){for(var re,Le,lt,ut,pt;ie.parent;)(Le=(re=ie.parent).parent)&&Le.parent?((lt=Le.parent).left===Le?lt.left=ie:lt.right=ie,ie.parent=lt):(ie.parent=null,this._root=ie),ut=ie.left,pt=ie.right,ie===re.left?(Le&&(Le.left===re?(re.right?(Le.left=re.right,Le.left.parent=Le):Le.left=null,re.right=Le,Le.parent=re):(ut?(Le.right=ut,ut.parent=Le):Le.right=null,ie.left=Le,Le.parent=ie)),pt?(re.left=pt,pt.parent=re):re.left=null,ie.right=re,re.parent=ie):(Le&&(Le.right===re?(re.left?(Le.right=re.left,Le.right.parent=Le):Le.right=null,re.left=Le,Le.parent=re):(pt?(Le.left=pt,pt.parent=Le):Le.left=null,ie.right=Le,Le.parent=ie)),ut?(re.right=ut,ut.parent=re):re.right=null,ie.left=re,re.parent=ie)},h.prototype.replace=function(ie,re){ie.parent?ie===ie.parent.left?ie.parent.left=re:ie.parent.right=re:this._root=re,re&&(re.parent=ie.parent)},h.prototype.minNode=function(ie){if(void 0===ie&&(ie=this._root),ie)for(;ie.left;)ie=ie.left;return ie},h.prototype.maxNode=function(ie){if(void 0===ie&&(ie=this._root),ie)for(;ie.right;)ie=ie.right;return ie},h.prototype.insert=function(ie,re){var Le=this._root,lt=null,ut=this._compare;if(this._noDuplicates)for(;Le;){if(lt=Le,0===ut(Le.key,ie))return;Le=ut(Le.key,ie)<0?Le.right:Le.left}else for(;Le;)lt=Le,Le=ut(Le.key,ie)<0?Le.right:Le.left;return Le={key:ie,data:re,left:null,right:null,parent:lt},lt?ut(lt.key,Le.key)<0?lt.right=Le:lt.left=Le:this._root=Le,this.splay(Le),this._size++,Le},h.prototype.find=function(ie){for(var re=this._root,Le=this._compare;re;){var lt=Le(re.key,ie);if(lt<0)re=re.right;else{if(!(lt>0))return re;re=re.left}}return null},h.prototype.contains=function(ie){for(var re=this._root,Le=this._compare;re;){var lt=Le(ie,re.key);if(0===lt)return!0;re=lt<0?re.left:re.right}return!1},h.prototype.remove=function(ie){var re=this.find(ie);if(!re)return!1;if(this.splay(re),re.left)if(re.right){var Le=this.minNode(re.right);Le.parent!==re&&(this.replace(Le,Le.right),Le.right=re.right,Le.right.parent=Le),this.replace(re,Le),Le.left=re.left,Le.left.parent=Le}else this.replace(re,re.left);else this.replace(re,re.right);return this._size--,!0},h.prototype.removeNode=function(ie){if(!ie)return!1;if(this.splay(ie),ie.left)if(ie.right){var re=this.minNode(ie.right);re.parent!==ie&&(this.replace(re,re.right),re.right=ie.right,re.right.parent=re),this.replace(ie,re),re.left=ie.left,re.left.parent=re}else this.replace(ie,ie.left);else this.replace(ie,ie.right);return this._size--,!0},h.prototype.erase=function(ie){var re=this.find(ie);if(re){this.splay(re);var Le=re.left,lt=re.right,ut=null;Le&&(Le.parent=null,ut=this.maxNode(Le),this.splay(ut),this._root=ut),lt&&(Le?ut.right=lt:this._root=lt,lt.parent=ut),this._size--}},h.prototype.pop=function(){var ie=this._root,re=null;if(ie){for(;ie.left;)ie=ie.left;re={key:ie.key,data:ie.data},this.remove(ie.key)}return re},h.prototype.next=function(ie){var re=ie;if(re)if(re.right)for(re=re.right;re&&re.left;)re=re.left;else for(re=ie.parent;re&&re.right===ie;)ie=re,re=re.parent;return re},h.prototype.prev=function(ie){var re=ie;if(re)if(re.left)for(re=re.left;re&&re.right;)re=re.right;else for(re=ie.parent;re&&re.left===ie;)ie=re,re=re.parent;return re},h.prototype.forEach=function(ie){for(var re=this._root,Le=[],lt=!1,ut=0;!lt;)re?(Le.push(re),re=re.left):Le.length>0?(ie(re=Le.pop(),ut++),re=re.right):lt=!0;return this},h.prototype.range=function(ie,re,Le,lt){for(var ut=[],pt=this._compare,Ct=this._root;0!==ut.length||Ct;)if(Ct)ut.push(Ct),Ct=Ct.left;else{if(pt((Ct=ut.pop()).key,re)>0)break;if(pt(Ct.key,ie)>=0&&Le.call(lt,Ct))return this;Ct=Ct.right}return this},h.prototype.keys=function(){for(var ie=this._root,re=[],Le=[],lt=!1;!lt;)ie?(re.push(ie),ie=ie.left):re.length>0?(ie=re.pop(),Le.push(ie.key),ie=ie.right):lt=!0;return Le},h.prototype.values=function(){for(var ie=this._root,re=[],Le=[],lt=!1;!lt;)ie?(re.push(ie),ie=ie.left):re.length>0?(ie=re.pop(),Le.push(ie.data),ie=ie.right):lt=!0;return Le},h.prototype.at=function(ie){for(var re=this._root,Le=[],lt=!1,ut=0;!lt;)if(re)Le.push(re),re=re.left;else if(Le.length>0){if(re=Le.pop(),ut===ie)return re;ut++,re=re.right}else lt=!0;return null},h.prototype.load=function(ie,re,Le){if(void 0===ie&&(ie=[]),void 0===re&&(re=[]),void 0===Le&&(Le=!1),0!==this._size)throw new Error("bulk-load: tree is not empty");var lt=ie.length;return Le&&x(ie,re,0,lt-1,this._compare),this._root=g(null,ie,re,0,lt),this._size=lt,this},h.prototype.min=function(){var ie=this.minNode(this._root);return ie?ie.key:null},h.prototype.max=function(){var ie=this.maxNode(this._root);return ie?ie.key:null},h.prototype.isEmpty=function(){return null===this._root},m.size.get=function(){return this._size},h.createTree=function(ie,re,Le,lt,ut){return new h(Le,ut).load(ie,re,lt)},Object.defineProperties(h.prototype,m);var w=0,T=1,I=2,A=3,M=0,k=1,L=2,V=3;function j(ie,re,Le){null===re?(ie.inOut=!1,ie.otherInOut=!0):(ie.isSubject===re.isSubject?(ie.inOut=!re.inOut,ie.otherInOut=re.otherInOut):(ie.inOut=!re.otherInOut,ie.otherInOut=re.isVertical()?!re.inOut:re.inOut),re&&(ie.prevInResult=!W(re,Le)||re.isVertical()?re.prevInResult:re));var lt=W(ie,Le);ie.resultTransition=lt?function(ut,pt){var Ct,Ht=!ut.inOut,wn=!ut.otherInOut;switch(pt){case M:Ct=Ht&&wn;break;case k:Ct=Ht||wn;break;case V:Ct=Ht^wn;break;case L:Ct=ut.isSubject?Ht&&!wn:wn&&!Ht}return Ct?1:-1}(ie,Le):0}function W(ie,re){switch(ie.type){case w:switch(re){case M:return!ie.otherInOut;case k:return ie.otherInOut;case L:return ie.isSubject&&ie.otherInOut||!ie.isSubject&&!ie.otherInOut;case V:return!0}break;case I:return re===M||re===k;case A:return re===L;case T:return!1}return!1}var Q=function(ie,re,Le,lt,ut){this.left=re,this.point=ie,this.otherEvent=Le,this.isSubject=lt,this.type=ut||w,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},K={inResult:{configurable:!0}};function te(ie,re){return ie[0]===re[0]&&ie[1]===re[1]}Q.prototype.isBelow=function(ie){var re=this.point,Le=this.otherEvent.point;return this.left?(re[0]-ie[0])*(Le[1]-ie[1])-(Le[0]-ie[0])*(re[1]-ie[1])>0:(Le[0]-ie[0])*(re[1]-ie[1])-(re[0]-ie[0])*(Le[1]-ie[1])>0},Q.prototype.isAbove=function(ie){return!this.isBelow(ie)},Q.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},K.inResult.get=function(){return 0!==this.resultTransition},Q.prototype.clone=function(){var ie=new Q(this.point,this.left,this.otherEvent,this.isSubject,this.type);return ie.contourId=this.contourId,ie.resultTransition=this.resultTransition,ie.prevInResult=this.prevInResult,ie.isExteriorRing=this.isExteriorRing,ie.inOut=this.inOut,ie.otherInOut=this.otherInOut,ie},Object.defineProperties(Q.prototype,K);var me=11102230246251565e-32,he=134217729,fe=(3+8*me)*me;function xe(ie,re,Le,lt,ut){var pt,Ct,Ht,wn,Gt=re[0],hn=lt[0],ai=0,Xi=0;hn>Gt==hn>-Gt?(pt=Gt,Gt=re[++ai]):(pt=hn,hn=lt[++Xi]);var tn=0;if(ai<ie&&Xi<Le)for(hn>Gt==hn>-Gt?(Ht=pt-((Ct=Gt+pt)-Gt),Gt=re[++ai]):(Ht=pt-((Ct=hn+pt)-hn),hn=lt[++Xi]),pt=Ct,0!==Ht&&(ut[tn++]=Ht);ai<ie&&Xi<Le;)hn>Gt==hn>-Gt?(Ht=pt-((Ct=pt+Gt)-(wn=Ct-pt))+(Gt-wn),Gt=re[++ai]):(Ht=pt-((Ct=pt+hn)-(wn=Ct-pt))+(hn-wn),hn=lt[++Xi]),pt=Ct,0!==Ht&&(ut[tn++]=Ht);for(;ai<ie;)Ht=pt-((Ct=pt+Gt)-(wn=Ct-pt))+(Gt-wn),Gt=re[++ai],pt=Ct,0!==Ht&&(ut[tn++]=Ht);for(;Xi<Le;)Ht=pt-((Ct=pt+hn)-(wn=Ct-pt))+(hn-wn),hn=lt[++Xi],pt=Ct,0!==Ht&&(ut[tn++]=Ht);return 0===pt&&0!==tn||(ut[tn++]=pt),tn}function Ee(ie){return new Float64Array(ie)}var Ve=33306690738754716e-32,Ce=22204460492503146e-32,Ue=11093356479670487e-47,ot=Ee(4),$e=Ee(8),Ke=Ee(12),nt=Ee(16),ze=Ee(4);function Qe(ie,re,Le){var lt=function(ut,pt,Ct,Ht,wn,Gt){var hn=(pt-Gt)*(Ct-wn),ai=(ut-wn)*(Ht-Gt),Xi=hn-ai;if(0===hn||0===ai||hn>0!=ai>0)return Xi;var tn=Math.abs(hn+ai);return Math.abs(Xi)>=Ve*tn?Xi:-function(Ri,li,jn,Zn,Oi,fi,_i){var ri,ln,oi,Bi,Ut,An,Ai,Ji,pi,kr,hi,Rr,zo,po,no,_s,vc,pr,Dr=Ri-Oi,Io=jn-Oi,Ko=li-fi,Bo=Zn-fi;ot[0]=(no=(Ji=Dr-(Ai=(An=he*Dr)-(An-Dr)))*(kr=Bo-(pi=(An=he*Bo)-(An-Bo)))-((po=Dr*Bo)-Ai*pi-Ji*pi-Ai*kr))-((hi=no-(vc=(Ji=Ko-(Ai=(An=he*Ko)-(An-Ko)))*(kr=Io-(pi=(An=he*Io)-(An-Io)))-((_s=Ko*Io)-Ai*pi-Ji*pi-Ai*kr)))+(Ut=no-hi))+(Ut-vc),ot[1]=(zo=po-((Rr=po+hi)-(Ut=Rr-po))+(hi-Ut))-((hi=zo-_s)+(Ut=zo-hi))+(Ut-_s),ot[2]=Rr-((pr=Rr+hi)-(Ut=pr-Rr))+(hi-Ut),ot[3]=pr;var bu=function(zC,n1){for(var qT=n1[0],r1=1;r1<4;r1++)qT+=n1[r1];return qT}(0,ot),Rp=Ce*_i;if(bu>=Rp||-bu>=Rp||(ri=Ri-(Dr+(Ut=Ri-Dr))+(Ut-Oi),oi=jn-(Io+(Ut=jn-Io))+(Ut-Oi),ln=li-(Ko+(Ut=li-Ko))+(Ut-fi),Bi=Zn-(Bo+(Ut=Zn-Bo))+(Ut-fi),0===ri&&0===ln&&0===oi&&0===Bi)||(Rp=Ue*_i+fe*Math.abs(bu),(bu+=Dr*Bi+Bo*ri-(Ko*oi+Io*ln))>=Rp||-bu>=Rp))return bu;ze[0]=(no=(Ji=ri-(Ai=(An=he*ri)-(An-ri)))*(kr=Bo-(pi=(An=he*Bo)-(An-Bo)))-((po=ri*Bo)-Ai*pi-Ji*pi-Ai*kr))-((hi=no-(vc=(Ji=ln-(Ai=(An=he*ln)-(An-ln)))*(kr=Io-(pi=(An=he*Io)-(An-Io)))-((_s=ln*Io)-Ai*pi-Ji*pi-Ai*kr)))+(Ut=no-hi))+(Ut-vc),ze[1]=(zo=po-((Rr=po+hi)-(Ut=Rr-po))+(hi-Ut))-((hi=zo-_s)+(Ut=zo-hi))+(Ut-_s),ze[2]=Rr-((pr=Rr+hi)-(Ut=pr-Rr))+(hi-Ut),ze[3]=pr;var e1=xe(4,ot,4,ze,$e);ze[0]=(no=(Ji=Dr-(Ai=(An=he*Dr)-(An-Dr)))*(kr=Bi-(pi=(An=he*Bi)-(An-Bi)))-((po=Dr*Bi)-Ai*pi-Ji*pi-Ai*kr))-((hi=no-(vc=(Ji=Ko-(Ai=(An=he*Ko)-(An-Ko)))*(kr=oi-(pi=(An=he*oi)-(An-oi)))-((_s=Ko*oi)-Ai*pi-Ji*pi-Ai*kr)))+(Ut=no-hi))+(Ut-vc),ze[1]=(zo=po-((Rr=po+hi)-(Ut=Rr-po))+(hi-Ut))-((hi=zo-_s)+(Ut=zo-hi))+(Ut-_s),ze[2]=Rr-((pr=Rr+hi)-(Ut=pr-Rr))+(hi-Ut),ze[3]=pr;var $T=xe(e1,$e,4,ze,Ke);ze[0]=(no=(Ji=ri-(Ai=(An=he*ri)-(An-ri)))*(kr=Bi-(pi=(An=he*Bi)-(An-Bi)))-((po=ri*Bi)-Ai*pi-Ji*pi-Ai*kr))-((hi=no-(vc=(Ji=ln-(Ai=(An=he*ln)-(An-ln)))*(kr=oi-(pi=(An=he*oi)-(An-oi)))-((_s=ln*oi)-Ai*pi-Ji*pi-Ai*kr)))+(Ut=no-hi))+(Ut-vc),ze[1]=(zo=po-((Rr=po+hi)-(Ut=Rr-po))+(hi-Ut))-((hi=zo-_s)+(Ut=zo-hi))+(Ut-_s),ze[2]=Rr-((pr=Rr+hi)-(Ut=pr-Rr))+(hi-Ut),ze[3]=pr;var t1=xe($T,Ke,4,ze,nt);return nt[t1-1]}(ut,pt,Ct,Ht,wn,Gt,tn)}(ie[0],ie[1],re[0],re[1],Le[0],Le[1]);return lt>0?-1:lt<0?1:0}function Ae(ie,re){var ut,pt,Le=ie.point,lt=re.point;return Le[0]>lt[0]?1:Le[0]<lt[0]?-1:Le[1]!==lt[1]?Le[1]>lt[1]?1:-1:(ut=ie).left!==(pt=re).left?ut.left?1:-1:0!==Qe(Le,ut.otherEvent.point,pt.otherEvent.point)?ut.isBelow(pt.otherEvent.point)?-1:1:!ut.isSubject&&pt.isSubject?1:-1}function Be(ie,re,Le){var lt=new Q(re,!1,ie,ie.isSubject),ut=new Q(re,!0,ie.otherEvent,ie.isSubject);return te(ie.point,ie.otherEvent.point)&&console.warn("what is that, a collapsed segment?",ie),lt.contourId=ut.contourId=ie.contourId,Ae(ut,ie.otherEvent)>0&&(ie.otherEvent.left=!0,ut.left=!1),ie.otherEvent.otherEvent=ut,ie.otherEvent=lt,Le.push(ut),Le.push(lt),Le}function at(ie,re){return ie[0]*re[1]-ie[1]*re[0]}function et(ie,re){return ie[0]*re[0]+ie[1]*re[1]}function Ft(ie,re,Le){var lt=function(wn,Gt,hn,ai,Xi){var tn=[Gt[0]-wn[0],Gt[1]-wn[1]],Ri=[ai[0]-hn[0],ai[1]-hn[1]];function li(An,Ai,Ji){return[An[0]+Ai*Ji[0],An[1]+Ai*Ji[1]]}var jn=[hn[0]-wn[0],hn[1]-wn[1]],Zn=at(tn,Ri),Oi=Zn*Zn,fi=et(tn,tn);if(Oi>0){var _i=at(jn,Ri)/Zn;if(_i<0||_i>1)return null;var ri=at(jn,tn)/Zn;return ri<0||ri>1?null:0===_i||1===_i?[li(wn,_i,tn)]:0===ri||1===ri?[li(hn,ri,Ri)]:[li(wn,_i,tn)]}if((Oi=(Zn=at(jn,tn))*Zn)>0)return null;var ln=et(tn,jn)/fi,oi=ln+et(tn,Ri)/fi,Bi=Math.min(ln,oi),Ut=Math.max(ln,oi);return Bi<=1&&Ut>=0?1===Bi?[li(wn,Bi>0?Bi:0,tn)]:0===Ut?[li(wn,Ut<1?Ut:1,tn)]:[li(wn,Bi>0?Bi:0,tn),li(wn,Ut<1?Ut:1,tn)]:null}(ie.point,ie.otherEvent.point,re.point,re.otherEvent.point),ut=lt?lt.length:0;if(0===ut||1===ut&&(te(ie.point,re.point)||te(ie.otherEvent.point,re.otherEvent.point))||2===ut&&ie.isSubject===re.isSubject)return 0;if(1===ut)return te(ie.point,lt[0])||te(ie.otherEvent.point,lt[0])||Be(ie,lt[0],Le),te(re.point,lt[0])||te(re.otherEvent.point,lt[0])||Be(re,lt[0],Le),1;var pt=[],Ct=!1,Ht=!1;return te(ie.point,re.point)?Ct=!0:1===Ae(ie,re)?pt.push(re,ie):pt.push(ie,re),te(ie.otherEvent.point,re.otherEvent.point)?Ht=!0:1===Ae(ie.otherEvent,re.otherEvent)?pt.push(re.otherEvent,ie.otherEvent):pt.push(ie.otherEvent,re.otherEvent),Ct&&Ht||Ct?(re.type=T,ie.type=re.inOut===ie.inOut?I:A,Ct&&!Ht&&Be(pt[1].otherEvent,pt[0].point,Le),2):Ht?(Be(pt[0],pt[1].point,Le),3):pt[0]!==pt[3].otherEvent?(Be(pt[0],pt[1].point,Le),Be(pt[1],pt[2].point,Le),3):(Be(pt[0],pt[1].point,Le),Be(pt[3].otherEvent,pt[2].point,Le),3)}function St(ie,re){if(ie===re)return 0;if(0!==Qe(ie.point,ie.otherEvent.point,re.point)||0!==Qe(ie.point,ie.otherEvent.point,re.otherEvent.point))return te(ie.point,re.point)?ie.isBelow(re.otherEvent.point)?-1:1:ie.point[0]===re.point[0]?ie.point[1]<re.point[1]?-1:1:1===Ae(ie,re)?re.isAbove(ie.point)?-1:1:ie.isBelow(re.point)?-1:1;if(ie.isSubject!==re.isSubject)return ie.isSubject?-1:1;var Le=ie.point,lt=re.point;return Le[0]===lt[0]&&Le[1]===lt[1]?(Le=ie.otherEvent.point)[0]===(lt=re.otherEvent.point)[0]&&Le[1]===lt[1]?0:ie.contourId>re.contourId?1:-1:1===Ae(ie,re)?1:-1}var Xe=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function tt(ie,re,Le,lt){var ut,pt=ie+1,Ct=re[ie].point,Ht=re.length;for(pt<Ht&&(ut=re[pt].point);pt<Ht&&ut[0]===Ct[0]&&ut[1]===Ct[1];){if(!Le[pt])return pt;++pt<Ht&&(ut=re[pt].point)}for(pt=ie-1;Le[pt]&&pt>lt;)pt--;return pt}Xe.prototype.isExterior=function(){return null==this.holeOf};var It=ft,yt=ft;function ft(ie,re){if(!(this instanceof ft))return new ft(ie,re);if(this.data=ie||[],this.length=this.data.length,this.compare=re||xt,this.length>0)for(var Le=(this.length>>1)-1;Le>=0;Le--)this._down(Le)}function xt(ie,re){return ie<re?-1:ie>re?1:0}ft.prototype={push:function(ie){this.data.push(ie),this.length++,this._up(this.length-1)},pop:function(){if(0!==this.length){var ie=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),ie}},peek:function(){return this.data[0]},_up:function(ie){for(var re=this.data,Le=this.compare,lt=re[ie];ie>0;){var ut=ie-1>>1,pt=re[ut];if(Le(lt,pt)>=0)break;re[ie]=pt,ie=ut}re[ie]=lt},_down:function(ie){for(var re=this.data,Le=this.compare,lt=this.length>>1,ut=re[ie];ie<lt;){var pt=1+(ie<<1),Ct=pt+1,Ht=re[pt];if(Ct<this.length&&Le(re[Ct],Ht)<0&&(pt=Ct,Ht=re[Ct]),Le(Ht,ut)>=0)break;re[ie]=Ht,ie=pt}re[ie]=ut}},It.default=yt;var zt=Math.max,qt=Math.min,rn=0;function Kt(ie,re,Le,lt,ut,pt){var Ct,Ht,wn,Gt,hn,ai;for(Ct=0,Ht=ie.length-1;Ct<Ht;Ct++)if(Gt=ie[Ct+1],hn=new Q(wn=ie[Ct],!1,void 0,re),ai=new Q(Gt,!1,hn,re),hn.otherEvent=ai,wn[0]!==Gt[0]||wn[1]!==Gt[1]){hn.contourId=ai.contourId=Le,pt||(hn.isExteriorRing=!1,ai.isExteriorRing=!1),Ae(hn,ai)>0?ai.left=!0:hn.left=!0;var Xi=wn[0],tn=wn[1];ut[0]=qt(ut[0],Xi),ut[1]=qt(ut[1],tn),ut[2]=zt(ut[2],Xi),ut[3]=zt(ut[3],tn),lt.push(hn),lt.push(ai)}}var vn=[];function dn(ie,re,Le){"number"==typeof ie[0][0][0]&&(ie=[ie]),"number"==typeof re[0][0][0]&&(re=[re]);var tn,Ri,li,jn,lt=(li=Le,jn=null,(tn=ie).length*(Ri=re).length==0&&(li===M?jn=vn:li===L?jn=tn:li!==k&&li!==V||(jn=0===tn.length?Ri:tn)),jn);if(lt)return lt===vn?null:lt;var ut=[1/0,1/0,-1/0,-1/0],pt=[1/0,1/0,-1/0,-1/0],Ct=function(tn,Ri,li,jn,Zn){var Oi,fi,_i,ri,ln,oi,Bi=new It(null,Ae);for(_i=0,ri=tn.length;_i<ri;_i++)for(ln=0,oi=(Oi=tn[_i]).length;ln<oi;ln++)(fi=0===ln)&&rn++,Kt(Oi[ln],!0,rn,Bi,li,fi);for(_i=0,ri=Ri.length;_i<ri;_i++)for(ln=0,oi=(Oi=Ri[_i]).length;ln<oi;ln++)fi=0===ln,Zn===L&&(fi=!1),fi&&rn++,Kt(Oi[ln],!1,rn,Bi,jn,fi);return Bi}(ie,re,ut,pt,Le);if(lt=function(tn,Ri,li,jn,Zn){var Oi=null;return(li[0]>jn[2]||jn[0]>li[2]||li[1]>jn[3]||jn[1]>li[3])&&(Zn===M?Oi=vn:Zn===L?Oi=tn:Zn!==k&&Zn!==V||(Oi=tn.concat(Ri))),Oi}(ie,re,ut,pt,Le))return lt===vn?null:lt;for(var Ht=function(tn){var Ri,li,jn=function(_i){var ri,ln,oi,Bi,Ut=[];for(ln=0,oi=_i.length;ln<oi;ln++)((ri=_i[ln]).left&&ri.inResult||!ri.left&&ri.otherEvent.inResult)&&Ut.push(ri);for(var An=!1;!An;)for(An=!0,ln=0,oi=Ut.length;ln<oi;ln++)ln+1<oi&&1===Ae(Ut[ln],Ut[ln+1])&&(Bi=Ut[ln],Ut[ln]=Ut[ln+1],Ut[ln+1]=Bi,An=!1);for(ln=0,oi=Ut.length;ln<oi;ln++)(ri=Ut[ln]).otherPos=ln;for(ln=0,oi=Ut.length;ln<oi;ln++)(ri=Ut[ln]).left||(Bi=ri.otherPos,ri.otherPos=ri.otherEvent.otherPos,ri.otherEvent.otherPos=Bi);return Ut}(tn),Zn={},Oi=[],fi=function(){if(!Zn[Ri]){var _i=Oi.length,ri=function(Ut,An,Ai){var Ji=new Xe;if(null!=Ut.prevInResult){var pi=Ut.prevInResult,kr=pi.outputContourId;if(pi.resultTransition>0){var hi=An[kr];if(null!=hi.holeOf){var Rr=hi.holeOf;An[Rr].holeIds.push(Ai),Ji.holeOf=Rr,Ji.depth=An[kr].depth}else An[kr].holeIds.push(Ai),Ji.holeOf=kr,Ji.depth=An[kr].depth+1}else Ji.holeOf=null,Ji.depth=An[kr].depth}else Ji.holeOf=null,Ji.depth=0;return Ji}(jn[Ri],Oi,_i),ln=function(Ut){Zn[Ut]=!0,Ut<jn.length&&jn[Ut]&&(jn[Ut].outputContourId=_i)},oi=Ri,Bi=Ri;for(ri.points.push(jn[Ri].point);ln(oi),ln(oi=jn[oi].otherPos),ri.points.push(jn[oi].point),!((oi=tt(oi,jn,Zn,Bi))==Bi||oi>=jn.length)&&jn[oi];);Oi.push(ri)}};for(Ri=0,li=jn.length;Ri<li;Ri++)fi();return Oi}(function(tn,Ri,li,jn,Zn,Oi){for(var fi,_i,ri,ln=new h(St),oi=[],Bi=Math.min(jn[2],Zn[2]);0!==tn.length;){var Ut=tn.pop();if(oi.push(Ut),Oi===M&&Ut.point[0]>Bi||Oi===L&&Ut.point[0]>jn[2])break;if(Ut.left){_i=fi=ln.insert(Ut),fi=fi!==(ri=ln.minNode())?ln.prev(fi):null,_i=ln.next(_i);var An=fi?fi.key:null;if(j(Ut,An,Oi),_i&&2===Ft(Ut,_i.key,tn)&&(j(Ut,An,Oi),j(_i.key,Ut,Oi)),fi&&2===Ft(fi.key,Ut,tn)){var Ai=fi;j(An,(Ai=Ai!==ri?ln.prev(Ai):null)?Ai.key:null,Oi),j(Ut,An,Oi)}}else _i=fi=ln.find(Ut=Ut.otherEvent),fi&&_i&&(fi=fi!==ri?ln.prev(fi):null,_i=ln.next(_i),ln.remove(Ut),_i&&fi&&Ft(fi.key,_i.key,tn))}return oi}(Ct,0,0,ut,pt,Le)),wn=[],Gt=0;Gt<Ht.length;Gt++){var hn=Ht[Gt];if(hn.isExterior()){for(var ai=[hn.points],Xi=0;Xi<hn.holeIds.length;Xi++)ai.push(Ht[hn.holeIds[Xi]].points);wn.push(ai)}}return wn}var ii={UNION:k,DIFFERENCE:L,INTERSECTION:M,XOR:V};o.diff=function(ie,re){return dn(ie,re,L)},o.intersection=function(ie,re){return dn(ie,re,M)},o.operations=ii,o.union=function(ie,re){return dn(ie,re,k)},o.xor=function(ie,re){return dn(ie,re,V)},Object.defineProperty(o,"__esModule",{value:!0})}(F_.exports)),F_.exports);function k_(a,i,o,c){const h=[],m=0===c?(g,x,w,T,I,A)=>{g.push(new Je(A,w+(A-x)/(T-x)*(I-w)))}:(g,x,w,T,I,A)=>{g.push(new Je(x+(A-w)/(I-w)*(T-x),A))};for(const g of a){const x=[];for(const w of g){if(w.length<=2)continue;const T=[];for(let M=0;M<w.length-1;M++){const k=w[M].x,L=w[M].y,V=w[M+1].x,j=w[M+1].y,W=0===c?k:L,Q=0===c?V:j;W<i?Q>i&&m(T,k,L,V,j,i):W>o?Q<o&&m(T,k,L,V,j,o):T.push(w[M]),Q<i&&W>=i&&m(T,k,L,V,j,i),Q>o&&W<=o&&m(T,k,L,V,j,o)}let I=w[w.length-1];const A=0===c?I.x:I.y;A>=i&&A<=o&&T.push(I),T.length&&(I=T[T.length-1],T[0].x===I.x&&T[0].y===I.y||T.push(T[0]),x.push(T))}x.length&&h.push(x)}return h}function TE(a,i){const o=Wv(a),c=Wv([i]),h=Oh.intersection(o,c);return null==h?[]:L_(h)}function bC(a,i){let c=Wv(a,65536);for(;i.valid();i.next()){const[h,m]=i.get(),g=65536*h.x,x=65536*h.y,w=65536*m.x,T=65536*m.y,I=w-g,A=T-x,M=Math.hypot(I,A),k=Math.trunc(A/M*3),L=-Math.trunc(I/M*3);c=Oh.diff(c,[[[g,x],[w,T],[w+k,T+L],[g+k,x+L],[g,x]]])}return L_(c,1/65536)}function Wv(a,i=1){return[a.map(o=>o.map(c=>[c.x*i,c.y*i]))]}function L_(a,i=1){return a.map(o=>o.map((c,h)=>{const m=c.map(g=>new Je(g[0]*i,g[1]*i).round());return h>0&&m.reverse(),m}))}class Zv{constructor(i,o){this.layoutVertexArray=new Ds,this.indexArray=new Pi,this.lineIndexArray=new va,this.triangleSegments=new Wi,this.lineSegments=new Wi,this.programConfigurations=new Cs(i.layers,{zoom:i.zoom,lut:i.lut}),this.uploaded=!1,o&&(this.elevatedLayoutVertexArray=new ds)}update(i,o,c,h,m,g,x,w){this.programConfigurations.updatePaintArrays(i,o,m,c,h,g,x,w)}isEmpty(){return 0===this.layoutVertexArray.length}needsUpload(){return this.programConfigurations.needsUpload}upload(i){this.uploaded||(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,yE.members),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.lineIndexBuffer=i.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=i.createVertexBuffer(this.elevatedLayoutVertexArray,vE.members))),this.programConfigurations.upload(i),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(i,o,c,h,m,g,x){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,o,c,h,m,g,void 0,x)}}class hd{constructor(i){this.zoom=i.zoom,this.pixelRatio=i.pixelRatio,this.overscaling=i.overscaling,this.layers=i.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=i.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=i.lut,this.bufferData=new Zv(i,!1),this.elevationBufferData=new Zv(i,!0),this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.projection=i.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=i.sourceLayerIndex,this.worldview=i.worldview}updateFootprints(i,o){}populate(i,o,c,h){this.hasPattern=O_("fill",this.layers,this.pixelRatio,o);const m=this.layers[0].layout.get("fill-sort-key"),g=[];for(const{feature:x,id:w,index:T,sourceLayerIndex:I}of i){const A=this.layers[0]._featureFilter.needGeometry,M=Ne(x,A);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),M,c))continue;const k=m?m.evaluate(M,{},c,o.availableImages):void 0,L={id:w,properties:x.properties,type:x.type,sourceLayerIndex:I,index:T,geometry:A?M.geometry:_e(x,c,h),patterns:{},sortKey:k};g.push(L)}m&&g.sort((x,w)=>x.sortKey-w.sortKey);for(const x of g){const{geometry:w,index:T,sourceLayerIndex:I}=x;if(this.hasPattern){const A=qv("fill",this.layers,x,this.zoom,this.pixelRatio,o);this.patternFeatures.push(A)}else this.addFeature(x,w,T,c,{},o.availableImages,o.brightness,o.elevationFeatures);o.featureIndex.insert(i[T].feature,w,T,I,this.index)}}update(i,o,c,h,m,g,x){this.bufferData.update(i,o,c,h,m,g,x,this.worldview),this.elevationBufferData.update(i,o,c,h,m,g,x,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(i,o,c,h,m,g,x,this.worldview)}addFeatures(i,o,c,h,m,g){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,o,c,h,g,i.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(i){this.bufferData.upload(i),this.elevationBufferData.upload(i),this.elevatedStructures&&this.elevatedStructures.upload(i)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(i,o,c,h,m,g=[],x,w){const T=Ph(o,500);"none"!==this.elevationMode?this.addElevatedRoadFeature(i,T,h,c,w):this.addGeometry(T,this.bufferData),this.bufferData.populatePaintArrays(i,c,m,g,h,x,this.worldview),this.elevationBufferData.populatePaintArrays(i,c,m,g,h,x,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(i,o,c,h,m){this.elevatedStructures&&(this.elevatedStructures.construct(i),this.elevatedStructures.populatePaintArrays(o,c,h,m,this.worldview))}addElevatedRoadFeature(i,o,c,h,m){const g=new Array,x=Ni.getElevationFeature(i,m);if(!x)return void this.addGeometry(o,this.bufferData);{const T=this.clipPolygonsToTile(o,1);T.length>0&&g.push({polygons:T,elevationFeature:x,elevationTileID:c})}const w={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(i,{},c),featureIndex:h};for(const T of g)if(T.elevationFeature){if("hd-road-base"===this.elevationMode){this.elevatedStructures||(this.elevatedStructures=new As(T.elevationTileID,this.layers,this.zoom,this.lut));const A=T.elevationFeature.isTunnel();let M=0;i.properties.hasOwnProperty("level")&&(M=+i.properties.level);for(const k of T.polygons)this.elevatedStructures.addPortalCandidates(T.elevationFeature.id,k,A,T.elevationFeature,M)}null==T.elevationFeature.constantHeight&&(T.polygons=this.prepareElevatedPolygons(T.polygons,T.elevationFeature,T.elevationTileID));const I=new Pn(c,T.elevationTileID);this.addElevatedGeometry(T.polygons,I,T.elevationFeature,"hd-road-base"===this.elevationMode?0:.05,h,w)}}addElevatedGeometry(i,o,c,h,m,g){const x={elevation:c,elevationSampler:o,bias:h,index:m,featureInfo:g},[w,T]=this.addGeometry(i,this.elevationBufferData,x);null==this.elevationBufferData.heightRange?this.elevationBufferData.heightRange={min:w,max:T}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,w),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,T))}addGeometry(i,o,c){let h=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,g=null;c&&(g=c.elevationSampler.constantElevation(c.elevation,c.bias),null!=g&&(h=g,m=g));const x=(w,T,I)=>{if(null!=c)if(T.push(w),null!=g)o.elevatedLayoutVertexArray.emplaceBack(g),I.push(g);else{const A=c.elevationSampler.pointElevation(w,c.elevation,c.bias);o.elevatedLayoutVertexArray.emplaceBack(A),I.push(A),h=Math.min(h,A),m=Math.max(m,A)}};for(const w of i){let T=0;for(const K of w)T+=K.length;const I=o.triangleSegments.prepareSegment(T,o.layoutVertexArray,o.indexArray),A=I.vertexLength,M=[],k=[],L=[],V=[],j=[],W=o.layoutVertexArray.length;for(const K of w){if(0===K.length)continue;K!==w[0]&&k.push(M.length/2);const te=o.lineSegments.prepareSegment(K.length,o.layoutVertexArray,o.lineIndexArray),me=te.vertexLength;c&&j.push(o.layoutVertexArray.length-W),x(K[0],L,V),o.layoutVertexArray.emplaceBack(K[0].x,K[0].y),o.lineIndexArray.emplaceBack(me+K.length-1,me),M.push(K[0].x),M.push(K[0].y);for(let he=1;he<K.length;he++)x(K[he],L,V),o.layoutVertexArray.emplaceBack(K[he].x,K[he].y),o.lineIndexArray.emplaceBack(me+he-1,me+he),M.push(K[he].x),M.push(K[he].y);te.vertexLength+=K.length,te.primitiveLength+=K.length}const Q=Sh(M,k);for(let K=0;K<Q.length;K+=3)o.indexArray.emplaceBack(A+Q[K],A+Q[K+1],A+Q[K+2]);if(Q.length>0&&c&&"hd-road-base"===this.elevationMode){const K=c.elevation.isTunnel(),te=c.elevation.safeArea,me=this.elevatedStructures.addVertices(L,V);this.elevatedStructures.addTriangles(Q,me,K);const he=j.length;if(he>0){for(let fe=0;fe<he-1;fe++)this.elevatedStructures.addRenderableRing(c.index,j[fe]+me,j[fe+1]-j[fe],K,te,c.featureInfo);this.elevatedStructures.addRenderableRing(c.index,j[he-1]+me,L.length-j[he-1],K,te,c.featureInfo)}}I.vertexLength+=T,I.primitiveLength+=Q.length/3}return[h,m]}prepareElevatedPolygons(i,o,c){const h=1/ce(c),m=[];for(const g of i){const x=bC(g,new ni(o,h));m.push(...x)}return m}clipPolygonsToTile(i,o){const c=-o,h=-o,m=ht+o,g=ht+o;let x=0;const w=[],T=[];for(;x<i.length;x++){const M=i[x],k=bf(M);(k.min.x>=c&&k.max.x<=m&&k.min.y>=h&&k.max.y<=g?w:T).push(M)}if(w.length===i.length)return i;const I=[new Je(c,h),new Je(m,h),new Je(m,g),new Je(c,g),new Je(c,h)],A=w;for(const M of T)A.push(...TE(M,I));return A}}let Wm,N_,Xv,Yv;Et(hd,"FillBucket",{omit:["layers","patternFeatures"]}),Et(Zv,"FillBufferData"),Et(As,"ElevatedStructures");class Zm{constructor(i,o,c,h){if(this.triangleCount=o.length/3,this.min=new Je(0,0),this.max=new Je(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===i.length)return;const[m,g]=[i[0].clone(),i[0].clone()];for(let A=1;A<i.length;++A){const M=i[A];m.x=Math.min(m.x,M.x),m.y=Math.min(m.y,M.y),g.x=Math.max(g.x,M.x),g.y=Math.max(g.y,M.y)}if(h){const A=Math.ceil(Math.max(g.x-m.x,g.y-m.y)/h);c=Math.max(c,A)}if(0===c)return;this.min=m,this.max=g;const x=this.max.sub(this.min);x.x=Math.max(x.x,1),x.y=Math.max(x.y,1);const w=Math.max(x.x,x.y)/c;this.cellsX=Math.max(1,Math.ceil(x.x/w)),this.cellsY=Math.max(1,Math.ceil(x.y/w)),this.xScale=1/w,this.yScale=1/w;const T=[];for(let A=0;A<this.triangleCount;A++){const M=i[o[3*A+0]].sub(this.min),k=i[o[3*A+1]].sub(this.min),L=i[o[3*A+2]].sub(this.min),V=xl(Math.floor(Math.min(M.x,k.x,L.x)),this.xScale,this.cellsX),j=xl(Math.floor(Math.max(M.x,k.x,L.x)),this.xScale,this.cellsX),W=xl(Math.floor(Math.min(M.y,k.y,L.y)),this.yScale,this.cellsY),Q=xl(Math.floor(Math.max(M.y,k.y,L.y)),this.yScale,this.cellsY),K=new Je(0,0),te=new Je(0,0),me=new Je(0,0),he=new Je(0,0);for(let fe=W;fe<=Q;++fe){K.y=te.y=fe*w,me.y=he.y=(fe+1)*w;for(let xe=V;xe<=j;++xe)K.x=me.x=xe*w,te.x=he.x=(xe+1)*w,(Tr(M,k,L,K,te,he)||Tr(M,k,L,K,he,me))&&T.push({cellIdx:fe*this.cellsX+xe,triIdx:A})}}if(0===T.length)return;T.sort((A,M)=>A.cellIdx-M.cellIdx||A.triIdx-M.triIdx);let I=0;for(;I<T.length;){const A=T[I].cellIdx,M={start:this.payload.length,len:0};for(;I<T.length&&T[I].cellIdx===A;)++M.len,this.payload.push(T[I++].triIdx);this.cells[A]=M}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(i,o){if(0===this.triangleCount||0===this.cells.length||i.x>this.max.x||this.min.x>i.x||i.y>this.max.y||this.min.y>i.y)return;const c=xl(i.x-this.min.x,this.xScale,this.cellsX),h=xl(i.y-this.min.y,this.yScale,this.cellsY),m=this.cells[h*this.cellsX+c];if(m){this._lazyInitLookup();for(let g=0;g<m.len;g++){const x=this.payload[m.start+g],w=Math.floor(x/8),T=1<<x%8;if(!(this.lookup[w]&T)&&(this.lookup[w]|=T,o.push(x),o.length===this.triangleCount))return}}}query(i,o,c){if(0===this.triangleCount||0===this.cells.length||i.x>this.max.x||this.min.x>o.x||i.y>this.max.y||this.min.y>o.y)return;this._lazyInitLookup();const h=xl(i.x-this.min.x,this.xScale,this.cellsX),m=xl(o.x-this.min.x,this.xScale,this.cellsX),g=xl(i.y-this.min.y,this.yScale,this.cellsY),x=xl(o.y-this.min.y,this.yScale,this.cellsY);for(let w=g;w<=x;w++)for(let T=h;T<=m;T++){const I=this.cells[w*this.cellsX+T];if(I)for(let A=0;A<I.len;A++){const M=this.payload[I.start+A],k=Math.floor(M/8),L=1<<M%8;if(!(this.lookup[k]&L)&&(this.lookup[k]|=L,c.push(M),c.length===this.triangleCount))return}}}}function xl(a,i,o){return Math.max(0,Math.min(o-1,Math.floor(a*i)))}Et(Zm,"TriangleGridIndex");class vb{constructor(i){this.zoom=i.zoom,this.layers=i.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=i.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.footprints=[],this.worldview=i.worldview}updateFootprints(i,o){for(const c of this.footprints)o.push({footprint:c,id:i})}populate(i,o,c,h){const m=[];for(const{feature:g,id:x,index:w,sourceLayerIndex:T}of i){const I=this.layers[0]._featureFilter.needGeometry,A=Ne(g,I);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),A,c))continue;const M={id:x,properties:g.properties,type:g.type,sourceLayerIndex:T,index:w,geometry:I?A.geometry:_e(g,c,h),patterns:{}};m.push(M)}for(const g of m){const{geometry:x,index:w,sourceLayerIndex:T}=g;this.addFeature(g,x,w,c,{},o.availableImages,o.brightness),o.featureIndex.insert(i[w].feature,x,w,T,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(i){}update(i,o,c,h,m,g,x){}destroy(){}addFeature(i,o,c,h,m,g=[],x){for(const w of Ph(o,2)){const T=[],I=[],A=[],M=new Je(1/0,1/0),k=new Je(-1/0,-1/0);for(const j of w)if(0!==j.length){j!==w[0]&&A.push(I.length/2);for(let W=0;W<j.length;W++)I.push(j[W].x),I.push(j[W].y),T.push(j[W]),M.x=Math.min(M.x,j[W].x),M.y=Math.min(M.y,j[W].y),k.x=Math.max(k.x,j[W].x),k.y=Math.max(k.y,j[W].y)}const L=Sh(I,A),V=new Zm(T,L,8,256);this.footprints.push({vertices:T,indices:L,grid:V,min:M,max:k})}}}Et(vb,"ClipBucket",{omit:["layers"]});const DE=En([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),SE=En([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),CE=En([{name:"a_centroid_pos",components:2,type:"Uint16"}]),IE=En([{name:"a_join_normal_inside",components:3,type:"Int16"}]),fd=En([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Xm=En([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:AE}=DE,z_=Number.MAX_SAFE_INTEGER,ME=z_-1;function PE(a,i,o,c){return a.order<i||a.order===z_||!(a.clipMask&o)||(h=c,0!==(m=a.clipScope).length&&void 0===m.find(g=>g===h));var h,m}function Kv(a,i){return a.x-i.x||a.y-i.y}function RE(a,i){return 0===Kv(a.min,i.min)&&0===Kv(a.max,i.max)}function B_(a,i){return!(a.min.x>i.max.x||a.max.x<i.min.x||a.min.y>i.max.y||a.max.y<i.min.y)}function V_(a,i){if(a.length!==i.length)return!1;for(let o=0;o<a.length;o++)if(a[o].sourceId!==i[o].sourceId||!RE(a[o],i[o])||a[o].order!==i[o].order||a[o].clipMask!==i[o].clipMask||!Ja(a[o].clipScope,i[o].clipScope))return!1;return!0}function xb(a,i,o){const c=1/ht,h=1/(1<<o.canonical.z),m=(i.x*c+o.canonical.x)*h+o.wrap,g=(i.y*c+o.canonical.y)*h;return{min:new Je((a.x*c+o.canonical.x)*h+o.wrap,(a.y*c+o.canonical.y)*h),max:new Je(m,g)}}function OE(a,i,o){const c=1<<o.canonical.z,h=((i.x-o.wrap)*c-o.canonical.x)*ht,m=(i.y*c-o.canonical.y)*ht;return{min:new Je(((a.x-o.wrap)*c-o.canonical.x)*ht,(a.y*c-o.canonical.y)*ht),max:new Je(h,m)}}function Qv(a,i,o,c,h,m,g){const x=a.indices,w=a.vertices,T=[];for(let I=c;I<c+h;I+=3){const A=i[o[I+0]+m],M=i[o[I+1]+m],k=i[o[I+2]+m],L=Math.min(A.x,M.x,k.x),V=Math.max(A.x,M.x,k.x),j=Math.min(A.y,M.y,k.y),W=Math.max(A.y,M.y,k.y);T.length=0,a.grid.query(new Je(L,j),new Je(V,W),T);for(let Q=0;Q<T.length;Q++){const K=T[Q];if(Tr(w[x[3*K+0]],w[x[3*K+1]],w[x[3*K+2]],A,M,k,g))return!0}}return!1}function j_(a,i,o,c){if(!a||!o)return!1;let h=a.vertices;if(!i.canonical.equals(c.canonical)||i.wrap!==c.wrap){if(o.vertices.length<a.vertices.length)return j_(o,c,a,i);const m=i.canonical,g=c.canonical,x=Math.pow(2,g.z-m.z);h=a.vertices.map(w=>new Je((w.x+m.x*ht)*x-g.x*ht,(w.y+m.y*ht)*x-g.y*ht))}return Qv(o,h,a.indices,0,a.indices.length,0,0)}function fc(a,i,o,c){const h=Math.pow(2,c.z-o.z);return new Je((a+o.x*ht)*h-c.x*ht,(i+o.y*ht)*h-c.y*ht)}function Fh(a,i){const o=[];i.grid.queryPoint(a,o);const c=i.indices,h=i.vertices;for(let m=0;m<o.length;m++){const g=o[m];if(Co([h[c[3*g+0]],h[c[3*g+1]],h[c[3*g+2]]],a))return!0}return!1}const U_=[new Je(0,0),new Je(ht,0),new Je(ht,ht),new Je(0,ht)];function Jv(a,i){const o=[];let c=[];if(!i||a.length<2)return[a];if(2===a.length)return rr(a[0],a[1],U_)?[a]:[];for(let h=0;h<a.length+2;h++){const m=a[h%a.length],g=a[(h+1)%a.length],x=rr(0===h?a[a.length-1]:a[(h-1)%a.length],m,U_),w=rr(m,g,U_),T=x||w;T&&c.push(m),T&&w||c.length>0&&(c.length>1&&o.push(c),c=[])}return c.length>1&&o.push(c),o}const H_=Re.types,wC=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],EC=["fill-extrusion-flood-light-ground-radius"],TC=Math.pow(2,13),e0=Math.pow(2,15)-1,G_=new Je(0,1),kh=2147483648;function $_(a,i,o,c,h,m,g,x){a.emplaceBack((i<<1)+g,(o<<1)+m,(Math.floor(c*TC)<<1)+h,Math.round(x))}function Qf(a,i,o){a.emplaceBack(i.x*ht,i.y*ht,o?1:0)}function q_(a,i,o,c,h,m){a.emplaceBack(i.x,i.y,(o.x<<1)+c,(o.y<<1)+h,m)}function Ym(a,i,o){a.emplaceBack(i.x,i.y,i.z,16384*o[0],16384*o[1],16384*o[2])}class bb{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class wb{constructor(){this.centroidXY=new Je(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Je(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Je(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Je(this.max.x-this.min.x,this.max.y-this.min.y)}}class t0{constructor(){this.acc=new Je(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(i,o){i.min.x===Number.MAX_VALUE&&(i.min.x=i.max.x=o.x,i.min.y=i.max.y=o.y)}appendEdge(i,o,c){this.accCount++,this.acc._add(o);let h=!!this.borders;o.x<i.min.x?(i.min.x=o.x,h=!0):o.x>i.max.x&&(i.max.x=o.x,h=!0),o.y<i.min.y?(i.min.y=o.y,h=!0):o.y>i.max.y&&(i.max.y=o.y,h=!0),((0===o.x||o.x===ht)&&o.x===c.x)!=((0===o.y||o.y===ht)&&o.y===c.y)&&this.processBorderOverlap(o,c),h&&this.checkBorderIntersection(o,c)}checkBorderIntersection(i,o){o.x<0!=i.x<0&&this.addBorderIntersection(0,Nt(o.y,i.y,(0-o.x)/(i.x-o.x))),o.x>ht!=i.x>ht&&this.addBorderIntersection(1,Nt(o.y,i.y,(ht-o.x)/(i.x-o.x))),o.y<0!=i.y<0&&this.addBorderIntersection(2,Nt(o.x,i.x,(0-o.y)/(i.y-o.y))),o.y>ht!=i.y>ht&&this.addBorderIntersection(3,Nt(o.x,i.x,(ht-o.y)/(i.y-o.y)))}addBorderIntersection(i,o){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const c=this.borders[i];o<c[0]&&(c[0]=o),o>c[1]&&(c[1]=o)}processBorderOverlap(i,o){if(i.x===o.x){if(i.y===o.y)return;const c=0===i.x?0:1;this.addBorderIntersection(c,o.y),this.addBorderIntersection(c,i.y)}else{const c=0===i.y?2:3;this.addBorderIntersection(c,o.x),this.addBorderIntersection(c,i.x)}}centroid(){return 0===this.accCount?new Je(0,0):new Je(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((i,o)=>i+ +(o[0]!==Number.MAX_VALUE),0):0}}function Km(a,i){const o=a.add(i)._unit(),c=se(a.x*o.x+a.y*o.y,-1,1);var h,m,g;return h=Math.acos(c),Math.min(4,Math.max(-4,Math.tan(h)))/4*e0*((m=a).x*(g=i).y-m.y*g.x<0?-1:1)}const FE=[a=>a.x<0,a=>a.x>ht,a=>a.y<0,a=>a.y>ht];function n0(a,i,o,c){const h=[4];if(0===c)return h;o._mult(c);const m=a.sub(o),g=i.sub(o),x=[a,i,m,g];for(let w=0;w<4;w++)for(const T of x)if(FE[w](T)){h.push(w);break}return h}class r0{constructor(i){this.vertexArray=new na,this.indexArray=new Pi,this.programConfigurations=new Cs(i.layers,{zoom:i.zoom,lut:i.lut},o=>EC.includes(o)),this._segments=new Wi,this.hiddenByLandmarkVertexArray=new xa,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Wi}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(i,o,c,h=!1){const m=i.length;if(m>2){let g=Math.max(0,this._segments.get().length-1);const x=this._segments._prepareSegment(4*m,this.vertexArray.length,2*this._segmentToGroundQuads[g].length);let w;g!==this._segments.get().length-1&&(g++,this._segmentToGroundQuads[g]=[],this._segmentToRegionTriCounts[g]=[0,0,0,0,0]);{const T=i[0],I=i[1];w=Km(T.sub(i[m-1])._perp()._unit(),I.sub(T)._perp()._unit())}for(let T=0;T<m;T++){const I=T===m-1?0:T+1,A=i[T],M=i[I],k=i[I===m-1?0:I+1],L=M.sub(A)._perp()._unit(),V=Km(L,k.sub(M)._perp()._unit()),j=w,W=V;if(W_(A,M,o)||h&&Tb(A,o)&&Tb(M,o)){w=V;continue}const Q=x.vertexLength;q_(this.vertexArray,A,M,1,1,j),q_(this.vertexArray,A,M,1,0,j),q_(this.vertexArray,A,M,0,1,W),q_(this.vertexArray,A,M,0,0,W),x.vertexLength+=4;const K=n0(A,M,L,c);for(const te of K)this._segmentToGroundQuads[g].push({id:Q,region:te}),this._segmentToRegionTriCounts[g][te]+=2,x.primitiveLength+=2;w=V}}}prepareBorderSegments(){if(!this.hasData())return;const i=this._segments.get(),o=i.length;for(let c=0;c<o;c++)this._segmentToGroundQuads[c].sort((h,m)=>h.region-m.region);for(let c=0;c<o;c++){const h=this._segmentToGroundQuads[c],m=i[c],g=this._segmentToRegionTriCounts[c];g.reduce((w,T)=>w+T,0);let x=0;for(let w=0;w<=4;w++){const T=g[w];if(0!==T){let I=this.regionSegments[w];I||(I=this.regionSegments[w]=new Wi);const A={vertexOffset:m.vertexOffset,primitiveOffset:m.primitiveOffset+x,vertexLength:m.vertexLength,primitiveLength:T};I.get().push(A)}x+=T}for(let w=0;w<h.length;w++){const T=h[w].id;this.indexArray.emplaceBack(T,T+1,T+3),this.indexArray.emplaceBack(T,T+3,T+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(i,o,c,h,m,g,x){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,i,o,c,h,m,g,void 0,x)}upload(i){this.hasData()&&(this.vertexBuffer=i.createVertexBuffer(this.vertexArray,SE.members),this.indexBuffer=i.createIndexBuffer(this.indexArray))}uploadPaintProperties(i){this.hasData()&&this.programConfigurations.upload(i)}update(i,o,c,h,m,g,x,w){this.hasData()&&this.programConfigurations.updatePaintArrays(i,o,c,h,m,g,x,w)}updateHiddenByLandmark(i){this.updateHiddenByLandmarkRange(i.groundVertexArrayOffset,i.groundVertexCount,!!(i.flags&kh))}updateHiddenByLandmarkRange(i,o,c){if(!this.hasData())return;const h=o+i;if(0!==o){for(let m=i;m<h;++m)this.hiddenByLandmarkVertexArray.emplace(m,c?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(i){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=i.createVertexBuffer(this.hiddenByLandmarkVertexArray,fd.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let i=0;i<=4;i++){const o=this.regionSegments[i];o&&o.destroy()}}}}class du{constructor(i){this.zoom=i.zoom,this.canonical=i.canonical,this.overscaling=i.overscaling,this.layers=i.layers,this.pixelRatio=i.pixelRatio,this.layerIds=this.layers.map(o=>o.fqid),this.index=i.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=i.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Pi,this.footprintVertices=new Ds,this.footprintSegments=[],this.layoutVertexArray=new to,this.centroidVertexArray=new x_,this.wallVertexArray=new Wf,this.indexArray=new Pi,this.programConfigurations=new Cs(i.layers,{zoom:i.zoom,lut:i.lut},o=>wC.includes(o)),this.segments=new Wi,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.groundEffect=new r0(i),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=i.worldview}updateFootprints(i,o){}populate(i,o,c,h){this.features=[],this.hasPattern=O_("fill-extrusion",this.layers,this.pixelRatio,o),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=ce(c),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:m,id:g,index:x,sourceLayerIndex:w}of i){const T=this.layers[0]._featureFilter.needGeometry,I=Ne(m,T);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),I,c))continue;const A={id:g,sourceLayerIndex:w,index:x,geometry:T?I.geometry:_e(m,c,h),properties:m.properties,type:m.type,patterns:{}},M=this.layoutVertexArray.length,k="Polygon"===H_[A.type];if(this.hasPattern)this.features.push({featureId:m.id,feature:qv("fill-extrusion",this.layers,A,this.zoom,this.pixelRatio,o)});else if(this.wallMode)for(const L of A.geometry)for(const V of Jv(L,k))this.addFeature(m.id,A,[V],x,c,{},o.availableImages,h,o.brightness);else this.addFeature(m.id,A,A.geometry,x,c,{},o.availableImages,h,o.brightness);o.featureIndex.insert(m,A.geometry,x,w,this.index,M)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(i,o,c,h,m,g){for(const{featureId:x,feature:w}of this.features){const T="Polygon"===H_[w.type],{geometry:I}=w;if(this.wallMode)for(const A of I)for(const M of Jv(A,T))this.addFeature(x,w,[M],w.index,o,c,h,m,g);else this.addFeature(x,w,I,w.index,o,c,h,m,g)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(i,o,c,h,m,g,x){this.programConfigurations.updatePaintArrays(i,o,m,c,h,g,x,this.worldview),this.groundEffect.update(i,o,m,c,h,g,x,this.worldview)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(i){this.uploaded||(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,AE),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.wallVertexBuffer=i.createVertexBuffer(this.wallVertexArray,IE.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=i.createVertexBuffer(this.layoutVertexExtArray,Xm.members,!0)),this.groundEffect.upload(i)),this.groundEffect.uploadPaintProperties(i),this.programConfigurations.upload(i),this.uploaded=!0}uploadCentroid(i){this.groundEffect.uploadHiddenByLandmark(i),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=i.createVertexBuffer(this.centroidVertexArray,CE.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(i,o,c,h,m,g,x,w,T){const I=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(o,{})/this.tileToMeter,A=[new Je(0,0),new Je(ht,ht)],M=w.projection,k="globe"===M.name,L=this.wallMode||"Polygon"===H_[o.type],V=new t0;V.centroidDataIndex=this.centroidData.length;const j=new wb;j.buildingId=i,o.properties&&o.properties.hasOwnProperty("building_id")&&(j.buildingId=o.properties.building_id);const W=this.layers[0].paint.get("fill-extrusion-base").evaluate(o,{},m)<=0,Q=this.layers[0].paint.get("fill-extrusion-height").evaluate(o,{},m);let K;if(j.height=Q,j.vertexArrayOffset=this.layoutVertexArray.length,j.groundVertexArrayOffset=this.groundEffect.vertexArray.length,k&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new nd),this.wallMode){if(k)return void yn("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==c.length)return;K=function(Ce){const Ue=Ce[0].x===Ce[Ce.length-1].x&&Ce[0].y===Ce[Ce.length-1].y;(function(tt){let It=0;const yt=tt.length;for(let ft=0;ft<yt;ft++)It+=(tt[(ft+1)%yt].x-tt[ft].x)*(tt[(ft+1)%yt].y+tt[ft].y);return It>=0})(Ce)||(Ce=Ce.reverse());const $e={geometry:[],joinNormals:[],indices:[]},Ke=[],nt=[],ze=[];let Qe=Ce.length;for(;Qe>=2&&Ce[Qe-1].equals(Ce[Qe-2]);)Qe--;if(Qe<(Ue?3:2))return $e;let Ae,Be,at,et,Ft,St=0;for(;St<Qe-1&&Ce[St].equals(Ce[St+1]);)St++;Ue&&(Ae=Ce[Qe-2],Ft=Ce[St].sub(Ae)._unit()._perp());for(let tt=St;tt<Qe;tt++){if(at=tt===Qe-1?Ue?Ce[St+1]:void 0:Ce[tt+1],at&&Ce[tt].equals(at))continue;Ft&&(et=Ft),Ae&&(Be=Ae),Ae=Ce[tt],Ft=at?at.sub(Ae)._unit()._perp():et,et=et||Ft;let It=et.add(Ft);0===It.x&&0===It.y||It._unit();const yt=It.x*Ft.x+It.y*Ft.y,ft=0!==yt?1/yt:1/0,xt=et.x*Ft.y-et.y*Ft.x>0;let zt="miter";const qt=2;"miter"===zt&&ft>qt&&(zt="bevel"),"bevel"===zt&&(ft>100&&(zt="flipbevel"),ft<qt&&(zt="miter"));const rn=(Kt,vn,dn,ii)=>{const ie=new Je(Kt.x,Kt.y),re=new Je(Kt.x,Kt.y);ie.x+=vn.x*ii,ie.y+=vn.y*ii,re.x-=vn.x*Math.max(dn,1),re.y-=vn.y*Math.max(dn,1),ze.push(vn),Ke.push(ie),nt.push(re)};if("miter"===zt)It._mult(ft),rn(Ae,It,0,0);else if("flipbevel"===zt)It=Ft.mult(-1),rn(Ae,It,0,0),rn(Ae,It.mult(-1),0,0);else{const Kt=-Math.sqrt(ft*ft-1),vn=xt?Kt:0,dn=xt?0:Kt;Be&&rn(Ae,et,vn,dn),at&&rn(Ae,Ft,vn,dn)}}$e.geometry=[...Ke,...nt.reverse(),Ke[0]],$e.joinNormals=[...ze,...ze.reverse(),ze[ze.length-1]];const Xe=$e.geometry.length-1;for(let tt=0;tt<Xe/2;tt++)if(tt+1<Xe/2){let It=tt,yt=tt+1,ft=Xe-1-tt,xt=Xe-2-tt;It=0===It?Xe-1:It-1,yt=0===yt?Xe-1:yt-1,ft=0===ft?Xe-1:ft-1,xt=0===xt?Xe-1:xt-1,$e.indices.push(ft),$e.indices.push(yt),$e.indices.push(It),$e.indices.push(ft),$e.indices.push(xt),$e.indices.push(yt)}return $e}(c[0]),c=[K.geometry]}const te=(Ce,Ue)=>Ce<(Ue.length-1)/2||Ce===Ue.length-1,me=this.wallMode?[c]:Ph(c,500);for(let Ce=me.length-1;Ce>=0;Ce--){const Ue=me[Ce];(0===Ue.length||(he=Ue[0]).every(ot=>ot.x<=0)||he.every(ot=>ot.x>=ht)||he.every(ot=>ot.y<=0)||he.every(ot=>ot.y>=ht))&&me.splice(Ce,1)}var he;let fe;if(k)fe=Ib(me,A,m);else{fe=[];for(const Ce of me)fe.push({polygon:Ce,bounds:A})}const xe=L?this.edgeRadius:0,Ee=xe>0&&this.zoom<17,Ve=(Ce,Ue)=>{if(0===Ce.length)return!1;const ot=Ce[Ce.length-1];return Ue.x===ot.x&&Ue.y===ot.y};for(const{polygon:Ce,bounds:Ue}of fe){let ot=0,$e=0;for(const Qe of Ce)L&&!Qe[0].equals(Qe[Qe.length-1])&&Qe.push(Qe[0]),$e+=L?Qe.length-1:Qe.length;const Ke=this.segments.prepareSegment((L?5:4)*$e,this.layoutVertexArray,this.indexArray);j.footprintSegIdx<0&&(j.footprintSegIdx=this.footprintSegments.length),j.polygonSegIdx<0&&(j.polygonSegIdx=this.polygonSegments.length);const nt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},ze=new bb;if(ze.vertexOffset=this.footprintVertices.length,ze.indexOffset=3*this.footprintIndices.length,ze.ringIndices=[],L){const Qe=[],Ae=[];ot=Ke.vertexLength;for(let at=0;at<Ce.length;at++){const et=Ce[at];et.length&&0!==at&&Ae.push(Qe.length/2);const Ft=[];let St,Xe;St=et[1].sub(et[0])._perp()._unit(),ze.ringIndices.push(et.length-1);for(let tt=1;tt<et.length;tt++){const It=et[tt],yt=et[tt===et.length-1?1:tt+1],ft=It.clone();if(xe){Xe=yt.sub(It)._perp()._unit();const xt=St.add(Xe)._unit(),zt=xe*Math.min(4,1/(St.x*xt.x+St.y*xt.y));ft.x+=zt*xt.x,ft.y+=zt*xt.y,ft.x=Math.round(ft.x),ft.y=Math.round(ft.y),St=Xe}if(!W||0!==xe&&!Ee||Ve(Ft,ft)||Ft.push(ft),$_(this.layoutVertexArray,ft.x,ft.y,0,0,1,1,0),this.wallMode){const xt=te(tt,et);Qf(this.wallVertexArray,K.joinNormals[tt],!xt)}Ke.vertexLength++,this.footprintVertices.emplaceBack(It.x,It.y),Qe.push(It.x,It.y),k&&Ym(this.layoutVertexExtArray,M.projectTilePoint(ft.x,ft.y,m),M.upVector(m,ft.x,ft.y))}W&&(0===xe||Ee)&&(0!==Ft.length&&Ve(Ft,Ft[0])&&Ft.pop(),this.groundEffect.addData(Ft,Ue,I))}const Be=this.wallMode?K.indices:Sh(Qe,Ae);for(let at=0;at<Be.length;at+=3)this.footprintIndices.emplaceBack(ze.vertexOffset+Be[at+0],ze.vertexOffset+Be[at+1],ze.vertexOffset+Be[at+2]),this.indexArray.emplaceBack(ot+Be[at],ot+Be[at+2],ot+Be[at+1]),Ke.primitiveLength++;ze.indexCount+=Be.length,ze.vertexCount+=this.footprintVertices.length-ze.vertexOffset}for(let Qe=0;Qe<Ce.length;Qe++){const Ae=Ce[Qe];V.startRing(j,Ae[0]);let Be=Ae.length>4&&Db(Ae[Ae.length-2],Ae[0],Ae[1]),at=xe?kE(Ae[Ae.length-2],Ae[0],Ae[1],xe):0;const et=[];let Ft,St,Xe;St=Ae[1].sub(Ae[0])._perp()._unit();let tt=!0;for(let It=1,yt=0;It<Ae.length;It++){let ft=Ae[It-1],xt=Ae[It];const zt=Ae[It===Ae.length-1?1:It+1];if(V.appendEdge(j,xt,ft),W_(xt,ft,Ue)){xe&&(St=zt.sub(xt)._perp()._unit(),tt=!tt);continue}const qt=xt.sub(ft)._perp(),rn=qt.x/(Math.abs(qt.x)+Math.abs(qt.y)),Kt=qt.y>0?1:0,vn=ft.dist(xt);if(yt+vn>32768&&(yt=0),xe){Xe=zt.sub(xt)._perp()._unit();let re=o0(ft,xt,zt,Eb(St,Xe),xe);isNaN(re)&&(re=0);const Le=xt.sub(ft)._unit();ft=ft.add(Le.mult(at))._round(),xt=xt.add(Le.mult(-re))._round(),at=re,St=Xe,W&&this.zoom>=17&&(Ve(et,ft)||et.push(ft),Ve(et,xt)||et.push(xt))}const dn=Ke.vertexLength,ii=Ae.length>4&&Db(ft,xt,zt);let ie=Sb(yt,Be,tt);if($_(this.layoutVertexArray,ft.x,ft.y,rn,Kt,0,0,ie),$_(this.layoutVertexArray,ft.x,ft.y,rn,Kt,0,1,ie),this.wallMode){const re=te(It-1,Ae),Le=K.joinNormals[It-1];Qf(this.wallVertexArray,Le,re),Qf(this.wallVertexArray,Le,re)}if(yt+=vn,ie=Sb(yt,ii,!tt),Be=ii,$_(this.layoutVertexArray,xt.x,xt.y,rn,Kt,0,0,ie),$_(this.layoutVertexArray,xt.x,xt.y,rn,Kt,0,1,ie),this.wallMode){const re=te(It,Ae),Le=K.joinNormals[It];Qf(this.wallVertexArray,Le,re),Qf(this.wallVertexArray,Le,re)}if(Ke.vertexLength+=4,this.indexArray.emplaceBack(dn+0,dn+1,dn+2),this.indexArray.emplaceBack(dn+1,dn+3,dn+2),Ke.primitiveLength+=2,xe){const re=ot+(1===It?Ae.length-2:It-2),Le=1===It?ot:re+1;if(this.indexArray.emplaceBack(dn+1,re,dn+3),this.indexArray.emplaceBack(re,Le,dn+3),Ke.primitiveLength+=2,void 0===Ft&&(Ft=dn),!W_(zt,Ae[It],Ue)){const lt=It===Ae.length-1?Ft:Ke.vertexLength;this.indexArray.emplaceBack(dn+2,dn+3,lt),this.indexArray.emplaceBack(dn+3,lt+1,lt),this.indexArray.emplaceBack(dn+3,Le,lt+1),Ke.primitiveLength+=3}tt=!tt}if(k){const re=this.layoutVertexExtArray,Le=M.projectTilePoint(ft.x,ft.y,m),lt=M.projectTilePoint(xt.x,xt.y,m),ut=M.upVector(m,ft.x,ft.y),pt=M.upVector(m,xt.x,xt.y);Ym(re,Le,ut),Ym(re,Le,ut),Ym(re,lt,pt),Ym(re,lt,pt)}}L&&(ot+=Ae.length-1),W&&xe&&this.zoom>=17&&(0!==et.length&&Ve(et,et[0])&&et.pop(),this.groundEffect.addData(et,Ue,I,xe>0))}this.footprintSegments.push(ze),nt.triangleCount=this.indexArray.length-nt.triangleArrayOffset,this.polygonSegments.push(nt),++j.footprintSegLen,++j.polygonSegLen}if(j.vertexCount=this.layoutVertexArray.length-j.vertexArrayOffset,j.groundVertexCount=this.groundEffect.vertexArray.length-j.groundVertexArrayOffset,0!==j.vertexCount){if(j.centroidXY=V.borders?G_:this.encodeCentroid(V,j),this.centroidData.push(j),V.borders){this.featuresOnBorder.push(V);const Ce=this.featuresOnBorder.length-1;for(let Ue=0;Ue<V.borders.length;Ue++)V.borders[Ue][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Ue].push(Ce)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,h,g,x,m,T,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(o,h,g,x,m,T,this.worldview),this.maxHeight=Math.max(this.maxHeight,Q)}}sortBorders(){for(let i=0;i<this.borderFeatureIndices.length;i++)this.borderFeatureIndices[i].sort((o,c)=>this.featuresOnBorder[o].borders[i][0]-this.featuresOnBorder[c].borders[i][0])}splitToSubtiles(){const i=[];for(let x=0;x<this.centroidData.length;x++){const w=this.centroidData[x],T=+(w.min.y+w.max.y>ht),I=2*T+(+(w.min.x+w.max.x>ht)^T);for(let A=0;A<w.polygonSegLen;A++){const M=w.polygonSegIdx+A;i.push({centroidIdx:x,subtile:I,polygonSegmentIdx:M,triangleSegmentIdx:this.polygonSegments[M].triangleSegIdx})}}const o=new Pi;i.sort((x,w)=>x.triangleSegmentIdx===w.triangleSegmentIdx?x.subtile-w.subtile:x.triangleSegmentIdx-w.triangleSegmentIdx);let c=0,h=0,m=0;for(const x of i){if(x.triangleSegmentIdx!==c)break;m++}const g=i.length;for(;h!==i.length;){c=i[h].triangleSegmentIdx;let x=0,w=h,T=h;for(let I=w;I<m&&i[I].subtile===x;I++)T++;for(;w!==m;){const I=i[w];x=I.subtile;const A=this.centroidData[I.centroidIdx].min.clone(),M=this.centroidData[I.centroidIdx].max.clone(),k={vertexOffset:this.segments.segments[c].vertexOffset,primitiveOffset:o.length,vertexLength:this.segments.segments[c].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let L=w;L<T;L++){const V=i[L],j=this.polygonSegments[V.polygonSegmentIdx],W=this.centroidData[V.centroidIdx].min,Q=this.centroidData[V.centroidIdx].max,K=this.indexArray.uint16;for(let te=j.triangleArrayOffset;te<j.triangleArrayOffset+j.triangleCount;te++)o.emplaceBack(K[3*te],K[3*te+1],K[3*te+2]);k.primitiveLength+=j.triangleCount,A.x=Math.min(A.x,W.x),A.y=Math.min(A.y,W.y),M.x=Math.max(M.x,Q.x),M.y=Math.max(M.y,Q.y)}k.primitiveLength>0&&this.triangleSubSegments.push({segment:k,min:A,max:M}),w=T;for(let L=w;L<m&&i[L].subtile===i[w].subtile;L++)T++}h=m;for(let I=h;I<g&&i[I].triangleSegmentIdx===i[h].triangleSegmentIdx;I++)m++}o._trim(),this.indexArray=o}getVisibleSegments(i,o,c){const h=new Wi;if(this.wallMode){for(const V of this.triangleSubSegments)h.segments.push(V.segment);return h}let m=0,g=0;const x=1<<i.canonical.z;if(o){const V=o.getMinMaxForTile(i);V&&(m=V.min,g=V.max)}g+=this.maxHeight;const w=i.toUnwrapped();let T;const I=[w.canonical.x/x+w.wrap,w.canonical.y/x],A=[(w.canonical.x+1)/x+w.wrap,(w.canonical.y+1)/x],M=(V,j,W)=>[V[0]*(1-W[0])+j[0]*W[0],V[1]*(1-W[1])+j[1]*W[1]],k=[],L=[];for(const V of this.triangleSubSegments){k[0]=V.min.x/ht,k[1]=V.min.y/ht,L[0]=V.max.x/ht,L[1]=V.max.y/ht;const j=M(I,A,k),W=M(I,A,L);if(0===new sn([j[0],j[1],m],[W[0],W[1],g]).intersectsPrecise(c)){T&&(h.segments.push(T),T=void 0);continue}const Q=V.segment;T&&T.vertexOffset!==Q.vertexOffset&&(h.segments.push(T),T=void 0),T?(T.vertexLength+=Q.vertexLength,T.primitiveLength+=Q.primitiveLength):T={vertexOffset:Q.vertexOffset,primitiveLength:Q.primitiveLength,vertexLength:Q.vertexLength,primitiveOffset:Q.primitiveOffset,sortKey:void 0,vaos:{}}}return T&&h.segments.push(T),h}encodeCentroid(i,o){const c=i.centroid(),h=o.span(),m=Math.min(7,Math.round(h.x*this.tileToMeter/10)),g=Math.min(7,Math.round(h.y*this.tileToMeter/10));return new Je(se(c.x,1,ht-1)<<3|m,se(c.y,1,ht-1)<<3|g)}encodeBorderCentroid(i){if(!i.borders)return new Je(0,0);const o=i.borders,c=Number.MAX_VALUE;if(o[0][0]!==c||o[1][0]!==c){const h=o[0][0]!==c?0:1;return new Je(6|(o[0][0]!==c?0:65528),(o[h][0]+o[h][1])/2<<3|6)}{const h=o[2][0]!==c?2:3;return new Je((o[h][0]+o[h][1])/2<<3|6,6|(o[2][0]!==c?0:65528))}}showCentroid(i){const o=this.centroidData[i.centroidDataIndex];o.flags&=2147483647,o.centroidXY.x=0,o.centroidXY.y=0,this.writeCentroidToBuffer(o)}writeCentroidToBuffer(i){this.groundEffect.updateHiddenByLandmark(i);const o=i.vertexArrayOffset,c=i.vertexCount+i.vertexArrayOffset,h=i.flags&kh?G_:i.centroidXY,m=this.centroidVertexArray.geta_centroid_pos0(o);if(this.centroidVertexArray.geta_centroid_pos1(o)!==h.y||m!==h.x){for(let g=o;g<c;++g)this.centroidVertexArray.emplace(g,h.x,h.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const i of this.centroidData)this.writeCentroidToBuffer(i)}updateReplacement(i,o,c){if(o.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=o.updateTime;const h=o.getReplacementRegionsForTile(i.toUnwrapped());if(V_(this.activeReplacements,h))return;if(this.activeReplacements=h,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const g of this.centroidData)g.flags&=2147483647;const m=[];for(const g of this.activeReplacements){if(g.order<c)continue;const x=Math.max(1,Math.pow(2,g.footprintTileId.canonical.z-i.canonical.z));if(g.footprint.buildingId){const w=g.footprint.buildingId;for(const T of this.centroidData)T.buildingId===w&&(T.flags|=kh)}else for(const w of this.centroidData)if(!(w.flags&kh||g.min.x>w.max.x||w.min.x>g.max.x||g.min.y>w.max.y||w.min.y>g.max.y))for(let T=0;T<w.footprintSegLen;T++){const I=this.footprintSegments[w.footprintSegIdx+T];if(m.length=0,DC(this.footprintVertices,I.vertexOffset,I.vertexCount,g.footprintTileId.canonical,i.canonical,m),Qv(g.footprint,m,this.footprintIndices.uint16,I.indexOffset,I.indexCount,-I.vertexOffset,-x)){w.flags|=kh;break}}}for(const g of this.centroidData)this.writeCentroidToBuffer(g);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(i,o,c){let h=!1;for(let m=0;m<c.footprintSegLen;m++){const g=this.footprintSegments[c.footprintSegIdx+m];let x=0;for(const w of g.ringIndices){for(let T=x,I=w+x-1;T<w+x;I=T++){const A=this.footprintVertices.int16[2*(T+g.vertexOffset)+0],M=this.footprintVertices.int16[2*(T+g.vertexOffset)+1],k=this.footprintVertices.int16[2*(I+g.vertexOffset)+1];M>o!=k>o&&i<(this.footprintVertices.int16[2*(I+g.vertexOffset)+0]-A)*(o-M)/(k-M)+A&&(h=!h)}x=w}}return h}getHeightAtTileCoord(i,o){let c=Number.NEGATIVE_INFINITY,h=!0;const m=4*(i+ht)*ht+(o+ht);if(this.partLookup.hasOwnProperty(m)){const g=this.partLookup[m];return g?{height:g.height,hidden:!!(g.flags&kh)}:void 0}for(const g of this.centroidData)i>g.max.x||g.min.x>i||o>g.max.y||g.min.y>o||g.height<=c||this.footprintContainsPoint(i,o,g)&&(c=g.height,this.partLookup[m]=g,h=!!(g.flags&kh));if(c!==Number.NEGATIVE_INFINITY)return{height:c,hidden:h};this.partLookup[m]=void 0}}function Eb(a,i){const o=a.add(i)._unit();return a.x*o.x+a.y*o.y}function kE(a,i,o,c){const h=i.sub(a)._perp()._unit(),m=o.sub(i)._perp()._unit();return o0(a,i,o,Eb(h,m),c)}function o0(a,i,o,c,h){const m=Math.sqrt(1-c*c);return Math.min(a.dist(i)/3,i.dist(o)/3,h*m/c)}function W_(a,i,o){return a.x<o[0].x&&i.x<o[0].x||a.x>o[1].x&&i.x>o[1].x||a.y<o[0].y&&i.y<o[0].y||a.y>o[1].y&&i.y>o[1].y}function Tb(a,i){return a.x<i[0].x||a.x>i[1].x||a.y<i[0].y||a.y>i[1].y}function Db(a,i,o){if(a.x<0||a.x>=ht||i.x<0||i.x>=ht||o.x<0||o.x>=ht)return!1;const c=o.sub(i),h=c.perp(),m=a.sub(i);return(c.x*m.x+c.y*m.y)/Math.sqrt((c.x*c.x+c.y*c.y)*(m.x*m.x+m.y*m.y))>-.866&&h.x*m.x+h.y*m.y<0}function Sb(a,i,o){const c=i?2|a:-3&a;return o?1|c:-2&c}function Cb(){const a=Math.PI/32,i=Math.tan(a),o=C;return o*Math.sqrt(1+2*i*i)-o}function Ib(a,i,o){const c=1<<o.z,h=Y(o.x/c),m=Y((o.x+1)/c),g=ee(o.y/c),x=ee((o.y+1)/c);return function(w,T,I,A,M=0,k){const L=[];if(!w.length||!I||!A)return L;const V=(he,fe)=>{for(const xe of he)L.push({polygon:xe,bounds:fe})},j=Math.ceil(Math.log2(I)),W=Math.ceil(Math.log2(A)),Q=j-W,K=[];for(let he=0;he<Math.abs(Q);he++)K.push(Q>0?0:1);for(let he=0;he<Math.min(j,W);he++)K.push(0),K.push(1);let te=w;if(te=k_(te,T[0].y-M,T[1].y+M,1),te=k_(te,T[0].x-M,T[1].x+M,0),!te.length)return L;const me=[];for(K.length?me.push({polygons:te,bounds:T,depth:0}):V(te,T);me.length;){const he=me.pop(),fe=he.depth,xe=K[fe],Ee=he.bounds[0],Ve=he.bounds[1],Ce=0===xe?Ee.x:Ee.y,Ue=0===xe?Ve.x:Ve.y,ot=k?k(xe,Ce,Ue):.5*(Ce+Ue),$e=k_(he.polygons,Ce-M,ot+M,xe),Ke=k_(he.polygons,ot-M,Ue+M,xe);if($e.length){const nt=[Ee,new Je(0===xe?ot:Ve.x,1===xe?ot:Ve.y)];K.length>fe+1?me.push({polygons:$e,bounds:nt,depth:fe+1}):V($e,nt)}if(Ke.length){const nt=[new Je(0===xe?ot:Ee.x,1===xe?ot:Ee.y),Ve];K.length>fe+1?me.push({polygons:Ke,bounds:nt,depth:fe+1}):V(Ke,nt)}}return L}(a,i,Math.ceil((m-h)/11.25),Math.ceil((g-x)/11.25),1,(w,T,I)=>{if(0===w)return.5*(T+I);{const A=ee((o.y+T/ht)/c);return(q(.5*(ee((o.y+I/ht)/c)+A))*c-o.y)*ht}})}function DC(a,i,o,c,h,m){const g=Math.pow(2,c.z-h.z);for(let x=0;x<o;x++){let w=a.int16[2*(x+i)+0],T=a.int16[2*(x+i)+1];w=(w+h.x*ht)*g-c.x*ht,T=(T+h.y*ht)*g-c.y*ht,m.push(new Je(w,T))}}let LE,Jf;Et(du,"FillExtrusionBucket",{omit:["layers","features"]}),Et(wb,"PartData"),Et(bb,"FootprintSegment"),Et(t0,"BorderCentroidData"),Et(r0,"GroundEffect");class pc extends Je{constructor(i,o,c){super(i,o),this.z=c}}class s0 extends pc{constructor(i,o,c,h){super(i,o,c),this.w=h}}function a0(a,i,o,c){const h="x"===o?"y":"x",m=(c-a[o])/(i[o]-a[o]);a[h]=Math.round(a[h]+(i[h]-a[h])*m),a[o]=c,a.hasOwnProperty("z")&&(a.z=Nt(a.z,i.z,m)),a.hasOwnProperty("w")&&(a.w=Nt(a.w,i.w,m))}function Z_(a,i,o,c){const h=o,m=c;for(const g of["x","y"]){let x=a,w=i;x[g]>=w[g]&&(x=i,w=a),x[g]<h&&w[g]>h&&a0(x,w,g,h),x[g]<m&&w[g]>m&&a0(w,x,g,m)}}function Qm(a,i,o,c,h,m){const g=[];for(let x=0;x<a.length;x++){const w=a[x];let T;const I=g.length;let A=0;for(let M=0;M<w.length-1;M++){let k=w[M],L=w[M+1],V=0;const j=A;let W,Q;m&&(V=Math.hypot(L.x-k.x,L.y-k.y),A+=V,W=k,Q=L),k.x<i&&L.x<i||(k.x<i?k=new Je(i,k.y+(i-k.x)/(L.x-k.x)*(L.y-k.y))._round():L.x<i&&(L=new Je(i,k.y+(i-k.x)/(L.x-k.x)*(L.y-k.y))._round()),k.y<o&&L.y<o||(k.y<o?k=new Je(k.x+(o-k.y)/(L.y-k.y)*(L.x-k.x),o)._round():L.y<o&&(L=new Je(k.x+(o-k.y)/(L.y-k.y)*(L.x-k.x),o)._round()),k.x>=c&&L.x>=c||(k.x>=c?k=new Je(c,k.y+(c-k.x)/(L.x-k.x)*(L.y-k.y))._round():L.x>=c&&(L=new Je(c,k.y+(c-k.x)/(L.x-k.x)*(L.y-k.y))._round()),k.y>=h&&L.y>=h||(k.y>=h?k=new Je(k.x+(h-k.y)/(L.y-k.y)*(L.x-k.x),h)._round():L.y>=h&&(L=new Je(k.x+(h-k.y)/(L.y-k.y)*(L.x-k.x),h)._round()),T&&k.equals(T[T.length-1])||(T=[k],g.push(T),m&&m.push({progress:{min:j+l0(W,Q,k)*V,max:1},parentIndex:x,prevPoint:W,nextPoint:Q})),T.push(L),m&&(m[m.length-1].progress.max=j+l0(W,Q,L)*V,m[m.length-1].nextPoint=Q)))))}if(m&&A>0)for(let M=I;M<g.length;M++)m[M].progress.min/=A,m[M].progress.max/=A}return g}function NE(a,i,o,c,h){if(a.length<2)return void c.push(a);const m=[];for(;i.valid();){const[T,I]=i.get();for(let A=0;A<a.length-1;A++){const M=a[A],k=a[A+1],L=qs(M,k,T,I);if(L){const[V]=L,j=new Je(Nt(M.x,k.x,V),Nt(M.y,k.y,V));m.push({t:A+V,distance:0,point:j})}}i.next()}if(0===m.length)return void c.push(a);m.sort((T,I)=>T.t-I.t);let g=0,x=0,w=[];for(c.push(w);g!==a.length;){if(x===m.length){for(;g!==a.length;)0!==w.length&&w[w.length-1].equals(a[g])||w.push(a[g]),g++;break}m[x].t<=g?(0!==w.length&&w[w.length-1].equals(m[x].point)||w.push(m[x].point),Math.trunc(m[x].t),x++):(0!==w.length&&w[w.length-1].equals(a[g])||w.push(a[g]),g++)}}function l0(a,i,o){return a.x!==i.x?(o.x-a.x)/(i.x-a.x):a.y!==i.y?(o.y-a.y)/(i.y-a.y):0}function ep(a,i){return a.x*i.x+a.y*i.y}function Jm(a,i){if(1===a.length){let o=0;const c=i[o++];let h;for(;!h||c.equals(h);)if(h=i[o++],!h)return 1/0;for(;o<i.length;o++){const m=i[o],g=a[0],x=h.sub(c),w=m.sub(c),T=g.sub(c),I=ep(x,x),A=ep(x,w),M=ep(w,w),k=ep(T,x),L=ep(T,w),V=I*M-A*A,j=(M*k-A*L)/V,W=(I*L-A*k)/V,Q=c.z*(1-j-W)+h.z*j+m.z*W;if(isFinite(Q))return Q}return 1/0}{let o=1/0;for(const c of i)o=Math.min(o,c.z);return o}}function zE(a,i,o,c,h,m,g,x){const w=g*h.getElevationAt(a,i,!0,!0),T=0!==m[0],I=T?0===m[1]?g*(m[0]/7-450):g*function(A,M,k){const L=Math.floor(M[0]/8),V=Math.floor(M[1]/8),j=10*(M[0]-8*L),W=10*(M[1]-8*V),Q=A.getElevationAt(L,V,!0,!0),K=A.getMeterToDEM(k),te=Math.floor(.5*(j*K-1)),me=Math.floor(.5*(W*K-1)),he=A.tileCoordToPixel(L,V),fe=2*te+1,xe=2*me+1,Ee=(Qe=fe,Ae=xe,[(Ke=A).getElevationAtPixel(nt=he.x-te,ze=he.y-me,!0),Ke.getElevationAtPixel(nt+Ae,ze,!0),Ke.getElevationAtPixel(nt,ze+Ae,!0),Ke.getElevationAtPixel(nt+Qe,ze+Ae,!0)]),Ve=Math.abs(Ee[0]-Ee[1]),Ce=Math.abs(Ee[2]-Ee[3]),Ue=Math.abs(Ee[0]-Ee[2])+Math.abs(Ee[1]-Ee[3]),ot=Math.min(.25,.5*K*(Ve+Ce)/fe),$e=Math.min(.25,.5*K*Ue/xe);var Ke,nt,ze,Qe,Ae;return Q+Math.max(ot*j,$e*W)}(h,m,x):w;return{base:w+(0===o?-1:o),top:T?Math.max(I+c,w+o+2):w+c}}class c0{constructor(i){this._callback=i,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class BE{constructor(){this.tasks={},this.taskQueue=[],$t(["process"],this),this.invoker=new c0(this.process),this.nextId=0}add(i,o){const c=this.nextId++,h=function({type:m,isSymbolTile:g,zoom:x}){return x=x||0,"message"===m?0:"maybePrepare"!==m||g?"parseTile"!==m||g?"parseTile"===m&&g?300-x:"maybePrepare"===m&&g?400-x:500:200-x:100-x}(o);if(0===h){try{i()}finally{}return null}return this.tasks[c]={fn:i,metadata:o,priority:h,id:c},this.taskQueue.push(c),this.invoker.trigger(),{cancel:()=>{delete this.tasks[c]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(c=>!!this.tasks[c]),!this.taskQueue.length)return;const i=this.pick();if(null===i)return;const o=this.tasks[i];if(delete this.tasks[i],this.taskQueue.length&&this.invoker.trigger(),!o)return;o.fn()}finally{}}pick(){let i=null,o=1/0;for(let h=0;h<this.taskQueue.length;h++){const m=this.tasks[this.taskQueue[h]];m.priority<o&&(o=m.priority,i=h)}if(null===i)return null;const c=this.taskQueue[i];return this.taskQueue.splice(i,1),c}remove(){this.invoker.remove()}}class X_{constructor(i,o,c){this.target=i,this.parent=o,this.mapId=c,this.callbacks={},this.cancelCallbacks={},$t(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new BE}send(i,o,c,h,m=!1,g){const x=Math.round(1e18*Math.random()).toString(36).substring(0,10);c&&(c.metadata=g,this.callbacks[x]=c);const w=new Set;return this.target.postMessage({id:x,type:i,hasCallback:!!c,targetMapId:h,mustQueue:m,sourceMapId:this.mapId,data:fl(o,w)},w),{cancel:()=>{c&&delete this.callbacks[x],this.target.postMessage({id:x,type:"<cancel>",targetMapId:h,sourceMapId:this.mapId})}}}receive(i){const o=i.data;if(!o)return;const c=o.id;if(c&&(!o.targetMapId||this.mapId===o.targetMapId))if("<cancel>"===o.type){const h=this.cancelCallbacks[c];delete this.cancelCallbacks[c],h&&h.cancel()}else if(o.mustQueue||ci(self)){const h=this.callbacks[c],m=this.scheduler.add(()=>this.processTask(c,o),h&&h.metadata||{type:"message"});m&&(this.cancelCallbacks[c]=m)}else this.processTask(c,o)}processTask(i,o){if(delete this.cancelCallbacks[i],"<response>"===o.type){const c=this.callbacks[i];delete this.callbacks[i],c&&(o.error?c($o(o.error)):c(null,$o(o.data)))}else{const c=new Set,h=o.hasCallback?(g,x)=>{this.target.postMessage({id:i,type:"<response>",sourceMapId:this.mapId,error:g?fl(g):null,data:fl(x,c)},c)}:()=>{},m=$o(o.data);if(this.parent[o.type])this.parent[o.type](o.sourceMapId,m,h);else if(this.parent.getWorkerSource){const g=o.type.split("."),{source:x,scope:w}=m;this.parent.getWorkerSource(o.sourceMapId,g[0],x,w)[g[1]](m,h)}else h(new Error(`Could not find function ${o.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var tp={workerUrl:"",workerClass:null,workerParams:void 0};const Y_="mapboxgl_preloaded_worker_pool";let Lh,ip,mc=(()=>{class a{constructor(){this.active={}}acquire(o,c=a.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<c;)this.workers.push(null!=tp.workerClass?new tp.workerClass:new self.Worker(tp.workerUrl,tp.workerParams));return this.active[o]=!0,this.workers.slice()}release(o){delete this.active[o],this.workers&&0===this.numActive()&&(this.workers.forEach(c=>{c.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Y_]}numActive(){return Object.keys(this.active).length}}return a.workerCount=2,a})();class np{constructor(i,o,c="Worker",h=mc.workerCount){this.workerPool=i,this.actors=[],this.currentActor=0,this.id=qe();const m=this.workerPool.acquire(this.id,h);for(let g=0;g<m.length;g++){const x=new np.Actor(m[g],o,this.id);x.name=`${c} ${g}`,this.actors.push(x)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(i,o,c){Te(this.actors,(h,m)=>{h.send(i,o,m)},c=c||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(i=>{i.remove()}),this.actors=[],this.workerPool.release(this.id)}}function K_(){return Lh||(Lh=new mc),Lh}np.Actor=X_;class u0{constructor(i){this.module=i}createIntArray(i){const o=new Int32Array(i),c=this.module.malloc(o.length*o.BYTES_PER_ELEMENT);return this.module.heap32.set(o,c/o.BYTES_PER_ELEMENT),c}createFloatArray(i){const o=new Float32Array(i),c=this.module.malloc(o.length*o.BYTES_PER_ELEMENT);return this.module.heapF32.set(o,c/o.BYTES_PER_ELEMENT),c}createStringBuffer(i){const o=this.module.malloc(i.length+1);for(let c=0;c<i.length;++c)this.module.heapU8[o+c]=i.charCodeAt(c);return this.module.heapU8[o+i.length]=0,o}readStringBuffer(i){let o="";for(;0!==this.module.heapU8[i];)o+=String.fromCharCode(this.module.heapU8[i]),++i;return o}setStyle(i){const o=i.entranceColorRgb,c=i.facadeGlazingColorRgb,h=i.roofColorRgb,m=i.wallColorRgb,g=i.normalScale;this.module.setStyle(o[0],o[1],o[2],c[0],c[1],c[2],h[0],h[1],h[2],m[0],m[1],m[2],g[0],g[1],g[2],i.tileToMeters)}setAOOptions(i,o){this.module.setAOOptions(i?1:0,o)}setMetricOptions(i,o){this.module.setMetricOptions(i?1:0,o)}setStructuralOptions(i){this.module.setStructuralOptions(i?1:0)}setFacadeOptions(i,o){this.module.setFacadeOptions(i,o?1:0)}setFauxFacadeOptions(i,o,c){this.module.setFauxFacadeOptions(i?1:0,o?1:0,c)}setFacadeClassifierOptions(i){this.module.setFacadeClassifierOptions(i)}generateMesh(i,o){for(const x of i){const w=this.createStringBuffer(x.roofType),T=[0],I=[];for(const k of x.coordinates)if(Array.isArray(k)){for(const L of k)I.push(L.x),I.push(L.y);T.push(I.length)}const A=this.createIntArray(T),M=this.createFloatArray(I);this.module.addFeature(x.id,x.sourceId,x.minHeight,x.height,w,x.roofType.length,M,A,T.length-1),this.module.free(w),this.module.free(A),this.module.free(M)}for(const x of o){let w;w=x.entrances?JSON.parse(x.entrances):[];const T=this.createFloatArray(w),I=[];for(const M of x.coordinates)I.push(M.x),I.push(M.y);const A=this.createFloatArray(I);this.module.addFacade(x.sourceId,x.crossPerc,x.distanceToRoad,T,w.length,A,I.length),this.module.free(T),this.module.free(A)}if(!this.module.generateMesh()){const x=this.module.getLastError();return this.readStringBuffer(x)}const c=this.module.getMeshCount(),h=new Array(c);for(let x=0;x<c;x++){const w=this.module.getPositionsPtr(x),T=this.module.getPositionsLength(x),I=new Float32Array(this.module.heapF32.buffer,w,T),A=this.module.getNormalsPtr(x),M=this.module.getNormalsLength(x),k=new Float32Array(this.module.heapF32.buffer,A,M),L=this.module.getColorsPtr(x),V=this.module.getColorsLength(x),j=new Uint8Array(this.module.heapU8.buffer,L,V),W=this.module.getAOPtr(x),Q=this.module.getAOLength(x),K=new Float32Array(this.module.heapF32.buffer,W,Q),te=this.module.getUVPtr(x),me=this.module.getUVLength(x),he=new Float32Array(this.module.heapF32.buffer,te,me),fe=this.module.getFauxFacadePtr(x),xe=this.module.getFauxFacadeLength(x),Ee=new Uint8Array(this.module.heapU8.buffer,fe,xe),Ve=this.module.getIndicesPtr(x),Ce=this.module.getIndicesLength(x),Ue=new Int32Array(this.module.heap32.buffer,Ve,Ce),ot=this.module.getBuildingPart(x),$e=this.readStringBuffer(ot);h[x]={positions:I,normals:k,colors:j,ao:K,uv:he,isFauxFacade:Ee,indices:Ue,buildingPart:$e}}const m=this.module.getRingCount(),g=[];for(let x=0;x<m;x++){const w=this.module.getRingPtr(x),T=this.module.getRingLength(x),I=new Float32Array(this.module.heapF32.buffer,w,T);g.push(I)}return{meshes:h,modifiedPolygonRings:g}}}let pd,bl,Ms,md,d0,rp=null,Nh=null,zh=null,Q_=null;function Ab(){return ci(self)&&self.worker.dracoUrl?self.worker.dracoUrl:bl||so.DRACO_URL}function Mb(){if(ci(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(md)return md;const a=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return md=WebAssembly.validate(a)?so.MESHOPT_SIMD_URL:so.MESHOPT_URL,md}const Bh={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},VE={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},op={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function gd(a,i,o){const c=o.json.bufferViews.length,h=o.buffers.length;i.bufferView=c,o.json.bufferViews[c]={buffer:h,byteLength:a.byteLength},o.buffers[h]=a}const Pb="KHR_draco_mesh_compression";function eg(a,i){const o=a.extensions&&a.extensions[Pb];if(!o)return;const c=new Ms.Decoder,h=J_(i,o.bufferView),m=new Ms.Mesh;if(!c.DecodeArrayToMesh(h,h.byteLength,m))throw new Error("Failed to decode Draco mesh");const g=i.json.accessors[a.indices],x=Bh[g.componentType],w=g.count*x.BYTES_PER_ELEMENT,T=Ms._malloc(w);x===Uint16Array?c.GetTrianglesUInt16Array(m,w,T):c.GetTrianglesUInt32Array(m,w,T),gd(Ms.memory.buffer.slice(T,T+w),g,i),Ms._free(T);for(const I of Object.keys(o.attributes)){const A=c.GetAttributeByUniqueId(m,o.attributes[I]),M=i.json.accessors[a.attributes[I]],k=VE[M.componentType],L=M.count*op[M.type]*Bh[M.componentType].BYTES_PER_ELEMENT,V=Ms._malloc(L);c.GetAttributeDataArrayForAllPoints(m,A,Ms[k],L,V),gd(Ms.memory.buffer.slice(V,V+L),M,i),Ms._free(V)}c.destroy(),m.destroy(),delete a.extensions[Pb]}const sp="EXT_meshopt_compression";function jE(a,i){if(!a.extensions||!a.extensions[sp])return;const o=a.extensions[sp],c=new Uint8Array(i.buffers[o.buffer],o.byteOffset||0,o.byteLength||0),h=new Uint8Array(o.count*o.byteStride);d0.decodeGltfBuffer(h,o.count,o.byteStride,c,o.mode,o.filter),a.buffer=i.buffers.length,a.byteOffset=0,i.buffers[a.buffer]=h.buffer,delete a.extensions[sp]}const UE=1179937895,HE=new TextDecoder("utf8");function tg(a,i){return new URL(a,i).href}function GE(a,i,o,c){return fetch(tg(a.uri,c)).then(h=>h.arrayBuffer()).then(h=>{i.buffers[o]=h})}function J_(a,i){const o=a.json.bufferViews[i];return new Uint8Array(a.buffers[o.buffer],o.byteOffset||0,o.byteLength)}function f0(a,i,o,c){if(a.uri){const h=tg(a.uri,c);return fetch(h).then(m=>m.blob()).then(m=>createImageBitmap(m)).then(m=>{i.images[o]=m})}if(void 0!==a.bufferView){const h=J_(i,a.bufferView),m=new Blob([h],{type:a.mimeType});return createImageBitmap(m).then(g=>{i.images[o]=g})}}function Vh(a,i=0,o){const c={json:null,images:[],buffers:[]};if(new Uint32Array(a,i,1)[0]===UE){const I=new Uint32Array(a,i);let A=2;const M=(I[A++]>>2)-3,k=I[A++]>>2;if(A++,c.json=JSON.parse(HE.decode(I.subarray(A,A+k))),A+=k,A<M){const L=I[A++];A++;const V=i+(A<<2);c.buffers[0]=a.slice(V,V+L)}}else c.json=JSON.parse(HE.decode(new Uint8Array(a,i)));const{buffers:h,images:m,meshes:g,extensionsUsed:x,bufferViews:w}=c.json;let T=Promise.resolve();if(h){const I=[];for(let A=0;A<h.length;A++){const M=h[A];M.uri?I.push(GE(M,c,A,o)):c.buffers[A]||(c.buffers[A]=null)}T=Promise.all(I)}return T.then(()=>{const I=[],A=x&&x.includes(Pb),M=x&&x.includes(sp);if(A&&I.push(function(){if(!Ms)return pd??(pd=function(k){let L,V=null;function j(){L=new Uint8Array(V.buffer)}function W(){throw new Error("Unexpected Draco error.")}const Q={a:{a:W,d:function(K,te,me){return L.copyWithin(K,te,te+me)},c:function(K){const te=L.length,me=Math.max(K>>>0,Math.ceil(1.2*te)),he=Math.ceil((me-te)/65536);try{return V.grow(he),j(),!0}catch{return!1}},b:W}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(k,Q):k.then(K=>K.arrayBuffer()).then(K=>WebAssembly.instantiate(K,Q))).then(K=>{const{Rb:te,Qb:me,P:he,T:fe,X:xe,Ja:Ee,La:Ve,Qa:Ce,Va:Ue,Wa:ot,eb:$e,jb:Ke,f:nt,e:ze,yb:Qe,zb:Ae,Ab:Be,Bb:at,Db:et,Gb:Ft}=K.instance.exports;V=ze;const St=(()=>{let Xe=0,tt=0,It=0,yt=0;return ft=>{It&&(te(yt),te(Xe),tt+=It,It=Xe=0),Xe||(tt+=128,Xe=me(tt));const xt=ft.length+7&-8;let zt=Xe;xt>=tt&&(It=xt,zt=yt=me(xt));for(let qt=0;qt<ft.length;qt++)L[zt+qt]=ft[qt];return zt}})();return j(),nt(),{memory:ze,_free:te,_malloc:me,Mesh:class{constructor(){this.ptr=he()}destroy(){fe(this.ptr)}},Decoder:class{constructor(){this.ptr=Ee()}destroy(){Ke(this.ptr)}DecodeArrayToMesh(Xe,tt,It){const yt=St(Xe),ft=Ve(this.ptr,yt,tt,It.ptr);return!!xe(ft)}GetAttributeByUniqueId(Xe,tt){return{ptr:Ce(this.ptr,Xe.ptr,tt)}}GetTrianglesUInt16Array(Xe,tt,It){Ue(this.ptr,Xe.ptr,tt,It)}GetTrianglesUInt32Array(Xe,tt,It){ot(this.ptr,Xe.ptr,tt,It)}GetAttributeDataArrayForAllPoints(Xe,tt,It,yt,ft){$e(this.ptr,Xe.ptr,tt.ptr,It,yt,ft)}},DT_INT8:Qe(),DT_UINT8:Ae(),DT_INT16:Be(),DT_UINT16:at(),DT_UINT32:et(),DT_FLOAT32:Ft()}})}(fetch(Ab())),pd.then(k=>{Ms=k,pd=void 0}))}()),M&&I.push(function(){if(d0)return;const k=function(L){let V;const j=WebAssembly.instantiateStreaming(L,{}).then(K=>{V=K.instance,V.exports.__wasm_call_ctors()}),W={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Q={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:j,supported:!0,decodeGltfBuffer(K,te,me,he,fe,xe){!function(Ee,Ve,Ce,Ue,ot,$e,Ke){const nt=Ee.exports.sbrk,ze=Ue+3&-4,Qe=nt(ze*ot),Ae=nt($e.length),Be=new Uint8Array(Ee.exports.memory.buffer);Be.set($e,Ae);const at=Ve(Qe,Ue,ot,Ae,$e.length);if(0===at&&Ke&&Ke(Qe,ze,ot),Ce.set(Be.subarray(Qe,Qe+Ue*ot)),nt(Qe-nt(0)),0!==at)throw new Error(`Malformed buffer data: ${at}`)}(V,V.exports[Q[fe]],K,te,me,he,V.exports[W[xe]])}}}(fetch(Mb()));return k.ready.then(()=>{d0=k})}()),m)for(let k=0;k<m.length;k++)I.push(f0(m[k],c,k,o));return(I.length?Promise.all(I):Promise.resolve()).then(()=>{if(A&&g)for(const{primitives:k}of g)for(const L of k)eg(L,c);if(M&&g&&w)for(const k of w)jE(k,c);return c})})}function ng(a){switch(a){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function ig(a){switch(a){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class jh{constructor(i,o,c,h){this.context=i,this.format=c,this.useMipmap=h&&h.useMipmap,this.texture=i.gl.createTexture(),this.update(o,{premultiply:h&&h.premultiply})}update(i,o){const c=i&&i instanceof HTMLVideoElement&&0===i.width?i.videoWidth:i.width,h=i&&i instanceof HTMLVideoElement&&0===i.height?i.videoHeight:i.height,{context:m}=this,{gl:g}=m,{x,y:w}=o&&o.position?o.position:{x:0,y:0},T=x+c,I=w+h;!this.size||this.size[0]===T&&this.size[1]===I||(g.bindTexture(g.TEXTURE_2D,null),g.deleteTexture(this.texture),this.texture=g.createTexture(),this.size=null),g.bindTexture(g.TEXTURE_2D,this.texture),m.pixelStoreUnpackFlipY.set(!1),m.pixelStoreUnpack.set(1),m.pixelStoreUnpackPremultiplyAlpha.set(this.format===g.RGBA8&&(!o||!1!==o.premultiply));const A=i instanceof HTMLImageElement||i instanceof HTMLCanvasElement||i instanceof HTMLVideoElement||i instanceof ImageData||ImageBitmap&&i instanceof ImageBitmap;if(!this.size&&T>0&&I>0){const M=this.useMipmap?Math.floor(Math.log2(Math.max(T,I)))+1:1;g.texStorage2D(g.TEXTURE_2D,M,this.format,T,I),this.size=[T,I]}if(this.size)if(A)g.texSubImage2D(g.TEXTURE_2D,0,x,w,ng(this.format),ig(this.format),i);else{const M=i.data;M&&g.texSubImage2D(g.TEXTURE_2D,0,x,w,c,h,ng(this.format),ig(this.format),M)}this.useMipmap&&g.generateMipmap(g.TEXTURE_2D)}bind(i,o,c=!1){const{context:h}=this,{gl:m}=h;m.bindTexture(m.TEXTURE_2D,this.texture),i!==this.minFilter&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,i),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,this.useMipmap&&!c?i===m.NEAREST?m.NEAREST_MIPMAP_NEAREST:m.LINEAR_MIPMAP_LINEAR:i),this.minFilter=i),o!==this.wrapS&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,o),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,o),this.wrapS=o)}bindExtraParam(i,o,c,h,m){const{context:g}=this,{gl:x}=g;x.bindTexture(x.TEXTURE_2D,this.texture),o!==this.magFilter&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,o),this.magFilter=o),i!==this.minFilter&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,this.useMipmap?i===x.NEAREST?x.NEAREST_MIPMAP_NEAREST:x.LINEAR_MIPMAP_LINEAR:i),this.minFilter=i),c!==this.wrapS&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,c),this.wrapS=c),h!==this.wrapT&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,h),this.wrapT=h),m!==this.compareMode&&(m?(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_COMPARE_MODE,x.COMPARE_REF_TO_TEXTURE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_COMPARE_FUNC,m)):x.texParameteri(x.TEXTURE_2D,x.TEXTURE_COMPARE_MODE,x.NONE),this.compareMode=m)}destroy(){const{gl:i}=this.context;i.deleteTexture(this.texture),this.texture=null}}class _d{constructor(i,o){this.context=i,this.texture=o}bind(i,o){const{context:c}=this,{gl:h}=c;h.bindTexture(h.TEXTURE_2D,this.texture),i!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,i),this.minFilter=i),o!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,o),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,o),this.wrapS=o)}}const ap=En([{name:"a_pos_3f",components:3,type:"Float32"}]),p0=En([{name:"a_color_3f",components:3,type:"Float32"}]),m0=En([{name:"a_color_4f",components:4,type:"Float32"}]),ey=En([{name:"a_uv_2f",components:2,type:"Float32"}]),SC=En([{name:"a_normal_3f",components:3,type:"Float32"}]),g0=En([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),rg=En([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function Rb(a,i){const o=ty(a.projection,a.zoom,a.width,a.height),c=function(m,g,x,w,T){const I=new O(x.lng-180*yd,x.lat),A=new O(x.lng+180*yd,x.lat),M=m.project(I.lng,I.lat),k=m.project(A.lng,A.lat),L=-Math.atan2(k.y-M.y,k.x-M.x),V=ue.fromLngLat(x);V.y=se(V.y,-1+yd,1-yd);const j=V.toLngLat(),W=m.project(j.lng,j.lat),Q=ue.fromLngLat(j);Q.x+=yd;const K=Q.toLngLat(),te=m.project(K.lng,K.lat),me=y0(te.x-W.x,te.y-W.y,L),he=ue.fromLngLat(j);he.y+=yd;const fe=he.toLngLat(),xe=m.project(fe.lng,fe.lat),Ee=y0(xe.x-W.x,xe.y-W.y,L),Ve=Math.abs(me.x)/Math.abs(Ee.y),Ce=fn([]);zl(Ce,Ce,-L*(1-(T?0:w)));const Ue=fn([]);return ro(Ue,Ue,[1,1-(1-Ve)*w,1]),Ue[4]=-Ee.x/Ee.y*w,zl(Ue,Ue,L),Ui(Ue,Ce,Ue),Ue}(a.projection,0,a.center,o,i),h=_0(a);return ro(c,c,[h,h,1]),c}function _0(a){const i=a.projection,o=ty(a.projection,a.zoom,a.width,a.height),c=og(i,a.center),h=og(i,O.convert(i.center));return Math.pow(2,c*o+(1-o)*h)}function ty(a,i,o,c,h=1/0){const m=a.range;if(!m)return 0;const g=Math.min(h,Math.max(o,c)),x=Math.log(g/1024)/Math.LN2;return be(m[0]+x,m[1]+x,i)}const yd=1/4e4;function og(a,i){const o=se(i.lat,-le,le),c=new O(i.lng-180*yd,o),h=new O(i.lng+180*yd,o),m=a.project(c.lng,o),g=a.project(h.lng,o),x=ue.fromLngLat(c),w=ue.fromLngLat(h),T=g.x-m.x,I=g.y-m.y,A=w.x-x.x,M=w.y-x.y,k=Math.sqrt((A*A+M*M)/(T*T+I*I));return Math.log(k)/Math.LN2}function y0(a,i,o){const c=Math.cos(o),h=Math.sin(o);return{x:a*c-i*h,y:a*h+i*c}}function Ob(a,i,o){fn(a),zl(a,a,Rn(i[2])),ys(a,a,Rn(i[0])),Ws(a,a,Rn(i[1])),ro(a,a,o),Ui(a,a,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function ny(a,i,o,c,h,m,g,x){const w=[o[0]-i[0],o[1]-i[1],0],T=[c[0]-i[0],c[1]-i[1],0];if(go(w)<1e-12||go(T)<1e-12)return Pa(a);const I=vi([],w,T);Mi(I,I),oo(T,c,i),w[2]=(m-h)*x,T[2]=(g-h)*x;const A=w;return vi(A,w,T),Mi(A,A),Au(a,I,A)}function Fb(a,i,o=!1){const c=lu(i.zoom),h=function(m,g,x){const w=g.worldSize,T=[m[12],m[13],m[14]],I=ee(T[1]/w),A=Y(T[0]/w),M=fn([]),k=G(1,I)*w,L=G(1,0)*w*pe(I,g.zoom),V=1/Zo(w);let j=L*V;if(x){const te=ty(g.projection,g.zoom,g.width,g.height,1024);j=V*g.projection.pixelSpaceConversion(g.center.lat,w,te)}const W=D(I,A);Fi(W,W,ki([],Mi([],W),k*j*T[2]));const Q=function(te){const me=[te[0],te[1],te[2]];let he=[0,1,0];const fe=vi([],he,me);return vi(he,me,fe),0===ff(he)&&(he=[0,1,0],vi(fe,me,he)),Mi(fe,fe),Mi(he,he),Mi(me,me),[fe[0],fe[1],fe[2],0,he[0],he[1],he[2],0,me[0],me[1],me[2],0,te[0],te[1],te[2],1]}(W);ro(M,M,[j,j,j*k]),jo(M,M,[-T[0],-T[1],-T[2]]);const K=Ui([],g.globeMatrix,Q);return Ui(K,K,M),Ui(K,K,m),K}(a,i,o);return c>0?function(g,x,w){const T=(L,V,j)=>{const W=go(L),Q=go(V),K=au(L,V,j);return ki(K,K,1/go(K)*Nt(W,Q,j))},I=T([g[0],g[1],g[2]],[x[0],x[1],x[2]],w),A=T([g[4],g[5],g[6]],[x[4],x[5],x[6]],w),M=T([g[8],g[9],g[10]],[x[8],x[9],x[10]],w),k=au([g[12],g[13],g[14]],[x[12],x[13],x[14]],w);return[I[0],I[1],I[2],0,A[0],A[1],A[2],0,M[0],M[1],M[2],0,k[0],k[1],k[2],1]}(h,function(g,x){const w=x.worldSize,T=G(1,0)*w*pe(x.center.lat,x.zoom)/Zo(w),I=G(1,x.center.lat)*w,A=fn([]);return Ws(A,A,Rn(x.center.lng)),ys(A,A,Rn(x.center.lat)),jo(A,A,[0,0,Zi]),ro(A,A,[T,T,T*I]),jo(A,A,[x.point.x-.5*w,x.point.y-.5*w,0]),Ui(A,A,g),Ui(A,x.globeMatrix,A)}(a,i),c):h}function kb(a,i,o,c){const h=sn.projectAabbCorners(c,o);let m=Number.MAX_VALUE,g=-1;for(let T=0;T<h.length;++T){const I=h[T];I[0]=(.5*I[0]+.5)*i.width,I[1]=(.5-.5*I[1])*i.height,I[2]<m&&(g=T,m=I[2])}const x=T=>new Je(h[T][0],h[T][1]);let w;switch(g){case 0:case 6:w=[x(1),x(5),x(4),x(7),x(3),x(2),x(1)];break;case 1:case 7:w=[x(0),x(4),x(5),x(6),x(2),x(3),x(0)];break;case 3:case 5:w=[x(1),x(0),x(4),x(7),x(6),x(2),x(1)];break;default:w=[x(1),x(5),x(6),x(7),x(3),x(0),x(1)]}if(di(a,w))return m}const vd={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Lb(a,i,o,c,h,m,g,x,w,T=!1){const I=o.zoom,A=o.project(c),M=pe(c.lat,I),k=1/M;fn(a),jo(a,a,[A.x+g[0]*k,A.y+g[1]*k,g[2]]);let L=1,V=1;const j=o.worldSize;if(T){if("mercator"===o.projection.name){let te=0;o.elevation&&(te=o.elevation.getAtPointOrZero(new ue(A.x/j,A.y/j),0));const me=xs([],[A.x,A.y,te,1],o.projMatrix)[3]/o.cameraToCenterDistance;L=me,V=me*pe(o.center.lat,I)}else if("globe"===o.projection.name){const te=Fb(a,o),me=[0,0,0,1];xs(me,me,Ui([],o.projMatrix,te));const he=me[3]/o.cameraToCenterDistance,fe=lu(I),xe=o.projection.pixelsPerMeter(c.lat,j)*pe(c.lat,I),Ee=o.projection.pixelsPerMeter(o.center.lat,j)*pe(o.center.lat,I);L=he/Nt(xe,de(o.center.lat),fe),V=he*M/xe,L*=Ee,V*=Ee}}else L=k;ro(a,a,[L,L,V]);const W=[...a],Q=i.orientation,K=[];if(Ob(K,[Q[0]+h[0],Q[1]+h[1],Q[2]+h[2]],m),Ui(a,W,K),x&&o.elevation){let te=0;const me=[];if(w&&o.elevation){te=function(fe,xe,Ee,Ve,Ce){const Ue=xe.elevation;if(!Ue)return 0;const ot=sn.projectAabbCorners(Ee,Ve),$e=G(1,Ce.lat)*xe.worldSize,Ke=function(tt,It){const yt=[0,0,1],ft=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const xt of ft){const zt=tt[xt.corners[0]],qt=tt[xt.corners[1]],rn=tt[xt.corners[2]],Kt=[qt[0]-zt[0],qt[1]-zt[1],It*(qt[2]-zt[2])],vn=vi(Kt,Kt,[rn[0]-zt[0],rn[1]-zt[1],It*(rn[2]-zt[2])]);Mi(vn,vn),xt.dotProductWithUp=ar(vn,yt)}return ft.sort((xt,zt)=>xt.dotProductWithUp-zt.dotProductWithUp),ft[0].corners}(ot,$e),nt=ot[Ke[0]],ze=ot[Ke[1]],Qe=ot[Ke[2]],Ae=ot[Ke[3]],Be=Ue.getAtPointOrZero(new ue(nt[0]/xe.worldSize,nt[1]/xe.worldSize),0),at=Ue.getAtPointOrZero(new ue(ze[0]/xe.worldSize,ze[1]/xe.worldSize),0),et=Ue.getAtPointOrZero(new ue(Qe[0]/xe.worldSize,Qe[1]/xe.worldSize),0),Ft=Ue.getAtPointOrZero(new ue(Ae[0]/xe.worldSize,Ae[1]/xe.worldSize),0),St=(Be+Ft)/2,Xe=(at+et)/2;return St>Xe?at<et?ny(fe,ze,Ae,nt,at,Ft,Be,$e):ny(fe,Qe,nt,Ae,et,Be,Ft,$e):Be<Ft?ny(fe,nt,ze,Qe,Be,at,et,$e):ny(fe,Ae,Qe,ze,Ft,et,at,$e),Math.max(St,Xe)}(me,o,i.aabb,a,c);const he=Ui([],Ia([],me),K);Ui(a,W,he)}else te=o.elevation.getAtPointOrZero(new ue(A.x/j,A.y/j),0);0!==te&&(a[14]+=te)}}function lp(a,i,o=!1){a.uploaded||(a.gfxTexture=new jh(i,a.image,o?i.gl.R8:i.gl.RGBA8,{useMipmap:a.sampler.minFilter>=i.gl.NEAREST_MIPMAP_NEAREST}),a.uploaded=!0,a.image=null)}function v0(a,i,o){a.indexBuffer=i.createIndexBuffer(a.indexArray,!1,!0),a.vertexBuffer=i.createVertexBuffer(a.vertexArray,ap.members,!1,!0),a.normalArray&&(a.normalBuffer=i.createVertexBuffer(a.normalArray,SC.members,!1,!0)),a.texcoordArray&&(a.texcoordBuffer=i.createVertexBuffer(a.texcoordArray,ey.members,!1,!0)),a.colorArray&&(a.colorBuffer=i.createVertexBuffer(a.colorArray,(12===a.colorArray.bytesPerElement?p0:m0).members,!1,!0)),a.featureArray&&(a.pbrBuffer=i.createVertexBuffer(a.featureArray,rg.members,!0)),a.segments=Wi.simpleSegment(0,0,a.vertexArray.length,a.indexArray.length);const c=a.material;c.pbrMetallicRoughness.baseColorTexture&&lp(c.pbrMetallicRoughness.baseColorTexture,i),c.pbrMetallicRoughness.metallicRoughnessTexture&&lp(c.pbrMetallicRoughness.metallicRoughnessTexture,i),c.normalTexture&&lp(c.normalTexture,i),c.occlusionTexture&&lp(c.occlusionTexture,i,o),c.emissionTexture&&lp(c.emissionTexture,i)}function cp(a,i,o){if(a.meshes)for(const c of a.meshes)v0(c,i,o);if(a.children)for(const c of a.children)cp(c,i,o)}function iy(a){if(a.meshes)for(const i of a.meshes)i.indexArray.destroy(),i.vertexArray.destroy(),i.colorArray&&i.colorArray.destroy(),i.normalArray&&i.normalArray.destroy(),i.texcoordArray&&i.texcoordArray.destroy(),i.featureArray&&i.featureArray.destroy();if(a.children)for(const i of a.children)iy(i)}function ry(a){if(a.meshes)for(const o of a.meshes)o.vertexBuffer&&(o.vertexBuffer.destroy(),o.indexBuffer.destroy(),o.normalBuffer&&o.normalBuffer.destroy(),o.texcoordBuffer&&o.texcoordBuffer.destroy(),o.colorBuffer&&o.colorBuffer.destroy(),o.pbrBuffer&&o.pbrBuffer.destroy(),o.segments.destroy(),o.material&&((i=o.material).pbrMetallicRoughness.baseColorTexture&&i.pbrMetallicRoughness.baseColorTexture.gfxTexture&&i.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),i.pbrMetallicRoughness.metallicRoughnessTexture&&i.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&i.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),i.normalTexture&&i.normalTexture.gfxTexture&&i.normalTexture.gfxTexture.destroy(),i.emissionTexture&&i.emissionTexture.gfxTexture&&i.emissionTexture.gfxTexture.destroy(),i.occlusionTexture&&i.occlusionTexture.gfxTexture&&i.occlusionTexture.gfxTexture.destroy()));var i;if(a.children)for(const o of a.children)ry(o)}function Uh(a,i){const o=a.json.bufferViews[i.bufferView],c=Bh[i.componentType];return new c(a.buffers[o.buffer],(i.byteOffset||0)+(o.byteOffset||0),i.count*(o.byteStride&&o.byteStride!==op[i.type]*c.BYTES_PER_ELEMENT?o.byteStride/c.BYTES_PER_ELEMENT:op[i.type]))}function oy(a,i,o,c){const h=Bh[i.componentType],m=function(I){switch(I){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(h),g=a.json.bufferViews[i.bufferView],x=g.byteStride?g.byteStride/h.BYTES_PER_ELEMENT:op[i.type],w=o.float32,T=w.length/o.capacity;for(let I=0,A=0;I<i.count*x;I+=x,A+=T)for(let M=0;M<T;M++)w[A+M]=c[I+M]*m;o._trim()}function CC(a,i,o){const c=a.indices,h=a.attributes,m={};m.indexArray=new Pi;const g=i.json.accessors[c],x=g.count/3;m.indexArray.reserve(x);const w=Uh(i,g);for(let M=0;M<x;M++)m.indexArray.emplaceBack(w[3*M],w[3*M+1],w[3*M+2]);m.indexArray._trim(),m.vertexArray=new Ss;const T=i.json.accessors[h.POSITION];m.vertexArray.reserve(T.count);const I=Uh(i,T);for(let M=0;M<T.count;M++)m.vertexArray.emplaceBack(I[3*M],I[3*M+1],I[3*M+2]);if(m.vertexArray._trim(),m.aabb=new sn(T.min,T.max),m.centroid=function(M,k){const L=[0,0,0],V=M.length;if(V>0){for(let j=0;j<V;j++){const W=3*M[j];L[0]+=k[W],L[1]+=k[W+1],L[2]+=k[W+2]}L[0]/=V,L[1]/=V,L[2]/=V}return L}(w,I),void 0!==h.COLOR_0){const M=i.json.accessors[h.COLOR_0],k=op[M.type],L=Uh(i,M);m.colorArray=3===k?new Ss:new Ba,m.colorArray.resize(M.count),oy(i,M,m.colorArray,L)}if(void 0!==h.NORMAL){m.normalArray=new Ss;const M=i.json.accessors[h.NORMAL];m.normalArray.resize(M.count);const k=Uh(i,M);oy(i,M,m.normalArray,k)}if(void 0!==h.TEXCOORD_0&&o.length>0){m.texcoordArray=new lc;const M=i.json.accessors[h.TEXCOORD_0];m.texcoordArray.resize(M.count);const k=Uh(i,M);oy(i,M,m.texcoordArray,k)}if(void 0!==h._FEATURE_ID_RGBA4444){const M=i.json.accessors[h._FEATURE_ID_RGBA4444];i.json.extensionsUsed&&i.json.extensionsUsed.includes("EXT_meshopt_compression")&&(m.featureData=Uh(i,M))}void 0!==h._FEATURE_RGBA4444&&(m.featureData=new Uint32Array(Uh(i,i.json.accessors[h._FEATURE_RGBA4444]).buffer));const A=a.material;return m.material=function(M,k){const{emissiveFactor:L=[0,0,0],alphaMode:V="OPAQUE",alphaCutoff:j=.5,normalTexture:W,occlusionTexture:Q,emissiveTexture:K,doubleSided:te}=M,{baseColorFactor:me=[1,1,1,1],metallicFactor:he=1,roughnessFactor:fe=1,baseColorTexture:xe,metallicRoughnessTexture:Ee}=M.pbrMetallicRoughness||{},Ve=Q?k[Q.index]:void 0;if(Q&&Q.extensions&&Q.extensions.KHR_texture_transform&&Ve){const Ce=Q.extensions.KHR_texture_transform;Ve.offsetScale=[Ce.offset[0],Ce.offset[1],Ce.scale[0],Ce.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Kn(...me),metallicFactor:he,roughnessFactor:fe,baseColorTexture:xe?k[xe.index]:void 0,metallicRoughnessTexture:Ee?k[Ee.index]:void 0},doubleSided:te,emissiveFactor:new Kn(...L),alphaMode:V,alphaCutoff:j,normalTexture:W?k[W.index]:void 0,occlusionTexture:Ve,emissionTexture:K?k[K.index]:void 0,defined:void 0===M.defined}}(void 0!==A?i.json.materials[A]:{defined:!1},o),m}function Nb(a,i,o){const{matrix:c,rotation:h,translation:m,scale:g,mesh:x,extras:w,children:T}=a,I={};if(I.matrix=c||(k=m||[0,0,0],he=(V=(M=h||[0,0,0,1])[0])*(K=V+V),fe=V*(te=(j=M[1])+j),xe=V*(me=(W=M[2])+W),Ve=j*me,Ue=(Q=M[3])*K,ot=Q*te,$e=Q*me,nt=(L=g||[1,1,1])[1],ze=L[2],(A=[])[0]=(1-((Ee=j*te)+(Ce=W*me)))*(Ke=L[0]),A[1]=(fe+$e)*Ke,A[2]=(xe-ot)*Ke,A[3]=0,A[4]=(fe-$e)*nt,A[5]=(1-(he+Ce))*nt,A[6]=(Ve+Ue)*nt,A[7]=0,A[8]=(xe+ot)*ze,A[9]=(Ve-Ue)*ze,A[10]=(1-(he+Ee))*ze,A[11]=0,A[12]=k[0],A[13]=k[1],A[14]=k[2],A[15]=1,A),void 0!==x){I.meshes=o[x];const A=I.anchor=[0,0];for(const M of I.meshes){const{min:k,max:L}=M.aabb;A[0]+=k[0]+L[0],A[1]+=k[1]+L[1]}A[0]=Math.floor(A[0]/I.meshes.length/2),A[1]=Math.floor(A[1]/I.meshes.length/2)}var A,M,k,L,V,j,W,Q,K,te,me,he,fe,xe,Ee,Ve,Ce,Ue,ot,$e,Ke,nt,ze;if(w&&(w.id&&(I.id=w.id),w.lights&&(I.lights=function(A){if(!A.length)return[];const M=function(W){const Q=atob(W),K=new Uint8Array(Q.length);for(let te=0;te<Q.length;te++)K[te]=Q.codePointAt(te);return K}(A),k=[],L=M.length/24,V=new Uint16Array(M.buffer),j=new Float32Array(M.buffer);for(let W=0;W<L;W++){const Q=V[2*W*6]/30,K=V[2*W*6+1]/30,te=V[2*W*6+10]/100,me=j[6*W+1],he=j[6*W+2],fe=j[6*W+3],xe=j[6*W+4],Ee=fe-me,Ve=xe-he,Ce=Math.hypot(Ee,Ve);k.push({pos:[me+.5*Ee,he+.5*Ve,K],normal:[Ve/Ce,-Ee/Ce,0],width:Ce,height:Q,depth:te,points:[me,he,fe,xe]})}return k}(w.lights))),T){const A=[];for(const M of T)A.push(Nb(i.json.nodes[M],i,o));I.children=A}return I}function up(a){if(0===a.vertices.length||0===a.indices.length)return null;const i=new Zm(a.vertices,a.indices,8,256),[o,c]=[i.min.clone(),i.max.clone()];return{vertices:a.vertices,indices:a.indices,grid:i,min:o,max:c}}function $E(a){if(!a.extras||!a.extras.ground)return null;const i=a.extras.ground;if(!i||!Array.isArray(i)||0===i.length)return null;const o=i[0];if(!o||!Array.isArray(o)||0===o.length)return null;const c=[];for(const g of o){if(!Array.isArray(g)||2!==g.length)continue;const x=g[0],w=g[1];"number"==typeof x&&"number"==typeof w&&c.push(new Je(x,w))}if(c.length<3)return null;c.length>1&&c[c.length-1].equals(c[0])&&c.pop();let h=0;for(let g=0;g<c.length;g++){const x=c[g],w=c[(g+1)%c.length],T=c[(g+2)%c.length];h+=(x.x-w.x)*(T.y-w.y)-(T.x-w.x)*(x.y-w.y)}h>0&&c.reverse();const m=Sh(c.flatMap(g=>[g.x,g.y]),[]);return 0===m.length?null:{vertices:c,indices:m}}function dp(a,i){const o=[],c=[];let h=0;const m=[];for(const g of a){h=o.length;const x=g.vertexArray.float32,w=g.indexArray.uint16;for(let T=0;T<g.vertexArray.length;T++)m[0]=x[3*T+0],m[1]=x[3*T+1],m[2]=x[3*T+2],lr(m,m,i),o.push(new Je(m[0],m[1]));for(let T=0;T<3*g.indexArray.length;T++)c.push(w[T]+h)}if(c.length%3!=0)return null;for(let g=0;g<c.length;g+=3){const x=o[c[g+0]],w=o[c[g+1]],T=o[c[g+2]];(x.x-w.x)*(T.y-w.y)-(T.x-w.x)*(x.y-w.y)>0&&([c[g+1],c[g+2]]=[c[g+2],c[g+1]])}return{vertices:o,indices:c}}function Xo(a){const o=function(w,T){const I=[];for(const A of w.json.meshes){const M=[];for(const k of A.primitives)M.push(CC(k,w,T));I.push(M)}return I}(a,function(w,T){const I=[],A=WebGL2RenderingContext;if(w.json.textures)for(const M of w.json.textures){const k={magFilter:A.LINEAR,minFilter:A.NEAREST,wrapS:A.REPEAT,wrapT:A.REPEAT};void 0!==M.sampler&&Object.assign(k,w.json.samplers[M.sampler]),I.push({image:T[M.source],sampler:k,uploaded:!1})}return I}(a,a.images)),{scenes:c,scene:h,nodes:m}=a.json,g=c?c[h||0].nodes:m,x=[];for(const w of g)x.push(Nb(m[w],a,o));return function(w,T,I){const A={},M=new Set;for(let k=0;k<w.length;k++){const L=I[T[k]];if(!L.extras)continue;const V=L.extras["mapbox:footprint:version"],j=L.extras["mapbox:footprint:id"];(V||j)&&M.add(k),"1.0.0"===V&&j&&(A[j]=k)}for(let k=0;k<w.length;k++){if(M.has(k))continue;const L=w[k],V=I[T[k]];if(!V.extras)continue;let j=null;L.id in A&&(j=dp(w[A[L.id]].meshes,L.matrix)),j||(j=$E(V)),j&&(L.footprint=up(j))}if(M.size>0){const k=Array.from(M.values()).sort((L,V)=>L-V);for(let L=k.length-1;L>=0;L--)w.splice(k[L],1)}}(x,g,a.json.nodes),x}function qE(a){a.heightmap=new Float32Array(4096),a.heightmap.fill(-1);const i=a.vertexArray.float32,o=a.aabb.min[0]-1,c=a.aabb.min[1]-1,h=64/(a.aabb.max[0]-o+2),m=64/(a.aabb.max[1]-c+2);for(let g=0;g<i.length;g+=3){const x=i[g+2],w=(i[g+0]-o)*h|0,T=(i[g+1]-c)*m|0;x>a.heightmap[64*T+w]&&(a.heightmap[64*T+w]=x)}}function hp(a,i,o,c,h){o.reserve(o.length+4*a.length),c.reserve(c.length+10*a.length),h.reserve(h.length+10*a.length);let m=c.length;for(const g of a){const x=Math.min(10,Math.max(4,1.3*g.height))*i,w=[-g.normal[1],g.normal[0],0],T=Math.min(.29,.1*g.width/g.depth),I=g.width-2*g.depth*i*(T+.01),A=Uo([],g.pos,w,I/2),M=Uo([],g.pos,w,-I/2),k=[A[0],A[1],A[2]+g.height],L=[M[0],M[1],M[2]+g.height],V=Uo([],g.normal,w,T);ki(V,V,x);const j=Uo([],g.normal,w,-T);ki(j,j,x),Fi(V,A,V),Fi(j,M,j),A[2]+=.1,M[2]+=.1,c.emplaceBack(V[0],V[1],V[2]),c.emplaceBack(j[0],j[1],j[2]),c.emplaceBack(A[0],A[1],A[2]),c.emplaceBack(M[0],M[1],M[2]),c.emplaceBack(k[0],k[1],k[2]),c.emplaceBack(L[0],L[1],L[2]),c.emplaceBack(A[0],A[1],A[2]),c.emplaceBack(M[0],M[1],M[2]),c.emplaceBack(V[0],V[1],V[2]),c.emplaceBack(j[0],j[1],j[2]);const W=I/x/2;h.emplaceBack(-W-T,-1,W,.8),h.emplaceBack(W+T,-1,W,.8),h.emplaceBack(-W,0,W,1.3),h.emplaceBack(W,0,W,1.3),h.emplaceBack(W+T,-.8,W,.7),h.emplaceBack(W+T,-.8,W,.7),h.emplaceBack(0,0,W,1.3),h.emplaceBack(0,0,W,1.3),h.emplaceBack(W+T,-1.2,W,.8),h.emplaceBack(W+T,-1.2,W,.8),o.emplaceBack(6+m,4+m,8+m),o.emplaceBack(7+m,9+m,5+m),o.emplaceBack(0+m,1+m,2+m),o.emplaceBack(1+m,3+m,2+m),m+=10}}function Hh(a,i){const o={};o.indexArray=new Pi,o.vertexArray=new Ss,o.colorArray=new Ba,hp(a,i,o.indexArray,o.vertexArray,o.colorArray);const c={defined:!0};c.emissiveFactor=Kn.black;const h={};return h.baseColorFactor=Kn.white,c.pbrMetallicRoughness=h,o.material=c,o.aabb=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),o}const zb=En([{name:"a_pos_3f",components:3,type:"Float32"}]),WE=En([{name:"a_normal_3",components:3,type:"Int16"}]),Gh=En([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),ZE=En([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),sy=Re.types;function x0(a,i){const o=ht+i;for(const c of a)for(const h of c)if(h.x<-i||h.x>o||h.y<-i||h.y>o)return!1;return!0}class b0{constructor(i){this.layoutAOArray=[],this.indexArrayForConflationUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.footprintLookup={},this.zoom=i.zoom,this.canonical=i.canonical,this.layers=i.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=i.index,this.hasPattern=!1,this.worldview=i.worldview,this.layoutVertexArray=new Ss,this.layoutNormalArray=new Kc,this.layoutColorArray=new va,this.indexArray=new Pi,this.indexArrayForConflation=new Pi,this.entranceBloom={layoutVertexArray:new Ss,layoutVertexBuffer:null,layoutAttenuationArray:new Ba,layoutAttenuationBuffer:null,layoutColorArray:new va,layoutColorBuffer:null,indexArray:new Pi,indexArrayForConflation:new Pi,indexBuffer:null,segmentsBucket:new Wi},this.programConfigurations=new Cs(i.layers,{zoom:i.zoom,lut:i.lut}),this.segmentsBucket=new Wi,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.projection=i.projection,this.groundEffect=new r0(i)}get segments(){return this.segmentsBucket}get bloomGeometry(){return this.entranceBloom}updateFootprints(i,o){for(const c of this.footprints)o.push({footprint:c,id:i})}prepare(){return function(){if(null!=Q_||null!=zh)return null;if(null!=Nh)return Nh;const i=fetch(so.BUILDING_GEN_URL);return Nh=function(o){let c,h,m,g;function x(){c=new Uint8Array(g.buffer),h=new Int32Array(g.buffer),m=new Float32Array(g.buffer)}function w(){throw new Error("Unexpected BuildingGen error.")}const T=()=>{},I={a:{a:w,f:function(A){const M=c.length,k=Math.max(A>>>0,Math.ceil(1.2*M)),L=Math.ceil((k-M)/65536);try{return g.grow(L),x(),!0}catch{return!1}},g:w,b:T,c:T,d:T,e:T}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(o,I):o.then(A=>A.arrayBuffer()).then(A=>WebAssembly.instantiate(A,I))).then(A=>{const M=A.instance.exports;return(0,M.g)(),g=M.f,x(),new u0({setStyle:M.h,setAOOptions:M.i,setMetricOptions:M.j,setStructuralOptions:M.k,setFacadeOptions:M.l,setFauxFacadeOptions:M.m,setFacadeClassifierOptions:M.n,addFeature:M.o,addFacade:M.p,generateMesh:M.q,getLastError:M.r,getMeshCount:M.s,getPositionsPtr:M.t,getPositionsLength:M.u,getNormalsPtr:M.v,getNormalsLength:M.w,getColorsPtr:M.x,getColorsLength:M.y,getAOPtr:M.z,getAOLength:M.A,getUVPtr:M.B,getUVLength:M.C,getFauxFacadePtr:M.D,getFauxFacadeLength:M.E,getIndicesPtr:M.F,getIndicesLength:M.G,getBuildingPart:M.H,getRingCount:M.I,getRingPtr:M.J,getRingLength:M.K,free:M.L,malloc:M.M,heapU8:c,heap32:h,heapF32:m})})}(i).then(o=>(Nh=null,Q_=o,Q_)).catch(o=>{yn("Could not load building-gen"),Nh=null,zh=o}),Nh}()}populate(i,o,c,h){const m=function h0(){return Q_}();if(!m)return;const g=ce(c);this.tileToMeter=g,this.brightness=o.brightness,m.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,g],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:g,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),m.setAOOptions(!1,.3),m.setMetricOptions(!1,16),m.setStructuralOptions(!0),m.setFacadeOptions(4,!0),m.setFauxFacadeOptions(!1,!1,1),m.setFacadeClassifierOptions(3);const x=new Map;for(const{feature:w}of i){if("LineString"!==sy[w.type])continue;const T=this.layers[0]._featureFilter.needGeometry,I=Ne(w,T);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom),I,c))continue;const A=T?I.geometry:_e(w,c,h),M=[];for(const j of A)for(const W of j)M.push({x:W.x,y:W.y});const k={coordinates:M,crossPerc:w.properties.cross_perc,distanceToRoad:w.properties.distance_to_road,entrances:w.properties.entrances,sourceId:0},L=w.properties.source_id;let V=x.get(L);V||(V=[],x.set(L,V)),V.push(k)}this.maxHeight=0;for(const{feature:w,index:T}of i){if("LineString"===sy[w.type])continue;const I=this.layers[0]._featureFilter.needGeometry,A=Ne(w,I);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom),A,c))continue;const M=I?A.geometry:_e(w,c,h),k=Ph(M,500);if(!x0(M,163))continue;const L=this.layers[0],V=L.layout.get("building-base").evaluate(w,{},c),j=L.layout.get("building-height").evaluate(w,{},c),W=L.layout.get("building-roof-shape").evaluate(w,{},c),Q=L.paint.get("building-ambient-occlusion-intensity"),K=L.paint.get("building-ambient-occlusion-ground-radius")/this.tileToMeter;if("flat"===W)continue;const te=w.properties.source_id;let me;me=x.has(te)?x.get(te):[];const he=[],fe=new Je(1/0,1/0),xe=new Je(-1/0,-1/0);for(const Xe of k)if(Xe.length>0){const tt=[];for(const It of Xe){const yt=[];for(let ft=It.length-1;ft>=0;ft--){const xt=It[ft];yt.push({x:xt.x,y:xt.y}),fe.x=Math.min(fe.x,xt.x),fe.y=Math.min(fe.y,xt.y),xe.x=Math.max(xe.x,xt.x),xe.y=Math.max(xe.y,xt.y)}tt.push(yt)}he.push({id:w.id,height:j,minHeight:V,sourceId:0,roofType:W,coordinates:tt})}const Ee=m.generateMesh(he,me);if("string"==typeof Ee||0===Ee.meshes.length||0===Ee.modifiedPolygonRings.length)continue;let Ve=0;for(const Xe of Ee.meshes)Ve+=Xe.positions.length/3;const Ce=this.segmentsBucket.prepareSegment(Ve,this.layoutVertexArray,this.indexArray),Ue=[];let ot=null,$e=0,Ke=-1;const nt=this.indexArray.length;let ze=0;for(const Xe of Ee.meshes){const tt=this.layoutVertexArray.length;if("entrance"===Xe.buildingPart){const yt=new Array;for(let qt=0;qt<Xe.indices.length;qt+=12){const rn=Xe.positions[qt+0],Kt=Xe.positions[qt+1],vn=Xe.positions[qt+3],dn=Xe.positions[qt+4],ii=Xe.positions[qt+2],ie=Xe.positions[qt+8]-ii,re=1,Le=vn-rn,lt=dn-Kt,ut=Math.hypot(Le,lt);yt.push({pos:[rn+.5*Le,Kt+.5*lt,ii],normal:[lt/ut,-Le/ut,0],width:ut,height:ie,depth:re,points:[rn,Kt,vn,dn]})}const ft=this.entranceBloom.segmentsBucket.prepareSegment(10*yt.length,this.entranceBloom.layoutVertexArray,this.entranceBloom.indexArray),xt=this.entranceBloom.layoutVertexArray.length;$e=this.entranceBloom.indexArray.length,hp(yt,.5/this.tileToMeter,this.entranceBloom.indexArray,this.entranceBloom.layoutVertexArray,this.entranceBloom.layoutAttenuationArray);const zt=this.entranceBloom.layoutVertexArray.length-xt;Ke=this.entranceBloom.indexArray.length-$e;for(let qt=0;qt<zt;qt++)this.entranceBloom.layoutColorArray.emplaceBack(65535,65535);ft.vertexLength+=zt,ft.primitiveLength+=Ke,ot={part:Xe.buildingPart,vertexOffset:xt,vertexLength:zt}}for(let yt=0;yt<Xe.positions.length;yt+=3)ze=Math.max(ze,Xe.positions[yt+2]),this.layoutVertexArray.emplaceBack(Xe.positions[yt],Xe.positions[yt+1],Xe.positions[yt+2]);for(let yt=0;yt<Xe.normals.length;yt+=3)this.layoutNormalArray.emplaceBack(32767*Xe.normals[yt+0],32767*Xe.normals[yt+1],32767*Xe.normals[yt+2]);for(let yt=0;yt<Xe.ao.length;yt++)this.layoutAOArray.push(Xe.ao[yt]);for(let yt=0;yt<Xe.colors.length;yt+=3){const ft=1+(Xe.ao[yt/3]-1)*Q;this.layoutColorArray.emplaceBack(Xe.colors[yt]*ft<<8|Xe.colors[yt+1]*ft,Xe.colors[yt+2]*ft<<8)}const It=Ce.vertexLength;for(let yt=0;yt<Xe.indices.length;yt+=3)this.indexArray.emplaceBack(It+Xe.indices[yt],It+Xe.indices[yt+1],It+Xe.indices[yt+2]);Ce.vertexLength+=Xe.positions.length/3,Ce.primitiveLength+=Xe.indices.length/3,("roof"===Xe.buildingPart||"wall"===Xe.buildingPart||"facade_glazing"===Xe.buildingPart||"entrance"===Xe.buildingPart)&&Ue.push({part:Xe.buildingPart,vertexOffset:tt,vertexLength:Xe.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,ze),this.buildingFeatures.push({feature:A,segment:Ce,parts:Ue,buildingBloom:ot});const Qe=this.indexArray.length-nt,Ae=[],Be=[],at=new Je(1/0,1/0),et=new Je(-1/0,-1/0),Ft=this.groundEffect.vertexArray.length;for(const Xe of Ee.modifiedPolygonRings){const tt=[],It=new Je(1/0,1/0),yt=new Je(-1/0,-1/0);for(let ft=0;ft<Xe.length;ft+=2){const xt=Xe.length-ft-2;It.x=Math.min(It.x,Xe[xt]),It.y=Math.min(It.y,Xe[xt+1]),yt.x=Math.max(yt.x,Xe[xt]),yt.y=Math.max(yt.y,Xe[xt+1]);const zt=new Je(Xe[xt],Xe[xt+1]);tt.push(zt),Ae.push(zt.x,zt.y),Be.push(zt.clone())}at.x=Math.min(at.x,It.x),at.y=Math.min(at.y,It.y),et.x=Math.max(et.x,yt.x),et.y=Math.max(et.y,yt.y),this.groundEffect.addData(tt,[It,yt],K)}const St=this.groundEffect.vertexArray.length-Ft;(fe.x<0||xe.x>ht||fe.y<0||xe.y>ht)&&this.featuresOnBorder.push({featureId:w.id,footprintIndex:this.footprints.length});{const Xe=Sh(Ae,null,2),tt=new Zm(Be,Xe,8,256);let It=w.id;w.properties&&w.properties.hasOwnProperty("building_id")&&(It=w.properties.building_id),this.footprints.push({vertices:Be,indices:Xe,grid:tt,min:at,max:et,buildingId:It,hiddenFlags:0,indicesOffset:nt,indicesLength:Qe,bloomIndicesOffset:$e,bloomIndicesLength:Ke,groundEffectVertexOffset:Ft,groundEffectVertexLength:St,segment:Ce,height:ze})}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,w,T,{},o.availableImages,c,o.brightness),this.groundEffect.addPaintPropertiesData(w,T,{},o.availableImages,c,o.brightness)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0])}update(i,o,c,h,m,g,x){this.programConfigurations.updatePaintArrays(i,o,m,c,h,g,x),this.groundEffect.update(i,o,m,c,h,g,x)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(i){this.uploaded||(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,zb.members),this.layoutNormalBuffer=i.createVertexBuffer(this.layoutNormalArray,WE.members),this.entranceBloom.layoutVertexBuffer=i.createVertexBuffer(this.entranceBloom.layoutVertexArray,zb.members),this.entranceBloom.layoutAttenuationBuffer=i.createVertexBuffer(this.entranceBloom.layoutAttenuationArray,ZE.members),this.uploadUpdatedColorBuffer(i),this.uploadUpdatedIndexBuffer(i),this.groundEffect.upload(i)),this.groundEffect.uploadPaintProperties(i),this.programConfigurations.upload(i),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.layoutNormalBuffer.destroy(),this.layoutColorBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segmentsBucket.destroy(),this.entranceBloom.layoutVertexBuffer.destroy(),this.entranceBloom.layoutColorBuffer.destroy(),this.entranceBloom.layoutAttenuationBuffer.destroy(),this.entranceBloom.indexBuffer.destroy(),this.entranceBloom.segmentsBucket.destroy())}updateFootprintHiddenFlags(i,o,c=!0){let h=!1;const m=c?o:0,g=0|(c?-1:~o);0===this.groundEffect.hiddenByLandmarkVertexArray.length&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const x of i){const w=this.footprints[x],T=w.hiddenFlags&g|m;w.hiddenFlags!==T&&(w.hiddenFlags=T,h=!0,this.groundEffect.updateHiddenByLandmarkRange(w.groundEffectVertexOffset,w.groundEffectVertexLength,0!==w.hiddenFlags))}return h&&(this.indexArrayForConflationUploaded=!1),h}uploadUpdatedIndexBuffer(i){if(this.groundEffect.uploadHiddenByLandmark(i),!this.indexArrayForConflationUploaded&&0!==this.indexArray.length){this.indexArrayForConflation.resize(this.indexArray.length),this.indexArrayForConflation.uint16.set(this.indexArray.uint16),this.entranceBloom.indexArrayForConflation.resize(this.entranceBloom.indexArray.length),this.entranceBloom.indexArrayForConflation.uint16.set(this.entranceBloom.indexArray.uint16);for(const o of this.footprints){const c=o.indicesOffset+o.indicesLength;if(0!==o.hiddenFlags){for(let m=o.indicesOffset;m<c;m++)this.indexArrayForConflation.uint16[3*m+0]=0,this.indexArrayForConflation.uint16[3*m+1]=0,this.indexArrayForConflation.uint16[3*m+2]=0;const h=o.bloomIndicesOffset+o.bloomIndicesLength;for(let m=o.bloomIndicesOffset;m<h;m++)this.entranceBloom.indexArrayForConflation.uint16[3*m+0]=0,this.entranceBloom.indexArrayForConflation.uint16[3*m+1]=0,this.entranceBloom.indexArrayForConflation.uint16[3*m+2]=0}}this.indexBuffer?this.indexBuffer.updateData(this.indexArrayForConflation):this.indexBuffer=i.createIndexBuffer(this.indexArrayForConflation,!0),this.entranceBloom.indexBuffer?this.entranceBloom.indexBuffer.updateData(this.entranceBloom.indexArrayForConflation):this.entranceBloom.indexBuffer=i.createIndexBuffer(this.entranceBloom.indexArrayForConflation,!0),this.indexArrayForConflationUploaded=!0}}uploadUpdatedColorBuffer(i){this.layoutColorBuffer?this.layoutColorBuffer.updateData(this.layoutColorArray):this.layoutColorBuffer=i.createVertexBuffer(this.layoutColorArray,Gh.members,!0),this.entranceBloom.layoutColorBuffer?this.entranceBloom.layoutColorBuffer.updateData(this.entranceBloom.layoutColorArray):this.entranceBloom.layoutColorBuffer=i.createVertexBuffer(this.entranceBloom.layoutColorArray,Gh.members,!0)}evaluate(i){const o=i.paint.get("building-ambient-occlusion-intensity");for(const c of this.buildingFeatures){const h=c.feature;h.properties["building-part"]="roof";const m=i.paint.get("building-color").evaluate(h,{},this.canonical),g=i.paint.get("building-emissive-strength").evaluate(h,{},this.canonical);h.properties["building-part"]="wall";const x=i.paint.get("building-color").evaluate(h,{},this.canonical),w=i.paint.get("building-emissive-strength").evaluate(h,{},this.canonical);h.properties["building-part"]="window";const T=i.paint.get("building-color").evaluate(h,{},this.canonical),I=i.paint.get("building-emissive-strength").evaluate(h,{},this.canonical);h.properties["building-part"]="door";const A=i.paint.get("building-color").evaluate(h,{},this.canonical),M=i.paint.get("building-emissive-strength").evaluate(h,{},this.canonical);for(const L of c.parts){let V,j=m;"roof"===L.part?(j=m,V=g):"wall"===L.part?(j=x,V=w):"facade_glazing"===L.part?(j=T,V=I):"entrance"===L.part&&(j=A,V=M),V=se(V,0,1);for(let W=0;W<L.vertexLength;W++){const Q=L.vertexOffset+W,K=1+(this.layoutAOArray[Q]-1)*o;this.layoutColorArray.emplace(Q,j.r*K*255<<8|j.g*K*255,j.b*K*255<<8|255*V)}}const k=c.buildingBloom;if(k)for(let L=0;L<k.vertexLength;L++)this.bloomGeometry.layoutColorArray.emplace(k.vertexOffset+L,255*A.r<<8|255*A.g,255*A.b<<8|51*M)}}needsEvaluation(i,o){const c=i.transform.projectionOptions,h=i.style.getBrightness();return!(this.uploaded&&c.name===this.projection.name&&this.brightness===h||(this.projection=c,this.brightness=h,0))}updateReplacement(i,o,c){if(o.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=o.updateTime;const h=o.getReplacementRegionsForTile(i.toUnwrapped());if(V_(this.activeReplacements,h))return;this.activeReplacements=h;for(const g of this.footprints)g.hiddenFlags&=-2;const m=[];for(const g of this.activeReplacements){if(g.order<=ME)continue;const x=Math.max(1,Math.pow(2,g.footprintTileId.canonical.z-i.canonical.z));for(const w of this.footprints)w.min.x>g.max.x||w.max.x<g.min.x||w.min.y>g.max.y||w.max.y<g.min.y||(m.length=0,XE(w.vertices,0,w.vertices.length,g.footprintTileId.canonical,i.canonical,m),Qv(g.footprint,m,w.indices,0,w.indices.length,0,-x)&&(w.hiddenFlags|=1))}0===this.groundEffect.hiddenByLandmarkVertexArray.length&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const g of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(g.groundEffectVertexOffset,g.groundEffectVertexLength,0!==g.hiddenFlags);this.indexArrayForConflationUploaded=!1}getHeightAtTileCoord(i,o){let c=Number.NEGATIVE_INFINITY,h=!0;const m=4*(i+ht)*ht+(o+ht);if(this.footprintLookup.hasOwnProperty(m)){const x=this.footprintLookup[m];return x?{height:x.height,hidden:0!==x.hiddenFlags}:void 0}const g=new Je(i,o);for(const x of this.footprints)i>x.max.x||x.min.x>i||o>x.max.y||x.min.y>o||x.height<=c||Fh(g,x)&&(c=x.height,this.footprintLookup[m]=x,h=0!==x.hiddenFlags);if(c!==Number.NEGATIVE_INFINITY)return{height:c,hidden:h};this.footprintLookup[m]=void 0}}function XE(a,i,o,c,h,m){const g=Math.pow(2,c.z-h.z);for(let x=0;x<o;x++){let w=a[x+i].x,T=a[x+i].y;w=(w+h.x*ht)*g-c.x*ht,T=(T+h.y*ht)*g-c.y*ht,m.push(new Je(w,T))}}let Vb,w0;Et(b0,"BuildingBucket",{omit:["layers"]});const YE=En([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),jb=En([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:KE}=YE,QE=En([{name:"a_packed",components:3,type:"Float32"}]),{members:IC}=QE,Ub=En([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Hb}=Ub;class Yo{constructor(i,o){this.width=i,this.height=o,this.nextRow=0,this.image=new hc({width:i,height:o}),this.positions={},this.uploaded=!1}getDash(i,o){const c=this.getKey(i,o);return this.positions[c]}trim(){const i=this.width,o=this.height=Lt(this.nextRow);this.image.resize({width:i,height:o})}getKey(i,o){return i.join(",")+o}getDashRanges(i,o,c){const h=[];let m=i.length%2==1?-i[i.length-1]*c:0,g=i[0]*c,x=!0;h.push({left:m,right:g,isDash:x,zeroLength:0===i[0]});let w=i[0];for(let T=1;T<i.length;T++){x=!x;const I=i[T];m=w*c,w+=I,g=w*c,h.push({left:m,right:g,isDash:x,zeroLength:0===I})}return h}addRoundDash(i,o,c){const h=o/2;for(let m=-c;m<=c;m++){const g=this.width*(this.nextRow+c+m);let x=0,w=i[x];for(let T=0;T<this.width;T++){T/w.right>1&&(w=i[++x]);const I=Math.abs(T-w.left),A=Math.abs(T-w.right),M=Math.min(I,A);let k;const L=m/c*(h+1);if(w.isDash){const V=h-Math.abs(L);k=Math.sqrt(M*M+V*V)}else k=h-Math.sqrt(M*M+L*L);this.image.data[g+T]=Math.max(0,Math.min(255,k+128))}}}addRegularDash(i,o){for(let w=i.length-1;w>=0;--w){const T=i[w],I=i[w+1];T.zeroLength?i.splice(w,1):I&&I.isDash===T.isDash&&(I.left=T.left,i.splice(w,1))}const c=i[0],h=i[i.length-1];c.isDash===h.isDash&&(c.left=h.left-this.width,h.right=c.right+this.width);const m=this.width*this.nextRow;let g=0,x=i[g];for(let w=0;w<this.width;w++){w/x.right>1&&(x=i[++g]);const T=Math.abs(w-x.left),I=Math.abs(w-x.right),A=Math.min(T,I);this.image.data[m+w]=Math.max(0,Math.min(255,(x.isDash?A:-A)+o+128))}}addDash(i,o){const c=this.getKey(i,o);if(this.positions[c])return this.positions[c];const h="round"===o,m=h?7:0,g=2*m+1;if(this.nextRow+g>this.height)return yn("LineAtlas out of space"),null;0===i.length&&i.push(1);let x=0;for(let I=0;I<i.length;I++)i[I]<0&&(yn("Negative value is found in line dasharray, replacing values with 0"),i[I]=0),x+=i[I];if(0!==x){const I=this.width/x,A=this.getDashRanges(i,this.width,I);h?this.addRoundDash(A,I,m):this.addRegularDash(A,"square"===o?.5*I:0)}const w=this.nextRow+m;this.nextRow+=g;const T={tl:[w,m],br:[x,0]};return this.positions[c]=T,T}}Et(Yo,"LineAtlas");const Gb=Re.types,AC=Math.cos(Math.PI/180*37.5),E0=Math.cos(Math.PI/180*5);class wl{constructor(i){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=i.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=i.overscaling,this.pixelRatio=i.pixelRatio,this.layers=i.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=i.index,this.projection=i.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(o=>{this.gradients[o.id]={}}),this.layoutVertexArray=new $f,this.layoutVertexArray2=new Ss,this.patternVertexArray=new Ss,this.indexArray=new Pi,this.programConfigurations=new Cs(i.layers,{zoom:i.zoom,lut:i.lut}),this.segments=new Wi,this.maxLineLength=0,this.zOffsetVertexArray=new Ss,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.tessellationStep=i.tessellationStep?i.tessellationStep:ht/64,this.worldview=i.worldview}updateFootprints(i,o){}populate(i,o,c,h){this.hasPattern=O_("line",this.layers,this.pixelRatio,o);const m=this.layers[0].layout.get("line-sort-key");this.tileToMeter=ce(c);const g=this.layers[0].layout.get("line-elevation-reference");if("hd-road-markup"===g)this.elevationType="road";else{const M=this.layers[0].layout.get("line-z-offset"),k=M.isConstant()&&!M.constantOr(0);this.elevationType="sea"!==g&&"ground"!==g&&k?"none":"offset","offset"===this.elevationType&&"none"===g&&yn(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const x=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope="offset"===this.elevationType&&void 0!==x;const w=[];for(const{feature:M,id:k,index:L,sourceLayerIndex:V}of i){const j=this.layers[0]._featureFilter.needGeometry,W=Ne(M,j);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),W,c))continue;const Q=m?m.evaluate(W,{},c):void 0,K={id:k,properties:M.properties,type:M.type,sourceLayerIndex:V,index:L,geometry:j?W.geometry:_e(M,c,h),patterns:{},sortKey:Q};w.push(K)}m&&w.sort((M,k)=>M.sortKey-k.sortKey);const{lineAtlas:T,featureIndex:I}=o,A=this.addConstantDashes(T);for(const M of w){const{geometry:k,index:L,sourceLayerIndex:V}=M;if(A&&this.addFeatureDashes(M,T),this.hasPattern){const j=qv("line",this.layers,M,this.zoom,this.pixelRatio,o);this.patternFeatures.push(j)}else this.addFeature(M,k,L,c,T.positions,o.availableImages,o.brightness,o.elevationFeatures);I.insert(i[L].feature,k,L,V,this.index)}}addConstantDashes(i){let o=!1;for(const c of this.layers){const h=c.paint.get("line-dasharray").value,m=c.layout.get("line-cap").value;if("constant"!==h.kind||"constant"!==m.kind)o=!0;else{const g=m.value,x=h.value;if(!x)continue;i.addDash(x,g)}}return o}addFeatureDashes(i,o){const c=this.zoom;for(const h of this.layers){const m=h.paint.get("line-dasharray").value,g=h.layout.get("line-cap").value;if("constant"===m.kind&&"constant"===g.kind)continue;let x,w;if("constant"===m.kind){if(x=m.value,!x)continue}else x=m.evaluate({zoom:c},i);w="constant"===g.kind?g.value:g.evaluate({zoom:c},i),o.addDash(x,w),i.patterns[h.id]=[o.getKey(x,w)]}}update(i,o,c,h,m,g,x,w){this.programConfigurations.updatePaintArrays(i,o,m,c,h,g,x,w)}addFeatures(i,o,c,h,m,g){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,o,c,h,g)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(i){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=i.createVertexBuffer(this.layoutVertexArray2,IC)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=i.createVertexBuffer(this.patternVertexArray,Hb)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=i.createVertexBuffer(this.zOffsetVertexArray,jb.members,!0)),this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,KE),this.indexBuffer=i.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(i),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(i){if(i.properties&&i.properties.hasOwnProperty("mapbox_clip_start")&&i.properties.hasOwnProperty("mapbox_clip_end"))return{start:+i.properties.mapbox_clip_start,end:+i.properties.mapbox_clip_end}}addFeature(i,o,c,h,m,g,x,w){const T=this.layers[0].layout,I=T.get("line-join").evaluate(i,{}),A=T.get("line-cap").evaluate(i,{}),M=T.get("line-miter-limit"),k=T.get("line-round-limit");this.lineClips=this.lineFeatureClips(i),this.lineFeature=i,this.zOffsetValue=T.get("line-z-offset").value;const L=this.layers[0].paint.get("line-width").value;if("constant"!==L.kind&&!1===L.isLineProgressConstant&&(this.variableWidthValue=L),"road"===this.elevationType){const V=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(i,o,h,w,I,A,M,k)){const[j,W]=this.clipRuntimeLinesToTile(o,1);for(let Q=0;Q<j.length;Q++){const K=j[Q],te=W[Q],me={progress:{min:te.progress.min,max:te.progress.max},nextDir:this.computeSegNextDir(te,K),prevDir:this.computeSegPrevDir(te,K)};this.addLine(K,i,h,I,A,M,k,me)}this.fillNonElevatedRoadSegment(V)}}else for(const V of o)this.addLine(V,i,h,I,A,M,k);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,c,m,g,h,x,void 0,this.worldview)}computeSegNextDir(i,o){return i.nextPoint.sub(o.at(-2)).unit()}computeSegPrevDir(i,o){return o[1].sub(i.prevPoint).unit()}clipLinesToTile(i,o){return Qm(i,-o,-o,ht+o,ht+o)}clipRuntimeLinesToTile(i,o){const c=[];return[Qm(i,-o,-o,ht+o,ht+o,c),c]}addElevatedRoadFeature(i,o,c,h,m,g,x,w){const T=[],I=Ni.getElevationFeature(i,h);if(I){const A=this.clipLinesToTile(o,1),M=this.prepareElevatedLines(A,I,c);for(const k of M)T.push({geometry:k,elevation:I,elevationTileID:c,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(0===T.length)return!1;for(const A of T){const M=this.layoutVertexArray.length;this.addLine(A.geometry,i,c,m,g,x,w);const k=new Pn(c,A.elevationTileID);if(A.elevation)for(let L=M;L<this.layoutVertexArray.length;L++){const V=new Je(this.layoutVertexArray.int16[6*L]>>1,this.layoutVertexArray.int16[6*L+1]>>1),j=k.pointElevation(V,A.elevation,.05);this.updateHeightRange(j),this.zOffsetVertexArray.emplaceBack(j,0,0)}else this.fillNonElevatedRoadSegment(M)}return!0}prepareElevatedLines(i,o,c){if(null!=o.constantHeight)return i;const h=[],m=1/ce(c);for(const g of i)NE(g,new ni(o,m),0,h);return h}fillNonElevatedRoadSegment(i){for(let o=i;o<this.layoutVertexArray.length;o++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(i){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,i),this.heightRange.max=Math.max(this.heightRange.max,i)):this.heightRange={min:i,max:i}}addLine(i,o,c,h,m,g,x,w){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const T="none"===h;this.patternJoinNone=this.hasPattern&&T,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const I=w&&w.progress.min>0,A=w&&w.progress.max<1;if(this.lineClips){let xe={min:this.lineClips.start,max:this.lineClips.end},Ee=1;if(w){const Ue=this.lineClips.end-this.lineClips.start;xe={min:jd((ot=w.progress).min,$e={min:0,max:1},Ke=xe),max:jd(ot.max,$e,Ke)},Ue>0&&(Ee=(xe.max-xe.min)/Ue)}const Ve=+o.properties.mapbox_clip_feature_len,Ce=+o.properties.mapbox_clip_seg_len;if(Number.isNaN(Ve)||Number.isNaN(Ce)){for(let ot=0;ot<i.length-1;ot++)this.totalDistance+=i[ot].dist(i[ot+1]);const Ue=this.totalDistance/(xe.max-xe.min);this.totalFeatureLength=Number.isFinite(Ue)?Ue:0,this.lineClips.start=xe.min,this.lineClips.end=xe.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Ve,this.distance=Ce*Ee,this.lineClips.start=xe.min,this.lineClips.end=xe.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}var ot,$e,Ke;const M="Polygon"===Gb[o.type];let k=i.length;for(;k>=2&&i[k-1].equals(i[k-2]);)k--;let L=0;for(;L<k-1&&i[L].equals(i[L+1]);)L++;if(k<(M?3:2))return;"bevel"===h&&(g=1.05);const V=this.segments.prepareSegment(10*k,this.layoutVertexArray,this.indexArray);let j,W,Q,K,te,me,he,fe;w&&w.prevDir&&(me=w.prevDir.perp()),w&&w.nextDir&&(he=w.nextDir.perp()),this.e1=this.e2=-1,M&&(j=i[k-2],te=i[L].sub(j)._unit()._perp());for(let xe=L;xe<k;xe++){if(Q=xe===k-1?M?i[L+1]:void 0:i[xe+1],Q&&i[xe].equals(Q))continue;te&&(K=te),j&&(W=j),j=i[xe],fe=this.evaluateLineProgressFeatures(W?W.dist(j):0),te=Q?Q.sub(j)._unit()._perp():K,K=K||te;const Ee=W&&Q;let Ve=Ee?h:M||T?"butt":m;const Ce=K.x*te.x+K.y*te.y;if(T){const Ae=function(Be){if(Be.patternJoinNone){const at=Be.segmentPoints.length/2,et=Be.lineSoFar-Be.segmentStart;for(let Ft=0;Ft<at;++Ft){const St=Be.segmentPoints[2*Ft+1],Xe=Math.round(Be.segmentPoints[2*Ft])+.5+.25*St;Be.patternVertexArray.emplaceBack(Xe,et,Be.segmentStart),Be.patternVertexArray.emplaceBack(Xe,et,Be.segmentStart)}Be.segmentPoints.length=0}Be.e1=Be.e2=-1};if(Ee&&Ce<E0){this.updateDistance(W,j),this.addCurrentVertex(j,K,1,1,V,fe),Ae(this),this.addCurrentVertex(j,te,-1,-1,V,fe);continue}if(W){if(!Q){this.updateDistance(W,j),this.addCurrentVertex(j,K,1,1,V,fe),Ae(this);continue}Ve="miter"}}let Ue=K.add(te);0===Ue.x&&0===Ue.y||Ue._unit();const ot=Ue.x*te.x+Ue.y*te.y,$e=0!==ot?1/ot:1/0,Ke=2*Math.sqrt(2-2*ot),nt=ot<AC&&W&&Q,ze=K.x*te.y-K.y*te.x>0,Qe=this.overscaling<=16?15*ht/(512*this.overscaling):0;if(Ee&&"round"===Ve)if($e<x)Ve="miter";else if($e<=2){const Ae=fp(j,-10,ht+10);Ve="offset"===this.elevationType&&(Ae||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===Ve&&$e>g&&(Ve="bevel"),"bevel"===Ve&&($e>2&&(Ve="flipbevel"),$e<g&&(Ve="miter")),W&&!("miter"===Ve&&nt)&&this.updateDistance(W,j),"miter"===Ve)if(nt){const Ae=j.dist(W);if(Ae>2*Qe){const at=j.sub(j.sub(W)._mult(Qe/Ae)._round());this.updateDistance(W,at),this.addCurrentVertex(at,K,0,0,V,fe),W=at}this.updateDistance(W,j),Ue._mult($e),this.addCurrentVertex(j,Ue,0,0,V,fe);const Be=j.dist(Q);if(Be>2*Qe){const at=j.add(Q.sub(j)._mult(Qe/Be)._round());this.updateDistance(j,at),this.addCurrentVertex(at,te,0,0,V,fe),j=at}}else Ue._mult($e),this.addCurrentVertex(j,Ue,0,0,V,fe);else if("flipbevel"===Ve){if($e>100)Ue=te.mult(-1);else{const Ae=$e*K.add(te).mag()/K.sub(te).mag();Ue._perp()._mult(Ae*(ze?-1:1))}this.addCurrentVertex(j,Ue,0,0,V,fe),this.addCurrentVertex(j,Ue.mult(-1),0,0,V,fe)}else if("bevel"===Ve||"fakeround"===Ve){null!=fe&&W&&this.addCurrentVertex(j,he||K,-1,-1,V,fe);const Ae=j.dist(W)<=2*Qe&&"bevel"!==Ve,Be=Ue.mult(ze?1:-1);Be._mult($e);const at=te.mult(ze?-1:1),et=K.mult(ze?-1:1),Ft=this.evaluateLineProgressFeatures(this.distance);if(null==fe&&(this.addHalfVertex(j,Be.x,Be.y,!1,!ze,0,V,Ft),Ae||this.addHalfVertex(j,Be.x+2*et.x,Be.y+2*et.y,!1,ze,0,V,Ft)),"fakeround"===Ve){const St=Math.round(180*Ke/Math.PI/20);this.addHalfVertex(j,et.x,et.y,!1,ze,0,V,Ft);for(let Xe=0;Xe<St;Xe++){let tt=Xe/St;if(.5!==tt){const yt=tt-.5;tt+=tt*yt*(tt-1)*((1.0904+Ce*(Ce*(3.55645-1.43519*Ce)-3.2452))*yt*yt+(.848013+Ce*(.215638*Ce-1.06021)))}const It=at.sub(et)._mult(tt)._add(et)._unit();this.addHalfVertex(j,It.x,It.y,!1,ze,0,V,Ft)}this.addHalfVertex(j,at.x,at.y,!1,ze,0,V,Ft)}Ae||null!=fe||this.addHalfVertex(j,Be.x+2*at.x,Be.y+2*at.y,!1,ze,0,V,Ft),null!=fe&&Q&&this.addCurrentVertex(j,me||te,1,1,V,fe)}else if("butt"===Ve)this.addCurrentVertex(j,Ue,0,0,V,fe);else if("square"===Ve){if(!W){const Ae=I?0:-1;this.addCurrentVertex(j,Ue,Ae,Ae,V,fe)}if(this.addCurrentVertex(j,Ue,0,0,V,fe),W){const Ae=A?0:1;this.addCurrentVertex(j,Ue,Ae,Ae,V,fe)}}else if("round"===Ve){if(W){const Ae=!Ee&&he?he:K;this.addCurrentVertex(j,Ae,0,0,V,fe),!Ee&&A||this.addCurrentVertex(j,Ae,1,1,V,fe,!0)}if(Q){const Ae=!Ee&&me?me:te;!Ee&&I||this.addCurrentVertex(j,Ae,-1,-1,V,fe,!0),this.addCurrentVertex(j,Ae,0,0,V,fe)}}}}addVerticesTo(i,o,c,h,m,g,x,w,T,I){const A=(o.w-i.w)/this.tessellationStep|0;let M=0;const k=this.scaledDistance;if(A>1){this.lineSoFar=i.w;const V=(o.x-i.x)/A,j=(o.y-i.y)/A,W=(o.z-i.z)/A,Q=(o.w-i.w)/A;for(let K=1;K<A;++K){i.x+=V,i.y+=j,i.z+=W,this.lineSoFar+=Q,M+=Q;const te=this.evaluateLineProgressFeatures(this.prevDistance+M);this.scaledDistance=(this.prevDistance+M)/this.totalDistance,this.addHalfVertex(i,c,h,I,!1,x,T,te),this.addHalfVertex(i,m,g,I,!0,-w,T,te)}}this.lineSoFar=o.w,this.scaledDistance=k;const L=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(o,c,h,I,!1,x,T,L),this.addHalfVertex(o,m,g,I,!0,-w,T,L)}evaluateLineProgressFeatures(i){if(!this.variableWidthValue&&"offset"!==this.elevationType)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+i)/this.totalFeatureLength):yn(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let o=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(o=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),"offset"!==this.elevationType?{zOffset:0,variableWidth:o}:"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:o}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:o}}addCurrentVertex(i,o,c,h,m,g,x=!1){const w=o.x+o.y*c,T=o.y-o.x*c,I=o.y*h-o.x,A=-o.y-o.x*h;if(null!=g){const M="offset"===this.elevationType,k=-10,L=ht+10,V=g.zOffset,j=new s0(i.x,i.y,V,this.lineSoFar),W=!!M&&fp(i,k,L),Q=this.lineSoFar,K=this.distance;if(this.currentVertex)if(W){const te=this.currentVertexIsOutside,me=this.currentVertex,he=new s0(i.x,i.y,V,this.lineSoFar);if(Z_(me,he,k,L),!fp(he,k,L)){if(te){this.e1=this.e2=-1,this.distance-=me.dist(j),this.lineSoFar=me.w;const fe=this.evaluateLineProgressFeatures(me.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(me,w,T,x,!1,c,m,fe),this.addHalfVertex(me,I,A,x,!0,-h,m,fe),this.prevDistance=this.distance}this.distance=this.prevDistance+me.dist(he),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(me,he,w,T,I,A,c,h,m,x),this.distance=K,this.scaledDistance=this.distance/this.totalDistance}}else{const te=this.currentVertex;if(this.currentVertexIsOutside){Z_(te,j,k,L),this.e1=this.e2=-1,this.distance-=te.dist(j),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=te.w;const me=this.evaluateLineProgressFeatures(te.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(te,w,T,x,!1,c,m,me),this.addHalfVertex(te,I,A,x,!0,-h,m,me),this.prevDistance=this.distance,this.distance=K,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(te,j,w,T,I,A,c,h,m,x)}else W||(this.addHalfVertex(i,w,T,x,!1,c,m,g),this.addHalfVertex(i,I,A,x,!0,-h,m,g));this.currentVertex=j,this.currentVertexIsOutside=W,this.lineSoFar=Q}else this.addHalfVertex(i,w,T,x,!1,c,m,g),this.addHalfVertex(i,I,A,x,!0,-h,m,g)}addHalfVertex({x:i,y:o},c,h,m,g,x,w,T){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),g||this.segmentPoints.push(this.lineSoFar-this.segmentStart,x)),this.layoutVertexArray.emplaceBack((i<<1)+(m?1:0),(o<<1)+(g?1:0),Math.round(63*c)+128,Math.round(63*h)+128,1+(0===x?0:x<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const A=Nt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,A)}const I=w.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,I),w.primitiveLength++),g?this.e2=I:this.e1=I,null!=T&&this.zOffsetVertexArray.emplaceBack(T.zOffset,T.variableWidth,T.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(i,o){this.prevDistance=this.distance,this.distance+=i.dist(o),this.updateScaledDistance()}}function fp(a,i,o){return a.x<i||a.x>o||a.y<i||a.y>o}let $b,qb;function Wb(a,i,o){return i*(ht/(a.tileSize*Math.pow(2,o-a.tileID.overscaledZ)))}Et(wl,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const ay=(a,i,o)=>(1-o)*a+o*i;function fo(a,i){return 1/Wb(a,1,i.tileZoom)}function T0(a,i,o,c){return a.translatePosMatrix(c||i.tileID.projMatrix,i,o.paint.get("line-translate"),o.paint.get("line-translate-anchor"))}const Zb=a=>{const i=[];JE(a)&&i.push("RENDER_LINE_DASH"),a.paint.get("line-gradient")&&i.push("RENDER_LINE_GRADIENT");const o=a.paint.get("line-trim-offset");0===o[0]&&0===o[1]||i.push("RENDER_LINE_TRIM_OFFSET"),0!==a.paint.get("line-border-width").constantOr(1)&&i.push("RENDER_LINE_BORDER");const c="none"===a.layout.get("line-join").constantOr("miter"),h=!!a.paint.get("line-pattern").constantOr(1);return c&&h&&i.push("LINE_JOIN_NONE"),i};function JE(a){const i=a.paint.get("line-dasharray").value;return i.value||"constant"!==i.kind}let Ti;const Xb=()=>Ti||(Ti={layout:$b||($b=new Ki({"line-cap":new _t(Se.layout_line["line-cap"]),"line-join":new _t(Se.layout_line["line-join"]),"line-miter-limit":new it(Se.layout_line["line-miter-limit"]),"line-round-limit":new it(Se.layout_line["line-round-limit"]),"line-sort-key":new _t(Se.layout_line["line-sort-key"]),"line-z-offset":new _t(Se.layout_line["line-z-offset"]),"line-elevation-reference":new it(Se.layout_line["line-elevation-reference"]),"line-cross-slope":new it(Se.layout_line["line-cross-slope"]),visibility:new it(Se.layout_line.visibility),"line-width-unit":new it(Se.layout_line["line-width-unit"])})),paint:qb||(qb=new Ki({"line-opacity":new _t(Se.paint_line["line-opacity"]),"line-color":new _t(Se.paint_line["line-color"]),"line-translate":new it(Se.paint_line["line-translate"]),"line-translate-anchor":new it(Se.paint_line["line-translate-anchor"]),"line-width":new _t(Se.paint_line["line-width"]),"line-gap-width":new _t(Se.paint_line["line-gap-width"]),"line-offset":new _t(Se.paint_line["line-offset"]),"line-blur":new _t(Se.paint_line["line-blur"]),"line-dasharray":new _t(Se.paint_line["line-dasharray"]),"line-pattern":new _t(Se.paint_line["line-pattern"]),"line-pattern-cross-fade":new it(Se.paint_line["line-pattern-cross-fade"]),"line-gradient":new Yc(Se.paint_line["line-gradient"]),"line-trim-offset":new it(Se.paint_line["line-trim-offset"]),"line-trim-fade-range":new it(Se.paint_line["line-trim-fade-range"]),"line-trim-color":new it(Se.paint_line["line-trim-color"]),"line-emissive-strength":new it(Se.paint_line["line-emissive-strength"]),"line-border-width":new _t(Se.paint_line["line-border-width"]),"line-border-color":new _t(Se.paint_line["line-border-color"]),"line-occlusion-opacity":new it(Se.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},Ti);class D0 extends _t{possiblyEvaluate(i,o){return o=new Tn(Math.floor(o.zoom),{now:o.now,fadeDuration:o.fadeDuration,transition:o.transition,worldview:o.worldview}),super.possiblyEvaluate(i,o)}evaluate(i,o,c,h){return o=Ie({},o,{zoom:Math.floor(o.zoom)}),super.evaluate(i,o,c,h)}}let sg;function Yb(a,i){return i>0?i+2*a:a}const S0=En([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Kb=En([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Qb=En([{name:"a_projected_pos",components:4,type:"Float32"}],4);En([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const eT=En([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Jb=En([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),ew=En([{name:"a_texb",components:2,type:"Uint16"}]),tT=En([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),nT=En([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);En([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const tw=En([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),nw=En([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);En([{name:"triangle",components:3,type:"Uint16"}]),En([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),En([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),En([{type:"Float32",name:"offsetX"}]),En([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Pr=24;function hu(a,i,o){return a.sections.forEach(c=>{c.text=function(h,m,g){const x=m.layout.get("text-transform").evaluate(g,{});return"uppercase"===x?h=h.toLocaleUpperCase():"lowercase"===x&&(h=h.toLocaleLowerCase()),Gs.applyArabicShaping&&(h=Gs.applyArabicShaping(h)),h}(c.text,i,o)}),a}const _c={"!":"\ufe15","#":"\uff03",$:"\uff04","%":"\uff05","&":"\uff06","(":"\ufe35",")":"\ufe36","*":"\uff0a","+":"\uff0b",",":"\ufe10","-":"\ufe32",".":"\u30fb","/":"\uff0f",":":"\ufe13",";":"\ufe14","<":"\ufe3f","=":"\uff1d",">":"\ufe40","?":"\ufe16","@":"\uff20","[":"\ufe47","\\":"\uff3c","]":"\ufe48","^":"\uff3e",_:"\ufe33","`":"\uff40","{":"\ufe37","|":"\u2015","}":"\ufe38","~":"\uff5e","\xa2":"\uffe0","\xa3":"\uffe1","\xa5":"\uffe5","\xa6":"\uffe4","\xac":"\uffe2","\xaf":"\uffe3","\u2013":"\ufe32","\u2014":"\ufe31","\u2018":"\ufe43","\u2019":"\ufe44","\u201c":"\ufe41","\u201d":"\ufe42","\u2026":"\ufe19","\u2027":"\u30fb","\u20a9":"\uffe6","\u3001":"\ufe11","\u3002":"\ufe12","\u3008":"\ufe3f","\u3009":"\ufe40","\u300a":"\ufe3d","\u300b":"\ufe3e","\u300c":"\ufe41","\u300d":"\ufe42","\u300e":"\ufe43","\u300f":"\ufe44","\u3010":"\ufe3b","\u3011":"\ufe3c","\u3014":"\ufe39","\u3015":"\ufe3a","\u3016":"\ufe17","\u3017":"\ufe18","\uff01":"\ufe15","\uff08":"\ufe35","\uff09":"\ufe36","\uff0c":"\ufe10","\uff0d":"\ufe32","\uff0e":"\u30fb","\uff1a":"\ufe13","\uff1b":"\ufe14","\uff1c":"\ufe3f","\uff1e":"\ufe40","\uff1f":"\ufe16","\uff3b":"\ufe47","\uff3d":"\ufe48","\uff3f":"\ufe33","\uff5b":"\ufe37","\uff5c":"\u2015","\uff5d":"\ufe38","\uff5f":"\ufe35","\uff60":"\ufe36","\uff61":"\ufe12","\uff62":"\ufe41","\uff63":"\ufe42","\u2190":"\u2191","\u2192":"\u2193"};function iT(a){return"\ufe36"===a||"\ufe48"===a||"\ufe38"===a||"\ufe44"===a||"\ufe42"===a||"\ufe3e"===a||"\ufe3c"===a||"\ufe3a"===a||"\ufe18"===a||"\ufe40"===a||"\ufe10"===a||"\ufe13"===a||"\ufe14"===a||"\uff40"===a||"\uffe3"===a||"\ufe11"===a||"\ufe12"===a}function rT(a){return"\ufe35"===a||"\ufe47"===a||"\ufe37"===a||"\ufe43"===a||"\ufe41"===a||"\ufe3d"===a||"\ufe3b"===a||"\ufe39"===a||"\ufe17"===a||"\ufe3f"===a}const ly=4294967296,C0=1/ly,cy=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let xd=class{constructor(a=new Uint8Array(16)){this.buf=ArrayBuffer.isView(a)?a:new Uint8Array(a),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(a,i,o=this.length){for(;this.pos<o;){const c=this.readVarint(),h=c>>3,m=this.pos;this.type=7&c,a(h,i,this),this.pos===m&&this.skip(c)}return i}readMessage(a,i){return this.readFields(a,i,this.readVarint()+this.pos)}readFixed32(){const a=this.dataView.getUint32(this.pos,!0);return this.pos+=4,a}readSFixed32(){const a=this.dataView.getInt32(this.pos,!0);return this.pos+=4,a}readFixed64(){const a=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*ly;return this.pos+=8,a}readSFixed64(){const a=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*ly;return this.pos+=8,a}readFloat(){const a=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,a}readDouble(){const a=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,a}readVarint(a){const i=this.buf;let o,c;return c=i[this.pos++],o=127&c,c<128?o:(c=i[this.pos++],o|=(127&c)<<7,c<128?o:(c=i[this.pos++],o|=(127&c)<<14,c<128?o:(c=i[this.pos++],o|=(127&c)<<21,c<128?o:(c=i[this.pos],o|=(15&c)<<28,function(h,m,g){const x=g.buf;let w,T;if(T=x[g.pos++],w=(112&T)>>4,T<128||(T=x[g.pos++],w|=(127&T)<<3,T<128)||(T=x[g.pos++],w|=(127&T)<<10,T<128)||(T=x[g.pos++],w|=(127&T)<<17,T<128)||(T=x[g.pos++],w|=(127&T)<<24,T<128)||(T=x[g.pos++],w|=(1&T)<<31,T<128))return function fu(a,i,o){return o?4294967296*i+(a>>>0):4294967296*(i>>>0)+(a>>>0)}(h,w,m);throw new Error("Expected varint not more than 10 bytes")}(o,a,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const a=this.readVarint();return a%2==1?(a+1)/-2:a/2}readBoolean(){return!!this.readVarint()}readString(){const a=this.readVarint()+this.pos,i=this.pos;return this.pos=a,a-i>=12&&cy?cy.decode(this.buf.subarray(i,a)):function(o,c,h){let m="",g=c;for(;g<h;){const x=o[g];let w,T,I,A=null,M=x>239?4:x>223?3:x>191?2:1;if(g+M>h)break;1===M?x<128&&(A=x):2===M?(w=o[g+1],128==(192&w)&&(A=(31&x)<<6|63&w,A<=127&&(A=null))):3===M?(w=o[g+1],T=o[g+2],128==(192&w)&&128==(192&T)&&(A=(15&x)<<12|(63&w)<<6|63&T,(A<=2047||A>=55296&&A<=57343)&&(A=null))):4===M&&(w=o[g+1],T=o[g+2],I=o[g+3],128==(192&w)&&128==(192&T)&&128==(192&I)&&(A=(15&x)<<18|(63&w)<<12|(63&T)<<6|63&I,(A<=65535||A>=1114112)&&(A=null))),null===A?(A=65533,M=1):A>65535&&(A-=65536,m+=String.fromCharCode(A>>>10&1023|55296),A=56320|1023&A),m+=String.fromCharCode(A),g+=M}return m}(this.buf,i,a)}readBytes(){const a=this.readVarint()+this.pos,i=this.buf.subarray(this.pos,a);return this.pos=a,i}readPackedVarint(a=[],i){const o=this.readPackedEnd();for(;this.pos<o;)a.push(this.readVarint(i));return a}readPackedSVarint(a=[]){const i=this.readPackedEnd();for(;this.pos<i;)a.push(this.readSVarint());return a}readPackedBoolean(a=[]){const i=this.readPackedEnd();for(;this.pos<i;)a.push(this.readBoolean());return a}readPackedFloat(a=[]){const i=this.readPackedEnd();for(;this.pos<i;)a.push(this.readFloat());return a}readPackedDouble(a=[]){const i=this.readPackedEnd();for(;this.pos<i;)a.push(this.readDouble());return a}readPackedFixed32(a=[]){const i=this.readPackedEnd();for(;this.pos<i;)a.push(this.readFixed32());return a}readPackedSFixed32(a=[]){const i=this.readPackedEnd();for(;this.pos<i;)a.push(this.readSFixed32());return a}readPackedFixed64(a=[]){const i=this.readPackedEnd();for(;this.pos<i;)a.push(this.readFixed64());return a}readPackedSFixed64(a=[]){const i=this.readPackedEnd();for(;this.pos<i;)a.push(this.readSFixed64());return a}readPackedEnd(){return 2===this.type?this.readVarint()+this.pos:this.pos+1}skip(a){const i=7&a;if(0===i)for(;this.buf[this.pos++]>127;);else if(2===i)this.pos=this.readVarint()+this.pos;else if(5===i)this.pos+=4;else{if(1!==i)throw new Error(`Unimplemented type: ${i}`);this.pos+=8}}writeTag(a,i){this.writeVarint(a<<3|i)}realloc(a){let i=this.length||16;for(;i<this.pos+a;)i*=2;if(i!==this.length){const o=new Uint8Array(i);o.set(this.buf),this.buf=o,this.dataView=new DataView(o.buffer),this.length=i}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(a){this.realloc(4),this.dataView.setInt32(this.pos,a,!0),this.pos+=4}writeSFixed32(a){this.realloc(4),this.dataView.setInt32(this.pos,a,!0),this.pos+=4}writeFixed64(a){this.realloc(8),this.dataView.setInt32(this.pos,-1&a,!0),this.dataView.setInt32(this.pos+4,Math.floor(a*C0),!0),this.pos+=8}writeSFixed64(a){this.realloc(8),this.dataView.setInt32(this.pos,-1&a,!0),this.dataView.setInt32(this.pos+4,Math.floor(a*C0),!0),this.pos+=8}writeVarint(a){(a=+a||0)>268435455||a<0?function(i,o){let c,h;if(i>=0?(c=i%4294967296|0,h=i/4294967296|0):(c=~(-i%4294967296),h=~(-i/4294967296),4294967295^c?c=c+1|0:(c=0,h=h+1|0)),i>=0x10000000000000000||i<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");var m,x;o.realloc(10),m=c,(x=o).buf[x.pos++]=127&m|128,m>>>=7,x.buf[x.pos++]=127&m|128,m>>>=7,x.buf[x.pos++]=127&m|128,m>>>=7,x.buf[x.pos++]=127&m|128,x.buf[x.pos]=127&(m>>>=7),function(m,g){const x=(7&m)<<4;g.buf[g.pos++]|=x|((m>>>=3)?128:0),m&&(g.buf[g.pos++]=127&m|((m>>>=7)?128:0),m&&(g.buf[g.pos++]=127&m|((m>>>=7)?128:0),m&&(g.buf[g.pos++]=127&m|((m>>>=7)?128:0),m&&(g.buf[g.pos++]=127&m|((m>>>=7)?128:0),m&&(g.buf[g.pos++]=127&m)))))}(h,o)}(a,this):(this.realloc(4),this.buf[this.pos++]=127&a|(a>127?128:0),a<=127||(this.buf[this.pos++]=127&(a>>>=7)|(a>127?128:0),a<=127||(this.buf[this.pos++]=127&(a>>>=7)|(a>127?128:0),a<=127||(this.buf[this.pos++]=a>>>7&127))))}writeSVarint(a){this.writeVarint(a<0?2*-a-1:2*a)}writeBoolean(a){this.writeVarint(+a)}writeString(a){a=String(a),this.realloc(4*a.length),this.pos++;const i=this.pos;this.pos=function(c,h,m){for(let g,x,w=0;w<h.length;w++){if(g=h.charCodeAt(w),g>55295&&g<57344){if(!x){g>56319||w+1===h.length?(c[m++]=239,c[m++]=191,c[m++]=189):x=g;continue}if(g<56320){c[m++]=239,c[m++]=191,c[m++]=189,x=g;continue}g=x-55296<<10|g-56320|65536,x=null}else x&&(c[m++]=239,c[m++]=191,c[m++]=189,x=null);g<128?c[m++]=g:(g<2048?c[m++]=g>>6|192:(g<65536?c[m++]=g>>12|224:(c[m++]=g>>18|240,c[m++]=g>>12&63|128),c[m++]=g>>6&63|128),c[m++]=63&g|128)}return m}(this.buf,a,this.pos);const o=this.pos-i;o>=128&&I0(i,o,this),this.pos=i-1,this.writeVarint(o),this.pos+=o}writeFloat(a){this.realloc(4),this.dataView.setFloat32(this.pos,a,!0),this.pos+=4}writeDouble(a){this.realloc(8),this.dataView.setFloat64(this.pos,a,!0),this.pos+=8}writeBytes(a){const i=a.length;this.writeVarint(i),this.realloc(i);for(let o=0;o<i;o++)this.buf[this.pos++]=a[o]}writeRawMessage(a,i){this.pos++;const o=this.pos;a(i,this);const c=this.pos-o;c>=128&&I0(o,c,this),this.pos=o-1,this.writeVarint(c),this.pos+=c}writeMessage(a,i,o){this.writeTag(a,2),this.writeRawMessage(i,o)}writePackedVarint(a,i){i.length&&this.writeMessage(a,iw,i)}writePackedSVarint(a,i){i.length&&this.writeMessage(a,oT,i)}writePackedBoolean(a,i){i.length&&this.writeMessage(a,lT,i)}writePackedFloat(a,i){i.length&&this.writeMessage(a,sT,i)}writePackedDouble(a,i){i.length&&this.writeMessage(a,aT,i)}writePackedFixed32(a,i){i.length&&this.writeMessage(a,rw,i)}writePackedSFixed32(a,i){i.length&&this.writeMessage(a,MC,i)}writePackedFixed64(a,i){i.length&&this.writeMessage(a,cT,i)}writePackedSFixed64(a,i){i.length&&this.writeMessage(a,PC,i)}writeBytesField(a,i){this.writeTag(a,2),this.writeBytes(i)}writeFixed32Field(a,i){this.writeTag(a,5),this.writeFixed32(i)}writeSFixed32Field(a,i){this.writeTag(a,5),this.writeSFixed32(i)}writeFixed64Field(a,i){this.writeTag(a,1),this.writeFixed64(i)}writeSFixed64Field(a,i){this.writeTag(a,1),this.writeSFixed64(i)}writeVarintField(a,i){this.writeTag(a,0),this.writeVarint(i)}writeSVarintField(a,i){this.writeTag(a,0),this.writeSVarint(i)}writeStringField(a,i){this.writeTag(a,2),this.writeString(i)}writeFloatField(a,i){this.writeTag(a,5),this.writeFloat(i)}writeDoubleField(a,i){this.writeTag(a,1),this.writeDouble(i)}writeBooleanField(a,i){this.writeVarintField(a,+i)}};function I0(a,i,o){const c=i<=16383?1:i<=2097151?2:i<=268435455?3:Math.floor(Math.log(i)/(7*Math.LN2));o.realloc(c);for(let h=o.pos-1;h>=a;h--)o.buf[h+c]=o.buf[h]}function iw(a,i){for(let o=0;o<a.length;o++)i.writeVarint(a[o])}function oT(a,i){for(let o=0;o<a.length;o++)i.writeSVarint(a[o])}function sT(a,i){for(let o=0;o<a.length;o++)i.writeFloat(a[o])}function aT(a,i){for(let o=0;o<a.length;o++)i.writeDouble(a[o])}function lT(a,i){for(let o=0;o<a.length;o++)i.writeBoolean(a[o])}function rw(a,i){for(let o=0;o<a.length;o++)i.writeFixed32(a[o])}function MC(a,i){for(let o=0;o<a.length;o++)i.writeSFixed32(a[o])}function cT(a,i){for(let o=0;o<a.length;o++)i.writeFixed64(a[o])}function PC(a,i){for(let o=0;o<a.length;o++)i.writeSFixed64(a[o])}const ow=3;function sw(a,i,o){i.glyphs=[],1===a&&o.readMessage(aw,i)}function aw(a,i,o){if(3===a){const{id:c,bitmap:h,width:m,height:g,left:x,top:w,advance:T}=o.readMessage(RC,{});i.glyphs.push({id:c,bitmap:new hc({width:m+2*ow,height:g+2*ow},h),metrics:{width:m,height:g,left:x,top:w,advance:T}})}else 4===a?i.ascender=o.readSVarint():5===a&&(i.descender=o.readSVarint())}function RC(a,i,o){1===a?i.id=o.readVarint():2===a?i.bitmap=o.readBytes():3===a?i.width=o.readVarint():4===a?i.height=o.readVarint():5===a?i.left=o.readSVarint():6===a?i.top=o.readSVarint():7===a&&(i.advance=o.readVarint())}const ag=ow,Ps={horizontal:1,vertical:2,horizontalOnly:3};class pp{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(i,o){const c=new pp;return c.scale=i||1,c.fontStack=o,c}static forImage(i){const o=new pp;return o.image=i,o}}class mp{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(i,o,c){const h=new mp;for(let m=0;m<i.sections.length;m++){const g=i.sections[m];g.image?h.addImageSection(g,c):h.addTextSection(g,o)}return h}length(){return this.text.length}getSection(i){return this.sections[this.sectionIndex[i]]}getSections(){return this.sections}getSectionIndex(i){return this.sectionIndex[i]}getCodePoint(i){return this.text.codePointAt(i)}verticalizePunctuation(i){this.text=function(o,c){let h="";for(let m=0;m<o.length;m++){const g=o.charCodeAt(m+1)||null,x=o.charCodeAt(m-1)||null;h+=!c&&(g&&ta(g)&&!_c[o[m+1]]||x&&ta(x)&&!_c[o[m-1]])||!_c[o[m]]?o[m]:_c[o[m]]}return h}(this.text,i)}trim(){let i=0;for(let c=0;c<this.text.length&&lg[this.text.charCodeAt(c)];c++)i++;let o=this.text.length;for(let c=this.text.length-1;c>=0&&c>=i&&lg[this.text.charCodeAt(c)];c--)o--;this.text=this.text.substring(i,o),this.sectionIndex=this.sectionIndex.slice(i,o)}substring(i,o){const c=new mp;return c.text=this.text.substring(i,o),c.sectionIndex=this.sectionIndex.slice(i,o),c.sections=this.sections,c}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((i,o)=>Math.max(i,this.sections[o].scale),0)}addTextSection(i,o){this.text+=i.text,this.sections.push(pp.forText(i.scale,i.fontStack||o));const c=this.sections.length-1;for(let h=0;h<i.text.length;++h)this.sectionIndex.push(c)}addImageSection(i,o){const c=i.image?i.image.getPrimary():null;if(!c)return void yn("Can't add FormattedSection with an empty image.");c.scaleSelf(o);const h=this.getNextImageSectionCharCode();h?(this.text+=String.fromCodePoint(h),this.sections.push(pp.forImage(c)),this.sectionIndex.push(this.sections.length-1)):yn("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function uy(a,i,o,c,h,m,g,x,w,T,I,A,M,k,L,V=1){const j=mp.fromFeature(a,h,V);A===Ps.vertical&&j.verticalizePunctuation(M);let W=[];const Q=function(fe,xe,Ee,Ve,Ce,Ue){if(!fe)return[];const ot=[],$e=function(Qe,Ae,Be,at,et,Ft){let St=0;for(let Xe=0;Xe<Qe.length();Xe++){const tt=Qe.getSection(Xe);St+=dy(Qe.getCodePoint(Xe),tt,at,et,Ae,Ft)}return St/Math.max(1,Math.ceil(St/Be))}(fe,xe,Ee,Ve,Ce,Ue),Ke=fe.text.indexOf("\u200b")>=0;let nt=0;for(let Qe=0;Qe<fe.length();Qe++){const Ae=fe.getSection(Qe),Be=fe.getCodePoint(Qe);if(lg[Be]||(nt+=dy(Be,Ae,Ve,Ce,xe,Ue)),Qe<fe.length()-1){const at=!((ze=Be)<11904||!(jt["Bopomofo Extended"](ze)||jt.Bopomofo(ze)||jt["CJK Compatibility Forms"](ze)||jt["CJK Compatibility Ideographs"](ze)||jt["CJK Compatibility"](ze)||jt["CJK Radicals Supplement"](ze)||jt["CJK Strokes"](ze)||jt["CJK Symbols and Punctuation"](ze)||jt["CJK Unified Ideographs Extension A"](ze)||jt["CJK Unified Ideographs"](ze)||jt["Enclosed CJK Letters and Months"](ze)||jt["Halfwidth and Fullwidth Forms"](ze)||jt.Hiragana(ze)||jt["Ideographic Description Characters"](ze)||jt["Kangxi Radicals"](ze)||jt["Katakana Phonetic Extensions"](ze)||jt.Katakana(ze)||jt["Vertical Forms"](ze)||jt["Yi Radicals"](ze)||jt["Yi Syllables"](ze)));(si[Be]||at||Ae.image)&&ot.push(M0(Qe+1,nt,$e,ot,Dt(Be,fe.getCodePoint(Qe+1),at&&Ke),!1))}}var ze;return lw(M0(fe.length(),nt,$e,ot,0,!0))}(j,T,m,i,c,k),{processBidirectionalText:K,processStyledBidirectionalText:te}=Gs;if(K&&1===j.sections.length){const fe=K(j.toString(),Q);for(const xe of fe){const Ee=new mp;Ee.text=xe,Ee.sections=j.sections;for(let Ve=0;Ve<xe.length;Ve++)Ee.sectionIndex.push(0);W.push(Ee)}}else if(te){const fe=te(j.text,j.sectionIndex,Q);for(const xe of fe){const Ee=new mp;Ee.text=xe[0],Ee.sectionIndex=xe[1],Ee.sections=j.sections,W.push(Ee)}}else W=function(fe,xe){const Ee=[],Ve=fe.text;let Ce=0;for(const Ue of xe)Ee.push(fe.substring(Ce,Ue)),Ce=Ue;return Ce<Ve.length&&Ee.push(fe.substring(Ce,Ve.length)),Ee}(j,Q);const me=[],he={positionedLines:me,text:j.toString(),top:I[1],bottom:I[1],left:I[0],right:I[0],writingMode:A,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(fe,xe,Ee,Ve,Ce,Ue,ot,$e,Ke,nt,ze,Qe){let Ae=0,Be=0,at=0;const et="right"===$e?1:"left"===$e?0:.5;let Ft=!1;for(const ft of Ce){const xt=ft.getSections();for(const zt of xt){if(zt.image)continue;const qt=xe[zt.fontStack];if(qt&&(Ft=void 0!==qt.ascender&&void 0!==qt.descender,!Ft))break}if(!Ft)break}let St=0;for(const ft of Ce){ft.trim();const xt=ft.getMaxScale(),zt=(xt-1)*Pr,qt={positionedGlyphs:[],lineOffset:0};fe.positionedLines[St]=qt;const rn=qt.positionedGlyphs;let Kt=0;if(!ft.length()){Be+=Ue,++St;continue}let vn=0,dn=0;for(let ie=0;ie<ft.length();ie++){const re=ft.getSection(ie),Le=ft.getSectionIndex(ie),lt=ft.getCodePoint(ie);let ut=re.scale,pt=null,Ct=null,Ht=null,wn=Pr,Gt=0,hn=Ke;hn===Ps.vertical&&(12312===(Xe=lt)||12313===Xe||12316===Xe||12540===Xe||12448===Xe)&&(hn=Ps.horizontal);const ai=!(hn===Ps.horizontal||!ze&&!Nf(lt)||ze&&(lg[lt]||pm(lt)));if(re.image){const Xi=Ve.get(re.image.toString());if(!Xi)continue;Ht=re.image,fe.iconsInText=fe.iconsInText||!0,Ct=Xi.paddedRect;const tn=Xi.displaySize;ut=ut*Pr/Qe,pt={width:tn[0],height:tn[1],left:0,top:-ag,advance:ai?tn[1]:tn[0],localGlyph:!1},Gt=Ft?-pt.height*ut:xt*Pr-17-tn[1]*ut,wn=pt.advance;const Ri=(ai?tn[0]:tn[1])*ut-Pr*xt;Ri>0&&Ri>Kt&&(Kt=Ri)}else{const Xi=Ee[re.fontStack];if(!Xi)continue;Xi[lt]&&(Ct=Xi[lt]);const tn=xe[re.fontStack];if(!tn)continue;const Ri=tn.glyphs[lt];if(!Ri)continue;if(pt=Ri.metrics,wn=8203!==lt?Pr:0,Ft){const li=void 0!==tn.ascender?Math.abs(tn.ascender):0,jn=void 0!==tn.descender?Math.abs(tn.descender):0,Zn=(li+jn)*ut;vn<Zn&&(vn=Zn,dn=(li-jn)/2*ut),Gt=-li*ut}else Gt=(xt-ut)*Pr-17}ai?(fe.verticalizable=!0,rn.push({glyph:lt,image:Ht,x:Ae,y:Be+Gt,vertical:ai,scale:ut,localGlyph:pt.localGlyph,fontStack:re.fontStack,sectionIndex:Le,metrics:pt,rect:Ct}),Ae+=wn*ut+nt):(rn.push({glyph:lt,image:Ht,x:Ae,y:Be+Gt,vertical:ai,scale:ut,localGlyph:pt.localGlyph,fontStack:re.fontStack,sectionIndex:Le,metrics:pt,rect:Ct}),Ae+=pt.advance*ut+nt)}0!==rn.length&&(at=Math.max(Ae-nt,at),Ft?$h(rn,et,Kt,dn,Ue*xt/2):$h(rn,et,Kt,0,Ue/2)),Ae=0;const ii=Ue*xt+Kt;qt.lineOffset=Math.max(Kt,zt),Be+=ii,++St}var Xe;const tt=Be,{horizontalAlign:It,verticalAlign:yt}=gp(ot);(function(ft,xt,zt,qt,rn,Kt){const vn=(xt-zt)*rn,dn=-Kt*qt;for(const ii of ft)for(const ie of ii.positionedGlyphs)ie.x+=vn,ie.y+=dn})(fe.positionedLines,et,It,yt,at,tt),fe.top+=-yt*tt,fe.bottom=fe.top+tt,fe.left+=-It*at,fe.right=fe.left+at,fe.hasBaseline=Ft}(he,i,o,c,W,g,x,w,A,T,M,L),!function(fe){for(const xe of fe)if(0!==xe.positionedGlyphs.length)return!1;return!0}(me))return he}const lg={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},si={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function dy(a,i,o,c,h,m){if(i.image){const g=c.get(i.image.toString());return g?g.displaySize[0]*i.scale*Pr/m+h:0}{const g=o[i.fontStack],x=g&&g.glyphs[a];return x?x.metrics.advance*i.scale+h:0}}function A0(a,i,o,c){const h=Math.pow(a-i,2);return c?a<i?h/2:2*h:h+Math.abs(o)*o}function Dt(a,i,o){let c=0;return 10===a&&(c-=1e4),o&&(c+=150),40!==a&&65288!==a||(c+=50),41!==i&&65289!==i||(c+=50),c}function M0(a,i,o,c,h,m){let g=null,x=A0(i,o,h,m);for(const w of c){const T=A0(i-w.x,o,h,m)+w.badness;T<=x&&(g=w,x=T)}return{index:a,x:i,priorBreak:g,badness:x}}function lw(a){return a?lw(a.priorBreak).concat(a.index):[]}function gp(a){let i=.5,o=.5;switch(a){case"right":case"top-right":case"bottom-right":i=1;break;case"left":case"top-left":case"bottom-left":i=0}switch(a){case"bottom":case"bottom-right":case"bottom-left":o=1;break;case"top":case"top-right":case"top-left":o=0}return{horizontalAlign:i,verticalAlign:o}}function $h(a,i,o,c,h){if(!(i||o||c||h))return;const m=a.length-1,g=a[m],x=(g.x+g.metrics.advance*g.scale)*i;for(let w=0;w<=m;w++)a[w].x-=x,a[w].y+=o+c+h}function hy(a){return void 0!==a.imagePrimary&&void 0!==a.top&&void 0!==a.bottom&&void 0!==a.left&&void 0!==a.right}function cg(a,i,o,c){const{horizontalAlign:h,verticalAlign:m}=gp(c),g=o[0]-a.displaySize[0]*h,x=o[1]-a.displaySize[1]*m;return{imagePrimary:a,imageSecondary:i,top:x,bottom:x+a.displaySize[1],left:g,right:g+a.displaySize[0]}}function P0(a,i,o,c,h,m){const g=a.imagePrimary;let x;if(g.content){const j=g.content,W=g.pixelRatio||1;x=[j[0]/W,j[1]/W,g.displaySize[0]-j[2]/W,g.displaySize[1]-j[3]/W]}const w=i.left*m,T=i.right*m;let I,A,M,k;"width"===o||"both"===o?(k=h[0]+w-c[3],A=h[0]+T+c[1]):(k=h[0]+(w+T-g.displaySize[0])/2,A=k+g.displaySize[0]);const L=i.top*m,V=i.bottom*m;return"height"===o||"both"===o?(I=h[1]+L-c[0],M=h[1]+V+c[2]):(I=h[1]+(L+V-g.displaySize[1])/2,M=I+g.displaySize[1]),{imagePrimary:g,imageSecondary:void 0,top:I,right:A,bottom:M,left:k,collisionPadding:x}}function fy(a){return!a.imagePrimary.stretchX}function py(a){return!a.imagePrimary.stretchY}function my(a){return{width:a.right-a.left,height:a.bottom-a.top}}const El=128;function gy(a,i,o){const{expression:c}=i;if("constant"===c.kind)return{kind:"constant",layoutSize:c.evaluate(new Tn(a+1,{worldview:o}))};if("source"===c.kind)return{kind:"source"};{const{zoomStops:h,interpolationType:m}=c;let g=0;for(;g<h.length&&h[g]<=a;)g++;g=Math.max(0,g-1);let x=g;for(;x<h.length&&h[x]<a+1;)x++;x=Math.min(h.length-1,x);const w=h[g],T=h[x];return"composite"===c.kind?{kind:"composite",minZoom:w,maxZoom:T,interpolationType:m}:{kind:"camera",minZoom:w,maxZoom:T,minSize:c.evaluate(new Tn(w,{worldview:o})),maxSize:c.evaluate(new Tn(T,{worldview:o})),interpolationType:m}}}function R0(a,{uSize:i,uSizeT:o},{lowerSize:c,upperSize:h}){return"source"===a.kind?c/El:"composite"===a.kind?Nt(c/El,h/El,o):i}function ug(a,i,o=1){let c=0,h=0;if("constant"===a.kind)h=a.layoutSize*o;else if("source"!==a.kind){const{interpolationType:m,minZoom:g,maxZoom:x}=a,w=m?se(ls.interpolationFactor(m,i,g,x),0,1):0;"camera"===a.kind?h=Nt(a.minSize,a.maxSize,w)*o:c=w*o}return{uSizeT:c,uSize:h}}class pu extends Je{constructor(i,o,c,h,m){super(i,o),this.angle=h,this.z=c,void 0!==m&&(this.segment=m)}clone(){return new pu(this.x,this.y,this.z,this.angle,this.segment)}}function O0(a,i,o,c,h){if(void 0===i.segment)return!0;let m=i,g=i.segment+1,x=0;for(;x>-o/2;){if(g--,g<0)return!1;x-=a[g].dist(m),m=a[g]}x+=a[g].dist(a[g+1]),g++;const w=[];let T=0;for(;x<o/2;){const I=a[g],A=a[g+1];if(!A)return!1;let M=a[g-1].angleTo(I)-I.angleTo(A);for(M=Math.abs((M+3*Math.PI)%(2*Math.PI)-Math.PI),w.push({distance:x,angleDelta:M}),T+=M;x-w[0].distance>c;)T-=w.shift().angleDelta;if(T>h)return!1;g++,x+=I.dist(A)}return!0}function cw(a){let i=0;for(let o=0;o<a.length-1;o++)i+=a[o].dist(a[o+1]);return i}function uw(a,i,o){return a?.6*i*o:0}function dw(a,i){return Math.max(a?a.right-a.left:0,i?i.right-i.left:0)}function uT(a,i,o,c,h,m){const g=uw(o,h,m),x=dw(o,c)*m;let w=0;const T=cw(a)/2;for(let I=0;I<a.length-1;I++){const A=a[I],M=a[I+1],k=A.dist(M);if(w+k>T){const L=(T-w)/k,V=Nt(A.x,M.x,L),j=Nt(A.y,M.y,L),W=new pu(V,j,0,M.angleTo(A),I);return!g||O0(a,W,x,g,i)?W:void 0}w+=k}}function hw(a,i,o,c,h,m,g,x,w){const T=uw(c,m,g),I=dw(c,h),A=I*g,M=0===a[0].x||a[0].x===w||0===a[0].y||a[0].y===w;return i-A<i/4&&(i=A+i/4),F0(a,M?i/2*x%i:(I/2+2*m)*g*x%i,i,T,o,A,M,!1,w)}function F0(a,i,o,c,h,m,g,x,w){const T=m/2,I=cw(a);let A=0,M=i-o,k=[];for(let L=0;L<a.length-1;L++){const V=a[L],j=a[L+1],W=V.dist(j),Q=j.angleTo(V);for(;M+o<A+W;){M+=o;const K=(M-A)/W,te=Nt(V.x,j.x,K),me=Nt(V.y,j.y,K);if(te>=0&&te<w&&me>=0&&me<w&&M-T>=0&&M+T<=I){const he=new pu(te,me,0,Q,L);c&&!O0(a,he,m,c,h)||k.push(he)}}A+=W}return x||k.length||g||(k=F0(a,A/2,o,c,h,m,g,!0,w)),k}function fw(a){let i=0,o=0;for(const g of a)i+=g.w*g.h,o=Math.max(o,g.w);a.sort((g,x)=>x.h-g.h);const c=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(i/.95)),o),h:1/0}];let h=0,m=0;for(const g of a)for(let x=c.length-1;x>=0;x--){const w=c[x];if(!(g.w>w.w||g.h>w.h)){if(g.x=w.x,g.y=w.y,m=Math.max(m,g.y+g.h),h=Math.max(h,g.x+g.w),g.w===w.w&&g.h===w.h){const T=c.pop();T&&x<c.length&&(c[x]=T)}else g.h===w.h?(w.x+=g.w,w.w-=g.w):g.w===w.w?(w.y+=g.h,w.h-=g.h):(c.push({x:w.x+g.w,y:w.y,w:w.w-g.w,h:g.h}),w.y+=g.h,w.h-=g.h);break}}return{w:h,h:m,fill:i/(h*m)||0}}Et(pu,"Anchor");const qh=1;class ms{static getImagePositionScale(i,o,c){if(o&&i&&i.options&&i.options.transform){const h=i.options.transform;return{x:h.a,y:h.d}}return{x:c,y:c}}constructor(i,o,c,h){this.paddedRect=i;const{pixelRatio:m,version:g,stretchX:x,stretchY:w,content:T,sdf:I,usvg:A}=o;this.pixelRatio=m,this.stretchX=x,this.stretchY=w,this.content=T,this.version=g,this.padding=c,this.sdf=I,this.usvg=A,this.scale=ms.getImagePositionScale(h,A,m)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function k0(a,i,o){const c=pa.parse(a),h=function(m,g,x=[1,1]){return{x:0,y:0,w:(m.data?m.data.width:m.width*x[0])+2*g,h:(m.data?m.data.height:m.height*x[1])+2*g}}(i,o,[c.options.transform.a,c.options.transform.d]);return{bin:h,imagePosition:new ms(h,i,o,c),imageVariant:c}}class pw{constructor(i,o,c){const h=new Map,m=new Map;this.haveRenderCallbacks=[];const g=[];this.addImages(i,h,qh,g),this.addImages(o,m,2,g);const{w:x,h:w}=fw(g),T=new $r({width:x||1,height:w||1});for(const[I,A]of i.entries()){const M=h.get(I).paddedRect;$r.copy(A.data,T,{x:0,y:0},{x:M.x+qh,y:M.y+qh},A.data,c,A.sdf)}for(const[I,A]of o.entries()){const M=m.get(I),k=M.paddedRect;let L=M.padding;const V=k.x+L,j=k.y+L,W=A.data.width,Q=A.data.height;L=L>1?L-1:L,$r.copy(A.data,T,{x:0,y:0},{x:V,y:j},A.data,c),$r.copy(A.data,T,{x:0,y:Q-L},{x:V,y:j-L},{width:W,height:L},c),$r.copy(A.data,T,{x:0,y:0},{x:V,y:j+Q},{width:W,height:L},c),$r.copy(A.data,T,{x:W-L,y:0},{x:V-L,y:j},{width:L,height:Q},c),$r.copy(A.data,T,{x:0,y:0},{x:V+W,y:j},{width:L,height:Q},c),$r.copy(A.data,T,{x:W-L,y:Q-L},{x:V-L,y:j-L},{width:L,height:L},c),$r.copy(A.data,T,{x:0,y:Q-L},{x:V+W,y:j-L},{width:L,height:L},c),$r.copy(A.data,T,{x:0,y:0},{x:V+W,y:j+Q},{width:L,height:L},c),$r.copy(A.data,T,{x:W-L,y:0},{x:V-L,y:j+Q},{width:L,height:L},c)}this.lut=c,this.image=T,this.iconPositions=h,this.patternPositions=m}addImages(i,o,c,h){for(const[m,g]of i.entries()){const{bin:x,imagePosition:w,imageVariant:T}=k0(m,g,c);o.set(m,w),h.push(x),g.hasRenderCallback&&this.haveRenderCallbacks.push(T.id)}}patchUpdatedImages(i,o,c){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(h=>i.hasImage(h,c)),i.dispatchRenderCallbacks(this.haveRenderCallbacks,c);for(const h of i.getUpdatedImages(c)){for(const m of this.iconPositions.keys()){const g=pa.parse(m);if(Jt.isEqual(g.id,h)){const x=i.getImage(h,c);this.patchUpdatedImage(this.iconPositions.get(m),x,o)}}for(const m of this.patternPositions.keys()){const g=pa.parse(m);if(Jt.isEqual(g.id,h)){const x=i.getImage(h,c);this.patchUpdatedImage(this.patternPositions.get(m),x,o)}}}}patchUpdatedImage(i,o,c){if(!i||!o||i.version===o.version)return;i.version=o.version;const[h,m]=i.tl,g=i.sdf;if(this.lut||g){const x={width:o.data.width,height:o.data.height},w=new $r(x);$r.copy(o.data,w,{x:0,y:0},{x:0,y:0},x,this.lut,g),c.update(w,{position:{x:h,y:m}})}else c.update(o.data,{position:{x:h,y:m}})}}Et(ms,"ImagePosition"),Et(pw,"ImageAtlas");const _y=1e20;function yy(a,i,o,c,h,m,g,x,w){for(let T=i;T<i+c;T++)L0(a,o*m+T,m,h,g,x,w);for(let T=o;T<o+h;T++)L0(a,T*m+i,1,c,g,x,w)}function L0(a,i,o,c,h,m,g){m[0]=0,g[0]=-_y,g[1]=_y,h[0]=a[i];for(let x=1,w=0,T=0;x<c;x++){h[x]=a[i+x*o];const I=x*x;do{const A=m[w];T=(h[x]-h[A]+I-A*A)/(x-A)/2}while(T<=g[w]&&--w>-1);w++,m[w]=x,g[w]=T,g[w+1]=_y}for(let x=0,w=0;x<c;x++){for(;g[w+1]<x;)w++;const T=m[w],I=x-T;a[i+x*o]=h[T]+I*I}}const Tl=2,N0={none:0,ideographs:1,all:2};class _p{constructor(i,o,c){this.requestManager=i,this.localGlyphMode=o,this.localFontFamily=c,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(i){this.url=i}getGlyphs(i,o){const c=[],h=this.url||so.GLYPHS_URL;for(const m in i)for(const g of i[m])c.push({stack:m,id:g});Te(c,({stack:m,id:g},x)=>{let w=this.entries[m];w||(w=this.entries[m]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let T=w.glyphs[g];if(void 0!==T)return void x(null,{stack:m,id:g,glyph:T});if(T=this._tinySDF(w,m,g),T)return w.glyphs[g]=T,void x(null,{stack:m,id:g,glyph:T});const I=Math.floor(g/256);if(256*I>65535)return yn("glyphs > 65535 not supported"),void x(null,{stack:m,id:g,glyph:T});if(w.ranges[I])return void x(null,{stack:m,id:g,glyph:T});let A=w.requests[I];A||(A=w.requests[I]=[],_p.loadGlyphRange(m,I,h,this.requestManager,(M,k)=>{if(k){w.ascender=k.ascender,w.descender=k.descender;for(const L in k.glyphs)this._doesCharSupportLocalGlyph(+L)||(w.glyphs[+L]=k.glyphs[+L]);w.ranges[I]=!0}for(const L of A)L(M,k);delete w.requests[I]})),A.push((M,k)=>{M?x(M):k&&x(null,{stack:m,id:g,glyph:k.glyphs[g]||null})})},(m,g)=>{if(m)o(m);else if(g){const x={};for(const{stack:w,id:T,glyph:I}of g)void 0===x[w]&&(x[w]={}),void 0===x[w].glyphs&&(x[w].glyphs={}),x[w].glyphs[T]=I&&{id:I.id,bitmap:I.bitmap.clone(),metrics:I.metrics},x[w].ascender=this.entries[w].ascender,x[w].descender=this.entries[w].descender;o(null,x)}})}_doesCharSupportLocalGlyph(i){return this.localGlyphMode!==N0.none&&(this.localGlyphMode===N0.all?!!this.localFontFamily:!!this.localFontFamily&&(jt["CJK Unified Ideographs"](i)||jt["Hangul Syllables"](i)||jt.Hiragana(i)||jt.Katakana(i)||jt["CJK Symbols and Punctuation"](i)||jt["CJK Unified Ideographs Extension A"](i)||jt["CJK Unified Ideographs Extension B"](i)||jt.Osage(i)))}_tinySDF(i,o,c){const h=this.localFontFamily;if(!h||!this._doesCharSupportLocalGlyph(c))return;let m=i.tinySDF;if(!m){let V="400";/bold/i.test(o)?V="900":/medium/i.test(o)?V="500":/light/i.test(o)&&(V="200"),m=i.tinySDF=new _p.TinySDF({fontFamily:h,fontWeight:V,fontSize:24*Tl,buffer:3*Tl,radius:8*Tl}),m.fontWeight=V}if(this.localGlyphs[m.fontWeight][c])return this.localGlyphs[m.fontWeight][c];const g=String.fromCodePoint(c),{data:x,width:w,height:T,glyphWidth:I,glyphHeight:A,glyphLeft:M,glyphTop:k,glyphAdvance:L}=m.draw(g);return this.localGlyphs[m.fontWeight][c]={id:c,bitmap:new hc({width:w,height:T},x),metrics:{width:I/Tl,height:A/Tl,left:M/Tl,top:k/Tl-27,advance:L/Tl,localGlyph:!0}}}}_p.loadGlyphRange=function(a,i,o,c,h){const m=256*i,g=m+255,x=c.transformRequest(c.normalizeGlyphsURL(o).replace("{fontstack}",a).replace("{range}",`${m}-${g}`),Li.Glyphs);Ic(x,(w,T)=>{if(w)h(w);else if(T){const I={},A=new xd(T).readFields(sw,{});for(const M of A.glyphs)I[M.id]=M;h(null,{glyphs:I,ascender:A.ascender,descender:A.descender})}})},_p.TinySDF=class{constructor({fontSize:a=24,buffer:i=3,radius:o=8,cutoff:c=.25,fontFamily:h="sans-serif",fontWeight:m="normal",fontStyle:g="normal"}={}){this.buffer=i,this.cutoff=c,this.radius=o;const x=this.size=a+4*i,w=this._createCanvas(x),T=this.ctx=w.getContext("2d",{willReadFrequently:!0});T.font=`${g} ${m} ${a}px ${h}`,T.textBaseline="alphabetic",T.textAlign="left",T.fillStyle="black",this.gridOuter=new Float64Array(x*x),this.gridInner=new Float64Array(x*x),this.f=new Float64Array(x),this.z=new Float64Array(x+1),this.v=new Uint16Array(x)}_createCanvas(a){const i=document.createElement("canvas");return i.width=i.height=a,i}draw(a){const{width:i,actualBoundingBoxAscent:o,actualBoundingBoxDescent:c,actualBoundingBoxLeft:h,actualBoundingBoxRight:m}=this.ctx.measureText(a),g=Math.ceil(o),x=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(m-h))),w=Math.min(this.size-this.buffer,g+Math.ceil(c)),T=x+2*this.buffer,I=w+2*this.buffer,A=Math.max(T*I,0),M=new Uint8ClampedArray(A),k={data:M,width:T,height:I,glyphWidth:x,glyphHeight:w,glyphTop:g,glyphLeft:0,glyphAdvance:i};if(0===x||0===w)return k;const{ctx:L,buffer:V,gridInner:j,gridOuter:W}=this;L.clearRect(V,V,x,w),L.fillText(a,V,V+g);const Q=L.getImageData(V,V,x,w);W.fill(_y,0,A),j.fill(0,0,A);for(let K=0;K<w;K++)for(let te=0;te<x;te++){const me=Q.data[4*(K*x+te)+3]/255;if(0===me)continue;const he=(K+V)*T+te+V;if(1===me)W[he]=0,j[he]=_y;else{const fe=.5-me;W[he]=fe>0?fe*fe:0,j[he]=fe<0?fe*fe:0}}yy(W,0,0,T,I,T,this.f,this.v,this.z),yy(j,V,V,x,w,T,this.f,this.v,this.z);for(let K=0;K<A;K++){const te=Math.sqrt(W[K])-Math.sqrt(j[K]);M[K]=Math.round(255-255*(te/this.radius+this.cutoff))}return k}};const mu=qh;function mw(a,i){return a+i[1]-i[0]}function gw(a,i,o,c,h=1){const m=[],g=a.imagePrimary,x=g.pixelRatio,w=g.paddedRect.w-2*mu,T=g.paddedRect.h-2*mu,I=(a.right-a.left)*h,A=(a.bottom-a.top)*h,M=g.stretchX||[[0,w]],k=g.stretchY||[[0,T]],L=M.reduce(mw,0),V=k.reduce(mw,0),j=w-L,W=T-V;let Q=0,K=L,te=0,me=V,he=0,fe=j,xe=0,Ee=W;if(g.content&&c){const Ce=g.content;Q=yp(M,0,Ce[0]),te=yp(k,0,Ce[1]),K=yp(M,Ce[0],Ce[2]),me=yp(k,Ce[1],Ce[3]),he=Ce[0]-Q,xe=Ce[1]-te,fe=Ce[2]-Ce[0]-K,Ee=Ce[3]-Ce[1]-me}const Ve=(Ce,Ue,ot,$e)=>{const Ke=vy(Ce.stretch-Q,K,I,a.left*h),nt=xy(Ce.fixed-he,fe,Ce.stretch,L),ze=vy(Ue.stretch-te,me,A,a.top*h),Qe=xy(Ue.fixed-xe,Ee,Ue.stretch,V),Ae=vy(ot.stretch-Q,K,I,a.left*h),Be=xy(ot.fixed-he,fe,ot.stretch,L),at=vy($e.stretch-te,me,A,a.top*h),et=xy($e.fixed-xe,Ee,$e.stretch,V),Ft=new Je(Ke,ze),St=new Je(Ae,ze),Xe=new Je(Ae,at),tt=new Je(Ke,at),It=new Je(nt/x,Qe/x),yt=new Je(Be/x,et/x),ft=i*Math.PI/180;if(ft){const vn=Math.sin(ft),dn=Math.cos(ft),ii=[dn,-vn,vn,dn];Ft._matMult(ii),St._matMult(ii),tt._matMult(ii),Xe._matMult(ii)}const xt=Ce.stretch+Ce.fixed,zt=ot.stretch+ot.fixed,qt=Ue.stretch+Ue.fixed,rn=$e.stretch+$e.fixed,Kt=a.imageSecondary;return{tl:Ft,tr:St,bl:tt,br:Xe,texPrimary:{x:g.paddedRect.x+mu+xt,y:g.paddedRect.y+mu+qt,w:zt-xt,h:rn-qt},texSecondary:Kt?{x:Kt.paddedRect.x+mu+xt,y:Kt.paddedRect.y+mu+qt,w:zt-xt,h:rn-qt}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:It,pixelOffsetBR:yt,minFontScaleX:fe/x/I,minFontScaleY:Ee/x/A,isSDF:o}};if(c&&(g.stretchX||g.stretchY)){const Ce=_w(M,j,L),Ue=_w(k,W,V);for(let ot=0;ot<Ce.length-1;ot++){const $e=Ce[ot],Ke=Ce[ot+1];for(let nt=0;nt<Ue.length-1;nt++)m.push(Ve($e,Ue[nt],Ke,Ue[nt+1]))}}else m.push(Ve({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:w+1},{fixed:0,stretch:T+1}));return m}function yp(a,i,o){let c=0;for(const h of a)c+=Math.max(i,Math.min(o,h[1]))-Math.max(i,Math.min(o,h[0]));return c}function _w(a,i,o){const c=[{fixed:-mu,stretch:0}];for(const[h,m]of a){const g=c[c.length-1];c.push({fixed:h-g.stretch,stretch:g.stretch}),c.push({fixed:h-g.stretch,stretch:g.stretch+(m-h)})}return c.push({fixed:i+mu,stretch:o}),c}function vy(a,i,o,c){return a/i*o+c}function xy(a,i,o,c){return a-i*o/c}function dT(a,i,o,c){const h=i+a.positionedLines[c].lineOffset;return 0===c?o+h/2:o+(h+(i+a.positionedLines[c-1].lineOffset))/2}function hT(a,i=1,o=!1){let c=1/0,h=1/0,m=-1/0,g=-1/0;const x=a[0];for(let k=0;k<x.length;k++){const L=x[k];(!k||L.x<c)&&(c=L.x),(!k||L.y<h)&&(h=L.y),(!k||L.x>m)&&(m=L.x),(!k||L.y>g)&&(g=L.y)}const w=Math.min(m-c,g-h);let T=w/2;const I=new Tf([],yc);if(0===w)return new Je(c,h);for(let k=c;k<m;k+=w)for(let L=h;L<g;L+=w)I.push(new bd(k+T,L+T,T,a));let A=function(k){let L=0,V=0,j=0;const W=k[0];for(let Q=0,K=W.length,te=K-1;Q<K;te=Q++){const me=W[Q],he=W[te],fe=me.x*he.y-he.x*me.y;V+=(me.x+he.x)*fe,j+=(me.y+he.y)*fe,L+=3*fe}return new bd(V/L,j/L,0,k)}(a),M=I.length;for(;I.length;){const k=I.pop();(k.d>A.d||!A.d)&&(A=k,o&&console.log("found best %d after %d probes",Math.round(1e4*k.d)/1e4,M)),k.max-A.d<=i||(T=k.h/2,I.push(new bd(k.p.x-T,k.p.y-T,T,a)),I.push(new bd(k.p.x+T,k.p.y-T,T,a)),I.push(new bd(k.p.x-T,k.p.y+T,T,a)),I.push(new bd(k.p.x+T,k.p.y+T,T,a)),M+=4)}return o&&(console.log(`num probes: ${M}`),console.log(`best distance: ${A.d}`)),A.p}function yc(a,i){return i.max-a.max}class bd{constructor(i,o,c,h){this.p=new Je(i,o),this.h=c,this.d=function(m,g){let x=!1,w=1/0;for(let T=0;T<g.length;T++){const I=g[T];for(let A=0,M=I.length,k=M-1;A<M;k=A++){const L=I[A],V=I[k];L.y>m.y!=V.y>m.y&&m.x<(V.x-L.x)*(m.y-L.y)/(V.y-L.y)+L.x&&(x=!x),w=Math.min(w,ia(m,L,V))}}return(x?1:-1)*Math.sqrt(w)}(this.p,h),this.max=this.d+this.h*Math.SQRT2}}const fT=Object.keys,by=Number.POSITIVE_INFINITY,pT=Math.sqrt(2);function z0(a,[i,o]){let c=0,h=0;if(o===by){i<0&&(i=0);const m=i/pT;switch(a){case"top-right":case"top-left":h=m-7;break;case"bottom-right":case"bottom-left":h=7-m;break;case"bottom":h=7-i;break;case"top":h=i-7}switch(a){case"top-right":case"bottom-right":c=-m;break;case"top-left":case"bottom-left":c=m;break;case"left":c=i;break;case"right":c=-i}}else{switch(i=Math.abs(i),o=Math.abs(o),a){case"top-right":case"top-left":case"top":h=o-7;break;case"bottom-right":case"bottom-left":case"bottom":h=7-o}switch(a){case"top-right":case"bottom-right":case"right":c=-i;break;case"top-left":case"bottom-left":case"left":c=i}}return[c,h]}function dg(a,i,o,c,h,m,g,x,w){if(!i||!i.usvg)return;const T=my(c),I=my(h),A="both"!==m&&"width"!==m||!fy(c)?1:I.width/T.width,M="both"!==m&&"height"!==m||!py(c)?1:I.height/T.height;o.scaleSelf(A,M);const k=o.toString();g.set(k,o),x.set(k,i);const{imagePosition:L}=k0(k,i,qh);w.set(k,L)}function hg(a,i,o,c,h,m,g,x,w){if(!a)return;const T=function(I,A,M,k,L,V){if("camera"===I.kind)return I.maxSize;if("composite"===I.kind){const j=A.possiblyEvaluate(new Tn(I.maxZoom,{worldview:V}),M).evaluate(L,{},M),W=A.possiblyEvaluate(new Tn(I.minZoom,{worldview:V}),M).evaluate(L,{},M);return Math.max(j,W)}return A.possiblyEvaluate(new Tn(k,{worldview:V})).evaluate(L,{},M)}(i,o,c,h,m,w);return a.scaleSelf(T*x*g)}function wy(a,i,o,c,h,m,g,x,w){return{iconPrimary:hg(a.getPrimary(),i,o,c,h,m,g,x,w),iconSecondary:hg(a.getSecondary(),i,o,c,h,m,g,x,w)}}function OC(a,i,o){if(!i)return;const c=o.get(a.toString()),h=o.get(i.toString());h&&(c.paddedRect.w===h.paddedRect.w&&c.paddedRect.h===h.paddedRect.h||yn(`Mismatch in icon variant sizes: ${a.toString()} and ${i.toString()}`),c.usvg!==h.usvg&&yn(`Mismatch in icon variant image types: ${a.id} and ${i.id}`))}function B0(a,i,o,c){if(!a)return;const h=i.get(o.toString());if(a.imagePrimary=h,c){const m=i.get(c.toString());a.imageSecondary=m}}function yw(a,i){for(const o in a.horizontal)V0(a.horizontal[o],i);V0(a.vertical,i)}function V0(a,i){if(a)for(const o of a.positionedLines)for(const c of o.positionedGlyphs)if(null!==c.image){const h=c.image.toString();c.rect=i.get(h).paddedRect}}function Ey(a){switch(a){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function j0(a,i,o,c,h,m,g,x,w){const T=U0(m.horizontal)||m.vertical,I=o.get("icon-text-fit-padding").evaluate(c,{},h);let A,M=i;return i&&"none"!==w&&(a.allowVerticalPlacement&&m.vertical&&(A=P0(i,m.vertical,w,I,x,g)),T&&(M=P0(i,T,w,I,x,g))),{defaultShapedIcon:M,verticallyShapedIcon:A}}function gu(a,i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W,Q,K){let te=g.textMaxSize.evaluate(i,{},M);void 0===te?te=x*g.textScaleFactor:te*=g.textScaleFactor;const me=a.layers[0].layout,he=U0(o.horizontal)||o.vertical,fe="globe"===k.name,xe=Pr,Ee=a.tilePixelRatio*te/xe,Ve=(nt=a.overscaling,a.zoom>18&&nt>2&&(nt>>=1),Math.max(ht/(512*nt),1)*me.get("symbol-spacing")),Ce=me.get("text-padding")*a.tilePixelRatio,Ue=me.get("icon-padding")*a.tilePixelRatio,ot=Rn(me.get("text-max-angle")),$e="map"===me.get("icon-rotation-alignment")&&"point"!==K,Ke=Ve/2;var nt;!1===a.hasAnyIconTextFit&&"none"!==j&&(a.hasAnyIconTextFit=!0);const ze=i.properties?+i.properties[vt]:null,Qe=ze&&a.elevationFeatureIdToIndex?a.elevationFeatureIdToIndex.get(ze):65535,Ae=(Be,at,et)=>{if(at.x<0||at.x>=ht||at.y<0||at.y>=ht)return;let Ft=null;if(fe){const{x:St,y:Xe,z:tt}=k.projectTilePoint(at.x,at.y,et);Ft={anchor:new pu(St,Xe,tt,0,void 0),up:k.upVector(et,at.x,at.y)}}!function(St,Xe,tt,It,yt,ft,xt,zt,qt,rn,Kt,vn,dn,ii,ie,re,Le,lt,ut,pt,Ct,Ht,wn,Gt,hn,ai,Xi,tn,Ri){const li=St.addToLineVertexArray(Xe,It);let jn,Zn,Oi,fi,_i,ri,ln,oi=0,Bi=0,Ut=0,An=0,Ai=-1,Ji=-1;const pi={};let kr=Wd("");const hi=tt?tt.anchor:Xe,Rr="none"!==tn;let zo=0,po=0;if(void 0===qt._unevaluatedLayout.getValue("text-radial-offset")){const pr=qt.layout.get("text-offset").evaluate(Ct,{},hn);zo=pr[0]*Pr,po=pr[1]*Pr}else zo=qt.layout.get("text-radial-offset").evaluate(Ct,{},hn)*Pr,po=by;if(St.allowVerticalPlacement&&yt.vertical){const pr=yt.vertical;if(ie)ri=H0(pr),zt&&(ln=H0(zt));else{const Dr=qt.layout.get("text-rotate").evaluate(Ct,{},hn)+90;Oi=pg(rn,hi,Xe,Kt,vn,dn,pr,ii,Dr,re),zt&&(fi=pg(rn,hi,Xe,Kt,vn,dn,zt,lt,Dr))}}if(ft){const pr=St.iconSizeData,Dr=qt.layout.get("icon-rotate").evaluate(Ct,{},hn),Io=gw(ft,Dr,wn,Rr,Ht.iconScaleFactor),Ko=zt?gw(zt,Dr,wn,Rr,Ht.iconScaleFactor):void 0;Zn=pg(rn,hi,Xe,Kt,vn,dn,ft,lt,Dr,null),oi=4*Io.length;let Bo=null;"source"===pr.kind?(Bo=[El*qt.layout.get("icon-size").evaluate(Ct,{},hn)*Ht.iconScaleFactor],Bo[0]>wd&&yn(`${St.layerIds[0]}: Value for "icon-size" is >= ${fg}. Reduce your "icon-size".`)):"composite"===pr.kind&&(Bo=[El*Ht.compositeIconSizes[0].evaluate(Ct,{},hn)*Ht.iconScaleFactor,El*Ht.compositeIconSizes[1].evaluate(Ct,{},hn)*Ht.iconScaleFactor],(Bo[0]>wd||Bo[1]>wd)&&yn(`${St.layerIds[0]}: Value for "icon-size" is >= ${fg}. Reduce your "icon-size".`)),St.addSymbols(St.icon,Io,Bo,pt,ut,Ct,void 0,tt,Xe,li.lineStartIndex,li.lineLength,-1,Gt,hn,ai,Xi),Ai=St.icon.placedSymbolArray.length-1,Ko&&(Bi=4*Ko.length,St.addSymbols(St.icon,Ko,Bo,pt,ut,Ct,Ps.vertical,tt,Xe,li.lineStartIndex,li.lineLength,-1,Gt,hn,ai,Xi),Ji=St.icon.placedSymbolArray.length-1)}for(const pr in yt.horizontal){const Dr=pr,Io=yt.horizontal[Dr];jn||(kr=Wd(Io.text),ie?_i=H0(Io):jn=pg(rn,hi,Xe,Kt,vn,dn,Io,ii,qt.layout.get("text-rotate").evaluate(Ct,{},hn),re));const Ko=1===Io.positionedLines.length;if(Ut+=Ty(St,tt,Xe,Io,xt,qt,ie,Ct,re,li,yt.vertical?Ps.horizontal:Ps.horizontalOnly,Ko?fT(yt.horizontal):[Dr],pi,Ai,Ht,Gt,hn,ai),Ko)break}yt.vertical&&(An+=Ty(St,tt,Xe,yt.vertical,xt,qt,ie,Ct,re,li,Ps.vertical,["vertical"],pi,Ji,Ht,Gt,hn,ai));let no=-1;const _s=(pr,Dr)=>pr?Math.max(pr,Dr):Dr;no=_s(_i,no),no=_s(ri,no),no=_s(ln,no);const vc=no>-1?1:0;St.glyphOffsetArray.length>=65535&&yn("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==Ct.sortKey&&St.addToSortKeyRanges(St.symbolInstances.length,Ct.sortKey),St.symbolInstances.emplaceBack(Xe.x,Xe.y,hi.x,hi.y,hi.z,pi.right>=0?pi.right:-1,pi.center>=0?pi.center:-1,pi.left>=0?pi.left:-1,pi.vertical>=0?pi.vertical:-1,Ai,Ji,kr,void 0!==jn?jn:St.collisionBoxArray.length,void 0!==jn?jn+1:St.collisionBoxArray.length,void 0!==Oi?Oi:St.collisionBoxArray.length,void 0!==Oi?Oi+1:St.collisionBoxArray.length,void 0!==Zn?Zn:St.collisionBoxArray.length,void 0!==Zn?Zn+1:St.collisionBoxArray.length,fi||St.collisionBoxArray.length,fi?fi+1:St.collisionBoxArray.length,Kt,Ut,An,oi,Bi,vc,0,zo,po,no,0,Rr?1:0,Ri)}(a,at,Ft,Be,o,c,m,h,a.layers[0],a.collisionBoxArray,i.index,i.sourceLayerIndex,a.index,Ce,Q,T,0,Ue,$e,W,i,g,I,A,M,L,V,j,Qe)};if("line"===K)for(const Be of Qm(i.geometry,0,0,ht,ht)){const at=hw(Be,Ve,ot,o.vertical||he,c,xe,Ee,a.overscaling,ht);for(const et of at)he&&Dy(a,he.text,Ke,et)||Ae(Be,et,M)}else if("line-center"===K){for(const Be of i.geometry)if(Be.length>1){const at=uT(Be,ot,o.vertical||he,c,xe,Ee);at&&Ae(Be,at,M)}}else if("Polygon"===i.type)for(const Be of Ph(i.geometry,0)){const at=hT(Be,16);Ae(Be[0],new pu(at.x,at.y,0,0,void 0),M)}else if("LineString"===i.type)for(const Be of i.geometry)Ae(Be,new pu(Be[0].x,Be[0].y,0,0,void 0),M);else if("Point"===i.type)for(const Be of i.geometry)for(const at of Be)Ae([at],new pu(at.x,at.y,0,0,void 0),M)}const fg=255,wd=fg*El;function Ty(a,i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j,W){const Q=function(me,he,fe,xe,Ee,Ve,Ce,Ue){const ot=[];if(0===he.positionedLines.length)return ot;const $e=xe.layout.get("text-rotate").evaluate(Ve,{})*Math.PI/180,Ke=function(Be){const at=Be[0],et=Be[1],Ft=at*et;return Ft>0?[at,-et]:Ft<0?[-at,et]:0===at?[et,at]:[et,-at]}(fe);let nt=Math.abs(he.top-he.bottom);for(const Be of he.positionedLines)nt-=Be.lineOffset;const ze=he.positionedLines.length,Qe=nt/ze;let Ae=he.top-fe[1];for(let Be=0;Be<ze;++Be){const at=he.positionedLines[Be];Ae=dT(he,Qe,Ae,Be);for(const et of at.positionedGlyphs){if(!et.rect)continue;const Ft=et.rect||{};let St=ag+1,Xe=!0,tt=1,It=0;if(et.image){const Ct=Ce.get(et.image.toString());if(!Ct)continue;if(Ct.sdf){yn("SDF images are not supported in formatted text and will be ignored.");continue}Xe=!1,tt=Ct.pixelRatio,St=qh/tt}const yt=(Ee||Ue)&&et.vertical,ft=et.metrics.advance*et.scale/2,xt=et.metrics,zt=et.rect;if(null===zt)continue;Ue&&he.verticalizable&&(It=et.image?ft-et.metrics.width*et.scale/2:0);const qt=Ee?[et.x+ft,et.y]:[0,0];let rn=[0,0],Kt=[0,0],vn=!1;Ee||(yt?(Kt=[et.x+ft+Ke[0],et.y+Ke[1]-It],vn=!0):rn=[et.x+ft+fe[0],et.y+fe[1]-It]);const dn=zt.w*et.scale/(tt*(et.localGlyph?Tl:1)),ii=zt.h*et.scale/(tt*(et.localGlyph?Tl:1));let ie,re,Le,lt;if(yt){const Ct=et.y-Ae,Ht=new Je(-ft,ft-Ct),wn=-Math.PI/2,Gt=new Je(...Kt);ie=new Je(-ft+rn[0],rn[1]),ie._rotateAround(wn,Ht)._add(Gt),ie.x+=-Ct+ft,ie.y-=(xt.left-St)*et.scale;const hn=et.image?xt.advance*et.scale:Pr*et.scale,ai=String.fromCodePoint(et.glyph);iT(ai)?ie.x+=(1-St)*et.scale:rT(ai)?ie.x+=hn-xt.height*et.scale+(-St-1)*et.scale:ie.x+=et.image||xt.width+2*St===zt.w&&xt.height+2*St===zt.h?(hn-ii)/2:(hn-(xt.height+2*St)*et.scale)/2,re=new Je(ie.x,ie.y-dn),Le=new Je(ie.x+ii,ie.y),lt=new Je(ie.x+ii,ie.y-dn)}else{const Ct=(xt.left-St)*et.scale-ft+rn[0],Ht=(-xt.top-St)*et.scale+rn[1],wn=Ct+dn,Gt=Ht+ii;ie=new Je(Ct,Ht),re=new Je(wn,Ht),Le=new Je(Ct,Gt),lt=new Je(wn,Gt)}if($e){let Ct;Ct=Ee?new Je(0,0):vn?new Je(Ke[0],Ke[1]):new Je(fe[0],fe[1]),ie._rotateAround($e,Ct),re._rotateAround($e,Ct),Le._rotateAround($e,Ct),lt._rotateAround($e,Ct)}const ut=new Je(0,0),pt=new Je(0,0);ot.push({tl:ie,tr:re,bl:Le,br:lt,texPrimary:Ft,texSecondary:void 0,writingMode:he.writingMode,glyphOffset:qt,sectionIndex:et.sectionIndex,isSDF:Xe,pixelOffsetTL:ut,pixelOffsetBR:pt,minFontScaleX:0,minFontScaleY:0})}}return ot}(0,c,w,m,g,x,h,a.allowVerticalPlacement),K=a.textSizeData;let te=null;"source"===K.kind?(te=[El*m.layout.get("text-size").evaluate(x,{},j)*L.textScaleFactor],te[0]>wd&&yn(`${a.layerIds[0]}: Value for "text-size" is >= ${fg}. Reduce your "text-size".`)):"composite"===K.kind&&(te=[El*L.compositeTextSizes[0].evaluate(x,{},j)*L.textScaleFactor,El*L.compositeTextSizes[1].evaluate(x,{},j)*L.textScaleFactor],(te[0]>wd||te[1]>wd)&&yn(`${a.layerIds[0]}: Value for "text-size" is >= ${fg}. Reduce your "text-size".`)),a.addSymbols(a.text,Q,te,w,g,x,I,i,o,T.lineStartIndex,T.lineLength,k,V,j,W,!1);for(const me of A)M[me]=a.text.placedSymbolArray.length-1;return 4*Q.length}function U0(a){for(const i in a)return a[i];return null}function pg(a,i,o,c,h,m,g,x,w,T){let I=g.top,A=g.bottom,M=g.left,k=g.right;if(hy(g)&&g.collisionPadding){const L=g.collisionPadding;M-=L[0],I-=L[1],k+=L[2],A+=L[3]}if(w){const L=new Je(M,I),V=new Je(k,I),j=new Je(M,A),W=new Je(k,A),Q=Rn(w);let K=new Je(0,0);T&&(K=new Je(T[0],T[1])),L._rotateAround(Q,K),V._rotateAround(Q,K),j._rotateAround(Q,K),W._rotateAround(Q,K),M=Math.min(L.x,V.x,j.x,W.x),k=Math.max(L.x,V.x,j.x,W.x),I=Math.min(L.y,V.y,j.y,W.y),A=Math.max(L.y,V.y,j.y,W.y)}return a.emplaceBack(i.x,i.y,i.z,o.x,o.y,M,I,k,A,x,c,h,m),a.length-1}function H0(a){hy(a)&&a.collisionPadding&&(a.top-=a.collisionPadding[1],a.bottom+=a.collisionPadding[3]);const i=a.bottom-a.top;return i>0?Math.max(10,i):null}function Dy(a,i,o,c){const h=a.compareText;if(i in h){const m=h[i];for(let g=m.length-1;g>=0;g--)if(c.dist(m[g])<o)return!0}else h[i]=[];return h[i].push(c),!1}function vp(a,i){const o=a.fovAboveCenter,c=a.elevation?a.elevation.getMinElevationBelowMSL()*i:0,h=(a._camera.position[2]*a.worldSize-c)/Math.cos(a._pitch),m=Math.sin(o)*h/Math.sin(Math.max(Math.PI/2-a._pitch-o,.01));let g=Math.sin(a._pitch)*m+h;const x=h*(1/a._horizonShift);if(!a.elevation||0===a.elevation.exaggeration()){let w=Math.max(a.zoom-17,0);a.isOrthographic&&(w/=10),g*=1+w}return Math.min(1.01*g,x)}function xp(a,i){if(!i.isReprojectedInTileSpace)return{scale:1<<a.z,x:a.x,y:a.y,x2:a.x+1,y2:a.y+1,projection:i};const o=Math.pow(2,-a.z),c=a.x*o,h=(a.x+1)*o,m=a.y*o,g=(a.y+1)*o,x=Y(c),w=Y(h),T=ee(m),I=ee(g),A=i.project(x,T),M=i.project(w,T),k=i.project(w,I),L=i.project(x,I);let V=Math.min(A.x,M.x,k.x,L.x),j=Math.min(A.y,M.y,k.y,L.y),W=Math.max(A.x,M.x,k.x,L.x),Q=Math.max(A.y,M.y,k.y,L.y);const K=o/16;function te(he,fe,xe,Ee,Ve,Ce){const Ue=(xe+Ve)/2,ot=(Ee+Ce)/2,$e=i.project(Y(Ue),ee(ot)),Ke=Math.max(0,V-$e.x,j-$e.y,$e.x-W,$e.y-Q);V=Math.min(V,$e.x),W=Math.max(W,$e.x),j=Math.min(j,$e.y),Q=Math.max(Q,$e.y),Ke>K&&(te(he,$e,xe,Ee,Ue,ot),te($e,fe,Ue,ot,Ve,Ce))}te(A,M,c,m,h,m),te(M,k,h,m,h,g),te(k,L,h,g,c,g),te(L,A,c,g,c,m),V-=K,j-=K,W+=K,Q+=K;const me=1/Math.max(W-V,Q-j);return{scale:me,x:V*me,y:j*me,x2:W*me,y2:Q*me,projection:i}}function mg(a,{x:i,y:o},c=0){return new Je(((i-c)*a.scale-a.x)*ht,(o*a.scale-a.y)*ht)}const FC=fn(new Float32Array(16));class Ed{constructor(i){this.spec=i,this.name=i.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(i,o){return{x:0,y:0,z:0}}unproject(i,o){return new O(0,0)}projectTilePoint(i,o,c){return{x:i,y:o,z:0}}locationPoint(i,o,c,h=!0){return i._coordinatePoint(i.locationCoordinate(o,c),h)}pixelsPerMeter(i,o){return G(1,i)*o}pixelSpaceConversion(i,o,c){return 1}farthestPixelDistance(i){return vp(i,i.pixelsPerMeter)}pointCoordinate(i,o,c,h){const m=i.horizonLineFromTop(!1),g=new Je(o,Math.max(m,c));return i.rayIntersectionCoordinate(i.pointRayIntersection(g,h))}pointCoordinate3D(i,o,c){const h=new Je(o,c);if(i.elevation)return i.elevation.pointCoordinate(h);{const m=this.pointCoordinate(i,h.x,h.y,0);return[m.x,m.y,m.z]}}isPointAboveHorizon(i,o){if(i.elevation&&i.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(i,o.x,o.y);const c=i.horizonLineFromTop();return o.y<c}createInversionMatrix(i,o){return FC}createTileMatrix(i,o,c){let h,m,g;const x=c.canonical,w=fn(new Float64Array(16));if(this.isReprojectedInTileSpace){const T=xp(x,this);h=1,m=T.x+c.wrap*T.scale,g=T.y,ro(w,w,[h/T.scale,h/T.scale,i.pixelsPerMeter/o])}else h=o/i.zoomScale(x.z),m=(x.x+Math.pow(2,x.z)*c.wrap)*h,g=x.y*h;return jo(w,w,[m,g,0]),ro(w,w,[h/ht,h/ht,1]),w}upVector(i,o,c){return[0,0,1]}upVectorScale(i,o,c){return{metersToTile:1}}}class vw extends Ed{constructor(i){super(i),this.range=[4,7],this.center=i.center||[-96,37.5];const[o,c]=this.parallels=i.parallels||[29.5,45.5],h=Math.sin(Rn(o));this.n=(h+Math.sin(Rn(c)))/2,this.c=1+h*(2*this.n-h),this.r0=Math.sqrt(this.c)/this.n}project(i,o){const{n:c,c:h,r0:m}=this,g=Rn(i-this.center[0]),x=Rn(o),w=Math.sqrt(h-2*c*Math.sin(x))/c;return{x:w*Math.sin(g*c),y:w*Math.cos(g*c)-m,z:0}}unproject(i,o){const{n:c,c:h,r0:m}=this,g=m+o;let x=Math.atan2(i,Math.abs(g))*Math.sign(g);g*c<0&&(x-=Math.PI*Math.sign(i)*Math.sign(g));const w=Rn(this.center[0])*c;x=ke(x,-Math.PI-w,Math.PI-w);const T=se(Pe(x/c)+this.center[0],-180,180),I=Math.asin(se((h-(i*i+g*g)*c*c)/(2*c),-1,1)),A=se(Pe(I),-le,le);return new O(T,A)}}const bp=1.340264,gg=-.081106,_g=893e-6,wp=.003796,yg=Math.sqrt(3)/2;class vg extends Ed{project(i,o){o=o/180*Math.PI,i=i/180*Math.PI;const c=Math.asin(yg*Math.sin(o)),h=c*c,m=h*h*h;return{x:.5*(i*Math.cos(c)/(yg*(bp+3*gg*h+m*(7*_g+9*wp*h)))/Math.PI+.5),y:1-.5*(c*(bp+gg*h+m*(_g+wp*h))/Math.PI+1),z:0}}unproject(i,o){i=(2*i-.5)*Math.PI;let c=o=(2*(1-o)-1)*Math.PI,h=c*c,m=h*h*h;for(let I,A,M,k=0;k<12&&(A=c*(bp+gg*h+m*(_g+wp*h))-o,M=bp+3*gg*h+m*(7*_g+9*wp*h),I=A/M,c=se(c-I,-Math.PI/3,Math.PI/3),h=c*c,m=h*h*h,!(Math.abs(I)<1e-12));++k);const g=yg*i*(bp+3*gg*h+m*(7*_g+9*wp*h))/Math.cos(c),x=Math.asin(Math.sin(c)/yg),w=se(180*g/Math.PI,-180,180),T=se(180*x/Math.PI,-le,le);return new O(w,T)}}class mT extends Ed{constructor(i){super(i),this.wrap=!0,this.supportsWorldCopies=!0}project(i,o){return{x:.5+i/360,y:.5-o/360,z:0}}unproject(i,o){const c=360*(i-.5),h=se(360*(.5-o),-le,le);return new O(c,h)}}const Wh=Math.PI/2;function xg(a){return Math.tan((Wh+a)/2)}class gT extends Ed{constructor(i){super(i),this.center=i.center||[0,30];const[o,c]=this.parallels=i.parallels||[30,30];let h=Rn(o),m=Rn(c);this.southernCenter=h+m<0,this.southernCenter&&(h=-h,m=-m);const g=Math.cos(h),x=xg(h);this.n=h===m?Math.sin(h):Math.log(g/Math.cos(m))/Math.log(xg(m)/x),this.f=g*Math.pow(xg(h),this.n)/this.n}project(i,o){o=Rn(o),this.southernCenter&&(o=-o),i=Rn(i-this.center[0]);const c=1e-6,{n:h,f:m}=this;m>0?o<-Wh+c&&(o=-Wh+c):o>Wh-c&&(o=Wh-c);const g=m/Math.pow(xg(o),h);let x=g*Math.sin(h*i),w=m-g*Math.cos(h*i);return x=.5*(x/Math.PI+.5),w=.5*(w/Math.PI+.5),{x,y:this.southernCenter?w:1-w,z:0}}unproject(i,o){i=(2*i-.5)*Math.PI,this.southernCenter&&(o=1-o),o=(2*(1-o)-.5)*Math.PI;const{n:c,f:h}=this,m=h-o,g=Math.sign(m),x=Math.sign(c)*Math.sqrt(i*i+m*m);let w=Math.atan2(i,Math.abs(m))*g;m*c<0&&(w-=Math.PI*Math.sign(i)*g);const T=se(Pe(w/c)+this.center[0],-180,180),I=se(Pe(2*Math.atan(Math.pow(h/x,1/c))-Wh),-le,le);return new O(T,this.southernCenter?-I:I)}}class xw extends Ed{constructor(i){super(i),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(i,o){return{x:U(i),y:q(o),z:0}}unproject(i,o){const c=Y(i),h=ee(o);return new O(c,h)}}const Ep=Rn(le);class _T extends Ed{project(i,o){const c=(o=Rn(o))*o,h=c*c;return{x:.5*((i=Rn(i))*(.8707-.131979*c+h*(h*(.003971*c-.001529*h)-.013791))/Math.PI+.5),y:1-.5*(o*(1.007226+c*(.015085+h*(.028874*c-.044475-.005916*h)))/Math.PI+1),z:0}}unproject(i,o){i=(2*i-.5)*Math.PI;let c=o=(2*(1-o)-1)*Math.PI,h=25,m=0,g=c*c;do{g=c*c;const T=g*g;m=(c*(1.007226+g*(.015085+T*(.028874*g-.044475-.005916*T)))-o)/(1.007226+g*(.045255+T*(.259866*g-.311325-.005916*11*T))),c=se(c-m,-Ep,Ep)}while(Math.abs(m)>1e-6&&--h>0);g=c*c;const x=se(Pe(i/(.8707+g*(g*(g*g*g*(.003971-.001529*g)-.013791)-.131979))),-180,180),w=Pe(c);return new O(x,w)}}const bw=Rn(le);class yT extends Ed{project(i,o){o=Rn(o),i=Rn(i);const c=Math.cos(o),h=2/Math.PI,m=Math.acos(c*Math.cos(i/2)),g=Math.sin(m)/m,x=.5*(i*h+2*c*Math.sin(i/2)/g)||0,w=.5*(o+Math.sin(o)/g)||0;return{x:.5*(x/Math.PI+.5),y:1-.5*(w/Math.PI+1),z:0}}unproject(i,o){let c=i=(2*i-.5)*Math.PI,h=o=(2*(1-o)-1)*Math.PI,m=25;const g=1e-6;let x=0,w=0;do{const T=Math.cos(h),I=Math.sin(h),A=2*I*T,M=I*I,k=T*T,L=Math.cos(c/2),V=Math.sin(c/2),j=2*L*V,W=V*V,Q=1-k*L*L,K=Q?1/Q:0,te=Q?Math.acos(T*L)*Math.sqrt(1/Q):0,me=.5*(2*te*T*V+2*c/Math.PI)-i,he=.5*(te*I+h)-o,fe=.5*K*(k*W+te*T*L*M)+1/Math.PI,xe=K*(j*A/4-te*I*V),Ee=.125*K*(A*V-te*I*k*j),Ve=.5*K*(M*L+te*W*T)+.5,Ce=xe*Ee-Ve*fe;x=(he*xe-me*Ve)/Ce,w=(me*Ee-he*fe)/Ce,c=se(c-x,-Math.PI,Math.PI),h=se(h-w,-bw,bw)}while((Math.abs(x)>g||Math.abs(w)>g)&&--m>0);return new O(Pe(c),Pe(h))}}class ww extends Ed{constructor(i){super(i),this.center=i.center||[0,0],this.parallels=i.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Rn(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(i,o){const{scale:c,cosPhi:h}=this;return{x:Rn(i)*h*c+.5,y:-Math.sin(Rn(o))/h*c+.5,z:0}}unproject(i,o){const{scale:c,cosPhi:h}=this,m=-(o-.5)/c,g=se(Pe((i-.5)/c)/h,-180,180),x=Math.asin(se(m*h,-1,1)),w=se(Pe(x),-le,le);return new O(g,w)}}class vT extends xw{constructor(i){super(i),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(i,o,c){const h=km(i,o,c);return lr(h,h,Lm(Va(c))),{x:h[0],y:h[1],z:h[2]}}locationPoint(i,o,c){const h=D(o.lat,o.lng),m=Mi([],h),g=c?i._centerAltitude+c:i.elevation?i.elevation.getAtPointOrZero(i.locationCoordinate(o),i._centerAltitude):i._centerAltitude;Uo(h,h,m,G(1,0)*ht*g);const x=fn(new Float64Array(16));return Ui(x,i.pixelMatrix,i.globeMatrix),lr(h,h,x),new Je(h[0],h[1])}pixelsPerMeter(i,o){return G(1,0)*o}pixelSpaceConversion(i,o,c){const h=G(1,i)*o,m=Nt(G(1,45)*o,h,c);return this.pixelsPerMeter(i,o)/m}createTileMatrix(i,o,c){const h=Nm(Va(c.canonical));return Ui(new Float64Array(16),i.globeMatrix,h)}createInversionMatrix(i,o){const{center:c}=i,h=Lm(Va(o));return Ws(h,h,Rn(c.lng)),ys(h,h,Rn(c.lat)),ro(h,h,[i._pixelsPerMercatorPixel,i._pixelsPerMercatorPixel,1]),Float32Array.from(h)}pointCoordinate(i,o,c,h){return eb(i,o,c,!0)||new ue(0,0)}pointCoordinate3D(i,o,c){const h=this.pointCoordinate(i,o,c,0);return[h.x,h.y,h.z]}isPointAboveHorizon(i,o){return!eb(i,o.x,o.y,!1)}farthestPixelDistance(i){const o=function(h,m){const g=h.cameraToCenterDistance,x=h._centerAltitude*m,w=h._camera,T=h._camera.forward(),I=Fi([],ki([],T,-g),[0,0,x]),A=h.worldSize/(2*Math.PI),M=[0,0,-A],k=h.width/h.height,L=Math.tan(h.fovAboveCenter),V=ki([],w.up(),L),j=ki([],w.right(),L*k),W=Mi([],Fi([],Fi([],T,V),j)),Q=[];let K;if(new Mn(I,W).closestPointOnSphere(M,A,Q)){const te=Fi([],Q,M),me=cr([],te,I);K=Math.cos(h.fovAboveCenter)*go(me)}else{const te=cr([],I,M),me=cr([],M,I);Mi(me,me);const he=go(te)-A;K=Math.sqrt(he*(he+2*A));const fe=Math.acos(K/(A+he))-Math.acos(ar(T,me));K*=Math.cos(fe)}return 1.01*K}(i,this.pixelsPerMeter(i.center.lat,i.worldSize)),c=lu(i.zoom);if(c>0){const h=vp(i,G(1,i.center.lat)*i.worldSize),m=i.worldSize/(2*Math.PI),g=Math.max(i.width,i.height)/i.worldSize*Math.PI;return Nt(o,h+m*(1-Math.cos(g)),Math.pow(c,10))}return o}upVector(i,o,c){return km(o,c,i,1)}upVectorScale(i){return{metersToTile:vl(ps(Va(i)))}}}function Ew(a){const i=a.parallels,o=!!i&&Math.abs(i[0]+i[1])<.01;switch(a.name){case"mercator":return new xw(a);case"equirectangular":return new mT(a);case"naturalEarth":return new _T(a);case"equalEarth":return new vg(a);case"winkelTripel":return new yT(a);case"albers":return o?new ww(a):new vw(a);case"lambertConformalConic":return o?new ww(a):new gT(a);case"globe":return new vT(a)}throw new Error(`Invalid projection name: ${a.name}`)}const xT=Re.types,bT=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function bg(a,i,o,c,h,m,g,x,w,T,I,A,M){const k=x?Math.min(wd,Math.round(x[0])):0,L=x?Math.min(wd,Math.round(x[1])):0;a.emplaceBack(i,o,Math.round(32*c),Math.round(32*h),m,g,(k<<1)+(w?1:0),L,16*T,16*I,256*A,256*M)}function zi(a,i,o){a.emplaceBack(i,o)}function Sy(a,i,o,c,h,m,g){a.emplaceBack(i,o,c,h,m,g)}const Zh=(a,i,o,c)=>{for(let h=0;h<i;h++)a.emplaceBack(o[0],o[1],o[2],c[0],c[1],c[2])};function Cy(a,i,o,c,h){a.emplaceBack(i,o,c,h),a.emplaceBack(i,o,c,h),a.emplaceBack(i,o,c,h),a.emplaceBack(i,o,c,h)}function wT(a){for(const i of a.sections)if(f_(i.text))return!0;return!1}class G0{constructor(i){this.layoutVertexArray=new id,this.indexArray=new Pi,this.programConfigurations=i,this.segments=new Wi,this.dynamicLayoutVertexArray=new Ba,this.opacityVertexArray=new xm,this.placedSymbolArray=new cc,this.iconTransitioningVertexArray=new va,this.globeExtVertexArray=new Qc,this.zOffsetVertexArray=new ds,this.orientationVertexArray=new wm}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(i,o,c,h,m){this.isEmpty()||(c&&(this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,S0.members),this.indexBuffer=i.createIndexBuffer(this.indexArray,o),this.dynamicLayoutVertexBuffer=i.createVertexBuffer(this.dynamicLayoutVertexArray,Qb.members,!0),this.opacityVertexBuffer=i.createVertexBuffer(this.opacityVertexArray,bT,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=i.createVertexBuffer(this.iconTransitioningVertexArray,ew.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=i.createVertexBuffer(this.globeExtVertexArray,Kb.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||m)&&(this.zOffsetVertexBuffer=i.createVertexBuffer(this.zOffsetVertexArray,eT.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=i.createVertexBuffer(this.orientationVertexArray,Jb.members,!0)),this.opacityVertexBuffer.itemSize=1),(c||h)&&this.programConfigurations.upload(i))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Et(G0,"SymbolBuffers");class $0{constructor(i,o,c){this.layoutVertexArray=new i,this.layoutAttributes=o,this.indexArray=new c,this.segments=new Wi,this.collisionVertexArray=new eu,this.collisionVertexArrayExt=new Ba}upload(i){this.layoutVertexBuffer=i.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=i.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=i.createVertexBuffer(this.collisionVertexArray,tT.members,!0),this.collisionVertexBufferExt=i.createVertexBuffer(this.collisionVertexArrayExt,nT.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Et($0,"CollisionBuffers");class Iy{constructor(i){this.collisionBoxArray=i.collisionBoxArray,this.zoom=i.zoom,this.lut=i.lut,this.overscaling=i.overscaling,this.layers=i.layers,this.layerIds=this.layers.map(g=>g.fqid),this.index=i.index,this.pixelRatio=i.pixelRatio,this.sourceLayerIndex=i.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=fn([]),this.placementViewportMatrix=fn([]);const o=this.layers[0]._unevaluatedLayout._values;this.worldview=i.worldview,this.textSizeData=gy(this.zoom,o["text-size"],this.worldview),this.iconSizeData=gy(this.zoom,o["icon-size"],this.worldview);const c=this.layers[0].layout,h=c.get("symbol-sort-key"),m=c.get("symbol-z-order");this.canOverlap=c.get("text-allow-overlap")||c.get("icon-allow-overlap")||c.get("text-ignore-placement")||c.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==m&&void 0!==h.constantOr(1),this.sortFeaturesByY=("viewport-y"===m||"auto"===m&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=c.get("text-writing-mode").map(g=>Ps[g]),this.stateDependentLayerIds=this.layers.filter(g=>g.isStateDependent()).map(g=>g.id),this.sourceID=i.sourceID,this.projection=i.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1}createArrays(){this.text=new G0(new Cs(this.layers,{zoom:this.zoom,lut:this.lut},i=>i.startsWith("text")||i.startsWith("symbol"))),this.icon=new G0(new Cs(this.layers,{zoom:this.zoom,lut:this.lut},i=>i.startsWith("icon")||i.startsWith("symbol"))),this.glyphOffsetArray=new qf,this.lineVertexArray=new v_,this.symbolInstances=new Cm}calculateGlyphDependencies(i,o,c,h,m){for(const g of i){const x=g.codePointAt(0);if(void 0===x)break;if(o[x]=!0,h&&m&&x<=65535){const w=_c[g];w&&(o[w.charCodeAt(0)]=!0)}}}updateFootprints(i,o){}updateReplacement(i,o){if(o.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=o.updateTime;const c=o.getReplacementRegionsForTile(i.toUnwrapped(),!0);return!V_(this.activeReplacements,c)&&(this.activeReplacements=c,!0)}populate(i,o,c,h){const m=this.layers[0],g=m.layout,x="globe"===this.projection.name,w=g.get("text-font"),T=g.get("text-field"),I=g.get("icon-image"),[A,M]=g.get("icon-size-scale-range"),k=se(o.scaleFactor||1,A,M),L=("constant"!==T.value.kind||T.value.value instanceof Kr&&!T.value.value.isEmpty()||T.value.value.toString().length>0)&&("constant"!==w.value.kind||w.value.value.length>0),V="constant"!==I.value.kind||!!I.value.value||Object.keys(I.parameters).length>0,j=g.get("symbol-sort-key");if(this.features=[],!L&&!V)return;const W=o.iconDependencies,Q=o.glyphDependencies,K=o.availableImages,te=new Tn(this.zoom,{worldview:this.worldview});for(const{feature:me,id:he,index:fe,sourceLayerIndex:xe}of i){const Ee=m._featureFilter.needGeometry,Ve=Ne(me,Ee);if(!m._featureFilter.filter(te,Ve,c))continue;if(Ee||(Ve.geometry=_e(me,c,h)),x&&1!==me.type&&c.z<=5){const Ke=Ve.geometry,nt=.98078528056,ze=(Qe,Ae)=>ar(km(Qe.x,Qe.y,c,1),km(Ae.x,Ae.y,c,1))<nt;for(let Qe=0;Qe<Ke.length;Qe++)Ke[Qe]=Fe(Ke[Qe],ze)}let Ce,Ue;if(L){const Ke=m.getValueAndResolveTokens("text-field",Ve,c,K),nt=Kr.factory(Ke);wT(nt)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===dr()||this.hasRTLText&&Gs.isParsed())&&(Ce=hu(nt,m,Ve))}if(V){const Ke=m.getValueAndResolveTokens("icon-image",Ve,c,K);Ue="string"==typeof Ke?vo.build(Ke):Ke}if(!Ce&&!Ue)continue;const ot=this.sortFeaturesByKey?j.evaluate(Ve,{},c):void 0,$e={id:he,text:Ce,icon:Ue,index:fe,sourceLayerIndex:xe,geometry:Ve.geometry,properties:me.properties,type:xT[me.type],sortKey:ot};if(this.features.push($e),Ue){const Ke=this.layers[0]._unevaluatedLayout._values,{iconPrimary:nt,iconSecondary:ze}=wy(Ue,this.iconSizeData,Ke["icon-size"],c,this.zoom,$e,this.pixelRatio,k,this.worldview),Qe=nt.id.toString();if(W.has(Qe)?W.get(Qe).push(nt):W.set(Qe,[nt]),ze){this.hasAnySecondaryIcon=!0;const Ae=ze.id.toString();W.has(Ae)?W.get(Ae).push(ze):W.set(Ae,[ze])}}if(Ce){const Ke=w.evaluate(Ve,{},c).join(","),nt="map"===g.get("text-rotation-alignment")&&"point"!==g.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Ps.vertical)>=0;for(const ze of Ce.sections)if(ze.image){const Qe=ze.image.getPrimary().scaleSelf(this.pixelRatio),Ae=Qe.id.toString(),Be=W.get(Ae)||[];Be.push(Qe),W.set(Ae,Be)}else{const Qe=Lf(Ce.toString()),Ae=ze.fontStack||Ke,Be=Q[Ae]=Q[Ae]||{};this.calculateGlyphDependencies(ze.text,Be,nt,this.allowVerticalPlacement,Qe)}}}if("line"===g.get("symbol-placement")&&(this.features=function(me){const he={},fe={},xe=[];let Ee=0;function Ve($e){xe.push(me[$e]),Ee++}function Ce($e,Ke,nt){const ze=fe[$e];return delete fe[$e],fe[Ke]=ze,xe[ze].geometry[0].pop(),xe[ze].geometry[0]=xe[ze].geometry[0].concat(nt[0]),ze}function Ue($e,Ke,nt){const ze=he[Ke];return delete he[Ke],he[$e]=ze,xe[ze].geometry[0].shift(),xe[ze].geometry[0]=nt[0].concat(xe[ze].geometry[0]),ze}function ot($e,Ke,nt){const ze=nt?Ke[0][Ke[0].length-1]:Ke[0][0];return`${$e}:${ze.x}:${ze.y}`}for(let $e=0;$e<me.length;$e++){const Ke=me[$e],nt=Ke.geometry,ze=Ke.text?Ke.text.toString():null;if(!ze){Ve($e);continue}const Qe=ot(ze,nt),Ae=ot(ze,nt,!0);if(Qe in fe&&Ae in he&&fe[Qe]!==he[Ae]){const Be=Ue(Qe,Ae,nt),at=Ce(Qe,Ae,xe[Be].geometry);delete he[Qe],delete fe[Ae],fe[ot(ze,xe[at].geometry,!0)]=at,xe[Be].geometry=null}else Qe in fe?Ce(Qe,Ae,nt):Ae in he?Ue(Qe,Ae,nt):(Ve($e),he[Qe]=Ee-1,fe[Ae]=Ee-1)}return xe.filter($e=>$e.geometry)}(this.features)),"hd-road-markup"===g.get("symbol-elevation-reference")){if(this.elevationType="road",o.elevationFeatures){!this.elevationFeatures&&o.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const me of o.elevationFeatures)this.elevationFeatureIdToIndex.set(me.id,this.elevationFeatures.length),this.elevationFeatures.push(me)}}else g.get("symbol-z-elevate")&&(this.elevationType="offset");"none"!==this.elevationType&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((me,he)=>me.sortKey-he.sortKey)}update(i,o,c,h,m,g,x){this.text.programConfigurations.updatePaintArrays(i,o,m,c,h,g,x,this.worldview),this.icon.programConfigurations.updatePaintArrays(i,o,m,c,h,g,x,this.worldview)}updateRoadElevation(i){if("road"!==this.elevationType||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let o=!1;const c=ce(i),h=1/c;let m=!1,g=!1;for(let x=0;x<this.symbolInstances.length;x++){const w=this.symbolInstances.get(x),T=mr(1,0,0),I=mr(0,1,0),{numHorizontalGlyphVertices:A,numVerticalGlyphVertices:M,numIconVertices:k,numVerticalIconVertices:L}=w,V=A>0||M>0,j=k>0,W=this.elevationFeatures[w.elevationFeatureIndex];if(W){const Q=new Je(w.tileAnchorX,w.tileAnchorY),K=.075+W.pointElevation(Q);w.zOffset!==K&&(o=!0,w.zOffset=K);const te=W.computeSlopeNormal(Q,h),me=Au(Za(),mr(0,0,1),te);Ma(T,T,me),Ma(I,I,me),T[2]*=c,I[2]*=c,1===T[0]&&0===T[1]&&0===T[2]&&0===I[0]&&1===I[1]&&0===I[2]||(m=m||V,g=g||j)}if(V&&(Zh(this.text.orientationVertexArray,A,T,I),Zh(this.text.orientationVertexArray,M,T,I)),j){const{placedIconSymbolIndex:Q,verticalPlacedIconSymbolIndex:K}=w;Q>=0&&Zh(this.icon.orientationVertexArray,k,T,I),K>=0&&Zh(this.icon.orientationVertexArray,L,T,I)}}m||(this.text.orientationVertexArray=void 0),g||(this.icon.orientationVertexArray=void 0),o&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const i=(m,g,x)=>{c+=g,c>m.length&&m.resize(c);for(let w=-g;w<0;w++)m.emplace(w+c,x)},o=(m,g,x)=>{h+=g,h>m.length&&m.resize(h);for(let w=-g;w<0;w++)m.emplace(w+h,x)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let c=0,h=0;for(let m=0;m<this.symbolInstances.length;m++){const g=this.symbolInstances.get(m),{numHorizontalGlyphVertices:x,numVerticalGlyphVertices:w,numIconVertices:T}=g,I=g.zOffset,A=T>0;if((x>0||w>0)&&(i(this.text.zOffsetVertexArray,x,I),i(this.text.zOffsetVertexArray,w,I)),A){const{placedIconSymbolIndex:M,verticalPlacedIconSymbolIndex:k}=g;M>=0&&o(this.icon.zOffsetVertexArray,T,I),k>=0&&o(this.icon.zOffsetVertexArray,g.numVerticalIconVertices,I)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(i){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(i),this.iconCollisionBox.upload(i)),this.text.upload(i,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(i,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Ew(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(i,o){const c=this.lineVertexArray.length;if(void 0!==i.segment)for(const{x:h,y:m}of o)this.lineVertexArray.emplaceBack(h,m);return{lineStartIndex:c,lineLength:this.lineVertexArray.length-c}}addSymbols(i,o,c,h,m,g,x,w,T,I,A,M,k,L,V,j){const W=i.indexArray,Q=i.layoutVertexArray,K=i.globeExtVertexArray,te=i.segments.prepareSegment(4*o.length,Q,W,this.canOverlap?g.sortKey:void 0),me=this.glyphOffsetArray.length,he=te.vertexLength,fe=this.allowVerticalPlacement&&x===Ps.vertical?Math.PI/2:0,xe=g.text&&g.text.sections;for(let Ve=0;Ve<o.length;Ve++){const{tl:Ce,tr:Ue,bl:ot,br:$e,texPrimary:Ke,texSecondary:nt,pixelOffsetTL:ze,pixelOffsetBR:Qe,minFontScaleX:Ae,minFontScaleY:Be,glyphOffset:at,isSDF:et,sectionIndex:Ft}=o[Ve],St=te.vertexLength,Xe=at[1];if(bg(Q,T.x,T.y,Ce.x,Xe+Ce.y,Ke.x,Ke.y,c,et,ze.x,ze.y,Ae,Be),bg(Q,T.x,T.y,Ue.x,Xe+Ue.y,Ke.x+Ke.w,Ke.y,c,et,Qe.x,ze.y,Ae,Be),bg(Q,T.x,T.y,ot.x,Xe+ot.y,Ke.x,Ke.y+Ke.h,c,et,ze.x,Qe.y,Ae,Be),bg(Q,T.x,T.y,$e.x,Xe+$e.y,Ke.x+Ke.w,Ke.y+Ke.h,c,et,Qe.x,Qe.y,Ae,Be),w){const{x:tt,y:It,z:yt}=w.anchor,[ft,xt,zt]=w.up;Sy(K,tt,It,yt,ft,xt,zt),Sy(K,tt,It,yt,ft,xt,zt),Sy(K,tt,It,yt,ft,xt,zt),Sy(K,tt,It,yt,ft,xt,zt),Cy(i.dynamicLayoutVertexArray,tt,It,yt,fe)}else Cy(i.dynamicLayoutVertexArray,T.x,T.y,T.z,fe);if(j){const tt=nt||Ke;zi(i.iconTransitioningVertexArray,tt.x,tt.y),zi(i.iconTransitioningVertexArray,tt.x+tt.w,tt.y),zi(i.iconTransitioningVertexArray,tt.x,tt.y+tt.h),zi(i.iconTransitioningVertexArray,tt.x+tt.w,tt.y+tt.h)}W.emplaceBack(St,St+1,St+2),W.emplaceBack(St+1,St+2,St+3),te.vertexLength+=4,te.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(at[0]),Ve!==o.length-1&&Ft===o[Ve+1].sectionIndex||i.programConfigurations.populatePaintArrays(Q.length,g,g.index,{},k,L,V,xe&&xe[Ft],this.worldview)}const Ee=w?w.anchor:T;i.placedSymbolArray.emplaceBack(Ee.x,Ee.y,Ee.z,T.x,T.y,me,this.glyphOffsetArray.length-me,he,I,A,T.segment,c?c[0]:0,c?c[1]:0,h[0],h[1],x,0,0,0,M,0)}_commitLayoutVertex(i,o,c,h,m,g,x){i.emplaceBack(o,c,h,m,g,Math.round(x.x),Math.round(x.y))}_addCollisionDebugVertices(i,o,c,h,m,g,x){const w=c.segments.prepareSegment(4,c.layoutVertexArray,c.indexArray),T=w.vertexLength,I=x.tileAnchorX,A=x.tileAnchorY;for(let k=0;k<4;k++)c.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(c.collisionVertexArrayExt,o,i.padding,x.zOffset),this._commitLayoutVertex(c.layoutVertexArray,h,m,g,I,A,new Je(i.x1,i.y1)),this._commitLayoutVertex(c.layoutVertexArray,h,m,g,I,A,new Je(i.x2,i.y1)),this._commitLayoutVertex(c.layoutVertexArray,h,m,g,I,A,new Je(i.x2,i.y2)),this._commitLayoutVertex(c.layoutVertexArray,h,m,g,I,A,new Je(i.x1,i.y2)),w.vertexLength+=4;const M=c.indexArray;M.emplaceBack(T,T+1),M.emplaceBack(T+1,T+2),M.emplaceBack(T+2,T+3),M.emplaceBack(T+3,T),w.primitiveLength+=4}_addTextDebugCollisionBoxes(i,o,c,h,m,g){for(let x=h;x<m;x++){const w=c.get(x),T=this.getSymbolInstanceTextSize(i,g,o,x);this._addCollisionDebugVertices(w,T,this.textCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,g)}}_addIconDebugCollisionBoxes(i,o,c,h,m,g){for(let x=h;x<m;x++){const w=c.get(x),T=this.getSymbolInstanceIconSize(i,o,g.placedIconSymbolIndex);this._addCollisionDebugVertices(w,T,this.iconCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,g)}}generateCollisionDebugBuffers(i,o,c){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new $0(yh,tw.members,va),this.iconCollisionBox=new $0(yh,tw.members,va);const h=ug(this.iconSizeData,i),m=ug(this.textSizeData,i,c);for(let g=0;g<this.symbolInstances.length;g++){const x=this.symbolInstances.get(g);this._addTextDebugCollisionBoxes(m,i,o,x.textBoxStartIndex,x.textBoxEndIndex,x),this._addTextDebugCollisionBoxes(m,i,o,x.verticalTextBoxStartIndex,x.verticalTextBoxEndIndex,x),this._addIconDebugCollisionBoxes(h,i,o,x.iconBoxStartIndex,x.iconBoxEndIndex,x),this._addIconDebugCollisionBoxes(h,i,o,x.verticalIconBoxStartIndex,x.verticalIconBoxEndIndex,x)}}getSymbolInstanceTextSize(i,o,c,h){const m=this.text.placedSymbolArray.get(o.rightJustifiedTextSymbolIndex>=0?o.rightJustifiedTextSymbolIndex:o.centerJustifiedTextSymbolIndex>=0?o.centerJustifiedTextSymbolIndex:o.leftJustifiedTextSymbolIndex>=0?o.leftJustifiedTextSymbolIndex:o.verticalPlacedTextSymbolIndex>=0?o.verticalPlacedTextSymbolIndex:h),g=R0(this.textSizeData,i,m)/Pr;return this.tilePixelRatio*g}getSymbolInstanceIconSize(i,o,c){const h=this.icon.placedSymbolArray.get(c),m=R0(this.iconSizeData,i,h);return this.tilePixelRatio*m}_commitDebugCollisionVertexUpdate(i,o,c,h){i.emplaceBack(o,-c,-c,h),i.emplaceBack(o,c,-c,h),i.emplaceBack(o,c,c,h),i.emplaceBack(o,-c,c,h)}_updateTextDebugCollisionBoxes(i,o,c,h,m,g,x){for(let w=h;w<m;w++){const T=c.get(w),I=this.getSymbolInstanceTextSize(i,g,o,w);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,I,T.padding,g.zOffset)}}_updateIconDebugCollisionBoxes(i,o,c,h,m,g,x){for(let w=h;w<m;w++){const T=c.get(w),I=this.getSymbolInstanceIconSize(i,o,g.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,I,T.padding,g.zOffset)}}updateCollisionDebugBuffers(i,o,c,h){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const m=ug(this.iconSizeData,i,h),g=ug(this.textSizeData,i,c);for(let x=0;x<this.symbolInstances.length;x++){const w=this.symbolInstances.get(x);this._updateTextDebugCollisionBoxes(g,i,o,w.textBoxStartIndex,w.textBoxEndIndex,w,c),this._updateTextDebugCollisionBoxes(g,i,o,w.verticalTextBoxStartIndex,w.verticalTextBoxEndIndex,w,c),this._updateIconDebugCollisionBoxes(m,i,o,w.iconBoxStartIndex,w.iconBoxEndIndex,w,h),this._updateIconDebugCollisionBoxes(m,i,o,w.verticalIconBoxStartIndex,w.verticalIconBoxEndIndex,w,h)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(i,o,c,h,m,g,x,w,T){const I={};if(o<c){const{x1:A,y1:M,x2:k,y2:L,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te,featureIndex:me}=i.get(o);I.textBox={x1:A,y1:M,x2:k,y2:L,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te},I.textFeatureIndex=me}if(h<m){const{x1:A,y1:M,x2:k,y2:L,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te,featureIndex:me}=i.get(h);I.verticalTextBox={x1:A,y1:M,x2:k,y2:L,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te},I.verticalTextFeatureIndex=me}if(g<x){const{x1:A,y1:M,x2:k,y2:L,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te,featureIndex:me}=i.get(g);I.iconBox={x1:A,y1:M,x2:k,y2:L,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te},I.iconFeatureIndex=me}if(w<T){const{x1:A,y1:M,x2:k,y2:L,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te,featureIndex:me}=i.get(w);I.verticalIconBox={x1:A,y1:M,x2:k,y2:L,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te},I.verticalIconFeatureIndex=me}return I}deserializeCollisionBoxes(i){this.collisionArrays=[];for(let o=0;o<this.symbolInstances.length;o++){const c=this.symbolInstances.get(o);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(i,c.textBoxStartIndex,c.textBoxEndIndex,c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c.iconBoxStartIndex,c.iconBoxEndIndex,c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(i,o){const c=i.placedSymbolArray.get(o),h=c.vertexStartIndex+4*c.numGlyphs;for(let m=c.vertexStartIndex;m<h;m+=4)i.indexArray.emplaceBack(m,m+1,m+2),i.indexArray.emplaceBack(m+1,m+2,m+3)}getSortedSymbolIndexes(i){if(this.sortedAngle===i&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const o=Math.sin(i),c=Math.cos(i),h=[],m=[],g=[];for(let x=0;x<this.symbolInstances.length;++x){g.push(x);const w=this.symbolInstances.get(x);h.push(0|Math.round(o*w.tileAnchorX+c*w.tileAnchorY)),m.push(w.featureIndex)}return g.sort((x,w)=>h[x]-h[w]||m[w]-m[x]),g}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let i=0;i<this.symbolInstances.length;++i)this.symbolInstanceIndexesSortedZOffset.push(i)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((i,o)=>this.symbolInstances.get(o).zOffset-this.symbolInstances.get(i).zOffset)}addToSortKeyRanges(i,o){const c=this.sortKeyRanges[this.sortKeyRanges.length-1];c&&c.sortKey===o?c.symbolInstanceEnd=i+1:this.sortKeyRanges.push({sortKey:o,symbolInstanceStart:i,symbolInstanceEnd:i+1})}sortFeatures(i){if(this.sortFeaturesByY&&this.sortedAngle!==i&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(i),this.sortedAngle=i,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const o of this.symbolInstanceIndexes){const c=this.symbolInstances.get(o);this.featureSortOrder.push(c.featureIndex);const{rightJustifiedTextSymbolIndex:h,centerJustifiedTextSymbolIndex:m,leftJustifiedTextSymbolIndex:g,verticalPlacedTextSymbolIndex:x,placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:T}=c;h>=0&&this.addIndicesForPlacedSymbol(this.text,h),m>=0&&m!==h&&this.addIndicesForPlacedSymbol(this.text,m),g>=0&&g!==m&&g!==h&&this.addIndicesForPlacedSymbol(this.text,g),x>=0&&this.addIndicesForPlacedSymbol(this.text,x),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w),T>=0&&this.addIndicesForPlacedSymbol(this.icon,T)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Tw,Dw,Ay;Et(Iy,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Iy.addDynamicAttributes=Cy;class q0{constructor(i){this.type=i.property.overrides?i.property.overrides.runtimeType:Oc,this.defaultValue=i}evaluate(i){if(i.formattedSection){const o=this.defaultValue.property.overrides;if(o&&o.hasOverride(i.formattedSection))return o.getOverride(i.formattedSection)}return i.feature&&i.featureState?this.defaultValue.evaluate(i.feature,i.featureState):this.defaultValue.property.specification.default}eachChild(i){this.defaultValue.isConstant()||i(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Et(q0,"FormatSectionOverride",{omit:["defaultValue"]});const W0=()=>Ay||(Ay={layout:Tw||(Tw=new Ki({"symbol-placement":new it(Se.layout_symbol["symbol-placement"]),"symbol-spacing":new it(Se.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new it(Se.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new _t(Se.layout_symbol["symbol-sort-key"]),"symbol-z-order":new it(Se.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new it(Se.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new it(Se.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new it(Se.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new it(Se.layout_symbol["icon-ignore-placement"]),"icon-optional":new it(Se.layout_symbol["icon-optional"]),"icon-rotation-alignment":new it(Se.layout_symbol["icon-rotation-alignment"]),"icon-size":new _t(Se.layout_symbol["icon-size"]),"icon-size-scale-range":new it(Se.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new _t(Se.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new _t(Se.layout_symbol["icon-text-fit-padding"]),"icon-image":new _t(Se.layout_symbol["icon-image"]),"icon-rotate":new _t(Se.layout_symbol["icon-rotate"]),"icon-padding":new it(Se.layout_symbol["icon-padding"]),"icon-keep-upright":new it(Se.layout_symbol["icon-keep-upright"]),"icon-offset":new _t(Se.layout_symbol["icon-offset"]),"icon-anchor":new _t(Se.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new it(Se.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new it(Se.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new it(Se.layout_symbol["text-rotation-alignment"]),"text-field":new _t(Se.layout_symbol["text-field"]),"text-font":new _t(Se.layout_symbol["text-font"]),"text-size":new _t(Se.layout_symbol["text-size"]),"text-size-scale-range":new it(Se.layout_symbol["text-size-scale-range"]),"text-max-width":new _t(Se.layout_symbol["text-max-width"]),"text-line-height":new _t(Se.layout_symbol["text-line-height"]),"text-letter-spacing":new _t(Se.layout_symbol["text-letter-spacing"]),"text-justify":new _t(Se.layout_symbol["text-justify"]),"text-radial-offset":new _t(Se.layout_symbol["text-radial-offset"]),"text-variable-anchor":new it(Se.layout_symbol["text-variable-anchor"]),"text-anchor":new _t(Se.layout_symbol["text-anchor"]),"text-max-angle":new it(Se.layout_symbol["text-max-angle"]),"text-writing-mode":new it(Se.layout_symbol["text-writing-mode"]),"text-rotate":new _t(Se.layout_symbol["text-rotate"]),"text-padding":new it(Se.layout_symbol["text-padding"]),"text-keep-upright":new it(Se.layout_symbol["text-keep-upright"]),"text-transform":new _t(Se.layout_symbol["text-transform"]),"text-offset":new _t(Se.layout_symbol["text-offset"]),"text-allow-overlap":new it(Se.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new it(Se.layout_symbol["text-ignore-placement"]),"text-optional":new it(Se.layout_symbol["text-optional"]),visibility:new it(Se.layout_symbol.visibility)})),paint:Dw||(Dw=new Ki({"icon-opacity":new _t(Se.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new _t(Se.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new _t(Se.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new _t(Se.paint_symbol["text-emissive-strength"]),"icon-color":new _t(Se.paint_symbol["icon-color"]),"icon-halo-color":new _t(Se.paint_symbol["icon-halo-color"]),"icon-halo-width":new _t(Se.paint_symbol["icon-halo-width"]),"icon-halo-blur":new _t(Se.paint_symbol["icon-halo-blur"]),"icon-translate":new it(Se.paint_symbol["icon-translate"]),"icon-translate-anchor":new it(Se.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new it(Se.paint_symbol["icon-image-cross-fade"]),"text-opacity":new _t(Se.paint_symbol["text-opacity"]),"text-occlusion-opacity":new _t(Se.paint_symbol["text-occlusion-opacity"]),"text-color":new _t(Se.paint_symbol["text-color"],{runtimeType:gi,getOverride:a=>a.textColor,hasOverride:a=>!!a.textColor}),"text-halo-color":new _t(Se.paint_symbol["text-halo-color"]),"text-halo-width":new _t(Se.paint_symbol["text-halo-width"]),"text-halo-blur":new _t(Se.paint_symbol["text-halo-blur"]),"text-translate":new it(Se.paint_symbol["text-translate"]),"text-translate-anchor":new it(Se.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new it(Se.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new it(Se.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new it(Se.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new it(Se.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new _t(Se.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},Ay);class Z0 extends So{constructor(i,o,c,h){super(i,W0(),o,c,h),this._colorAdjustmentMatrix=fn([]),this.hasInitialOcclusionOpacityProperties=void 0!==i.paint&&("icon-occlusion-opacity"in i.paint||"text-occlusion-opacity"in i.paint)}recalculate(i,o){super.recalculate(i,o),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const c=this.layout.get("text-writing-mode");if(c){const h=[];for(const m of c)h.indexOf(m)<0&&h.push(m);this.layout._values["text-writing-mode"]=h}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(i,o,c,h){return this._saturation===i&&this._contrast===o&&this._brightnessMin===c&&this._brightnessMax===h||(this._colorAdjustmentMatrix=function(m,g,x,w){m=_o(m),g=Ho(g);const T=Nl(),I=m/3,A=1-2*I,M=[A,I,I,0,I,A,I,0,I,I,A,0,0,0,0,1],k=.5-.5*g,L=w-x;return Ui(T,[L,0,0,0,0,L,0,0,0,0,L,0,x,x,x,1],[g,0,0,0,0,g,0,0,0,0,g,0,k,k,k,1]),Ui(T,T,M),T}(i,o,c,h),this._saturation=i,this._contrast=o,this._brightnessMin=c,this._brightnessMax=h),this._colorAdjustmentMatrix}getValueAndResolveTokens(i,o,c,h){const m=this.layout.get(i).evaluate(o,{},c,h),g=this._unevaluatedLayout._values[i];return g.isDataDriven()||d_(g.value)||!m?m:(x=o.properties,m.replace(/{([^{}]+)}/g,(T,I)=>I in x?String(x[I]):""));var x}createBucket(i){return new Iy(i)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const i of W0().paint.overridableProperties){if(!Z0.hasPaintOverride(this.layout,i))continue;const o=this.paint.get(i),c=new q0(o),h=new u_(c,o.property.specification,this.scope,this.options);let m=null;m="constant"===o.value.kind||"source"===o.value.kind?new Of("source",h):new Zc("composite",h,o.value.zoomStops,o.value.interpolationType),this.paint._values[i]=new Xc(o.property,m,o.parameters)}}_handleOverridablePaintPropertyUpdate(i,o,c){return!(!this.layout||o.isDataDriven()||c.isDataDriven())&&Z0.hasPaintOverride(this.layout,i)}static hasPaintOverride(i,o){const c=i.get("text-field"),h=W0().paint.properties[o];let m=!1;const g=x=>{for(const w of x)if(h.overrides&&h.overrides.hasOverride(w))return void(m=!0)};if("constant"===c.value.kind&&c.value.value instanceof Kr)g(c.value.value.sections);else if("source"===c.value.kind){const x=T=>{m||(T instanceof Vt&&bt(T.value)===Fc?g(T.value.sections):T instanceof gt?g(T.sections):T.eachChild(x))},w=c.value;w._styleExpression&&x(w._styleExpression.expression)}return m}getProgramIds(){return["symbol"]}getDefaultProgramParams(i,o,c){return{config:new qo(this,{zoom:o,lut:c}),overrideFog:!1}}hasElevation(){return this.layout&&"hd-road-markup"===this.layout.get("symbol-elevation-reference")}}let X0,Sw,ET,wg;var Y0=En([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function My(a,i,o,c,h,m,g,x){const w=[a,i,1,o,c,1,h,m,1],T=[g,x,1],I=Fs([],w),[A,M,k]=Ls(T,T,I);return ks(w,w,[A,0,0,0,M,0,0,0,k])}function Py(a,i,o,c,h,m,g,x){const w=function(T,I,A,M,k,L,V,j){const W=My(0,0,1,0,1,1,0,1),Q=My(T,I,A,M,k,L,V,j);return ks(Q,Q,Fs([],W))}(a,i,o,c,h,m,g,x);return[w[2]/w[8]/ht,w[5]/w[8]/ht]}function Ry(a){return[a[0],Math.min(Math.max(a[1],-le),le)]}class Dl extends Nu{constructor(i,o,c,h){super(),this.id=i,this.dispatcher=c,this.coordinates=o.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(h),this.options=o,this._dirty=!1}load(i,o){if(this._loaded=o||!1,this.fire(new Yr("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return i&&(this.coordinates=i),this._loaded=!0,void this._finishLoading();this._imageRequest=fa(this.map._requestManager.transformRequest(this.url,Li.Image),(c,h)=>{this._imageRequest=null,this._loaded=!0,c?this.fire(new _n(c)):h&&(this.image=h instanceof HTMLImageElement?Zs.getImageData(h):h,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,i&&(this.coordinates=i),this._finishLoading())})}loaded(){return this._loaded}updateImage(i){return i.url?(this._imageRequest&&i.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=i.url,this.load(i.coordinates,this._loaded),this):this}setTexture(i){if(!(i.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new _d(this.map.painter.context,i.handle),this.width=i.dimensions[0],this.height=i.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Yr("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(i){this.map=i,this.load()}onRemove(i){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof _d||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(i){if(this.coordinates=i,this._boundsArray=void 0,this._unsupportedCoords=!1,!i.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let o=i[0][1],c=i[0][1];for(const m of i)m[1]>c&&(c=m[1]),m[1]<o&&(o=m[1]);const h=(c+o)/2;if(h>le?this.onNorthPole=!0:h<-le&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const m=i.map(ue.fromLngLat);this.tileID=function(g){let x=1/0,w=1/0,T=-1/0,I=-1/0;for(const V of g)x=Math.min(x,V.x),w=Math.min(w,V.y),T=Math.max(T,V.x),I=Math.max(I,V.y);const A=Math.max(T-x,I-w),M=Math.max(0,Math.floor(-Math.log(A)/Math.LN2)),k=Math.pow(2,M);let L=Math.floor((x+T)/2*k);return L>1&&(L-=1),new Wo(M,L,Math.floor((w+I)/2*k))}(m),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Yr("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof _d||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(i){for(const W in this.tiles){const Q=this.tiles[W];"loaded"!==Q.state&&(Q.state="loaded",Q.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const o=xp(new Wo(0,0,0),this.map.transform.projection),c=[o.projection.project(this.coordinates[0][0],this.coordinates[0][1]),o.projection.project(this.coordinates[1][0],this.coordinates[1][1]),o.projection.project(this.coordinates[2][0],this.coordinates[2][1]),o.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(W){const Q=W[1].x-W[0].x,K=W[1].y-W[0].y,te=W[2].x-W[1].x,me=W[2].y-W[1].y,he=W[3].x-W[2].x,fe=W[3].y-W[2].y,xe=W[0].x-W[3].x,Ee=W[0].y-W[3].y,Ve=Q*me-te*K,Ce=te*fe-he*me,Ue=he*Ee-xe*fe,ot=xe*K-Q*Ee;return Ve>0&&Ce>0&&Ue>0&&ot>0||Ve<0&&Ce<0&&Ue<0&&ot<0}(c))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const h=xp(this.tileID,this.map.transform.projection),[m,g,x,w]=this.coordinates.map(W=>{const Q=h.projection.project(W[0],W[1]);return mg(h,Q)._round()});this.perspectiveTransform=Py(m.x,m.y,g.x,g.y,x.x,x.y,w.x,w.y);const T=this._boundsArray=new to;T.emplaceBack(m.x,m.y,0,0),T.emplaceBack(g.x,g.y,ht,0),T.emplaceBack(w.x,w.y,0,ht),T.emplaceBack(x.x,x.y,ht,ht),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=i.createVertexBuffer(T,Y0.members),this.boundsSegments=Wi.simpleSegment(0,0,4,2);const I=[],A=[Ry((M=this.coordinates)[0]),Ry(M[1]),Ry(M[2]),Ry(M[3])];var M;const[k,L,V,j]=function(W){let Q=W[0][0],K=Q,te=W[0][1],me=te;for(let he=1;he<W.length;he++)W[he][0]<Q?Q=W[he][0]:W[he][0]>K&&(K=W[he][0]),W[he][1]<te?te=W[he][1]:W[he][1]>me&&(me=W[he][1]);return[Q,te,K-Q,me-te]}(A);{const W=new to,[Q,K,te,me]=function(ze){let Qe=ze[0].x,Ae=Qe,Be=ze[0].y,at=Be;for(let et=1;et<ze.length;et++)ze[et].x<Qe?Qe=ze[et].x:ze[et].x>Ae&&(Ae=ze[et].x),ze[et].y<Be?Be=ze[et].y:ze[et].y>at&&(at=ze[et].y);return[Qe,Be,Ae-Qe,at-Be]}(c),he=ze=>[(ze.x-Q)/te,(ze.y-K)/me],[fe,xe,Ee,Ve]=c.map(he),Ce=function(ze,Qe,Ae,Be,at,et,Ft,St){const Xe=My(0,0,1,0,1,1,0,1);return ks(Xe,Xe,Fs([],My(ze,Qe,Ae,Be,at,et,Ft,St)))}(fe[0],fe[1],xe[0],xe[1],Ee[0],Ee[1],Ve[0],Ve[1]);this.elevatedGlobePerspectiveTransform=Py(fe[0],fe[1],xe[0],xe[1],Ee[0],Ee[1],Ve[0],Ve[1]);const Ue=(ze,Qe)=>{I.push(ze.lng);const Ae=Math.round((ze.lng-k)/V*ht),Be=Math.round((ze.lat-L)/j*ht),at=he(Qe),et=Ls([],[at[0],at[1],1],Ce),Ft=Math.round(et[0]/et[2]*ht),St=Math.round(et[1]/et[2]*ht);W.emplaceBack(Ae,Be,Ft,St)},ot=c[3].x-c[0].x,$e=c[3].y-c[0].y,Ke=c[2].x-c[1].x,nt=c[2].y-c[1].y;for(let ze=0;ze<65;ze++){const Qe=ze/64,Ae=[c[0].x+Qe*ot,c[0].y+Qe*$e],Be=[c[1].x+Qe*Ke,c[1].y+Qe*nt],at=Be[0]-Ae[0],et=Be[1]-Ae[1];for(let Ft=0;Ft<65;Ft++){const St=Ft/64,Xe={x:Ae[0]+at*St,y:Ae[1]+et*St};Ue(o.projection.unproject(Xe.x,Xe.y),Xe)}}this.elevatedGlobeVertexBuffer=i.createVertexBuffer(W,Y0.members)}{this.maxLongitudeTriangleSize=0;let W=[],Q=new Pi;const K=(te,me,he)=>{Q.emplaceBack(te,me,he);const fe=I[te],xe=I[me],Ee=I[he],Ve=Math.min(Math.min(fe,xe),Ee),Ce=Math.max(Math.max(fe,xe),Ee)-Ve;Ce>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Ce),W.push(Ve+Ce/2)};for(let te=0;te<64;te++)for(let me=0;me<64;me++){const he=65*te+me,fe=he+1,xe=he+65,Ee=xe+1;K(he,xe,fe),K(fe,xe,Ee)}[W,Q]=function(te,me){const he=Array.from({length:te.length},(Ee,Ve)=>Ve);he.sort((Ee,Ve)=>te[Ee]-te[Ve]);const fe=[],xe=new Pi;for(let Ee=0;Ee<he.length;Ee++){const Ve=he[Ee];fe.push(te[Ve]);const Ce=3*Ve,Ue=Ce+1;xe.emplaceBack(me.uint16[Ce],me.uint16[Ue],me.uint16[Ue+1])}return[fe,xe]}(W,Q),this.elevatedGlobeTrianglesCenterLongitudes=W,this.elevatedGlobeIndexBuffer=i.createIndexBuffer(Q)}this.elevatedGlobeSegments=Wi.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,V/ht,0,j/ht,0,0,L,k,0])}prepare(){const i=0!==Object.keys(this.tiles).length;if(this.tileID&&!i)return;const o=this.map.painter.context,c=o.gl;!this._dirty||this.texture instanceof _d||(this.texture?this.texture.update(this.image):(this.texture=new jh(o,this.image,c.RGBA8),this.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE)),this._dirty=!1),i&&this._prepareData(o)}loadTile(i,o){this.tileID&&this.tileID.equals(i.tileID.canonical)?(this.tiles[String(i.tileID.wrap)]=i,i.buckets={},o(null)):(i.state="errored",o(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(i){const o=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!o)return null;const c=this.elevatedGlobeTrianglesCenterLongitudes;let h=(m=i+180)+360*Math.round((c[0]-m)/360);var m;const g=new Wi,x=(A,M)=>{g.segments.push({vertexOffset:0,primitiveOffset:A,vertexLength:o.segments[0].vertexLength,primitiveLength:M,sortKey:void 0,vaos:{}})},w=.51*this.maxLongitudeTriangleSize;if(Math.abs(c[0]-h)<=w){const A=Xr(c,0,c.length,h+w);return A===c.length||x(A,Si(c,A+1,c.length,h+360-w)-A),g}h<c[0]&&(h+=360);const T=Si(c,0,c.length,h-w);if(T===c.length)return x(0,c.length),g;x(0,T-0);const I=Xr(c,T+1,c.length,h+w);return I!==c.length&&x(I,c.length-I),g}}const Eg=(Math.pow(256,2)-1)/16907520;class gs extends So{constructor(i,o,c,h){super(i,{layout:ET||(ET=new Ki({visibility:new it(Se.layout_raster.visibility)})),paint:wg||(wg=new Ki({"raster-opacity":new it(Se.paint_raster["raster-opacity"]),"raster-color":new Yc(Se.paint_raster["raster-color"]),"raster-color-mix":new it(Se.paint_raster["raster-color-mix"]),"raster-color-range":new it(Se.paint_raster["raster-color-range"]),"raster-hue-rotate":new it(Se.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new it(Se.paint_raster["raster-brightness-min"]),"raster-brightness-max":new it(Se.paint_raster["raster-brightness-max"]),"raster-saturation":new it(Se.paint_raster["raster-saturation"]),"raster-contrast":new it(Se.paint_raster["raster-contrast"]),"raster-resampling":new it(Se.paint_raster["raster-resampling"]),"raster-fade-duration":new it(Se.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new it(Se.paint_raster["raster-emissive-strength"]),"raster-array-band":new it(Se.paint_raster["raster-array-band"]),"raster-elevation":new it(Se.paint_raster["raster-elevation"]),"raster-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},o,c,h),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(i){return!(i&&i._source instanceof Dl&&(i._source.onNorthPole||i._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(i){"raster-color"!==i&&"raster-color-range"!==i||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(i){if(!this.hasColorMap()||!this._curRampRange)return;const o=this._transitionablePaint._values["raster-color"].value.expression,[c,h]=i||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(c)&&isNaN(h)||c===this._curRampRange[0]&&h===this._curRampRange[1]||(this.colorRamp=Vm({expression:o,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:c,end:h}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[c,h])}}let Td,Tg,Ea,ja,Xh;class Yh extends So{constructor(i,o,c,h){super(i,{layout:Td||(Td=new Ki({visibility:new it(Se["layout_raster-particle"].visibility)})),paint:Tg||(Tg=new Ki({"raster-particle-array-band":new it(Se["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new it(Se["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Yc(Se["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new it(Se["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new it(Se["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new it(Se["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new it(Se["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new it(Se["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},o,c,h),this._updateColorRamp(),this.lastInvalidatedAt=Zs.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(i){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(i){return!1}_handleSpecialPaintPropertyUpdate(i){"raster-particle-color"!==i&&"raster-particle-max-speed"!==i||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===i&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const i=this._transitionablePaint._values["raster-particle-color"].value.expression,o=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Vm({expression:i,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:o}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Zs.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class Tp extends So{constructor(i,o){super(i,{},o,null),this.implementation=i,i.slot&&(this.slot=i.slot)}is3D(i){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(i){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(i){this.implementation.onAdd&&this.implementation.onAdd(i,i.painter.context.gl)}onRemove(i){this.implementation.onRemove&&this.implementation.onRemove(i,i.painter.context.gl)}}function Dd(a,i,o){const c=[0,0,1],h=Pa([]);return jl(h,h,o?-Rn(a)+Math.PI:Rn(a)),Tc(h,h,-Rn(i)),Ma(c,c,h),Mi(c,c)}const Kh={None:0,Model:1,Symbol:2,FillExtrusion:4};class _u{constructor(i,o,c,h){this.message=(i?`${i}: `:"")+c,h&&(this.identifier=h),null!=o&&o.__line__&&(this.line=o.__line__)}}function Sd(a,i){const o=-1===a.indexOf("://");try{return new URL(a,o&&i?"http://example.com":void 0),!0}catch{return!1}}class Qh{constructor(i,o){this.feature=i,this.instancedDataOffset=o,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Jh{constructor(){this.instancedDataArray=new vh,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Oy{constructor(i){this.zoom=i.zoom,this.canonical=i.canonical,this.layers=i.layers,this.layerIds=this.layers.map(o=>o.fqid),this.projection=i.projection,this.index=i.index,this.worldview=i.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=i.styleDefinedModelURLs}updateFootprints(i,o){}populate(i,o,c,h){this.tileToMeter=ce(c);const m=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:g,id:x,index:w,sourceLayerIndex:T}of i){const I=x??(g.properties&&g.properties.hasOwnProperty("id")?g.properties.id:void 0),A=Ne(g,m);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),A,c))continue;const M={id:I,sourceLayerIndex:T,index:w,geometry:m?A.geometry:_e(g,c,h),properties:g.properties,type:g.type,patterns:{}},k=this.addFeature(M,M.geometry,A);k&&o.featureIndex.insert(g,M.geometry,w,T,this.index,this.instancesPerModel[k].instancedDataArray.length,ht/32)}this.lookup=null}update(i,o,c,h){for(const m in this.instancesPerModel){const g=this.instancesPerModel[m];for(const x in i)g.idToFeaturesIndex.hasOwnProperty(x)&&(this.evaluate(g.features[g.idToFeaturesIndex[x]],i[x],g,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let i=!1;for(const o in this.instancesPerModel){const c=this.instancesPerModel[o];for(const h of c.features){const m=this.layers[0],g=h.feature,x=this.canonical,w=m.paint.get("model-rotation").evaluate(g,{},x),T=m.paint.get("model-scale").evaluate(g,{},x),I=m.paint.get("model-translation").evaluate(g,{},x);vs(h.rotation,w)&&vs(h.scale,T)&&vs(h.translation,I)||(this.evaluate(h,h.featureStates,c,!0),i=!0)}}return i}updateReplacement(i,o,c,h){if(o.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=o.updateTime;const m=o.getReplacementRegionsForTile(i.toUnwrapped(),!0);if(V_(this.activeReplacements,m))return!1;this.activeReplacements=m;let g=!1;for(const x in this.instancesPerModel){const w=this.instancesPerModel[x],T=w.instancedDataArray;for(const I of w.features){const A=I.instancedDataOffset,M=I.instancedDataCount;for(let k=0;k<M;k++){const L=16*(k+A);let V=T.float32[L+0];const j=V>ht;V=j?V-ht:V;const W=Math.floor(V),Q=T.float32[L+1];let K=!1;for(const te of this.activeReplacements)if(!PE(te,c,Kh.Model,h)&&!(te.min.x>W||W>te.max.x||te.min.y>Q||Q>te.max.y)&&(K=Fh(fc(W,Q,i.canonical,te.footprintTileId.canonical),te.footprint),K))break;T.float32[L]=K?V+ht:V,g=g||K!==j}}}return g}isEmpty(){for(const i in this.instancesPerModel)if(0!==this.instancesPerModel[i].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(i){if(!this.uploaded)for(const o in this.instancesPerModel){const c=this.instancesPerModel[o];c.instancedDataArray.length<0||0===c.instancedDataArray.length||(c.instancedDataBuffer?c.instancedDataBuffer.updateData(c.instancedDataArray):c.instancedDataBuffer=i.createVertexBuffer(c.instancedDataArray,g0.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const o in this.instancesPerModel){const c=this.instancesPerModel[o];0!==c.instancedDataArray.length&&c.instancedDataBuffer&&c.instancedDataBuffer.destroy()}const i=this.layers[0].modelManager;if(i&&this.modelUris&&this.modelsRequested)for(const o of this.modelUris)i.removeModel(o,"",!0)}addFeature(i,o,c){const h=this.layers[0],m=h.layout.get("model-id").evaluate(c,{},this.canonical);if(!m)return yn(`modelId is not evaluated for layer ${h.id} and it is not going to get rendered.`),m;(Sd(m,!1)||void 0!==this.styleDefinedModelURLs[m])&&(this.modelUris.includes(m)||this.modelUris.push(m)),this.instancesPerModel[m]||(this.instancesPerModel[m]=new Jh);const g=this.instancesPerModel[m],x=g.instancedDataArray,w=new Qh(c,x.length);for(const T of o)for(const I of T){if(I.x<0||I.x>=ht||I.y<0||I.y>=ht)continue;const A=(this.lookupDim-1)/ht,M=this.lookupDim*(I.y*A|0)+I.x*A|0;if(this.lookup){if(0!==this.lookup[M])continue;this.lookup[M]=1}this.instanceCount++;const k=x.length;x.resize(k+1),g.instancesEvaluatedElevation.push(0),x.float32[16*k]=I.x,x.float32[16*k+1]=I.y}return w.instancedDataCount=g.instancedDataArray.length-w.instancedDataOffset,w.instancedDataCount>0&&(i.id&&(g.idToFeaturesIndex[i.id]=g.features.length),g.features.push(w),this.evaluate(w,{},g,!1)),m}getModelUris(){return this.modelUris}evaluate(i,o,c,h){const m=this.layers[0],g=i.feature,x=this.canonical,w=i.rotation=m.paint.get("model-rotation").evaluate(g,o,x),T=i.scale=m.paint.get("model-scale").evaluate(g,o,x),I=i.translation=m.paint.get("model-translation").evaluate(g,o,x),A=m.paint.get("model-color").evaluate(g,o,x);A.a=m.paint.get("model-color-mix-intensity").evaluate(g,o,x);const M=[];this.maxVerticalOffset<I[2]&&(this.maxVerticalOffset=I[2]),this.maxScale=Math.max(Math.max(this.maxScale,T[0]),Math.max(T[1],T[2])),Ob(M,w,T);const k=Math.round(100*A.a)+A.b/1.05;for(let L=0;L<i.instancedDataCount;++L){const V=i.instancedDataOffset+L,j=16*V,W=c.instancedDataArray.float32;let Q=0;h&&(Q=W[j+6]-c.instancesEvaluatedElevation[V]);const K=0|W[j+1];W[j]=(0|W[j])+A.r/1.05,W[j+1]=K+A.g/1.05,W[j+2]=k,W[j+3]=1/(x.z>10?this.tileToMeter:ce(x,K)),W[j+4]=I[0],W[j+5]=I[1],W[j+6]=I[2]+Q,W[j+7]=M[0],W[j+8]=M[1],W[j+9]=M[2],W[j+10]=M[4],W[j+11]=M[5],W[j+12]=M[6],W[j+13]=M[8],W[j+14]=M[9],W[j+15]=M[10],c.instancesEvaluatedElevation[V]=I[2]}}}let K0,Q0;Et(Oy,"ModelBucket",{omit:["layers"]}),Et(Jh,"PerModelAttributes"),Et(Qh,"ModelFeature");class ef{constructor(i,o,c){this._demTile=i,this._dem=this._demTile.dem,this._scale=o,this._offset=c}static create(i,o,c){const h=c||i.findDEMTileFor(o);if(!h||!h.dem)return;const m=h.dem,g=h.tileID,x=1<<o.canonical.z-g.canonical.z;return new ef(h,m.dim/ht/x,[(o.canonical.x/x-g.canonical.x)*m.dim,(o.canonical.y/x-g.canonical.y)*m.dim])}tileCoordToPixel(i,o){const c=o*this._scale+this._offset[1];return new Je(Math.floor(i*this._scale+this._offset[0]),Math.floor(c))}getElevationAt(i,o,c,h){const m=i*this._scale+this._offset[0],g=o*this._scale+this._offset[1],x=Math.floor(m),w=Math.floor(g),T=this._dem;return h=!!h,c?Nt(Nt(T.get(x,w,h),T.get(x,w+1,h),g-w),Nt(T.get(x+1,w,h),T.get(x+1,w+1,h),g-w),m-x):T.get(x,w,h)}getElevationAtPixel(i,o,c){return this._dem.get(i,o,!!c)}getMeterToDEM(i){return(1<<this._demTile.tileID.canonical.z)*G(1,i)*this._dem.stride}}const Fy=new Float32Array(262144),Cd=new Uint8Array(262144);function J0(a){let i=0;if(a.meshes)for(const o of a.meshes)i=Math.max(i,o.aabb.max[2]);if(a.children)for(const o of a.children)i=Math.max(i,J0(o));return i}function ex(a,i,o){if(a.meshes)for(const c of a.meshes){if(c.aabb.min[0]===1/0)continue;const h=sn.applyTransform(c.aabb,a.matrix);o.insert(i,h.min[0],h.min[1],h.max[0],h.max[1])}if(a.children)for(const c of a.children)ex(c,i,o)}const tx=["","wall","door","roof","window","lamp","logo"];class ky{constructor(i){this.node=i,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:i.id,geometry:[],properties:{height:J0(i)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let i=0;const o=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const c of this.node.meshes)this.node.lightMeshIndex!==i&&(c.transformedAabb=sn.applyTransformFast(c.aabb,this.node.matrix),o.encapsulate(c.transformedAabb)),i++;this.aabb=o}return this.aabb}}class Ly{constructor(i,o,c,h,m,g,x,w){this.id=c,this.layers=i,this.layerIds=this.layers.map(T=>T.fqid),this.stateDependentLayerIds=this.layers.filter(T=>T.isStateDependent()).map(T=>T.id),this.modelTraits|=vd.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,h&&(this.modelTraits|=vd.HasMapboxMeshFeatures),m&&(this.modelTraits|=vd.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=g,this.worldview=w,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const T of o)this.nodesInfo.push(new ky(T)),ex(T,x.featureIndexArray.length,x.grid),x.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,x.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(i,o){for(const c of this.getNodesInfo()){const h=c.node;h.footprint&&o.push({footprint:h.footprint,id:i})}}update(i){const o=0!==Object.keys(i).length;if(o&&!this.stateDependentLayers.length)return;const c=o?this.stateDependentLayers:this.layers;if(!Ja(i,this.states))for(const h of c)this.evaluate(h,i);this.states=structuredClone(i)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(i){if(!this.needsUpload)return;const o=this.getNodesInfo();for(const c of o){const h=c.node;this.uploaded?this.updatePbrBuffer(h):cp(h,i,!0)}for(const c of o)iy(c.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(i){let o=!1;if(!i.meshes)return o;for(const c of i.meshes)c.pbrBuffer&&(c.pbrBuffer.updateData(c.featureArray),o=!0);return o}needsReEvaluation(i,o,c){const h=i.transform.projectionOptions,m=i.style.getBrightness(),g=this.brightness!==m;if(!this.uploaded||this.dirty||h.name!==this.projection.name||Ny(c.paint.get("model-color").value,g)||Ny(c.paint.get("model-color-mix-intensity").value,g)||Ny(c.paint.get("model-roughness").value,g)||Ny(c.paint.get("model-emissive-strength").value,g)||Ny(c.paint.get("model-height-based-emissive-strength-multiplier").value,g)){this.projection=h,this.brightness=m;const x=this.getNodesInfo();for(const w of x)w.state=null;return!0}return!1}evaluateTransform(i,o){if(i.transform.zoom===this.zoom)return;this.zoom=i.transform.zoom;const c=this.getNodesInfo(),h=this.id.canonical;for(const m of c){const g=m.feature;m.evaluatedTranslation=o.paint.get("model-translation").evaluate(g,{},h),m.evaluatedScale=o.paint.get("model-scale").evaluate(g,{},h)}}evaluate(i,o){const c=this.getNodesInfo();for(const h of c){if(!h.node.meshes)continue;const m=h.feature,g=o&&o[m.id];if(Ja(g,h.state))continue;h.state=structuredClone(g);const x=h.node.meshes&&h.node.meshes[0].featureData,w=h.evaluatedColor[2],T=h.evaluatedRMEA[2],I=this.id.canonical;if(h.hasTranslucentParts=!1,x){for(let A=0;A<tx.length;A++){const M=tx[A];M.length&&(m.properties.part=M);const k=i.paint.get("model-color").evaluate(m,g,I).toPremultipliedRenderColor(null),L=i.paint.get("model-color-mix-intensity").evaluate(m,g,I);h.evaluatedColor[A]=[k.r,k.g,k.b,L],h.evaluatedRMEA[A][0]=i.paint.get("model-roughness").evaluate(m,g,I),h.evaluatedRMEA[A][2]=i.paint.get("model-emissive-strength").evaluate(m,g,I),h.evaluatedRMEA[A][3]=k.a,h.emissionHeightBasedParams[A]=i.paint.get("model-height-based-emissive-strength-multiplier").evaluate(m,g,I),!h.hasTranslucentParts&&k.a<1&&(h.hasTranslucentParts=!0)}delete m.properties.part,TT(h,w!==h.evaluatedColor[2]||T!==h.evaluatedRMEA[2],this.modelTraits)}else h.evaluatedRMEA[0][2]=i.paint.get("model-emissive-strength").evaluate(m,g,I);h.evaluatedTranslation=i.paint.get("model-translation").evaluate(m,g,I),h.evaluatedScale=i.paint.get("model-scale").evaluate(m,g,I),this.updatePbrBuffer(h.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(i,o,c,h){const m=i.findDEMTileFor(c);if(m&&(m.tileID.canonical!==this.terrainTile||o!==this.terrainExaggeration)){if(m.dem&&m.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=m.tileID.overscaledZ;const g=ef.create(i,c,m);if(!g)return;this.modelTraits&vd.HasMapboxMeshFeatures&&this.updateDEM(i,g,c,h);for(const x of this.getNodesInfo()){const w=x.node;if(!w.footprint||!w.footprint.vertices||!w.footprint.vertices.length)continue;const T=w.footprint.vertices;let I=g.getElevationAt(T[0].x,T[0].y,!0,!0);for(let A=1;A<T.length;A++)I=Math.min(I,g.getElevationAt(T[A].x,T[A].y,!0,!0));w.elevation=I}}this.terrainTile=m.tileID.canonical,this.terrainExaggeration=o}}updateDEM(i,o,c,h){let m=o._dem._modifiedForSources[h];if(void 0===m&&(o._dem._modifiedForSources[h]=[],m=o._dem._modifiedForSources[h]),m.includes(c.canonical))return;const g=o._dem.dim;m.push(c.canonical);let x=!1;for(const w of this.getNodesInfo()){const T=w.node;if(!T.footprint||!T.footprint.grid)continue;const I=T.footprint.grid,A=o.tileCoordToPixel(I.min.x,I.min.y),M=o.tileCoordToPixel(I.max.x,I.max.y),k=Math.min(Math.min(g-M.y,A.x),Math.min(A.y,g-M.x));if(k<0)continue;const L=se(k,2,5);let V=Math.max(0,A.x-L),j=Math.max(0,A.y-L),W=Math.min(M.x+L,g-1),Q=Math.min(M.y+L,g-1);for(let he=j;he<=Q;++he)for(let fe=V;fe<=W;++fe)Cd[he*g+fe]=255;let K=0,te=0;for(let he=0;he<I.cellsY;++he)for(let fe=0;fe<I.cellsX;++fe){if(!I.cells[he*I.cellsX+fe])continue;const xe=o.tileCoordToPixel(I.min.x+fe/I.xScale,I.min.y+he/I.yScale),Ee=o.tileCoordToPixel(I.min.x+(fe+1)/I.xScale,I.min.y+(he+1)/I.yScale);for(let Ve=xe.y;Ve<=Math.min(Ee.y+1,g-1);++Ve)for(let Ce=xe.x;Ce<=Math.min(Ee.x+1,g-1);++Ce)255===Cd[Ve*g+Ce]&&(Cd[Ve*g+Ce]=0,K+=o.getElevationAtPixel(Ce,Ve),te++)}const me=K/te;V=Math.max(1,A.x-L),j=Math.max(1,A.y-L),W=Math.min(M.x+L,g-2),Q=Math.min(M.y+L,g-2),x=!0;for(let he=j;he<=Q;++he)for(let fe=V;fe<=W;++fe)0===Cd[he*g+fe]&&(Fy[he*g+fe]=o._dem.set(fe,he,me));for(let he=1;he<L;++he){V=Math.max(1,A.x-he),j=Math.max(1,A.y-he),W=Math.min(M.x+he,g-2),Q=Math.min(M.y+he,g-2);for(let fe=j;fe<=Q;++fe)for(let xe=V;xe<=W;++xe){const Ee=fe*g+xe;if(255===Cd[Ee]){let Ve=0,Ce=0,Ue=-1,ot=-1;for(let $e=-1;$e<=1;++$e)for(let Ke=-1;Ke<=1;++Ke){const nt=(fe+$e)*g+xe+Ke;if(Cd[nt]>=he)continue;const ze=Fy[nt],Qe=Math.abs(ze);Qe>Ce&&(Ve=ze,Ce=Qe,Ue=Ke,ot=$e)}if(Ce>.1){const $e=1-(he+.5*Math.abs(Ue*ot))/L;let Ke=o._dem.get(xe,fe)+Ve*$e;const nt=o._dem.get(xe+Ue,fe+ot),ze=o._dem.get(xe-Ue,fe-ot,!0);(Ke-nt)*(Ke-ze)>0&&(Ke=(nt+ze)/2),Fy[Ee]=o._dem.set(xe,fe,Ke),Cd[Ee]=he}}}}}x&&(o._demTile.needsDEMTextureUpload=!0,o._dem._timestamp=Zs.now())}setFilter(i){this.filter=i?mh(i):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(i=>this.filter.filter(new Tn(this.id.overscaledZ,{worldview:this.worldview}),i.feature,this.id.canonical)):this.nodesInfo}destroy(){const i=this.getNodesInfo();for(const o of i)iy(o.node),ry(o.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(i,o){if(o.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=o.updateTime;const c=o.getReplacementRegionsForTile(i.toUnwrapped());for(const h of this.getNodesInfo()){const m=h.node.footprint;h.hiddenByReplacement=!!m&&!c.find(g=>g.footprint===m)}}getHeightAtTileCoord(i,o){const c=[],h=[0,0,0],m=fn([]);for(const g of this.getNodesInfo()){const x=g.node.meshes[0],w=x.transformedAabb;if(i<w.min[0]||o<w.min[1]||i>w.max[0]||o>w.max[1])continue;if(!0===g.node.hidden)return{height:1/0,maxHeight:g.feature.properties.height,hidden:!1,verticalScale:g.evaluatedScale[2]};es(m,g.node.matrix),h[0]=i,h[1]=o,lr(h,h,m);const T=(h[0]-x.aabb.min[0])/(x.aabb.max[0]-x.aabb.min[0])*64|0,I=64*Math.min(63,(h[1]-x.aabb.min[1])/(x.aabb.max[1]-x.aabb.min[1])*64|0)+Math.min(63,T),A=x.heightmap[I];if(!(A<0&&g.node.footprint))return g.hiddenByReplacement?void 0:{height:A,maxHeight:g.feature.properties.height,hidden:!1,verticalScale:g.evaluatedScale[2]};if(g.node.footprint.grid.query(new Je(i,o),new Je(i,o),c),c.length>0)return{height:void 0,maxHeight:g.feature.properties.height,hidden:g.hiddenByReplacement,verticalScale:g.evaluatedScale[2]}}}}function Ny(a,i){return a instanceof Of&&!a.isLightConstant&&i}function kC(a,i,o,c,h,m,g,x){let w=(61440&i|(61440&i)>>4)>>8,T=(3840&i|(3840&i)>>4)>>4,I=240&i|(240&i)>>4;o[3]>0&&(w=Nt(w,255*o[0],o[3]),T=Nt(T,255*o[1],o[3]),I=Nt(I,255*o[2],o[3]));const A=w<<8|T,M=I<<8|Math.floor(255*c[3]),k=function(he){const fe=se(he,0,2);return Math.min(Math.round(.5*fe*255),255)}(c[2])<<8|15*c[0]<<4|15*c[1],L=se(h[0],0,1),V=se(h[1],0,1),j=se(h[2],0,1),W=se(h[3],0,1);let Q,K,te,me;if(L!==V&&g!==m&&V!==L){const he=g-m;K=1/(he*(V-L)),te=-(m+he*L)/(he*(V-L));const fe=se(h[4],-1,1);me=Math.pow(10,fe),Q=255*j<<8|255*W}else Q=65535,K=0,te=1,me=1;if(a.emplaceBack(A,M,k,Q,K,te,me),x){const he=x.length;x.clear();for(let fe=0;fe<he;fe++)x.emplaceBack(A,M,k,Q,K,te,me)}}function TT(a,i,o){const c=a.node;let h=0;const m=o&vd.HasMeshoptCompression;for(const g of c.meshes){if(c.lights&&c.lightMeshIndex===h||!g.featureData)continue;g.featureArray=new tu,g.featureArray.reserve(g.featureData.length);let x=i;for(const w of g.featureData){const T=m?65535&w:w>>16&65535,I=m?w>>16&65535:65535&w,A=(15&I)<8?15&I:0,M=a.evaluatedRMEA[A],k=a.evaluatedColor[A],L=a.emissionHeightBasedParams[A];let V;if(x&&2===A&&c.lights&&(V=new tu,V.resize(10*c.lights.length)),kC(g.featureArray,T,k,M,L,g.aabb.min[2],g.aabb.max[2],V),V&&x){x=!1;const j=c.meshes[c.lightMeshIndex];j.featureArray=V,j.featureArray._trim()}}g.featureArray._trim(),h++}}function Cw(a,i,o,c){const h=1<<a.z;i.lat=ee((c/ht+a.y)/h),i.lng=Y((o/ht+a.x)/h)}function LC(a,i,o,c){const h=a.getNodesInfo()[i];if(!h||h.hiddenByReplacement||!h.node.meshes)return;let m=Number.MAX_VALUE;const g=h.node,x=o.tile,w=c.calculatePosMatrix(x.tileID.toUnwrapped(),c.worldSize),T=h.evaluatedScale;let I=0;c.elevation&&g.elevation&&(I=g.elevation*c.elevation.exaggeration()),jo(w,w,[(g.anchor?g.anchor[0]:0)*(T[0]-1),(g.anchor?g.anchor[1]:0)*(T[1]-1),I]),ro(w,w,T);const A=o.queryGeometry,M=A.isPointQuery()?A.screenBounds:A.screenGeometry,k=function(V){const j=Ui([],w,V.matrix);Ui(j,c.expandedFarZProjMatrix,j);for(let W=0;W<V.meshes.length;++W){const Q=V.meshes[W];if(W===V.lightMeshIndex)continue;const K=kb(M,c,j,Q.aabb);null!=K&&(m=Math.min(K,m))}if(V.children)for(const W of V.children)k(W)};if(k(g),m===Number.MAX_VALUE)return;const L=new O(0,0);return Cw(x.tileID.canonical,L,h.node.anchor[0],h.node.anchor[1]),{intersectionZ:m,position:L,feature:h.feature}}Et(Ly,"Tiled3dModelBucket",{omit:["layers"]}),Et(ky,"Tiled3dModelFeature");const DT={circle:class extends So{constructor(a,i,o,c){super(a,{layout:su||(su=new Ki({"circle-sort-key":new _t(Se.layout_circle["circle-sort-key"]),"circle-elevation-reference":new it(Se.layout_circle["circle-elevation-reference"]),visibility:new it(Se.layout_circle.visibility)})),paint:ud||(ud=new Ki({"circle-radius":new _t(Se.paint_circle["circle-radius"]),"circle-color":new _t(Se.paint_circle["circle-color"]),"circle-blur":new _t(Se.paint_circle["circle-blur"]),"circle-opacity":new _t(Se.paint_circle["circle-opacity"]),"circle-translate":new it(Se.paint_circle["circle-translate"]),"circle-translate-anchor":new it(Se.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new it(Se.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new it(Se.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new _t(Se.paint_circle["circle-stroke-width"]),"circle-stroke-color":new _t(Se.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new _t(Se.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new it(Se.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c)}createBucket(a){return new Wn(a)}queryRadius(a){const i=a;return ho("circle-radius",this,i)+ho("circle-stroke-width",this,i)+fr(this.paint.get("circle-translate"))}queryIntersectsFeature(a,i,o,c,h,m,g,x){const w=cd(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),m.angle,a.pixelToTileUnitsFactor),T=this.paint.get("circle-radius").evaluate(i,o)+this.paint.get("circle-stroke-width").evaluate(i,o);return lb(a,c,m,g,x,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),w,T)}getProgramIds(){return["circle"]}getDefaultProgramParams(a,i,o){const c=ab(this);return{config:new qo(this,{zoom:i,lut:o}),defines:c,overrideFog:!1}}is3D(a){return!a&&!!this.layout&&"none"!==this.layout.get("circle-elevation-reference")}hasElevation(){return this.layout&&"none"!==this.layout.get("circle-elevation-reference")}},heatmap:class extends So{createBucket(a){return new cb(a)}constructor(a,i,o,c){super(a,{layout:ub||(ub=new Ki({visibility:new it(Se.layout_heatmap.visibility)})),paint:Vv||(Vv=new Ki({"heatmap-radius":new _t(Se.paint_heatmap["heatmap-radius"]),"heatmap-weight":new _t(Se.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new it(Se.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Yc(Se.paint_heatmap["heatmap-color"]),"heatmap-opacity":new it(Se.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(a){"heatmap-color"===a&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Vm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(a){return ho("heatmap-radius",this,a)}queryIntersectsFeature(a,i,o,c,h,m,g,x){const w=this.paint.get("heatmap-radius").evaluate(i,o);return lb(a,c,m,g,x,!0,!0,new Je(0,0),w)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(a,i,o){return"heatmap"===a?{config:new qo(this,{zoom:i,lut:o}),overrideFog:!1}:{}}},hillshade:class extends So{constructor(a,i,o,c){super(a,{layout:jv||(jv=new Ki({visibility:new it(Se.layout_hillshade.visibility)})),paint:Uv||(Uv=new Ki({"hillshade-illumination-direction":new it(Se.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new it(Se.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new it(Se.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new it(Se.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new it(Se.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new it(Se.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new it(Se.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(a,i,o){return{overrideFog:!1}}},fill:class extends So{constructor(a,i,o,c){super(a,{layout:Wm||(Wm=new Ki({"fill-sort-key":new _t(Se.layout_fill["fill-sort-key"]),visibility:new it(Se.layout_fill.visibility),"fill-elevation-reference":new it(Se.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new _t(Se.layout_fill["fill-construct-bridge-guard-rail"])})),paint:N_||(N_=new Ki({"fill-antialias":new it(Se.paint_fill["fill-antialias"]),"fill-opacity":new _t(Se.paint_fill["fill-opacity"]),"fill-color":new _t(Se.paint_fill["fill-color"]),"fill-outline-color":new _t(Se.paint_fill["fill-outline-color"]),"fill-translate":new it(Se.paint_fill["fill-translate"]),"fill-translate-anchor":new it(Se.paint_fill["fill-translate-anchor"]),"fill-pattern":new _t(Se.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new it(Se.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new it(Se.paint_fill["fill-emissive-strength"]),"fill-z-offset":new _t(Se.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new _t(Se.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new _t(Se.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c)}getProgramIds(){const a=this.paint.get("fill-pattern"),i=a&&a.constantOr(1),o=[i?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&o.push(i&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),o}getDefaultProgramParams(a,i,o){return{config:new qo(this,{zoom:i,lut:o}),overrideFog:!1}}recalculate(a,i){super.recalculate(a,i);const o=this.paint._values["fill-outline-color"];"constant"===o.value.kind&&void 0===o.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(a){return new hd(a)}queryRadius(){return fr(this.paint.get("fill-translate"))}queryIntersectsFeature(a,i,o,c,h,m){return!a.queryGeometry.isAboveHorizon&&hr(oa(a.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),m.angle,a.pixelToTileUnitsFactor),c)}isTileClipped(){return 0===this.paint.get("fill-z-offset").constantOr(1)}is3D(a){if(0!==this.paint.get("fill-z-offset").constantOr(1))return!0;const i=this.layout&&"none"!==this.layout.get("fill-elevation-reference");return null!=a?i&&!a:i}hasElevation(){return this.layout&&"none"!==this.layout.get("fill-elevation-reference")}hasShadowPass(){return this.layout&&"none"!==this.layout.get("fill-elevation-reference")}},"fill-extrusion":class extends So{constructor(a,i,o,c){super(a,{layout:LE||(LE=new Ki({visibility:new it(Se["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new it(Se["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:Jf||(Jf=new Ki({"fill-extrusion-opacity":new it(Se["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new _t(Se["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new it(Se["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new it(Se["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new _t(Se["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new it(Se["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new _t(Se["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new _t(Se["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new it(Se["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new it(Se["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new it(Se["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new it(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new it(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new it(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new it(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new it(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new it(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new it(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new _t(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new _t(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new it(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new it(Se["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new it(Se["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new it(Se["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new _t(Se["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new _t(Se["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new it(Se["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(a){return new du(a)}queryRadius(){return fr(this.paint.get("fill-extrusion-translate"))}is3D(a){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(a,i,o,c,h,m,g,x,w){const T=cd(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),m.angle,a.pixelToTileUnitsFactor),I=this.paint.get("fill-extrusion-height").evaluate(i,o),A=this.paint.get("fill-extrusion-base").evaluate(i,o),M=[0,0],k=x&&m.elevation,L=m.elevation?m.elevation.exaggeration():1,V=a.tile.getBucket(this);if(k&&V instanceof du){const te=V.centroidVertexArray,me=w+1;me<te.length&&(M[0]=te.geta_centroid_pos0(me),M[1]=te.geta_centroid_pos1(me))}if(0===M[0]&&1===M[1])return!1;"globe"===m.projection.name&&(c=Ib([c],[new Je(0,0),new Je(ht,ht)],a.tileID.canonical).map(te=>te.polygon).flat());const j=k?x:null,[W,Q]=(me=c,he=A,fe=I,xe=T,Ee=g,Ve=j,Ce=M,Ue=L,ot=m.center.lat,"globe"===(te=m).projection.name?function(Ke,nt,ze,Qe,Ae,Be,at,et,Ft,St,Xe){const tt=[],It=[],yt=Ke.projection.upVectorScale(Xe,Ke.center.lat,Ke.worldSize).metersToTile,ft=[0,0,0,1],xt=[0,0,0,1],zt=(rn,Kt,vn,dn)=>{rn[0]=Kt,rn[1]=vn,rn[2]=dn,rn[3]=1},qt=Cb();ze>0&&(ze+=qt),Qe+=qt;for(const rn of nt){const Kt=[],vn=[];for(const dn of rn){const ii=dn.x+Ae.x,ie=dn.y+Ae.y,re=Ke.projection.projectTilePoint(ii,ie,Xe),Le=Ke.projection.upVector(Xe,dn.x,dn.y);let lt=ze,ut=Qe;if(at){const pt=zE(ii,ie,ze,Qe,at,et,Ft,St);lt+=pt.base,ut+=pt.top}0!==ze?zt(ft,re.x+Le[0]*yt*lt,re.y+Le[1]*yt*lt,re.z+Le[2]*yt*lt):zt(ft,re.x,re.y,re.z),zt(xt,re.x+Le[0]*yt*ut,re.y+Le[1]*yt*ut,re.z+Le[2]*yt*ut),lr(ft,ft,Be),lr(xt,xt,Be),Kt.push(new pc(ft[0],ft[1],ft[2])),vn.push(new pc(xt[0],xt[1],xt[2]))}tt.push(Kt),It.push(vn)}return[tt,It]}(te,me,he,fe,xe,Ee,Ve,Ce,Ue,ot,a.tileID.canonical):Ve?function(Ke,nt,ze,Qe,Ae,Be,at,et,Ft){const St=[],Xe=[],tt=[0,0,0,1];for(const It of Ke){const yt=[],ft=[];for(const xt of It){const zt=xt.x+Qe.x,qt=xt.y+Qe.y,rn=zE(zt,qt,nt,ze,Be,at,et,Ft);tt[0]=zt,tt[1]=qt,tt[2]=rn.base,tt[3]=1,xs(tt,tt,Ae),tt[3]=Math.max(tt[3],1e-5);const Kt=new pc(tt[0]/tt[3],tt[1]/tt[3],tt[2]/tt[3]);tt[0]=zt,tt[1]=qt,tt[2]=rn.top,tt[3]=1,xs(tt,tt,Ae),tt[3]=Math.max(tt[3],1e-5);const vn=new pc(tt[0]/tt[3],tt[1]/tt[3],tt[2]/tt[3]);yt.push(Kt),ft.push(vn)}St.push(yt),Xe.push(ft)}return[St,Xe]}(me,he,fe,xe,Ee,Ve,Ce,Ue,ot):function(Ke,nt,ze,Qe,Ae){const Be=[],at=[],et=Ae[8]*nt,Ft=Ae[9]*nt,St=Ae[10]*nt,Xe=Ae[11]*nt,tt=Ae[8]*ze,It=Ae[9]*ze,yt=Ae[10]*ze,ft=Ae[11]*ze;for(const xt of Ke){const zt=[],qt=[];for(const rn of xt){const Kt=rn.x+Qe.x,vn=rn.y+Qe.y,dn=Ae[0]*Kt+Ae[4]*vn+Ae[12],ii=Ae[1]*Kt+Ae[5]*vn+Ae[13],ie=Ae[2]*Kt+Ae[6]*vn+Ae[14],re=Ae[3]*Kt+Ae[7]*vn+Ae[15],Le=dn+et,lt=ii+Ft,ut=ie+St,pt=Math.max(re+Xe,1e-5),Ct=dn+tt,Ht=ii+It,wn=ie+yt,Gt=Math.max(re+ft,1e-5);zt.push(new pc(Le/pt,lt/pt,ut/pt)),qt.push(new pc(Ct/Gt,Ht/Gt,wn/Gt))}Be.push(zt),at.push(qt)}return[Be,at]}(me,he,fe,xe,Ee)),K=a.queryGeometry;var te,me,he,fe,xe,Ee,Ve,Ce,Ue,ot;return function(te,me,he){let fe=1/0;hr(he,me)&&(fe=Jm(he,me[0]));for(let xe=0;xe<me.length;xe++){const Ee=me[xe],Ve=te[xe];for(let Ce=0;Ce<Ee.length-1;Ce++){const Ue=Ee[Ce],ot=[Ue,Ee[Ce+1],Ve[Ce+1],Ve[Ce],Ue];di(he,ot)&&(fe=Math.min(fe,Jm(he,ot)))}}return fe!==1/0&&fe}(W,Q,K.isPointQuery()?K.screenBounds:K.screenGeometry)}},building:class extends So{constructor(a,i,o,c){super(a,{layout:Vb||(Vb=new Ki({visibility:new it(Se.layout_building.visibility),"building-facade":new _t(Se.layout_building["building-facade"]),"building-facade-floors":new _t(Se.layout_building["building-facade-floors"]),"building-facade-window":new _t(Se.layout_building["building-facade-window"]),"building-roof-shape":new _t(Se.layout_building["building-roof-shape"]),"building-height":new _t(Se.layout_building["building-height"]),"building-base":new _t(Se.layout_building["building-base"])})),paint:w0||(w0=new Ki({"building-opacity":new it(Se.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new it(Se.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new it(Se.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new it(Se.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new it(Se.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new it(Se.paint_building["building-vertical-scale"]),"building-cast-shadows":new it(Se.paint_building["building-cast-shadows"]),"building-color":new _t(Se.paint_building["building-color"]),"building-emissive-strength":new _t(Se.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new it(Se.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new it(Se.paint_building["building-cutoff-fade-range"]),"building-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(a){return new b0(a)}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(a){return!0}},line:class extends So{constructor(a,i,o,c){const h=Xb();super(a,h,i,o,c),h.layout&&(this.layout=new Do(h.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(a){if("line-gradient"===a){const i=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=i._styleExpression&&i._styleExpression.expression instanceof rl,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(a,i){super.recalculate(a,i),this.paint._values["line-floorwidth"]=(()=>{if(sg)return sg;const o=Xb();return sg=new D0(o.paint.properties["line-width"].specification),sg.useIntegerZoom=!0,sg})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,a)}createBucket(a){return new wl(a)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(a,i,o){const c=Zb(this);return{config:new qo(this,{zoom:i,lut:o}),defines:c,overrideFog:!1}}queryRadius(a){const i=a,o=Yb(ho("line-width",this,i),ho("line-gap-width",this,i)),c=ho("line-offset",this,i);return o/2+Math.abs(c)+fr(this.paint.get("line-translate"))}queryIntersectsFeature(a,i,o,c,h,m){if(a.queryGeometry.isAboveHorizon)return!1;const g=oa(a.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),m.angle,a.pixelToTileUnitsFactor),x=a.pixelToTileUnitsFactor/2*Yb(this.paint.get("line-width").evaluate(i,o),this.paint.get("line-gap-width").evaluate(i,o)),w=this.paint.get("line-offset").evaluate(i,o);return w&&(c=function(T,I){const A=[],M=new Je(0,0);for(let k=0;k<T.length;k++){const L=T[k],V=[];for(let j=0;j<L.length;j++){const W=L[j],Q=L[j+1],K=0===j?M:W.sub(L[j-1])._unit()._perp(),te=j===L.length-1?M:Q.sub(W)._unit()._perp(),me=K._add(te)._unit();me._mult(1/(me.x*te.x+me.y*te.y)),V.push(me._mult(I)._add(W))}A.push(V)}return A}(c,w*a.pixelToTileUnitsFactor)),function(T,I,A){for(let M=0;M<I.length;M++){const k=I[M];if(T.length>=3)for(let L=0;L<k.length;L++)if(Co(T,k[L]))return!0;if(or(T,k,A))return!0}return!1}(g,c,x)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(a){return!this.hasElevatedBuckets||this.layout&&"hd-road-markup"===this.layout.get("line-elevation-reference")}hasElevation(){return this.layout&&"none"!==this.layout.get("line-elevation-reference")}},symbol:Z0,background:class extends So{constructor(a,i,o,c){super(a,{layout:X0||(X0=new Ki({visibility:new it(Se.layout_background.visibility)})),paint:Sw||(Sw=new Ki({"background-pitch-alignment":new it(Se.paint_background["background-pitch-alignment"]),"background-color":new it(Se.paint_background["background-color"]),"background-pattern":new it(Se.paint_background["background-pattern"]),"background-opacity":new it(Se.paint_background["background-opacity"]),"background-emissive-strength":new it(Se.paint_background["background-emissive-strength"]),"background-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(a,i,o){return{overrideFog:!1}}is3D(a){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:gs,"raster-particle":Yh,sky:class extends So{constructor(a,i,o,c){super(a,{layout:Ea||(Ea=new Ki({visibility:new it(Se.layout_sky.visibility)})),paint:ja||(ja=new Ki({"sky-type":new it(Se.paint_sky["sky-type"]),"sky-atmosphere-sun":new it(Se.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new it(Se.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new it(Se.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new it(Se.paint_sky["sky-gradient-radius"]),"sky-gradient":new Yc(Se.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new it(Se.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new it(Se.paint_sky["sky-atmosphere-color"]),"sky-opacity":new it(Se.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(a){"sky-gradient"===a?this._updateColorRamp():"sky-atmosphere-sun"!==a&&"sky-atmosphere-halo-color"!==a&&"sky-atmosphere-color"!==a&&"sky-atmosphere-sun-intensity"!==a||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Vm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(a){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const i=a.style.light.properties.get("position");return this._lightPosition.azimuthal!==i.azimuthal||this._lightPosition.polar!==i.polar}return!1}getCenter(a,i){if("atmosphere"===this.paint.get("sky-type")){const c=this.paint.get("sky-atmosphere-sun"),h=!c,m=a.style.light,g=m.properties.get("position");return h&&"viewport"===m.properties.get("anchor")&&yn("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),h?Dd(g.azimuthal,90-g.polar,i):Dd(c[0],90-c[1],i)}const o=this.paint.get("sky-gradient-center");return Dd(o[0],90-o[1],i)}isSky(){return!0}markSkyboxValid(a){this._skyboxInvalidated=!1,this._lightPosition=a.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const a=this.paint.get("sky-type");return"atmosphere"===a?["skyboxCapture","skybox"]:"gradient"===a?["skyboxGradient"]:null}},slot:class extends So{constructor(a,i,o,c){super(a,{paint:Xh||(Xh=new Ki({}))},i,null)}},model:class extends So{constructor(a,i,o,c){super(a,{layout:K0||(K0=new Ki({visibility:new it(Se.layout_model.visibility),"model-id":new _t(Se.layout_model["model-id"])})),paint:Q0||(Q0=new Ki({"model-opacity":new _t(Se.paint_model["model-opacity"]),"model-rotation":new _t(Se.paint_model["model-rotation"]),"model-scale":new _t(Se.paint_model["model-scale"]),"model-translation":new _t(Se.paint_model["model-translation"]),"model-color":new _t(Se.paint_model["model-color"]),"model-color-mix-intensity":new _t(Se.paint_model["model-color-mix-intensity"]),"model-type":new it(Se.paint_model["model-type"]),"model-cast-shadows":new it(Se.paint_model["model-cast-shadows"]),"model-receive-shadows":new it(Se.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new it(Se.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new _t(Se.paint_model["model-emissive-strength"]),"model-roughness":new _t(Se.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new _t(Se.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new it(Se.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new it(Se.paint_model["model-front-cutoff"]),"model-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,c),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(a){return new Oy(a)}getProgramIds(){return["model"]}is3D(a){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(a){return a instanceof Ly?ht-1:0}queryIntersectsFeature(a,i,o,c,h,m){if(!this.modelManager)return!1;const g=this.modelManager,x=a.tile.getBucket(this);if(!(x&&x instanceof Oy))return!1;for(const w in x.instancesPerModel){const T=x.instancesPerModel[w],I=void 0!==i.id?i.id:i.properties&&i.properties.hasOwnProperty("id")?i.properties.id:void 0;if(T.idToFeaturesIndex.hasOwnProperty(I)){const A=T.features[T.idToFeaturesIndex[I]],M=g.getModel(w,this.scope);if(!M)return!1;let k=Nl();const L=new O(0,0),V=x.canonical;let j=Number.MAX_VALUE;for(let W=0;W<A.instancedDataCount;++W){const Q=16*(A.instancedDataOffset+W),K=T.instancedDataArray.float32,te=[K[Q+4],K[Q+5],K[Q+6]];Cw(V,L,K[Q],0|K[Q+1]),Lb(k,M,m,L,A.rotation,A.scale,te,!1,!1,!1),"globe"===m.projection.name&&(k=Fb(k,m));const me=Ui([],m.projMatrix,k),he=a.queryGeometry,fe=kb(he.isPointQuery()?he.screenBounds:he.screenGeometry,m,me,M.aabb);null!=fe&&(j=Math.min(fe,j))}return j!==Number.MAX_VALUE&&j}}return!1}_handleOverridablePaintPropertyUpdate(a,i,o){return!(!this.layout||i.isDataDriven()||o.isDataDriven()||"model-color"!==a&&"model-color-mix-intensity"!==a&&"model-rotation"!==a&&"model-scale"!==a&&"model-translation"!==a&&"model-emissive-strength"!==a)}_isPropertyZoomDependent(a){const i=this._transitionablePaint._values[a];return null!=i&&null!=i.value&&null!=i.value.expression&&i.value.expression instanceof Zc}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends So{constructor(a,i,o,c){super(a,{layout:Xv||(Xv=new Ki({"clip-layer-types":new it(Se.layout_clip["clip-layer-types"]),"clip-layer-scope":new it(Se.layout_clip["clip-layer-scope"])})),paint:Yv||(Yv=new Ki({}))},i,o,c)}recalculate(a,i){super.recalculate(a,i)}createBucket(a){return new vb(a)}is3D(a){return!0}}},Iw=new Kn(0,0,0),nx={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},ix={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},zy={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},rx={PAINT_ORDER_FILL_AND_STROKE:1},yu={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},By={MASK_TYPE_LUMINANCE:1};function Vy(a,i,o){var c,h;1===a&&i.icons.push((c=o,h=o.readVarint()+o.pos,function(m){if(m.usvg_tree.height||(m.usvg_tree.height=m.usvg_tree.width),!m.metadata)return m;const{metadata:g}=m;if(g.content_area){const{content_area:x}=g;null==x.top&&(x.top=x.left),null==x.width&&(x.width=m.usvg_tree.width),null==x.height&&(x.height=x.width)}return g.stretch_x&&g.stretch_x.length&&ox(g,"x"),g.stretch_y&&g.stretch_y.length&&ox(g,"y"),m}(c.readFields(Dg,{name:void 0},h))))}function ox(a,i){const o=[],c=a[`stretch_${i}`];let h=null;for(let m=0;m<c.length;m++)null===h?h=0===o.length?c[0]:o[o.length-1][1]+c[m]:(o.push([h,h+c[m]]),h=null);a[`stretch_${i}_areas`]=o}function Dg(a,i,o){var c,h;1===a?i.name=o.readString():2===a?i.metadata=(c=o,h=o.readVarint()+o.pos,c.readFields(Aw,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},h)):3===a&&(i.usvg_tree=function(c,h){return c.readFields(CT,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},h)}(o,o.readVarint()+o.pos),i.data="usvg_tree")}function Aw(a,i,o){var c,h;1===a?i.stretch_x=o.readPackedVarint():2===a?i.stretch_y=o.readPackedVarint():3===a?i.content_area=(c=o,h=o.readVarint()+o.pos,c.readFields(ST,{left:0},h)):4===a&&i.variables.push(function(c,h){return c.readFields(Sg,{name:void 0},h)}(o,o.readVarint()+o.pos))}function ST(a,i,o){1===a?i.left=o.readVarint():2===a?i.width=o.readVarint():3===a?i.top=o.readVarint():4===a&&(i.height=o.readVarint())}function Sg(a,i,o){1===a?i.name=o.readString():2===a&&(i.rgb_color=Gy(o.readVarint()),i.value="rgb_color")}function CT(a,i,o){var c,h;1===a?i.width=i.height=o.readVarint():2===a?i.height=o.readVarint():3===a?i.children.push(jy(o,o.readVarint()+o.pos)):4===a?i.linear_gradients.push((c=o,h=o.readVarint()+o.pos,c.readFields(sx,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},h))):5===a?i.radial_gradients.push(function(c,h){return c.readFields(PT,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},h)}(o,o.readVarint()+o.pos)):7===a?i.clip_paths.push(function(c,h){return c.readFields(RT,{children:[]},h)}(o,o.readVarint()+o.pos)):8===a&&i.masks.push(function(c,h){const m=c.readFields(ax,{left:0,width:20,mask_type:By.MASK_TYPE_LUMINANCE,children:[]},h);return null==m.height&&(m.height=m.width),null==m.top&&(m.top=m.left),m}(o,o.readVarint()+o.pos))}function jy(a,i){return a.readFields(IT,{},i)}function IT(a,i,o){var c,h;1===a?(i.group=(c=o,h=o.readVarint()+o.pos,c.readFields(AT,{opacity:255,children:[]},h)),i.node="group"):2===a&&(i.path=function(c,h){return c.readFields(Hy,{paint_order:1,commands:[],step:1,diffs:[],rule:nx.PATH_RULE_NON_ZERO},h)}(o,o.readVarint()+o.pos),i.node="path")}function AT(a,i,o){1===a?i.transform=Dp(o,o.readVarint()+o.pos):2===a?i.opacity=o.readVarint():5===a?i.clip_path_idx=o.readVarint():6===a?i.mask_idx=o.readVarint():7===a&&i.children.push(jy(o,o.readVarint()+o.pos))}function Dp(a,i){return a.readFields(Uy,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},i)}function Uy(a,i,o){1===a?i.sx=o.readFloat():2===a?i.ky=o.readFloat():3===a?i.kx=o.readFloat():4===a?i.sy=o.readFloat():5===a?i.tx=o.readFloat():6===a&&(i.ty=o.readFloat())}function Hy(a,i,o){var c,h;1===a?i.fill=(c=o,h=o.readVarint()+o.pos,c.readFields(NC,{rgb_color:Iw,paint:"rgb_color",opacity:255},h)):2===a?i.stroke=function(c,h){return c.readFields(MT,{rgb_color:Iw,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},h)}(o,o.readVarint()+o.pos):3===a?i.paint_order=o.readVarint():5===a?o.readPackedVarint(i.commands):6===a?i.step=o.readFloat():7===a?o.readPackedSVarint(i.diffs):8===a&&(i.rule=o.readVarint())}function NC(a,i,o){1===a?(i.rgb_color=Gy(o.readVarint()),i.paint="rgb_color"):2===a?(i.linear_gradient_idx=o.readVarint(),i.paint="linear_gradient_idx"):3===a?(i.radial_gradient_idx=o.readVarint(),i.paint="radial_gradient_idx"):5===a&&(i.opacity=o.readVarint())}function Gy(a){return new Kn((a>>16&255)/255,(a>>8&255)/255,(255&a)/255,1)}function MT(a,i,o){1===a?(i.rgb_color=Gy(o.readVarint()),i.paint="rgb_color"):2===a?(i.linear_gradient_idx=o.readVarint(),i.paint="linear_gradient_idx"):3===a?(i.radial_gradient_idx=o.readVarint(),i.paint="radial_gradient_idx"):5===a?o.readPackedFloat(i.dasharray):6===a?i.dashoffset=o.readFloat():7===a?i.miterlimit=o.readFloat():8===a?i.opacity=o.readVarint():9===a?i.width=o.readFloat():10===a?i.linecap=o.readVarint():11===a&&(i.linejoin=o.readVarint())}function sx(a,i,o){1===a?i.transform=Dp(o,o.readVarint()+o.pos):2===a?i.spread_method=o.readVarint():3===a?i.stops.push(Mw(o,o.readVarint()+o.pos)):4===a?i.x1=o.readFloat():5===a?i.y1=o.readFloat():6===a?i.x2=o.readFloat():7===a&&(i.y2=o.readFloat())}function Mw(a,i){return a.readFields(Pw,{offset:0,opacity:255,rgb_color:Iw},i)}function Pw(a,i,o){1===a?i.offset=o.readFloat():2===a?i.opacity=o.readVarint():3===a&&(i.rgb_color=Gy(o.readVarint()))}function PT(a,i,o){1===a?i.transform=Dp(o,o.readVarint()+o.pos):2===a?i.spread_method=o.readVarint():3===a?i.stops.push(Mw(o,o.readVarint()+o.pos)):4===a?i.cx=o.readFloat():5===a?i.cy=o.readFloat():6===a?i.r=o.readFloat():7===a?i.fx=o.readFloat():8===a?i.fy=o.readFloat():9===a&&(i.fr=o.readFloat())}function RT(a,i,o){1===a?i.transform=Dp(o,o.readVarint()+o.pos):2===a?i.clip_path_idx=o.readVarint():3===a&&i.children.push(jy(o,o.readVarint()+o.pos))}function ax(a,i,o){1===a?i.left=i.top=o.readFloat():2===a?i.width=i.height=o.readFloat():3===a?i.top=o.readFloat():4===a?i.height=o.readFloat():5===a?i.mask_type=o.readVarint():6===a?i.mask_idx=o.readVarint():7===a&&i.children.push(jy(o,o.readVarint()+o.pos))}class Rw{static calculate(i={},o=[]){const c=new Map,h=new Map;if(0===Object.keys(i).length)return c;o.forEach(m=>{h.set(m.name,m.rgb_color||new Kn(0,0,0))});for(const[m,g]of Object.entries(i))h.has(m)?c.set(h.get(m).toString(),g):console.warn(`Ignoring unknown image variable "${m}"`);return c}}function tf(a,i=255,o){const c=i/255,h=a.toString(),m=o.has(h)?o.get(h).clone():a.clone();return m.a*=c,m.toString()}function Cg(a,i){if(!Dc()){const o=document.createElement("canvas");return o.width=a,o.height=i,o}return new OffscreenCanvas(a,i)}function OT(a,i){const o=Rw.calculate(i.params,a.metadata?a.metadata.variables:[]),c=a.usvg_tree,h=c.width,m=c.height,g=i.transform?i.transform:new DOMMatrix,x=Math.max(1,Math.round(h*g.a)),w=Math.max(1,Math.round(m*g.d)),T=new DOMMatrix([x/h,0,0,w/m,0,0]),I=Cg(x,w).getContext("2d");return lx(I,T,c,c,o),I.getImageData(0,0,x,w)}function lx(a,i,o,c,h){for(const m of c.children)Ow(a,i,o,m,h)}function Ow(a,i,o,c,h){var m,x,w,T;c.group?(a.save(),function(m,g,x,w,T){const I=null!=w.mask_idx?x.masks[w.mask_idx]:null,A=null!=w.clip_path_idx?x.clip_paths[w.clip_path_idx]:null;if(w.transform&&(g=Sp(w.transform).preMultiplySelf(g)),255===w.opacity&&!(null!=A)&&!(null!=I))return void lx(m,g,x,w,T);const M=Cg(m.canvas.width,m.canvas.height),k=M.getContext("2d");lx(k,g,x,w,T),A&&cx(k,g,x,A),I&&kw(k,g,x,I,T),m.globalAlpha=w.opacity/255,m.drawImage(M,0,0)}(a,i,o,c.group,h),a.restore()):c.path&&(a.save(),x=o,w=c.path,T=h,(m=a).setTransform(i),w.paint_order===rx.PAINT_ORDER_FILL_AND_STROKE?($y(m,x,w,T),Fw(m,x,w,T)):(Fw(m,x,w,T),$y(m,x,w,T)),a.restore())}function $y(a,i,o,c){const h=o.fill;if(!h)return;const m=h.opacity/255;switch(a.save(),a.beginPath(),Lw(o,a),h.paint){case"rgb_color":a.fillStyle=tf(h.rgb_color,h.opacity,c);break;case"linear_gradient_idx":{const g=i.linear_gradients[h.linear_gradient_idx];g.transform&&a.setTransform(Sp(g.transform).preMultiplySelf(a.getTransform())),a.fillStyle=Ua(a,g,m,c);break}case"radial_gradient_idx":{const g=i.radial_gradients[h.radial_gradient_idx];g.transform&&a.setTransform(Sp(g.transform).preMultiplySelf(a.getTransform())),a.fillStyle=Sl(a,g,m,c)}}a.fill(qy(o)),a.restore()}function qy(a){return a.rule===nx.PATH_RULE_NON_ZERO?"nonzero":a.rule===nx.PATH_RULE_EVEN_ODD?"evenodd":void 0}function Fw(a,i,o,c){const h=o.stroke;if(!h)return;const m=Wy(o);a.lineWidth=h.width,a.miterLimit=h.miterlimit,a.setLineDash(h.dasharray),a.lineDashOffset=h.dashoffset;const g=h.opacity/255;switch(h.paint){case"rgb_color":a.strokeStyle=tf(h.rgb_color,h.opacity,c);break;case"linear_gradient_idx":a.strokeStyle=Ua(a,i.linear_gradients[h.linear_gradient_idx],g,c,!0);break;case"radial_gradient_idx":a.strokeStyle=Sl(a,i.radial_gradients[h.radial_gradient_idx],g,c,!0)}switch(h.linejoin){case zy.LINE_JOIN_MITER_CLIP:case zy.LINE_JOIN_MITER:a.lineJoin="miter";break;case zy.LINE_JOIN_ROUND:a.lineJoin="round";break;case zy.LINE_JOIN_BEVEL:a.lineJoin="bevel"}switch(h.linecap){case ix.LINE_CAP_BUTT:a.lineCap="butt";break;case ix.LINE_CAP_ROUND:a.lineCap="round";break;case ix.LINE_CAP_SQUARE:a.lineCap="square"}a.stroke(m)}function Ua(a,i,o,c,h=!1){if(1===i.stops.length){const M=i.stops[0];return tf(M.rgb_color,M.opacity*o,c)}const{x1:m,y1:g,x2:x,y2:w}=i;let T=new DOMPoint(m,g),I=new DOMPoint(x,w);if(h){const M=Sp(i.transform);T=M.transformPoint(T),I=M.transformPoint(I)}const A=a.createLinearGradient(T.x,T.y,I.x,I.y);for(const M of i.stops)A.addColorStop(M.offset,tf(M.rgb_color,M.opacity*o,c));return A}function Sl(a,i,o,c,h=!1){if(1===i.stops.length){const W=i.stops[0];return tf(W.rgb_color,W.opacity*o,c)}const m=Sp(i.transform),{fx:g,fy:x,fr:w,cx:T,cy:I,r:A}=i;let M=new DOMPoint(g,x),k=new DOMPoint(T,I),L=w,V=A;if(h){M=m.transformPoint(M),k=m.transformPoint(k);const W=(m.a+m.d)/2;L=w*W,V=i.r*W}const j=a.createRadialGradient(M.x,M.y,L,k.x,k.y,V);for(const W of i.stops)j.addColorStop(W.offset,tf(W.rgb_color,W.opacity*o,c));return j}function nf(a,i,o,c){const h=c.transform?Sp(c.transform).preMultiplySelf(i):i,m=Cg(a.canvas.width,a.canvas.height),g=m.getContext("2d");for(const w of c.children)if(w.group)nf(g,h,o,w.group);else if(w.path){const T=w.path,I=new Path2D;I.addPath(Wy(T),h),g.fill(I,qy(T))}const x=null!=c.clip_path_idx?o.clip_paths[c.clip_path_idx]:null;x&&cx(g,h,o,x),a.globalCompositeOperation="source-over",a.drawImage(m,0,0)}function cx(a,i,o,c){const h=Cg(a.canvas.width,a.canvas.height);nf(h.getContext("2d"),i,o,c),a.globalCompositeOperation="destination-in",a.drawImage(h,0,0)}function kw(a,i,o,c,h){if(0===c.children.length)return;const m=null!=c.mask_idx?o.masks[c.mask_idx]:null;m&&kw(a,i,o,m,h);const g=a.canvas.width,x=a.canvas.height,w=Cg(g,x),T=w.getContext("2d"),I=c.width,A=c.height,M=c.left,k=c.top,L=new Path2D,V=new Path2D;V.rect(M,k,I,A),L.addPath(V,i),T.clip(L);for(const Q of c.children)Ow(T,i,o,Q,h);const j=T.getImageData(0,0,g,x),W=j.data;if(c.mask_type===By.MASK_TYPE_LUMINANCE)for(let Q=0;Q<W.length;Q+=4)W[Q+3]=W[Q+3]/255*(.2126*W[Q]+.7152*W[Q+1]+.0722*W[Q+2]);T.putImageData(j,0,0),a.globalCompositeOperation="destination-in",a.drawImage(w,0,0)}function Sp(a){return a?new DOMMatrix([a.sx,a.ky,a.kx,a.sy,a.tx,a.ty]):new DOMMatrix}function Lw(a,i){const o=a.step;let c=a.diffs[0]*o,h=a.diffs[1]*o;i.moveTo(c,h);for(let m=0,g=2;m<a.commands.length;m++)switch(a.commands[m]){case yu.PATH_COMMAND_MOVE:c+=a.diffs[g++]*o,h+=a.diffs[g++]*o,i.moveTo(c,h);break;case yu.PATH_COMMAND_LINE:c+=a.diffs[g++]*o,h+=a.diffs[g++]*o,i.lineTo(c,h);break;case yu.PATH_COMMAND_QUAD:{const x=c+a.diffs[g++]*o,w=h+a.diffs[g++]*o;c=x+a.diffs[g++]*o,h=w+a.diffs[g++]*o,i.quadraticCurveTo(x,w,c,h);break}case yu.PATH_COMMAND_CUBIC:{const x=c+a.diffs[g++]*o,w=h+a.diffs[g++]*o,T=x+a.diffs[g++]*o,I=w+a.diffs[g++]*o;c=T+a.diffs[g++]*o,h=I+a.diffs[g++]*o,i.bezierCurveTo(x,w,T,I,c,h);break}case yu.PATH_COMMAND_CLOSE:i.closePath()}return i}function Wy(a){return Lw(a,new Path2D)}class Cp{constructor(i){this.capacity=i,this.cache=new Map}get(i){if(!this.cache.has(i))return;const o=this.cache.get(i);return this.cache.delete(i),this.cache.set(i,o),o}put(i,o){this.cache.has(i)?this.cache.delete(i):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(i,o)}delete(i){this.cache.delete(i)}}Et(Cp,"LRUCache");class Zy{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(i){return new $r(i,i.data)}getFromCache(i,o,c){return this.cacheMap.has(c)||this.cacheMap.set(c,new Cp(150)),this.cacheMap.get(c).get(ed(i.toString(),o))}setInCache(i,o,c,h){this.cacheDependenciesMap.has(h)||this.cacheDependenciesMap.set(h,new Map),this.cacheMap.has(h)||this.cacheMap.set(h,new Cp(150));const m=this.cacheDependenciesMap.get(h),g=ed(i.id.toString(),c);m.get(g)||m.set(g,new Set);const x=this.cacheMap.get(h),w=i.toString();m.get(g).add(w),x.put(ed(i.toString(),c),o)}removeImagesFromCacheByIds(i,o,c=0){if(!this.cacheMap.has(c)||!this.cacheDependenciesMap.has(c))return;const h=this.cacheMap.get(c),m=this.cacheDependenciesMap.get(c);for(const g of i){const x=ed(g.toString(),o);if(m.has(x)){for(const w of m.get(x))h.delete(w);m.delete(x)}}}rasterize(i,o,c,h,m=OT){const g=this.getFromCache(i,c,h);if(g)return g.clone();const x=m(o.icon,i.options),w=Zy._getImage(x);return this.setInCache(i,w,c,h),w.clone()}}class ux{constructor(i){this.size=i,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(i,o){const c=this.toIdx(i,o);return{min:this.minimums[c],max:this.maximums[c]}}isLeaf(i,o){return this.leaves[this.toIdx(i,o)]}toIdx(i,o){return o*this.size+i}}function Nw(a,i,o,c){let h=0,m=Number.MAX_VALUE;for(let g=0;g<3;g++)if(Math.abs(c[g])<1e-15){if(o[g]<a[g]||o[g]>i[g])return null}else{const x=1/c[g];let w=(a[g]-o[g])*x,T=(i[g]-o[g])*x;if(w>T){const I=w;w=T,T=I}if(w>h&&(h=w),T<m&&(m=T),h>m)return null}return h}function zw(a,i,o,c,h,m,g,x,w,T,I){const A=c-a,M=h-i,k=m-o,L=g-a,V=x-i,j=w-o,W=I[1]*j-I[2]*V,Q=I[2]*L-I[0]*j,K=I[0]*V-I[1]*L,te=A*W+M*Q+k*K;if(Math.abs(te)<1e-15)return null;const me=1/te,he=T[0]-a,fe=T[1]-i,xe=T[2]-o,Ee=(he*W+fe*Q+xe*K)*me;if(Ee<0||Ee>1)return null;const Ve=fe*k-xe*M,Ce=xe*A-he*k,Ue=he*M-fe*A,ot=(I[0]*Ve+I[1]*Ce+I[2]*Ue)*me;return ot<0||Ee+ot>1?null:(L*Ve+V*Ce+j*Ue)*me}function Bw(a,i,o){return(a-i)/(o-i)}function Ig(a,i,o,c,h,m,g,x,w){const T=1<<o,I=m-c,A=g-h,M=(a+1)/T*I+c,k=(i+0)/T*A+h,L=(i+1)/T*A+h;x[0]=(a+0)/T*I+c,x[1]=k,w[0]=M,w[1]=L}class dx{constructor(i){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=i,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const o=function(m){const g=Math.ceil(Math.log2(m.dim/8)),x=[];let w=Math.ceil(Math.pow(2,g));const T=1/w,I=(k,L,V,j,W)=>{const Q=j?1:0,K=(k+1)*V-Q,te=L*V,me=(L+1)*V-Q;W[0]=k*V,W[1]=te,W[2]=K,W[3]=me};let A=new ux(w);const M=[];for(let k=0;k<w*w;k++){I(k%w,Math.floor(k/w),T,!1,M);const L=vu(M[0],M[1],m),V=vu(M[2],M[1],m),j=vu(M[2],M[3],m),W=vu(M[0],M[3],m);A.minimums.push(Math.min(L,V,j,W)),A.maximums.push(Math.max(L,V,j,W)),A.leaves.push(1)}for(x.push(A),w/=2;w>=1;w/=2){const k=x[x.length-1];A=new ux(w);for(let L=0;L<w*w;L++){I(L%w,Math.floor(L/w),2,!0,M);const V=k.getElevation(M[0],M[1]),j=k.getElevation(M[2],M[1]),W=k.getElevation(M[2],M[3]),Q=k.getElevation(M[0],M[3]),K=k.isLeaf(M[0],M[1]),te=k.isLeaf(M[2],M[1]),me=k.isLeaf(M[2],M[3]),he=k.isLeaf(M[0],M[3]),fe=Math.min(V.min,j.min,W.min,Q.min),xe=Math.max(V.max,j.max,W.max,Q.max),Ee=K&&te&&me&&he;A.maximums.push(xe),A.minimums.push(fe),A.leaves.push(xe-fe<=5&&Ee?1:0)}x.push(A)}return x}(this.dem),c=o.length-1,h=o[c];this._addNode(h.minimums[0],h.maximums[0],h.leaves[0]),this._construct(o,0,0,c,0)}raycastRoot(i,o,c,h,m,g,x=1){return Nw([i,o,-100],[c,h,this.maximums[0]*x],m,g)}raycast(i,o,c,h,m,g,x=1){if(!this.nodeCount)return null;const w=this.raycastRoot(i,o,c,h,m,g,x);if(null==w)return null;const T=[],I=[],A=[],M=[],k=[{idx:0,t:w,nodex:0,nodey:0,depth:0}];for(;k.length>0;){const{idx:L,t:V,nodex:j,nodey:W,depth:Q}=k.pop();if(this.leaves[L]){Ig(j,W,Q,i,o,c,h,A,M);const te=1<<Q,me=(j+0)/te,he=(j+1)/te,fe=(W+0)/te,xe=(W+1)/te,Ee=vu(me,fe,this.dem)*x,Ve=vu(he,fe,this.dem)*x,Ce=vu(he,xe,this.dem)*x,Ue=vu(me,xe,this.dem)*x,ot=zw(A[0],A[1],Ee,M[0],A[1],Ve,M[0],M[1],Ce,m,g),$e=zw(M[0],M[1],Ce,A[0],M[1],Ue,A[0],A[1],Ee,m,g),Ke=Math.min(null!==ot?ot:Number.MAX_VALUE,null!==$e?$e:Number.MAX_VALUE);if(Ke!==Number.MAX_VALUE)return Ke;{const nt=Uo([],m,g,V);if(Rs(Ee,Ve,Ue,Ce,Bw(nt[0],A[0],M[0]),Bw(nt[1],A[1],M[1]))>=nt[2])return V}continue}let K=0;for(let te=0;te<this._siblingOffset.length;te++){Ig((j<<1)+this._siblingOffset[te][0],(W<<1)+this._siblingOffset[te][1],Q+1,i,o,c,h,A,M),A[2]=-100,M[2]=this.maximums[this.childOffsets[L]+te]*x;const me=Nw(A,M,m,g);if(null!=me){const he=me;T[te]=he;let fe=!1;for(let xe=0;xe<K&&!fe;xe++)he>=T[I[xe]]&&(I.splice(xe,0,te),fe=!0);fe||(I[K]=te),K++}}for(let te=0;te<K;te++){const me=I[te];k.push({idx:this.childOffsets[L]+me,t:T[me],nodex:(j<<1)+this._siblingOffset[me][0],nodey:(W<<1)+this._siblingOffset[me][1],depth:Q+1})}}return null}_addNode(i,o,c){return this.minimums.push(i),this.maximums.push(o),this.leaves.push(c),this.childOffsets.push(0),this.nodeCount++}_construct(i,o,c,h,m){if(1===i[h].isLeaf(o,c))return;this.childOffsets[m]||(this.childOffsets[m]=this.nodeCount);const g=h-1,x=i[g];let w=0,T=0;for(let I=0;I<this._siblingOffset.length;I++){const A=2*o+this._siblingOffset[I][0],M=2*c+this._siblingOffset[I][1],k=x.getElevation(A,M),L=x.isLeaf(A,M),V=this._addNode(k.min,k.max,L);L&&(w|=1<<I),T||(T=V)}for(let I=0;I<this._siblingOffset.length;I++)w&1<<I||this._construct(i,2*o+this._siblingOffset[I][0],2*c+this._siblingOffset[I][1],g,T+I)}}function Rs(a,i,o,c,h,m){return Nt(Nt(a,o,m),Nt(i,c,m),h)}function vu(a,i,o){const c=o.dim,h=se(a*c-.5,0,c-1),m=se(i*c-.5,0,c-1),g=Math.floor(h),x=Math.floor(m),w=Math.min(g+1,c-1),T=Math.min(x+1,c-1);return Rs(o.get(g,x),o.get(w,x),o.get(g,T),o.get(w,T),h-g,m-x)}const FT={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Vw(a,i,o){return(256*a*256+256*i+o)/10-1e4}function jw(a,i,o){return 256*a+i+o/256-32768}class Ag{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(i,o,c,h=!1){if(this.uid=i,o.height!==o.width)throw new RangeError("DEM tiles must be square");if(c&&"mapbox"!==c&&"terrarium"!==c)return void yn(`"${c}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=o.height;const m=this.dim=o.height-2,g=new Uint32Array(o.data.buffer);if(this.pixels=new Uint8Array(o.data.buffer),this.floatView=new Float32Array(o.data.buffer),this.borderReady=h,this._modifiedForSources={},!h){for(let w=0;w<m;w++)g[this._idx(-1,w)]=g[this._idx(0,w)],g[this._idx(m,w)]=g[this._idx(m-1,w)],g[this._idx(w,-1)]=g[this._idx(w,0)],g[this._idx(w,m)]=g[this._idx(w,m-1)];g[this._idx(-1,-1)]=g[this._idx(0,0)],g[this._idx(m,-1)]=g[this._idx(m-1,0)],g[this._idx(-1,m)]=g[this._idx(0,m-1)],g[this._idx(m,m)]=g[this._idx(m-1,m-1)]}const x="terrarium"===c?jw:Vw;for(let w=0;w<g.length;++w){const T=4*w;this.floatView[w]=x(this.pixels[T],this.pixels[T+1],this.pixels[T+2])}this._timestamp=Zs.now()}_buildQuadTree(){this._tree=new dx(this)}get(i,o,c=!1){c&&(i=se(i,-1,this.dim),o=se(o,-1,this.dim));const h=this._idx(i,o);return this.floatView[h]}set(i,o,c){const h=this._idx(i,o),m=this.floatView[h];return this.floatView[h]=c,c-m}static getUnpackVector(i){return FT[i]}_idx(i,o){if(i<-1||i>=this.dim+1||o<-1||o>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(o+1)*this.stride+(i+1)}static pack(i,o){const c=[0,0,0,0],h=Ag.getUnpackVector(o);let m=Math.floor((i+h[3])/h[2]);return c[2]=m%256,m=Math.floor(m/256),c[1]=m%256,m=Math.floor(m/256),c[0]=m,c}getPixels(){return new db({width:this.stride,height:this.stride},this.pixels)}backfillBorder(i,o,c){if(this.dim!==i.dim)throw new Error("dem dimension mismatch");let h=o*this.dim,m=o*this.dim+this.dim,g=c*this.dim,x=c*this.dim+this.dim;switch(o){case-1:h=m-1;break;case 1:m=h+1}switch(c){case-1:g=x-1;break;case 1:x=g+1}const w=-o*this.dim,T=-c*this.dim;for(let I=g;I<x;I++)for(let A=h;A<m;A++){const M=4*this._idx(A,I),k=4*this._idx(A+w,I+T);this.pixels[M+0]=i.pixels[k+0],this.pixels[M+1]=i.pixels[k+1],this.pixels[M+2]=i.pixels[k+2],this.pixels[M+3]=i.pixels[k+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function kT(a,i,o){var c,h;1===a?i.headerLength=o.readFixed32():2===a?i.x=o.readVarint():3===a?i.y=o.readVarint():4===a?i.z=o.readVarint():5===a&&i.layers.push((c=o,h=o.readVarint()+o.pos,c.readFields(hx,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},h)))}function LT(a,i,o){var c,h;1===a?(i.delta_filter=(c=o,h=o.readVarint()+o.pos,c.readFields(NT,{blockSize:0},h)),i.filter="delta_filter"):2===a?(o.readVarint(),i.filter="zigzag_filter"):3===a?(o.readVarint(),i.filter="bitshuffle_filter"):4===a&&(o.readVarint(),i.filter="byteshuffle_filter")}function NT(a,i,o){1===a&&(i.blockSize=o.readVarint())}function zT(a,i,o){1===a?(o.readVarint(),i.codec="gzip_data"):2===a?(o.readVarint(),i.codec="jpeg_image"):3===a?(o.readVarint(),i.codec="webp_image"):4===a&&(o.readVarint(),i.codec="png_image")}function Uw(a,i,o){let c=0,h=0;var m,g;1===a?i.firstByte=o.readFixed64():2===a?i.lastByte=o.readFixed64():3===a?i.filters.push((m=o,g=o.readVarint()+o.pos,m.readFields(LT,{},g))):4===a?i.codec=function(m,g){return m.readFields(zT,{},g)}(o,o.readVarint()+o.pos):5===a?h=o.readFloat():6===a?c=o.readFloat():7===a?i.bands.push(o.readString()):8===a?i.offset=o.readDouble():9===a&&(i.scale=o.readDouble()),0===i.offset&&(i.offset=h),0===i.scale&&(i.scale=c)}function hx(a,i,o){var c,h;1===a?i.version=o.readVarint():2===a?i.name=o.readString():3===a?i.units=o.readString():4===a?i.tileSize=o.readVarint():5===a?i.buffer=o.readVarint():6===a?i.pixelFormat=o.readVarint():7===a&&i.dataIndex.push((c=o,h=o.readVarint()+o.pos,c.readFields(Uw,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},h)))}function Hw(a,i,o){if(2===a)c=o,h=o.readVarint()+o.pos,c.readFields(Gw,i,h);else if(3===a)throw new Error("Not implemented");var c,h}function Gw(a,i,o){if(1===a){let c=0;const h=o.readVarint()+o.pos;for(;o.pos<h;)i[c++]=o.readVarint()}}function $w(a,i){if(4!==i.length)throw new Error(`Expected data of dimension 4 but got ${i.length}.`);let o=i[3];for(let c=2;c>=1;c--){const h=1===c?1:0,m=2===c?1:0;for(let g=0;g<i[0];g++){const x=i[1]*g;for(let w=h;w<i[1];w++){const T=i[2]*(w+x);for(let I=m;I<i[2];I++){const A=i[3]*(I+T);for(let M=0;M<i[3];M++){const k=A+M;a[k]+=a[k-o]}}}}o*=i[c]}return a}function qw(a){for(let i=0,o=a.length;i<o;i++)a[i]=a[i]>>>1^-(1&a[i]);return a}function Ww(a,i){switch(i){case"uint32":return a;case"uint16":for(let o=0;o<a.length;o+=2){const c=a[o],h=a[o+1];a[o]=(240&c)>>4|(61440&c)>>8|(240&h)<<4|61440&h,a[o+1]=15&c|(3840&c)>>4|(15&h)<<8|(3840&h)<<4}return a;case"uint8":for(let o=0;o<a.length;o+=4){const c=a[o],h=a[o+1],m=a[o+2],g=a[o+3];a[o+0]=(192&c)>>6|(192&h)>>4|(192&m)>>2|192&g,a[o+1]=(48&c)>>4|(48&h)>>2|48&m|(48&g)<<2,a[o+2]=(12&c)>>2|12&h|(12&m)<<2|(12&g)<<4,a[o+3]=3&c|(3&h)<<2|(3&m)<<4|(3&g)<<6}return a;default:throw new Error(`Invalid pixel format, "${i}"`)}}Et(Ag,"DEMData"),Et(dx,"DemMinMaxQuadTree",{omit:["dem"]});var aa=Uint8Array,Ip=Uint16Array,Zw=Int32Array,Mg=new aa([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),xu=new aa([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),BT=new aa([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Xw=function(a,i){for(var o=new Ip(31),c=0;c<31;++c)o[c]=i+=1<<a[c-1];var h=new Zw(o[30]);for(c=1;c<30;++c)for(var m=o[c];m<o[c+1];++m)h[m]=m-o[c]<<5|c;return{b:o,r:h}},Xy=Xw(Mg,2),Id=Xy.b,fx=Xy.r;Id[28]=258,fx[258]=28;for(var VT=Xw(xu,0).b,Yy=new Ip(32768),jr=0;jr<32768;++jr){var Pg=(43690&jr)>>1|(21845&jr)<<1;Yy[jr]=((65280&(Pg=(61680&(Pg=(52428&Pg)>>2|(13107&Pg)<<2))>>4|(3855&Pg)<<4))>>8|(255&Pg)<<8)>>1}var Rg=function(a,i,o){for(var c=a.length,h=0,m=new Ip(i);h<c;++h)a[h]&&++m[a[h]-1];var g,x=new Ip(i);for(h=1;h<i;++h)x[h]=x[h-1]+m[h-1]<<1;g=new Ip(1<<i);var w=15-i;for(h=0;h<c;++h)if(a[h])for(var T=h<<4|a[h],I=i-a[h],A=x[a[h]-1]++<<I,M=A|(1<<I)-1;A<=M;++A)g[Yy[A]>>w]=T;return g},Og=new aa(288);for(jr=0;jr<144;++jr)Og[jr]=8;for(jr=144;jr<256;++jr)Og[jr]=9;for(jr=256;jr<280;++jr)Og[jr]=7;for(jr=280;jr<288;++jr)Og[jr]=8;var px=new aa(32);for(jr=0;jr<32;++jr)px[jr]=5;var jT=Rg(Og,9),No=Rg(px,5),Ky=function(a){for(var i=a[0],o=1;o<a.length;++o)a[o]>i&&(i=a[o]);return i},Cl=function(a,i,o){var c=i/8|0;return(a[c]|a[c+1]<<8)>>(7&i)&o},mx=function(a,i){var o=i/8|0;return(a[o]|a[o+1]<<8|a[o+2]<<16)>>(7&i)},Yw=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Il=function(a,i,o){var c=new Error(i||Yw[a]);if(c.code=a,Error.captureStackTrace&&Error.captureStackTrace(c,Il),!o)throw c;return c},Kw=new aa(0),Qw=typeof TextDecoder<"u"&&new TextDecoder;try{Qw.decode(Kw,{stream:!0})}catch{}const Ap={gzip_data:"gzip"};class Ha extends Error{constructor(i){super(i),this.name="MRTError"}}const UT={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},gx={uint32:1,uint16:2,uint8:4},HT={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Qy;class _x{constructor(i=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=i}getLayer(i){const o=this.layers[i];if(!o)throw new Ha(`Layer '${i}' not found`);return o}getHeaderLength(i){const o=new Uint8Array(i),c=new DataView(i);if(13!==o[0])throw new Ha("File is not a valid MRT.");return c.getUint32(1,!0)}parseHeader(i){const o=new Uint8Array(i),c=this.getHeaderLength(i);if(o.length<c)throw new Ha(`Expected header with length >= ${c} but got buffer of length ${o.length}`);const h=new Qy(o.subarray(0,c)).readFields(kT,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==h.x||this.y!==h.y||this.z!==h.z))throw new Ha(`Invalid attempt to parse header ${h.z}/${h.x}/${h.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=h.x,this.y=h.y,this.z=h.z;for(const m of h.layers)this.layers[m.name]=new yx(m,{cacheSize:this._cacheSize});return this}createDecodingTask(i){const o=[],c=this.getLayer(i.layerName);for(let h of i.blockIndices){const m=c.dataIndex[h],g=m.firstByte-i.firstByte,x=m.lastByte-i.firstByte;if(c._blocksInProgress.has(h))continue;const w={layerName:c.name,firstByte:g,lastByte:x,pixelFormat:c.pixelFormat,blockIndex:h,blockShape:[m.bands.length].concat(c.bandShape),buffer:c.buffer,codec:m.codec.codec,filters:m.filters.map(T=>T.filter)};c._blocksInProgress.add(h),o.push(w)}return new Mp(o,()=>{o.forEach(h=>c._blocksInProgress.delete(h.blockIndex))},(h,m)=>{if(o.forEach(g=>c._blocksInProgress.delete(g.blockIndex)),h)throw h;m.forEach(g=>{this.getLayer(g.layerName).processDecodedData(g)})})}}class yx{constructor({version:i,name:o,units:c,tileSize:h,pixelFormat:m,buffer:g,dataIndex:x},w){if(this.version=i,1!==this.version)throw new Ha(`Cannot parse raster layer encoded with MRT version ${i}`);this.name=o,this.units=c,this.tileSize=h,this.buffer=g,this.pixelFormat=UT[m],this.dataIndex=x,this.bandShape=[h+2*g,h+2*g,gx[this.pixelFormat]],this._decodedBlocks=new Cp(w?w.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return gx[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:i})=>i).flat()}processDecodedData(i){const o=i.blockIndex.toString();this._decodedBlocks.get(o)||this._decodedBlocks.put(o,i.data)}getBlockForBand(i){let o=0;switch(typeof i){case"string":for(const[c,h]of this.dataIndex.entries()){for(const[m,g]of h.bands.entries())if(g===i)return{bandIndex:o+m,blockIndex:c,blockBandIndex:m};o+=h.bands.length}break;case"number":for(const[c,h]of this.dataIndex.entries()){if(i>=o&&i<o+h.bands.length)return{bandIndex:i,blockIndex:c,blockBandIndex:i-o};o+=h.bands.length}break;default:throw new Ha(`Invalid band \`${JSON.stringify(i)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(i){let o=1/0,c=-1/0;const h=[],m=new Set;for(const g of i){const{blockIndex:x}=this.getBlockForBand(g);if(x<0)throw new Ha(`Invalid band: ${JSON.stringify(g)}`);const w=this.dataIndex[x];h.includes(x)||h.push(x),m.add(x),o=Math.min(o,w.firstByte),c=Math.max(c,w.lastByte)}if(m.size>this.cacheSize)throw new Ha(`Number of blocks to decode (${m.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:o,lastByte:c,blockIndices:h}}hasBand(i){const{blockIndex:o}=this.getBlockForBand(i);return o>=0}hasDataForBand(i){const{blockIndex:o}=this.getBlockForBand(i);return o>=0&&!!this._decodedBlocks.get(o.toString())}getBandView(i){const{blockIndex:o,blockBandIndex:c}=this.getBlockForBand(i);if(o<0)throw new Ha(`Band not found: ${JSON.stringify(i)}`);const h=this._decodedBlocks.get(o.toString());if(!h)throw new Ha(`Data for band ${JSON.stringify(i)} of layer "${this.name}" not decoded.`);const m=this.dataIndex[o],g=this.bandShape.reduce((T,I)=>T*I,1),x=c*g,w=h.subarray(x,x+g);return{data:w,bytes:new Uint8Array(w.buffer).subarray(w.byteOffset,w.byteOffset+w.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:m.offset,scale:m.scale}}}_x.setPbf=function(a){Qy=a};class Mp{constructor(i,o,c){this.tasks=i,this._onCancel=o,this._onComplete=c,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(i,o){this._finalized||(this._onComplete(i,o),this._finalized=!0)}}_x.performDecoding=function(a,i){const o=new Uint8Array(a);return Promise.all(i.tasks.map(c=>{const{layerName:h,firstByte:m,lastByte:g,pixelFormat:x,blockShape:w,blockIndex:T,filters:I,codec:A}=c,M=o.subarray(m,g+1),k=new Uint32Array(w[0]*w[1]*w[2]);let L;if("gzip_data"!==A)throw new Ha(`Unhandled codec: ${A}`);return L=function(V,j){if(!globalThis.DecompressionStream&&"gzip_data"===j)return Promise.resolve(((te=function(fe){31==fe[0]&&139==fe[1]&&8==fe[2]||Il(6,"invalid gzip data");var xe=fe[3],Ee=10;4&xe&&(Ee+=2+(fe[10]|fe[11]<<8));for(var Ve=(xe>>3&1)+(xe>>4&1);Ve>0;Ve-=!fe[Ee++]);return Ee+(2&xe)}(K=V))+8>K.length&&Il(6,"invalid gzip data"),function(fe,xe,Ee,Ve){var Ce=fe.length;if(!Ce||xe.f&&!xe.l)return Ee||new aa(0);var Ue=!Ee,ot=Ue||2!=xe.i,$e=xe.i;Ue&&(Ee=new aa(3*Ce));var Ke,nt,ze=function(Zn){var Oi=Ee.length;if(Zn>Oi){var fi=new aa(Math.max(2*Oi,Zn));fi.set(Ee),Ee=fi}},Qe=xe.f||0,Ae=xe.p||0,Be=xe.b||0,at=xe.l,et=xe.d,Ft=xe.m,St=xe.n,Xe=8*Ce;do{if(!at){Qe=Cl(fe,Ae,1);var tt=Cl(fe,Ae+1,3);if(Ae+=3,!tt){var It=fe[(ie=4+((Ae+7)/8|0))-4]|fe[ie-3]<<8,yt=ie+It;if(yt>Ce){$e&&Il(0);break}ot&&ze(Be+It),Ee.set(fe.subarray(ie,yt),Be),xe.b=Be+=It,xe.p=Ae=8*yt,xe.f=Qe;continue}if(1==tt)at=jT,et=No,Ft=9,St=5;else if(2==tt){var ft=Cl(fe,Ae,31)+257,xt=Cl(fe,Ae+10,15)+4,zt=ft+Cl(fe,Ae+5,31)+1;Ae+=14;for(var qt=new aa(zt),rn=new aa(19),Kt=0;Kt<xt;++Kt)rn[BT[Kt]]=Cl(fe,Ae+3*Kt,7);Ae+=3*xt;var vn=Ky(rn),dn=(1<<vn)-1,ii=Rg(rn,vn);for(Kt=0;Kt<zt;){var ie,re=ii[Cl(fe,Ae,dn)];if(Ae+=15&re,(ie=re>>4)<16)qt[Kt++]=ie;else{var Le=0,lt=0;for(16==ie?(lt=3+Cl(fe,Ae,3),Ae+=2,Le=qt[Kt-1]):17==ie?(lt=3+Cl(fe,Ae,7),Ae+=3):18==ie&&(lt=11+Cl(fe,Ae,127),Ae+=7);lt--;)qt[Kt++]=Le}}var ut=qt.subarray(0,ft),pt=qt.subarray(ft);Ft=Ky(ut),St=Ky(pt),at=Rg(ut,Ft),et=Rg(pt,St)}else Il(1);if(Ae>Xe){$e&&Il(0);break}}ot&&ze(Be+131072);for(var Ct=(1<<Ft)-1,Ht=(1<<St)-1,wn=Ae;;wn=Ae){var Gt=(Le=at[mx(fe,Ae)&Ct])>>4;if((Ae+=15&Le)>Xe){$e&&Il(0);break}if(Le||Il(2),Gt<256)Ee[Be++]=Gt;else{if(256==Gt){wn=Ae,at=null;break}var hn=Gt-254;Gt>264&&(hn=Cl(fe,Ae,(1<<(tn=Mg[Kt=Gt-257]))-1)+Id[Kt],Ae+=tn);var ai=et[mx(fe,Ae)&Ht],Xi=ai>>4;if(ai||Il(3),Ae+=15&ai,pt=VT[Xi],Xi>3){var tn=xu[Xi];pt+=mx(fe,Ae)&(1<<tn)-1,Ae+=tn}if(Ae>Xe){$e&&Il(0);break}ot&&ze(Be+131072);var Ri=Be+hn;if(Be<pt){var li=0-pt,jn=Math.min(pt,Ri);for(li+Be<0&&Il(3);Be<jn;++Be)Ee[Be]=(void 0)[li+Be]}for(;Be<Ri;++Be)Ee[Be]=Ee[Be-pt]}}xe.l=at,xe.p=wn,xe.b=Be,xe.f=Qe,at&&(Qe=1,xe.m=Ft,xe.d=et,xe.n=St)}while(!Qe);return Be!=Ee.length&&Ue?(Ke=Ee,(null==(nt=Be)||nt>Ke.length)&&(nt=Ke.length),new aa(Ke.subarray(0,nt))):Ee.subarray(0,Be)}(K.subarray(te,-8),{i:2},new aa(((W=K)[(Q=W.length)-4]|W[Q-3]<<8|W[Q-2]<<16|W[Q-1]<<24)>>>0))));var W,Q,K,te;const me=Ap[j];if(!me)throw new Error(`Unhandled codec: ${j}`);const he=new globalThis.DecompressionStream(me);return new Response(new Blob([V]).stream().pipeThrough(he)).arrayBuffer().then(fe=>new Uint8Array(fe))}(M,A).then(V=>(new Qy(V).readFields(Hw,k),new HT[x](k.buffer))),L.then(V=>{for(let j=I.length-1;j>=0;j--)switch(I[j]){case"delta_filter":$w(V,w);break;case"zigzag_filter":qw(V);break;case"bitshuffle_filter":Ww(V,x);break;default:throw new Ha(`Unhandled filter "${I[j]}"`)}return{layerName:h,blockIndex:T,data:V}}).catch(V=>{throw V})}))},Et(Mp,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Et(_x,"MapboxRasterTile"),Et(yx,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class Al{constructor(i){this._stringToNumber={},this._numberToString=[];for(let o=0;o<i.length;o++){const c=i[o];this._stringToNumber[c]=o,this._numberToString[o]=c}}encode(i){return this._stringToNumber[i]}decode(i){return this._numberToString[i]}}const GT=["id","tile","layer","source","sourceLayer","state"];class Pp{constructor(i,o,c,h,m){this.type="Feature",this._vectorTileFeature=i,this._z=o,this._x=c,this._y=h,this.properties=i.properties,this.id=m}clone(){const i=new Pp(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(i.state=Object.assign({},this.state)),this.layer&&(i.layer=Object.assign({},this.layer)),this.source&&(i.source=this.source),this.sourceLayer&&(i.sourceLayer=this.sourceLayer),i}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(i){this._geometry=i}toJSON(){const i={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const o of GT)void 0!==this[o]&&(i[o]=this[o]);return i}}class Ml{constructor(i,o){this.tileID=i,this.x=i.canonical.x,this.y=i.canonical.y,this.z=i.canonical.z,this.grid=new nc(ht,16,0),this.featureIndexArray=new od,this.promoteId=o,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(i,o,c,h,m,g=0,x=0){const w=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(c,h,m,g);const T=this.grid;for(let I=0;I<o.length;I++){const A=o[I],M=[1/0,1/0,-1/0,-1/0];for(let k=0;k<A.length;k++){const L=A[k];M[0]=Math.min(M[0],L.x),M[1]=Math.min(M[1],L.y),M[2]=Math.max(M[2],L.x),M[3]=Math.max(M[3],L.y)}0!==x&&(M[0]-=x,M[1]-=x,M[2]+=x,M[3]+=x),M[0]<ht&&M[1]<ht&&M[2]>=0&&M[3]>=0&&T.insert(w,M[0],M[1],M[2],M[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Mt(new xd(this.rawTileData)).layers,this.sourceLayerCoder=new Al(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const i in this.vtLayers)this.vtFeatures[i]=[]}return this.vtLayers}query(i,o){const{tilespaceGeometry:c,transform:h,tileTransform:m,pixelPosMatrix:g,availableImages:x,worldview:w}=o;this.loadVTLayers(),this.serializedLayersCache.clear();const T=c.bufferedTilespaceBounds,I=this.grid.query(T.min.x,T.min.y,T.max.x,T.max.y,(L,V,j,W)=>Qi(c.bufferedTilespaceGeometry,L,V,j,W));I.sort(Pl);let A=null;h.elevation&&I.length>0&&(A=ef.create(h.elevation,this.tileID));const M={};let k;for(let L=0;L<I.length;L++){const V=I[L];if(V===k)continue;k=V;const j=this.featureIndexArray.get(V);let W=null;this.is3DTile?this.loadMatchingModelFeature(M,j,i,c,h,w):this.loadMatchingFeature(M,j,i,x,w,(Q,K,te,me=0)=>(W||(W=_e(Q,this.tileID.canonical,m)),K.queryIntersectsFeature(c,Q,te,W,this.z,h,g,A,me)))}return M}loadMatchingFeature(i,o,c,h,m,g){const{featureIndex:x,bucketIndex:w,sourceLayerIndex:T,layoutVertexArrayOffset:I}=o,A=this.bucketLayerIDs[w],M=c.layers,k=Object.keys(M);if(k.length&&!cn(k,A))return;const L=c.sourceCache,V=this.sourceLayerCoder.decode(T),j=this.vtLayers[V].feature(x),W=this.getId(j,V);for(let Q=0;Q<A.length;Q++){const K=A[Q];if(!M[K])continue;const{styleLayer:te,targets:me}=M[K];let he={};void 0!==W&&(he=L.getFeatureState(te.sourceLayer,W));const fe=!g||g(j,te,he,I);if(!fe)continue;const xe=new Pp(j,this.z,this.x,this.y,W);xe.tile=this.tileID.canonical,xe.state=he;let Ee=this.serializedLayersCache.get(K);Ee||(Ee=te.serialize(),Ee.id=K,this.serializedLayersCache.set(K,Ee)),xe.source=Ee.source,xe.sourceLayer=Ee["source-layer"],xe.layer=Ie({},Ee),xe.layer.paint=Ga(Ee.paint,te.paint,j,he,h),xe.layer.layout=Ga(Ee.layout,te.layout,j,he,h);let Ve=!1;for(const Ce of me){this.updateFeatureProperties(xe,Ce);const{filter:Ue}=Ce;if(Ue)if(j.properties=xe.properties,Ue.needGeometry){const ot=Ne(j,!0);if(!Ue.filter(new Tn(this.tileID.overscaledZ,{worldview:m}),ot,this.tileID.canonical))continue}else if(!Ue.filter(new Tn(this.tileID.overscaledZ,{worldview:m}),j))continue;Ve=!0,Ce.targetId&&this.addFeatureVariant(xe,Ce)}Ve&&this.appendToResult(i,K,x,xe,fe)}}loadMatchingModelFeature(i,o,c,h,m,g){const{featureIndex:x,bucketIndex:w}=o,T=this.bucketLayerIDs[w],I=c.layers,A=Object.keys(I);if(!A.length||cn(A,T))for(let M=0;M<T.length;M++){const k=T[M],{styleLayer:L,targets:V}=I[k];if("model"!==L.type)continue;const j=h.tile,W=j.getBucket(L);if(!(W&&W instanceof Ly))continue;const Q=LC(W,x,h,m);if(!Q)continue;const{z:K,x:te,y:me}=j.tileID.canonical,{feature:he,intersectionZ:fe,position:xe}=Q;let Ee={};void 0!==he.id&&(Ee=c.sourceCache.getFeatureState(L.sourceLayer,he.id));const Ve=new Pp({},K,te,me,he.id);Ve.tile=this.tileID.canonical,Ve.state=Ee,Ve.properties=he.properties,Ve.geometry={type:"Point",coordinates:[xe.lng,xe.lat]};let Ce=this.serializedLayersCache.get(k);Ce||(Ce=L.serialize(),Ce.id=k,this.serializedLayersCache.set(k,Ce)),Ve.source=Ce.source,Ve.sourceLayer=Ce["source-layer"],Ve.layer=Ie({},Ce);let Ue=!1;for(const ot of V){this.updateFeatureProperties(Ve,ot);const{filter:$e}=ot;if($e)if(he.properties=Ve.properties,$e.needGeometry){if(!$e.filter(new Tn(this.tileID.overscaledZ,{worldview:g}),he,this.tileID.canonical))continue}else if(!$e.filter(new Tn(this.tileID.overscaledZ,{worldview:g}),he))continue;Ue=!0,ot.targetId&&this.addFeatureVariant(Ve,ot)}Ue&&this.appendToResult(i,k,x,Ve,fe)}}updateFeatureProperties(i,o,c){if(o.properties){const h={};for(const m in o.properties){const g=o.properties[m].evaluate({zoom:this.z},i._vectorTileFeature,i.state,i.tile,c);null!=g&&(h[m]=g)}i.properties=h}}addFeatureVariant(i,o,c){const h={target:o.target,namespace:o.namespace,uniqueFeatureID:o.uniqueFeatureID};o.properties&&(h.properties=i.properties),i.variants=i.variants||{},i.variants[o.targetId]=i.variants[o.targetId]||[],i.variants[o.targetId].push(h)}appendToResult(i,o,c,h,m){let g=i[o];void 0===g&&(g=i[o]=[]),g.push({featureIndex:c,feature:h,intersectionZ:m})}lookupSymbolFeatures(i,o,c,h,m,g){const x={};this.loadVTLayers();for(const w of i)this.loadMatchingFeature(x,{bucketIndex:o,sourceLayerIndex:c,featureIndex:w,layoutVertexArrayOffset:0},h,m,g);return x}loadFeature(i){const{featureIndex:o,sourceLayerIndex:c}=i;this.loadVTLayers();const h=this.sourceLayerCoder.decode(c),m=this.vtFeatures[h];if(m[o])return m[o];const g=this.vtLayers[h].feature(o);return m[o]=g,g}hasLayer(i){for(const o of this.bucketLayerIDs)for(const c of o)if(i===c)return!0;return!1}getId(i,o){let c=i.id;if(this.promoteId){const h=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[o];if(null!=h)if(Array.isArray(h)){if(!this.promoteIdExpression){const m=Wc(h);if("success"!==m.result)return void yn(`Failed to create expression for promoteId: ${m.value.map(x=>`${x.key}: ${x.message}`).join(", ")}`);this.promoteIdExpression=m.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Kd),c=this.promoteIdExpression.evaluate({zoom:0},i)}else c=i.properties[h];"boolean"==typeof c&&(c=Number(c))}return c}}function Ga(a,i,o,c,h){return Zt(a,(m,g)=>{const x=i instanceof Do?i.get(g):null;return x&&x.evaluate?x.evaluate(o,c,void 0,h):x})}function Pl(a,i){return i-a}Et(Ml,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const vx=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Jy{static from(i){if(!(i instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[o,c]=new Uint8Array(i,0,2);if(219!==o)throw new Error("Data does not appear to be in a KDBush format.");const h=c>>4;if(1!==h)throw new Error(`Got v${h} data when expected v1.`);const m=vx[15&c];if(!m)throw new Error("Unrecognized array type.");const[g]=new Uint16Array(i,2,1),[x]=new Uint32Array(i,4,1);return new Jy(x,g,m,i)}constructor(i,o=64,c=Float64Array,h){if(isNaN(i)||i<0)throw new Error(`Unpexpected numItems value: ${i}.`);this.numItems=+i,this.nodeSize=Math.min(Math.max(+o,2),65535),this.ArrayType=c,this.IndexArrayType=i<65536?Uint16Array:Uint32Array;const m=vx.indexOf(this.ArrayType),g=2*i*this.ArrayType.BYTES_PER_ELEMENT,x=i*this.IndexArrayType.BYTES_PER_ELEMENT,w=(8-x%8)%8;if(m<0)throw new Error(`Unexpected typed array class: ${c}.`);h&&h instanceof ArrayBuffer?(this.data=h,this.ids=new this.IndexArrayType(this.data,8,i),this.coords=new this.ArrayType(this.data,8+x+w,2*i),this._pos=2*i,this._finished=!0):(this.data=new ArrayBuffer(8+g+x+w),this.ids=new this.IndexArrayType(this.data,8,i),this.coords=new this.ArrayType(this.data,8+x+w,2*i),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+m]),new Uint16Array(this.data,2,1)[0]=o,new Uint32Array(this.data,4,1)[0]=i)}add(i,o){const c=this._pos>>1;return this.ids[c]=c,this.coords[this._pos++]=i,this.coords[this._pos++]=o,c}finish(){const i=this._pos>>1;if(i!==this.numItems)throw new Error(`Added ${i} items when expected ${this.numItems}.`);return xx(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(i,o,c,h){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:m,coords:g,nodeSize:x}=this,w=[0,m.length-1,0],T=[];for(;w.length;){const I=w.pop()||0,A=w.pop()||0,M=w.pop()||0;if(A-M<=x){for(let j=M;j<=A;j++){const W=g[2*j],Q=g[2*j+1];W>=i&&W<=c&&Q>=o&&Q<=h&&T.push(m[j])}continue}const k=M+A>>1,L=g[2*k],V=g[2*k+1];L>=i&&L<=c&&V>=o&&V<=h&&T.push(m[k]),(0===I?i<=L:o<=V)&&(w.push(M),w.push(k-1),w.push(1-I)),(0===I?c>=L:h>=V)&&(w.push(k+1),w.push(A),w.push(1-I))}return T}within(i,o,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:h,coords:m,nodeSize:g}=this,x=[0,h.length-1,0],w=[],T=c*c;for(;x.length;){const I=x.pop()||0,A=x.pop()||0,M=x.pop()||0;if(A-M<=g){for(let j=M;j<=A;j++)ev(m[2*j],m[2*j+1],i,o)<=T&&w.push(h[j]);continue}const k=M+A>>1,L=m[2*k],V=m[2*k+1];ev(L,V,i,o)<=T&&w.push(h[k]),(0===I?i-c<=L:o-c<=V)&&(x.push(M),x.push(k-1),x.push(1-I)),(0===I?i+c>=L:o+c>=V)&&(x.push(k+1),x.push(A),x.push(1-I))}return w}}function xx(a,i,o,c,h,m){if(h-c<=o)return;const g=c+h>>1;Jw(a,i,g,c,h,m),xx(a,i,o,c,g-1,1-m),xx(a,i,o,g+1,h,1-m)}function Jw(a,i,o,c,h,m){for(;h>c;){if(h-c>600){const T=h-c+1,I=o-c+1,A=Math.log(T),M=.5*Math.exp(2*A/3),k=.5*Math.sqrt(A*M*(T-M)/T)*(I-T/2<0?-1:1);Jw(a,i,o,Math.max(c,Math.floor(o-I*M/T+k)),Math.min(h,Math.floor(o+(T-I)*M/T+k)),m)}const g=i[2*o+m];let x=c,w=h;for(Fg(a,i,c,o),i[2*h+m]>g&&Fg(a,i,c,h);x<w;){for(Fg(a,i,x,w),x++,w--;i[2*x+m]<g;)x++;for(;i[2*w+m]>g;)w--}i[2*c+m]===g?Fg(a,i,c,w):(w++,Fg(a,i,w,h)),w<=o&&(c=w+1),o<=w&&(h=w-1)}}function Fg(a,i,o,c){bx(a,o,c),bx(i,2*o,2*c),bx(i,2*o+1,2*c+1)}function bx(a,i,o){const c=a[i];a[i]=a[o],a[o]=c}function ev(a,i,o,c){const h=a-o,m=i-c;return h*h+m*m}u.$=Jr,u.A=Yr,u.B=pa,u.C=ed,u.D=np,u.E=Nu,u.F=2,u.G=ms,u.H=fw,u.I=Jt,u.J=ui,u.K=class extends _u{},u.L=Rc,u.M=m_,u.N=Xu,u.O=Zu,u.P=Je,u.Q=Pf,u.R=Li,u.S=d_,u.T=jh,u.U=Sn,u.V=_u,u.W=Ff,u.X=Wc,u.Y=Ql,u.Z=ga,u._=Fn,u.a=function(a){return so.API_CDN_URL_REGEX.test(a)},u.a$=qe,u.a0=zu,u.a1=Ku,u.a2=ch,u.a3=dm,u.a4=function(a){const i=a.value;let o=[];if(!i)return o;const c=ui(i);return"string"!==c?(o=o.concat([new _u(a.key,i,`string expected, "${c}" found`)]),o):(Sd(i,!0)||(o=o.concat([new _u(a.key,i,`invalid url "${i}"`)])),o)},u.a5=Se,u.a6=za,u.a7=Ki,u.a8=it,u.a9=class{constructor(a){this.specification=a}possiblyEvaluate(a,i){return Lr(a.expression.evaluate(i))}interpolate(a,i,o){return{x:Nt(a.x,i.x,o),y:Nt(a.y,i.y,o),z:Nt(a.z,i.z,o),azimuthal:Nt(a.azimuthal,i.azimuthal,o),polar:Nt(a.polar,i.polar,o)}}},u.aA=xs,u.aB=Zi,u.aC=Co,u.aD=U,u.aE=ye,u.aF=function(a,i){const o={};for(let c=0;c<i.length;c++){const h=i[c];h in a&&(o[h]=a[h])}return o},u.aG=N,u.aH=q,u.aI=class{constructor(a){this.entries={},this.scheduler=a}request(a,i,o,c){const h=this.entries[a]=this.entries[a]||{callbacks:[]};if(h.result){const[m,g]=h.result;return this.scheduler?this.scheduler.add(()=>{c(m,g)},i):c(m,g),()=>{}}return h.callbacks.push(c),h.cancel||(h.cancel=o((m,g)=>{h.result=[m,g];for(const x of h.callbacks)this.scheduler?this.scheduler.add(()=>{x(m,g)},i):x(m,g);setTimeout(()=>delete this.entries[a],3e3)})),()=>{h.result||(h.callbacks=h.callbacks.filter(m=>m!==c),h.callbacks.length||(h.cancel(),delete this.entries[a]))}}},u.aJ=function(a,i,o){const c=JSON.stringify(a.request);return a.data&&(this.deduped.entries[c]={result:[null,a.data]}),this.deduped.request(c,{type:"parseTile",isSymbolTile:a.isSymbolTile,zoom:a.tileZoom},h=>{const m=Ic(a.request,(g,x,w,T)=>{g?h(g):x&&h(null,{vectorTile:o?void 0:new Mt(new xd(x)),rawData:x,cacheControl:w,expires:T})});return()=>{m.cancel(),h()}},i)},u.aK=function(a){Nn++,Nn>Ci&&(a.getActor().send("enforceCacheSizeLimit",ha),Nn=0)},u.aL=function(a){return a<=1?1:Math.pow(2,Math.floor(Math.log(a)/Math.LN2))},u.aM=Mr,u.aN=gs,u.aO=Yh,u.aP=Dl,u.aQ=function(a,i){const o=document.createElement("video");o.muted=!0,o.onloadstart=function(){i(null,o)};for(let c=0;c<a.length;c++){const h=document.createElement("source");Bs(a[c])||(o.crossOrigin="Anonymous"),h.src=a[c],o.appendChild(h)}return{cancel:()=>{}}},u.aR=_d,u.aS=function(a){return fetch(a).then(i=>i.arrayBuffer()).then(i=>Vh(i,0,a))},u.aT=Xo,u.aU=class{constructor(a,i,o,c){this.id=a,this.position=null!=i?new O(i[0],i[1]):new O(0,0),this.orientation=o??[0,0,0],this.nodes=c,this.uploaded=!1,this.aabb=new sn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(a,i){if(Ui(a.matrix,i,a.matrix),a.meshes)for(const o of a.meshes){const c=sn.applyTransformFast(o.aabb,a.matrix);this.aabb.encapsulate(c)}if(a.children)for(const o of a.children)this._applyTransformations(o,a.matrix)}computeBoundsAndApplyParent(){const a=fn([]);for(const i of this.nodes)this._applyTransformations(i,a)}computeModelMatrix(a,i,o,c,h,m,g=!1){Lb(this.matrix,this,a.transform,this.position,i,o,c,h,m,g)}upload(a){if(!this.uploaded){for(const i of this.nodes)cp(i,a);for(const i of this.nodes)iy(i);this.uploaded=!0}}destroy(){for(const a of this.nodes)ry(a)}},u.aV=$t,u.aW=xp,u.aX=Y,u.aY=ee,u.aZ=to,u.a_=Pi,u.aa=Tn,u.ab=Zc,u.ac=ue,u.ad=lr,u.ae=go,u.af=be,u.ag=Do,u.ah=lu,u.ai=Nt,u.aj=ht,u.ak=yf,u.al=Rn,u.am=Kn,u.an=class{constructor(a){this.specification=a}possiblyEvaluate(a,i){return function([o,c]){const h=Lr([1,o,c]);return{x:h.x,y:h.y,z:h.z}}(a.expression.evaluate(i))}interpolate(a,i,o){return{x:Nt(a.x,i.x,o),y:Nt(a.y,i.y,o),z:Nt(a.z,i.z,o)}}},u.ao=function(a,i,o=0,c=!0){const h=new Je(o,o),m=a.sub(h),g=i.add(h),x=[m,new Je(g.x,m.y),g,new Je(m.x,g.y)];return c&&x.push(m.clone()),x},u.ap=function(a,i){const o=[];for(let c=0;c<a.length;c++){const h=ke(c-1,-1,a.length-1),m=ke(c+1,-1,a.length-1),g=a[c],x=a[m],w=a[h].sub(g).unit(),T=x.sub(g).unit(),I=T.angleWithSep(w.x,w.y),A=w.add(T).unit().mult(-1*i/Math.sin(I/2));o.push(g.add(A))}return o},u.aq=mg,u.ar=Qi,u.as=function(a,i,o=0){return mr(((i.x-o)*a.scale-a.x)*ht,(i.y*a.scale-a.y)*ht,ne(i.z,i.y))},u.at=cr,u.au=Mi,u.av=Mn,u.aw=Wb,u.ax=function(a){let i=1/0,o=1/0,c=-1/0,h=-1/0;for(const m of a)i=Math.min(i,m.x),o=Math.min(o,m.y),c=Math.max(c,m.x),h=Math.max(h,m.y);return{min:new Je(i,o),max:new Je(c,h)}},u.ay=se,u.az=Ui,u.b=function(a){return so.API_FONTS_REGEX.test(a)},u.b$=Ey,u.b0=xh,u.b1=Iy,u.b2=function(){Gs.isLoading()||Gs.isLoaded()||"deferred"!==dr()||jf()},u.b3=mh,u.b4=Ne,u.b5=Pp,u.b6=Vn,u.b7=wl,u.b8=hd,u.b9=_e,u.bA=function(a,i){const{x:o,y:c}=a.point,h=zv(o,c,a.worldSize/a._pixelsPerMercatorPixel,0,0);return Ui(h,h,Nm(Va(i)))},u.bB=Ca,u.bC=Ld,u.bD=function(a,i){return Math.hypot(i[0]-a[0],i[1]-a[1],i[2]-a[2])},u.bE=Uo,u.bF=vi,u.bG=ar,u.bH=ug,u.bI=Ps,u.bJ=R0,u.bK=function(a,i,o,c,h){const m=5*i+2;a.float32[m+0]=o,a.float32[m+1]=c,a.float32[m+2]=h},u.bL=Cy,u.bM=Zr,u.bN=Qa,u.bO=Ya,u.bP=zs,u.bQ=ke,u.bR=function(a,i,o,c){var h=new ji(4);return h[0]=a,h[1]=i,h[2]=o,h[3]=c,h},u.bS=Qm,u.bT=di,u.bU=Pr,u.bV=PE,u.bW=Kh,u.bX=fc,u.bY=Fh,u.bZ=gp,u.b_=z0,u.ba=Ds,u.bb=Dm,u.bc=Om,u.bd=Wi,u.be=Sh,u.bf=Y0,u.bg=function(a,i){const o=lu(i.zoom);if(0===o)return Va(a);const c=Fm(a),h=Nv(c),m=U(c.getWest())*i.worldSize,g=U(c.getEast())*i.worldSize,x=q(c.getNorth())*i.worldSize,w=q(c.getSouth())*i.worldSize,T=[m,x,0],I=[g,x,0],A=[m,w,0],M=[g,w,0],k=es([],i.globeMatrix);return lr(T,T,k),lr(I,I,k),lr(A,A,k),lr(M,M,k),h[0]=au(h[0],A,o),h[1]=au(h[1],M,o),h[2]=au(h[2],I,o),h[3]=au(h[3],T,o),sn.fromPoints(h)},u.bh=Lm,u.bi=es,u.bj=km,u.bk=au,u.bl=Kc,u.bm=T_,u.bn=Bl,u.bo=jo,u.bp=_x,u.bq=xd,u.br=Ic,u.bs=function(a,i){const o=[];for(const c in a)c in i||o.push(c);return o},u.bt=Te,u.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],u.bv=Ja,u.bw=function(a){var i=new ji(16);return i[0]=a[0],i[1]=a[1],i[2]=a[2],i[3]=a[3],i[4]=a[4],i[5]=a[5],i[6]=a[6],i[7]=a[7],i[8]=a[8],i[9]=a[9],i[10]=a[10],i[11]=a[11],i[12]=a[12],i[13]=a[13],i[14]=a[14],i[15]=a[15],i},u.bx=fn,u.by=zl,u.bz=Nl,u.c=mf,u.c$=45,u.c0=Jy,u.c1=ki,u.c2=Vl,u.c3=Pa,u.c4=function(a,i,o){o*=.5;var c=i[0],h=i[1],m=i[2],g=i[3],x=Math.sin(o),w=Math.cos(o);return a[0]=c*w+h*x,a[1]=h*w-c*x,a[2]=m*w+g*x,a[3]=g*w-m*x,a},u.c5=Tc,u.c6=Vi,u.c7=function(a,i){return a[0]=-i[0],a[1]=-i[1],a[2]=-i[2],a[3]=i[3],a},u.c8=Ia,u.c9=function(a,i,o,c,h){var m,g=1/Math.tan(i/2);return a[0]=g/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=g,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=-1,a[12]=0,a[13]=0,a[15]=0,null!=h&&h!==1/0?(a[10]=(h+c)*(m=1/(c-h)),a[14]=2*h*c*m):(a[10]=-1,a[14]=-2*c),a},u.cA=Wo,u.cB=nb,u.cC=function(a,i,o,c,h,m,g,x,w){if("globe"===w.name)return nb(a,i,new Wo(o,c,h),!1);const T=xp({z:o,x:c,y:h},w);return new sn([(m+T.x/T.scale)*i,i*(T.y/T.scale),g],[(m+T.x2/T.scale)*i,i*(T.y2/T.scale),x])},u.cD=function(a,i,o){return a[0]=Math.min(i[0],o[0]),a[1]=Math.min(i[1],o[1]),a[2]=Math.min(i[2],o[2]),a[3]=Math.min(i[3],o[3]),a},u.cE=function(a,i,o){return a[0]=Math.max(i[0],o[0]),a[1]=Math.max(i[1],o[1]),a[2]=Math.max(i[2],o[2]),a[3]=Math.max(i[3],o[3]),a},u.cF=function(a){const i=Math.round((a+45+360)%360/90)%4;return Z[i]},u.cG=le,u.cH=Wa,u.cI=f,u.cJ=function(a){const i=fn(new Float64Array(16));Ui(i,a.pixelMatrix,a.globeMatrix);const o=[0,y,0],c=[0,v,0];return lr(o,o,i),lr(c,c,i),[o[0]>0&&o[0]<=a.width&&o[1]>0&&o[1]<=a.height&&!C_(a,new O(a.center.lat,90)),c[0]>0&&c[0]<=a.width&&c[1]>0&&c[1]<=a.height&&!C_(a,new O(a.center.lat,-90))]},u.cK=function(a,i){const{scale:o}=a.tileTransform,c=o*ht/(a.tileSize*Math.pow(2,i.zoom-a.tileID.overscaledZ+a.tileID.canonical.z));return h=new Float32Array(4),x=(m=i.inverseAdjustmentMatrix)[1],w=m[2],T=m[3],A=(g=[c,c])[1],h[0]=m[0]*(I=g[0]),h[1]=x*I,h[2]=w*A,h[3]=T*A,h;var h,m,g,x,w,T,I,A},u.cL=ty,u.cM=df,u.cN=Rb,u.cO=function(a){const i=Rb(a,!0);return Ca([],[i[0],i[1],i[4],i[5]])},u.cP=ro,u.cQ=kn,u.cR=ys,u.cS=function(a){const{x:i,y:o}=a.point,{lng:c,lat:h}=a._center;return zv(i,o,a.worldSize,c,h)},u.cT=hf,u.cU=Pe,u.cV=Is,u.cW=rr,u.cX=Yf,u.cY=function(a,i,o){let c=0;for(let h=0;h<2;++h)a[h]>0&&(c+=(a[h]-0)*(a[h]-0)),i[h]<0&&(c+=(0-i[h])*(0-i[h]));return c},u.cZ=function(a){return a*a*a*a*a},u.c_=H,u.ca=function(a,i,o,c,h,m,g){var x=1/(i-o),w=1/(c-h),T=1/(m-g);return a[0]=-2*x,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*w,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*T,a[11]=0,a[12]=(i+o)*x,a[13]=(h+c)*w,a[14]=(g+m)*T,a[15]=1,a},u.cb=G,u.cc=function(a,i,o){a[4*i+0]=o[0],a[4*i+1]=o[1],a[4*i+2]=o[2],a[4*i+3]=o[3]},u.cd=wh,u.ce=ad,u.cf=vr,u.cg=lo,u.ch=dc,u.ci=O,u.cj=Ew,u.ck=function(){var a=new ji(4);return ji!=Float32Array&&(a[1]=0,a[2]=0),a[0]=1,a[3]=1,a},u.cl=function(a,i,o){var c=i[0],h=i[1],m=i[2],g=i[3],x=Math.sin(o),w=Math.cos(o);return a[0]=c*w+m*x,a[1]=h*w+g*x,a[2]=c*-x+m*w,a[3]=h*-x+g*w,a},u.cm=function(a,i){return a[0]===i[0]&&a[1]===i[1]&&a[2]===i[2]&&a[3]===i[3]},u.cn=vs,u.co=function(a){return Math.hypot(a[0],a[1],a[2],a[3])},u.cp=Xa,u.cq=Ma,u.cr=wa,u.cs=3,u.ct=2,u.cu=7,u.cv=6,u.cw=nr,u.cx=Un,u.cy=In,u.cz=_0,u.d=function(a){return so.API_TILEJSON_REGEX.test(a)},u.d$=(a,i,o,c,h,m,g,x,w,T)=>{const I=a.transform,A=I.calculatePixelsToTileUnitsMatrix(i),M="none"===o.paint.get("line-trim-color-use-theme").constantOr("default"),k=I.pitch<15?ay(.07,.7,se((14-I.zoom)/5,0,1)):.07;return{u_matrix:T0(a,i,o,c),u_pixels_to_tile_units:A,u_device_pixel_ratio:m,u_width_scale:g,u_floor_width_scale:x,u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:h,u_texsize:JE(o)&&i.lineAtlasTexture?i.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:fo(i,a.transform),u_alpha_discard_threshold:0,u_trim_offset:w,u_trim_fade_range:o.paint.get("line-trim-fade-range"),u_trim_color:o.paint.get("line-trim-color").toPremultipliedRenderColor(M?null:o.lut).toArray01(),u_emissive_strength:o.paint.get("line-emissive-strength"),u_zbias_factor:k,u_tile_to_meter:ce(i.tileID.canonical,0),u_ground_shadow_factor:T}},u.d0=uc,u.d1=function(a,i,o){const c=Math.sqrt(a*a+i*i+o*o),h=c>0?Math.acos(o/c)*pf:0;let m=0!==a||0!==i?Math.atan2(-i,-a)*pf+90:0;return m<0&&(m+=360),[c,m,h]},u.d2=mr,u.d3=Lr,u.d4=ce,u.d5=Fi,u.d6=sn,u.d7=oo,u.d8=function(a){return[Math.pow(a[0],1/2.2),Math.pow(a[1],1/2.2),Math.pow(a[2],1/2.2)]},u.d9=Sd,u.dA=Fm,u.dB=function(a){const i=le-5;a=se(a,-i,i)/i*90;const o=Math.pow(Math.abs(Math.sin(Rn(a))),3);return Math.round(o*(p.length-1))},u.dC=function(a,i,o,c){const h=i.getNorth(),m=i.getSouth(),g=i.getWest(),x=i.getEast(),w=1<<a.z,T=x-g,I=h-m,A=T/l,M=-I/p[o],k=[0,A,0,M,0,0,h,g,0];if(a.z>0){const L=180/c;ks(k,k,[L/T+1,0,0,0,L/I+1,0,-.5*L/A,.5*L/M,1])}return k[2]=w,k[5]=a.x,k[8]=a.y,k},u.dD=Va,u.dE=function(a,i,o){const c=fn(new Float64Array(16)),h=(i/(1<<a)-.5)*Math.PI*2;return Ws(c,o.globeMatrix,h),Float32Array.from(c)},u.dF=class{isDataAvailableAtPoint(a){const i=this._source();if(this.isUsingMockSource()||!i||a.y<0||a.y>1)return!1;const o=i.getSource().maxzoom,c=1<<o,h=Math.floor(a.x),m=Math.floor((a.x-h)*c),g=Math.floor(a.y*c),x=this.findDEMTileFor(new Mr(o,h,o,m,g));return!(!x||!x.dem)}getAtPointOrZero(a,i=0){return this.getAtPoint(a,i)||0}getAtPoint(a,i,o=!0){if(this.isUsingMockSource())return null;null==i&&(i=null);const c=this._source();if(!c||a.y<0||a.y>1)return i;const h=c.getSource().maxzoom,m=1<<h,g=Math.floor(a.x),x=a.x-g,w=new Mr(h,g,h,Math.floor(x*m),Math.floor(a.y*m)),T=this.findDEMTileFor(w);if(!T||!T.dem)return i;const I=T.dem,A=1<<T.tileID.canonical.z,M=(x*A-T.tileID.canonical.x)*I.dim,k=(a.y*A-T.tileID.canonical.y)*I.dim,L=Math.floor(M),V=Math.floor(k);return(o?this.exaggeration():1)*Nt(Nt(I.get(L,V),I.get(L,V+1),k-V),Nt(I.get(L+1,V),I.get(L+1,V+1),k-V),M-L)}getAtTileOffset(a,i,o){const c=1<<a.canonical.z;return this.getAtPointOrZero(new ue(a.wrap+(a.canonical.x+i/ht)/c,(a.canonical.y+o/ht)/c))}getAtTileOffsetFunc(a,i,o,c){return h=>{const m=this.getAtTileOffset(a,h.x,h.y),g=c.upVector(a.canonical,h.x,h.y);return ki(g,g,m*c.upVectorScale(a.canonical,i,o).metersToTile),g}}getForTilePoints(a,i,o,c){if(this.isUsingMockSource())return!1;const h=ef.create(this,a,c);return!!h&&(i.forEach(m=>{m[2]=this.exaggeration()*h.getElevationAt(m[0],m[1],o)}),!0)}getMinMaxForTile(a){if(this.isUsingMockSource())return null;const i=this.findDEMTileFor(a);if(!i||!i.dem)return null;const o=i.dem.tree,c=i.tileID,h=1<<a.canonical.z-c.canonical.z;let m=a.canonical.x/h-c.canonical.x,g=a.canonical.y/h-c.canonical.y,x=0;for(let w=0;w<a.canonical.z-c.canonical.z&&!o.leaves[x];w++){m*=2,g*=2;const T=2*Math.floor(g)+Math.floor(m);x=o.childOffsets[x]+T,m%=1,g%=1}return{min:this.exaggeration()*o.minimums[x],max:this.exaggeration()*o.maximums[x]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(a,i,o){throw new Error("Pure virtual method called.")}pointCoordinate(a){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(a){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const a=this.visibleDemTiles;if(0===a.length)return null;let i=!1,o=Number.MAX_VALUE,c=Number.MIN_VALUE;for(const h of a){const m=this.getMinMaxForTile(h.tileID);m&&(o=Math.min(o,m.min),c=Math.max(c,m.max),i=!0)}return i?{min:o,max:c}:null}},u.dG=db,u.dH=vl,u.dI=function(a,i){return[Math.pow(a[0],2.2)*i,Math.pow(a[1],2.2)*i,Math.pow(a[2],2.2)*i]},u.dJ=kd,u.dK=function(a,i){var o=Math.sin(i),c=Math.cos(i);return a[0]=c,a[1]=o,a[2]=0,a[3]=-o,a[4]=c,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},u.dL=Ls,u.dM=Kf,u.dN=Ho,u.dO=_o,u.dP=256,u.dQ=function(a,i){const o=[0,0,0];return lr(o,o,Lm(Va(i.canonical))),lr(o,o,a),o},u.dR=a=>({u_matrix:new dc(a),u_texsize:new lo(a),u_pixels_to_tile_units:new Zf(a),u_device_pixel_ratio:new vr(a),u_width_scale:new vr(a),u_floor_width_scale:new vr(a),u_image:new wh(a),u_units_to_pixels:new lo(a),u_tile_units_to_pixels:new vr(a),u_alpha_discard_threshold:new vr(a),u_trim_offset:new lo(a),u_trim_fade_range:new lo(a),u_trim_color:new uc(a),u_emissive_strength:new vr(a),u_zbias_factor:new vr(a),u_tile_to_meter:new vr(a),u_ground_shadow_factor:new ad(a),u_pattern_transition:new vr(a)}),u.dS=a=>({u_matrix:new dc(a),u_pixels_to_tile_units:new Zf(a),u_device_pixel_ratio:new vr(a),u_width_scale:new vr(a),u_floor_width_scale:new vr(a),u_units_to_pixels:new lo(a),u_dash_image:new wh(a),u_gradient_image:new wh(a),u_image_height:new vr(a),u_texsize:new lo(a),u_tile_units_to_pixels:new vr(a),u_alpha_discard_threshold:new vr(a),u_trim_offset:new lo(a),u_trim_fade_range:new lo(a),u_trim_color:new uc(a),u_emissive_strength:new vr(a),u_zbias_factor:new vr(a),u_tile_to_meter:new vr(a),u_ground_shadow_factor:new ad(a)}),u.dT=a=>({u_camera_to_center_distance:new vr(a),u_extrude_scale:new Zf(a),u_device_pixel_ratio:new vr(a),u_matrix:new dc(a),u_inv_rot_matrix:new dc(a),u_merc_center:new lo(a),u_tile_id:new ad(a),u_zoom_transition:new vr(a),u_up_dir:new ad(a),u_emissive_strength:new vr(a)}),u.dU=Jc,u.dV=nw,u.dW=ab,u.dX=(a,i,o,c,h,m)=>{const g=a.transform,x="globe"===g.projection.name;let w;if("map"===m.paint.get("circle-pitch-alignment"))if(x){const I=Kf(g.zoom,i.canonical)*g._pixelsPerMercatorPixel;w=Float32Array.from([I,0,0,I])}else w=g.calculatePixelsToTileUnitsMatrix(o);else w=new Float32Array([g.pixelsToGLUnits[0],0,0,g.pixelsToGLUnits[1]]);const T={u_camera_to_center_distance:a.transform.getCameraToCenterDistance(g.projection),u_matrix:a.translatePosMatrix(i.projMatrix,o,m.paint.get("circle-translate"),m.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Zs.devicePixelRatio,u_extrude_scale:w,u_inv_rot_matrix:sb,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:m.paint.get("circle-emissive-strength")};if(x){T.u_inv_rot_matrix=c,T.u_merc_center=h,T.u_tile_id=[i.canonical.x,i.canonical.y,1<<i.canonical.z],T.u_zoom_transition=lu(g.zoom);const I=h[0]*ht,A=h[1]*ht;T.u_up_dir=g.projection.upVector(new Wo(0,0,0),I,A)}return T},u.dY=Zb,u.dZ=vo,u.d_=(a,i,o,c,h,m,g,x,w,T)=>{const I=a.transform,A=I.pitch<15?ay(.07,.7,se((14-I.zoom)/5,0,1)):.07,M="none"===o.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:T0(a,i,o,c),u_texsize:i.imageAtlasTexture?i.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:I.calculatePixelsToTileUnitsMatrix(i),u_device_pixel_ratio:h,u_width_scale:m,u_floor_width_scale:g,u_image:0,u_tile_units_to_pixels:fo(i,I),u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:x,u_trim_fade_range:o.paint.get("line-trim-fade-range"),u_trim_color:o.paint.get("line-trim-color").toPremultipliedRenderColor(M?null:o.lut).toArray01(),u_emissive_strength:o.paint.get("line-emissive-strength"),u_zbias_factor:A,u_tile_to_meter:ce(i.tileID.canonical,0),u_ground_shadow_factor:w,u_pattern_transition:T}},u.da=function(a,i){return a.readFields(Vy,{icons:[]},i)},u.db=K_,u.dc=_p,u.dd=N0,u.de=qp,u.df=_a,u.dg=Xs,u.dh=Wd,u.di=pn,u.dj=function(a){const i=a.indexOf("\x1f");return i>=0?a.slice(0,i):a},u.dk=function(a){return a.indexOf("\x1f")>=0},u.dl=function(a){const i=a.lastIndexOf("\x1f");return i>=0?a.slice(i+1):""},u.dm=function(a){const i=[],o=a.id;return void 0===o&&i.push({message:`layers.${o}: missing required property "id"`}),void 0===a.render&&i.push({message:`layers.${o}: missing required method "render"`}),a.renderingMode&&"2d"!==a.renderingMode&&"3d"!==a.renderingMode&&i.push({message:`layers.${o}: property "renderingMode" must be either "2d" or "3d"`}),i},u.dn=function(a,i,o,c){return"custom"===a.type?new Tp(a,i):new DT[a.type](a,i,o,c)},u.dp=bn,u.dq=function(a){const i=a.indexOf("\x1f");return i>=0?a.slice(i+1):""},u.dr=class extends Pp{constructor(a,i){super(a._vectorTileFeature,a._z,a._x,a._y,a.id),a.state&&(this.state=Object.assign({},a.state)),this.target=i.target,this.namespace=i.namespace,i.properties&&(this.properties=i.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=a.source,this.sourceLayer=a.sourceLayer,this.layer=a.layer)}toJSON(){const a=super.toJSON();return a.target=this.target,a.namespace=this.namespace,a}},u.ds=Vf,u.dt=Lu,u.du=function(a){return a({pluginStatus:To,pluginURL:ic}),Vf.on("pluginStateChange",a),a},u.dv=Eh,u.dw=class extends $s{constructor(a){super(a),this.current=Pm}set(a,i,o){if(this.fetchUniformLocation(a,i))for(let c=0;c<9;c++)if(o[c]!==this.current[c]){this.current=o,this.gl.uniformMatrix3fv(this.location,!1,o);break}}},u.dx=X,u.dy=function(a,i,o){const c=lu(o.zoom),h=a.style.map._antialias,m=a.terrain&&a.terrain.exaggeration()>0;return 0===c&&!h&&!m},u.dz=function(a){const i=a.pixelsPerMeter,o=i/G(1,a.center.lat),c=fn(new Float64Array(16));return jo(c,c,[a.point.x,a.point.y,0]),ro(c,c,[o,o,i]),Float32Array.from(c)},u.e=so,u.e$=dr,u.e0=Lt,u.e1=Vm,u.e2=ne,u.e3=sa,u.e4=du,u.e5=Cb,u.e6=kh,u.e7=450,u.e8=7,u.e9=pe,u.eA=function(a,i,o,c,h,m,g,x,w,T,I,A,M,k,L,V){var j=new ji(16);return j[0]=a,j[1]=i,j[2]=o,j[3]=c,j[4]=h,j[5]=m,j[6]=g,j[7]=x,j[8]=w,j[9]=T,j[10]=I,j[11]=A,j[12]=M,j[13]=k,j[14]=L,j[15]=V,j},u.eB=C,u.eC=Em,u.eD=yr,u.eE=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Je(1/0,1/0),max:new Je(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(a,i=!1){const o=xb(new Je(0,0),new Je(ht,ht),a),c=[];if(i&&!B_(o,this._globalClipBounds))return c;for(const h of this._activeRegions){if(h.hiddenByOverlap||!B_(o,h))continue;const m=OE(h.min,h.max,a);c.push({min:m.min,max:m.max,sourceId:this._sourceIds[h.priority],footprint:h.footprint,footprintTileId:h.tileId,order:h.order,clipMask:h.clipMask,clipScope:h.clipScope})}return c}setSources(a){this._setSources(a.map(i=>({getSourceId:()=>i.cache.id,getFootprints:()=>{const o=[];for(const c of i.cache.getVisibleCoordinates()){const h=i.cache.getTile(c).buckets[i.layer];h&&h.updateFootprints(c.toUnwrapped(),o)}return o},getOrder:()=>i.order,getClipMask:()=>i.clipMask,getClipScope:()=>i.clipScope})))}_addSource(a){const i=a.getFootprints();if(0===i.length)return;const o=a.getOrder(),c=a.getClipMask(),h=a.getClipScope();for(const m of i){if(!m.footprint)continue;const g=xb(m.footprint.min,m.footprint.max,m.id);this._activeRegions.push({min:g.min,max:g.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:m.id,footprint:m.footprint,order:o,clipMask:c,clipScope:h})}this._sourceIds.push(a.getSourceId())}_computeReplacement(){this._activeRegions.sort((i,o)=>i.priority-o.priority||Kv(i.min,o.min)||Kv(i.max,o.max)||i.order-o.order||i.clipMask-o.clipMask||function(c,h){const m=(g,x)=>g+x;return c.length-h.length||c.reduce(m,"").localeCompare(h.reduce(m,""))}(i.clipScope,o.clipScope));let a=this._activeRegions.length!==this._prevRegions.length;if(!a){let i=0;for(;!a&&i!==this._activeRegions.length;){const o=this._activeRegions[i],c=this._prevRegions[i];a=o.priority!==c.priority||!RE(o,c)||o.order!==c.order||o.clipMask!==c.clipMask||!Ja(o.clipScope,c.clipScope),++i}}if(a){++this._updateTime;for(const o of this._activeRegions)o.order!==z_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,o.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,o.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,o.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,o.max.y));const i=o=>{const c=this._activeRegions;if(o>=c.length)return o;const h=c[o].priority;for(;o<c.length&&c[o].priority===h;)++o;return o};if(this._sourceIds.length>1){let o=0,c=i(o);for(;o!==c;){let h=o;const m=o;for(;h!==c;){const g=this._activeRegions[h];g.hiddenByOverlap=!1;for(let x=0;x<m;x++){const w=this._activeRegions[x];if(!w.hiddenByOverlap&&g.order===z_&&B_(g,w)&&(g.hiddenByOverlap=j_(g.footprint,g.tileId,w.footprint,w.tileId),g.hiddenByOverlap))break}++h}o=c,c=i(o)}}}}_setSources(a){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let i=a.length-1;i>=0;i--)this._addSource(a[i]);this._computeReplacement()}},u.eF=z_,u.eG=class{constructor(a){this._createGrid(a),this._createPoles(a)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const a of this._poleSegments)a.destroy();for(const a of this._gridSegments)a.withSkirts.destroy(),a.withoutSkirts.destroy()}_fillGridMeshWithLods(a,i){const o=new Ds,c=new Pi,h=[],m=a+1+2,g=i[0]+1,x=i[0]+1+(1+i.length),w=(T,I,A)=>{let M=T===m-1?T-2:0===T?T:T-1;return M+=A?24575:0,[M,I]};for(let T=0;T<m;++T)o.emplaceBack(...w(T,0,!0));for(let T=0;T<g;++T)for(let I=0;I<m;++I)o.emplaceBack(...w(I,T,(0===I||I===m-1)&&!0));for(let T=0;T<i.length;++T){const I=i[T];for(let A=0;A<m;++A)o.emplaceBack(...w(A,I,!0))}for(let T=0;T<i.length;++T){const I=c.length,A=i[T]+1+2,M=new Pi;for(let V=0;V<A-1;V++){const j=V===A-2,W=j?m*(x-i.length+T-V):m;for(let Q=0;Q<m-1;Q++){const K=V*m+Q;0===V||j||0===Q||Q===m-2?(M.emplaceBack(K+1,K,K+W),M.emplaceBack(K+W,K+W+1,K+1)):(c.emplaceBack(K+1,K,K+W),c.emplaceBack(K+W,K+W+1,K+1))}}const k=Wi.simpleSegment(0,I,o.length,c.length-I);for(let V=0;V<M.uint16.length;V+=3)c.emplaceBack(M.uint16[V],M.uint16[V+1],M.uint16[V+2]);const L=Wi.simpleSegment(0,I,o.length,c.length-I);h.push({withoutSkirts:k,withSkirts:L})}return{vertices:o,indices:c,segments:h}}_createGrid(a){const i=this._fillGridMeshWithLods(l,p);this._gridSegments=i.segments,this._gridBuffer=a.createVertexBuffer(i.vertices,Om.members),this._gridIndexBuffer=a.createIndexBuffer(i.indices,!0)}_createPoles(a){const i=new Pi;for(let g=0;g<=l;g++)i.emplaceBack(0,g+1,g+2);this._poleIndexBuffer=a.createIndexBuffer(i,!0);const o=new Hr,c=new Hr,h=new Hr,m=new Hr;this._poleSegments=[];for(let g=0,x=0;g<Yf;g++){const w=360/(1<<g);o.emplaceBack(0,-Zi,0,.5,0),c.emplaceBack(0,-Zi,0,.5,1),h.emplaceBack(0,-Zi,0,.5,.5),m.emplaceBack(0,-Zi,0,.5,.5);for(let T=0;T<=l;T++){let I=T/l,A=0;const M=Nt(0,w,I),[k,L,V]=b(ob,gE,M,Zi);o.emplaceBack(k,L,V,I,A),c.emplaceBack(k,L,V,I,1-A);const j=Rn(M);I=.5+.5*Math.sin(j),A=.5+.5*Math.cos(j),h.emplaceBack(k,L,V,I,A),m.emplaceBack(k,L,V,I,1-A)}this._poleSegments.push(Wi.simpleSegment(x,0,66,64)),x+=66}this._poleNorthVertexBuffer=a.createVertexBuffer(o,Rm,!1),this._poleSouthVertexBuffer=a.createVertexBuffer(c,Rm,!1),this._texturedPoleNorthVertexBuffer=a.createVertexBuffer(h,Rm,!1),this._texturedPoleSouthVertexBuffer=a.createVertexBuffer(m,Rm,!1)}getGridBuffers(a,i){return[this._gridBuffer,this._gridIndexBuffer,i?this._gridSegments[a].withSkirts:this._gridSegments[a].withoutSkirts]}getPoleBuffers(a,i){return[i?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,i?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[a]]}},u.eH=ME,u.eI=oe,u.eJ=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},u.eK=ge,u.eL=ae,u.eM=function(a,i,o){return a[0]=i[0]/o[0],a[1]=i[1]/o[1],a[2]=i[2]/o[2],a},u.eN=ts,u.eO=D,u.eP=ff,u.eQ=gr,u.eR=function([a,i,o]){const c=Math.hypot(a,i,o),h=Math.atan2(a,o),m=.5*Math.PI-Math.acos(-i/c);return new O(Pe(h),Pe(m))},u.eS=Ns,u.eT=og,u.eU=function(a){const i=a.navigator?a.navigator.userAgent:null;return!!function(o){if(null==$i){const c=o.navigator?o.navigator.userAgent:null;$i=!!o.safari||!(!c||!(/\b(iPad|iPhone|iPod)\b/.test(c)||c.match("Safari")&&!c.match("Chrome")))}return $i}(a)&&!(!i||!(i.match("Version/15.4")||i.match("Version/15.5")||i.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},u.eV=function(a,i){ha=a,Ci=i},u.eW=C_,u.eX=ib,u.eY=function(a){const i=[0,0,0],o=fn(new Float64Array(16));return Ui(o,a.pixelMatrix,a.globeMatrix),lr(i,i,o),new Je(i[0],i[1])},u.eZ=function(){const a=Lh;a&&(a.isPreloaded()&&1===a.numActive()?(a.release(Y_),Lh=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},u.e_=function(){K_().acquire(Y_)},u.ea=function(a,i){if(a===i){var o=i[1],c=i[2],h=i[3],m=i[6],g=i[7],x=i[11];a[1]=i[4],a[2]=i[8],a[3]=i[12],a[4]=o,a[6]=i[9],a[7]=i[13],a[8]=c,a[9]=m,a[11]=i[14],a[12]=h,a[13]=g,a[14]=x}else a[0]=i[0],a[1]=i[4],a[2]=i[8],a[3]=i[12],a[4]=i[1],a[5]=i[5],a[6]=i[9],a[7]=i[13],a[8]=i[2],a[9]=i[6],a[10]=i[10],a[11]=i[14],a[12]=i[3],a[13]=i[7],a[14]=i[11],a[15]=i[15];return a},u.eb=Eg,u.ec=En,u.ed=rd,u.ee=256,u.ef=Nm,u.eg=Ss,u.eh=Ws,u.ei=function(a,i){return a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=i[4],a[4]=i[5],a[5]=i[6],a[6]=i[8],a[7]=i[9],a[8]=i[10],a},u.ej=Hr,u.ek=pl,u.el=ll,u.em=function(a,i,o,c,h){return se((a-i)/(o-i)*(h-c)+c,c,h)},u.en=jl,u.eo=function(a,i){var o=i[0],c=i[1],h=i[2],m=i[3],g=i[4],x=i[5],w=i[6],T=i[7],I=i[8],A=I*g-x*T,M=-I*m+x*w,k=T*m-g*w,L=o*A+c*M+h*k;return L?(a[0]=A*(L=1/L),a[1]=(-I*c+h*T)*L,a[2]=(x*c-h*g)*L,a[3]=M*L,a[4]=(I*o-h*w)*L,a[5]=(-x*o+h*m)*L,a[6]=k*L,a[7]=(-T*o+c*w)*L,a[8]=(g*o-c*m)*L,a):null},u.ep=2,u.eq=Gi,u.er=Fb,u.es=[1,1,1],u.et=class{constructor(a,i,o,c){this.context=a,this.format=c,this.size=o,this.texture=a.gl.createTexture();const[h,m,g]=this.size,{gl:x}=a;x.bindTexture(x.TEXTURE_3D,this.texture),a.pixelStoreUnpackFlipY.set(!1),a.pixelStoreUnpack.set(1),a.pixelStoreUnpackPremultiplyAlpha.set(!1),x.texImage3D(x.TEXTURE_3D,0,this.format,h,m,g,0,ng(this.format),ig(this.format),i.data)}bind(a,i){const{context:o}=this,{gl:c}=o;c.bindTexture(c.TEXTURE_3D,this.texture),a!==this.minFilter&&(c.texParameteri(c.TEXTURE_3D,c.TEXTURE_MAG_FILTER,a),c.texParameteri(c.TEXTURE_3D,c.TEXTURE_MIN_FILTER,a),this.minFilter=a),i!==this.wrapS&&(c.texParameteri(c.TEXTURE_3D,c.TEXTURE_WRAP_S,i),c.texParameteri(c.TEXTURE_3D,c.TEXTURE_WRAP_T,i),this.wrapS=i)}destroy(){const{gl:a}=this.context;a.deleteTexture(this.texture),this.texture=null}},u.eu=ef,u.ev=Nd,u.ew=function(a,i,o,c){var h=i[0],m=i[1],g=i[2],x=i[3];return a[0]=h+c*(o[0]-h),a[1]=m+c*(o[1]-m),a[2]=g+c*(o[2]-g),a[3]=x+c*(o[3]-x),a},u.ex=vd,u.ey=va,u.ez=lc,u.f=function(a){return btoa(encodeURIComponent(a).replace(/%([0-9A-F]{2})/g,(i,o)=>String.fromCharCode(+("0x"+o))))},u.f0=function(a,i,o=!1){if(To===us.deferred||To===us.loading||To===us.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");ic=Zs.resolveURL(a),To=us.deferred,mm=i,Bf(),o||jf()},u.f1=function(a){md=Zs.resolveURL(a),rp||(rp=new np(K_(),new Nu)),rp.broadcast("setMeshoptUrl",md)},u.f2=Mb,u.f3=function(a){bl=Zs.resolveURL(a),rp||(rp=new np(K_(),new Nu)),rp.broadcast("setDracoUrl",bl)},u.f4=Ab,u.f5=tp,u.f6=function(a){const i=Cc();if(!i)return;const o=i.delete(Ra);a&&o.then(()=>a()).catch(a)},u.f7=mc,u.f8=Et,u.f9=hc,u.fa=Tl,u.fb=Al,u.fc=Ml,u.fd=Yo,u.fe=vt,u.ff="hd_road_elevation",u.fg=Ni,u.fh=Zt,u.fi=Rh,u.fj=k0,u.fk=qh,u.fl=function(a,i,o,c,h,m,g,x=1,w,T,I){a.createArrays(),a.tilePixelRatio=ht/(512*a.overscaling),a.compareText={},a.iconsNeedLinear=!1;const A=a.layers[0].layout,M=a.layers[0]._unevaluatedLayout._values,k={};k.scaleFactor=x,k.textSizeScaleRange=A.get("text-size-scale-range"),k.iconSizeScaleRange=A.get("icon-size-scale-range");const[L,V]=k.textSizeScaleRange,[j,W]=k.iconSizeScaleRange;k.textScaleFactor=se(k.scaleFactor,L,V),k.iconScaleFactor=se(k.scaleFactor,j,W);const Q=M["text-size"],K=M["icon-size"];if("composite"===a.textSizeData.kind){const{minZoom:Ee,maxZoom:Ve}=a.textSizeData;k.compositeTextSizes=[Q.possiblyEvaluate(new Tn(Ee,{worldview:I}),m),Q.possiblyEvaluate(new Tn(Ve,{worldview:I}),m)]}if("composite"===a.iconSizeData.kind){const{minZoom:Ee,maxZoom:Ve}=a.iconSizeData;k.compositeIconSizes=[K.possiblyEvaluate(new Tn(Ee,{worldview:I}),m),K.possiblyEvaluate(new Tn(Ve,{worldview:I}),m)]}k.layoutTextSize=Q.possiblyEvaluate(new Tn(g+1,{worldview:I}),m),k.layoutIconSize=K.possiblyEvaluate(new Tn(g+1,{worldview:I}),m),k.textMaxSize=Q.possiblyEvaluate(new Tn(18,{worldview:I}),m);const te=A.get("symbol-placement"),me="map"===A.get("text-rotation-alignment")&&"point"!==te,he=A.get("text-size");let fe=!1;const xe=[];for(const Ee of a.features){const Ve=A.get("text-font").evaluate(Ee,{},m).join(","),Ce=he.evaluate(Ee,{},m)*k.textScaleFactor,Ue=k.layoutTextSize.evaluate(Ee,{},m)*k.textScaleFactor,ot=k.layoutIconSize.evaluate(Ee,{},m)*k.iconScaleFactor,$e={horizontal:{},vertical:void 0},Ke=Ee.text;let nt,ze=[0,0];if(Ke){const xt=Ke.toString(),zt=A.get("text-letter-spacing").evaluate(Ee,{},m)*Pr,qt=A.get("text-line-height").evaluate(Ee,{},m)*Pr,rn=Iv(xt)?zt:0,Kt=A.get("text-anchor").evaluate(Ee,{},m),vn=A.get("text-variable-anchor");if(!vn){const Le=A.get("text-radial-offset").evaluate(Ee,{},m);if(Le)ze=z0(Kt,[Le*Pr,by]);else{const lt=A.get("text-offset").evaluate(Ee,{},m);ze=[lt[0]*Pr,lt[1]*Pr]}}let dn=me?"center":A.get("text-justify").evaluate(Ee,{},m);const ii="point"===te,ie=ii?A.get("text-max-width").evaluate(Ee,{},m)*Pr:1/0,re=Le=>{a.allowVerticalPlacement&&Lf(xt)&&($e.vertical=uy(Ke,i,o,h,Ve,ie,qt,Kt,Le,rn,ze,Ps.vertical,!0,Ue,Ce,w))};if(!me&&vn){const Le="auto"===dn?vn.map(ut=>Ey(ut)):[dn];let lt=!1;for(let ut=0;ut<Le.length;ut++){const pt=Le[ut];if(!$e.horizontal[pt])if(lt)$e.horizontal[pt]=$e.horizontal[0];else{const Ct=uy(Ke,i,o,h,Ve,ie,qt,"center",pt,rn,ze,Ps.horizontal,!1,Ue,Ce,w);Ct&&($e.horizontal[pt]=Ct,lt=1===Ct.positionedLines.length)}}re("left")}else{if("auto"===dn&&(dn=Ey(Kt)),ii||A.get("text-writing-mode").indexOf("horizontal")>=0||!Lf(xt)){const Le=uy(Ke,i,o,h,Ve,ie,qt,Kt,dn,rn,ze,Ps.horizontal,!1,Ue,Ce,w);Le&&($e.horizontal[dn]=Le)}re(ii?"left":dn)}}let Qe,Ae,Be,at,et,Ft,St=!1;const Xe=A.get("icon-text-fit").evaluate(Ee,{},m);if(Ee.icon&&Ee.icon.hasPrimary()){const xt=wy(Ee.icon,a.iconSizeData,M["icon-size"],m,a.zoom,Ee,w,k.iconScaleFactor,I);Qe=xt.iconPrimary,Be=xt.iconSecondary;const zt=Qe.toString();if(Ae=c.get(zt),Ae&&(et=A.get("icon-offset").evaluate(Ee,{},m),Ft=A.get("icon-anchor").evaluate(Ee,{},m),nt=cg(h.get(zt),Be?h.get(Be.toString()):void 0,et,Ft),St=Ae.sdf,void 0===a.sdfIcons?a.sdfIcons=Ae.sdf:a.sdfIcons!==Ae.sdf&&yn("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ae.pixelRatio!==a.pixelRatio||0!==A.get("icon-rotate").constantOr(1))&&(a.iconsNeedLinear=!0)),Be){const qt=Be.toString();at=c.get(qt)}}fe=fe||!(!Ee.icon||!Ee.icon.hasSecondary());const tt=U0($e.horizontal)||$e.vertical;a.iconsInText||(a.iconsInText=!!tt&&tt.iconsInText);const It=Ue*k.textScaleFactor/Pr,{defaultShapedIcon:yt,verticallyShapedIcon:ft}=j0(a,nt,A,Ee,m,$e,It,et,Xe);"none"!==Xe&&nt&&(fy(nt)||py(nt))&&(dg(0,Ae,Qe,nt,yt,Xe,T,c,h),dg(0,at,Be,nt,yt,Xe,T,c,h),ft&&(dg(0,Ae,Qe,nt,ft,Xe,T,c,h),dg(0,at,Be,nt,ft,Xe,T,c,h))),nt=yt,xe.push({feature:Ee,shapedTextOrientations:$e,shapedText:tt,shapedIcon:nt,iconPrimary:Qe,iconSecondary:Be,iconOffset:et,iconAnchor:Ft,verticallyShapedIcon:ft,layoutTextSize:Ue,layoutIconSize:ot,textOffset:ze,isSDFIcon:St,iconTextFit:Xe})}return{featureData:xe,sizes:k,hasAnySecondaryIcon:fe,textAlongLine:me,symbolPlacement:te}},u.fm=pw,u.fn=function(a,i,o,c,h,m,g,x,w,T){const{featureData:I,hasAnySecondaryIcon:A,sizes:M,textAlongLine:k,symbolPlacement:L}=i;for(const V of I){const{shapedIcon:j,verticallyShapedIcon:W,feature:Q,shapedTextOrientations:K,shapedText:te,layoutTextSize:me,textOffset:he,isSDFIcon:fe,iconPrimary:xe,iconSecondary:Ee,iconTextFit:Ve,iconOffset:Ce}=V;B0(j,T.iconPositions,xe,Ee),B0(W,T.iconPositions,xe,Ee),yw(K,T.iconPositions),OC(xe,Ee,T.iconPositions),(te||j)&&gu(a,Q,K,j,W,w,M,me,0,he,fe,c,h,g,x,A,Ve,Ce,k,L)}o&&a.generateCollisionDebugBuffers(m,a.collisionBoxArray,M.textScaleFactor)},u.fo=Mt,u.fp=Ag,u.fq=Re,u.fr=function(a){let i=0;if(new Uint32Array(a,0,1)[0]!==UE){const o=new Uint32Array(a,0,7),[,,c,h,m,g]=o;i=o.byteLength+h+m+g+m,(c!==a.byteLength||i>=a.byteLength)&&yn("Invalid b3dm header information.")}return Vh(a,i)},u.fs=function(a,i){const o=Xo(a);for(const c of o){for(const h of c.meshes)qE(h);c.lights&&(c.lightMeshIndex=c.meshes.length,c.meshes.push(Hh(c.lights,i)))}return o},u.ft=Ly,u.fu=ci,u.fv=X_,u.fw=Gs,u.fx=us,u.fy=function(a){Yi(),ur?.then(i=>{i.keys().then(o=>{for(let c=0;c<o.length-a;c++)i.delete(o[c]).catch(h=>yn(h.message))}).catch(o=>yn(o.message))}).catch(i=>yn(i.message))},u.g=function(a,i){return Lu(Ie(a,{method:"GET"}),i)},u.h=Ie,u.i=function(a){return so.API_STYLE_REGEX.test(a)&&!mf(a)},u.j=function(a){return 0===a.indexOf("mapbox:")},u.k=Hl,u.l=Hd,u.m=function(a){return decodeURIComponent(atob(a).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""))},u.n=function(a,i){return Lu(Ie(a,{type:"json"}),i)},u.o=fa,u.p=function(a,i){return Lu(Ie(a,{method:"POST"}),i)},u.q=Zs,u.r=$r,u.s=function(a){try{const i=self[a];return i.setItem("_mapbox_test_",1),i.removeItem("_mapbox_test_"),!0}catch{return!1}},u.t=Dc,u.u=function(){return function a(i){return i?(i^Math.random()*(16>>i/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,a)}()},u.v=function(a){return!!a&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(a)},u.w=yn,u.x=function(){return ip||(ip=new mc),ip},u.y=Zy,u.z=_n}),Xg(0,function(u){function tr(Pe){const Z=Pe?Pe.url.toString():void 0;return Z?performance.getEntriesByName(Z):[]}function ji(Pe){if("number"==typeof Pe||"boolean"==typeof Pe||"string"==typeof Pe||null==Pe)return JSON.stringify(Pe);if(Array.isArray(Pe)){let X="[";for(const oe of Pe)X+=`${ji(oe)},`;return`${X}]`}let Z="{";for(const X of Object.keys(Pe).sort())Z+=`${X}:${ji(Pe[X])},`;return`${Z}}`}function Ca(Pe){let Z="";for(const X of u.bu)Z+=`/${ji(Pe[X])}`;return Z}class kd{constructor(Z){this.keyCache={},this._layers={},this._layerConfigs={},Z&&this.replace(Z)}replace(Z,X){this._layerConfigs={},this._layers={},this.update(Z,[],X)}update(Z,X,oe){this._options=oe;for(const se of Z)this._layerConfigs[se.id]=se,(this._layers[se.id]=u.dn(se,this.scope,null,this._options)).compileFilter(oe),this.keyCache[se.id]&&delete this.keyCache[se.id];for(const se of X)delete this.keyCache[se],delete this._layerConfigs[se],delete this._layers[se];this.familiesBySource={};const ge=function(se,be){const ke={};for(let Ie=0;Ie<se.length;Ie++){const st=se[Ie];let qe=be&&be[st.id];qe||("symbol"===st.type?qe=st.id:(qe=Ca(st),"line"===st.type&&st.paint&&function $t(Zt){return"string"==typeof Zt&&"line-progress"===Zt||(Array.isArray(Zt)?Zt.some($t):!(!Zt||"object"!=typeof Zt)&&Object.values(Zt).some($t))}(st.paint["line-width"])&&(qe+=`/${ji(st.paint["line-width"])}`))),be&&(be[st.id]=qe);let Lt=ke[qe];Lt||(Lt=ke[qe]=[]),Lt.push(st)}const Te=[];for(const Ie in ke)Te.push(ke[Ie]);return Te}(Object.values(this._layerConfigs),this.keyCache);for(const se of ge){const be=se.map(Lt=>this._layers[Lt.id]),ke=be[0];if("none"===ke.visibility)continue;const Te=ke.source||"";let Ie=this.familiesBySource[Te];Ie||(Ie=this.familiesBySource[Te]={});const st=ke.sourceLayer||"_geojsonTileLayer";let qe=Ie[st];qe||(qe=Ie[st]=[]),qe.push(be)}}}const Fs=1*u.fa;class ks{constructor(Z){const X={},oe=[];for(const ke in Z){const Te=Z[ke],Ie=X[ke]={};for(const st in Te.glyphs){const qe=Te.glyphs[+st];if(!qe||0===qe.bitmap.width||0===qe.bitmap.height)continue;const Lt=qe.metrics.localGlyph?Fs:1,$t={x:0,y:0,w:qe.bitmap.width+2*Lt,h:qe.bitmap.height+2*Lt};oe.push($t),Ie[st]=$t}}const{w:ge,h:se}=u.H(oe),be=new u.f9({width:ge||1,height:se||1});for(const ke in Z){const Te=Z[ke];for(const Ie in Te.glyphs){const st=Te.glyphs[+Ie];if(!st||0===st.bitmap.width||0===st.bitmap.height)continue;const qe=X[ke][Ie],Lt=st.metrics.localGlyph?Fs:1;u.f9.copy(st.bitmap,be,{x:0,y:0},{x:qe.x+Lt,y:qe.y+Lt},st.bitmap)}}this.image=be,this.positions=X}}u.f8(ks,"GlyphAtlas");class Nl{constructor(Z){this.tileID=new u.aM(Z.tileID.overscaledZ,Z.tileID.wrap,Z.tileID.canonical.z,Z.tileID.canonical.x,Z.tileID.canonical.y),this.tileZoom=Z.tileZoom,this.uid=Z.uid,this.zoom=Z.zoom,this.lut=Z.lut,this.canonical=Z.tileID.canonical,this.pixelRatio=Z.pixelRatio,this.tileSize=Z.tileSize,this.source=Z.source,this.scope=Z.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=Z.showCollisionBoxes,this.collectResourceTiming=!!Z.request&&Z.request.collectResourceTiming,this.promoteId=Z.promoteId,this.isSymbolTile=Z.isSymbolTile,this.tileTransform=u.aW(Z.tileID.canonical,Z.projection),this.projection=Z.projection,this.worldview=Z.worldview,this.localizableLayerIds=Z.localizableLayerIds,this.brightness=Z.brightness,this.extraShadowCaster=!!Z.extraShadowCaster,this.tessellationStep=Z.tessellationStep,this.scaleFactor=Z.scaleFactor,this.worldview=Z.worldview}parse(Z,X,oe,ge,se,be){this.status="parsing",this.data=Z,this.collisionBoxArray=new u.b0;const ke=new u.fb(Object.keys(Z.layers).sort()),Te=new u.fc(this.tileID,this.promoteId);Te.bucketLayerIDs=[];const Ie={},st=new u.fd(256,256),qe={featureIndex:Te,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:st,availableImages:oe,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Lt=[],$t=X.familiesBySource[this.source];for(const bn in $t){const pn=Z.layers[bn];if(!pn)continue;let cn=!1,mi=!1,yn=!1;for(const ci of $t[bn])"symbol"===ci[0].type?cn=!0:mi=!0,ci[0].is3D()&&"model"!==ci[0].type&&(yn=!0);if(this.extraShadowCaster&&!yn||!0===this.isSymbolTile&&!cn||!1===this.isSymbolTile&&!mi)continue;1===pn.version&&u.w(`Vector tile source "${this.source}" layer "${bn}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const ir=ke.encode(bn),Cr=[];let Lr=!1;for(let ci=0,Vn=0;ci<pn.length;ci++){const $i=pn.feature(ci),Vi=Te.getId($i,bn);if(this.localizableLayerIds&&this.localizableLayerIds.has(bn)){const Si=$i.properties?$i.properties.worldview:null;if(this.worldview&&"string"==typeof Si)if("all"===Si)$i.properties.$localized=!0;else{if(!Si.split(",").includes(this.worldview))continue;$i.properties.$localized=!0,$i.properties.worldview=this.worldview}}!Lr&&$i.properties&&$i.properties.hasOwnProperty(u.fe)&&(Lr=!0),Cr.push({feature:$i,id:Vi,index:Vn,sourceLayerIndex:ir}),Vn++}Lr&&!qe.elevationFeatures&&Z.layers.hasOwnProperty(u.ff)&&(qe.elevationFeatures=u.fg.parseFrom(Z.layers[u.ff],this.canonical));for(const ci of $t[bn]){const Vn=ci[0];if(this.extraShadowCaster&&(!Vn.is3D()||"model"===Vn.type)||void 0!==this.isSymbolTile&&"symbol"===Vn.type!==this.isSymbolTile||Vn.minzoom&&this.zoom<Math.floor(Vn.minzoom)||Vn.maxzoom&&this.zoom>=Vn.maxzoom||"none"===Vn.visibility)continue;fn(ci,this.zoom,qe.brightness,oe,this.worldview);const $i=Ie[Vn.id]=Vn.createBucket({index:Te.bucketLayerIDs.length,layers:ci,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:ir,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:ge,worldview:this.worldview});Te.bucketLayerIDs.push(ci.map(Si=>u.C(Si.id,Si.scope)));let Vi=$i.prepare?$i.prepare():null;null!=Vi?(Vi=Vi.then(()=>$i.populate(Cr,qe,this.tileID.canonical,this.tileTransform)),Lt.push(Vi)):$i.populate(Cr,qe,this.tileID.canonical,this.tileTransform)}}const Zt=()=>{let bn,pn,cn,mi,yn,ir;st.trim();const Cr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Lr=()=>{if(bn)return this.status="done",be(bn);if(this.extraShadowCaster)this.status="done",be(null,{buckets:Object.values(Ie).filter(Vn=>!Vn.isEmpty()),featureIndex:Te,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:qe.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(pn&&cn&&mi){const Vn=new ks(pn),$i=new Map;for(const[Xr,Ho]of cn.entries()){const{imagePosition:_o}=u.fj(Xr,Ho,u.fk);$i.set(Xr,_o)}const Vi={};for(const Xr in Ie){const Ho=Ie[Xr];Ho instanceof u.b1&&(fn(Ho.layers,this.zoom,qe.brightness,oe,this.worldview),Vi[Xr]=u.fl(Ho,pn,Vn.positions,cn,$i,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,yn,this.worldview))}const Si={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(se,cn,yn,()=>{Si.iconsPending=!1,ci(Vi,Vn,Si)}),this.rasterizeIfNeeded(se,mi,ir,()=>{Si.patternsPending=!1,ci(Vi,Vn,Si)})}},ci=(Vn,$i,Vi,Si)=>{if(Vi.iconsPending||Vi.patternsPending)return;const Xr=new u.fm(cn,mi,this.lut);for(const Ho in Ie){const _o=Ie[Ho];if(Ho in Vn)u.fn(_o,Vn[Ho],this.showCollisionBoxes,oe,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,cn,Xr);else if(_o.hasPattern&&(_o instanceof u.b7||_o instanceof u.b8||_o instanceof u.e4)){fn(_o.layers,this.zoom,qe.brightness,oe,this.worldview);const jd=Object.fromEntries(Xr.patternPositions);_o.addFeatures(qe,this.tileID.canonical,jd,oe,this.tileTransform,this.brightness)}}this.status="done",be(null,{buckets:Object.values(Ie).filter(Ho=>!Ho.isEmpty()),featureIndex:Te,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:$i.image,lineAtlas:st,imageAtlas:Xr,brightness:qe.brightness})};if(!this.extraShadowCaster){const Vn=u.fh(qe.glyphDependencies,Si=>Object.keys(Si).map(Number));Object.keys(Vn).length?se.send("getGlyphs",{uid:this.uid,stacks:Vn},(Si,Xr)=>{bn||(bn=Si,pn=Xr,Lr())},void 0,!1,Cr):pn={};const $i=Array.from(qe.iconDependencies.keys()).map(Si=>u.I.parse(Si));$i.length?se.send("getImages",{images:$i,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Si,Xr)=>{bn||(bn=Si,cn=new Map,yn=this.updateImageMapAndGetImageTaskQueue(cn,Xr,qe.iconDependencies),Lr())},void 0,!1,Cr):(cn=new Map,yn=new Map);const Vi=Array.from(qe.patternDependencies.keys()).map(Si=>u.I.parse(Si));Vi.length?se.send("getImages",{images:Vi,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Si,Xr)=>{bn||(bn=Si,mi=new Map,ir=this.updateImageMapAndGetImageTaskQueue(mi,Xr,qe.patternDependencies),Lr())},void 0,!1,Cr):(mi=new Map,ir=new Map)}if(qe.elevationFeatures&&qe.elevationFeatures.length>0){const Vn=[];for(const Vi of Object.values(Ie))if(Vi instanceof u.b8){const Si=Vi.getUnevaluatedPortalGraph();Si&&Vn.push(Si)}const $i=u.fi.evaluate(Vn);for(const Vi of Object.values(Ie))if(Vi instanceof u.b8){const Si=Z.layers[ke.decode(Vi.sourceLayerIndex)];Vi.setEvaluatedPortalGraph($i,Si,this.tileID.canonical,qe.availableImages,qe.brightness)}}Lr()};Lt.length>0?Promise.allSettled(Lt).then(Zt).catch(be):Zt()}rasterizeIfNeeded(Z,X,oe,ge){Array.from(X.values()).some(se=>se.usvg)?this.rasterize(Z,X,oe,ge):ge()}updateImageMapAndGetImageTaskQueue(Z,X,oe){const ge=new Map;for(const se of X.keys()){const be=oe.get(se)||[];for(const ke of be){const Te=ke.toString(),Ie=X.get(ke.id.toString());Ie.usvg?ge.has(Te)||(ge.set(Te,ke),Z.set(Te,Object.assign({},Ie))):Z.set(Te,Ie)}}return ge}rasterize(Z,X,oe,ge){this.rasterizeTask=Z.send("rasterizeImages",{scope:this.scope,tasks:oe},(se,be)=>{if(!se)for(const[ke,Te]of be.entries()){const Ie=Object.assign(X.get(ke),{data:Te});X.set(ke,Ie)}ge()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function fn(Pe,Z,X,oe,ge){const se=new u.aa(Z,{brightness:X,worldview:ge});for(const be of Pe)be.recalculate(se,oe)}class es extends u.E{constructor(Z,X,oe,ge,se,be,ke){super(),this.actor=Z,this.layerIndex=X,this.availableImages=oe,this.availableModels=ge,this.loadVectorData=be||u.aJ,this.loading={},this.loaded={},this.deduped=new u.aI(Z.scheduler),this.isSpriteLoaded=se,this.scheduler=Z.scheduler,this.brightness=ke}loadTile(Z,X){const oe=Z.uid,ge=Z&&Z.request,se=ge&&ge.collectResourceTiming,be=this.loading[oe]=new Nl(Z);be.abort=this.loadVectorData(Z,(ke,Te)=>{const Ie=!this.loading[oe];if(delete this.loading[oe],be.cancelRasterize(),Ie||ke||!Te)return be.status="done",Ie||(this.loaded[oe]=be),X(ke);const st=Te.rawData,qe={};Te.expires&&(qe.expires=Te.expires),Te.cacheControl&&(qe.cacheControl=Te.cacheControl),be.vectorTile=Te.vectorTile||new u.fo(new u.bq(st));const Lt=()=>{be.parse(be.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,($t,Zt)=>{if($t||!Zt)return X($t);const bn={};if(se){const pn=tr(ge);pn.length>0&&(bn.resourceTiming=JSON.parse(JSON.stringify(pn)))}X(null,u.h({rawTileData:st.slice(0)},Zt,qe,bn))})};this.isSpriteLoaded?Lt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Lt,{type:"parseTile",isSymbolTile:Z.isSymbolTile,zoom:Z.tileZoom}):Lt()}),this.loaded=this.loaded||{},this.loaded[oe]=be})}reloadTile(Z,X){const oe=this.loaded,ge=Z.uid;if(oe&&oe[ge]){const se=oe[ge];se.scaleFactor=Z.scaleFactor,se.showCollisionBoxes=Z.showCollisionBoxes,se.projection=Z.projection,se.brightness=Z.brightness,se.tileTransform=u.aW(Z.tileID.canonical,Z.projection),se.extraShadowCaster=Z.extraShadowCaster,se.lut=Z.lut,se.worldview=Z.worldview;const be=(ke,Te)=>{const Ie=se.reloadCallback;Ie&&(delete se.reloadCallback,se.parse(se.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ie)),X(ke,Te)};"parsing"===se.status?se.reloadCallback=be:"done"===se.status&&(se.vectorTile?se.parse(se.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,be):be())}else X(null,void 0)}abortTile(Z,X){const oe=Z.uid,ge=this.loading[oe];ge&&(ge.abort&&ge.abort(),delete this.loading[oe]),X()}removeTile(Z,X){const oe=this.loaded,ge=Z.uid;oe&&oe[ge]&&delete oe[ge],X()}}class Ui{loadTile(Z,X){const{uid:oe,encoding:ge,rawImageData:se,padding:be}=Z,ke=ImageBitmap&&se instanceof ImageBitmap?this.getImageData(se,be):se;X(null,new u.fp(oe,ke,ge,be<1))}reloadTile(Z,X){X(null,null)}abortTile(Z,X){X()}removeTile(Z,X){X()}getImageData(Z,X){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(Z.width,Z.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=Z.width,this.offscreenCanvas.height=Z.height,this.offscreenCanvasContext.drawImage(Z,0,0,Z.width,Z.height);const oe=this.offscreenCanvasContext.getImageData(-X,-X,Z.width+2*X,Z.height+2*X);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),oe}}u.bp.setPbf(u.bq);class jo{constructor(Z){this._mrt=new u.bp(Z.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=Z.uid,this.tileID=Z.tileID,this.source=Z.source}parse(Z,X){const oe=this._mrt;this.status="parsing",this._entireBuffer=Z;try{oe.parseHeader(Z),this._isHeaderLoaded=!0;const ge=[];for(const se in oe.layers){const be=oe.getLayer(se),ke=be.getDataRange(be.getBandList()),Te=oe.createDecodingTask(ke),Ie=Z.slice(ke.firstByte,ke.lastByte+1),st=u.bp.performDecoding(Ie,Te).then(qe=>Te.complete(null,qe)).catch(qe=>Te.complete(qe,null));ge.push(st)}Promise.allSettled(ge).then(()=>X(null,oe)).catch(se=>X(se))}catch(ge){X(ge)}}}class ro{constructor(Z){this.actor=Z,this.loading={},this.loaded={}}loadTile(Z,X){const oe=Z.uid,ge=Z.request,se=this.loading[oe]=new jo(Z),{cancel:be}=u.br(ge,(ke,Te,Ie,st)=>{const qe=!this.loading[oe];if(delete this.loading[oe],qe||ke||!Te)return se.status="done",qe||(this.loaded[oe]=se),X(ke);se.parse(Te,(Lt,$t)=>{if(Lt||!$t)return X(Lt);X(null,$t,Ie,st)}),this.loaded[oe]=se});se.abort=be}reloadTile(Z,X){X(null,void 0)}abortTile(Z,X){const oe=Z.uid,ge=this.loading[oe];ge&&(ge.abort&&ge.abort(),delete this.loading[oe]),X()}removeTile(Z,X){const oe=Z.uid;this.loaded[oe]&&delete this.loaded[oe],X()}decodeRasterArray(Z,X){u.bp.performDecoding(Z.buffer,Z.task).then(oe=>X(null,oe)).catch(oe=>X(oe))}}const ys=u.fq.prototype.toGeoJSON;class Ws{constructor(Z){this._feature=Z,this.extent=u.aj,this.type=Z.type,this.properties=Z.tags,"id"in Z&&!isNaN(Z.id)&&(this.id=parseInt(Z.id,10))}loadGeometry(){if(1===this._feature.type){const Z=[];for(const X of this._feature.geometry)Z.push([new u.P(X[0],X[1])]);return Z}{const Z=[];for(const X of this._feature.geometry){const oe=[];for(const ge of X)oe.push(new u.P(ge[0],ge[1]));Z.push(oe)}return Z}}toGeoJSON(Z,X,oe){return ys.call(this,Z,X,oe)}}class zl{constructor(Z,X){this.name=Z,this.extent=u.aj,this.length=X.length,this._jsonFeatures=X}feature(Z){return new Ws(this._jsonFeatures[Z])}}class Bl{constructor(Z){this.layers={},this.extent=u.aj;for(const X of Object.keys(Z))this.layers[X]=new zl(X,Z[X])}}const da=64/4096,Ia=128;class df{constructor(){this.features=new Map}clear(){this.features.clear()}load(Z=[],X){for(const oe of Z){const ge=oe.id;if(null==ge)continue;let se=this.features.get(ge);se&&this.updateCache(se,X),oe.geometry?(se=qa(oe),this.updateCache(se,X),this.features.set(ge,se)):this.features.delete(ge),this.updateCache(se,X)}}updateCache(Z,X){for(const{canonical:oe,uid:ge}of Object.values(X)){const{z:se,x:be,y:ke}=oe;Un(Z,Math.pow(2,se),be,ke)&&delete X[ge]}}getTile(Z,X,oe){const ge=Math.pow(2,Z),se=[];for(const be of this.features.values())Un(be,ge,X,oe)&&se.push(Fi(be,ge,X,oe));return{features:se}}getFeatures(){return[...this.features.values()]}}function Un({minX:Pe,minY:Z,maxX:X,maxY:oe},ge,se,be){return Pe<(se+1+da)/ge&&Z<(be+1+da)/ge&&X>(se-da)/ge&&oe>(be-da)/ge}function qa(Pe){const{id:Z,geometry:X,properties:oe}=Pe;if(!X)return;if("GeometryCollection"===X.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:ge,coordinates:se}=X,be={id:Z,type:1,geometry:[],tags:oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},ke=be.geometry;if("Point"===ge)go(se,ke,be);else if("MultiPoint"===ge)for(const Te of se)go(Te,ke,be);else if("LineString"===ge)be.type=2,mr(se,ke,be);else if("MultiLineString"===ge)be.type=2,gr(se,ke,be);else if("Polygon"===ge)be.type=3,gr(se,ke,be,!0);else{if("MultiPolygon"!==ge)throw new Error("Input data is not a valid GeoJSON object.");be.type=3;for(const Te of se)gr(Te,ke,be,!0)}return be}function go([Pe,Z],X,oe){const ge=u.aD(Pe);let se=u.aH(Z);se=se<0?0:se>1?1:se,X.push(ge,se),oe.minX=Math.min(oe.minX,ge),oe.minY=Math.min(oe.minY,se),oe.maxX=Math.max(oe.maxX,ge),oe.maxY=Math.max(oe.maxY,se)}function mr(Pe,Z,X,oe=!1,ge=!1){const se=[];for(const be of Pe)go(be,se,X);Z.push(se),oe&&function(be,ke){let Te=0;for(let Ie=0,st=be.length,qe=st-2;Ie<st;qe=Ie,Ie+=2)Te+=(be[Ie]-be[qe])*(be[Ie+1]+be[qe+1]);if(Te>0===ke)for(let Ie=0,st=be.length;Ie<st/2;Ie+=2){const qe=be[Ie],Lt=be[Ie+1];be[Ie]=be[st-2-Ie],be[Ie+1]=be[st-1-Ie],be[st-2-Ie]=qe,be[st-1-Ie]=Lt}}(se,ge)}function gr(Pe,Z,X,oe=!1){for(let ge=0;ge<Pe.length;ge++)mr(Pe[ge],Z,X,oe,0===ge)}function Fi(Pe,Z,X,oe){const{id:ge,type:se,geometry:be,tags:ke}=Pe,Te=[];if(1===se)!function(Ie,st,qe,Lt,$t){for(let Zt=0;Zt<Ie.length;Zt+=2){const bn=Math.round(u.aj*(Ie[Zt+0]*st-qe)),pn=Math.round(u.aj*(Ie[Zt+1]*st-Lt));$t.push([bn,pn])}}(be,Z,X,oe,Te);else for(const Ie of be)oo(Ie,Z,X,oe,Te);return{id:ge,type:se,geometry:Te,tags:ke}}function oo(Pe,Z,X,oe,ge){const se=-Ia,be=u.aj+Ia;let ke;for(let Te=0;Te<Pe.length-2;Te+=2){let Ie=Math.round(u.aj*(Pe[Te+0]*Z-X)),st=Math.round(u.aj*(Pe[Te+1]*Z-oe)),qe=Math.round(u.aj*(Pe[Te+2]*Z-X)),Lt=Math.round(u.aj*(Pe[Te+3]*Z-oe));const $t=qe-Ie,Zt=Lt-st;Ie<se&&qe<se||(Ie<se?(st+=Math.round(Zt*((se-Ie)/$t)),Ie=se):qe<se&&(Lt=st+Math.round(Zt*((se-Ie)/$t)),qe=se),st<se&&Lt<se||(st<se?(Ie+=Math.round($t*((se-st)/Zt)),st=se):Lt<se&&(qe=Ie+Math.round($t*((se-st)/Zt)),Lt=se),Ie>=be&&qe>=be||(Ie>=be?(st+=Math.round(Zt*((be-Ie)/$t)),Ie=be):qe>=be&&(Lt=st+Math.round(Zt*((be-Ie)/$t)),qe=be),st>=be&&Lt>=be||(st>=be?(Ie+=Math.round($t*((be-st)/Zt)),st=be):Lt>=be&&(qe=Ie+Math.round($t*((be-st)/Zt)),Lt=be),ke&&Ie===ke[ke.length-1][0]&&st===ke[ke.length-1][1]||(ke=[[Ie,st]],ge.push(ke)),ke.push([qe,Lt])))))}}function hf({name:Pe,features:Z},X){X.writeStringField(1,Pe),X.writeVarintField(5,u.aj);const oe=new Map,ge=new Map,se={keys:oe,values:ge,feature:null};for(const be of Z)se.feature=be,X.writeMessage(2,Aa,se);for(const be of oe.keys())X.writeStringField(3,be);for(const be of ge.keys())X.writeMessage(4,ff,be)}function Aa(Pe,Z){const X=Pe.feature;void 0===X.id||isNaN(+X.id)||Z.writeVarintField(1,+X.id),X.tags&&Z.writeMessage(2,Hi,Pe),Z.writeVarintField(3,X.type),Z.writeMessage(4,Cu,X)}function Hi({keys:Pe,values:Z,feature:X},oe){for(const ge of Object.keys(X.tags)){let se=X.tags[ge];if(null===se)continue;let be=Pe.get(ge);void 0===be&&(be=Pe.size,Pe.set(ge,be)),oe.writeVarint(be);const ke=typeof se;"string"!==ke&&"boolean"!==ke&&"number"!==ke&&(se=JSON.stringify(se));let Te=Z.get(se);void 0===Te&&(Te=Z.size,Z.set(se,Te)),oe.writeVarint(Te)}}function ki(Pe,Z){return(Z<<3)+(7&Pe)}function Uo(Pe){return Pe<<1^Pe>>31}function Cu(Pe,Z){const{geometry:X,type:oe}=Pe;let ge=0,se=0;if(1===oe){Z.writeVarint(ki(1,X.length));for(const be of X){const ke=be[0]-ge,Te=be[1]-se;Z.writeVarint(Uo(ke)),Z.writeVarint(Uo(Te)),ge+=ke,se+=Te}}else for(const be of X){Z.writeVarint(ki(1,1));const ke=be.length-(3===oe?1:0);for(let Te=0;Te<ke;Te++){1===Te&&Z.writeVarint(ki(2,ke-1));const Ie=be[Te][0]-ge,st=be[Te][1]-se;Z.writeVarint(Uo(Ie)),Z.writeVarint(Uo(st)),ge+=Ie,se+=st}3===oe&&Z.writeVarint(ki(7,1))}}function ff(Pe,Z){const X=typeof Pe;"string"===X?Z.writeStringField(1,Pe):"boolean"===X?Z.writeBooleanField(7,Pe):"number"===X&&(Pe%1!=0?Z.writeDoubleField(3,Pe):Pe<0?Z.writeSVarintField(6,Pe):Z.writeVarintField(5,Pe))}const Gi={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Pe=>Pe},Mi=Math.fround||(ar=new Float32Array(1),Pe=>(ar[0]=+Pe,ar[0]));var ar;const vi=3,nr=5,lr=6;class Ls{constructor(Z){this.options=Object.assign(Object.create(Gi),Z),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(Z){const{log:X,minZoom:oe,maxZoom:ge}=this.options;X&&console.time("total time");const se=`prepare ${Z.length} points`;X&&console.time(se),this.points=Z;const be=[];for(let Te=0;Te<Z.length;Te++){const Ie=Z[Te];if(!Ie.geometry)continue;const[st,qe]=Ie.geometry.coordinates,Lt=Mi(vs(st)),$t=Mi(cr(qe));be.push(Lt,$t,1/0,Te,-1,1),this.options.reduce&&be.push(0)}let ke=this.trees[ge+1]=this._createTree(be);X&&console.timeEnd(se);for(let Te=ge;Te>=oe;Te--){const Ie=+Date.now();ke=this.trees[Te]=this._createTree(this._cluster(ke,Te)),X&&console.log("z%d: %d clusters in %dms",Te,ke.numItems,+Date.now()-Ie)}return X&&console.timeEnd("total time"),this}getClusters(Z,X){let oe=((Z[0]+180)%360+360)%360-180;const ge=Math.max(-90,Math.min(90,Z[1]));let se=180===Z[2]?180:((Z[2]+180)%360+360)%360-180;const be=Math.max(-90,Math.min(90,Z[3]));if(Z[2]-Z[0]>=360)oe=-180,se=180;else if(oe>se){const qe=this.getClusters([oe,ge,180,be],X),Lt=this.getClusters([-180,ge,se,be],X);return qe.concat(Lt)}const ke=this.trees[this._limitZoom(X)],Te=ke.range(vs(oe),cr(be),vs(se),cr(ge)),Ie=ke.data,st=[];for(const qe of Te){const Lt=this.stride*qe;st.push(Ie[Lt+nr]>1?Ma(Ie,Lt,this.clusterProps):this.points[Ie[Lt+vi]])}return st}getChildren(Z){const X=this._getOriginId(Z),oe=this._getOriginZoom(Z),ge="No cluster with the specified id.",se=this.trees[oe];if(!se)throw new Error(ge);const be=se.data;if(X*this.stride>=be.length)throw new Error(ge);const ke=this.options.radius/(this.options.extent*Math.pow(2,oe-1)),Te=se.within(be[X*this.stride],be[X*this.stride+1],ke),Ie=[];for(const st of Te){const qe=st*this.stride;be[qe+4]===Z&&Ie.push(be[qe+nr]>1?Ma(be,qe,this.clusterProps):this.points[be[qe+vi]])}if(0===Ie.length)throw new Error(ge);return Ie}getLeaves(Z,X,oe){const ge=[];return this._appendLeaves(ge,Z,X=X||10,oe=oe||0,0),ge}getTile(Z,X,oe){const ge=this.trees[this._limitZoom(Z)],se=Math.pow(2,Z),{extent:be,radius:ke}=this.options,Te=ke/be,Ie=(oe-Te)/se,st=(oe+1+Te)/se,qe={features:[]};return this._addTileFeatures(ge.range((X-Te)/se,Ie,(X+1+Te)/se,st),ge.data,X,oe,se,qe),0===X&&this._addTileFeatures(ge.range(1-Te/se,Ie,1,st),ge.data,se,oe,se,qe),X===se-1&&this._addTileFeatures(ge.range(0,Ie,Te/se,st),ge.data,-1,oe,se,qe),qe.features.length?qe:null}getClusterExpansionZoom(Z){let X=this._getOriginZoom(Z)-1;for(;X<=this.options.maxZoom;){const oe=this.getChildren(Z);if(X++,1!==oe.length)break;Z=oe[0].properties.cluster_id}return X}_appendLeaves(Z,X,oe,ge,se){const be=this.getChildren(X);for(const ke of be){const Te=ke.properties;if(Te&&Te.cluster?se+Te.point_count<=ge?se+=Te.point_count:se=this._appendLeaves(Z,Te.cluster_id,oe,ge,se):se<ge?se++:Z.push(ke),Z.length===oe)break}return se}_createTree(Z){const X=new u.c0(Z.length/this.stride|0,this.options.nodeSize,Float32Array);for(let oe=0;oe<Z.length;oe+=this.stride)X.add(Z[oe],Z[oe+1]);return X.finish(),X.data=Z,X}_addTileFeatures(Z,X,oe,ge,se,be){for(const ke of Z){const Te=ke*this.stride,Ie=X[Te+nr]>1;let st,qe,Lt;if(Ie)st=Ld(X,Te,this.clusterProps),qe=X[Te],Lt=X[Te+1];else{const bn=this.points[X[Te+vi]];st=bn.properties;const[pn,cn]=bn.geometry.coordinates;qe=vs(pn),Lt=cr(cn)}const $t={type:1,geometry:[[Math.round(this.options.extent*(qe*se-oe)),Math.round(this.options.extent*(Lt*se-ge))]],tags:st};let Zt;Zt=Ie||this.options.generateId?X[Te+vi]:this.points[X[Te+vi]].id,void 0!==Zt&&($t.id=Zt),be.features.push($t)}}_limitZoom(Z){return Math.max(this.options.minZoom,Math.min(Math.floor(+Z),this.options.maxZoom+1))}_cluster(Z,X){const{radius:oe,extent:ge,reduce:se,minPoints:be}=this.options,ke=oe/(ge*Math.pow(2,X)),Te=Z.data,Ie=[],st=this.stride;for(let qe=0;qe<Te.length;qe+=st){if(Te[qe+2]<=X)continue;Te[qe+2]=X;const Lt=Te[qe],$t=Te[qe+1],Zt=Z.within(Te[qe],Te[qe+1],ke),bn=Te[qe+nr];let pn=bn;for(const cn of Zt){const mi=cn*st;Te[mi+2]>X&&(pn+=Te[mi+nr])}if(pn>bn&&pn>=be){let cn,mi=Lt*bn,yn=$t*bn,ir=-1;const Cr=(qe/st<<5)+(X+1)+this.points.length;for(const Lr of Zt){const ci=Lr*st;if(Te[ci+2]<=X)continue;Te[ci+2]=X;const Vn=Te[ci+nr];mi+=Te[ci]*Vn,yn+=Te[ci+1]*Vn,Te[ci+4]=Cr,se&&(cn||(cn=this._map(Te,qe,!0),ir=this.clusterProps.length,this.clusterProps.push(cn)),se(cn,this._map(Te,ci)))}Te[qe+4]=Cr,Ie.push(mi/pn,yn/pn,1/0,Cr,-1,pn),se&&Ie.push(ir)}else{for(let cn=0;cn<st;cn++)Ie.push(Te[qe+cn]);if(pn>1)for(const cn of Zt){const mi=cn*st;if(!(Te[mi+2]<=X)){Te[mi+2]=X;for(let yn=0;yn<st;yn++)Ie.push(Te[mi+yn])}}}}return Ie}_getOriginId(Z){return Z-this.points.length>>5}_getOriginZoom(Z){return(Z-this.points.length)%32}_map(Z,X,oe){if(Z[X+nr]>1){const be=this.clusterProps[Z[X+lr]];return oe?Object.assign({},be):be}const ge=this.points[Z[X+vi]].properties,se=this.options.map(ge);return oe&&se===ge?Object.assign({},se):se}}function Ma(Pe,Z,X){return{type:"Feature",id:Pe[Z+vi],properties:Ld(Pe,Z,X),geometry:{type:"Point",coordinates:[(oe=Pe[Z],360*(oe-.5)),ts(Pe[Z+1])]}};var oe}function Ld(Pe,Z,X){const oe=Pe[Z+nr],ge=oe>=1e4?`${Math.round(oe/1e3)}k`:oe>=1e3?Math.round(oe/100)/10+"k":oe,se=Pe[Z+lr],be=-1===se?{}:Object.assign({},X[se]);return Object.assign(be,{cluster:!0,cluster_id:Pe[Z+vi],point_count:oe,point_count_abbreviated:ge})}function vs(Pe){return Pe/360+.5}function cr(Pe){const Z=Math.sin(Pe*Math.PI/180),X=.5-.25*Math.log((1+Z)/(1-Z))/Math.PI;return X<0?0:X>1?1:X}function ts(Pe){const Z=(180-360*Pe)*Math.PI/180;return 360*Math.atan(Math.exp(Z))/Math.PI-90}function Vl(Pe,Z,X,oe){let ge=oe;const se=Z+(X-Z>>1);let be,ke=X-Z;const Te=Pe[Z],Ie=Pe[Z+1],st=Pe[X],qe=Pe[X+1];for(let Lt=Z+3;Lt<X;Lt+=3){const $t=Nd(Pe[Lt],Pe[Lt+1],Te,Ie,st,qe);if($t>ge)be=Lt,ge=$t;else if($t===ge){const Zt=Math.abs(Lt-se);Zt<ke&&(be=Lt,ke=Zt)}}ge>oe&&(be-Z>3&&Vl(Pe,Z,be,oe),Pe[be+2]=ge,X-be>3&&Vl(Pe,be,X,oe))}function Nd(Pe,Z,X,oe,ge,se){let be=ge-X,ke=se-oe;if(0!==be||0!==ke){const Te=((Pe-X)*be+(Z-oe)*ke)/(be*be+ke*ke);Te>1?(X=ge,oe=se):Te>0&&(X+=be*Te,oe+=ke*Te)}return be=Pe-X,ke=Z-oe,be*be+ke*ke}function Wa(Pe,Z,X,oe){const ge={id:Pe??null,type:Z,geometry:X,tags:oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===Z||"MultiPoint"===Z||"LineString"===Z)Ns(ge,X);else if("Polygon"===Z)Ns(ge,X[0]);else if("MultiLineString"===Z)for(const se of X)Ns(ge,se);else if("MultiPolygon"===Z)for(const se of X)Ns(ge,se[0]);return ge}function Ns(Pe,Z){for(let X=0;X<Z.length;X+=3)Pe.minX=Math.min(Pe.minX,Z[X]),Pe.minY=Math.min(Pe.minY,Z[X+1]),Pe.maxX=Math.max(Pe.maxX,Z[X]),Pe.maxY=Math.max(Pe.maxY,Z[X+1])}function xs(Pe,Z,X,oe){if(!Z.geometry)return;const ge=Z.geometry.coordinates;if(ge&&0===ge.length)return;const se=Z.geometry.type,be=Math.pow(X.tolerance/((1<<X.maxZoom)*X.extent),2);let ke=[],Te=Z.id;if(X.promoteId?Te=Z.properties[X.promoteId]:X.generateId&&(Te=oe||0),"Point"===se)Za(ge,ke);else if("MultiPoint"===se)for(const Ie of ge)Za(Ie,ke);else if("LineString"===se)Pa(ge,ke,be,!1);else if("MultiLineString"===se){if(X.lineMetrics){for(const Ie of ge)ke=[],Pa(Ie,ke,be,!1),Pe.push(Wa(Te,"LineString",ke,Z.properties));return}Tc(ge,ke,be,!1)}else if("Polygon"===se)Tc(ge,ke,be,!0);else{if("MultiPolygon"!==se){if("GeometryCollection"===se){for(const Ie of Z.geometry.geometries)xs(Pe,{id:Te,geometry:Ie,properties:Z.properties},X,oe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ie of ge){const st=[];Tc(Ie,st,be,!0),ke.push(st)}}Pe.push(Wa(Te,se,ke,Z.properties))}function Za(Pe,Z){Z.push(jl(Pe[0]),ns(Pe[1]),0)}function Pa(Pe,Z,X,oe){let ge,se,be=0;for(let Te=0;Te<Pe.length;Te++){const Ie=jl(Pe[Te][0]),st=ns(Pe[Te][1]);Z.push(Ie,st,0),Te>0&&(be+=oe?(ge*st-Ie*se)/2:Math.sqrt(Math.pow(Ie-ge,2)+Math.pow(st-se,2))),ge=Ie,se=st}const ke=Z.length-3;Z[2]=1,Vl(Z,0,ke,X),Z[ke+2]=1,Z.size=Math.abs(be),Z.start=0,Z.end=Z.size}function Tc(Pe,Z,X,oe){for(let ge=0;ge<Pe.length;ge++){const se=[];Pa(Pe[ge],se,X,oe),Z.push(se)}}function jl(Pe){return Pe/360+.5}function ns(Pe){const Z=Math.sin(Pe*Math.PI/180),X=.5-.25*Math.log((1+Z)/(1-Z))/Math.PI;return X<0?0:X>1?1:X}function is(Pe,Z,X,oe,ge,se,be,ke){if(oe/=Z,se>=(X/=Z)&&be<oe)return Pe;if(be<X||se>=oe)return null;const Te=[];for(const Ie of Pe){const st=Ie.geometry;let qe=Ie.type;const Lt=0===ge?Ie.minX:Ie.minY,$t=0===ge?Ie.maxX:Ie.maxY;if(Lt>=X&&$t<oe){Te.push(Ie);continue}if($t<X||Lt>=oe)continue;let Zt=[];if("Point"===qe||"MultiPoint"===qe)Iu(st,Zt,X,oe,ge);else if("LineString"===qe)Xa(st,Zt,X,oe,ge,!1,ke.lineMetrics);else if("MultiLineString"===qe)Mo(st,Zt,X,oe,ge,!1);else if("Polygon"===qe)Mo(st,Zt,X,oe,ge,!0);else if("MultiPolygon"===qe)for(const bn of st){const pn=[];Mo(bn,pn,X,oe,ge,!0),pn.length&&Zt.push(pn)}if(Zt.length){if(ke.lineMetrics&&"LineString"===qe){for(const bn of Zt)Te.push(Wa(Ie.id,qe,bn,Ie.tags));continue}"LineString"!==qe&&"MultiLineString"!==qe||(1===Zt.length?(qe="LineString",Zt=Zt[0]):qe="MultiLineString"),"Point"!==qe&&"MultiPoint"!==qe||(qe=3===Zt.length?"Point":"MultiPoint"),Te.push(Wa(Ie.id,qe,Zt,Ie.tags))}}return Te.length?Te:null}function Iu(Pe,Z,X,oe,ge){for(let se=0;se<Pe.length;se+=3){const be=Pe[se+ge];be>=X&&be<=oe&&Zr(Z,Pe[se],Pe[se+1],Pe[se+2])}}function Xa(Pe,Z,X,oe,ge,se,be){let ke=Au(Pe);const Te=0===ge?Ya:Ka;let Ie,st,qe=Pe.start;for(let pn=0;pn<Pe.length-3;pn+=3){const cn=Pe[pn],mi=Pe[pn+1],yn=Pe[pn+2],ir=Pe[pn+3],Cr=Pe[pn+4],Lr=0===ge?cn:mi,ci=0===ge?ir:Cr;let Vn=!1;be&&(Ie=Math.sqrt(Math.pow(cn-ir,2)+Math.pow(mi-Cr,2))),Lr<X?ci>X&&(st=Te(ke,cn,mi,ir,Cr,X),be&&(ke.start=qe+Ie*st)):Lr>oe?ci<oe&&(st=Te(ke,cn,mi,ir,Cr,oe),be&&(ke.start=qe+Ie*st)):Zr(ke,cn,mi,yn),ci<X&&Lr>=X&&(st=Te(ke,cn,mi,ir,Cr,X),Vn=!0),ci>oe&&Lr<=oe&&(st=Te(ke,cn,mi,ir,Cr,oe),Vn=!0),!se&&Vn&&(be&&(ke.end=qe+Ie*st),Z.push(ke),ke=Au(Pe)),be&&(qe+=Ie)}let Lt=Pe.length-3;const $t=Pe[Lt],Zt=Pe[Lt+1],bn=0===ge?$t:Zt;bn>=X&&bn<=oe&&Zr(ke,$t,Zt,Pe[Lt+2]),Lt=ke.length-3,se&&Lt>=3&&(ke[Lt]!==ke[0]||ke[Lt+1]!==ke[1])&&Zr(ke,ke[0],ke[1],ke[2]),ke.length&&Z.push(ke)}function Au(Pe){const Z=[];return Z.size=Pe.size,Z.start=Pe.start,Z.end=Pe.end,Z}function Mo(Pe,Z,X,oe,ge,se){for(const be of Pe)Xa(be,Z,X,oe,ge,se,!1)}function Zr(Pe,Z,X,oe){Pe.push(Z,X,oe)}function Ya(Pe,Z,X,oe,ge,se){const be=(se-Z)/(oe-Z);return Zr(Pe,se,X+(ge-X)*be,1),be}function Ka(Pe,Z,X,oe,ge,se){const be=(se-X)/(ge-X);return Zr(Pe,Z+(oe-Z)*be,se,1),be}function Qa(Pe,Z){const X=[];for(let oe=0;oe<Pe.length;oe++){const ge=Pe[oe],se=ge.type;let be;if("Point"===se||"MultiPoint"===se||"LineString"===se)be=Ul(ge.geometry,Z);else if("MultiLineString"===se||"Polygon"===se){be=[];for(const ke of ge.geometry)be.push(Ul(ke,Z))}else if("MultiPolygon"===se){be=[];for(const ke of ge.geometry){const Te=[];for(const Ie of ke)Te.push(Ul(Ie,Z));be.push(Te)}}X.push(Wa(ge.id,se,be,ge.tags))}return X}function Ul(Pe,Z){const X=[];X.size=Pe.size,void 0!==Pe.start&&(X.start=Pe.start,X.end=Pe.end);for(let oe=0;oe<Pe.length;oe+=3)X.push(Pe[oe]+Z,Pe[oe+1],Pe[oe+2]);return X}function Mu(Pe,Z){if(Pe.transformed)return Pe;const X=1<<Pe.z,oe=Pe.x,ge=Pe.y;for(const se of Pe.features){const be=se.geometry,ke=se.type;if(se.geometry=[],1===ke)for(let Te=0;Te<be.length;Te+=2)se.geometry.push(Di(be[Te],be[Te+1],Z,X,oe,ge));else for(let Te=0;Te<be.length;Te++){const Ie=[];for(let st=0;st<be[Te].length;st+=2)Ie.push(Di(be[Te][st],be[Te][st+1],Z,X,oe,ge));se.geometry.push(Ie)}}return Pe.transformed=!0,Pe}function Di(Pe,Z,X,oe,ge,se){return[Math.round(X*(Pe*oe-ge)),Math.round(X*(Z*oe-se))]}function zd(Pe,Z,X,oe,ge){const se=Z===ge.maxZoom?0:ge.tolerance/((1<<Z)*ge.extent),be={features:[],numPoints:0,numSimplified:0,numFeatures:Pe.length,source:null,x:X,y:oe,z:Z,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const ke of Pe)Bd(be,ke,se,ge);return be}function Bd(Pe,Z,X,oe){const ge=Z.geometry,se=Z.type,be=[];if(Pe.minX=Math.min(Pe.minX,Z.minX),Pe.minY=Math.min(Pe.minY,Z.minY),Pe.maxX=Math.max(Pe.maxX,Z.maxX),Pe.maxY=Math.max(Pe.maxY,Z.maxY),"Point"===se||"MultiPoint"===se)for(let ke=0;ke<ge.length;ke+=3)be.push(ge[ke],ge[ke+1]),Pe.numPoints++,Pe.numSimplified++;else if("LineString"===se)zs(be,ge,Pe,X,!1,!1);else if("MultiLineString"===se||"Polygon"===se)for(let ke=0;ke<ge.length;ke++)zs(be,ge[ke],Pe,X,"Polygon"===se,0===ke);else if("MultiPolygon"===se)for(let ke=0;ke<ge.length;ke++){const Te=ge[ke];for(let Ie=0;Ie<Te.length;Ie++)zs(be,Te[Ie],Pe,X,!0,0===Ie)}if(be.length){let ke=Z.tags||null;if("LineString"===se&&oe.lineMetrics){ke={};for(const Ie in Z.tags)ke[Ie]=Z.tags[Ie];ke.mapbox_clip_start=ge.start/ge.size,ke.mapbox_clip_end=ge.end/ge.size}const Te={geometry:be,type:"Polygon"===se||"MultiPolygon"===se?3:"LineString"===se||"MultiLineString"===se?2:1,tags:ke};null!==Z.id&&(Te.id=Z.id),Pe.features.push(Te)}}function zs(Pe,Z,X,oe,ge,se){const be=oe*oe;if(oe>0&&Z.size<(ge?be:oe))return void(X.numPoints+=Z.length/3);const ke=[];for(let Te=0;Te<Z.length;Te+=3)(0===oe||Z[Te+2]>be)&&(X.numSimplified++,ke.push(Z[Te],Z[Te+1])),X.numPoints++;ge&&function(Te,Ie){let st=0;for(let qe=0,Lt=Te.length,$t=Lt-2;qe<Lt;$t=qe,qe+=2)st+=(Te[qe]-Te[$t])*(Te[qe+1]+Te[$t+1]);if(st>0===Ie)for(let qe=0,Lt=Te.length;qe<Lt/2;qe+=2){const $t=Te[qe],Zt=Te[qe+1];Te[qe]=Te[Lt-2-qe],Te[qe+1]=Te[Lt-1-qe],Te[Lt-2-qe]=$t,Te[Lt-1-qe]=Zt}}(ke,se),Pe.push(ke)}const Vd={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Gp{constructor(Z,X){const oe=(X=this.options=function(se,be){for(const ke in be)se[ke]=be[ke];return se}(Object.create(Vd),X)).debug;if(oe&&console.time("preprocess data"),X.maxZoom<0||X.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(X.promoteId&&X.generateId)throw new Error("promoteId and generateId cannot be used together.");let ge=function(se,be){const ke=[];if("FeatureCollection"===se.type)for(let Te=0;Te<se.features.length;Te++)xs(ke,se.features[Te],be,Te);else xs(ke,"Feature"===se.type?se:{geometry:se},be);return ke}(Z,X);this.tiles={},this.tileCoords=[],oe&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",X.indexMaxZoom,X.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ge=function(se,be){const ke=be.buffer/be.extent;let Te=se;const Ie=is(se,1,-1-ke,ke,0,-1,2,be),st=is(se,1,1-ke,2+ke,0,-1,2,be);return(Ie||st)&&(Te=is(se,1,-ke,1+ke,0,-1,2,be)||[],Ie&&(Te=Qa(Ie,1).concat(Te)),st&&(Te=Te.concat(Qa(st,-1)))),Te}(ge,X),ge.length&&this.splitTile(ge,0,0,0),oe&&(ge.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(Z,X,oe,ge,se,be,ke){const Te=[Z,X,oe,ge],Ie=this.options,st=Ie.debug;for(;Te.length;){ge=Te.pop(),oe=Te.pop(),X=Te.pop(),Z=Te.pop();const qe=1<<X,Lt=Pu(X,oe,ge);let $t=this.tiles[Lt];if(!$t&&(st>1&&console.time("creation"),$t=this.tiles[Lt]=zd(Z,X,oe,ge,Ie),this.tileCoords.push({z:X,x:oe,y:ge}),st)){st>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",X,oe,ge,$t.numFeatures,$t.numPoints,$t.numSimplified),console.timeEnd("creation"));const Vn=`z${X}`;this.stats[Vn]=(this.stats[Vn]||0)+1,this.total++}if($t.source=Z,null==se){if(X===Ie.indexMaxZoom||$t.numPoints<=Ie.indexMaxPoints)continue}else{if(X===Ie.maxZoom||X===se)continue;if(null!=se){const Vn=se-X;if(oe!==be>>Vn||ge!==ke>>Vn)continue}}if($t.source=null,0===Z.length)continue;st>1&&console.time("clipping");const Zt=.5*Ie.buffer/Ie.extent,bn=.5-Zt,pn=.5+Zt,cn=1+Zt;let mi=null,yn=null,ir=null,Cr=null,Lr=is(Z,qe,oe-Zt,oe+pn,0,$t.minX,$t.maxX,Ie),ci=is(Z,qe,oe+bn,oe+cn,0,$t.minX,$t.maxX,Ie);Z=null,Lr&&(mi=is(Lr,qe,ge-Zt,ge+pn,1,$t.minY,$t.maxY,Ie),yn=is(Lr,qe,ge+bn,ge+cn,1,$t.minY,$t.maxY,Ie),Lr=null),ci&&(ir=is(ci,qe,ge-Zt,ge+pn,1,$t.minY,$t.maxY,Ie),Cr=is(ci,qe,ge+bn,ge+cn,1,$t.minY,$t.maxY,Ie),ci=null),st>1&&console.timeEnd("clipping"),Te.push(mi||[],X+1,2*oe,2*ge),Te.push(yn||[],X+1,2*oe,2*ge+1),Te.push(ir||[],X+1,2*oe+1,2*ge),Te.push(Cr||[],X+1,2*oe+1,2*ge+1)}}getTile(Z,X,oe){Z=+Z,X=+X,oe=+oe;const ge=this.options,{extent:se,debug:be}=ge;if(Z<0||Z>24)return null;const ke=1<<Z,Te=Pu(Z,X=X+ke&ke-1,oe);if(this.tiles[Te])return Mu(this.tiles[Te],se);be>1&&console.log("drilling down to z%d-%d-%d",Z,X,oe);let Ie,st=Z,qe=X,Lt=oe;for(;!Ie&&st>0;)st--,qe>>=1,Lt>>=1,Ie=this.tiles[Pu(st,qe,Lt)];return Ie&&Ie.source?(be>1&&(console.log("found parent tile z%d-%d-%d",st,qe,Lt),console.time("drilling down")),this.splitTile(Ie.source,st,qe,Lt,Z,X,oe),be>1&&console.timeEnd("drilling down"),this.tiles[Te]?Mu(this.tiles[Te],se):null):null}}function Pu(Pe,Z,X){return 32*((1<<Pe)*X+Z)+Pe}function Je(Pe,Z){const X=Pe.tileID.canonical;if(!this._geoJSONIndex)return void Z(null,null);const oe=this._geoJSONIndex.getTile(X.z,X.x,X.y);if(!oe)return void Z(null,null);const ge=Ie=>Ie.tags&&"3d_elevation_id"in Ie.tags&&"source"in Ie.tags&&"elevation"===Ie.tags.source,se=oe.features.filter(Ie=>ge(Ie));let be={_geojsonTileLayer:oe.features};se.length>0&&(be={_geojsonTileLayer:oe.features.filter(Ie=>!ge(Ie)),hd_road_elevation:se}),Z(null,{vectorTile:new Bl(be),rawData:function(Ie){const st=new u.bq;for(const qe of Object.keys(Ie))st.writeMessage(3,hf,{name:qe,features:Ie[qe]});return st.finish()}(be).buffer})}class Ja extends es{constructor(Z,X,oe,ge,se,be,ke){super(Z,X,oe,ge,se,Je,ke),be&&(this.loadGeoJSON=be),this._dynamicIndex=new df}loadData(Z,X){const oe=Z&&Z.request,ge=oe&&oe.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(Z,(se,be)=>{if(se||!be)return X(se);if("object"!=typeof be)return X(new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`));{try{if(Z.filter){const Te=u.X(Z.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Te.result)throw new Error(Te.value.map(Ie=>`${Ie.key}: ${Ie.message}`).join(", "));be.features=be.features.filter(Ie=>Te.value.evaluate({zoom:0},Ie))}Z.dynamic?("Feature"===be.type&&(be={type:"FeatureCollection",features:[be]}),Z.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(be.features,this.loaded),Z.cluster&&(be.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=Z.cluster?new Ls(function({superclusterOptions:Te,clusterProperties:Ie}){if(!Ie||!Te)return Te;const st={},qe={},Lt={accumulated:null,zoom:0},$t={properties:null},Zt=Object.keys(Ie);for(const bn of Zt){const[pn,cn]=Ie[bn],mi=u.X(cn),yn=u.X("string"==typeof pn?[pn,["accumulated"],["get",bn]]:pn);st[bn]=mi.value,qe[bn]=yn.value}return Te.map=bn=>{$t.properties=bn;const pn={};for(const cn of Zt)pn[cn]=st[cn].evaluate(Lt,$t);return pn},Te.reduce=(bn,pn)=>{$t.properties=pn;for(const cn of Zt)Lt.accumulated=bn[cn],bn[cn]=qe[cn].evaluate(Lt,$t)},Te}(Z)).load(be.features):Z.dynamic?this._dynamicIndex:new Gp(Te=be,Z.geojsonVtOptions)}catch(Te){return X(Te)}const ke={};if(ge){const Te=tr(oe);Te&&(ke.resourceTiming={},ke.resourceTiming[Z.source]=JSON.parse(JSON.stringify(Te)))}X(null,ke)}var Te})}reloadTile(Z,X){const oe=this.loaded;return oe&&oe[Z.uid]?Z.partial?X(null,void 0):super.reloadTile(Z,X):this.loadTile(Z,X)}loadGeoJSON(Z,X){if(Z.request)u.n(Z.request,X);else{if("string"!=typeof Z.data)return X(new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return X(null,JSON.parse(Z.data))}catch{return X(new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(Z,X){try{X(null,this._geoJSONIndex.getClusterExpansionZoom(Z.clusterId))}catch(oe){X(oe)}}getClusterChildren(Z,X){try{X(null,this._geoJSONIndex.getChildren(Z.clusterId))}catch(oe){X(oe)}}getClusterLeaves(Z,X){try{X(null,this._geoJSONIndex.getLeaves(Z.clusterId,Z.limit,Z.offset))}catch(oe){X(oe)}}}class $p{constructor(Z,X,oe){this.tileID=new u.aM(Z.tileID.overscaledZ,Z.tileID.wrap,Z.tileID.canonical.z,Z.tileID.canonical.x,Z.tileID.canonical.y),this.tileZoom=Z.tileZoom,this.uid=Z.uid,this.zoom=Z.zoom,this.canonical=Z.tileID.canonical,this.pixelRatio=Z.pixelRatio,this.tileSize=Z.tileSize,this.source=Z.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=Z.projection,this.brightness=X,this.worldview=oe}parse(Z,X,oe,ge){this.status="parsing";const se=new u.aM(oe.tileID.overscaledZ,oe.tileID.wrap,oe.tileID.canonical.z,oe.tileID.canonical.x,oe.tileID.canonical.y),be=[],ke=X.familiesBySource[oe.source],Te=new u.fc(se,oe.promoteId);Te.bucketLayerIDs=[],Te.is3DTile=!0,u.fr(Z).then(Ie=>{if(!Ie)return ge(new Error("Could not parse tile"));const st=Ie.json.extensionsUsed&&Ie.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ie.json.asset.extras&&Ie.json.asset.extras.MAPBOX_mesh_features,qe=Ie.json.extensionsUsed&&Ie.json.extensionsUsed.includes("EXT_meshopt_compression"),Lt=new u.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const $t in ke)for(const Zt of ke[$t]){const bn=Zt[0];Te.bucketLayerIDs.push(Zt.map(mi=>u.C(mi.id,mi.scope))),bn.recalculate(Lt,[]);const pn=u.fs(Ie,1/u.d4(oe.tileID.canonical)),cn=new u.ft(Zt,pn,se,st,qe,this.brightness,Te,this.worldview);st||(cn.needsUpload=!0),be.push(cn),cn.evaluate(bn)}this.status="done",ge(null,{buckets:be,featureIndex:Te,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Ie=>ge(new Error(Ie.message)))}}class pf{constructor(Z,X,oe,ge,se,be,ke,Te){this.actor=Z,this.layerIndex=X,this.availableImages=oe,this.availableModels=ge,this.brightness=ke,this.loading={},this.loaded={},this.worldview=Te}loadTile(Z,X){const oe=Z.uid,ge=this.loading[oe]=new $p(Z,this.brightness,this.worldview);u.br(Z.request,(se,be)=>{const ke=!this.loading[oe];return delete this.loading[oe],ke||se?(ge.status="done",ke||(this.loaded[oe]=ge),X(se)):be&&0!==be.byteLength?void ge.parse(be,this.layerIndex,Z,(Te,Ie)=>{ge.status="done",this.loaded=this.loaded||{},this.loaded[oe]=ge,Te||!Ie?X(Te):X(null,Ie)}):(ge.status="done",this.loaded[oe]=ge,X())})}reloadTile(Z,X){const oe=this.loaded,ge=Z.uid;if(oe&&oe[ge]){const se=oe[ge];se.projection=Z.projection,se.brightness=Z.brightness;const be=(ke,Te)=>{se.reloadCallback&&(delete se.reloadCallback,this.loadTile(Z,X)),X(ke,Te)};"parsing"===se.status?se.reloadCallback=be:"done"===se.status&&this.loadTile(Z,X)}}abortTile(Z,X){const oe=Z.uid;this.loading[oe]&&delete this.loading[oe],X()}removeTile(Z,X){const oe=this.loaded,ge=Z.uid;oe&&oe[ge]&&delete oe[ge],X()}}class Rn{constructor(Z){this.self=Z,this.actor=new u.fv(Z,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new u.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=u.cj({name:"mercator"}),this.workerSourceTypes={vector:es,geojson:Ja,"raster-dem":Ui,"raster-array":ro,"batched-model":pf},this.workerSources={},this.self.registerWorkerSource=(X,oe)=>{if(this.workerSourceTypes[X])throw new Error(`Worker source with name "${X}" already registered.`);this.workerSourceTypes[X]=oe},this.self.registerRTLTextPlugin=X=>{if(u.fw.isParsed())throw new Error("RTL text plugin already registered.");u.fw.setState({pluginStatus:u.fx.parsed,pluginURL:u.fw.getPluginURL()}),u.fw.applyArabicShaping=X.applyArabicShaping,u.fw.processBidirectionalText=X.processBidirectionalText,u.fw.processStyledBidirectionalText=X.processStyledBidirectionalText;for(const oe of this.rtlPluginParsingListeners)oe(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(Z,X,oe){delete this.layerIndexes[Z],delete this.availableImages[Z],delete this.availableModels[Z],delete this.workerSources[Z],oe()}checkIfReady(Z,X,oe){oe()}setReferrer(Z,X){this.referrer=X}spriteLoaded(Z,X){this.isSpriteLoaded[Z]||(this.isSpriteLoaded[Z]={});const{scope:oe,isLoaded:ge}=X;if(this.isSpriteLoaded[Z][oe]=ge,this.workerSources[Z]&&this.workerSources[Z][oe])for(const se in this.workerSources[Z][oe]){const be=this.workerSources[Z][oe][se];for(const ke in be){const Te=be[ke];Te instanceof es&&(Te.isSpriteLoaded=ge,Te.fire(new u.A("isSpriteLoaded")))}}}setImages(Z,X,oe){this.availableImages[Z]||(this.availableImages[Z]={});const{scope:ge,images:se}=X;if(this.availableImages[Z][ge]=se,this.workerSources[Z]&&this.workerSources[Z][ge]){for(const be in this.workerSources[Z][ge]){const ke=this.workerSources[Z][ge][be];for(const Te in ke)ke[Te].availableImages=se}oe()}else oe()}setModels(Z,{scope:X,models:oe},ge){if(this.availableModels[Z]||(this.availableModels[Z]={}),this.availableModels[Z][X]=oe,this.workerSources[Z]&&this.workerSources[Z][X]){for(const se in this.workerSources[Z][X]){const be=this.workerSources[Z][X][se];for(const ke in be)be[ke].availableModels=oe}ge()}else ge()}setProjection(Z,X){this.projections[Z]=u.cj(X)}setBrightness(Z,X,oe){this.brightness=X,oe()}setWorldview(Z,X,oe){this.worldview=X,oe()}setLayers(Z,X,oe){this.getLayerIndex(Z,X.scope).replace(X.layers,X.options),oe()}updateLayers(Z,X,oe){this.getLayerIndex(Z,X.scope).update(X.layers,X.removedIds,X.options),oe()}loadTile(Z,X,oe){X.projection=this.projections[Z]||this.defaultProjection,this.getWorkerSource(Z,X.type,X.source,X.scope).loadTile(X,oe)}decodeRasterArray(Z,X,oe){this.getWorkerSource(Z,X.type,X.source,X.scope).decodeRasterArray(X,oe)}reloadTile(Z,X,oe){X.projection=this.projections[Z]||this.defaultProjection,this.getWorkerSource(Z,X.type,X.source,X.scope).reloadTile(X,oe)}abortTile(Z,X,oe){this.getWorkerSource(Z,X.type,X.source,X.scope).abortTile(X,oe)}removeTile(Z,X,oe){this.getWorkerSource(Z,X.type,X.source,X.scope).removeTile(X,oe)}removeSource(Z,X,oe){if(!(this.workerSources[Z]&&this.workerSources[Z][X.scope]&&this.workerSources[Z][X.scope][X.type]&&this.workerSources[Z][X.scope][X.type][X.source]))return;const ge=this.workerSources[Z][X.scope][X.type][X.source];delete this.workerSources[Z][X.scope][X.type][X.source],void 0!==ge.removeSource?ge.removeSource(X,oe):oe()}loadWorkerSource(Z,X,oe){try{this.self.importScripts(X.url),oe()}catch(ge){oe(ge.toString())}}syncRTLPluginState(Z,X,oe){if(u.fw.isParsed())oe(null,!0);else if(u.fw.isParsing())this.rtlPluginParsingListeners.push(oe);else try{u.fw.setState(X);const ge=u.fw.getPluginURL();!u.fw.isLoaded()||u.fw.isParsed()||u.fw.isParsing()||null==ge||(u.fw.setState({pluginStatus:u.fx.parsing,pluginURL:u.fw.getPluginURL()}),this.self.importScripts(ge),u.fw.isParsed()?oe(null,!0):this.rtlPluginParsingListeners.push(oe))}catch(ge){oe(ge.toString())}}setDracoUrl(Z,X){this.dracoUrl=X}getAvailableImages(Z,X){this.availableImages[Z]||(this.availableImages[Z]={});let oe=this.availableImages[Z][X];return oe||(oe=[]),oe}getAvailableModels(Z,X){this.availableModels[Z]||(this.availableModels[Z]={});let oe=this.availableModels[Z][X];return oe||(oe={}),oe}getLayerIndex(Z,X){this.layerIndexes[Z]||(this.layerIndexes[Z]={});let oe=this.layerIndexes[Z][X];return oe||(oe=this.layerIndexes[Z][X]=new kd,oe.scope=X),oe}getWorkerSource(Z,X,oe,ge){const se=this.workerSources;return se[Z]||(se[Z]={}),se[Z][ge]||(se[Z][ge]={}),se[Z][ge][X]||(se[Z][ge][X]={}),this.isSpriteLoaded[Z]||(this.isSpriteLoaded[Z]={}),se[Z][ge][X][oe]||(se[Z][ge][X][oe]=new this.workerSourceTypes[X]({send:(be,ke,Te,Ie,st,qe)=>this.actor.send(be,ke,Te,Z,st,qe),scheduler:this.actor.scheduler},this.getLayerIndex(Z,ge),this.getAvailableImages(Z,ge),this.getAvailableModels(Z,ge),this.isSpriteLoaded[Z][ge],void 0,this.brightness,this.worldview)),se[Z][ge][X][oe]}rasterizeImagesWorker(Z,X,oe){const ge=new Map;for(const[se,{image:be,imageVariant:ke}]of X.tasks.entries()){const Te=this.imageRasterizer.rasterize(ke,be,X.scope,Z);ge.set(se,Te)}oe(void 0,ge)}removeRasterizedImages(Z,X,oe){this.imageRasterizer.removeImagesFromCacheByIds(X.imageIds,X.scope,Z),oe()}enforceCacheSizeLimit(Z,X){u.fy(X)}getWorkerPerformanceMetrics(Z,X,oe){oe(void 0,void 0)}}return u.fu(self)&&(self.worker=new Rn(self)),Rn}),Xg(0,function(u){var tr="3.14.0";const ji={create:"create",load:"load",fullLoad:"fullLoad"},Ca={mark(f){performance.mark(f)},measure(f,r,l){performance.measure(f,r,l)}};function kd(f){const r=f.name.split("?")[0];return u.a(r)&&r.includes("mapbox-gl.js")?"javascript":u.a(r)&&r.includes("mapbox-gl.css")?"css":u.b(r)?"fontRange":u.c(r)?"sprite":u.i(r)?"style":u.d(r)?"tilejson":"other"}var Fs,ks={},Nl=function(){if(Fs)return ks;function f(p){return!r(p)}function r(p){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var v,b,D=new Blob([""],{type:"text/javascript"}),C=URL.createObjectURL(D);try{b=new Worker(C),v=!0}catch{v=!1}return b&&b.terminate(),URL.revokeObjectURL(C),v}()?function(){var v=document.createElement("canvas");v.width=v.height=1;var b=v.getContext("2d");if(!b)return!1;var D=b.getImageData(0,0,1,1);return D&&D.width===v.width}()?(void 0===l[y=p&&p.failIfMajorPerformanceCaveat]&&(l[y]=function(v){var b,C,P,O,D=(C=v,P=document.createElement("canvas"),(O=Object.create(f.webGLContextAttributes)).failIfMajorPerformanceCaveat=C,P.getContext("webgl2",O));if(!D)return!1;try{b=D.createShader(D.VERTEX_SHADER)}catch{return!1}return!(!b||D.isContextLost())&&(D.shaderSource(b,"void main() {}"),D.compileShader(b),!0===D.getShaderParameter(b,D.COMPILE_STATUS))}(y)),l[y]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var y}Fs=1,ks.supported=f,ks.notSupportedReason=r;var l={};return f.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},ks}();function fn(f,r,l){const p=document.createElement(f);return null!=r&&(p.className=r),l&&l.appendChild(p),p}function es(f,r,l){const p=document.createElementNS("http://www.w3.org/2000/svg",f);for(const y of Object.keys(r))p.setAttributeNS(null,y,String(r[y]));return l&&l.appendChild(p),p}const Ui=typeof document<"u"?document.documentElement&&document.documentElement.style:null,jo=Ui&&void 0!==Ui.userSelect?"userSelect":"WebkitUserSelect";let ro;function ys(){Ui&&jo&&(ro=Ui[jo],Ui[jo]="none")}function Ws(){Ui&&jo&&(Ui[jo]=ro)}function zl(f){f.preventDefault(),f.stopPropagation(),window.removeEventListener("click",zl,!0)}function Bl(){window.addEventListener("click",zl,!0),window.setTimeout(()=>{window.removeEventListener("click",zl,!0)},0)}function da(f,r){const l=f.getBoundingClientRect();return Un(f,l,r)}function Ia(f,r){const l=f.getBoundingClientRect(),p=[];for(let y=0;y<r.length;y++)p.push(Un(f,l,r[y]));return p}function df(f){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===f.button&&f.ctrlKey?0:f.button}function Un(f,r,l){const p=f.offsetWidth===r.width?1:f.offsetWidth/r.width;return new u.P((l.clientX-r.left)*p,(l.clientY-r.top)*p)}const qa="01",go="NO_ACCESS_TOKEN";class mr{constructor(r,l,p){this._transformRequestFn=r,this._customAccessToken=l,this._silenceAuthErrors=!!p,this._createSkuToken()}_createSkuToken(){const r=function(){let l="";for(let p=0;p<10;p++)l+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",qa,l].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=r.token,this._skuTokenExpiresAt=r.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(r,l){return this._transformRequestFn&&this._transformRequestFn(r,l)||{url:r}}normalizeStyleURL(r,l){if(!u.j(r))return r;const p=Fi(r);return p.params.push(`sdk=js-${tr}`),p.path=`/styles/v1${p.path}`,this._makeAPIURL(p,this._customAccessToken||l)}normalizeGlyphsURL(r,l){if(!u.j(r))return r;const p=Fi(r);return p.path=`/fonts/v1${p.path}`,this._makeAPIURL(p,this._customAccessToken||l)}normalizeModelURL(r,l){if(!u.j(r))return r;const p=Fi(r);return p.path=`/models/v1${p.path}`,this._makeAPIURL(p,this._customAccessToken||l)}normalizeSourceURL(r,l,p,y){if(!u.j(r))return r;const v=Fi(r);return v.path=`/v4/${v.authority}.json`,v.params.push("secure"),p&&v.params.push(`language=${p}`),y&&v.params.push(`worldview=${y}`),this._makeAPIURL(v,this._customAccessToken||l)}normalizeIconsetURL(r,l){const p=Fi(r);return u.j(r)?(p.path=`/styles/v1${p.path}/iconset.pbf`,this._makeAPIURL(p,this._customAccessToken||l)):oo(p)}normalizeSpriteURL(r,l,p,y){const v=Fi(r);return u.j(r)?(v.path=`/styles/v1${v.path}/sprite${l}${p}`,this._makeAPIURL(v,this._customAccessToken||y)):(v.path+=`${l}${p}`,oo(v))}normalizeTileURL(r,l,p){if(this._isSkuTokenExpired()&&this._createSkuToken(),r&&!u.j(r))return r;const y=Fi(r);y.path=y.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${l||p&&"raster"!==y.authority&&512===p?"@2x":""}${u.l.supported?".webp":"$1"}`),"raster"===y.authority?y.path=`/${u.e.RASTER_URL_PREFIX}${y.path}`:"rasterarrays"===y.authority?y.path=`/${u.e.RASTERARRAYS_URL_PREFIX}${y.path}`:"3dtiles"===y.authority?y.path=`/${u.e.TILES3D_URL_PREFIX}${y.path}`:(y.path=y.path.replace(/^.+\/v4\//,"/"),y.path=`/${u.e.TILE_URL_VERSION}${y.path}`);const v=this._customAccessToken||function(b){for(const D of b){const C=D.match(/^access_token=(.*)$/);if(C)return C[1]}return null}(y.params)||u.e.ACCESS_TOKEN;return u.e.REQUIRE_ACCESS_TOKEN&&v&&this._skuToken&&y.params.push(`sku=${this._skuToken}`),this._makeAPIURL(y,v)}canonicalizeTileURL(r,l){const p=Fi(r);if(!p.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!p.path.match(/\.[\w]+$/))return r;let y="mapbox://";p.path.match(/^\/raster\/v1\//)?y+=`raster/${p.path.replace(`/${u.e.RASTER_URL_PREFIX}/`,"")}`:p.path.match(/^\/rasterarrays\/v1\//)?y+=`rasterarrays/${p.path.replace(`/${u.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:y+=`tiles/${p.path.replace(`/${u.e.TILE_URL_VERSION}/`,"")}`;let v=p.params;return l&&(v=v.filter(b=>!b.match(/^access_token=/))),v.length&&(y+=`?${v.join("&")}`),y}canonicalizeTileset(r,l){const p=!!l&&u.j(l),y=[];for(const v of r.tiles||[])u.k(v)?y.push(this.canonicalizeTileURL(v,p)):y.push(v);return y}_makeAPIURL(r,l){const p="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",y=Fi(u.e.API_URL);if(r.protocol=y.protocol,r.authority=y.authority,"http"===r.protocol){const v=r.params.indexOf("secure");v>=0&&r.params.splice(v,1)}if("/"!==y.path&&(r.path=`${y.path}${r.path}`),!u.e.REQUIRE_ACCESS_TOKEN)return oo(r);if(l=l||u.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!l)throw new Error(`An API access token is required to use Mapbox GL. ${p}`);if("s"===l[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${p}`)}return r.params=r.params.filter(v=>-1===v.indexOf("access_token")),r.params.push(`access_token=${l||""}`),oo(r)}}const gr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Fi(f){const r=f.match(gr);if(!r)throw new Error("Unable to parse URL object");return{protocol:r[1],authority:r[2],path:r[3]||"/",params:r[4]?r[4].split("&"):[]}}function oo(f){const r=f.params.length?`?${f.params.join("&")}`:"";return`${f.protocol}://${f.authority}${f.path}${r}`}const hf="mapbox.eventData";function Aa(f){if(!f)return null;const r=f.split(".");if(!r||3!==r.length)return null;try{return JSON.parse(u.m(r[1]))}catch{return null}}class Hi{constructor(r){this.type=r,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(r){const l=Aa(u.e.ACCESS_TOKEN);let p="";return p=l&&l.u?u.f(l.u):u.e.ACCESS_TOKEN||"",r?`${hf}.${r}:${p}`:`${hf}:${p}`}fetchEventData(){const r=u.s("localStorage"),l=this.getStorageKey(),p=this.getStorageKey("uuid");if(r)try{const y=localStorage.getItem(l);y&&(this.eventData=JSON.parse(y));const v=localStorage.getItem(p);v&&(this.anonId=v)}catch{u.w("Unable to read from LocalStorage")}}saveEventData(){const r=u.s("localStorage"),l=this.getStorageKey(),p=this.getStorageKey("uuid"),y=this.anonId;if(r&&y)try{localStorage.setItem(p,y),Object.keys(this.eventData).length>=1&&localStorage.setItem(l,JSON.stringify(this.eventData))}catch{u.w("Unable to write to LocalStorage")}}processRequests(r){}postEvent(r,l,p,y){if(!u.e.EVENTS_URL)return;const v=Fi(u.e.EVENTS_URL);v.params.push(`access_token=${y||u.e.ACCESS_TOKEN||""}`);const b={event:this.type,created:new Date(r).toISOString()},D=l?u.h(b,l):b,C={url:oo(v),headers:{"Content-Type":"text/plain"},body:JSON.stringify([D])};this.pendingRequest=u.p(C,P=>{this.pendingRequest=null,p(P),this.saveEventData(),this.processRequests(y)})}queueRequest(r,l){this.queue.push(r),this.processRequests(l)}}const ki=new class extends Hi{constructor(f){super("appUserTurnstile"),this._customAccessToken=f}postTurnstileEvent(f,r){u.e.EVENTS_URL&&u.e.ACCESS_TOKEN&&Array.isArray(f)&&f.some(l=>u.j(l)||u.k(l))&&this.queueRequest(Date.now(),r)}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const r=Aa(u.e.ACCESS_TOKEN),l=r?r.u:u.e.ACCESS_TOKEN;let p=l!==this.eventData.tokenU;u.v(this.anonId)||(this.anonId=u.u(),p=!0);const y=this.queue.shift();if(this.eventData.lastSuccess){const v=new Date(this.eventData.lastSuccess),b=new Date(y),D=(y-this.eventData.lastSuccess)/864e5;p=p||D>=1||D<-1||v.getDate()!==b.getDate()}else p=!0;p?this.postEvent(y,{sdkIdentifier:"mapbox-gl-js",sdkVersion:tr,skuId:qa,"enabled.telemetry":!1,userId:this.anonId},v=>{v||(this.eventData.lastSuccess=y,this.eventData.tokenU=l)},f):this.processRequests()}},Uo=ki.postTurnstileEvent.bind(ki),Cu=new class extends Hi{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(f,r,l,p){this.skuToken=r,this.errorCb=p,u.e.EVENTS_URL&&(l||u.e.ACCESS_TOKEN?this.queueRequest({id:f,timestamp:Date.now()},l):this.errorCb(new Error(go)))}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;const{id:r,timestamp:l}=this.queue.shift();r&&this.success[r]||(this.anonId||this.fetchEventData(),u.v(this.anonId)||(this.anonId=u.u()),this.postEvent(l,{sdkIdentifier:"mapbox-gl-js",sdkVersion:tr,skuId:qa,skuToken:this.skuToken,userId:this.anonId},p=>{p?this.errorCb(p):r&&(this.success[r]=!0)},f))}remove(){this.errorCb=null}},ff=Cu.postMapLoadEvent.bind(Cu),Gi=new class extends Hi{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(f){let r=this.mapInstanceIdMap.get(f);return r||(r=u.u(),this.mapInstanceIdMap.set(f,r)),r}getEventId(f){const r=this.eventIdPerMapInstanceMap.get(f)||0;return this.eventIdPerMapInstanceMap.set(f,r+1),r}postStyleLoadEvent(f,r){const{map:l,style:p,importedStyles:y}=r;if(!u.e.EVENTS_URL||!f&&!u.e.ACCESS_TOKEN)return;const v=this.getMapInstanceId(l),b={mapInstanceId:v,eventId:this.getEventId(v),style:p};y.length&&(b.importedStyles=y),this.queueRequest({timestamp:Date.now(),payload:b},f)}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:r,payload:l}=this.queue.shift();this.postEvent(r,l,()=>{},f)}},Mi=Gi.postStyleLoadEvent.bind(Gi),ar=new class extends Hi{constructor(){super("gljs.performance")}postPerformanceEvent(f,r){u.e.EVENTS_URL&&(f||u.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:r},f)}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:r,performanceData:l}=this.queue.shift(),p=function(y){const v=performance.getEntriesByType("resource"),b=performance.getEntriesByType("mark"),D=function(B){const H={};if(B)for(const U in B)if("other"!==U)for(const q of B[U]){const G=`${U}ResolveRangeMin`,Y=`${U}ResolveRangeMax`,ee=`${U}RequestCount`,ne=`${U}RequestCachedCount`;H[G]=Math.min(H[G]||1/0,q.startTime),H[Y]=Math.max(H[Y]||-1/0,q.responseEnd);const le=de=>{void 0===H[de]&&(H[de]=0),++H[de]};void 0!==q.transferSize&&0===q.transferSize&&le(ne),le(ee)}return H}(function(B,H){const U={};if(B)for(const q of B){const G=H(q);void 0===U[G]&&(U[G]=[]),U[G].push(q)}return U}(v,kd)),C=window.devicePixelRatio,P=navigator.connection||navigator.mozConnection||navigator.webkitConnection,O=P?P.effectiveType:void 0,N={counters:[],metadata:[],attributes:[]},F=(B,H,U)=>{null!=U&&B.push({name:H,value:U.toString()})};for(const B in D)F(N.counters,B,D[B]);if(y.interactionRange[0]!==1/0&&y.interactionRange[1]!==-1/0&&(F(N.counters,"interactionRangeMin",y.interactionRange[0]),F(N.counters,"interactionRangeMax",y.interactionRange[1])),b)for(const B of Object.keys(ji)){const H=ji[B],U=b.find(q=>q.name===H);U&&F(N.counters,H,U.startTime)}return F(N.counters,"visibilityHidden",y.visibilityHidden),F(N.attributes,"style",function(B){if(B)for(const H of B){const U=H.name.split("?")[0];if(u.i(U)){const q=U.split("/").slice(-2);if(2===q.length)return`mapbox://styles/${q[0]}/${q[1]}`}}}(v)),F(N.attributes,"terrainEnabled",y.terrainEnabled?"true":"false"),F(N.attributes,"fogEnabled",y.fogEnabled?"true":"false"),F(N.attributes,"projection",y.projection),F(N.attributes,"zoom",y.zoom),F(N.metadata,"devicePixelRatio",C),F(N.metadata,"connectionEffectiveType",O),F(N.metadata,"navigatorUserAgent",navigator.userAgent),F(N.metadata,"screenWidth",window.screen.width),F(N.metadata,"screenHeight",window.screen.height),F(N.metadata,"windowWidth",window.innerWidth),F(N.metadata,"windowHeight",window.innerHeight),F(N.metadata,"mapWidth",y.width/C),F(N.metadata,"mapHeight",y.height/C),F(N.metadata,"webglRenderer",y.renderer),F(N.metadata,"webglVendor",y.vendor),F(N.metadata,"sdkVersion",tr),F(N.metadata,"sdkIdentifier","mapbox-gl-js"),N}(l);for(const y of p.metadata);for(const y of p.counters);for(const y of p.attributes);this.postEvent(r,p,()=>{},f)}},vi=ar.postPerformanceEvent.bind(ar),nr=new class extends Hi{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(f,r,l,p){if(!u.e.API_URL||!u.e.SESSION_PATH)return;const y=Fi(u.e.API_URL+u.e.SESSION_PATH);y.params.push(`sku=${r||""}`),y.params.push(`access_token=${p||u.e.ACCESS_TOKEN||""}`);const v={url:oo(y),headers:{"Content-Type":"text/plain"}};this.pendingRequest=u.g(v,b=>{this.pendingRequest=null,l(b),this.saveEventData(),this.processRequests(p)})}getSessionAPI(f,r,l,p){this.skuToken=r,this.errorCb=p,u.e.SESSION_PATH&&u.e.API_URL&&(l||u.e.ACCESS_TOKEN?this.queueRequest({id:f,timestamp:Date.now()},l):this.errorCb(new Error(go)))}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;const{id:r,timestamp:l}=this.queue.shift();r&&this.success[r]||this.getSession(l,this.skuToken,p=>{p?this.errorCb(p):r&&(this.success[r]=!0)},f)}remove(){this.errorCb=null}},lr=nr.getSessionAPI.bind(nr),Ls=new Set;function Ma(f,r){r?Ls.add(f):Ls.delete(f)}class Ld{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(r,l){this._updatedSourceCaches[r]=l,this.setDirty()}discardSourceCacheUpdate(r){delete this._updatedSourceCaches[r]}updateLayer(r){const l=r.scope;this._updatedLayers[l]=this._updatedLayers[l]||new Set,this._updatedLayers[l].add(r.id),this.setDirty()}removeLayer(r){const l=r.scope;this._removedLayers[l]=this._removedLayers[l]||{},this._updatedLayers[l]=this._updatedLayers[l]||new Set,this._removedLayers[l][r.id]=r,this._updatedLayers[l].delete(r.id),this._updatedPaintProps.delete(r.fqid),this.setDirty()}getRemovedLayer(r){return this._removedLayers[r.scope]?this._removedLayers[r.scope][r.id]:null}discardLayerRemoval(r){this._removedLayers[r.scope]&&delete this._removedLayers[r.scope][r.id]}getLayerUpdatesByScope(){const r={};for(const l in this._updatedLayers)r[l]=r[l]||{},r[l].updatedIds=Array.from(this._updatedLayers[l].values());for(const l in this._removedLayers)r[l]=r[l]||{},r[l].removedIds=Object.keys(this._removedLayers[l]);return r}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(r){this._updatedPaintProps.add(r.fqid),this.setDirty()}getUpdatedImages(r){return this._updatedImages[r]?Array.from(this._updatedImages[r].values()):[]}updateImage(r,l){this._updatedImages[l]=this._updatedImages[l]||new Set,this._updatedImages[l].add(u.I.toString(r)),this.setDirty()}resetUpdatedImages(r){this._updatedImages[r]&&this._updatedImages[r].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function vs(f){const{userImage:r}=f;return!!(r&&r.render&&r.render())&&(f.data.replace(new Uint8Array(r.data.buffer)),!0)}class cr extends u.E{constructor(r){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=r,"raster"!==r&&u.t()&&(this.imageRasterizerDispatcher=new u.D(u.x(),this,"Image Rasterizer Worker",1))}addScope(r){this.loaded.set(r,!1),this.imageProviders.set(r,new Map),this.images.set(r,new Map),this.updatedImages.set(r,new Set),this.callbackDispatchedThisFrame.set(r,new Set),this.patterns.set(r,new Map),this.atlasImage.set(r,new u.r({width:1,height:1}))}removeScope(r){this.loaded.delete(r),this.imageProviders.delete(r),this.images.delete(r),this.updatedImages.delete(r),this.callbackDispatchedThisFrame.delete(r),this.patterns.delete(r),this.atlasImage.delete(r);const l=this.atlasTexture.get(r);l&&(l.destroy(),this.atlasTexture.delete(r))}addImageProvider(r,l){this.imageProviders.has(l)||this.imageProviders.set(l,new Map),this.imageProviders.get(l).set(r.id,r)}removeImageProvider(r,l){this.imageProviders.has(l)&&this.imageProviders.get(l).delete(r)}getPendingImageProviders(){const r=[];for(const l of this.imageProviders.values())for(const p of l.values())p.hasPendingRequests()&&r.push(p);return r}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new u.y),this._imageRasterizer}isLoaded(){for(const r of this.loaded.keys())if(!this.loaded.get(r))return!1;return!0}setLoaded(r,l){if(this.loaded.get(l)!==r&&(this.loaded.set(l,r),r)){for(const{ids:p,callback:y}of this.requestors)this._notify(p,l,y);this.requestors=[]}}hasImage(r,l){return!!this.getImage(r,l)}getImage(r,l){return this.images.get(l).get(r.toString())}addImage(r,l,p){this._validate(r,p)&&this.images.get(l).set(r.toString(),p)}_validate(r,l){let p=!0;return this._validateStretch(l.stretchX,l.data&&l.data.width)||(this.fire(new u.z(new Error(`Image "${r.name}" has invalid "stretchX" value`))),p=!1),this._validateStretch(l.stretchY,l.data&&l.data.height)||(this.fire(new u.z(new Error(`Image "${r.name}" has invalid "stretchY" value`))),p=!1),this._validateContent(l.content,l)||(this.fire(new u.z(new Error(`Image "${r.name}" has invalid "content" value`))),p=!1),p}_validateStretch(r,l){if(!r)return!0;let p=0;for(const y of r){if(y[0]<p||y[1]<y[0]||l<y[1])return!1;p=y[1]}return!0}_validateContent(r,l){return!r||!(4!==r.length||!l.usvg&&(r[0]<0||l.data.width<r[0]||r[1]<0||l.data.height<r[1]||r[2]<0||l.data.width<r[2]||r[3]<0||l.data.height<r[3]))&&!(r[2]<r[0]||r[3]<r[1])}updateImage(r,l,p){const y=this.images.get(l).get(r.toString());p.version=y.version+1,this.images.get(l).set(r.toString(),p),this.updatedImages.get(l).add(r),this.removeFromImageRasterizerCache(r,l)}clearUpdatedImages(r){this.updatedImages.get(r).clear()}removeFromImageRasterizerCache(r,l){"raster"!==this.spriteFormat&&(u.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[r],scope:l}):this.imageRasterizer.removeImagesFromCacheByIds([r],l))}removeImage(r,l){const p=this.images.get(l),y=p.get(r.toString());p.delete(r.toString()),this.patterns.get(l).delete(r.toString()),this.removeFromImageRasterizerCache(r,l),y.userImage&&y.userImage.onRemove&&y.userImage.onRemove()}listImages(r){return Array.from(this.images.get(r).keys()).map(l=>u.I.from(l))}getImages(r,l,p){const y=[],v=[],b=this.imageProviders.get(l);for(const O of r){if(!O.iconsetId){y.push(O);continue}const N=b.get(O.iconsetId);N&&(this.getImage(O,l)?v.push(O):N.addPendingRequest(O))}if(0===y.length)return void this._notify(v,l,p);let D=!0;const C=!!this.loaded.get(l),P=this.images.get(l);if(!C)for(const O of y)P.has(O.toString())||(D=!1);C||D?this._notify(y,l,p):this.requestors.push({ids:y,scope:l,callback:p})}rasterizeImages(r,l){const p=new Map,{tasks:y,scope:v}=r;for(const[b,D]of y.entries()){const C=this.getImage(D.id,v);C&&p.set(b,{image:C,imageVariant:D})}this._rasterizeImages(v,p,l)}_rasterizeImages(r,l,p){if(u.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:l,scope:r},p);else{const y=new Map;for(const[v,{image:b,imageVariant:D}]of l.entries())y.set(v,this.imageRasterizer.rasterize(D,b,r,0));p(void 0,y)}}getUpdatedImages(r){return this.updatedImages.get(r)||new Set}_notify(r,l,p){const y=this.images.get(l),v=new Map;for(const b of r){if(!y.get(b.toString())){if(b.iconsetId)continue;this.fire(new u.A("styleimagemissing",{id:b.name}))}const D=y.get(b.toString());if(!D){u.w(`Image "${b.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const C={data:D.usvg?null:D.data.clone(),pixelRatio:D.pixelRatio,sdf:D.sdf,usvg:D.usvg,version:D.version,stretchX:D.stretchX,stretchY:D.stretchY,content:D.content,hasRenderCallback:!(!D.userImage||!D.userImage.render)};D.usvg&&Object.assign(C,{width:D.icon.usvg_tree.width,height:D.icon.usvg_tree.height}),v.set(u.I.toString(b),C)}p(null,v)}getPixelSize(r){const{width:l,height:p}=this.atlasImage.get(r);return{width:l,height:p}}getPattern(r,l,p){const y=r.toString(),v=this.patterns.get(l),b=v.get(y),D=this.getImage(r,l);if(!D)return null;if(b){if(b.position.version===D.version)return b.position;b.position.version=D.version}else{if(D.usvg&&!D.data){const C=this.getPatternInFlightId(y,l);if(this.patternsInFlight.has(C))return null;this.patternsInFlight.add(C);const P=new u.B(r).scaleSelf(u.q.devicePixelRatio),O=new Map([[P.toString(),{image:D,imageVariant:P}]]);return this._rasterizeImages(l,O,(N,F)=>this.storePatternImage(P,l,D,p,F)),null}this.storePattern(r,l,D)}return this._updatePatternAtlas(l,p),v.get(y).position}getPatternInFlightId(r,l){return u.C(r,l)}hasPatternsInFlight(){return 0!==this.patternsInFlight.size}storePatternImage(r,l,p,y,v){const b=r.toString(),D=v?v.get(b):void 0;D&&(p.data=D,this.storePattern(r.id,l,p),this._updatePatternAtlas(l,y),this.patternsInFlight.delete(this.getPatternInFlightId(r.id.toString(),l)))}storePattern(r,l,p){const y={w:p.data.width+2*u.F,h:p.data.height+2*u.F,x:0,y:0},v=new u.G(y,p,u.F);this.patterns.get(l).set(r.toString(),{bin:y,position:v})}destroyAtlasTextures(){for(const r of this.atlasTexture.values())r&&r.destroy();this.atlasTexture.clear()}bind(r,l){const p=r.gl;let y=this.atlasTexture.get(l);y?this.dirty&&(y.update(this.atlasImage.get(l)),this.dirty=!1):(y=new u.T(r,this.atlasImage.get(l),p.RGBA8),this.atlasTexture.set(l,y)),y.bind(p.LINEAR,p.CLAMP_TO_EDGE)}_updatePatternAtlas(r,l){const p=this.patterns.get(r),y=Array.from(p.values()).map(({bin:P})=>P),{w:v,h:b}=u.H(y),D=this.atlasImage.get(r);D.resize({width:v||1,height:b||1});const C=this.images.get(r);for(const[P,{bin:O,position:N}]of p.entries()){let F=N.padding;const B=O.x+F,H=O.y+F,U=C.get(P).data,q=U.width,G=U.height;F=F>1?F-1:F,u.r.copy(U,D,{x:0,y:0},{x:B,y:H},{width:q,height:G},l),u.r.copy(U,D,{x:0,y:G-F},{x:B,y:H-F},{width:q,height:F},l),u.r.copy(U,D,{x:0,y:0},{x:B,y:H+G},{width:q,height:F},l),u.r.copy(U,D,{x:q-F,y:0},{x:B-F,y:H},{width:F,height:G},l),u.r.copy(U,D,{x:0,y:0},{x:B+q,y:H},{width:F,height:G},l),u.r.copy(U,D,{x:q-F,y:G-F},{x:B-F,y:H-F},{width:F,height:F},l),u.r.copy(U,D,{x:0,y:G-F},{x:B+q,y:H-F},{width:F,height:F},l),u.r.copy(U,D,{x:0,y:0},{x:B+q,y:H+G},{width:F,height:F},l),u.r.copy(U,D,{x:q-F,y:0},{x:B-F,y:H+G},{width:F,height:F},l)}this.dirty=!0}beginFrame(){for(const r of this.images.keys())this.callbackDispatchedThisFrame.set(r,new Set)}dispatchRenderCallbacks(r,l){const p=this.images.get(l);for(const y of r){if(this.callbackDispatchedThisFrame.get(l).has(y.toString()))continue;this.callbackDispatchedThisFrame.get(l).add(y.toString());const v=p.get(y.toString());vs(v)&&this.updateImage(y,l,v)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function ts(f){const r=f.key,l=f.value,p=f.valueSpec||{},y=f.objectElementValidators||{},v=f.style,b=f.styleSpec;let D=[];const C=u.J(l);if("object"!==C)return[new u.V(r,l,`object expected, ${C} found`)];for(const P in l){const O=P.split(".")[0];let N;y[O]?N=y[O]:p[O]?N=Di:y["*"]?N=y["*"]:p["*"]&&(N=Di),N?D=D.concat(N({key:(r&&`${r}.`)+P,value:l[P],valueSpec:p[O]||p["*"],style:v,styleSpec:b,object:l,objectKey:P},l)):D.push(new u.K(r,l[P],`unknown property "${P}"`))}for(const P in p)y[P]||p[P].required&&void 0===p[P].default&&void 0===l[P]&&D.push(new u.V(r,l,`missing required property "${P}"`));return D}function Vl(f){const r=f.value,l=f.valueSpec,p=f.style,y=f.styleSpec,v=f.key,b=f.arrayElementValidator||Di;if("array"!==u.J(r))return[new u.V(v,r,`array expected, ${u.J(r)} found`)];if(l.length&&r.length!==l.length)return[new u.V(v,r,`array length ${l.length} expected, length ${r.length} found`)];if(l["min-length"]&&r.length<l["min-length"])return[new u.V(v,r,`array length at least ${l["min-length"]} expected, length ${r.length} found`)];let D={type:l.value,values:l.values,minimum:l.minimum,maximum:l.maximum,function:void 0};y.$version<7&&(D.function=l.function),"object"===u.J(l.value)&&(D=l.value);let C=[];for(let P=0;P<r.length;P++)C=C.concat(b({array:r,arrayIndex:P,value:r[P],valueSpec:D,style:p,styleSpec:y,key:`${v}[${P}]`},!0));return C}function Nd(f){const r=f.key,l=f.value,p=f.valueSpec;let y=u.J(l);if("number"===y&&l!=l&&(y="NaN"),"number"!==y)return[new u.V(r,l,`number expected, ${y} found`)];if("minimum"in p){let v=p.minimum;if("array"===u.J(p.minimum)&&(v=p.minimum[f.arrayIndex]),l<v)return[new u.V(r,l,`${l} is less than the minimum value ${v}`)]}if("maximum"in p){let v=p.maximum;if("array"===u.J(p.maximum)&&(v=p.maximum[f.arrayIndex]),l>v)return[new u.V(r,l,`${l} is greater than the maximum value ${v}`)]}return[]}function Wa(f){const r=f.valueSpec,l=u.M(f.value.type);let p,y,v,b={};const D="categorical"!==l&&void 0===f.value.property,C=!D,P="array"===u.J(f.value.stops)&&"array"===u.J(f.value.stops[0])&&"object"===u.J(f.value.stops[0][0]),O=ts({key:f.key,value:f.value,valueSpec:f.styleSpec.function,style:f.style,styleSpec:f.styleSpec,objectElementValidators:{stops:function(B){if("identity"===l)return[new u.V(B.key,B.value,'identity function may not have a "stops" property')];let H=[];const U=B.value;return H=H.concat(Vl({key:B.key,value:U,valueSpec:B.valueSpec,style:B.style,styleSpec:B.styleSpec,arrayElementValidator:N})),"array"===u.J(U)&&0===U.length&&H.push(new u.V(B.key,U,"array must have at least one stop")),H},default:function(B){return Di({key:B.key,value:B.value,valueSpec:r,style:B.style,styleSpec:B.styleSpec})}}});return"identity"===l&&D&&O.push(new u.V(f.key,f.value,'missing required property "property"')),"identity"===l||f.value.stops||O.push(new u.V(f.key,f.value,'missing required property "stops"')),"exponential"===l&&f.valueSpec.expression&&!u.N(f.valueSpec)&&O.push(new u.V(f.key,f.value,"exponential functions not supported")),f.styleSpec.$version>=8&&(C&&!u.O(f.valueSpec)?O.push(new u.V(f.key,f.value,"property functions not supported")):D&&!u.Q(f.valueSpec)&&O.push(new u.V(f.key,f.value,"zoom functions not supported"))),"categorical"!==l&&!P||void 0!==f.value.property||O.push(new u.V(f.key,f.value,'"property" property is required')),O;function N(B){let H=[];const U=B.value,q=B.key;if("array"!==u.J(U))return[new u.V(q,U,`array expected, ${u.J(U)} found`)];if(2!==U.length)return[new u.V(q,U,`array length 2 expected, length ${U.length} found`)];if(P){if("object"!==u.J(U[0]))return[new u.V(q,U,`object expected, ${u.J(U[0])} found`)];if(void 0===U[0].zoom)return[new u.V(q,U,"object stop key must have zoom")];if(void 0===U[0].value)return[new u.V(q,U,"object stop key must have value")];const G=u.M(U[0].zoom);if("number"!=typeof G)return[new u.V(q,U[0].zoom,"stop zoom values must be numbers")];if(v&&v>G)return[new u.V(q,U[0].zoom,"stop zoom values must appear in ascending order")];G!==v&&(v=G,y=void 0,b={}),H=H.concat(ts({key:`${q}[0]`,value:U[0],valueSpec:{zoom:{}},style:B.style,styleSpec:B.styleSpec,objectElementValidators:{zoom:Nd,value:F}}))}else H=H.concat(F({key:`${q}[0]`,value:U[0],style:B.style,styleSpec:B.styleSpec},U));return u.S(u.U(U[1]))?H.concat([new u.V(`${q}[1]`,U[1],"expressions are not allowed in function stops.")]):H.concat(Di({key:`${q}[1]`,value:U[1],valueSpec:r,style:B.style,styleSpec:B.styleSpec}))}function F(B,H){const U=u.J(B.value),q=u.M(B.value),G=null!==B.value?B.value:H;if(p){if(U!==p)return[new u.V(B.key,G,`${U} stop domain type must match previous stop domain type ${p}`)]}else p=U;if("number"!==U&&"string"!==U&&"boolean"!==U&&"number"!=typeof q&&"string"!=typeof q&&"boolean"!=typeof q)return[new u.V(B.key,G,"stop domain value must be a number, string, or boolean")];if("number"!==U&&"categorical"!==l){let Y=`number expected, ${U} found`;return u.O(r)&&void 0===l&&(Y+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new u.V(B.key,G,Y)]}return"categorical"!==l||"number"!==U||"number"==typeof q&&isFinite(q)&&Math.floor(q)===q?"categorical"!==l&&"number"===U&&"number"==typeof q&&"number"==typeof y&&void 0!==y&&q<y?[new u.V(B.key,G,"stop domain values must appear in ascending order")]:(y=q,"categorical"===l&&q in b?[new u.V(B.key,G,"stop domain values must be unique")]:(b[q]=!0,[])):[new u.V(B.key,G,`integer expected, found ${String(q)}`)]}}function Ns(f){const r=("property"===f.expressionContext?u.W:u.X)(u.U(f.value),f.valueSpec);if("error"===r.result)return r.value.map(p=>new u.V(`${f.key}${p.key}`,f.value,p.message));const l=r.value.expression||r.value._styleExpression.expression;if("property"===f.expressionContext&&"text-font"===f.propertyKey&&!l.outputDefined())return[new u.V(f.key,f.value,`Invalid data expression for "${f.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===f.expressionContext&&"layout"===f.propertyType&&!u.Y(l))return[new u.V(f.key,f.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===f.expressionContext)return xs(l,f);if(f.expressionContext&&0===f.expressionContext.indexOf("cluster")){if(!u.Z(l,["zoom","feature-state"]))return[new u.V(f.key,f.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===f.expressionContext&&!u._(l))return[new u.V(f.key,f.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function xs(f,r){const l=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(r.valueSpec&&r.valueSpec.expression)for(const y of r.valueSpec.expression.parameters)l.delete(y);if(0===l.size)return[];const p=[];return f instanceof u.$&&l.has(f.name)?[new u.V(r.key,r.value,`["${f.name}"] expression is not supported in a filter for a ${r.object.type} layer with id: ${r.object.id}`)]:(f.eachChild(y=>{p.push(...xs(y,r))}),p)}function Za(f){const r=f.key,l=f.value,p=f.valueSpec,y=[];return Array.isArray(p.values)?-1===p.values.indexOf(u.M(l))&&y.push(new u.V(r,l,`expected one of [${p.values.join(", ")}], ${JSON.stringify(l)} found`)):-1===Object.keys(p.values).indexOf(u.M(l))&&y.push(new u.V(r,l,`expected one of [${Object.keys(p.values).join(", ")}], ${JSON.stringify(l)} found`)),y}function Pa(f){return u.a1(u.U(f.value))?Ns(u.L({},f,{expressionContext:"filter",valueSpec:f.styleSpec[`filter_${f.layerType||"fill"}`]})):Tc(f)}function Tc(f){const r=f.value,l=f.key;if("array"!==u.J(r))return[new u.V(l,r,`array expected, ${u.J(r)} found`)];const p=f.styleSpec;let y,v=[];if(r.length<1)return[new u.V(l,r,"filter array must have at least 1 element")];switch(v=v.concat(Za({key:`${l}[0]`,value:r[0],valueSpec:p.filter_operator,style:f.style,styleSpec:f.styleSpec})),u.M(r[0])){case"<":case"<=":case">":case">=":r.length>=2&&"$type"===u.M(r[1])&&v.push(new u.V(l,r,`"$type" cannot be use with operator "${r[0]}"`));case"==":case"!=":3!==r.length&&v.push(new u.V(l,r,`filter array for operator "${r[0]}" must have 3 elements`));case"in":case"!in":r.length>=2&&(y=u.J(r[1]),"string"!==y&&v.push(new u.V(`${l}[1]`,r[1],`string expected, ${y} found`)));for(let b=2;b<r.length;b++)y=u.J(r[b]),"$type"===u.M(r[1])?v=v.concat(Za({key:`${l}[${b}]`,value:r[b],valueSpec:p.geometry_type,style:f.style,styleSpec:f.styleSpec})):"string"!==y&&"number"!==y&&"boolean"!==y&&v.push(new u.V(`${l}[${b}]`,r[b],`string, number, or boolean expected, ${y} found`));break;case"any":case"all":case"none":for(let b=1;b<r.length;b++)v=v.concat(Tc({key:`${l}[${b}]`,value:r[b],style:f.style,styleSpec:f.styleSpec}));break;case"has":case"!has":y=u.J(r[1]),2!==r.length?v.push(new u.V(l,r,`filter array for "${r[0]}" operator must have 2 elements`)):"string"!==y&&v.push(new u.V(`${l}[1]`,r[1],`string expected, ${y} found`))}return v}function jl(f,r){const l=f.key,p=f.style,y=f.layer,v=f.styleSpec,b=f.value,D=f.objectKey,C=v[`${r}_${f.layerType}`];if(!C)return[];const P=D.match(/^(.*)-use-theme$/);if("paint"===r&&P&&C[P[1]])return u.S(b)?[].concat(Di({key:f.key,value:b,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:p,styleSpec:v,expressionContext:"property",propertyType:r,propertyKey:D})):Di({key:l,value:b,valueSpec:{type:"string"},style:p,styleSpec:v});const O=D.match(/^(.*)-transition$/);if("paint"===r&&O&&C[O[1]]&&C[O[1]].transition)return Di({key:l,value:b,valueSpec:v.transition,style:p,styleSpec:v});const N=f.valueSpec||C[D];if(!N)return[new u.K(l,b,`unknown property "${D}"`)];let F;if("string"===u.J(b)&&u.O(N)&&!N.tokens&&(F=/^{([^}]+)}$/.exec(b))){const H=`\`{ "type": "identity", "property": ${F?JSON.stringify(F[1]):'"_"'} }\``;return[new u.V(l,b,`"${D}" does not support interpolation syntax\nUse an identity property function instead: ${H}.`)]}const B=[];if("symbol"===f.layerType)"text-field"!==D||!p||p.glyphs||p.imports||B.push(new u.V(l,b,'use of "text-field" requires a style "glyphs" property')),"text-font"===D&&u.a2(u.U(b))&&"identity"===u.M(b.type)&&B.push(new u.V(l,b,'"text-font" does not support identity functions'));else if("model"===f.layerType&&"paint"===r&&y&&y.layout&&y.layout.hasOwnProperty("model-id")&&u.O(N)&&(u.a3(N)||u.Q(N))){const H=u.W(u.U(b),N),U=H.value.expression||H.value._styleExpression.expression;U&&!u.Z(U,["measure-light"])&&("model-emissive-strength"===D&&u._(U)&&u.Y(U)||B.push(new u.V(l,b,`${D} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return B.concat(Di({key:f.key,value:b,valueSpec:N,style:p,styleSpec:v,expressionContext:"property",propertyType:r,propertyKey:D}))}function ns(f){return jl(f,"paint")}function is(f){return jl(f,"layout")}function Iu(f){let r=[];const l=f.value,p=f.key,y=f.style,v=f.styleSpec;l.type||l.ref||r.push(new u.V(p,l,'either "type" or "ref" is required'));let b=u.M(l.type);const D=u.M(l.ref);if(l.id){const C=u.M(l.id);for(let P=0;P<f.arrayIndex;P++){const O=y.layers[P];u.M(O.id)===C&&r.push(new u.V(p,l.id,`duplicate layer id "${l.id}", previously used at line ${O.id.__line__}`))}}if("ref"in l){let C;["type","source","source-layer","filter","layout"].forEach(P=>{P in l&&r.push(new u.V(p,l[P],`"${P}" is prohibited for ref layers`))}),y.layers.forEach(P=>{u.M(P.id)===D&&(C=P)}),C?C.ref?r.push(new u.V(p,l.ref,"ref cannot reference another ref layer")):b=u.M(C.type):"string"==typeof D&&r.push(new u.V(p,l.ref,`ref layer "${D}" not found`))}else if("background"!==b&&"sky"!==b&&"slot"!==b)if(l.source){const C=y.sources&&y.sources[l.source],P=C&&u.M(C.type);C?"vector"===P&&"raster"===b?r.push(new u.V(p,l.source,`layer "${l.id}" requires a raster source`)):"raster"===P&&"raster"!==b?r.push(new u.V(p,l.source,`layer "${l.id}" requires a vector source`)):"vector"!==P||l["source-layer"]?"raster-dem"===P&&"hillshade"!==b?r.push(new u.V(p,l.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==P||["raster","raster-particle"].includes(b)?"line"===b&&l.paint&&(l.paint["line-gradient"]||l.paint["line-trim-offset"])&&"geojson"===P&&!C.lineMetrics?r.push(new u.V(p,l,`layer "${l.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):"raster-particle"===b&&"raster-array"!==P&&r.push(new u.V(p,l.source,`layer "${l.id}" requires a 'raster-array' source.`)):r.push(new u.V(p,l.source,"raster-array source can only be used with layer type 'raster'.")):r.push(new u.V(p,l,`layer "${l.id}" must specify a "source-layer"`)):r.push(new u.V(p,l.source,`source "${l.source}" not found`))}else r.push(new u.V(p,l,'missing required property "source"'));return r=r.concat(ts({key:p,value:l,valueSpec:v.layer,style:f.style,styleSpec:f.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Di({key:`${p}.type`,value:l.type,valueSpec:v.layer.type,style:f.style,styleSpec:f.styleSpec,object:l,objectKey:"type"}),filter:C=>Pa(u.L({layerType:b},C)),layout:C=>ts({layer:l,key:C.key,value:C.value,valueSpec:{},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":P=>is(u.L({layerType:b},P))}}),paint:C=>ts({layer:l,key:C.key,value:C.value,valueSpec:{},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":P=>ns(u.L({layerType:b,layer:l},P))}})}})),r}function Xa(f){const r=f.value,l=f.key,p=u.J(r);return"string"!==p?[new u.V(l,r,`string expected, ${p} found`)]:[]}const Au={promoteId:function f({key:r,value:l}){if("string"===u.J(l))return Xa({key:r,value:l});if(Array.isArray(l)){const p=[],y=u.U(l),v=u.X(y);return"error"===v.result&&v.value.forEach(b=>{p.push(new u.V(`${r}${b.key}`,null,`${b.message}`))}),u.Z(v.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||p.push(new u.V(`${r}`,null,"promoteId expression should be only feature dependent")),p}{const p=[];for(const y in l)p.push(...f({key:`${r}.${y}`,value:l[y]}));return p}}};function Mo(f){const r=f.value,l=f.key,p=f.styleSpec,y=f.style;if(!r.type)return[new u.V(l,r,'"type" is required')];const v=u.M(r.type);let b=[];switch(["vector","raster","raster-dem","raster-array"].includes(v)&&(r.url||r.tiles||b.push(new u.K(l,r,'Either "url" or "tiles" is required.'))),v){case"vector":case"raster":case"raster-dem":case"raster-array":return b=b.concat(ts({key:l,value:r,valueSpec:p[`source_${v.replace("-","_")}`],style:f.style,styleSpec:p,objectElementValidators:Au})),b;case"geojson":if(b=ts({key:l,value:r,valueSpec:p.source_geojson,style:y,styleSpec:p,objectElementValidators:Au}),r.cluster)for(const D in r.clusterProperties){const[C,P]=r.clusterProperties[D],O="string"==typeof C?[C,["accumulated"],["get",D]]:C;b.push(...Ns({key:`${l}.${D}.map`,value:P,expressionContext:"cluster-map"})),b.push(...Ns({key:`${l}.${D}.reduce`,value:O,expressionContext:"cluster-reduce"}))}return b;case"video":return ts({key:l,value:r,valueSpec:p.source_video,style:y,styleSpec:p});case"image":return ts({key:l,value:r,valueSpec:p.source_image,style:y,styleSpec:p});case"canvas":return[new u.V(l,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Za({key:`${l}.type`,value:r.type,valueSpec:{values:Zr(p)}})}}function Zr(f){return f.source.reduce((r,l)=>{const p=f[l];return"enum"===p.type.type&&(r=r.concat(Object.keys(p.type.values))),r},[])}function Ya(f){const r=f.value,l=f.styleSpec,p=l.light,y=f.style;let v=[];const b=u.J(r);if(void 0===r)return v;if("object"!==b)return v=v.concat([new u.V("light",r,`object expected, ${b} found`)]),v;for(const D in r){const C=D.match(/^(.*)-transition$/),P=D.match(/^(.*)-use-theme$/);v=v.concat(P&&p[P[1]]?Di({key:D,value:r[D],valueSpec:{type:"string"},style:y,styleSpec:l}):C&&p[C[1]]&&p[C[1]].transition?Di({key:D,value:r[D],valueSpec:l.transition,style:y,styleSpec:l}):p[D]?Di({key:D,value:r[D],valueSpec:p[D],style:y,styleSpec:l}):[new u.V(D,r[D],`unknown property "${D}"`)])}return v}function Ka(f){const r=f.value;let l=[];if(!r)return l;const p=u.J(r);if("object"!==p)return l=l.concat([new u.V("light-3d",r,`object expected, ${p} found`)]),l;const y=f.styleSpec,v=y["light-3d"],b=f.key,D=f.style,C=f.style.lights;for(const N of["type","id"])if(!(N in r))return l=l.concat([new u.V("light-3d",r,`missing property ${N} on light`)]),l;if(r.type&&C)for(let N=0;N<f.arrayIndex;N++){const F=u.M(r.type),B=C[N];u.M(B.type)===F&&l.push(new u.V(b,r.id,`duplicate light type "${r.type}", previously defined at line ${B.id.__line__}`))}const P=`properties_light_${r.type}`;if(!(P in y))return l=l.concat([new u.V("light-3d",r,`Invalid light type ${r.type}`)]),l;const O=y[P];for(const N in r)if("properties"===N){const F=r[N],B=u.J(F);if("object"!==B)return l=l.concat([new u.V("properties",F,`object expected, ${B} found`)]),l;for(const H in F){const U=H.match(/^(.*)-transition$/),q=H.match(/^(.*)-use-theme$/);l=l.concat(q&&O[q[1]]?Di({key:N,value:F[H],valueSpec:{type:"string"},style:D,styleSpec:y}):U&&O[U[1]]&&O[U[1]].transition?Di({key:N,value:r[N],valueSpec:y.transition,style:D,styleSpec:y}):O[H]?Di({key:H,value:F[H],valueSpec:O[H],style:D,styleSpec:y}):[new u.K(f.key,F[H],`unknown property "${H}"`)])}}else l=l.concat(v[N]?Di({key:N,value:r[N],valueSpec:v[N],style:D,styleSpec:y}):[new u.K(N,r[N],`unknown property "${N}"`)]);return l}function Qa(f){const r=f.value,l=f.key,p=f.style,y=f.styleSpec,v=y.terrain;let b=[];const D=u.J(r);if(void 0===r||"null"===D)return b;if("object"!==D)return b=b.concat([new u.V("terrain",r,`object expected, ${D} found`)]),b;for(const C in r){const P=C.match(/^(.*)-transition$/),O=C.match(/^(.*)-use-theme$/);b=b.concat(O&&v[O[1]]?Di({key:C,value:r[C],valueSpec:{type:"string"},style:p,styleSpec:y}):P&&v[P[1]]&&v[P[1]].transition?Di({key:C,value:r[C],valueSpec:y.transition,style:p,styleSpec:y}):v[C]?Di({key:C,value:r[C],valueSpec:v[C],style:p,styleSpec:y}):[new u.K(C,r[C],`unknown property "${C}"`)])}if(r.source){const C=p.sources&&p.sources[r.source],P=C&&u.M(C.type);C?"raster-dem"!==P&&b.push(new u.V(l,r.source,`terrain cannot be used with a source of type ${String(P)}, it only be used with a "raster-dem" source type`)):b.push(new u.V(l,r.source,`source "${r.source}" not found`))}else b.push(new u.V(l,r,'terrain is missing required property "source"'));return b}function Ul(f){const r=f.value,l=f.style,p=f.styleSpec,y=p.fog;let v=[];const b=u.J(r);if(void 0===r)return v;if("object"!==b)return v=v.concat([new u.V("fog",r,`object expected, ${b} found`)]),v;for(const D in r){const C=D.match(/^(.*)-transition$/),P=D.match(/^(.*)-use-theme$/);v=v.concat(P&&y[P[1]]?Di({key:D,value:r[D],valueSpec:{type:"string"},style:l,styleSpec:p}):C&&y[C[1]]&&y[C[1]].transition?Di({key:D,value:r[D],valueSpec:p.transition,style:l,styleSpec:p}):y[D]?Di({key:D,value:r[D],valueSpec:y[D],style:l,styleSpec:p}):[new u.K(D,r[D],`unknown property "${D}"`)])}return v}const Mu={"*":()=>[],array:Vl,boolean:function(f){const r=f.value,l=f.key,p=u.J(r);return"boolean"!==p?[new u.V(l,r,`boolean expected, ${p} found`)]:[]},number:Nd,color:function(f){const r=f.key,l=f.value,p=u.J(l);return"string"!==p?[new u.V(r,l,`color expected, ${p} found`)]:null===u.a0.parseCSSColor(l)?[new u.V(r,l,`color expected, "${l}" found`)]:[]},enum:Za,filter:Pa,function:Wa,layer:Iu,object:ts,source:Mo,model:u.a4,light:Ya,"light-3d":Ka,terrain:Qa,fog:Ul,string:Xa,formatted:function(f){return 0===Xa(f).length?[]:Ns(f)},resolvedImage:function(f){return 0===Xa(f).length?[]:Ns(f)},projection:function(f){const r=f.value,l=f.styleSpec,p=l.projection,y=f.style;let v=[];const b=u.J(r);if("object"===b)for(const D in r)v=v.concat(Di({key:D,value:r[D],valueSpec:p[D],style:y,styleSpec:l}));else"string"!==b&&(v=v.concat([new u.V("projection",r,`object or string expected, ${b} found`)]));return v},import:function(f){const{value:r,styleSpec:l}=f,{data:p,...y}=r;Object.defineProperty(y,"__line__",{value:r.__line__,enumerable:!1});let v=ts(u.L({},f,{value:y,valueSpec:l.import}));return""===u.M(y.id)&&v.push(new u.V(`${f.key}.id`,y,"import id can't be an empty string")),p&&(v=v.concat(Bd(p,l,{key:`${f.key}.data`}))),v},iconset:function(f){const r=f.value,l=f.key,p=f.styleSpec,y=f.style;if(!r.type)return[new u.V(l,r,'"type" is required')];const v=u.M(r.type);let b=[];if(b=b.concat(ts({key:l,value:r,valueSpec:p[`iconset_${v}`],style:y,styleSpec:p})),"source"===v&&r.source){const D=y.sources&&y.sources[r.source],C=D&&u.M(D.type);D?"raster-array"!==C&&b.push(new u.V(l,r.source,`iconset cannot be used with a source of type ${String(C)}, it only be used with a "raster-array" source type`)):b.push(new u.V(l,r.source,`source "${r.source}" not found`))}return b}};function Di(f,r=!1){const l=f.value,p=f.valueSpec,y=f.styleSpec;if(p.expression&&u.a2(u.M(l)))return Wa(f);if(p.expression&&u.S(u.U(l)))return Ns(f);if(p.type&&Mu[p.type]){const v=Mu[p.type](f);return!0===r&&v.length>0&&"array"===u.J(f.value)?Ns(f):v}return ts(u.L({},f,{valueSpec:p.type?y[p.type]:p}))}function zd(f){const r=f.value,l=f.key,p=Xa(f);return p.length||(-1===r.indexOf("{fontstack}")&&p.push(new u.V(l,r,'"glyphs" url must include a "{fontstack}" token')),-1===r.indexOf("{range}")&&p.push(new u.V(l,r,'"glyphs" url must include a "{range}" token'))),p}function Bd(f,r=u.a5,l={}){return Di({key:l.key||"",value:f,valueSpec:r.$root,styleSpec:r,style:f,objectElementValidators:{glyphs:zd,"*":()=>[]}})}function zs(f,r=u.a5){return ge(Bd(f,r))}const Vd=f=>ge(Mo(f)),Gp=f=>ge(Ya(f)),Pu=f=>ge(Ka(f)),Je=f=>ge(Qa(f)),Ja=f=>ge(Ul(f)),$p=f=>ge(function(r){const l=r.value,p=r.style,y=r.styleSpec,v=y.snow;let b=[];const D=u.J(l);if(void 0===l)return b;if("object"!==D)return b=b.concat([new u.V("snow",l,`object expected, ${D} found`)]),b;for(const C in l){const P=C.match(/^(.*)-transition$/);b=b.concat(P&&v[P[1]]&&v[P[1]].transition?Di({key:C,value:l[C],valueSpec:y.transition,style:p,styleSpec:y}):v[C]?Di({key:C,value:l[C],valueSpec:v[C],style:p,styleSpec:y}):[new u.K(C,l[C],`unknown property "${C}"`)])}return b}(f)),pf=f=>ge(function(r){const l=r.value,p=r.style,y=r.styleSpec,v=y.rain;let b=[];const D=u.J(l);if(void 0===l)return b;if("object"!==D)return b=b.concat([new u.V("rain",l,`object expected, ${D} found`)]),b;for(const C in l){const P=C.match(/^(.*)-transition$/);b=b.concat(P&&v[P[1]]&&v[P[1]].transition?Di({key:C,value:l[C],valueSpec:y.transition,style:p,styleSpec:y}):v[C]?Di({key:C,value:l[C],valueSpec:v[C],style:p,styleSpec:y}):[new u.K(C,l[C],`unknown property "${C}"`)])}return b}(f)),Rn=f=>ge(Iu(f)),Pe=f=>ge(Pa(f)),Z=f=>ge(ns(f)),X=f=>ge(is(f)),oe=f=>ge(u.a4(f));function ge(f){return f.slice().sort((r,l)=>r.line&&l.line?r.line-l.line:0)}function se(f,r){let l=!1;if(r&&r.length)for(const p of r)p instanceof u.K?u.w(p.message):(f.fire(new u.z(new Error(p.message))),l=!0);return l}let be;class ke extends u.E{constructor(r,l="flat"){super(),this._transitionable=new u.a6(be||(be=new u.a7({anchor:new u.a8(u.a5.light.anchor),position:new u.a9(u.a5.light.position),color:new u.a8(u.a5.light.color),intensity:new u.a8(u.a5.light.intensity)}))),this.setLight(r,l),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(r,l,p={}){this._validate(Gp,r,p)||(this._transitionable.setTransitionOrValue(r),this.id=l)}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}_validate(r,l,p){return(!p||!1!==p.validate)&&se(this,r.call(zs,u.h({value:l,style:{glyphs:!0,sprite:!0},styleSpec:u.a5})))}}let Te=class extends u.E{constructor(f,r,l,p,y){super(),this.scope=l,this._transitionable=new u.a6(new u.a7({source:new u.a8(u.a5.terrain.source),exaggeration:new u.a8(u.a5.terrain.exaggeration)}),l,p),this._transitionable.setTransitionOrValue(f,p),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=r,this.worldview=y}get(){return this._transitionable.serialize()}set(f,r){this._transitionable.setTransitionOrValue(f,r)}updateTransitions(f){this._transitioning=this._transitionable.transitioned(f,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(f){this.properties=this._transitioning.possiblyEvaluate(f)}getExaggeration(f){return this._transitioning.possiblyEvaluate(new u.aa(f,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const f=this._transitionable._values.exaggeration;if(!f)return null;const r=f.value.expression;if(!r)return null;let l=-1,p=-1,y=1;for(const v of r.zoomStops)y=r.evaluate(new u.aa(v,{worldview:this.worldview})),y>.01?(l=v,p=-1):p=v;return y<.01&&l>0&&p>l?[l,p]:null}isZoomDependent(){const f=this._transitionable._values.exaggeration;return null!=f&&null!=f.value&&null!=f.value.expression&&f.value.expression instanceof u.ab}};const Ie=45,st=65,qe=.05;function Lt(f,r,l,p){const y=u.af(Ie,st,l),[v,b]=$t(f,p);let D=1-Math.min(1,Math.exp((r-v)/(b-v)*-6));return D*=D*D,D=Math.min(1,1.00747*D),D*y*f.alpha}function $t(f,r){const l=.5/Math.tan(.5*r);return[f.range[0]+l,f.range[1]+l]}function Zt(f,r,l,p,y){const v=u.ad([],[r,l,p],y.mercatorFogMatrix);return Lt(f,u.ae(v),y.pitch,y._fov)}function bn(f,r,l,p,y,v,b){const D=[[l,p,0],[y,p,0],[y,v,0],[l,v,0]];let C=Number.MAX_VALUE,P=-Number.MAX_VALUE;for(const O of D){const N=u.ad([],O,r),F=u.ae(N);C=Math.min(C,F),P=Math.max(P,F)}return[Lt(f,C,b.pitch,b._fov),Lt(f,P,b.pitch,b._fov)]}class pn extends u.E{constructor(r,l,p,y){super();const v=new u.a7({range:new u.a8(u.a5.fog.range),color:new u.a8(u.a5.fog.color),"color-use-theme":new u.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new u.a8(u.a5.fog["high-color"]),"high-color-use-theme":new u.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new u.a8(u.a5.fog["space-color"]),"space-color-use-theme":new u.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new u.a8(u.a5.fog["horizon-blend"]),"star-intensity":new u.a8(u.a5.fog["star-intensity"]),"vertical-range":new u.a8(u.a5.fog["vertical-range"])});this._transitionable=new u.a6(v,p,new Map(y)),this.set(r,y),this._transitioning=this._transitionable.untransitioned(),this._transform=l,this.properties=new u.ag(v),this.scope=p}get state(){const r=this._transform,l="globe"===r.projection.name,p=u.ah(r.zoom),y=this.properties.get("range"),v=[.5,3];return{range:l?[u.ai(v[0],y[0],p),u.ai(v[1],y[1],p)]:y,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(r,l,p={}){if(this._validate(Ja,r,p))return;const y=u.h({},r);for(const v of Object.keys(u.a5.fog))void 0===y[v]&&(y[v]=u.a5.fog[v].default);this._options=y,this._transitionable.setTransitionOrValue(this._options,l)}getOpacity(r){if(!this._transform.projection.supportsFog)return 0;const l=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:u.af(Ie,st,r))*l.a}getOpacityAtLatLng(r,l){return this._transform.projection.supportsFog?function(p,y,v){const b=u.ac.fromLngLat(y),D=v.elevation?v.elevation.getAtPointOrZero(b):0;return Zt(p,b.x,b.y,D,v)}(this.state,r,l):0}getOpacityForTile(r){if(!this._transform.projection.supportsFog)return[1,1];const l=this._transform.calculateFogTileMatrix(r.toUnwrapped());return bn(this.state,l,0,0,u.aj,u.aj,this._transform)}getOpacityForBounds(r,l,p,y,v){return this._transform.projection.supportsFog?bn(this.state,r,l,p,y,v,this._transform):[1,1]}getFovAdjustedRange(r){return this._transform.projection.supportsFog?$t(this.state,r):[0,1]}isVisibleOnFrustum(r){if(!this._transform.projection.supportsFog)return!1;const l=[4,5,6,7];for(const p of l){const y=r.points[p];let v;if(y[2]>=0)v=y;else{const b=r.points[p-4];v=u.ak(b,y,b[2]/(b[2]-y[2]))}if(Zt(this.state,v[0],v[1],0,this._transform)>=qe)return!0}return!1}updateConfig(r){this._transitionable.setTransitionOrValue(this._options,new Map(r))}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}_validate(r,l,p){return(!p||!1!==p.validate)&&se(this,r.call(zs,u.h({value:l,style:{glyphs:!0,sprite:!0},styleSpec:u.a5})))}}let cn,mi,yn,ir,Cr=class extends u.E{constructor(f,r,l,p){super();const y=cn||(cn=new u.a7({density:new u.a8(u.a5.snow.density),intensity:new u.a8(u.a5.snow.intensity),color:new u.a8(u.a5.snow.color),opacity:new u.a8(u.a5.snow.opacity),vignette:new u.a8(u.a5.snow.vignette),"vignette-color":new u.a8(u.a5.snow["vignette-color"]),"center-thinning":new u.a8(u.a5.snow["center-thinning"]),direction:new u.a8(u.a5.snow.direction),"flake-size":new u.a8(u.a5.snow["flake-size"])}));this._transitionable=new u.a6(y,l,new Map(p)),this.set(f,p),this._transitioning=this._transitionable.untransitioned(),this.properties=new u.ag(y),this.scope=l}get state(){const f=this.properties.get("opacity"),r=this.properties.get("color"),l=this.properties.get("direction"),p=u.al(l[0]),y=-Math.max(u.al(l[1]),.01),v=[Math.cos(p)*Math.cos(y),Math.sin(p)*Math.cos(y),Math.sin(y)],b=this.properties.get("vignette"),D=this.properties.get("vignette-color");return D.a=b,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new u.am(r.r,r.g,r.b,r.a*f),direction:v,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:D}}get(){return this._transitionable.serialize()}set(f,r,l={}){if(this._validate($p,f,l))return;const p=u.h({},f);for(const y of Object.keys(u.a5.snow))void 0===p[y]&&(p[y]=u.a5.snow[y].default);this._options=p,this._transitionable.setTransitionOrValue(this._options,r)}updateConfig(f){this._transitionable.setTransitionOrValue(this._options,new Map(f))}updateTransitions(f){this._transitioning=this._transitionable.transitioned(f,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(f){this.properties=this._transitioning.possiblyEvaluate(f)}_validate(f,r,l){return(!l||!1!==l.validate)&&se(this,f.call(zs,u.h({value:r,style:{glyphs:!0,sprite:!0},styleSpec:u.a5})))}},Lr=class extends u.E{constructor(f,r,l,p){super();const y=mi||(mi=new u.a7({density:new u.a8(u.a5.rain.density),intensity:new u.a8(u.a5.rain.intensity),color:new u.a8(u.a5.rain.color),opacity:new u.a8(u.a5.rain.opacity),vignette:new u.a8(u.a5.rain.vignette),"vignette-color":new u.a8(u.a5.rain["vignette-color"]),"center-thinning":new u.a8(u.a5.rain["center-thinning"]),direction:new u.a8(u.a5.rain.direction),"droplet-size":new u.a8(u.a5.rain["droplet-size"]),"distortion-strength":new u.a8(u.a5.rain["distortion-strength"])}));this._transitionable=new u.a6(y,l,new Map(p)),this.set(f,p),this._transitioning=this._transitionable.untransitioned(),this.properties=new u.ag(y),this.scope=l}get state(){const f=this.properties.get("opacity"),r=this.properties.get("color"),l=this.properties.get("direction"),p=u.al(l[0]),y=-Math.max(u.al(l[1]),.01),v=[Math.cos(p)*Math.cos(y),Math.sin(p)*Math.cos(y),Math.sin(y)],b=this.properties.get("vignette-color");return b.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new u.am(r.r,r.g,r.b,r.a*f),direction:v,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:b}}get(){return this._transitionable.serialize()}set(f,r,l={}){if(this._validate(pf,f,l))return;const p=u.h({},f);for(const y of Object.keys(u.a5.rain))void 0===p[y]&&(p[y]=u.a5.rain[y].default);this._options=p,this._transitionable.setTransitionOrValue(this._options,r)}updateConfig(f){this._transitionable.setTransitionOrValue(this._options,new Map(f))}updateTransitions(f){this._transitioning=this._transitionable.transitioned(f,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(f){this.properties=this._transitioning.possiblyEvaluate(f)}_validate(f,r,l){return(!l||!1!==l.validate)&&se(this,f.call(zs,u.h({value:r,style:{glyphs:!0,sprite:!0},styleSpec:u.a5})))}};class ci extends u.E{constructor(r,l,p,y){super(),this.scope=p,this._options=r,this.properties=new u.ag(l),this._transitionable=new u.a6(l,p,new Map(y)),this._transitionable.setTransitionOrValue(r.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(r){this._transitionable.setTransitionOrValue(this._options.properties,new Map(r))}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(r,l){this._options=r,this._transitionable.setTransitionOrValue(r.properties,l)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}class Vn{constructor(r,l,p){this.screenBounds=r,this.cameraPoint=p.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=l,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,p)}static createFromScreenPoints(r,l){let p,y;if(r instanceof u.P||"number"==typeof r[0]){const v=u.P.convert(r);p=[v],y=l.isPointAboveHorizon(v)}else{const v=u.P.convert(r[0]),b=u.P.convert(r[1]),D=v.add(b)._div(2);p=[v,b],y=u.ao(v,b).every(C=>l.isPointAboveHorizon(C))&&l.isPointAboveHorizon(D)}return new Vn(p,y,l)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(r){return u.ao(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],r)}bufferedCameraGeometry(r){const l=this.screenBounds[0],p=1===this.screenBounds.length?this.screenBounds[0].add(new u.P(1,1)):this.screenBounds[1],y=u.ao(l,p,0,!1);return this.cameraPoint.y>p.y&&(this.cameraPoint.x>l.x&&this.cameraPoint.x<p.x?y.splice(3,0,this.cameraPoint):this.cameraPoint.x>=p.x?y[2]=this.cameraPoint:this.cameraPoint.x<=l.x&&(y[3]=this.cameraPoint)),u.ap(y,r)}bufferedCameraGeometryGlobe(r){const l=this.screenBounds[0],p=1===this.screenBounds.length?this.screenBounds[0].add(new u.P(1,1)):this.screenBounds[1],y=u.ao(l,p,r),v=this.cameraPoint.clone();switch(3*((v.y>l.y)+(v.y>p.y))+((v.x>l.x)+(v.x>p.x))){case 0:y[0]=v,y[4]=v.clone();break;case 1:y.splice(1,0,v);break;case 2:y[1]=v;break;case 3:y.splice(4,0,v);break;case 5:y.splice(2,0,v);break;case 6:y[3]=v;break;case 7:y.splice(3,0,v);break;case 8:y[2]=v}return y}containsTile(r,l,p,y=0){const v=r.queryPadding/l._pixelsPerMercatorPixel+1,b=p?this._bufferedCameraMercator(v,l):this._bufferedScreenMercator(v,l);let D=r.tileID.wrap+(b.unwrapped?y:0);const C=b.polygon.map(q=>u.aq(r.tileTransform,q,D));if(!u.ar(C,0,0,u.aj,u.aj))return;D=r.tileID.wrap+(this.screenGeometryMercator.unwrapped?y:0);const P=this.screenGeometryMercator.polygon.map(q=>u.as(r.tileTransform,q,D)),O=P.map(q=>new u.P(q[0],q[1])),N=l.getFreeCameraOptions().position||new u.ac(0,0,0),F=u.as(r.tileTransform,N,D),B=P.map(q=>{const G=u.at(q,q,F);return u.au(G,G),new u.av(F,G)}),H=u.aw(r,1,l.zoom)*l._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:O,tilespaceRays:B,bufferedTilespaceGeometry:C,bufferedTilespaceBounds:(U=u.ax(C),U.min.x=u.ay(U.min.x,0,u.aj),U.min.y=u.ay(U.min.y,0,u.aj),U.max.x=u.ay(U.max.x,0,u.aj),U.max.y=u.ay(U.max.y,0,u.aj),U),tile:r,tileID:r.tileID,pixelToTileUnitsFactor:H};var U}_bufferedScreenMercator(r,l){const p=Si(r);if(this._screenRaycastCache[p])return this._screenRaycastCache[p];{let y;return y="globe"===l.projection.name?this._projectAndResample(this.bufferedScreenGeometry(r),l):{polygon:this.bufferedScreenGeometry(r).map(v=>l.pointCoordinate3D(v)),unwrapped:!0},this._screenRaycastCache[p]=y,y}}_bufferedCameraMercator(r,l){const p=Si(r);if(this._cameraRaycastCache[p])return this._cameraRaycastCache[p];{let y;return y="globe"===l.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(r),l):{polygon:this.bufferedCameraGeometry(r).map(v=>l.pointCoordinate3D(v)),unwrapped:!0},this._cameraRaycastCache[p]=y,y}}_projectAndResample(r,l){const p=function(v,b){const D=u.az([],b.pixelMatrix,b.globeMatrix),C=[0,-u.aB,0,1],P=[0,u.aB,0,1],O=[0,0,0,1];u.aA(C,C,D),u.aA(P,P,D),u.aA(O,O,D);const N=new u.P(C[0]/C[3],C[1]/C[3]),F=new u.P(P[0]/P[3],P[1]/P[3]),B=u.aC(v,N)&&C[3]<O[3],H=u.aC(v,F)&&P[3]<O[3];if(!B&&!H)return null;const U=function(pe,ae,ce){for(let ue=1;ue<pe.length;ue++){const Me=Vi(ae.pointCoordinate3D(pe[ue-1]).x),ye=Vi(ae.pointCoordinate3D(pe[ue]).x);if(ce<0){if(Me<ye)return{idx:ue,t:-Me/(ye-1-Me)}}else if(ye<Me)return{idx:ue,t:(1-Me)/(ye+1-Me)}}return null}(v,b,B?-1:1);if(!U)return null;const{idx:q,t:G}=U;let Y=q>1?$i(v.slice(0,q),b):[],ee=q<v.length?$i(v.slice(q),b):[];Y=Y.map(pe=>new u.P(Vi(pe.x),pe.y)),ee=ee.map(pe=>new u.P(Vi(pe.x),pe.y));const ne=[...Y];0===ne.length&&ne.push(ee[ee.length-1]);const le=u.ai(ne[ne.length-1].y,(0===ee.length?Y[0]:ee[0]).y,G);let de;return de=B?[new u.P(0,le),new u.P(0,0),new u.P(1,0),new u.P(1,le)]:[new u.P(1,le),new u.P(1,1),new u.P(0,1),new u.P(0,le)],ne.push(...de),0===ee.length?ne.push(Y[0]):ne.push(...ee),{polygon:ne.map(pe=>new u.ac(pe.x,pe.y)),unwrapped:!1}}(r,l);if(p)return p;const y=function(v,b){let D=!1,C=-1/0,P=0;for(let N=0;N<v.length-1;N++)v[N].x>C&&(C=v[N].x,P=N);for(let N=0;N<v.length-1;N++){const F=(P+N)%(v.length-1),B=v[F],H=v[F+1];Math.abs(B.x-H.x)>.5&&(B.x<H.x?(B.x+=1,0===F&&(v[v.length-1].x+=1)):(H.x+=1,F+1===v.length-1&&(v[0].x+=1)),D=!0)}const O=u.aD(b.center.lng);return D&&O<Math.abs(O-1)&&v.forEach(N=>{N.x-=1}),{polygon:v,unwrapped:D}}($i(r,l).map(v=>new u.P(Vi(v.x),v.y)),l);return{polygon:y.polygon.map(v=>new u.ac(v.x,v.y)),unwrapped:y.unwrapped}}}function $i(f,r){return u.aE(f,l=>{const p=r.pointCoordinate3D(l);l.x=p.x,l.y=p.y},1/256)}function Vi(f){return f<0?1+f%1:f%1}function Si(f){return 100*f|0}function Xr(f,r,l,p,y){const v=function(D,C){if(D)return y(D);if(C){if(f.url&&C.tiles&&f.tiles&&delete f.tiles,C.variants){if(!Array.isArray(C.variants))return y(new Error("variants must be an array"));for(const O of C.variants){if(null==O||"object"!=typeof O||O.constructor!==Object)return y(new Error("variant must be an object"));if(!Array.isArray(O.capabilities))return y(new Error("capabilities must be an array"));if(1===O.capabilities.length&&"meshopt"===O.capabilities[0]){C=u.h(C,O);break}}}const P=u.aF(u.h({},C,f),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);P.tiles=r.canonicalizeTileset(P,f.url),y(null,P)}},b=function(D,C,P){if(!D)return null;if(!C&&!P)return D;P=P||D.worldview_default;const O=Object.values(D.language||{});if(0===O.length)return null;const N=Object.values(D.worldview||{});if(0===N.length)return null;const F=O.every(H=>H===C),B=N.every(H=>H===P);return F&&B?D:C in(D.language_options||{})||P in(D.worldview_options||{})?null:D.language_options&&D.worldview_options?D:null}(f.data,l,p);return b?u.q.frame(()=>v(null,b)):f.url?u.n(r.transformRequest(r.normalizeSourceURL(f.url,null,l,p),u.R.Source),v):u.q.frame(()=>{const{data:D,...C}=f;v(null,C)})}function Ho(f,r){const l=Math.pow(2,r.z),p=Math.floor(u.aD(f.getWest())*l),y=Math.floor(u.aH(f.getNorth())*l),v=Math.ceil(u.aD(f.getEast())*l),b=Math.ceil(u.aH(f.getSouth())*l);return r.x>=p&&r.x<v&&r.y>=y&&r.y<b}class _o{constructor(r,l,p){this.bounds=r?u.aG.convert(this.validateBounds(r)):null,this.minzoom=l||0,this.maxzoom=p||24}validateBounds(r){return Array.isArray(r)&&4===r.length?[Math.max(-180,r[0]),Math.max(-90,r[1]),Math.min(180,r[2]),Math.min(90,r[3])]:[-180,-90,180,90]}addExtraBounds(r){if(r){this.extraBounds||(this.extraBounds=[]);for(const l of r)this.extraBounds.push(u.aG.convert(this.validateBounds(l)))}}contains(r){if(r.z>this.maxzoom||r.z<this.minzoom||this.bounds&&!Ho(this.bounds,r))return!1;if(!this.extraBounds)return!0;for(const l of this.extraBounds)if(Ho(l,r))return!0;return!1}static fromTileJSON(r){if(!r.bounds&&!r.extra_bounds)return null;const l=new _o(r.bounds,r.minzoom,r.maxzoom);return l.addExtraBounds(r.extra_bounds),l}}class jd extends u.E{constructor(r,l,p,y){if(super(),this.id=r,this.dispatcher=p,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,u.h(this,u.aF(l,["url","scheme","tileSize","promoteId"])),this._options=u.h({type:"vector"},l),this._collectResourceTiming=!!l.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(y),this._tileWorkers={},this._deduped=new u.aI}load(r){this._loaded=!1,this.fire(new u.A("dataloading",{dataType:"source"}));const l=Array.isArray(this.map._language)?this.map._language.join():this.map._language,p=this.map.getWorldview();this._tileJSONRequest=Xr(this._options,this.map._requestManager,l,p,(y,v)=>{if(this._tileJSONRequest=null,this._loaded=!0,y)l&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${l}`),p&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${p}`),this.fire(new u.z(y));else if(v){if(u.h(this,v),this.hasWorldviews=!!v.worldview_options,v.worldview_default&&(this.worldviewDefault=v.worldview_default),v.vector_layers){this.vectorLayers=v.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const b of v.vector_layers)this.vectorLayerIds.push(b.id),v.worldview&&v.worldview[b.source]&&this.localizableLayerIds.add(b.id)}this.tileBounds=_o.fromTileJSON(v),Uo(v.tiles,this.map._requestManager._customAccessToken),this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))}r&&r(y)})}loaded(){return this._loaded}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}onAdd(r){this.map=r,this.load()}reload(){this.cancelTileJSONRequest();const r=u.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(r))}setTiles(r){return this._options.tiles=r,this.reload(),this}setUrl(r){return this.url=r,this._options.url=r,this.reload(),this}onRemove(r){this.cancelTileJSONRequest()}serialize(){return u.h({},this._options)}loadTile(r,l){const p=r.tileID.canonical.url(this.tiles,this.scheme),y=this.map._requestManager.normalizeTileURL(p),v=this.map._requestManager.transformRequest(y,u.R.Tile),b=this.map.style?this.map.style.getLut(this.scope):null,D=b?{image:b.image.clone()}:null,C={request:v,data:void 0,uid:r.uid,tileID:r.tileID,tileZoom:r.tileZoom,zoom:r.tileID.overscaledZ,maxZoom:this.maxzoom,lut:D,tileSize:this.tileSize*r.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:u.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:r.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:r.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&u.j(p)&&(C.localizableLayerIds=this.localizableLayerIds),C.request.collectResourceTiming=this._collectResourceTiming,r.actor&&"expired"!==r.state)"loading"===r.state?r.reloadCallback=l:r.request=r.actor.send("reloadTile",C,P.bind(this));else if(r.actor=this._tileWorkers[y]=this._tileWorkers[y]||this.dispatcher.getActor(),this.dispatcher.ready)r.request=r.actor.send("loadTile",C,P.bind(this),void 0,!0);else{const O=u.aJ.call({deduped:this._deduped},C,(N,F)=>{N||!F?P.call(this,N):(C.data={cacheControl:F.cacheControl,expires:F.expires,rawData:F.rawData.slice(0)},r.actor&&r.actor.send("loadTile",C,P.bind(this),void 0,!0))},!0);r.request={cancel:O}}function P(O,N){return delete r.request,r.aborted?l(null):O&&404!==O.status?l(O):(N&&N.resourceTiming&&(r.resourceTiming=N.resourceTiming),this.map._refreshExpiredTiles&&N&&r.setExpiryData(N),r.loadVectorData(N,this.map.painter),u.aK(this.dispatcher),l(null),void(r.reloadCallback&&(this.loadTile(r,r.reloadCallback),r.reloadCallback=null)))}}abortTile(r){r.request&&(r.request.cancel(),delete r.request),r.actor&&r.actor.send("abortTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(r,l){r.actor&&r.actor.send("removeTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope}),r.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class so extends u.E{constructor(r,l,p,y){super(),this.id=r,this.dispatcher=p,this.setEventedParent(y),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=u.h({type:"raster"},l),u.h(this,u.aF(l,["url","scheme","tileSize"]))}load(r){this._loaded=!1,this.fire(new u.A("dataloading",{dataType:"source"}));const l=this.map.getWorldview();this._tileJSONRequest=Xr(this._options,this.map._requestManager,null,l,(p,y)=>{this._tileJSONRequest=null,this._loaded=!0,p?this.fire(new u.z(p)):y&&(u.h(this,y),y.raster_layers&&(this.rasterLayers=y.raster_layers,this.rasterLayerIds=this.rasterLayers.map(v=>v.id)),this.tileBounds=_o.fromTileJSON(y),Uo(y.tiles),this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))),r&&r(p)})}loaded(){return this._loaded}onAdd(r){this.map=r,this.load()}reload(){this.cancelTileJSONRequest();const r=u.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(r))}setTiles(r){return this._options.tiles=r,this.reload(),this}setUrl(r){return this.url=r,this._options.url=r,this.reload(),this}onRemove(r){this.cancelTileJSONRequest()}serialize(){return u.h({},this._options)}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}loadTile(r,l){const p=u.q.devicePixelRatio>=2,y=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme),p,this.tileSize);r.request=u.o(this.map._requestManager.transformRequest(y,u.R.Tile),(v,b,D,C)=>(delete r.request,r.aborted?(r.state="unloaded",l(null)):v?(r.state="errored",l(v)):b?(this.map._refreshExpiredTiles&&r.setExpiryData({cacheControl:D,expires:C}),r.setTexture(b,this.map.painter),r.state="loaded",u.aK(this.dispatcher),void l(null)):l(null)))}abortTile(r,l){r.request&&(r.request.cancel(),delete r.request),l&&l()}unloadTile(r,l){r.texture&&r.texture instanceof u.T?(r.destroy(!0),r.texture&&r.texture instanceof u.T&&this.map.painter.saveTileTexture(r.texture)):r.destroy(),l&&l()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Hl extends so{constructor(r,l,p,y){super(r,l,p,y),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=u.h({type:"raster-array"},l)}triggerRepaint(r){const l=this.map.painter._terrain,p=this.map.style.getSourceCache(this.id);l&&l.enabled&&p&&l._clearRenderCacheForTile(p.id,r.tileID),this.map.triggerRepaint()}loadTile(r,l){const p=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),y=this.map._requestManager.transformRequest(p,u.R.Tile),v={request:y,uid:r.uid,tileID:r.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};r.source=this.id,r.scope=this.scope,r.requestParams=y,r.actor||(r.actor=this.dispatcher.getActor());const b=(D,C,P,O)=>{if(delete r.request,r.aborted)return r.state="unloaded",l(null);if(D)return"AbortError"===D.name?void 0:(r.state="errored",l(D));if(this.map._refreshExpiredTiles&&C&&r.setExpiryData({cacheControl:P,expires:O}),this.partial)r.state="empty";else{if(!C)return l(null);r.state="loaded",r._isHeaderLoaded=!0,r._mrt=C}l(null)};r.request=this.partial?r.fetchHeader(void 0,b.bind(this)):r.actor.send("loadTile",v,b.bind(this),void 0,!0)}abortTile(r){r.request&&(r.request.cancel(),delete r.request),r.actor&&r.actor.send("abortTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(r,l){const p=r.texturePerLayer;if(r.flushAllQueues(),p.size){r.destroy(!0);for(const y of p.values())this.map.painter.saveTileTexture(y)}else r.destroy()}prepareTile(r,l,p,y){r._isHeaderLoaded&&("empty"!==r.state&&(r.state="reloading"),r.fetchBand(l,p,y,(v,b)=>{if(v)return r.state="errored",this.fire(new u.z(v)),void this.triggerRepaint(r);b&&(r._isHeaderLoaded=!0,r.setTexturePerLayer(p,b,this.map.painter),r.state="loaded",this.triggerRepaint(r))}))}getInitialBand(r){if(!this.rasterLayers)return 0;const l=this.rasterLayers.find(({id:v})=>v===r),p=l&&l.fields,y=p&&p.bands&&p.bands;return y?y[0]:0}getTextureDescriptor(r,l,p){if(!r)return;const y=l.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!y)return;let v=null;l instanceof u.aN?v=l.paint.get("raster-array-band"):l instanceof u.aO&&(v=l.paint.get("raster-particle-array-band"));const b=v||this.getInitialBand(y);if(null==b)return;if(!r.textureDescriptorPerLayer.get(l.id))return void this.prepareTile(r,y,l.id,b);if(r.updateNeeded(l.id,b)&&!p)return;const D=r.textureDescriptorPerLayer.get(l.id);return Object.assign({},D,{texture:r.texturePerLayer.get(l.id)})}getImages(r,l){const p=new Map;for(const y of r)for(const v of l){const[b,D]=v.split("/"),C=y.getLayer(b);if(!C||!C.hasBand(D)||!C.hasDataForBand(D))continue;const{bytes:P,tileSize:O,buffer:N}=C.getBandView(D),F=O+2*N,B={data:new u.r({width:F,height:F},P),pixelRatio:2,sdf:!1,usvg:!1,version:0};p.set(v,B)}return p}}const mf={vector:jd,raster:so,"raster-dem":class extends so{constructor(f,r,l,p){super(f,r,l,p),this.type="raster-dem",this.maxzoom=22,this._options=u.h({type:"raster-dem"},r),this.encoding=r.encoding||"mapbox"}loadTile(f,r){const l=this.map._requestManager.normalizeTileURL(f.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function p(y,v){y&&(f.state="errored",r(y)),v&&(f.dem=v,f.dem.onDeserialize(),f.needsHillshadePrepare=!0,f.needsDEMTextureUpload=!0,f.state="loaded",r(null))}f.request=u.o(this.map._requestManager.transformRequest(l,u.R.Tile),function(y,v,b,D){if(delete f.request,f.aborted)f.state="unloaded",r(null);else if(y)f.state="errored",r(y);else if(v){this.map._refreshExpiredTiles&&f.setExpiryData({cacheControl:b,expires:D});const C=ImageBitmap&&v instanceof ImageBitmap&&u.t(),P=1-(v.width-u.aL(v.width))/2;P<1||f.neighboringTiles||(f.neighboringTiles=this._getNeighboringTiles(f.tileID));const O=C?v:u.q.getImageData(v,P),N={uid:f.uid,tileID:f.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:O,encoding:this.encoding,padding:P};f.actor&&"expired"!==f.state||(f.actor=this.dispatcher.getActor(),f.actor.send("loadTile",N,p.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(f){const r=f.canonical,l=Math.pow(2,r.z),p=(r.x-1+l)%l,y=0===r.x?f.wrap-1:f.wrap,v=(r.x+1+l)%l,b=r.x+1===l?f.wrap+1:f.wrap,D={};return D[new u.aM(f.overscaledZ,y,r.z,p,r.y).key]={backfilled:!1},D[new u.aM(f.overscaledZ,b,r.z,v,r.y).key]={backfilled:!1},r.y>0&&(D[new u.aM(f.overscaledZ,y,r.z,p,r.y-1).key]={backfilled:!1},D[new u.aM(f.overscaledZ,f.wrap,r.z,r.x,r.y-1).key]={backfilled:!1},D[new u.aM(f.overscaledZ,b,r.z,v,r.y-1).key]={backfilled:!1}),r.y+1<l&&(D[new u.aM(f.overscaledZ,y,r.z,p,r.y+1).key]={backfilled:!1},D[new u.aM(f.overscaledZ,f.wrap,r.z,r.x,r.y+1).key]={backfilled:!1},D[new u.aM(f.overscaledZ,b,r.z,v,r.y+1).key]={backfilled:!1}),D}},"raster-array":Hl,geojson:class extends u.E{constructor(f,r,l,p){super(),this.id=f,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=l.getActor(),this.setEventedParent(p),this._data=r.data,this._options=u.h({},r),this._collectResourceTiming=r.collectResourceTiming,void 0!==r.maxzoom&&(this.maxzoom=r.maxzoom),void 0!==r.minzoom&&(this.minzoom=r.minzoom),r.type&&(this.type=r.type),r.attribution&&(this.attribution=r.attribution),this.promoteId=r.promoteId;const y=u.aj/this.tileSize;this.workerOptions=u.h({source:this.id,scope:this.scope,cluster:r.cluster||!1,geojsonVtOptions:{buffer:(void 0!==r.buffer?r.buffer:128)*y,tolerance:(void 0!==r.tolerance?r.tolerance:.375)*y,extent:u.aj,maxZoom:this.maxzoom,lineMetrics:r.lineMetrics||!1,generateId:r.generateId||!1},superclusterOptions:{maxZoom:void 0!==r.clusterMaxZoom?r.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,r.clusterMinPoints||2),extent:u.aj,radius:(void 0!==r.clusterRadius?r.clusterRadius:50)*y,log:!1,generateId:r.generateId||!1},clusterProperties:r.clusterProperties,filter:r.filter,dynamic:r.dynamic},r.workerOptions)}onAdd(f){this.map=f,this.setData(this._data)}setData(f){return this._data=f,this._updateWorkerData(),this}updateData(f){if(!this._options.dynamic)return this.fire(new u.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof f&&("Feature"===f.type&&(f={type:"FeatureCollection",features:[f]}),"FeatureCollection"!==f.type))return this.fire(new u.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof f&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const r=new Map;for(const l of this._data.features)r.set(l.id,l);for(const l of f.features)r.set(l.id,l);this._data.features=[...r.values()]}else this._data=f;return this._updateWorkerData(!0),this}getClusterExpansionZoom(f,r){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:f,source:this.id,scope:this.scope},r),this}getClusterChildren(f,r){return this.actor.send("geojson.getClusterChildren",{clusterId:f,source:this.id,scope:this.scope},r),this}getClusterLeaves(f,r,l,p){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:f,limit:r,offset:l},p),this}_updateWorkerData(f=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new u.A("dataloading",{dataType:"source"})),this._loaded=!1;const r=u.h({append:f},this.workerOptions);r.scope=this.scope;const l=this._data;"string"==typeof l?(r.request=this.map._requestManager.transformRequest(u.q.resolveURL(l),u.R.Source),r.request.collectResourceTiming=this._collectResourceTiming):r.data=JSON.stringify(l),this._pendingLoad=this.actor.send(`${this.type}.loadData`,r,(p,y)=>{if(this._loaded=!0,this._pendingLoad=null,p)this.fire(new u.z(p));else{const v={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&y&&y.resourceTiming&&y.resourceTiming[this.id]&&(v.resourceTiming=y.resourceTiming[this.id]),f&&(this._partialReload=!0),this.fire(new u.A("data",v)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(f),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const f=u.C(this.id,this.scope);this.map.style.clearSource(f),this._updateWorkerData()}loadTile(f,r){const l=f.actor?"reloadTile":"loadTile";f.actor=this.actor;const p=this.map.style?this.map.style.getLut(this.scope):null,y=p?{image:p.image.clone()}:null,v=this._partialReload,b={type:this.type,uid:f.uid,tileID:f.tileID,tileZoom:f.tileZoom,zoom:f.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:y,scope:this.scope,pixelRatio:u.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:f.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:v,worldview:this.map.getWorldview()};f.request=this.actor.send(l,b,(D,C)=>v&&!C?(f.state="loaded",r(null)):(delete f.request,f.destroy(),f.aborted?r(null):D?r(D):(f.loadVectorData(C,this.map.painter,"reloadTile"===l),r(null))),void 0,"loadTile"===l)}abortTile(f){f.request&&(f.request.cancel(),delete f.request),f.aborted=!0}unloadTile(f,r){this.actor.send("removeTile",{uid:f.uid,type:this.type,source:this.id,scope:this.scope}),f.destroy()}onRemove(f){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return u.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends u.aP{constructor(f,r,l,p){super(f,r,l,p),this.roundZoom=!0,this.type="video",this.options=r}load(){this._loaded=!1;const f=this.options;this.urls=[];for(const r of f.urls)this.urls.push(this.map._requestManager.transformRequest(r,u.R.Source).url);u.aQ(this.urls,(r,l)=>{this._loaded=!0,r?this.fire(new u.z(r)):l&&(this.video=l,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(f){if(this.video){const r=this.video.seekable;f<r.start(0)||f>r.end(0)?this.fire(new u.z(new u.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${r.start(0)} and ${r.end(0)}-second mark.`))):this.video.currentTime=f}}getVideo(){return this.video}onAdd(f){this.map||(this.map=f,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const f=this.map.painter.context,r=f.gl;this.texture?this.video.paused||(this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),r.texSubImage2D(r.TEXTURE_2D,0,0,0,r.RGBA,r.UNSIGNED_BYTE,this.video)):(this.texture=new u.T(f,this.video,r.RGBA8),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(f)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:u.aP,model:class extends u.E{constructor(f,r,l,p){super(),this.id=f,this.type="model",this.models=[],this._loaded=!1,this._options=r}load(){const f=[];for(const r in this._options.models){const l=this._options.models[r],p=u.aS(this.map._requestManager.transformRequest(l.uri,u.R.Model).url).then(y=>{if(!y)return;const v=u.aT(y),b=new u.aU(r,l.position,l.orientation,v);b.computeBoundsAndApplyParent(),this.models.push(b)}).catch(y=>{this.fire(new u.z(new Error(`Could not load model ${r} from ${l.uri}: ${y.message}`)))});f.push(p)}Promise.allSettled(f).then(()=>{this._loaded=!0,this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(r=>{this._loaded=!0,this.fire(new u.z(new Error(`Could not load models: ${r.message}`)))})}onAdd(f){this.map=f,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(f,r){}serialize(){return this._options}},"batched-model":class extends u.E{constructor(f,r,l,p){super(),this.type="batched-model",this.id=f,this.tileSize=512,this._options=r,this.tiles=this._options.tiles,this.maxzoom=r.maxzoom||19,this.minzoom=r.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=l,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(p)}onAdd(f){this.map=f,this.load()}reload(){this.cancelTileJSONRequest();const f=u.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(f))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(f){this._loaded=!1,this.fire(new u.A("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,l=this.map.getWorldview();this._tileJSONRequest=Xr(this._options,this.map._requestManager,r,l,(p,y)=>{this._tileJSONRequest=null,this._loaded=!0,p?(r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),l&&2!==l.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${l}`),this.fire(new u.z(p))):y&&(u.h(this,y),y.bounds&&(this.tileBounds=new _o(y.bounds,this.minzoom,this.maxzoom)),Uo(y.tiles,this.map._requestManager._customAccessToken),this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))),f&&f(p)})}hasTransition(){return!1}hasTile(f){return!this.tileBounds||this.tileBounds.contains(f.canonical)}loaded(){return this._loaded}loadTile(f,r){const l=this.map._requestManager.normalizeTileURL(f.tileID.canonical.url(this.tiles,this.scheme)),p={request:this.map._requestManager.transformRequest(l,u.R.Tile),data:void 0,uid:f.uid,tileID:f.tileID,tileZoom:f.tileZoom,zoom:f.tileID.overscaledZ,tileSize:this.tileSize*f.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:f.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:u.q.devicePixelRatio,promoteId:this.promoteId};if(f.actor&&"expired"!==f.state)if("loading"===f.state)f.reloadCallback=r;else{if(f.buckets){const v=Object.values(f.buckets);for(const b of v)b.dirty=!0;return void(f.state="loaded")}f.request=f.actor.send("reloadTile",p,y.bind(this))}else f.actor=this.dispatcher.getActor(),f.request=f.actor.send("loadTile",p,y.bind(this),void 0,!0);function y(v,b){return f.aborted?r(null):v&&404!==v.status?r(v):(this.map._refreshExpiredTiles&&b&&f.setExpiryData(b),f.loadModelData(b,this.map.painter),f.state="loaded",void r(null))}}serialize(){return u.h({},this._options)}},canvas:class extends u.aP{constructor(f,r,l,p){super(f,r,l,p),r.coordinates?Array.isArray(r.coordinates)&&4===r.coordinates.length&&!r.coordinates.some(y=>!Array.isArray(y)||2!==y.length||y.some(v=>"number"!=typeof v))||this.fire(new u.z(new u.V(`sources.${f}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new u.z(new u.V(`sources.${f}`,null,'missing required property "coordinates"'))),r.animate&&"boolean"!=typeof r.animate&&this.fire(new u.z(new u.V(`sources.${f}`,null,'optional "animate" property must be a boolean value'))),r.canvas?"string"==typeof r.canvas||r.canvas instanceof HTMLCanvasElement||this.fire(new u.z(new u.V(`sources.${f}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new u.z(new u.V(`sources.${f}`,null,'missing required property "canvas"'))),this.options=r,this.animate=void 0===r.animate||r.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new u.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(f){this.map=f,this.load(),this.canvas&&this.animate&&this.play()}onRemove(f){this.pause()}prepare(){let f=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,f=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,f=!0),this._hasInvalidDimensions()||0===Object.keys(this.tiles).length)return;const r=this.map.painter.context;this.texture?!f&&!this._playing||this.texture instanceof u.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new u.T(r,this.canvas,r.gl.RGBA8,{premultiply:!0}),this._prepareData(r)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const f of[this.canvas.width,this.canvas.height])if(isNaN(f)||f<=0)return!0;return!1}},custom:class extends u.E{constructor(f,r,l,p){super(),this.id=f,this.type="custom",this._dataType="raster",this._dispatcher=l,this._implementation=r,this.setEventedParent(p),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new u.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new u.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new _o(this._implementation.bounds,this.minzoom,this.maxzoom)),r.update=this._update.bind(this),r.clearTiles=this._clearTiles.bind(this),r.coveringTiles=this._coveringTiles.bind(this),u.h(this,u.aF(r,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return u.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(f){this.map=f,this._loaded=!1,this.fire(new u.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(f),this.load()}onRemove(f){this._implementation.onRemove&&this._implementation.onRemove(f)}hasTile(f){if(this._implementation.hasTile){const{x:r,y:l,z:p}=f.canonical;return this._implementation.hasTile({x:r,y:l,z:p})}return!this.tileBounds||this.tileBounds.contains(f.canonical)}loadTile(f,r){const{x:l,y:p,z:y}=f.tileID.canonical,v=new AbortController;f.request=Promise.resolve(this._implementation.loadTile({x:l,y:p,z:y},{signal:v.signal})).then(function(b){return delete f.request,f.aborted?(f.state="unloaded",r(null)):void 0===b?(f.state="errored",r(null)):null===b?(this.loadTileData(f,{width:this.tileSize,height:this.tileSize,data:null}),f.state="loaded",r(null)):(D=b)instanceof ImageData||D instanceof HTMLCanvasElement||D instanceof ImageBitmap||D instanceof HTMLImageElement?(this.loadTileData(f,b),f.state="loaded",void r(null)):(f.state="errored",r(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)));var D}.bind(this)).catch(b=>{"AbortError"!==b.name&&(f.state="errored",r(b))}),f.request.cancel=()=>v.abort()}loadTileData(f,r){f.setTexture(r,this.map.painter)}unloadTile(f,r){if(f.texture&&f.texture instanceof u.T?(f.destroy(!0),f.texture&&f.texture instanceof u.T&&this.map.painter.saveTileTexture(f.texture)):f.destroy(),this._implementation.unloadTile){const{x:l,y:p,z:y}=f.tileID.canonical;this._implementation.unloadTile({x:l,y:p,z:y})}r&&r()}abortTile(f,r){f.request&&f.request.cancel&&(f.request.cancel(),delete f.request),r&&r()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(f=>({x:f.canonical.x,y:f.canonical.y,z:f.canonical.z}))}_clearTiles(){const f=u.C(this.id,this.scope);this.map.style.clearSource(f)}_update(){this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))}}},Ru=function(f,r,l,p){const y=new mf[r.type](f,r,l,p);if(y.id!==f)throw new Error(`Expected Source id to be ${f} instead of ${y.id}`);return u.aV(["load","abort","unload","serialize","prepare"],y),y};function Ud(f,r,l=""){return`${l}:${r.id||""}:${r.layer.id}:${function(p){if("layerId"in p)return`layer:${p.layerId}`;{const{featuresetId:y,importId:v}=p;return`featureset:${y}${v?`:import:${v}`:""}`}}(f.target)}`}function gf(f,r,l,p=""){if(f.uniqueFeatureID){const y=Ud(f,r,p);if(l.has(y))return!0;l.add(y)}return!1}function el(f,r,l,p,y=!1){const v=r.sourceCache.transform,b=r.sourceCache.tilesIn(f,r.has3DLayers,y);b.sort(Dc);const D=[];for(const C of b){const P=C.tile.queryRenderedFeatures(r,C,l,p,v,y);Object.keys(P).length&&D.push({wrappedTileID:C.tile.tileID.wrapped().key,queryResults:P})}return 0===D.length?{}:function(C){const P={},O={};for(const N of C){const F=N.queryResults,B=N.wrappedTileID,H=O[B]=O[B]||{};for(const U in F){const q=F[U],G=H[U]=H[U]||{},Y=P[U]=P[U]||[];for(const ee of q)G[ee.featureIndex]||(G[ee.featureIndex]=!0,Y.push(ee))}}return P}(D)}function tl(f,r,l,p,y,v){const b={},D=p.queryRenderedSymbols(f),C=[];for(const P of Object.keys(D).map(Number))C.push(y[P]);C.sort(Dc);for(const P of C){const O=P.featureIndex.lookupSymbolFeatures(D[P.bucketInstanceId],P.bucketIndex,P.sourceLayerIndex,r,l,v);for(const N in O){const F=b[N]=b[N]||[],B=O[N];B.sort((H,U)=>{const q=P.featureSortOrder;if(q){const G=q.indexOf(H.featureIndex);return q.indexOf(U.featureIndex)-G}return U.featureIndex-H.featureIndex});for(const H of B)F.push(H)}}return b}function Ou(f,r){const l=f.getRenderableIds().map(v=>f.getTileByID(v)),p=[],y={};for(let v=0;v<l.length;v++){const b=l[v],D=b.tileID.canonical.key;y[D]||(y[D]=!0,b.querySourceFeatures(p,r))}return p}function Dc(f,r){const l=f.tileID,p=r.tileID;return l.overscaledZ-p.overscaledZ||l.canonical.y-p.canonical.y||l.wrap-p.wrap||l.canonical.x-p.canonical.x}function Zs(f,r){const l={};if(!r)return l;for(const p of f){const y=p.layerIds.map(v=>r.getLayer(v)).filter(Boolean);if(0!==y.length){p.layers=y,p.stateDependentLayerIds&&(p.stateDependentLayers=p.stateDependentLayerIds.map(v=>y.filter(b=>b.id===v)[0]));for(const v of y)l[v.fqid]=p}}return l}const Ra=new Uint16Array(8184);for(let f=0;f<2046;f++){let r=f+2,l=0,p=0,y=0,v=0,b=0,D=0;for(1&r?y=v=b=32:l=p=D=32;(r>>=1)>1;){const P=l+y>>1,O=p+v>>1;1&r?(y=l,v=p,l=b,p=D):(l=y,p=v,y=b,v=D),b=P,D=O}const C=4*f;Ra[C+0]=l,Ra[C+1]=p,Ra[C+2]=y,Ra[C+3]=v}const ha=new Uint16Array(2178),Ci=new Uint8Array(1089),Gl=new Uint16Array(1089);function ur(f){return 0===f?-.03125:32===f?.03125:0}const Sc={type:2,extent:u.aj,loadGeometry:()=>[[new u.P(0,0),new u.P(u.aj+1,0),new u.P(u.aj+1,u.aj+1),new u.P(0,u.aj+1),new u.P(0,0)]]};class Cc{constructor(r,l,p,y,v,b){this.tileID=r,this.uid=u.a$(),this.uses=0,this.tileSize=l,this.tileZoom=p,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=v,y&&y.style&&(this._lastUpdatedBrightness=y.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",y&&y.transform&&(this.projection=y.transform.projection),this.worldview=b}registerFadeDuration(r){const l=r+this.timeAdded;l<u.q.now()||this.fadeEndTime&&l<this.fadeEndTime||(this.fadeEndTime=l)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=u.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(r,l,p){if(this.unloadVectorData(),this.state="loaded",r){r.featureIndex&&(this.latestFeatureIndex=r.featureIndex,r.rawTileData?(this.latestRawTileData=r.rawTileData,this.latestFeatureIndex.rawTileData=r.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=r.collisionBoxArray,this.buckets=Zs(r.buckets,l.style),this.hasSymbolBuckets=!1;for(const y in this.buckets){const v=this.buckets[y];if(v instanceof u.b1){if(this.hasSymbolBuckets=!0,!p)break;v.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const y in this.buckets){const v=this.buckets[y];if(v instanceof u.b1&&v.hasRTLText){this.hasRTLText=!0,u.b2();break}}this.queryPadding=0;for(const y in this.buckets){const v=this.buckets[y],b=l.style.getOwnLayer(y);if(!b)continue;const D=b.queryRadius(v);this.queryPadding=Math.max(this.queryPadding,D)}r.imageAtlas&&(this.imageAtlas=r.imageAtlas),r.glyphAtlasImage&&(this.glyphAtlasImage=r.glyphAtlasImage),r.lineAtlas&&(this.lineAtlas=r.lineAtlas),this._lastUpdatedBrightness=r.brightness}else this.collisionBoxArray=new u.b0}unloadVectorData(){if(this.hasData()){for(const r in this.buckets)this.buckets[r].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(r,l,p){r&&(r.resourceTiming&&(this.resourceTiming=r.resourceTiming),this.buckets=Object.assign({},this.buckets,Zs(r.buckets,l.style)),r.featureIndex&&(this.latestFeatureIndex=r.featureIndex))}getBucket(r){return this.buckets[r.fqid]}upload(r){for(const y in this.buckets){const v=this.buckets[y];v.uploadPending()&&v.upload(r)}const l=r.gl,p=this.imageAtlas;p&&!p.uploaded&&(this.imageAtlasTexture=new u.T(r,p.image,l.RGBA8,{useMipmap:!!p.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new u.T(r,this.glyphAtlasImage,l.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new u.T(r,this.lineAtlas.image,l.R8),this.lineAtlas.uploaded=!0)}prepare(r,l,p){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(r,this.imageAtlasTexture,p),!l||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const y=l.style.getBrightness();(this._lastUpdatedBrightness||y)&&(this._lastUpdatedBrightness&&y&&Math.abs(this._lastUpdatedBrightness-y)<.001||(this.updateBuckets(l,this._lastUpdatedBrightness!==y),this._lastUpdatedBrightness=y))}queryRenderedFeatures(r,l,p,y,v,b){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const D=function(C,P){const O=u.bn([],[.5*C.width,.5*-C.height,1]);return u.bo(O,O,[1,-1,0]),u.az(O,O,C.calculateProjMatrix(P.toUnwrapped())),Float32Array.from(O)}(v,this.tileID);return this.latestFeatureIndex.query(r,{tilespaceGeometry:l,pixelPosMatrix:D,transform:y,availableImages:p,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(r,l){const p=this.latestFeatureIndex;if(!p||!p.rawTileData)return;const y=p.loadVTLayers(),v=l?l.sourceLayer:"",b=y._geojsonTileLayer||y[v];if(!b)return;const D=u.b3(l&&l.filter),{z:C,x:P,y:O}=this.tileID.canonical,N={z:C,x:P,y:O};for(let F=0;F<b.length;F++){const B=b.feature(F);if(D.needGeometry){const q=u.b4(B,!0);if(!D.filter(new u.aa(this.tileID.overscaledZ,{worldview:this.worldview}),q,this.tileID.canonical))continue}else if(!D.filter(new u.aa(this.tileID.overscaledZ,{worldview:this.worldview}),B))continue;const H=p.getId(B,v),U=new u.b5(B,C,P,O,H);U.tile=N,r.push(U)}}loaded(){return"loaded"===this.state||"errored"===this.state}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(r){const l=this.expirationTime;if(r.cacheControl){const p=u.b6(r.cacheControl);p["max-age"]&&(this.expirationTime=Date.now()+1e3*p["max-age"])}else r.expires&&(this.expirationTime=new Date(r.expires).getTime());if(this.expirationTime){const p=Date.now();let y=!1;if(this.expirationTime>p)y=!1;else if(l)if(this.expirationTime<l)y=!0;else{const v=this.expirationTime-l;v?this.expirationTime=p+Math.max(v,3e4):y=!0}else y=!0;y?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(r){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&r&&this.updateBuckets(r)}updateBuckets(r,l){if(!this.latestFeatureIndex||!r.style)return;const p=this.latestFeatureIndex.loadVTLayers(),y=r.style.listImages(),v=r.style.getBrightness();for(const b in this.buckets){if(!r.style.hasLayer(b))continue;const D=this.buckets[b],C=D.layers[0],P=C.sourceLayer||"_geojsonTileLayer",O=p[P],N=r.style.getLayerSourceCache(C);let F={};N&&(F=N._state.getState(P,void 0));const B=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},H=Object.keys(F).length>0&&!l;H&&!D.stateDependentLayers.length&&!l||D.update(F,O,y,B,H?D.stateDependentLayers:D.layers,l,v),(D instanceof u.b7||D instanceof u.b8)&&r._terrain&&r._terrain.enabled&&N&&D.uploadPending()&&r._terrain._clearRenderCacheForTile(N.id,this.tileID);const U=r&&r.style&&r.style.getOwnLayer(b);U&&(this.queryPadding=Math.max(this.queryPadding,U.queryRadius(D)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<u.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(r){this.symbolFadeHoldUntil=u.q.now()+r}setTexture(r,l){const p=l.context,y=p.gl;this.texture=this.texture||l.getTileTexture(r.width),this.texture&&this.texture instanceof u.T?this.texture.update(r):(this.texture=new u.T(p,r,y.RGBA8,{useMipmap:!0}),this.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE))}setDependencies(r,l){const p={};for(const y of l)p[y]=!0;this.dependencies[r]=p}hasDependency(r,l){for(const p of r){const y=this.dependencies[p];if(y)for(const v of l)if(y[v])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(r,l){if(!l||"mercator"===l.name||this._tileDebugBuffer)return;const p=u.b9(Sc,this.tileID.canonical,this.tileTransform)[0],y=new u.ba,v=new u.bb;for(let b=0;b<p.length;b++){const{x:D,y:C}=p[b];y.emplaceBack(D,C),v.emplaceBack(b)}v.emplaceBack(0),this._tileDebugIndexBuffer=r.createIndexBuffer(v),this._tileDebugBuffer=r.createVertexBuffer(y,u.bc.members),this._tileDebugSegments=u.bd.simpleSegment(0,0,y.length,v.length)}_makeTileBoundsBuffers(r,l){if(this._tileBoundsBuffer||!l||"mercator"===l.name)return;const p=u.b9(Sc,this.tileID.canonical,this.tileTransform)[0];let y,v;if(this.isRaster){const b=function(D,C){const P=u.aW(D,C),O=Math.pow(2,D.z);for(let q=0;q<33;q++)for(let G=0;G<33;G++){const Y=u.aX((D.x+(G+ur(G))/32)/O),ee=u.aY((D.y+(q+ur(q))/32)/O),ne=C.project(Y,ee),le=33*q+G;ha[2*le+0]=Math.round((ne.x*P.scale-P.x)*u.aj),ha[2*le+1]=Math.round((ne.y*P.scale-P.y)*u.aj)}Ci.fill(0),Gl.fill(0);for(let q=2045;q>=0;q--){const G=4*q,Y=Ra[G+0],ee=Ra[G+1],ne=Ra[G+2],le=Ra[G+3],de=Y+ne>>1,pe=ee+le>>1,ae=de+pe-ee,ce=pe+Y-de,ue=33*ee+Y,Me=33*le+ne,ye=33*pe+de,je=Math.hypot((ha[2*ue+0]+ha[2*Me+0])/2-ha[2*ye+0],(ha[2*ue+1]+ha[2*Me+1])/2-ha[2*ye+1])>=16;Ci[ye]=Ci[ye]||(je?1:0),q<1022&&(Ci[ye]=Ci[ye]||Ci[33*(ee+ce>>1)+(Y+ae>>1)]||Ci[33*(le+ce>>1)+(ne+ae>>1)])}const N=new u.aZ,F=new u.a_;let B=0;function H(q,G){const Y=33*G+q;return 0===Gl[Y]&&(N.emplaceBack(ha[2*Y+0],ha[2*Y+1],q*u.aj/32,G*u.aj/32),Gl[Y]=++B),Gl[Y]-1}function U(q,G,Y,ee,ne,le){const de=q+Y>>1,pe=G+ee>>1;if(Math.abs(q-ne)+Math.abs(G-le)>1&&Ci[33*pe+de])U(ne,le,q,G,de,pe),U(Y,ee,ne,le,de,pe);else{const ae=H(q,G),ce=H(Y,ee),ue=H(ne,le);F.emplaceBack(ae,ce,ue)}}return U(0,0,32,32,32,0),U(32,32,0,0,0,32),{vertices:N,indices:F}}(this.tileID.canonical,l);y=b.vertices,v=b.indices}else{y=new u.aZ,v=new u.a_;for(const{x:D,y:C}of p)y.emplaceBack(D,C,0,0);const b=u.be(y.int16.subarray(0,4*y.length),void 0,4);for(let D=0;D<b.length;D+=3)v.emplaceBack(b[D],b[D+1],b[D+2])}this._tileBoundsBuffer=r.createVertexBuffer(y,u.bf.members),this._tileBoundsIndexBuffer=r.createIndexBuffer(v),this._tileBoundsSegments=u.bd.simpleSegment(0,0,y.length,v.length)}_makeGlobeTileDebugBuffers(r,l){const p=l.projection;if(!p||"globe"!==p.name||l.freezeTileCoverage)return;const y=this.tileID.canonical,v=u.bg(y,l),b=u.bh(v),D=u.ah(l.zoom);let C;D>0&&(C=u.bi(new Float64Array(16),l.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(r,y,l,b,C,D),this._makeGlobeTileDebugTextBuffer(r,y,l,b,C,D)}_globePoint(r,l,p,y,v,b,D){let C=u.bj(r,l,p);if(b){const P=1<<p.z,O=u.aD(y.center.lng),N=u.aH(y.center.lat),F=(p.x+.5)/P-O;let B=0;F>.5?B=-1:F<-.5&&(B=1);let H=(r/u.aj+p.x)/P+B,U=(l/u.aj+p.y)/P;H=(H-O)*y._pixelsPerMercatorPixel+O,U=(U-N)*y._pixelsPerMercatorPixel+N;const q=[H*y.worldSize,U*y.worldSize,0];u.ad(q,q,b),C=u.bk(C,q,D)}return u.ad(C,C,v)}_makeGlobeTileDebugBorderBuffer(r,l,p,y,v,b){const D=new u.ba,C=new u.bb,P=new u.bl,O=(F,B,H,U,q)=>{const G=(H-F)/(q-1),Y=(U-B)/(q-1),ee=D.length;for(let ne=0;ne<q;ne++){const le=F+ne*G,de=B+ne*Y;D.emplaceBack(le,de);const pe=this._globePoint(le,de,l,p,y,v,b);P.emplaceBack(pe[0],pe[1],pe[2]),C.emplaceBack(ee+ne)}},N=u.aj;O(0,0,N,0,16),O(N,0,N,N,16),O(N,N,0,N,16),O(0,N,0,0,16),this._tileDebugIndexBuffer=r.createIndexBuffer(C),this._tileDebugBuffer=r.createVertexBuffer(D,u.bc.members),this._globeTileDebugBorderBuffer=r.createVertexBuffer(P,u.bm.members),this._tileDebugSegments=u.bd.simpleSegment(0,0,D.length,C.length)}_makeGlobeTileDebugTextBuffer(r,l,p,y,v,b){const D=u.aj/4,C=new u.ba,P=new u.a_,O=new u.bl,N=25;P.reserve(32),C.reserve(N),O.reserve(N);const F=(B,H)=>N*B+H;for(let B=0;B<N;B++){const H=B*D;for(let U=0;U<N;U++){const q=U*D;C.emplaceBack(q,H);const G=this._globePoint(q,H,l,p,y,v,b);O.emplaceBack(G[0],G[1],G[2])}}for(let B=0;B<4;B++)for(let H=0;H<4;H++){const U=F(B,H),q=F(B,H+1),G=F(B+1,H),Y=F(B+1,H+1);P.emplaceBack(U,q,G),P.emplaceBack(G,q,Y)}this._tileDebugTextIndexBuffer=r.createIndexBuffer(P),this._tileDebugTextBuffer=r.createVertexBuffer(C,u.bc.members),this._globeTileDebugTextBuffer=r.createVertexBuffer(O,u.bm.members),this._tileDebugTextSegments=u.bd.simpleSegment(0,0,N,32)}destroy(r=!1){for(const l in this.buckets)this.buckets[l].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!r&&this.texture&&this.texture instanceof u.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}u.bp.setPbf(u.bq);class Yi extends Cc{constructor(r,l,p,y,v){super(r,l,p,y,v),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(r){return this._mrt&&this._mrt.getLayer(r)}setTexturePerLayer(r,l,p){const y=p.context,v=y.gl;let b=this.texturePerLayer.get(r)||p.getTileTexture(l.width);b&&b instanceof u.T?b.update(l,{premultiply:!1}):b=new u.T(y,l,v.RGBA8,{premultiply:!1}),this.texturePerLayer.has(r)||this.texturePerLayer.set(r,b)}flushQueues(r){const l=this._workQueuePerLayer.get(r)||[],p=this._fetchQueuePerLayer.get(r)||[];for(;l.length;)l.pop()();for(;p.length;)p.pop()()}flushAllQueues(){for(const r of this._workQueuePerLayer.keys()){const l=this._workQueuePerLayer.get(r)||[];for(;l.length;)l.pop()()}for(const r of this._fetchQueuePerLayer.keys()){const l=this._fetchQueuePerLayer.get(r)||[];for(;l.length;)l.pop()()}}fetchHeader(r=16384,l){const p=this._mrt=new u.bp(30),y=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(r-1)}});return this.entireBuffer=null,this.request=u.br(y,(v,b,D,C)=>{if(v)l(v);else try{const P=p.getHeaderLength(b);if(P>r)return void(this.request=this.fetchHeader(P,l));p.parseHeader(b),this._isHeaderLoaded=!0;let O=0;for(const N of Object.values(p.layers))O=Math.max(O,N.dataIndex[N.dataIndex.length-1].lastByte);b.byteLength>=O&&(this.entireBuffer=b),l(null,this.entireBuffer||b,D,C)}catch(P){l(P)}}),this.request}fetchBand(r,l,p,y){const v=this._mrt;if(!this._isHeaderLoaded||!v)return void y(new Error("Tile header is not ready"));const b=this.actor;if(!b)return void y(new Error("Can't fetch tile band without an actor"));let D;const C=(F,B)=>{if(D.complete(F,B),F)return void y(F);this.updateTextureDescriptor(r,l,p);const H=this.textureDescriptorPerLayer.get(l);y(null,H&&H.img)},P=(F,B)=>{if(F)return y(F);const H=b.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:B,task:D},C,void 0,!0),U=this._workQueuePerLayer.get(l)||[];U.push(()=>{H&&H.cancel(),D.cancel()}),this._workQueuePerLayer.has(l)||this._workQueuePerLayer.set(l,U)},O=v.getLayer(r);if(!O)return void y(new Error(`Unknown sourceLayer "${r}"`));if(O.hasDataForBand(p)){this.updateTextureDescriptor(r,l,p);const F=this.textureDescriptorPerLayer.get(l);return void y(null,F?F.img:null)}const N=O.getDataRange([p]);if(D=v.createDecodingTask(N),!D||D.tasks.length)if(this.flushQueues(l),this.entireBuffer)P(null,this.entireBuffer.slice(N.firstByte,N.lastByte+1));else{const F=Object.assign({},this.requestParams,{headers:{Range:`bytes=${N.firstByte}-${N.lastByte}`}}),B=u.br(F,P),H=this._fetchQueuePerLayer.get(l)||[];H.push(()=>{B.cancel(),D.cancel()}),this._fetchQueuePerLayer.has(l)||this._fetchQueuePerLayer.set(l,H)}else y(null)}updateNeeded(r,l){return(!this.textureDescriptorPerLayer.get(r)||this.textureDescriptorPerLayer.get(r).band!==l)&&"errored"!==this.state}updateTextureDescriptor(r,l,p){if(!this._mrt)return;const y=this._mrt.getLayer(r);if(!y||!y.hasBand(p)||!y.hasDataForBand(p))return;const{bytes:v,tileSize:b,buffer:D,offset:C,scale:P}=y.getBandView(p),O=b+2*D,N=new u.r({width:O,height:O},v),F=this.texturePerLayer.get(l);F&&F instanceof u.T&&F.update(N,{premultiply:!1}),this.textureDescriptorPerLayer.set(l,{layer:r,band:p,img:N,buffer:D,offset:C,tileSize:b,format:y.pixelFormat,mix:[P,256*P,65536*P,16777216*P]})}destroy(r=!1){if(super.destroy(r),delete this._mrt,!r)for(const l of this.texturePerLayer.values())l&&l instanceof u.T&&l.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class Nn{constructor(r,l){this.max=r,this.onRemove=l,this.reset()}reset(){for(const r in this.data)for(const l of this.data[r])l.timeout&&clearTimeout(l.timeout),this.onRemove(l.value);return this.data={},this.order=[],this}add(r,l,p){const y=r.wrapped().key;void 0===this.data[y]&&(this.data[y]=[]);const v={value:l,timeout:void 0};if(void 0!==p&&(v.timeout=setTimeout(()=>{this.remove(r,v)},p)),this.data[y].push(v),this.order.push(y),this.order.length>this.max){const b=this._getAndRemoveByKey(this.order[0]);b&&this.onRemove(b)}return this}has(r){return r.wrapped().key in this.data}getAndRemove(r){return this.has(r)?this._getAndRemoveByKey(r.wrapped().key):null}_getAndRemoveByKey(r){const l=this.data[r].shift();return l.timeout&&clearTimeout(l.timeout),0===this.data[r].length&&delete this.data[r],this.order.splice(this.order.indexOf(r),1),l.value}getByKey(r){const l=this.data[r];return l?l[0].value:null}get(r){return this.has(r)?this.data[r.wrapped().key][0].value:null}remove(r,l){if(!this.has(r))return this;const p=r.wrapped().key,y=void 0===l?0:this.data[p].indexOf(l),v=this.data[p][y];return this.data[p].splice(y,1),v.timeout&&clearTimeout(v.timeout),0===this.data[p].length&&delete this.data[p],this.onRemove(v.value),this.order.splice(this.order.indexOf(p),1),this}setMaxSize(r){for(this.max=r;this.order.length>this.max;){const l=this._getAndRemoveByKey(this.order[0]);l&&this.onRemove(l)}return this}filter(r){const l=[];for(const p in this.data)for(const y of this.data[p])r(y.value)||l.push(y);for(const p of l)this.remove(p.value.tileID,p)}}class Hd{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(r,l,p){const y=String(l);if(this.stateChanges[r]=this.stateChanges[r]||{},this.stateChanges[r][y]=this.stateChanges[r][y]||{},u.h(this.stateChanges[r][y],p),null===this.deletedStates[r]){this.deletedStates[r]={};for(const v in this.state[r])v!==y&&(this.deletedStates[r][v]=null)}else if(this.deletedStates[r]&&null===this.deletedStates[r][y]){this.deletedStates[r][y]={};for(const v in this.state[r][y])p[v]||(this.deletedStates[r][y][v]=null)}else for(const v in p)this.deletedStates[r]&&this.deletedStates[r][y]&&null===this.deletedStates[r][y][v]&&delete this.deletedStates[r][y][v]}removeFeatureState(r,l,p){if(null===this.deletedStates[r])return;const y=String(l);if(this.deletedStates[r]=this.deletedStates[r]||{},p&&void 0!==l)null!==this.deletedStates[r][y]&&(this.deletedStates[r][y]=this.deletedStates[r][y]||{},this.deletedStates[r][y][p]=null);else if(void 0!==l)if(this.stateChanges[r]&&this.stateChanges[r][y])for(p in this.deletedStates[r][y]={},this.stateChanges[r][y])this.deletedStates[r][y][p]=null;else this.deletedStates[r][y]=null;else this.deletedStates[r]=null}getState(r,l){const p=this.state[r]||{},y=this.stateChanges[r]||{},v=this.deletedStates[r];if(null===v)return{};if(void 0!==l){const D=String(l),C=u.h({},p[D],y[D]);if(v){const P=v[l];if(null===P)return{};for(const O in P)delete C[O]}return C}const b=u.h({},p,y);if(v)for(const D in v)delete b[D];return b}initializeTileState(r,l){r.refreshFeatureState(l)}coalesceChanges(r,l){const p={};for(const y in this.stateChanges){this.state[y]=this.state[y]||{};const v={};for(const b in this.stateChanges[y])this.state[y][b]||(this.state[y][b]={}),u.h(this.state[y][b],this.stateChanges[y][b]),v[b]=this.state[y][b];p[y]=v}for(const y in this.deletedStates){this.state[y]=this.state[y]||{};const v={};if(null===this.deletedStates[y])for(const b in this.state[y])v[b]={},this.state[y][b]={};else for(const b in this.deletedStates[y]){if(null===this.deletedStates[y][b])this.state[y][b]={};else if(this.state[y][b])for(const D of Object.keys(this.deletedStates[y][b]))delete this.state[y][b][D];v[b]=this.state[y][b]}p[y]=p[y]||{},u.h(p[y],v)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(p).length)for(const y in r)r[y].refreshFeatureState(l)}}class Po extends u.E{constructor(r,l,p){super(),this.id=r,this._onlySymbols=p,l.on("data",y=>{"source"===y.dataType&&"metadata"===y.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===y.dataType&&"content"===y.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))}),l.on("error",()=>{this._sourceErrored=!0}),this._source=l,this._tiles={},this._cache=new Nn(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Hd,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(r){this.map=r,this._minTileCacheSize=void 0===this._minTileCacheSize&&r?r._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&r?r._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const r in this._tiles)if(!this._tiles[r].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const r=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,r&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(r,l){return r.isSymbolTile=this._onlySymbols,r.isExtraShadowCaster=this._shadowCasterTiles[r.tileID.key],this._source.loadTile(r,l)}_unloadTile(r){if(this._source.unloadTile)return this._source.unloadTile(r)}_abortTile(r){if(this._source.abortTile)return this._source.abortTile(r)}serialize(){return this._source.serialize()}prepare(r){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const l in this._tiles){const p=this._tiles[l];p.upload(r),p.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(r=>r.tileID).sort(Fu).map(r=>r.key)}getRenderableIds(r,l){const p=[];for(const y in this._tiles)this._isIdRenderable(+y,r,l)&&p.push(this._tiles[y]);return r?p.sort((y,v)=>{const b=y.tileID,D=v.tileID,C=new u.P(b.canonical.x,b.canonical.y)._rotate(this.transform.angle),P=new u.P(D.canonical.x,D.canonical.y)._rotate(this.transform.angle);return b.overscaledZ-D.overscaledZ||P.y-C.y||P.x-C.x}).map(y=>y.tileID.key):p.map(y=>y.tileID).sort(Fu).map(y=>y.key)}hasRenderableParent(r){const l=this.findLoadedParent(r,0);return!!l&&this._isIdRenderable(l.tileID.key)}_isIdRenderable(r,l,p){return this._tiles[r]&&this._tiles[r].hasData()&&!this._coveredTiles[r]&&(l||!this._tiles[r].holdingForFade())&&(p||!this._shadowCasterTiles[r])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const r in this._tiles)"errored"!==this._tiles[r].state&&this._reloadTile(+r,"reloading")}}_reloadTile(r,l){const p=this._tiles[r];p&&("loading"!==p.state&&(p.state=l),this._loadTile(p,this._tileLoaded.bind(this,p,r,l)))}_tileLoaded(r,l,p,y){if(y)if(r.state="errored",404!==y.status)this._source.fire(new u.z(y,{tile:r}));else{if(this._source.fire(new u.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:r})),!(r.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const v=this.map.painter.terrain;this.update(this.transform,v.getScaledDemTileSize(),!0),v.resetTileLookupCache(this.id)}else this.update(this.transform)}else r.timeAdded=u.q.now(),"expired"===p&&(r.refreshedUponExpiration=!0),this._setTileReloadTimer(l,r),"raster-dem"===this._source.type&&r.dem&&this._backfillDEM(r),this._state.initializeTileState(r,this.map?this.map.painter:null),this._source.fire(new u.A("data",{dataType:"source",tile:r,coord:r.tileID,sourceCacheId:this.id}))}_backfillDEM(r){const l=this.getRenderableIds();for(let y=0;y<l.length;y++){const v=l[y];if(r.neighboringTiles&&r.neighboringTiles[v]){const b=this.getTileByID(v);p(r,b),p(b,r)}}function p(y,v){if(!y.dem||y.dem.borderReady)return;y.needsHillshadePrepare=!0,y.needsDEMTextureUpload=!0;let b=v.tileID.canonical.x-y.tileID.canonical.x;const D=v.tileID.canonical.y-y.tileID.canonical.y,C=Math.pow(2,y.tileID.canonical.z),P=v.tileID.key;0===b&&0===D||Math.abs(D)>1||(Math.abs(b)>1&&(1===Math.abs(b+C)?b+=C:1===Math.abs(b-C)&&(b-=C)),v.dem&&y.dem&&(y.dem.backfillBorder(v.dem,b,D),y.neighboringTiles&&y.neighboringTiles[P]&&(y.neighboringTiles[P].backfilled=!0)))}}getTile(r){return this.getTileByID(r.key)}getTileByID(r){return this._tiles[r]}_retainLoadedChildren(r,l,p,y){for(const v in this._tiles){let b=this._tiles[v];if(y[v]||!b.hasData()||b.tileID.overscaledZ<=l||b.tileID.overscaledZ>p)continue;let D=b.tileID;for(;b&&b.tileID.overscaledZ>l+1;){const P=b.tileID.scaledTo(b.tileID.overscaledZ-1);b=this._tiles[P.key],b&&b.hasData()&&(D=P)}let C=D;for(;C.overscaledZ>l;)if(C=C.scaledTo(C.overscaledZ-1),r[C.key]){y[D.key]=D;break}}}findLoadedParent(r,l){if(r.key in this._loadedParentTiles){const p=this._loadedParentTiles[r.key];return p&&p.tileID.overscaledZ>=l?p:null}for(let p=r.overscaledZ-1;p>=l;p--){const y=r.scaledTo(p),v=this._getLoadedTile(y);if(v)return v}}_getLoadedTile(r){const l=this._tiles[r.key];return l&&l.hasData()?l:this._cache.getByKey(this._source.reparseOverscaled?r.wrapped().key:r.canonical.key)}updateCacheSize(r,l){l=l||this._source.tileSize;const p=Math.ceil(r.width/l)+1,y=Math.ceil(r.height/l)+1,v=Math.floor(p*y*5),b="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,v):v,D="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,b):b;this._cache.setMaxSize(D)}handleWrapJump(r){const l=Math.round((r-(void 0===this._prevLng?r:this._prevLng))/360);if(this._prevLng=r,l){const p={};for(const y in this._tiles){const v=this._tiles[y];v.tileID=v.tileID.unwrapTo(v.tileID.wrap+l),p[v.tileID.key]=v}this._tiles=p;for(const y in this._timers)clearTimeout(this._timers[y]),delete this._timers[y];for(const y in this._tiles)this._setTileReloadTimer(+y,this._tiles[y])}}update(r,l,p,y,v){if(this.transform=r,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!p)return;this.updateCacheSize(r,l),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const b="batched-model"===this._source.type;let D,C=this._source.maxzoom;const P=this.map&&this.map.painter?this.map.painter._terrain:null;if(P&&P.sourceCache===this&&P.attenuationRange()){const F=P.attenuationRange()[0],B=Math.floor(F)-Math.log2(P.getDemUpscale());C>B&&(C=B)}if(this.used||this.usedForTerrain){if(this._source.tileID)D=r.getVisibleUnwrappedCoordinates(this._source.tileID).map(F=>new u.aM(F.canonical.z,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y));else if(0!==this.tileCoverLift){const F=r.clone();F.tileCoverLift=this.tileCoverLift,D=F.coveringTiles({tileSize:l||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:C,roundZoom:this._source.roundZoom&&!p,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.minzoom<=1&&"globe"===r.projection.name&&(D.push(new u.aM(1,0,1,0,0)),D.push(new u.aM(1,0,1,1,0)),D.push(new u.aM(1,0,1,0,1)),D.push(new u.aM(1,0,1,1,1)))}else if(D=r.coveringTiles({tileSize:l||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:C,roundZoom:this._source.roundZoom&&!p,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.hasTile){const F=this._source.hasTile.bind(this._source);D=D.filter(B=>F(B))}}else D=[];if(D.length>0&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!ku(this._source.type)){const F=r.coveringZoomLevel({tileSize:l||this._source.tileSize,roundZoom:this._source.roundZoom&&!p}),B=Math.min(F,this._source.maxzoom);if(b){const H=r.extendTileCover(D,B);for(const U of H)D.push(U)}else if(v){const H=r.extendTileCoverToNearPlane(D,this.transform.getFrustum(B),B);for(const U of H)D.push(U)}else if(this.castsShadows&&y){const H=r.extendTileCover(D,B,y);for(const U of H)this._shadowCasterTiles[U.key]=!0,D.push(U)}}const O=this._updateRetainedTiles(D);if(ku(this._source.type)&&0!==D.length){const F={},B={},H=Object.keys(O);for(const q of H){const G=O[q],Y=this._tiles[q];if(!Y||Y.fadeEndTime&&Y.fadeEndTime<=u.q.now())continue;const ee=this.findLoadedParent(G,Math.max(G.overscaledZ-Po.maxOverzooming,this._source.minzoom));ee&&(this._addTile(ee.tileID),F[ee.tileID.key]=ee.tileID),B[q]=G}const U=D[D.length-1].overscaledZ;for(const q in this._tiles){const G=this._tiles[q];if(O[q]||!G.hasData())continue;let Y=G.tileID;for(;Y.overscaledZ>U;){Y=Y.scaledTo(Y.overscaledZ-1);const ee=this._tiles[Y.key];if(ee&&ee.hasData()&&B[Y.key]){O[q]=G.tileID;break}}}for(const q in F)O[q]||(this._coveredTiles[q]=!0,O[q]=F[q])}for(const F in O)this._tiles[F].clearFadeHold();const N=u.bs(this._tiles,O);for(const F of N){const B=this._tiles[F];B.hasSymbolBuckets&&!B.holdingForFade()?B.setHoldDuration(this.map._fadeDuration):B.hasSymbolBuckets&&!B.symbolFadeFinished()||this._removeTile(+F)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const r in this._tiles)this._tiles[r].holdingForFade()&&this._removeTile(+r)}_updateRetainedTiles(r){const l={};if(0===r.length)return l;const p={},y=r.reduce((P,O)=>Math.min(P,O.overscaledZ),1/0),v=r[0].overscaledZ,b=Math.max(v-Po.maxOverzooming,this._source.minzoom),D=Math.max(v+Po.maxUnderzooming,this._source.minzoom),C={};for(const P of r){const O=this._addTile(P);l[P.key]=P,O.hasData()||y<this._source.maxzoom&&(C[P.key]=P)}this._retainLoadedChildren(C,y,D,l);for(const P of r){let O=this._tiles[P.key];if(O.hasData())continue;if(P.canonical.z>=this._source.maxzoom){const F=P.children(this._source.maxzoom)[0],B=this.getTile(F);if(B&&B.hasData()){l[F.key]=F;continue}}else{const F=P.children(this._source.maxzoom);if(l[F[0].key]&&l[F[1].key]&&l[F[2].key]&&l[F[3].key])continue}let N=O.wasRequested();for(let F=P.overscaledZ-1;F>=b;--F){const B=P.scaledTo(F);if(p[B.key]||(p[B.key]=!0,O=this.getTile(B),!O&&N&&(O=this._addTile(B)),O&&(l[B.key]=B,N=O.wasRequested(),O.hasData())))break}}return l}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const r in this._tiles){const l=[];let p,y=this._tiles[r].tileID;for(;y.overscaledZ>0;){if(y.key in this._loadedParentTiles){p=this._loadedParentTiles[y.key];break}l.push(y.key);const v=y.scaledTo(y.overscaledZ-1);if(p=this._getLoadedTile(v),p)break;y=v}for(const v of l)this._loadedParentTiles[v]=p}}_addTile(r){let l=this._tiles[r.key];if(l)return!0!==l.isExtraShadowCaster||this._shadowCasterTiles[r.key]||this._reloadTile(r.key,"reloading"),l;l=this._cache.getAndRemove(r),l&&(this._setTileReloadTimer(r.key,l),l.tileID=r,this._state.initializeTileState(l,this.map?this.map.painter:null),this._cacheTimers[r.key]&&(clearTimeout(this._cacheTimers[r.key]),delete this._cacheTimers[r.key],this._setTileReloadTimer(r.key,l)));const p=!!l;if(!p){const y=this.map?this.map.painter:null,v=this._source.tileSize*r.overscaleFactor();l="raster-array"===this._source.type?new Yi(r,v,this.transform.tileZoom,y,this._isRaster):new Cc(r,v,this.transform.tileZoom,y,this._isRaster,this._source.worldview),this._loadTile(l,this._tileLoaded.bind(this,l,r.key,l.state))}return l.uses++,this._tiles[r.key]=l,p||this._source.fire(new u.A("dataloading",{tile:l,coord:l.tileID,dataType:"source"})),l}_setTileReloadTimer(r,l){r in this._timers&&(clearTimeout(this._timers[r]),delete this._timers[r]);const p=l.getExpiryTimeout();p&&(this._timers[r]=setTimeout(()=>{this._reloadTile(r,"expired"),delete this._timers[r]},p))}_removeTile(r){const l=this._tiles[r];l&&(l.uses--,delete this._tiles[r],this._timers[r]&&(clearTimeout(this._timers[r]),delete this._timers[r]),l.uses>0||(l.hasData()&&"reloading"!==l.state||"empty"===l.state?this._cache.add(l.tileID,l,l.getExpiryTimeout()):(l.aborted=!0,this._abortTile(l),this._unloadTile(l))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const r in this._tiles)this._removeTile(+r);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(r,l,p){const y=[],v=this.transform;if(!v)return y;const b="globe"===v.projection.name,D=u.aD(v.center.lng);for(const C in this._tiles){const P=this._tiles[C];if(p&&P.clearQueryDebugViz(),P.holdingForFade())continue;let O;if(b){const N=P.tileID.canonical;if(0===N.z){const F=[Math.abs(u.ay(D,...wt(N,-1))-D),Math.abs(u.ay(D,...wt(N,1))-D)];O=[0,2*F.indexOf(Math.min(...F))-1]}else{const F=[Math.abs(u.ay(D,...wt(N,-1))-D),Math.abs(u.ay(D,...wt(N,0))-D),Math.abs(u.ay(D,...wt(N,1))-D)];O=[F.indexOf(Math.min(...F))-1]}}else O=[0];for(const N of O){const F=r.containsTile(P,v,l,N);F&&y.push(F)}}return y}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(r){return this._getRenderableCoordinates(r)}_getRenderableCoordinates(r,l){const p=this.getRenderableIds(r,l).map(v=>this._tiles[v].tileID),y="globe"===this.transform.projection.name;for(const v of p)v.projMatrix=this.transform.calculateProjMatrix(v.toUnwrapped()),v.expandedProjMatrix=y?this.transform.calculateProjMatrix(v.toUnwrapped(),!1,!0):v.projMatrix;return p}sortCoordinatesByDistance(r){const l=r.slice(),p=this.transform._camera.position,y=this.transform._camera.forward(),v={};for(const b of l){const D=1/(1<<b.canonical.z);v[b.key]=((b.canonical.x+.5)*D+b.wrap-p[0])*y[0]+((b.canonical.y+.5)*D-p[1])*y[1]-p[2]*y[2]}return l.sort((b,D)=>v[b.key]-v[D.key]),l}hasTransition(){if(this._source.hasTransition())return!0;if(ku(this._source.type))for(const r in this._tiles){const l=this._tiles[r];if(void 0!==l.fadeEndTime&&l.fadeEndTime>=u.q.now())return!0}return!1}setFeatureState(r,l,p){this._state.updateState(r=r||"_geojsonTileLayer",l,p)}removeFeatureState(r,l,p){this._state.removeFeatureState(r=r||"_geojsonTileLayer",l,p)}getFeatureState(r,l){return this._state.getState(r=r||"_geojsonTileLayer",l)}setDependencies(r,l,p){const y=this._tiles[r];y&&y.setDependencies(l,p)}reloadTilesForDependencies(r,l){for(const p in this._tiles)this._tiles[p].hasDependency(r,l)&&this._reloadTile(+p,"reloading");this._cache.filter(p=>!p.hasDependency(r,l))}_preloadTiles(r,l){if(!this._sourceLoaded){const C=()=>{this._sourceLoaded&&(this._source.off("data",C),this._preloadTiles(r,l))};return void this._source.on("data",C)}const p=new Map,y=Array.isArray(r)?r:[r],v=this.map.painter.terrain,b=this.usedForTerrain&&v?v.getScaledDemTileSize():this._source.tileSize;for(const C of y){const P=C.coveringTiles({tileSize:b,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const O of P)p.set(O.key,O);this.usedForTerrain&&C.updateElevation(!1)}const D=Array.from(p.values());u.bt(D,(C,P)=>{const O=new Cc(C,this._source.tileSize*C.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(O,N=>{"raster-dem"===this._source.type&&O.dem&&this._backfillDEM(O),P(N,O)})},l)}}function Fu(f,r){const l=Math.abs(2*f.wrap)-+(f.wrap<0),p=Math.abs(2*r.wrap)-+(r.wrap<0);return f.overscaledZ-r.overscaledZ||p-l||r.canonical.y-f.canonical.y||r.canonical.x-f.canonical.x}function ku(f){return"raster"===f||"image"===f||"video"===f||"custom"===f}function wt(f,r){const l=1<<f.z;return[f.x/l+r,(f.x+1)/l+r]}Po.maxOverzooming=10,Po.maxUnderzooming=3;class Gd{constructor(r){this.style=r,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];for(const p in this.style._mergedLayers){const y=this.style._mergedLayers[p];if("fill-extrusion"===y.type||"building"===y.type)this.layers.push({layer:y,visible:false,visibilityChanged:false});else if("model"===y.type){const v=this.style.getLayerSource(y);v&&"batched-model"===v.type&&this.layers.push({layer:y,visible:false,visibilityChanged:false})}}}onNewFrame(r){this.layersGotHidden=!1;for(const l of this.layers){const p=l.layer;let y=!1;"fill-extrusion"===p.type?y=!p.isHidden(r)&&p.paint.get("fill-extrusion-opacity")>0:"building"===p.type?y=!p.isHidden(r)&&p.paint.get("building-opacity")>0:"model"===p.type&&(y=!p.isHidden(r)&&p.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!y&&l.visible,l.visible=y}}updateZOffset(r,l){this.currentBuildingBuckets=[];for(const y of this.layers){const v=y.layer,b=this.style.getLayerSourceCache(v);let D=1;"fill-extrusion"===v.type?D=y.visible?v.paint.get("fill-extrusion-vertical-scale"):0:"building"===v.type&&(D=y.visible?v.paint.get("building-vertical-scale"):0);let C=b?b.getTile(l):null;if(!C&&b)for(const P in b._tiles){const O=b._tiles[P];if(l.canonical.isChildOf(O.tileID.canonical)){C=O;break}}this.currentBuildingBuckets.push({bucket:C?C.getBucket(v):null,tileID:C?C.tileID:l,verticalScale:D})}r.hasAnyZOffset=!1;let p=!1;for(let y=0;y<r.symbolInstances.length;y++){const v=r.symbolInstances.get(y),b=v.zOffset,D=this._getHeightAtTileOffset(l,v.tileAnchorX,v.tileAnchorY);v.zOffset=D!==Number.NEGATIVE_INFINITY?D:b,p||b===v.zOffset||(p=!0),r.hasAnyZOffset||0===v.zOffset||(r.hasAnyZOffset=!0)}p&&(r.zOffsetBuffersNeedUpload=!0,r.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(r,l,p,y){let v=l,b=p;if(r.canonical.z!==y.canonical.z){const D=y.canonical,C=1/(1<<r.canonical.z-D.z);v=(l+r.canonical.x*u.aj)*C-D.x*u.aj|0,b=(p+r.canonical.y*u.aj)*C-D.y*u.aj|0}return{tileX:v,tileY:b}}_getHeightAtTileOffset(r,l,p){let y,v;for(let b=0;b<this.layers.length;++b){const D=this.layers[b].layer;if("fill-extrusion"!==D.type&&"building"!==D.type)continue;const{bucket:C,tileID:P,verticalScale:O}=this.currentBuildingBuckets[b];if(!C)continue;const{tileX:N,tileY:F}=this._mapCoordToOverlappingTile(r,l,p,P),B=C.getHeightAtTileCoord(N,F);B&&void 0!==B.height&&(B.hidden?y=B.height:v=Math.max(B.height*O,v||0))}if(void 0!==v)return v;for(let b=0;b<this.layers.length;++b){const D=this.layers[b];if("model"!==D.layer.type||!D.visible)continue;const{bucket:C,tileID:P}=this.currentBuildingBuckets[b];if(!C)continue;const{tileX:O,tileY:N}=this._mapCoordToOverlappingTile(r,l,p,P),F=C.getHeightAtTileCoord(O,N);if(F&&!F.hidden)return void 0===F.height&&void 0!==y?Math.min(F.maxHeight,y)*F.verticalScale:F.height?F.height*F.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function qn(f,r){const l={};for(const p in f)"ref"!==p&&(l[p]=f[p]);return u.bu.forEach(p=>{p in r&&(l[p]=r[p])}),l}function Li(f){f=f.slice();const r=Object.create(null);for(let l=0;l<f.length;l++)r[f[l].id]=f[l];for(let l=0;l<f.length;l++)"ref"in f[l]&&(f[l]=qn(f[l],r[f[l].ref]));return f}const On={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function qp(f,r,l){l.push({command:On.addSource,args:[f,r[f]]})}function Lu(f,r,l){r.push({command:On.removeSource,args:[f]}),l[f]=!0}function Ic(f,r,l,p){Lu(f,l,p),qp(f,r,l)}function Bs(f,r,l){let p;for(p in f[l])if(f[l].hasOwnProperty(p)&&"data"!==p&&!u.bv(f[l][p],r[l][p]))return!1;for(p in r[l])if(r[l].hasOwnProperty(p)&&"data"!==p&&!u.bv(f[l][p],r[l][p]))return!1;return!0}function _f(f,r,l,p,y,v){let b;for(b in r=r||{},f=f||{})f.hasOwnProperty(b)&&(u.bv(f[b],r[b])||l.push({command:v,args:[p,b,r[b],y]}));for(b in r)r.hasOwnProperty(b)&&!f.hasOwnProperty(b)&&(u.bv(f[b],r[b])||l.push({command:v,args:[p,b,r[b],y]}))}function Ac(f){return f.id}function Mc(f,r){return f[r.id]=r,f}function fa(f,r,l){const p=r.createTileMatrix(f,f.worldSize,l.toUnwrapped());return u.az(new Float32Array(16),f.projMatrix,p)}function gv(f,r,l){if(r.projection.name===l.projection.name)return f.projMatrix;const p=l.clone();return p.setProjection(r.projection),fa(p,r.getProjection(),f)}function Wp(f,r,l){return r.name===l.projection.name?f.projMatrix:fa(l,r,f)}class _v{constructor(r,l){this.reset(r,l)}reset(r,l){this.points=r||[],this._distances=[0];for(let p=1;p<this.points.length;p++)this._distances[p]=this._distances[p-1]+this.points[p].dist(this.points[p-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(l||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(r){if(1===this.points.length)return this.points[0];r=u.ay(r,0,1);let l=1,p=this._distances[l];const y=r*this.paddedLength+this.padding;for(;p<y&&l<this._distances.length;)p=this._distances[++l];const v=l-1,b=this._distances[v],D=p-b,C=D>0?(y-b)/D:0;return this.points[v].mult(1-C).add(this.points[l].mult(C))}}class $d{constructor(r,l,p){const y=this.boxCells=[],v=this.circleCells=[];this.xCellCount=Math.ceil(r/p),this.yCellCount=Math.ceil(l/p);for(let b=0;b<this.xCellCount*this.yCellCount;b++)y.push([]),v.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=r,this.height=l,this.xScale=this.xCellCount/r,this.yScale=this.yCellCount/l,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(r,l,p,y,v){this._forEachCell(l,p,y,v,this._insertBoxCell,this.boxUid++),this.boxKeys.push(r),this.bboxes.push(l),this.bboxes.push(p),this.bboxes.push(y),this.bboxes.push(v)}insertCircle(r,l,p,y){this._forEachCell(l-y,p-y,l+y,p+y,this._insertCircleCell,this.circleUid++),this.circleKeys.push(r),this.circles.push(l),this.circles.push(p),this.circles.push(y)}_insertBoxCell(r,l,p,y,v,b){this.boxCells[v].push(b)}_insertCircleCell(r,l,p,y,v,b){this.circleCells[v].push(b)}_query(r,l,p,y,v,b){if(p<0||r>this.width||y<0||l>this.height)return!v&&[];const D=[];if(r<=0&&l<=0&&this.width<=p&&this.height<=y){if(v)return!0;for(let C=0;C<this.boxKeys.length;C++)D.push({key:this.boxKeys[C],x1:this.bboxes[4*C],y1:this.bboxes[4*C+1],x2:this.bboxes[4*C+2],y2:this.bboxes[4*C+3]});for(let C=0;C<this.circleKeys.length;C++){const P=this.circles[3*C],O=this.circles[3*C+1],N=this.circles[3*C+2];D.push({key:this.circleKeys[C],x1:P-N,y1:O-N,x2:P+N,y2:O+N})}return b?D.filter(b):D}return this._forEachCell(r,l,p,y,this._queryCell,D,{hitTest:v,seenUids:{box:{},circle:{}}},b),v?D.length>0:D}_queryCircle(r,l,p,y,v){const b=r-p,D=r+p,C=l-p,P=l+p;if(D<0||b>this.width||P<0||C>this.height)return!y&&[];const O=[];return this._forEachCell(b,C,D,P,this._queryCellCircle,O,{hitTest:y,circle:{x:r,y:l,radius:p},seenUids:{box:{},circle:{}}},v),y?O.length>0:O}query(r,l,p,y,v){return this._query(r,l,p,y,!1,v)}hitTest(r,l,p,y,v){return this._query(r,l,p,y,!0,v)}hitTestCircle(r,l,p,y){return this._queryCircle(r,l,p,!0,y)}_queryCell(r,l,p,y,v,b,D,C){const P=D.seenUids,O=this.boxCells[v];if(null!==O){const F=this.bboxes;for(const B of O)if(!P.box[B]){P.box[B]=!0;const H=4*B;if(r<=F[H+2]&&l<=F[H+3]&&p>=F[H+0]&&y>=F[H+1]&&(!C||C(this.boxKeys[B]))){if(D.hitTest)return b.push(!0),!0;b.push({key:this.boxKeys[B],x1:F[H],y1:F[H+1],x2:F[H+2],y2:F[H+3]})}}}const N=this.circleCells[v];if(null!==N){const F=this.circles;for(const B of N)if(!P.circle[B]){P.circle[B]=!0;const H=3*B;if(this._circleAndRectCollide(F[H],F[H+1],F[H+2],r,l,p,y)&&(!C||C(this.circleKeys[B]))){if(D.hitTest)return b.push(!0),!0;{const U=F[H],q=F[H+1],G=F[H+2];b.push({key:this.circleKeys[B],x1:U-G,y1:q-G,x2:U+G,y2:q+G})}}}}}_queryCellCircle(r,l,p,y,v,b,D,C){const P=D.circle,O=D.seenUids,N=this.boxCells[v];if(null!==N){const B=this.bboxes;for(const H of N)if(!O.box[H]){O.box[H]=!0;const U=4*H;if(this._circleAndRectCollide(P.x,P.y,P.radius,B[U+0],B[U+1],B[U+2],B[U+3])&&(!C||C(this.boxKeys[H])))return b.push(!0),!0}}const F=this.circleCells[v];if(null!==F){const B=this.circles;for(const H of F)if(!O.circle[H]){O.circle[H]=!0;const U=3*H;if(this._circlesCollide(B[U],B[U+1],B[U+2],P.x,P.y,P.radius)&&(!C||C(this.circleKeys[H])))return b.push(!0),!0}}}_forEachCell(r,l,p,y,v,b,D,C){const P=this._convertToXCellCoord(r),O=this._convertToYCellCoord(l),N=this._convertToXCellCoord(p),F=this._convertToYCellCoord(y);for(let B=P;B<=N;B++)for(let H=O;H<=F;H++)if(v.call(this,r,l,p,y,this.xCellCount*H+B,b,D,C))return}_convertToXCellCoord(r){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(r*this.xScale)))}_convertToYCellCoord(r){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(r*this.yScale)))}_circlesCollide(r,l,p,y,v,b){const D=y-r,C=v-l,P=p+b;return P*P>D*D+C*C}_circleAndRectCollide(r,l,p,y,v,b,D){const C=(b-y)/2,P=Math.abs(r-(y+C));if(P>C+p)return!1;const O=(D-v)/2,N=Math.abs(l-(v+O));if(N>O+p)return!1;if(P<=C||N<=O)return!0;const F=P-C,B=N-O;return F*F+B*B<=p*p}}const Pc={unknown:0,flipRequired:1,flipNotRequired:2},yv=Math.tan(85*Math.PI/180);function qd(f,r,l,p,y,v,b){const D=u.bz();if(l)if("globe"===v.name){const C=u.bA(y,r);u.az(D,D,C)}else{const C=u.bB([],b);D[0]=C[0],D[1]=C[1],D[4]=C[2],D[5]=C[3],p||u.by(D,D,y.angle)}else u.az(D,y.labelPlaneMatrix,f);return D}function Wd(f,r,l,p,y,v,b){const D=qd(f,r,l,p,y,v,b);return"globe"===v.name&&l||(D[2]=D[6]=D[10]=D[14]=0),D}function Yr(f,r,l,p,y,v,b){if(l){if("globe"===v.name){const D=qd(f,r,l,p,y,v,b);return u.bi(D,D),u.az(D,f,D),D}{const D=u.bw(f),C=u.bx([]);return C[0]=b[0],C[1]=b[1],C[4]=b[2],C[5]=b[3],u.az(D,D,C),p||u.by(D,D,-y.angle),D}}return y.glCoordMatrix}function _n(f,r,l,p){const y=[f,r,l,1];l?u.aA(y,y,p):Zd(y,y,p);const v=y[3];return y[0]/=v,y[1]/=v,y[2]/=v,y}function Yg(f,r){return Math.min(.5+f/r*.5,1.5)}function Kg(f,r){const l=f[0]/f[3],p=f[1]/f[3];return l>=-r[0]&&l<=r[0]&&p>=-r[1]&&p<=r[1]}function Nu(f,r,l,p,y,v,b,D,C,P){const O=l.transform,N=p?f.textSizeData:f.iconSizeData,F=u.bH(N,l.transform.zoom),B="globe"===O.projection.name,H=[256/l.width*2+1,256/l.height*2+1],U=p?f.text.dynamicLayoutVertexArray:f.icon.dynamicLayoutVertexArray;U.clear();let q=null;B&&(q=p?f.text.globeExtVertexArray:f.icon.globeExtVertexArray);const G=f.lineVertexArray,Y=p?f.text.placedSymbolArray:f.icon.placedSymbolArray,ee=l.transform.width/l.transform.height;let ne,le=!1;for(let de=0;de<Y.length;de++){const pe=Y.get(de),{numGlyphs:ae,writingMode:ce}=pe;if(ce!==u.bI.vertical||le||ne===u.bI.horizontal||(le=!0),ne=ce,(pe.hidden||ce===u.bI.vertical)&&!le){Vu(ae,U);continue}le=!1;const ue=new u.P(pe.tileAnchorX,pe.tileAnchorY);let{x:Me,y:ye,z:je}=O.projection.projectTilePoint(ue.x,ue.y,P.canonical);if(C){const[Mt,kt,vt]=C(ue);Me+=Mt,ye+=kt,je+=vt}const Fe=[Me,ye,je,1];if(u.aA(Fe,Fe,r),!Kg(Fe,H)){Vu(ae,U);continue}const Ge=Fe[3],rt=Yg(l.transform.getCameraToCenterDistance(O.projection),Ge),De=u.bJ(N,F,pe),_e=b?De/rt:De*rt,Ne=_n(Me,ye,je,y);if(Ne[3]<=0){Vu(ae,U);continue}let Re={};const We=u.al(f.layers[0].layout.get("text-max-angle")),Ze=Math.cos(We),Ye=b?null:C,ct=Ir(pe,_e,!1,D,r,y,v,f.glyphOffsetArray,G,U,q,Ne,ue,Re,ee,Ye,O.projection,P,b,Ze);le=ct.useVertical,Ye&&ct.needsFlipping&&(Re={}),(ct.notEnoughRoom||le||ct.needsFlipping&&Ir(pe,_e,!0,D,r,y,v,f.glyphOffsetArray,G,U,q,Ne,ue,Re,ee,Ye,O.projection,P,b,Ze).notEnoughRoom)&&Vu(ae,U)}p?(f.text.dynamicLayoutVertexBuffer.updateData(U),q&&f.text.globeExtVertexBuffer&&f.text.globeExtVertexBuffer.updateData(q)):(f.icon.dynamicLayoutVertexBuffer.updateData(U),q&&f.icon.globeExtVertexBuffer&&f.icon.globeExtVertexBuffer.updateData(q))}function Jt(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q){const{lineStartIndex:G,glyphStartIndex:Y,segment:ee}=D,ne=Y+D.numGlyphs,le=G+D.lineLength,de=r.getoffsetX(Y),pe=r.getoffsetX(ne-1),ae=Bu(f*de,l,p,y,v,b,ee,G,le,C,P,O,N,F,!0,B,H,U,q);if(!ae)return null;const ce=Bu(f*pe,l,p,y,v,b,ee,G,le,C,P,O,N,F,!0,B,H,U,q);return ce?{first:ae,last:ce}:null}function Qg(f,r,l,p){return f===u.bI.horizontal&&Math.abs(p)>Math.abs(l)?{useVertical:!0}:f===u.bI.vertical?p>0?{needsFlipping:!0}:null:r!==Pc.unknown&&(0===(y=l)||Math.abs(p/y)>yv)?r===Pc.flipRequired?{needsFlipping:!0}:null:l<0?{needsFlipping:!0}:null;var y}function Ir(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q,G,Y,ee){const ne=r/24,le=f.lineOffsetX*ne,de=f.lineOffsetY*ne,{lineStartIndex:pe,glyphStartIndex:ae,numGlyphs:ce,segment:ue,writingMode:Me,flipState:ye}=f,je=pe+f.lineLength,Fe=Ge=>{if(O){const[Ne,Re,We]=Ge.up,Ze=P.length;u.bK(O,Ze+0,Ne,Re,We),u.bK(O,Ze+1,Ne,Re,We),u.bK(O,Ze+2,Ne,Re,We),u.bK(O,Ze+3,Ne,Re,We)}const[rt,De,_e]=Ge.point;u.bL(P,rt,De,_e,Ge.angle)};if(ce>1){const Ge=Jt(ne,D,le,de,l,N,F,f,C,v,B,U,!1,q,G,Y,ee);if(!Ge)return{notEnoughRoom:!0};if(p&&!l){let[rt,De,_e]=Ge.first.point,[Ne,Re,We]=Ge.last.point;[rt,De]=_n(rt,De,_e,b),[Ne,Re]=_n(Ne,Re,We,b);const Ze=Qg(Me,ye,(Ne-rt)*H,Re-De);if(f.flipState=Ze&&Ze.needsFlipping?Pc.flipRequired:Pc.flipNotRequired,Ze)return Ze}Fe(Ge.first);for(let rt=ae+1;rt<ae+ce-1;rt++){const De=Bu(ne*D.getoffsetX(rt),le,de,l,N,F,ue,pe,je,C,v,B,U,!1,!1,q,G,Y,ee);if(!De)return P.length-=4*(rt-ae),{notEnoughRoom:!0};Fe(De)}Fe(Ge.last)}else{if(p&&!l){const rt=_n(F.x,F.y,0,y),De=pe+ue+1,_e=new u.P(C.getx(De),C.gety(De)),Ne=_n(_e.x,_e.y,0,y),Re=Ne[3]>0?Ne:Kn(F,_e,rt,1,y,void 0,q,G.canonical),We=Qg(Me,ye,(Re[0]-rt[0])*H,Re[1]-rt[1]);if(f.flipState=We&&We.needsFlipping?Pc.flipRequired:Pc.flipNotRequired,We)return We}const Ge=Bu(ne*D.getoffsetX(ae),le,de,l,N,F,ue,pe,je,C,v,B,U,!1,!1,q,G,Y,ee);if(!Ge)return{notEnoughRoom:!0};Fe(Ge)}return{}}function zu(f,r,l,p,y){const{x:v,y:b,z:D}=p.projectTilePoint(f.x,f.y,r);if(!y)return _n(v,b,D,l);const[C,P,O]=y(f);return _n(v+C,b+P,D+O,l)}function Kn(f,r,l,p,y,v,b,D){const C=zu(f.sub(r)._unit()._add(f),D,y,b,v);return u.at(C,l,C),u.au(C,C),u.bE(C,l,C,p)}function Bu(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q,G,Y){const ee=p?f-r:f+r;let ne=ee>0?1:-1,le=0;p&&(ne*=-1,le=Math.PI),ne<0&&(le+=Math.PI);let de=D+b+(ne>0?0:1)|0,pe=y,ae=y,ce=0,ue=0;const Me=Math.abs(ee),ye=[],je=[];let Fe=v,Ge=Fe,rt=u.bC([]);const De=()=>Kn(Ge,Fe,ae,Me-ce+1,O,F,U,q.canonical);for(;ce+ue<=Me;){if(de+=ne,de<D||de>=C)return null;if(ae=pe,Ge=Fe,ye.push(ae),B&&je.push(Ge),Fe=new u.P(P.getx(de),P.gety(de)),pe=N[de],!pe){const vt=zu(Fe,q.canonical,O,U,F);pe=vt[3]>0?N[de]=vt:De()}ce+=ue;const Mt=u.at([],pe,ae),kt=u.bD(ae,pe);if(l&&kt>0&&ue>0&&u.bG(rt,Mt)/(ue*kt)<Y)return null;ue=kt,rt=Mt}H&&F&&(N[de]&&(pe=De(),ue=u.bD(ae,pe),rt=u.at([],pe,ae)),N[de]=pe);const _e=(Me-ce)/ue,Ne=Fe.sub(Ge)._mult(_e)._add(Ge),Re=u.bE([],ae,rt,_e);let We=[0,0,1],Ze=rt[0],Ye=rt[1];if(G&&(We=U.upVector(q.canonical,Ne.x,Ne.y),0!==We[0]||0!==We[1]||1!==We[2])){const Mt=[We[2],0,-We[0]],kt=u.bF([],We,Mt);u.au(Mt,Mt),u.au(kt,kt),Ze=u.bG(rt,Mt),Ye=u.bG(rt,kt)}if(l){const Mt=u.bF([],We,rt);u.au(Mt,Mt),u.bE(Re,Re,Mt,l*ne)}const ct=le+Math.atan2(Ye,Ze);return ye.push(Re),B&&je.push(Ne),{point:Re,angle:ct,path:ye,tilePath:je,up:We}}function Vu(f,r){const l=r.length,p=l+4*f;r.resize(p),r.float32.fill(-1/0,4*l,4*p)}function Zd(f,r,l){const p=r[0],y=r[1];return f[0]=l[0]*p+l[4]*y+l[12],f[1]=l[1]*p+l[5]*y+l[13],f[3]=l[3]*p+l[7]*y+l[15],f}const Nt=100;class yf{constructor(r,l,p=new $d(r.width+200,r.height+200,25),y=new $d(r.width+200,r.height+200,25)){this.transform=r,this.grid=p,this.ignoredGrid=y,this.pitchfactor=Math.cos(r._pitch)*r.cameraToCenterDistance,this.screenRightBoundary=r.width+Nt,this.screenBottomBoundary=r.height+Nt,this.gridRightBoundary=r.width+200,this.gridBottomBoundary=r.height+200,this.fogState=l}placeCollisionBox(r,l,p,y,v,b,D,C,P,O,N){let F=p.projectedAnchorX,B=p.projectedAnchorY,H=p.projectedAnchorZ;const U=p.tileAnchorX,q=p.tileAnchorY,G=p.elevation,Y=p.tileID,ee=r.getProjection();if(G&&Y){const[je,Fe,Ge]=ee.upVector(Y.canonical,p.tileAnchorX,p.tileAnchorY),rt=ee.upVectorScale(Y.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;F+=je*G*rt,B+=Fe*G*rt,H+=Ge*G*rt}const ne="globe"===r.projection.name,le="globe"===r.projection.name?u.ah(this.transform.zoom):0;if(Y&&ne&&le<1&&!b){const je=1<<Y.canonical.z,Fe=u.bM(U,q);u.bN(Fe,Fe,1/u.aj),u.bO(Fe,Fe,u.bM(Y.canonical.x,Y.canonical.y)),u.bN(Fe,Fe,1/je),u.bP(Fe,Fe,u.bM(y[0],y[1])),Fe[0]=u.bQ(Fe[0],-.5,.5),u.bN(Fe,Fe,u.aj);const Ge=u.bR(Fe[0],Fe[1],u.aj/(2*Math.PI),1);u.aA(Ge,Ge,v),F=u.ai(F,Ge[0],le),B=u.ai(B,Ge[1],le),H=u.ai(H,Ge[2],le)}const de=this.projectAndGetPerspectiveRatio(O,F,B,H,p.tileID,"globe"===ee.name||!!G||this.transform.pitch>0,ee),pe=P*de.perspectiveRatio,ae=(p.x1*l+D.x-p.padding)*pe+de.point.x,ce=(p.y1*l+D.y-p.padding)*pe+de.point.y,ue=(p.x2*l+D.x+p.padding)*pe+de.point.x,Me=(p.y2*l+D.y+p.padding)*pe+de.point.y,ye=de.perspectiveRatio<=.55||de.occluded;return!this.isInsideGrid(ae,ce,ue,Me)||!C&&this.grid.hitTest(ae,ce,ue,Me,N)||ye?{box:[],offscreen:!1,occluded:de.occluded}:{box:[ae,ce,ue,Me],offscreen:this.isOffscreen(ae,ce,ue,Me),occluded:!1}}placeCollisionCircles(r,l,p,y,v,b,D,C,P,O,N,F,B,H,U){const q=[],G=this.transform.elevation,Y=r.getProjection(),ee=G?G.getAtTileOffsetFunc(U,this.transform.center.lat,this.transform.worldSize,Y):null,ne=new u.P(p.tileAnchorX,p.tileAnchorY);let{x:le,y:de,z:pe}=Y.projectTilePoint(ne.x,ne.y,U.canonical);if(ee){const[We,Ze,Ye]=ee(ne);le+=We,de+=Ze,pe+=Ye}const ae="globe"===Y.name,ce=this.projectAndGetPerspectiveRatio(D,le,de,pe,U,ae||!!G||this.transform.pitch>0,Y),{perspectiveRatio:ue}=ce,Me=(N?b/ue:b*ue)/u.bU,ye=_n(le,de,pe,C),je=p.lineOffsetX*Me,Fe=p.lineOffsetY*Me,Ge=u.al(r.layers[0].layout.get("text-max-angle")),rt=Math.cos(Ge),De=ce.signedDistanceFromCamera>0?Jt(Me,v,je,Fe,!1,ye,ne,p,y,C,{},G&&!N?ee:null,N&&!!G,Y,U,N,rt):null;let _e=!1,Ne=!1,Re=!0;if(De&&!ce.occluded){const We=.5*B*ue+H,Ze=new u.P(-100,-100),Ye=new u.P(this.screenRightBoundary,this.screenBottomBoundary),ct=new _v,{first:Mt,last:kt}=De,vt=Mt.path.length;let Ot=[];for(let en=vt-1;en>=1;en--)Ot.push(Mt.path[en]);for(let en=1;en<kt.path.length;en++)Ot.push(kt.path[en]);const Pt=2.5*We;P&&(Ot=Ot.map(([en,mn,Cn],Yt)=>(ee&&!ae&&(Cn=ee(Yt<vt-1?Mt.tilePath[vt-1-Yt]:kt.tilePath[Yt-vt+2])[2]),_n(en,mn,Cn,P))),Ot.some(en=>en[3]<=0)&&(Ot=[]));let Wt=[];if(Ot.length>0){let en=1/0,mn=-1/0,Cn=1/0,Yt=-1/0;for(const Mn of Ot)en=Math.min(en,Mn[0]),Cn=Math.min(Cn,Mn[1]),mn=Math.max(mn,Mn[0]),Yt=Math.max(Yt,Mn[1]);mn>=Ze.x&&en<=Ye.x&&Yt>=Ze.y&&Cn<=Ye.y&&(Wt=[Ot.map(Mn=>new u.P(Mn[0],Mn[1]))],(en<Ze.x||mn>Ye.x||Cn<Ze.y||Yt>Ye.y)&&(Wt=u.bS(Wt,Ze.x,Ze.y,Ye.x,Ye.y)))}for(const en of Wt){ct.reset(en,.25*We);let mn=0;mn=ct.length<=.5*We?1:Math.ceil(ct.paddedLength/Pt)+1;for(let Cn=0;Cn<mn;Cn++){const Yt=Cn/Math.max(mn-1,1),Mn=ct.lerp(Yt),kn=Mn.x+Nt,ti=Mn.y+Nt;q.push(kn,ti,We,0);const un=kn-We,Ln=ti-We,zn=kn+We,In=ti+We;if(Re=Re&&this.isOffscreen(un,Ln,zn,In),Ne=Ne||this.isInsideGrid(un,Ln,zn,In),!l&&this.grid.hitTestCircle(kn,ti,We,F)&&(_e=!0,!O))return{circles:[],offscreen:!1,collisionDetected:_e,occluded:!1}}}}return{circles:!O&&_e||!Ne?[]:q,offscreen:Re,collisionDetected:_e,occluded:ce.occluded}}queryRenderedSymbols(r){if(0===r.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const l=[];let p=1/0,y=1/0,v=-1/0,b=-1/0;for(const O of r){const N=new u.P(O.x+Nt,O.y+Nt);p=Math.min(p,N.x),y=Math.min(y,N.y),v=Math.max(v,N.x),b=Math.max(b,N.y),l.push(N)}const D=this.grid.query(p,y,v,b).concat(this.ignoredGrid.query(p,y,v,b)),C={},P={};for(const O of D){const N=O.key;if(void 0===C[N.bucketInstanceId]&&(C[N.bucketInstanceId]={}),C[N.bucketInstanceId][N.featureIndex])continue;const F=[new u.P(O.x1,O.y1),new u.P(O.x2,O.y1),new u.P(O.x2,O.y2),new u.P(O.x1,O.y2)];u.bT(l,F)&&(C[N.bucketInstanceId][N.featureIndex]=!0,void 0===P[N.bucketInstanceId]&&(P[N.bucketInstanceId]=[]),P[N.bucketInstanceId].push(N.featureIndex))}return P}insertCollisionBox(r,l,p,y,v){(l?this.ignoredGrid:this.grid).insert({bucketInstanceId:p,featureIndex:y,collisionGroupID:v},r[0],r[1],r[2],r[3])}insertCollisionCircles(r,l,p,y,v){const b=l?this.ignoredGrid:this.grid,D={bucketInstanceId:p,featureIndex:y,collisionGroupID:v};for(let C=0;C<r.length;C+=4)b.insertCircle(D,r[C],r[C+1],r[C+2])}projectAndGetPerspectiveRatio(r,l,p,y,v,b,D){const C=[l,p,y,1];let P=!1;y||this.transform.pitch>0?(u.aA(C,C,r),this.fogState&&v&&"globe"!==D.name&&(P=function(F,B,H,U,q,G){const Y=G.calculateFogTileMatrix(q),ee=[B,H,U];return u.ad(ee,ee,Y),Lt(F,u.ae(ee),G.pitch,G._fov)}(this.fogState,l,p,y,v.toUnwrapped(),this.transform)>.9)):Zd(C,C,r);const O=C[3];return{point:new u.P((C[0]/O+1)/2*this.transform.width+Nt,(-C[1]/O+1)/2*this.transform.height+Nt),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(D)/O*.5,1.5),signedDistanceFromCamera:O,occluded:b&&C[2]>O||P}}isOffscreen(r,l,p,y){return p<Nt||r>=this.screenRightBoundary||y<Nt||l>this.screenBottomBoundary}isInsideGrid(r,l,p,y){return p>=0&&r<this.gridRightBoundary&&y>=0&&l<this.gridBottomBoundary}getViewportMatrix(){const r=u.bx([]);return u.bo(r,r,[-100,-100,0]),r}}class ju{constructor(r,l,p,y){this.opacity=r?Math.max(0,Math.min(1,r.opacity+(r.placed?l:-l))):y&&p?1:0,this.placed=p}isHidden(){return 0===this.opacity&&!this.placed}}class Rc{constructor(r,l,p,y,v,b=!1){this.text=new ju(r?r.text:null,l,p,v),this.icon=new ju(r?r.icon:null,l,y,v),this.clipped=b}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Hn{constructor(r,l,p,y=!1){this.text=r,this.icon=l,this.skipFade=p,this.clipped=y}}class Xd{constructor(){this.invProjMatrix=u.bz(),this.viewportMatrix=u.bz(),this.circles=[]}}class Oc{constructor(r,l,p,y,v){this.bucketInstanceId=r,this.featureIndex=l,this.sourceLayerIndex=p,this.bucketIndex=y,this.tileID=v}}class Tt{constructor(r){this.crossSourceCollisions=r,this.maxGroupID=0,this.collisionGroups={}}get(r){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[r]){const l=++this.maxGroupID;this.collisionGroups[r]={ID:l,predicate:p=>p.collisionGroupID===l}}return this.collisionGroups[r]}}function Gn(f,r,l,p,y){const{horizontalAlign:v,verticalAlign:b}=u.bZ(f),D=-(v-.5)*r,C=-(b-.5)*l,P=u.b_(f,p);return new u.P(D+P[0]*y,C+P[1]*y)}function Xn(f,r,l,p,y){const v=new u.P(f,r);return l&&v._rotate(p?y:-y),v}class gi{constructor(r,l,p,y,v,b){this.transform=r.clone(),this.projection=r.projection.name,this.collisionIndex=new yf(this.transform,v),this.buildingIndex=b,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=l,this.retainedQueryData={},this.collisionGroups=new Tt(p),this.collisionCircleArrays={},this.prevPlacement=y,y&&(y.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(r,l,p,y,v=1){const b=p.getBucket(l),D=p.latestFeatureIndex;if(!b||!D||l.fqid!==b.layerIds[0])return;const C=b.layers[0].layout,P=b.layers[0].paint,O=p.collisionBoxArray,N=Math.pow(2,this.transform.zoom-p.tileID.overscaledZ),F=p.tileSize/u.aj,B=p.tileID.toUnwrapped();this.transform.setProjection(b.projection);const H=(U=p.tileID,q=b.getProjection(),G=this.transform,q.name===this.projection?G.calculateProjMatrix(U.toUnwrapped()):fa(G,q,U));var U,q,G;const Y="map"===C.get("text-pitch-alignment"),ee="map"===C.get("text-rotation-alignment");l.compileFilter(l.options);const ne=l.dynamicFilter(),le=l.dynamicFilterNeedsFeature(),de=this.transform.calculatePixelsToTileUnitsMatrix(p),pe=Wd(H,p.tileID.canonical,Y,ee,this.transform,b.getProjection(),de);let ae=null;const ce=b.getProjection().createInversionMatrix(this.transform,p.tileID.canonical);if(Y){const _e=Yr(H,p.tileID.canonical,Y,ee,this.transform,b.getProjection(),de);ae=u.az([],this.transform.labelPlaneMatrix,_e)}let ue=null;ne&&p.latestFeatureIndex&&(ue={unwrappedTileID:B,dynamicFilter:ne,dynamicFilterNeedsFeature:le}),this.retainedQueryData[b.bucketInstanceId]=new Oc(b.bucketInstanceId,D,b.sourceLayerIndex,b.index,p.tileID);const[Me,ye]=b.layers[0].layout.get("text-size-scale-range"),je=u.ay(v,Me,ye),[Fe,Ge]=C.get("icon-size-scale-range"),rt=u.ay(v,Fe,Ge),De={bucket:b,layout:C,paint:P,posMatrix:H,invMatrix:ce,mercatorCenter:[u.aD(this.transform.center.lng),u.aH(this.transform.center.lat)],textLabelPlaneMatrix:pe,labelToScreenMatrix:ae,clippingData:ue,scale:N,textPixelRatio:F,holdingForFade:p.holdingForFade(),collisionBoxArray:O,partiallyEvaluatedTextSize:u.bH(b.textSizeData,this.transform.zoom,je),partiallyEvaluatedIconSize:u.bH(b.iconSizeData,this.transform.zoom,rt),collisionGroup:this.collisionGroups.get(b.sourceID),latestFeatureIndex:p.latestFeatureIndex};if(y)for(const _e of b.sortKeyRanges){const{sortKey:Ne,symbolInstanceStart:Re,symbolInstanceEnd:We}=_e;r.push({sortKey:Ne,symbolInstanceStart:Re,symbolInstanceEnd:We,parameters:De})}else r.push({symbolInstanceStart:0,symbolInstanceEnd:b.symbolInstances.length,parameters:De})}attemptAnchorPlacement(r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q,G,Y,ee,ne,le){const{textOffset0:de,textOffset1:pe,crossTileID:ae}=U,ce=[de,pe],ue=Gn(r,b,D,ce,C),Me=this.collisionIndex.placeCollisionBox(G,C,l,p,y,v,Xn(ue.x,ue.y,P,O,this.transform.angle),H,N,F,B.predicate);if(ee){const ye=G.getSymbolInstanceIconSize(le,this.transform.zoom,U.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(G,ye,ee,p,y,v,Xn(ue.x,ue.y,P,O,this.transform.angle),H,N,F,B.predicate).box.length)return}if(Me.box.length>0){let ye;return this.prevPlacement&&this.prevPlacement.variableOffsets[ae]&&this.prevPlacement.placements[ae]&&this.prevPlacement.placements[ae].text&&(ye=this.prevPlacement.variableOffsets[ae].anchor),this.variableOffsets[ae]={textOffset:ce,width:b,height:D,anchor:r,textScale:C,prevAnchor:ye},this.markUsedJustification(G,r,U,Y),G.allowVerticalPlacement&&(this.markUsedOrientation(G,Y,U),this.placedOrientations[ae]=Y),{shift:ue,placedGlyphBoxes:Me}}}placeLayerBucketPart(r,l,p,y,v=1){const{bucket:b,layout:D,paint:C,posMatrix:P,textLabelPlaneMatrix:O,labelToScreenMatrix:N,clippingData:F,textPixelRatio:B,mercatorCenter:H,invMatrix:U,holdingForFade:q,collisionBoxArray:G,partiallyEvaluatedTextSize:Y,partiallyEvaluatedIconSize:ee,collisionGroup:ne,latestFeatureIndex:le}=r.parameters,de=D.get("text-optional"),pe=D.get("icon-optional"),ae=D.get("text-allow-overlap"),ce=D.get("icon-allow-overlap"),ue="map"===D.get("text-rotation-alignment"),Me="map"===D.get("icon-rotation-alignment"),ye="map"===D.get("text-pitch-alignment"),je=C.get("symbol-z-offset"),Fe="sea"===D.get("symbol-elevation-reference"),Ge=D.get("symbol-placement"),[rt,De]=D.get("text-size-scale-range"),[_e,Ne]=D.get("icon-size-scale-range"),Re=u.ay(v,rt,De),We=u.ay(v,_e,Ne),Ze=D.get("text-variable-anchor"),Ye=ue&&"point"!==Ge,ct=Me&&"point"!==Ge,Mt=Ze&&b.hasTextData(),kt=b.hasIconTextFit()&&Mt&&b.hasIconData();this.transform.setProjection(b.projection);const vt=Mt||Ye,Ot=ct||kt;let Pt=ae&&(ce||!b.hasIconData()||pe),Wt=ce&&(ae||!b.hasTextData()||de);const en=!je.isConstant();!b.collisionArrays&&G&&b.deserializeCollisionBoxes(G),p&&y&&b.updateCollisionDebugBuffers(this.transform.zoom,G,Re,We);const mn=(Yt,Mn,kn)=>{const{crossTileID:ti,numVerticalGlyphVertices:un}=Yt;let Ln=null;if(F&&F.dynamicFilterNeedsFeature||en){const Qi=this.retainedQueryData[b.bucketInstanceId];Ln=le.loadFeature({featureIndex:Yt.featureIndex,bucketIndex:Qi.bucketIndex,sourceLayerIndex:Qi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(F&&!(0,F.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Ln,this.retainedQueryData[b.bucketInstanceId].tileID.canonical,new u.P(Yt.tileAnchorX,Yt.tileAnchorY),this.transform.calculateDistanceTileData(F.unwrappedTileID)))return this.placements[ti]=new Hn(!1,!1,!1,!0),void l.add(ti);const zn=je.evaluate(Ln,{});if(l.has(ti))return;if(q)return void(this.placements[ti]=new Hn(!1,!1,!1));let In=!1,sn=!1,ni=!0,$n=!1,Ni=!1,Pn=null,Wn={box:null,offscreen:null,occluded:null},di={box:null},xr=null,hr=null,or=null,Gr=0,ba=0,Lo=0;kn.textFeatureIndex?Gr=kn.textFeatureIndex:Yt.useRuntimeCollisionCircles&&(Gr=Yt.featureIndex),kn.verticalTextFeatureIndex&&(ba=kn.verticalTextFeatureIndex);const qs=Qi=>{Qi.tileID=this.retainedQueryData[b.bucketInstanceId].tileID;const rr=this.transform.elevation;Qi.elevation=Fe?zn:zn+(rr?rr.getAtTileOffset(Qi.tileID,Qi.tileAnchorX,Qi.tileAnchorY):0),Qi.elevation+=Yt.zOffset},uo=kn.textBox;if(uo){qs(uo);const Qi=Ei=>{let Tr=u.bI.horizontal;if(b.allowVerticalPlacement&&!Ei&&this.prevPlacement){const ho=this.prevPlacement.placedOrientations[ti];ho&&(this.placedOrientations[ti]=ho,Tr=ho,this.markUsedOrientation(b,Tr,Yt))}return Tr},rr=(Ei,Tr)=>{if(b.allowVerticalPlacement&&un>0&&kn.verticalTextBox){for(const ho of b.writingModes)if(ho===u.bI.vertical?(Wn=Tr(),di=Wn):Wn=Ei(),Wn&&Wn.box&&Wn.box.length)break}else Wn=Ei()};if(Ze){let Ei=Ze;if(this.prevPlacement&&this.prevPlacement.variableOffsets[ti]){const fr=this.prevPlacement.variableOffsets[ti];Ei.indexOf(fr.anchor)>0&&(Ei=Ei.filter(oa=>oa!==fr.anchor),Ei.unshift(fr.anchor))}const Tr=(fr,oa,cd)=>{const su=b.getSymbolInstanceTextSize(Y,Yt,this.transform.zoom,Mn),ud=(fr.x2-fr.x1)*su+2*fr.padding,yl=(fr.y2-fr.y1)*su+2*fr.padding,Wo=Yt.hasIconTextFit&&!ce?oa:null;Wo&&qs(Wo);let wa={box:[],offscreen:!1,occluded:!1};const Mr=ae?2*Ei.length:Ei.length;for(let Is=0;Is<Mr;++Is){const sa=this.attemptAnchorPlacement(Ei[Is%Ei.length],fr,H,U,vt,ud,yl,su,ue,ye,B,P,ne,Is>=Ei.length,Yt,Mn,b,cd,Wo,Y,ee);if(sa&&(wa=sa.placedGlyphBoxes,wa&&wa.box&&wa.box.length)){In=!0,Pn=sa.shift;break}}return wa};rr(()=>Tr(uo,kn.iconBox,u.bI.horizontal),()=>{const fr=kn.verticalTextBox;return fr&&qs(fr),b.allowVerticalPlacement&&!(Wn&&Wn.box&&Wn.box.length)&&un>0&&fr?Tr(fr,kn.verticalIconBox,u.bI.vertical):{box:null,offscreen:null,occluded:null}}),Wn&&(In=Wn.box,ni=Wn.offscreen,$n=Wn.occluded);const ho=Qi(!(!Wn||!Wn.box));if(!In&&this.prevPlacement){const fr=this.prevPlacement.variableOffsets[ti];fr&&(this.variableOffsets[ti]=fr,this.markUsedJustification(b,fr.anchor,Yt,ho))}}else{const Ei=(Tr,ho)=>{const fr=b.getSymbolInstanceTextSize(Y,Yt,this.transform.zoom,Mn,v),oa=this.collisionIndex.placeCollisionBox(b,fr,Tr,H,U,vt,new u.P(0,0),ae,B,P,ne.predicate);return oa&&oa.box&&oa.box.length&&(this.markUsedOrientation(b,ho,Yt),this.placedOrientations[ti]=ho),oa};rr(()=>Ei(uo,u.bI.horizontal),()=>{const Tr=kn.verticalTextBox;return b.allowVerticalPlacement&&un>0&&Tr?(qs(Tr),Ei(Tr,u.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Qi(!!(Wn&&Wn.box&&Wn.box.length))}}if(xr=Wn,In=xr&&xr.box&&xr.box.length>0,ni=xr&&xr.offscreen,$n=xr&&xr.occluded,Yt.useRuntimeCollisionCircles){const Qi=b.text.placedSymbolArray.get(Yt.centerJustifiedTextSymbolIndex>=0?Yt.centerJustifiedTextSymbolIndex:Yt.verticalPlacedTextSymbolIndex),rr=u.bJ(b.textSizeData,Y,Qi),Ei=D.get("text-padding");hr=this.collisionIndex.placeCollisionCircles(b,ae,Qi,b.lineVertexArray,b.glyphOffsetArray,rr,P,O,N,p,ye,ne.predicate,Yt.collisionCircleDiameter*rr/u.bU,Ei,this.retainedQueryData[b.bucketInstanceId].tileID),In=ae||hr.circles.length>0&&!hr.collisionDetected,ni=ni&&hr.offscreen,$n=hr.occluded}if(kn.iconFeatureIndex&&(Lo=kn.iconFeatureIndex),kn.iconBox){const Qi=rr=>{qs(rr);const Ei=Yt.hasIconTextFit&&Pn?Xn(Pn.x,Pn.y,ue,ye,this.transform.angle):new u.P(0,0),Tr=b.getSymbolInstanceIconSize(ee,this.transform.zoom,Yt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(b,Tr,rr,H,U,Ot,Ei,ce,B,P,ne.predicate)};di&&di.box&&di.box.length&&kn.verticalIconBox?(or=Qi(kn.verticalIconBox),sn=or.box.length>0):(or=Qi(kn.iconBox),sn=or.box.length>0),ni=ni&&or.offscreen,Ni=or.occluded}const ia=de||0===Yt.numHorizontalGlyphVertices&&0===un,ra=pe||0===Yt.numIconVertices;if(ia||ra?ra?ia||(sn=sn&&In):In=sn&&In:sn=In=sn&&In,In&&xr&&xr.box&&this.collisionIndex.insertCollisionBox(xr.box,D.get("text-ignore-placement"),b.bucketInstanceId,di&&di.box&&ba?ba:Gr,ne.ID),sn&&or&&this.collisionIndex.insertCollisionBox(or.box,D.get("icon-ignore-placement"),b.bucketInstanceId,Lo,ne.ID),hr&&(In&&this.collisionIndex.insertCollisionCircles(hr.circles,D.get("text-ignore-placement"),b.bucketInstanceId,Gr,ne.ID),p)){const Qi=b.bucketInstanceId;let rr=this.collisionCircleArrays[Qi];void 0===rr&&(rr=this.collisionCircleArrays[Qi]=new Xd);for(let Ei=0;Ei<hr.circles.length;Ei+=4)rr.circles.push(hr.circles[Ei+0]),rr.circles.push(hr.circles[Ei+1]),rr.circles.push(hr.circles[Ei+2]),rr.circles.push(hr.collisionDetected?1:0)}const Co="globe"!==b.projection.name;Pt=Pt&&(Co||!$n),Wt=Wt&&(Co||!Ni),this.placements[ti]=new Hn(In||Pt,sn||Wt,ni||b.justReloaded),l.add(ti)},Cn=this.retainedQueryData[b.bucketInstanceId].tileID;if("offset"===b.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(b,Cn),"road"===b.elevationType&&b.updateRoadElevation(Cn.canonical),b.updateZOffset(),b.sortFeaturesByY){const Yt=b.getSortedSymbolIndexes(this.transform.angle);for(let Mn=Yt.length-1;Mn>=0;--Mn){const kn=Yt[Mn];mn(b.symbolInstances.get(kn),kn,b.collisionArrays[kn])}b.hasAnyZOffset&&u.w(`${b.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(b.hasAnyZOffset){const Yt=b.getSortedIndexesByZOffset();for(let Mn=0;Mn<Yt.length;++Mn){const kn=Yt[Mn];mn(b.symbolInstances.get(kn),kn,b.collisionArrays[kn])}}else for(let Yt=r.symbolInstanceStart;Yt<r.symbolInstanceEnd;Yt++)mn(b.symbolInstances.get(Yt),Yt,b.collisionArrays[Yt]);if(p&&b.bucketInstanceId in this.collisionCircleArrays){const Yt=this.collisionCircleArrays[b.bucketInstanceId];u.bi(Yt.invProjMatrix,P),Yt.viewportMatrix=this.collisionIndex.getViewportMatrix()}b.justReloaded=!1}markUsedJustification(r,l,p,y){const{leftJustifiedTextSymbolIndex:v,centerJustifiedTextSymbolIndex:b,rightJustifiedTextSymbolIndex:D,verticalPlacedTextSymbolIndex:C,crossTileID:P}=p,O=u.b$(l),N=y===u.bI.vertical?C:"left"===O?v:"center"===O?b:"right"===O?D:-1;v>=0&&(r.text.placedSymbolArray.get(v).crossTileID=N>=0&&v!==N?0:P),b>=0&&(r.text.placedSymbolArray.get(b).crossTileID=N>=0&&b!==N?0:P),D>=0&&(r.text.placedSymbolArray.get(D).crossTileID=N>=0&&D!==N?0:P),C>=0&&(r.text.placedSymbolArray.get(C).crossTileID=N>=0&&C!==N?0:P)}markUsedOrientation(r,l,p){const y=l===u.bI.horizontal||l===u.bI.horizontalOnly?l:0,v=l===u.bI.vertical?l:0,{leftJustifiedTextSymbolIndex:b,centerJustifiedTextSymbolIndex:D,rightJustifiedTextSymbolIndex:C,verticalPlacedTextSymbolIndex:P}=p,O=r.text.placedSymbolArray;b>=0&&(O.get(b).placedOrientation=y),D>=0&&(O.get(D).placedOrientation=y),C>=0&&(O.get(C).placedOrientation=y),P>=0&&(O.get(P).placedOrientation=v)}commit(r){this.commitTime=r,this.zoomAtLastRecencyCheck=this.transform.zoom;const l=this.prevPlacement;let p=!1;this.prevZoomAdjustment=l?l.zoomAdjustment(this.transform.zoom):0;const y=l?l.symbolFadeChange(r):1,v=l?l.opacities:{},b=l?l.variableOffsets:{},D=l?l.placedOrientations:{};for(const C in this.placements){const P=this.placements[C],O=v[C];O?(this.opacities[C]=new Rc(O,y,P.text,P.icon,null,P.clipped),p=p||P.text!==O.text.placed||P.icon!==O.icon.placed):(this.opacities[C]=new Rc(null,y,P.text,P.icon,P.skipFade,P.clipped),p=p||P.text||P.icon)}for(const C in v){const P=v[C];if(!this.opacities[C]){const O=new Rc(P,y,!1,!1);O.isHidden()||(this.opacities[C]=O,p=p||P.text.placed||P.icon.placed)}}for(const C in b)this.variableOffsets[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.variableOffsets[C]=b[C]);for(const C in D)this.placedOrientations[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.placedOrientations[C]=D[C]);p?this.lastPlacementChangeTime=r:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=l?l.lastPlacementChangeTime:r)}updateLayerOpacities(r,l,p,y){const v=new Set;for(const b of l){const D=b.getBucket(r);D&&b.latestFeatureIndex&&r.fqid===D.layerIds[0]&&(this.updateBucketOpacities(D,v,b,b.collisionBoxArray,p,y,b.tileID,r.scope),"offset"===D.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(D,b.tileID),"road"===D.elevationType&&D.updateRoadElevation(b.tileID.canonical),D.updateZOffset())}}updateBucketOpacities(r,l,p,y,v,b,D,C){r.hasTextData()&&r.text.opacityVertexArray.clear(),r.hasIconData()&&r.icon.opacityVertexArray.clear(),r.hasIconCollisionBoxData()&&r.iconCollisionBox.collisionVertexArray.clear(),r.hasTextCollisionBoxData()&&r.textCollisionBox.collisionVertexArray.clear();const P=r.layers[0].layout,O=r.layers[0].paint,N=!!r.layers[0].dynamicFilter(),F=new Rc(null,0,!1,!1,!0),B=P.get("text-allow-overlap"),H=P.get("icon-allow-overlap"),U=P.get("text-variable-anchor"),q="map"===P.get("text-rotation-alignment"),G="map"===P.get("text-pitch-alignment"),Y=O.get("symbol-z-offset"),ee="sea"===P.get("symbol-elevation-reference"),ne=!Y.isConstant(),le=new Rc(null,0,B&&(H||!r.hasIconData()||P.get("icon-optional")),H&&(B||!r.hasTextData()||P.get("text-optional")),!0);!r.collisionArrays&&y&&(r.hasIconCollisionBoxData()||r.hasTextCollisionBoxData())&&r.deserializeCollisionBoxes(y);const de=(ae,ce,ue)=>{for(let Me=0;Me<ce/4;Me++)ae.opacityVertexArray.emplaceBack(ue)};let pe=0;b&&r.updateReplacement(D,b);for(let ae=0;ae<r.symbolInstances.length;ae++){const ce=r.symbolInstances.get(ae),{numHorizontalGlyphVertices:ue,numVerticalGlyphVertices:Me,crossTileID:ye,numIconVertices:je,tileAnchorX:Fe,tileAnchorY:Ge}=ce;let rt=null;const De=this.retainedQueryData[r.bucketInstanceId];ne&&ce&&De&&(rt=p.latestFeatureIndex.loadFeature({featureIndex:ce.featureIndex,bucketIndex:De.bucketIndex,sourceLayerIndex:De.sourceLayerIndex,layoutVertexArrayOffset:0}));const _e=Y.evaluate(rt,{}),Ne=l.has(ye);let Re=this.opacities[ye];Ne?Re=F:Re||(Re=le,this.opacities[ye]=Re),l.add(ye);const We=ue>0||Me>0,Ze=je>0,Ye=this.placedOrientations[ye],ct=Ye===u.bI.vertical,Mt=Ye===u.bI.horizontal||Ye===u.bI.horizontalOnly;!We&&!Ze||Re.isHidden()||pe++;let kt=!1;if((We||Ze)&&b)for(const vt of r.activeReplacements){if(u.bV(vt,v,u.bW.Symbol,C)||vt.min.x>Fe||Fe>vt.max.x||vt.min.y>Ge||Ge>vt.max.y)continue;const Ot=u.bX(Fe,Ge,D.canonical,vt.footprintTileId.canonical);if(kt=u.bY(Ot,vt.footprint),kt)break}if(We){const vt=kt?Lc:ql(Re.text);de(r.text,ue,ct?Lc:vt),de(r.text,Me,Mt?Lc:vt);const Ot=Re.text.isHidden(),{leftJustifiedTextSymbolIndex:Pt,centerJustifiedTextSymbolIndex:Wt,rightJustifiedTextSymbolIndex:en,verticalPlacedTextSymbolIndex:mn}=ce,Cn=r.text.placedSymbolArray,Yt=Ot||ct?1:0;Pt>=0&&(Cn.get(Pt).hidden=Yt),Wt>=0&&(Cn.get(Wt).hidden=Yt),en>=0&&(Cn.get(en).hidden=Yt),mn>=0&&(Cn.get(mn).hidden=Ot||Mt?1:0);const Mn=this.variableOffsets[ye];Mn&&this.markUsedJustification(r,Mn.anchor,ce,Ye);const kn=this.placedOrientations[ye];kn&&(this.markUsedJustification(r,"left",ce,kn),this.markUsedOrientation(r,kn,ce))}if(Ze){const vt=kt?Lc:ql(Re.icon),{placedIconSymbolIndex:Ot,verticalPlacedIconSymbolIndex:Pt}=ce,Wt=r.icon.placedSymbolArray,en=Re.icon.isHidden()?1:0;Ot>=0&&(de(r.icon,je,ct?Lc:vt),Wt.get(Ot).hidden=en),Pt>=0&&(de(r.icon,ce.numVerticalIconVertices,Mt?Lc:vt),Wt.get(Pt).hidden=en)}if(r.hasIconCollisionBoxData()||r.hasTextCollisionBoxData()){const vt=r.collisionArrays[ae];if(vt){let Ot=new u.P(0,0),Pt=!0;if(vt.textBox||vt.verticalTextBox){if(U){const en=this.variableOffsets[ye];en?(Ot=Gn(en.anchor,en.width,en.height,en.textOffset,en.textScale),q&&Ot._rotate(G?this.transform.angle:-this.transform.angle)):Pt=!1}N&&(Pt=!Re.clipped),vt.textBox&&$l(r.textCollisionBox.collisionVertexArray,Re.text.placed,!Pt||ct,_e,ee,Ot.x,Ot.y),vt.verticalTextBox&&$l(r.textCollisionBox.collisionVertexArray,Re.text.placed,!Pt||Mt,_e,ee,Ot.x,Ot.y)}const Wt=Pt&&!(Mt||!vt.verticalIconBox);vt.iconBox&&$l(r.iconCollisionBox.collisionVertexArray,Re.icon.placed,Wt,_e,ee,ce.hasIconTextFit?Ot.x:0,ce.hasIconTextFit?Ot.y:0),vt.verticalIconBox&&$l(r.iconCollisionBox.collisionVertexArray,Re.icon.placed,!Wt,_e,ee,ce.hasIconTextFit?Ot.x:0,ce.hasIconTextFit?Ot.y:0)}}}if(r.fullyClipped=0===pe,r.sortFeatures(this.transform.angle),this.retainedQueryData[r.bucketInstanceId]&&(this.retainedQueryData[r.bucketInstanceId].featureSortOrder=r.featureSortOrder),r.hasTextData()&&r.text.opacityVertexBuffer&&r.text.opacityVertexBuffer.updateData(r.text.opacityVertexArray),r.hasIconData()&&r.icon.opacityVertexBuffer&&r.icon.opacityVertexBuffer.updateData(r.icon.opacityVertexArray),r.hasIconCollisionBoxData()&&r.iconCollisionBox.collisionVertexBuffer&&r.iconCollisionBox.collisionVertexBuffer.updateData(r.iconCollisionBox.collisionVertexArray),r.hasTextCollisionBoxData()&&r.textCollisionBox.collisionVertexBuffer&&r.textCollisionBox.collisionVertexBuffer.updateData(r.textCollisionBox.collisionVertexArray),r.bucketInstanceId in this.collisionCircleArrays){const ae=this.collisionCircleArrays[r.bucketInstanceId];r.placementInvProjMatrix=ae.invProjMatrix,r.placementViewportMatrix=ae.viewportMatrix,r.collisionCircleArray=ae.circles,delete this.collisionCircleArrays[r.bucketInstanceId]}}symbolFadeChange(r){return 0===this.fadeDuration?1:(r-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(r){return Math.max(0,(this.transform.zoom-r)/1.5)}hasTransitions(r){return this.stale||r-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(r,l){const p=this.zoomAtLastRecencyCheck===l?1-this.zoomAdjustment(l):1;return this.zoomAtLastRecencyCheck=l,this.commitTime+this.fadeDuration*p>r}setStale(){this.stale=!0}}function $l(f,r,l,p,y,v,b){f.emplaceBack(r?1:0,l?1:0,v||0,b||0,p,y?1:0),f.emplaceBack(r?1:0,l?1:0,v||0,b||0,p,y?1:0),f.emplaceBack(r?1:0,l?1:0,v||0,b||0,p,y?1:0),f.emplaceBack(r?1:0,l?1:0,v||0,b||0,p,y?1:0)}const Qn=Math.pow(2,25),Xt=Math.pow(2,24),Fc=Math.pow(2,17),kc=Math.pow(2,16),yo=Math.pow(2,9),Er=Math.pow(2,8),vv=Math.pow(2,1);function ql(f){if(0===f.opacity&&!f.placed)return 0;if(1===f.opacity&&f.placed)return 4294967295;const r=f.placed?1:0,l=Math.floor(127*f.opacity);return l*Qn+r*Xt+l*Fc+r*kc+l*yo+r*Er+l*vv+r}const Lc=0;class vf{constructor(r){this._sortAcrossTiles="viewport-y"!==r.layout.get("symbol-z-order")&&void 0!==r.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(r,l,p,y,v,b){const D=this._bucketParts;for(;this._currentTileIndex<r.length;)if(l.getBucketParts(D,y,r[this._currentTileIndex],this._sortAcrossTiles,b),this._currentTileIndex++,v())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,D.sort((C,P)=>C.sortKey-P.sortKey));this._currentPartIndex<D.length;){const C=D[this._currentPartIndex];if(l.placeLayerBucketPart(C,this._seenCrossTileIDs,p,0===C.symbolInstanceStart,b),this._currentPartIndex++,v())return!0}return!1}}class Zp{constructor(r,l,p,y,v,b,D,C,P){this.placement=new gi(r,v,b,D,C,P),this._currentPlacementIndex=l.length-1,this._forceFullPlacement=p,this._showCollisionBoxes=y,this._done=!1}isDone(){return this._done}continuePlacement(r,l,p,y,v){const b=u.q.now(),D=()=>{const C=u.q.now()-b;return!this._forceFullPlacement&&C>2};for(;this._currentPlacementIndex>=0;){const C=l[r[this._currentPlacementIndex]],P=this.placement.collisionIndex.transform.zoom;if("symbol"===C.type&&(!C.minzoom||C.minzoom<=P)&&(!C.maxzoom||C.maxzoom>P)){const O=C,N=O.layout.get("symbol-z-elevate"),F=void 0!==O.layout.get("symbol-sort-key").constantOr(1),B=O.layout.get("symbol-z-order"),H="viewport-y"===B||"auto"===B&&!("viewport-y"!==B&&F),U=O.layout.get("text-allow-overlap")||O.layout.get("icon-allow-overlap")||O.layout.get("text-ignore-placement")||O.layout.get("icon-ignore-placement"),q=H&&U,G=this._inProgressLayer=this._inProgressLayer||new vf(O),Y=u.C(C.source,C.scope);if(G.continuePlacement(N||q?y[Y]:p[Y],this.placement,this._showCollisionBoxes,C,D,v))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(r){return this.placement.commit(r),this.placement}}const xf=512/u.aj/2;class Xp{constructor(r,l,p){this.tileID=r,this.bucketInstanceId=p,this.index=new u.c0(l.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const y=r.canonical.x*u.aj,v=r.canonical.y*u.aj;for(let b=0;b<l.length;b++){const{key:D,crossTileID:C,tileAnchorX:P,tileAnchorY:O}=l.get(b),N=Math.floor((y+P)*xf),F=Math.floor((v+O)*xf);this.index.add(N,F),this.keys.push(D),this.crossTileIDs.push(C)}this.index.finish()}findMatches(r,l,p){const y=this.tileID.canonical.z<l.canonical.z?1:Math.pow(2,this.tileID.canonical.z-l.canonical.z),v=xf/Math.pow(2,l.canonical.z-this.tileID.canonical.z),b=l.canonical.x*u.aj,D=l.canonical.y*u.aj;for(let C=0;C<r.length;C++){const P=r.get(C);if(P.crossTileID)continue;const{key:O,tileAnchorX:N,tileAnchorY:F}=P,B=Math.floor((b+N)*v),H=Math.floor((D+F)*v),U=this.index.range(B-y,H-y,B+y,H+y).sort((q,G)=>q-G);for(const q of U){const G=this.crossTileIDs[q];if(this.keys[q]===O&&!p.has(G)){p.add(G),P.crossTileID=G;break}}}}}class Kr{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class pa{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(r){const l=Math.round((r-this.lng)/360);if(0!==l)for(const p in this.indexes){const y=this.indexes[p],v={};for(const b in y){const D=y[b];D.tileID=D.tileID.unwrapTo(D.tileID.wrap+l),v[D.tileID.key]=D}this.indexes[p]=v}this.lng=r}addBucket(r,l,p){if(this.indexes[r.overscaledZ]&&this.indexes[r.overscaledZ][r.key]){if(this.indexes[r.overscaledZ][r.key].bucketInstanceId===l.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(r.overscaledZ,this.indexes[r.overscaledZ][r.key])}for(let v=0;v<l.symbolInstances.length;v++)l.symbolInstances.get(v).crossTileID=0;this.usedCrossTileIDs[r.overscaledZ]||(this.usedCrossTileIDs[r.overscaledZ]=new Set);const y=this.usedCrossTileIDs[r.overscaledZ];for(const v in this.indexes){const b=this.indexes[v];if(Number(v)>r.overscaledZ)for(const D in b){const C=b[D];C.tileID.isChildOf(r)&&C.findMatches(l.symbolInstances,r,y)}else{const D=b[r.scaledTo(Number(v)).key];D&&D.findMatches(l.symbolInstances,r,y)}}for(let v=0;v<l.symbolInstances.length;v++){const b=l.symbolInstances.get(v);b.crossTileID||(b.crossTileID=p.generate(),y.add(b.crossTileID))}return void 0===this.indexes[r.overscaledZ]&&(this.indexes[r.overscaledZ]={}),this.indexes[r.overscaledZ][r.key]=new Xp(r,l.symbolInstances,l.bucketInstanceId),!0}removeBucketCrossTileIDs(r,l){for(const p of l.crossTileIDs)this.usedCrossTileIDs[r].delete(p)}removeStaleBuckets(r){let l=!1;for(const p in this.indexes){const y=this.indexes[p];for(const v in y)r[y[v].bucketInstanceId]||(this.removeBucketCrossTileIDs(p,y[v]),delete y[v],l=!0)}return l}}class vo{constructor(){this.layerIndexes={},this.crossTileIDs=new Kr,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(r,l,p,y){let v=this.layerIndexes[r.fqid];void 0===v&&(v=this.layerIndexes[r.fqid]=new pa);let b=!1;const D={};"globe"!==y.name&&v.handleWrapJump(p);for(const C of l){const P=C.getBucket(r);P&&r.fqid===P.layerIds[0]&&(P.bucketInstanceId||(P.bucketInstanceId=++this.maxBucketInstanceId),v.addBucket(C.tileID,P,this.crossTileIDs)&&(b=!0),D[P.bucketInstanceId]=!0)}return v.removeStaleBuckets(D)&&(b=!0),b}pruneUnusedLayers(r){const l={};r.forEach(p=>{l[p]=!0});for(const p in this.layerIndexes)l[p]||delete this.layerIndexes[p]}}class an{constructor(r,l,p,y){this.blendFunction=r,this.blendColor=l.toNonPremultipliedRenderColor(null),this.mask=p,this.blendEquation=y}}an.Replace=[1,0,1,0],an.disabled=new an(an.Replace,u.am.transparent,[!1,!1,!1,!1]),an.unblended=new an(an.Replace,u.am.transparent,[!0,!0,!0,!0]),an.alphaBlended=new an([1,771,1,771],u.am.transparent,[!0,!0,!0,!0]),an.alphaBlendedNonPremultiplied=new an([770,771,770,771],u.am.transparent,[!0,!0,!0,!0]),an.multiply=new an([774,0,774,0],u.am.transparent,[!0,!0,!0,!0]);class bt{constructor(r,l,p){this.func=r,this.mask=l,this.range=p}}bt.ReadOnly=!1,bt.ReadWrite=!0,bt.disabled=new bt(519,bt.ReadOnly,[0,1]);class Vt{constructor(r,l,p,y,v,b){this.test=r,this.ref=l,this.mask=p,this.fail=y,this.depthFail=v,this.pass=b}}Vt.disabled=new Vt({func:519,mask:0},0,0,7680,7680,7680);class Bt{constructor(r,l,p){this.enable=r,this.mode=l,this.frontFace=p}}function gt(f,r){const l=u.c6(f,3);u.c8(f,r),u.cc(f,3,l)}function zc(f,r){const l=u.c3([]);return u.c4(l,l,-r),u.c5(l,l,-f),l}function ui(f,r){const l=[f[0],f[1],0],p=[r[0],r[1],0];if(u.ae(l)>=1e-15){const b=u.au([],l);u.c1(p,b,u.bG(p,b)),r[0]=p[0],r[1]=p[1]}const y=u.bF([],r,f);if(u.c2(y)<1e-15)return null;const v=Math.atan2(-y[1],y[0]);return zc(Math.atan2(Math.sqrt(f[0]*f[0]+f[1]*f[1]),-f[2]),v)}Bt.disabled=new Bt(!1,1029,2305),Bt.backCCW=new Bt(!0,1029,2305),Bt.backCW=new Bt(!0,1029,2304),Bt.frontCW=new Bt(!0,1028,2304),Bt.frontCCW=new Bt(!0,1028,2305);class Yd{constructor(r,l){this.position=r,this.orientation=l}get position(){return this._position}set position(r){if(r){const l=r instanceof u.ac?r:new u.ac(r[0],r[1],r[2]);this._renderWorldCopies&&(l.x=u.bQ(l.x,0,1)),this._position=l}else this._position=null}lookAtPoint(r,l){if(this.orientation=null,!this.position)return;const p=this.position,y=this._elevation?this._elevation.getAtPointOrZero(u.ac.fromLngLat(r)):0,v=u.ac.fromLngLat(r,y),b=[v.x-p.x,v.y-p.y,v.z-p.z];l||(l=[0,0,1]),l[2]=Math.abs(l[2]),this.orientation=ui(b,l)}setPitchBearing(r,l){this.orientation=zc(u.al(r),u.al(-l))}}class bs{constructor(r,l){this._transform=u.bx([]),this.orientation=l,this.position=r}get mercatorPosition(){const r=this.position;return new u.ac(r[0],r[1],r[2])}get position(){const r=u.c6(this._transform,3);return[r[0],r[1],r[2]]}set position(r){var l;r&&u.cc(this._transform,3,[(l=r)[0],l[1],l[2],1])}get orientation(){return this._orientation}set orientation(r){this._orientation=r||u.c3([]),r&&gt(this._transform,this._orientation)}getPitchBearing(){const r=this.forward(),l=this.right();return{bearing:Math.atan2(-l[1],l[0]),pitch:Math.atan2(Math.sqrt(r[0]*r[0]+r[1]*r[1]),-r[2])}}setPitchBearing(r,l){this._orientation=zc(r,l),gt(this._transform,this._orientation)}forward(){const r=u.c6(this._transform,2);return[-r[0],-r[1],-r[2]]}up(){const r=u.c6(this._transform,1);return[-r[0],-r[1],-r[2]]}right(){const r=u.c6(this._transform,0);return[r[0],r[1],r[2]]}getCameraToWorld(r,l){const p=new Float64Array(16);return u.bi(p,this.getWorldToCamera(r,l)),p}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(r,l,p){const y=this.position;u.c1(y,y,-r);const v=new Float64Array(16);return u.bn(v,[p,p,p]),u.bo(v,v,y),v[10]*=l,v}getWorldToCamera(r,l){const p=new Float64Array(16),y=new Float64Array(4),v=this.position;return u.c7(y,this._orientation),u.c1(v,v,-r),u.c8(p,y),u.bo(p,p,v),p[1]*=-1,p[5]*=-1,p[9]*=-1,p[13]*=-1,p[8]*=l,p[9]*=l,p[10]*=l,p[11]*=l,p}getCameraToClipPerspective(r,l,p,y){const v=new Float64Array(16);return u.c9(v,r,l,p,y),v}getCameraToClipOrthographic(r,l,p,y,v,b){const D=new Float64Array(16);return u.ca(D,r,l,p,y,v,b),D}getDistanceToElevation(r,l=!1){const p=0===r?0:u.cb(r,l?u.aY(this.position[1]):this.position[1]),y=this.forward();return(p-this.position[2])/y[2]}clone(){return new bs([...this.position],[...this.orientation])}}const Qr={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Kd{constructor(r=0,l=0,p=0,y=0){if(isNaN(r)||r<0||isNaN(l)||l<0||isNaN(p)||p<0||isNaN(y)||y<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=r,this.bottom=l,this.left=p,this.right=y}interpolate(r,l,p){return null!=l.top&&null!=r.top&&(this.top=u.ai(r.top,l.top,p)),null!=l.bottom&&null!=r.bottom&&(this.bottom=u.ai(r.bottom,l.bottom,p)),null!=l.left&&null!=r.left&&(this.left=u.ai(r.left,l.left,p)),null!=l.right&&null!=r.right&&(this.right=u.ai(r.right,l.right,p)),this}getCenter(r,l){const p=u.ay((this.left+r-this.right)/2,0,r),y=u.ay((this.top+l-this.bottom)/2,0,l);return new u.P(p,y)}equals(r){return this.top===r.top&&this.bottom===r.bottom&&this.left===r.left&&this.right===r.right}clone(){return new Kd(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}class Yp{constructor(r,l,p,y,v,b,D){this.tileSize=512,this._renderWorldCopies=void 0===v||v,this._minZoom=r||0,this._maxZoom=l||22,this._minPitch=p??0,this._maxPitch=y??60,this.setProjection(b),this.setMaxBounds(D),this.width=0,this.height=0,this._center=new u.ci(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Kd,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new bs,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const r=new Yp(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return r._elevation=this._elevation,r._centerAltitude=this._centerAltitude,r._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,r.tileSize=this.tileSize,r.mercatorFromTransition=this.mercatorFromTransition,r.width=this.width,r.height=this.height,r.cameraElevationReference=this.cameraElevationReference,r._center=this._center,r._setZoom(this.zoom),r._seaLevelZoom=this._seaLevelZoom,r.angle=this.angle,r._fov=this._fov,r._pitch=this._pitch,r._nearZ=this._nearZ,r._farZ=this._farZ,r._averageElevation=this._averageElevation,r._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,r._unmodified=this._unmodified,r._edgeInsets=this._edgeInsets.clone(),r._camera=this._camera.clone(),r._calcMatrices(),r.freezeTileCoverage=this.freezeTileCoverage,r.frustumCorners=this.frustumCorners,r._allowWorldUnderZoom=this._allowWorldUnderZoom,r}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(r){this._elevation!==r&&(this._elevation=r,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(r,l=!1){const p=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||p)&&this._updateCameraOnTerrain(),(r||p)&&this._constrainCamera(l),this._calcMatrices()}getProjection(){return u.aF(this.projection,["name","center","parallels"])}setProjection(r){this.projectionOptions=r||{name:"mercator"};const l=this.projection?this.getProjection():void 0;this.projection=u.cj(this.projectionOptions);const p=this.getProjection(),y=!u.bv(l,p);return y&&this._calcMatrices(),this.mercatorFromTransition=!1,y}setOrthographicProjectionAtLowPitch(r){return this._orthographicProjectionAtLowPitch!==r&&(this._orthographicProjectionAtLowPitch=r,this._calcMatrices(),!0)}setMercatorFromTransition(){const r=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=u.cj({name:"mercator"});const l=r!==this.projection.name;return l&&this._calcMatrices(),l}get minZoom(){return this._minZoom}set minZoom(r){this._minZoom!==r&&(this._minZoom=r,this.zoom=Math.max(this.zoom,r))}get maxZoom(){return this._maxZoom}set maxZoom(r){this._maxZoom!==r&&(this._maxZoom=r,this.zoom=Math.min(this.zoom,r))}get minPitch(){return this._minPitch}set minPitch(r){this._minPitch!==r&&(this._minPitch=r,this.pitch=Math.max(this.pitch,r))}get maxPitch(){return this._maxPitch}set maxPitch(r){this._maxPitch!==r&&(this._maxPitch=r,this.pitch=Math.min(this.pitch,r))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(r){void 0===r?r=!0:null===r&&(r=!1),this._renderWorldCopies=r}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const r=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(r))}get cameraWorldSize(){const r=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(r))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return u.cb(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new u.P(this.width,this.height)}get bearing(){return u.bQ(this.rotation,-180,180)}set bearing(r){this.rotation=r}get rotation(){return-this.angle/Math.PI*180}set rotation(r){const l=-r*Math.PI/180;this.angle!==l&&(this._unmodified=!1,this.angle=l,this._calcMatrices(),this.rotationMatrix=u.ck(),u.cl(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(r){const l=u.ay(r,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==l&&(this._unmodified=!1,this._pitch=l,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(r){r=Math.max(.01,Math.min(60,r)),this._fov!==r&&(this._unmodified=!1,this._fov=u.al(r),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const r=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/r)}get averageElevation(){return this._averageElevation}set averageElevation(r){this._averageElevation=r,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(r){const l=Math.min(Math.max(r,this.minZoom),this.maxZoom);this._zoom!==l&&(this._unmodified=!1,this._setZoom(l),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(r){this._zoom=r,this.scale=this.zoomScale(r),this.tileZoom=Math.floor(r),this.zoomFraction=r-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(r){this._tileCoverLift!==r&&(this._tileCoverLift=r)}_updateCameraOnTerrain(){const r=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,l=this.elevation&&r===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||r===Number.NEGATIVE_INFINITY&&(!l||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const p=this._elevation;l||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&p.exaggeration()&&this._centerAltitudeValidForExaggeration!==p.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*p.exaggeration(),this._centerAltitudeValidForExaggeration=p.exaggeration()):(this._centerAltitude=r||0,this._centerAltitudeValidForExaggeration=p.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(void 0===this._centerAltitudeValidForExaggeration)return;const r=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(r)}sampleAverageElevation(){if(!this._elevation)return 0;const r=this._elevation,l=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],p=this.horizonLineFromTop();let y=0,v=0;for(let b=0;b<l.length;b++){const D=new u.P(l[b][0]*this.width,p+l[b][1]*(this.height-p)),C=r.pointCoordinate(D);if(!C)continue;const P=1/Math.hypot(C[0]-this._camera.position[0],C[1]-this._camera.position[1]);y+=C[3]*P,v+=P}return 0===v?NaN:y/v}get center(){return this._center}set center(r){r.lat===this._center.lat&&r.lng===this._center.lng||(this._unmodified=!1,this._center=r,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const r=this._seaLevelZoom,l=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),p=this.pixelsPerMeter/this.worldSize*l,y=this._mercatorZfromZoom(r),v=this._mercatorZfromZoom(this._maxZoom),b=Math.max(y-p,v);this._setZoom(this._zoomFromMercatorZ(b))}get padding(){return this._edgeInsets.toJSON()}set padding(r){this._edgeInsets.equals(r)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,r,1),this._calcMatrices())}computeZoomRelativeTo(r){const l=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,r.toAltitude()));let p;p=r.z<this._camera.position[2]?[l.x,l.y,l.z]:[r.x,r.y,r.z];const y=u.ae(u.at([],this._camera.position,p));return u.ay(this._zoomFromMercatorZ(y),this._minZoom,this._maxZoom)}setFreeCameraOptions(r){if(!this.height||!r.position&&!r.orientation)return;this._updateCameraState();let l=!1;if(r.orientation&&!u.cm(r.orientation,this._camera.orientation)&&(l=this._setCameraOrientation(r.orientation)),r.position){const p=[r.position.x,r.position.y,r.position.z];u.cn(p,this._camera.position)||(this._setCameraPosition(p),l=!0)}l&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const r=this._camera.position,l=new Yd;return l.position=new u.ac(r[0],r[1],r[2]),l.orientation=this._camera.orientation,l._elevation=this.elevation,l._renderWorldCopies=this.renderWorldCopies,l}_setCameraOrientation(r){if(!u.co(r))return!1;u.cp(r,r);const l=u.cq([],[0,0,-1],r),p=u.cq([],[0,-1,0],r);if(p[2]<0)return!1;const y=ui(l,p);return!!y&&(this._camera.orientation=y,!0)}_setCameraPosition(r){const l=this.zoomScale(this.minZoom)*this.tileSize,p=this.zoomScale(this.maxZoom)*this.tileSize,y=this.cameraToCenterDistance;r[2]=u.ay(r[2],y/p,y/l),this._camera.position=r}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(r){return this._edgeInsets.equals(r)}interpolatePadding(r,l,p){this._unmodified=!1,this._edgeInsets.interpolate(r,l,p),this._constrain(),this._calcMatrices()}coveringZoomLevel(r){const l=(r.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/r.tileSize));return Math.max(0,l)}getVisibleUnwrappedCoordinates(r){const l=[new u.cr(0,r)];if(this.renderWorldCopies){const p=this.pointCoordinate(new u.P(0,0)),y=this.pointCoordinate(new u.P(this.width,0)),v=this.pointCoordinate(new u.P(this.width,this.height)),b=this.pointCoordinate(new u.P(0,this.height)),D=Math.floor(Math.min(p.x,y.x,v.x,b.x)),C=Math.floor(Math.max(p.x,y.x,v.x,b.x)),P=1;for(let O=D-P;O<=C+P;O++)0!==O&&l.push(new u.cr(O,r))}return l}isLODDisabled(r){return(!r||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(r,l,p){let y=[];const v=null!=p,b=!v;if(b&&this.zoom<l||v&&0===p[0]&&0===p[1])return y;const D=new Set,C=(O,N,F,B,H)=>{const U=u.cV(N,O,F,B,H);D.has(U)||(y.push(new u.aM(O,N,F,B,H)),D.add(U))};for(let O=0;O<r.length;O++){const N=r[O];if(b&&N.canonical.z!==l)continue;const F=N.canonical,B=N.overscaledZ,H=N.wrap,U=1<<F.z,q=F.x+1<U,G=F.x>0,Y=F.y+1<U,ee=F.y>0,ne=N.wrap-(G?0:1),le=N.wrap+(q?0:1),de=G?F.x-1:U-1,pe=q?F.x+1:0;if(v)p[0]<0?(C(B,le,F.z,pe,F.y),p[1]<0&&Y&&(C(B,H,F.z,F.x,F.y+1),C(B,le,F.z,pe,F.y+1)),p[1]>0&&ee&&(C(B,H,F.z,F.x,F.y-1),C(B,le,F.z,pe,F.y-1))):p[0]>0?(C(B,ne,F.z,de,F.y),p[1]<0&&Y&&(C(B,H,F.z,F.x,F.y+1),C(B,ne,F.z,de,F.y+1)),p[1]>0&&ee&&(C(B,H,F.z,F.x,F.y-1),C(B,ne,F.z,de,F.y-1))):p[1]<0&&Y?C(B,H,F.z,F.x,F.y+1):ee&&C(B,H,F.z,F.x,F.y-1);else{const ae=N.visibleQuadrants;1&ae&&(C(B,ne,F.z,de,F.y),ee&&(C(B,H,F.z,F.x,F.y-1),C(B,ne,F.z,de,F.y-1))),2&ae&&(C(B,le,F.z,pe,F.y),ee&&(C(B,H,F.z,F.x,F.y-1),C(B,le,F.z,pe,F.y-1))),4&ae&&(C(B,ne,F.z,de,F.y),Y&&(C(B,H,F.z,F.x,F.y+1),C(B,ne,F.z,de,F.y+1))),8&ae&&(C(B,le,F.z,pe,F.y),Y&&(C(B,H,F.z,F.x,F.y+1),C(B,le,F.z,pe,F.y+1)))}}const P=[];for(const O of y)y.some(N=>O.isChildOf(N))||P.push(O);if(y=P.filter(O=>!r.some(N=>!!(O.overscaledZ<l&&N.isChildOf(O))||O.equals(N)||O.isChildOf(N))),b){const O=1<<l,N="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),F=[O*N.x,O*N.y],B=4,H=B*B;y=y.filter(U=>{const q=U.canonical.x+.5-F[0],G=U.canonical.y+.5-F[1];return q*q+G*G<H})}return y}extendTileCoverToNearPlane(r,l,p){const y=[],v=new Set;for(const Y of r)v.add(Y.key);const b=(Y,ee,ne,le,de)=>{const pe=u.cV(ee,Y,ne,le,de);v.has(pe)||(y.push(new u.aM(Y,ee,ne,le,de)),v.add(pe))},D=r.reduce((Y,ee)=>Math.max(Y,ee.overscaledZ),p),C=1<<p,P=[new u.P(0,0),new u.P(u.aj,0),new u.P(u.aj,u.aj),new u.P(0,u.aj)],O=new u.P(0,0),N=new u.P(0,0),F=(Y,ee)=>{const ne=Math.floor(Y[0]),le=Math.floor(Y[1]),de=(Y[0]-ne)*u.aj,pe=(Y[1]-le)*u.aj,ae=Math.floor(ee[0]),ce=Math.floor(ee[1]),ue=(ee[0]-ae)*u.aj,Me=(ee[1]-ce)*u.aj;for(let ye=-1;ye<=1;ye++){const je=ne+ye;if(!(je<0||je>=C)){O.x=de-ye*u.aj,N.x=ue-(je-ae)*u.aj;for(let Fe=-1;Fe<=1;Fe++){const Ge=le+Fe;O.y=pe-Fe*u.aj,N.y=Me-(Ge-ce)*u.aj,u.cW(O,N,P)&&b(D,0,p,je,Ge)}}}},B=l.points,H=B[u.cs],U=B[u.ct],q=this._projectToGround(H,B[u.cu]),G=this._projectToGround(U,B[u.cv]);return F(H,q),F(U,G),y}_projectToGround(r,l){return u.cw(u.cx(),r,l,r[2]/(r[2]-l[2]))}coveringTiles(r){let l=this.coveringZoomLevel(r);const p=l,y=this.elevation&&this.elevation.exaggeration(),v=y&&!r.isTerrainDEM,b="mercator"===this.projection.name;if(void 0!==r.minzoom&&l<r.minzoom)return[];void 0!==r.maxzoom&&l>r.maxzoom&&(l=r.maxzoom);const D=this.locationCoordinate(this.center),C=this.center.lat,P=1<<l,O=[P*D.x,P*D.y,0],N="globe"===this.projection.name,F=!N,B=u.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,l,F),H=N?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),U=P*u.cb(1,this.center.lat),q=this._camera.position[2]/u.cb(1,this.center.lat),G=[P*H.x,P*H.y,q*(F?1:U)],Y=N||y,ee=this.cameraToCenterDistance/r.tileSize*(r.roundZoom?1:.502),ne=this.isLODDisabled(!0)?l:0;let le;if(this._elevation&&r.isTerrainDEM)le=1e4*this._elevation.exaggeration();else if(this._elevation){const _e=this._elevation.getMinMaxForVisibleTiles();le=_e?_e.max:this._centerAltitude}else le=this._centerAltitude;const de=r.isTerrainDEM?-le:this._elevation?this._elevation.getMinElevationBelowMSL():0,pe=this.projection.isReprojectedInTileSpace?u.cz(this):1,ae=_e=>{const Re=new u.ac(_e.x+25e-6,_e.y,_e.z),We=new u.ac(_e.x,_e.y+25e-6,_e.z),Ze=_e.toLngLat(),Ye=Re.toLngLat(),ct=We.toLngLat(),Mt=this.locationCoordinate(Ze),kt=this.locationCoordinate(Ye),vt=this.locationCoordinate(ct),Ot=Math.hypot(kt.x-Mt.x,kt.y-Mt.y),Pt=Math.hypot(vt.x-Mt.x,vt.y-Mt.y);return Math.sqrt(Ot*Pt)*pe/25e-6},ce=_e=>{const Ne=le,Re=de;return{aabb:u.cC(this,P,0,0,0,_e,Re,Ne,this.projection),zoom:0,x:0,y:0,minZ:Re,maxZ:Ne,wrap:_e,fullyVisible:!1}},ue=[];let Me=[];const ye=l,je=r.reparseOverscaled?p:l,Fe=(q-this._centerAltitude)*U,Ge=_e=>{if(!this._elevation||!_e.tileID||!b)return;const Ne=this._elevation.getMinMaxForTile(_e.tileID),Re=_e.aabb;Ne?(Re.min[2]=Ne.min,Re.max[2]=Ne.max,Re.center[2]=(Re.min[2]+Re.max[2])/2):(_e.shouldSplit=De(_e),_e.shouldSplit||(Re.min[2]=Re.max[2]=Re.center[2]=this._centerAltitude))},rt=(_e,Ne)=>{if(.707*Ne<_e)return 1;const Re=Ne/_e;return Re/(1.4144271570014144+(Math.pow(1.1,Re-1.4144271570014144+1)-1)/(1.1-1)-1)},De=_e=>{if(_e.zoom<ne)return!0;if(_e.zoom===ye)return!1;if(null!=_e.shouldSplit)return _e.shouldSplit;const Ne=_e.aabb.distanceX(G),Re=_e.aabb.distanceY(G);let We=Fe,Ze=1;if(N){We=_e.aabb.distanceZ(G);const Pt=Math.pow(2,_e.zoom),Wt=u.aY((_e.y+1)/Pt),en=u.aY(_e.y/Pt),mn=Math.min(Math.max(C,Wt),en),Cn=u.c_(mn)/u.c_(C);if(Ze=mn===C?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Cn/this._mercatorScaleRatio),this.zoom<=u.cX&&_e.zoom===ye-1&&Cn>=.9)return!0}else if(v&&(We=_e.aabb.distanceZ(G)*U),this.projection.isReprojectedInTileSpace&&p<=5){const Pt=Math.pow(2,_e.zoom),Wt=ae(new u.ac((_e.x+.5)/Pt,(_e.y+.5)/Pt));Ze=Wt>.85?1:Wt}if(!b){const Pt=Math.sqrt(Ne*Ne+Re*Re+We*We);let Wt=(1<<ye-_e.zoom)*ee*Ze;return Wt*=rt(Math.max(We,Fe),Pt),Pt<Wt}let Ye=Number.MAX_VALUE,ct=0;const Mt=_e.aabb.getCorners(),kt=[];for(const Pt of Mt){u.at(kt,Pt,G),N||(v?kt[2]*=U:kt[2]=Fe);const Wt=u.bG(kt,this._camera.forward());Wt<Ye&&(Ye=Wt,ct=Math.abs(kt[2]))}let vt=(1<<ye-_e.zoom)*ee*Ze;if(vt*=rt(Math.max(ct,Fe),Ye),Ye<vt)return!0;const Ot=_e.aabb.closestPoint(O);return Ot[0]===O[0]&&Ot[1]===O[1]};if(this.renderWorldCopies)for(let _e=1;_e<=3;_e++)ue.push(ce(-_e)),ue.push(ce(_e));for(ue.push(ce(0));ue.length>0;){const _e=ue.pop(),Ne=_e.x,Re=_e.y;let We=_e.fullyVisible;const Ze=()=>"globe"===this.projection.name&&(0===_e.y||_e.y===(1<<_e.zoom)-1);if(!We){let Ye=Y?_e.aabb.intersects(B):_e.aabb.intersectsFlat(B);if(0===Ye&&Ze()){const ct=new u.cA(_e.zoom,Ne,Re);Ye=u.cB(this,P,ct,!0).intersects(B)}if(0===Ye)continue;We=2===Ye}if(_e.zoom!==ye&&De(_e))for(let Ye=0;Ye<4;Ye++){const ct=(Ne<<1)+Ye%2,Mt=(Re<<1)+(Ye>>1),kt={aabb:b?_e.aabb.quadrant(Ye):u.cC(this,P,_e.zoom+1,ct,Mt,_e.wrap,_e.minZ,_e.maxZ,this.projection),zoom:_e.zoom+1,x:ct,y:Mt,wrap:_e.wrap,fullyVisible:We,tileID:void 0,shouldSplit:void 0,minZ:_e.minZ,maxZ:_e.maxZ};v&&!N&&(kt.tileID=new u.aM(_e.zoom+1===ye?je:_e.zoom+1,_e.wrap,_e.zoom+1,ct,Mt),Ge(kt)),ue.push(kt)}else{const Ye=_e.zoom===ye?je:_e.zoom;if(r.minzoom&&r.minzoom>Ye)continue;let ct=0;if(!We){let Ot=Y?_e.aabb.intersectsPrecise(B):_e.aabb.intersectsPreciseFlat(B);if(0===Ot&&Ze()){const Pt=new u.cA(_e.zoom,Ne,Re);Ot=u.cB(this,P,Pt,!0).intersectsPrecise(B)}if(0===Ot)continue;if(r.calculateQuadrantVisibility)if(B.containsPoint(_e.aabb.center))ct=15;else for(let Pt=0;Pt<4;Pt++)0!==_e.aabb.quadrant(Pt).intersects(B)&&(ct|=1<<Pt)}const Mt=O[0]-(.5+Ne+(_e.wrap<<_e.zoom))*(1<<l-_e.zoom),kt=O[1]-.5-Re,vt=_e.tileID?_e.tileID:new u.aM(Ye,_e.wrap,_e.zoom,Ne,Re);r.calculateQuadrantVisibility&&(vt.visibleQuadrants=ct),Me.push({tileID:vt,distanceSq:Mt*Mt+kt*kt})}}if(this.fogCullDistSq){const _e=this.fogCullDistSq,Ne=this.horizonLineFromTop();Me=Me.filter(Re=>{const We=[0,0,0,1],Ze=[u.aj,u.aj,0,1],Ye=this.calculateFogTileMatrix(Re.tileID.toUnwrapped());u.aA(We,We,Ye),u.aA(Ze,Ze,Ye);const ct=u.cD([],We,Ze),Mt=u.cE([],We,Ze),kt=u.cY(ct,Mt);if(0===kt)return!0;let vt=!1;const Ot=this._elevation;if(Ot&&kt>_e&&0!==Ne){const Pt=this.calculateProjMatrix(Re.tileID.toUnwrapped());let Wt;r.isTerrainDEM||(Wt=Ot.getMinMaxForTile(Re.tileID)),Wt||(Wt={min:de,max:le});const en=u.cF(this.rotation),mn=[en[0]*u.aj,en[1]*u.aj,Wt.max];u.ad(mn,mn,Pt),vt=(1-mn[1])*this.height*.5<Ne}return kt<_e||vt})}return Me.sort((_e,Ne)=>_e.distanceSq-Ne.distanceSq).map(_e=>_e.tileID)}resize(r,l){this.width=r,this.height=l,this.pixelsToGLUnits=[2/r,-2/l],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(r){return Math.pow(2,r)}scaleZoom(r){return Math.log(r)/Math.LN2}project(r){const l=u.ay(r.lat,-u.cG,u.cG),p=this.projection.project(r.lng,l);return new u.P(p.x*this.worldSize,p.y*this.worldSize)}unproject(r){return this.projection.unproject(r.x/this.worldSize,r.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/u.cb(1,this.center.lat)/this.worldSize}setLocationAtPoint(r,l){let p,y;const v=this.centerPoint;if("globe"===this.projection.name){const D=this.worldSize;p=(l.x-v.x)/D,y=(l.y-v.y)/D}else{const D=this.pointCoordinate(l),C=this.pointCoordinate(v);p=D.x-C.x,y=D.y-C.y}const b=this.locationCoordinate(r);this.setLocation(new u.ac(b.x-p,b.y-y))}setLocation(r){this.center=this.coordinateLocation(r),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(r,l){return this.projection.locationPoint(this,r,l)}locationPoint3D(r,l){return this.projection.locationPoint(this,r,l,!0)}pointLocation(r){return this.coordinateLocation(this.pointCoordinate(r))}pointLocation3D(r,l){return this.coordinateLocation(this.pointCoordinate3D(r,l))}locationCoordinate(r,l){const p=l?u.cb(l,r.lat):void 0,y=this.projection.project(r.lng,r.lat);return new u.ac(y.x,y.y,p)}coordinateLocation(r){return this.projection.unproject(r.x,r.y)}pointRayIntersection(r,l){const p=l??this._centerAltitude,y=[r.x,r.y,0,1],v=[r.x,r.y,1,1];u.aA(y,y,this.pixelMatrixInverse),u.aA(v,v,this.pixelMatrixInverse);const b=v[3];u.cH(y,y,1/y[3]),u.cH(v,v,1/b);const D=y[2],C=v[2];return{p0:y,p1:v,t:D===C?0:(p-D)/(C-D)}}screenPointToMercatorRay(r){const l=[r.x,r.y,0,1],p=[r.x,r.y,1,1];return u.aA(l,l,this.pixelMatrixInverse),u.aA(p,p,this.pixelMatrixInverse),u.cH(l,l,1/l[3]),u.cH(p,p,1/p[3]),l[2]=u.cb(l[2],this._center.lat)*this.worldSize,p[2]=u.cb(p[2],this._center.lat)*this.worldSize,u.cH(l,l,1/this.worldSize),u.cH(p,p,1/this.worldSize),new u.av([l[0],l[1],l[2]],u.au([],u.at([],p,l)))}rayIntersectionCoordinate(r){const{p0:l,p1:p,t:y}=r,v=u.cb(l[2],this._center.lat),b=u.cb(p[2],this._center.lat);return new u.ac(u.ai(l[0],p[0],y)/this.worldSize,u.ai(l[1],p[1],y)/this.worldSize,u.ai(v,b,y))}pointCoordinate(r,l=this._centerAltitude){return this.projection.pointCoordinate(this,r.x,r.y,l)}pointCoordinate3D(r,l){if(!this.elevation)return this.pointCoordinate(r,l);let p=this.projection.pointCoordinate3D(this,r.x,r.y);if(p)return new u.ac(p[0],p[1],p[2]);let y=0,v=this.horizonLineFromTop();if(r.y>v)return this.pointCoordinate(r,l);const b=.02*v,D=r.clone();for(let C=0;C<10&&v-y>b;C++){D.y=u.ai(y,v,.66);const P=this.projection.pointCoordinate3D(this,D.x,D.y);P?(v=D.y,p=P):y=D.y}return p?new u.ac(p[0],p[1],p[2]):this.pointCoordinate(r)}isPointAboveHorizon(r){return this.projection.isPointAboveHorizon(this,r)}isPointOnSurface(r){if(r.y<0||r.y>this.height||r.x<0||r.x>this.width)return!1;if(this.elevation||this.zoom>=u.cI)return!this.isPointAboveHorizon(r);const l=this.pointCoordinate(r);return l.y>=0&&l.y<=1}_coordinatePoint(r,l){const p=l&&this.elevation?this.elevation.getAtPointOrZero(r,this._centerAltitude):this._centerAltitude,y=[r.x*this.worldSize,r.y*this.worldSize,p+r.toAltitude(),1];return u.aA(y,y,this.pixelMatrix),y[3]>0?new u.P(y[0]/y[3],y[1]/y[3]):new u.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:r,left:l}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,y=this.width-this._edgeInsets.right,v=this.pointLocation3D(new u.P(l,r)),b=this.pointLocation3D(new u.P(y,r)),D=this.pointLocation3D(new u.P(y,p)),C=this.pointLocation3D(new u.P(l,p));let P=Math.min(v.lng,b.lng,D.lng,C.lng),O=Math.max(v.lng,b.lng,D.lng,C.lng),N=Math.min(v.lat,b.lat,D.lat,C.lat),F=Math.max(v.lat,b.lat,D.lat,C.lat);const B=Math.pow(2,-this.zoom)/16*270,H="globe"===this.projection.name?1:4,U=(q,G,Y,ee,ne)=>{const le=(q+Y)/2,de=(G+ee)/2,pe=new u.P(le,de),{lng:ae,lat:ce}=this.pointLocation3D(pe),ue=Math.max(0,P-ae,N-ce,ae-O,ce-F);P=Math.min(P,ae),O=Math.max(O,ae),N=Math.min(N,ce),F=Math.max(F,ce),(ne<H||ue>B)&&(U(q,G,le,de,ne+1),U(le,de,Y,ee,ne+1))};if(U(l,r,y,r,1),U(y,r,y,p,1),U(y,p,l,p,1),U(l,p,l,r,1),"globe"===this.projection.name){const[q,G]=u.cJ(this);q?(F=90,O=180,P=-180):G&&(N=-90,O=180,P=-180)}return new u.aG(new u.ci(P,N),new u.ci(O,F))}_getBoundsRectangular(r,l){const{top:p,left:y}=this._edgeInsets,v=this.height-this._edgeInsets.bottom,b=this.width-this._edgeInsets.right,D=new u.P(y,p),C=new u.P(b,p),P=new u.P(b,v),O=new u.P(y,v);let N=this.pointCoordinate(D,r),F=this.pointCoordinate(C,r);const B=this.pointCoordinate(P,l),H=this.pointCoordinate(O,l),U=(q,G)=>(G.y-q.y)/(G.x-q.x);return N.y>1&&F.y>=0?N=new u.ac((1-H.y)/U(H,N)+H.x,1):N.y<0&&F.y<=1&&(N=new u.ac(-H.y/U(H,N)+H.x,0)),F.y>1&&N.y>=0?F=new u.ac((1-B.y)/U(B,F)+B.x,1):F.y<0&&N.y<=1&&(F=new u.ac(-B.y/U(B,F)+B.x,0)),(new u.aG).extend(this.coordinateLocation(N)).extend(this.coordinateLocation(F)).extend(this.coordinateLocation(H)).extend(this.coordinateLocation(B))}_getBoundsRectangularTerrain(){const r=this.elevation;if(!r.visibleDemTiles.length||r.isUsingMockSource())return this._getBoundsRectangular(0,0);const l=r.visibleDemTiles.reduce((p,y)=>{if(y.dem){const v=y.dem.tree;p.min=Math.min(p.min,v.minimums[0]),p.max=Math.max(p.max,v.maximums[0])}return p},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(l.min*r.exaggeration(),l.max*r.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(r=!0){const l=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,p=this.height/2-l*(1-this._horizonShift);return r?Math.max(0,p):p}getMaxBounds(){return this.maxBounds}setMaxBounds(r){this.maxBounds=r,this.minLat=-u.cG,this.maxLat=u.cG,this.minLng=-180,this.maxLng=180,r&&(this.minLat=r.getSouth(),this.maxLat=r.getNorth(),this.minLng=r.getWest(),this.maxLng=r.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=u.aD(this.minLng)*this.tileSize,this.worldMaxX=u.aD(this.maxLng)*this.tileSize,this.worldMinY=u.aH(this.maxLat)*this.tileSize,this.worldMaxY=u.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(r,l){return this.projection.createTileMatrix(this,l,r)}calculateDistanceTileData(r){const l=r.key,p=this._distanceTileDataCache;if(p[l])return p[l];const y=r.canonical,v=1/this.height,b=this.cameraWorldSize,D=b/this.zoomScale(y.z),C=(y.x+Math.pow(2,y.z)*r.wrap)*D,P=y.y*D,O=this.point;O.x*=b/this.worldSize,O.y*=b/this.worldSize;const N=this.angle,F=Math.sin(-N),B=-Math.cos(-N);return p[l]={bearing:[F,B],center:[(O.x-C)*v,(O.y-P)*v],scale:D/u.aj*v},p[l]}calculateFogTileMatrix(r){const l=r.key,p=this._fogTileMatrixCache;if(p[l])return p[l];const y=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,r);return u.az(y,this.worldToFogMatrix,y),p[l]=new Float32Array(y),p[l]}calculateProjMatrix(r,l=!1,p=!1){const y=r.key;let v;if(v=p?this._expandedProjMatrixCache:l?this._alignedProjMatrixCache:this._projMatrixCache,v[y])return v[y];const b=this.calculatePosMatrix(r,this.worldSize);let D;return D=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:p?this.expandedFarZProjMatrix:l?this.alignedProjMatrix:this.projMatrix,u.az(b,D,b),v[y]=new Float32Array(b),v[y]}calculatePixelsToTileUnitsMatrix(r){const l=r.tileID.key,p=this._pixelsToTileUnitsCache;if(p[l])return p[l];const y=u.cK(r,this);return p[l]=y,p[l]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const r=1/this.worldSize,l=u.bn([],[r,r,r]);return u.az(l,l,this.globeMatrix),l}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const r=this._elevation;this._updateCameraState();const l=u.cb(1,this._center.lat)*this.worldSize,p=this._computeCameraPosition(l),y=this._camera.forward(),v=u.cb(1,this._center.lat);p[2]/=v,y[2]/=v,u.au(y,y);const b=r.raycast(p,y,r.exaggeration());if(b){const D=u.bE([],p,y,b),C=new u.ac(D[0],D[1],u.cb(D[2],u.aY(D[1]))),P=(C.z+u.ae([C.x-p[0],C.y-p[1],C.z-p[2]*v]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(P),this._centerAltitude=C.toAltitude(),this._center=this.coordinateLocation(C),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(r=!1){if(!this._elevation)return;const l=this._elevation,p=u.cb(1,this._center.lat)*this.worldSize,y=this._computeCameraPosition(p),v=l.getAtPointOrZero(new u.ac(...y)),b=this.pixelsPerMeter/this.worldSize*v,D=this._minimumHeightOverTerrain(),C=y[2]-b;if(C<=D)if(C<0||r){const P=this.locationCoordinate(this._center,this._centerAltitude),O=[y[0],y[1],P.z-y[2]],N=u.ae(O);O[2]-=(D-C)/this._pixelsPerMercatorPixel;const F=u.ae(O);if(0===F)return;u.c1(O,O,N/F*this._pixelsPerMercatorPixel),this._camera.position=[y[0],y[1],P.z*this._pixelsPerMercatorPixel-O[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const r="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||r){const F=this.center;return F.lat=u.ay(F.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!r)&&(F.lng=u.ay(F.lng,this.minLng,this.maxLng)),this.center=F,void(this._constraining=!1)}const l=this._unmodified,{x:p,y}=this.point;let v=0,b=p,D=y;const C=this.width/2,P=this.height/2,O=this.worldMinY*this.scale,N=this.worldMaxY*this.scale;if(y-P<O&&(D=O+P),y+P>N&&(D=N-P),N-O<this.height&&(v=Math.max(v,this.height/(N-O)),D=(N+O)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const F=this.worldMinX*this.scale,B=this.worldMaxX*this.scale,H=this.worldSize/2-(F+B)/2;b=(p+H+this.worldSize)%this.worldSize-H,b-C<F&&(b=F+C),b+C>B&&(b=B-C),B-F<this.width&&(v=Math.max(v,this.width/(B-F)),b=(B+F)/2)}b===p&&D===y||this._allowWorldUnderZoom||(this.center=this.unproject(new u.P(b,D))),v&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(v)),this._constrainCamera(),this._unmodified=l,this._constraining=!1}_minZoomForBounds(){let r=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(r=Math.max(r,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),r}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const r=this.centerOffset,l="globe"===this.projection.name,p=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=u.cb(1,this.center.lat)/u.cb(1,u.c$));const y=u.cL(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,y),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const v="meters"===this.projection.zAxisUnit?p:1,b=this._camera.getWorldToCamera(this.worldSize,v);let D;const C=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(C[8]=2*-r.x/this.width,C[9]=2*r.y/this.height,this.isOrthographic){let ce=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ue=ce*this.aspect,Me=-ue,ye=-ce;ue-=r.x,Me-=r.x,ce+=r.y,ye+=r.y,D=this._camera.getCameraToClipOrthographic(Me,ue,ye,ce,this._nearZ,this._farZ),((je,Fe,Ge,rt)=>{for(let De=0;De<16;De++)je[De]=u.ai(Fe[De],Ge[De],rt)})(D,D,C,u.cZ(this.pitch>=15?1:this.pitch/15))}else D=C;const P=u.cM([],C,b);let O=u.cM([],D,b);if(this.projection.isReprojectedInTileSpace){const ce=this.locationCoordinate(this.center),ue=u.bx([]);u.bo(ue,ue,[ce.x*this.worldSize,ce.y*this.worldSize,0]),u.az(ue,ue,u.cN(this)),u.bo(ue,ue,[-ce.x*this.worldSize,-ce.y*this.worldSize,0]),u.az(O,O,ue),u.az(P,P,ue),this.inverseAdjustmentMatrix=u.cO(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=u.cP([],O,[this.worldSize,this.worldSize,this.worldSize/v,1]),this.projMatrix=O,this.invProjMatrix=u.bi(new Float64Array(16),this.projMatrix),l){const ce=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);ce[8]=2*-r.x/this.width,ce[9]=2*r.y/this.height,this.expandedFarZProjMatrix=u.cM([],ce,b)}else this.expandedFarZProjMatrix=this.projMatrix;const N=u.bi([],D);this.frustumCorners=u.cQ.fromInvProjectionMatrix(N,this.horizonLineFromTop(),this.height),this.cameraFrustum=u.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!l);const F=new Float32Array(16);u.bx(F),u.cP(F,F,[1,-1,1]),u.cR(F,F,this._pitch),u.by(F,F,this.angle);const B=u.c9(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=u.bw(B);const H=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;B[8]=2*-r.x/this.width,B[9]=2*(r.y+H)/this.height,this.skyboxMatrix=u.az(F,B,F);const U=this.point,q=U.x,G=U.y,Y=this.width%2/2,ee=this.height%2/2,ne=Math.cos(this.angle),le=Math.sin(this.angle),de=q-Math.round(q)+ne*Y+le*ee,pe=G-Math.round(G)+ne*ee+le*Y,ae=new Float64Array(O);if(u.bo(ae,ae,[de>.5?de-1:de,pe>.5?pe-1:pe,0]),this.alignedProjMatrix=ae,O=u.bz(),u.cP(O,O,[this.width/2,-this.height/2,1]),u.bo(O,O,[1,-1,0]),this.labelPlaneMatrix=O,O=u.bz(),u.cP(O,O,[1,-1,1]),u.bo(O,O,[-1,-1,0]),u.cP(O,O,[2/this.width,2/this.height,1]),this.glCoordMatrix=O,this.pixelMatrix=u.az(new Float64Array(16),this.labelPlaneMatrix,P),this._calcFogMatrices(),this._distanceTileDataCache={},O=u.bi(new Float64Array(16),this.pixelMatrix),!O)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=O,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=u.cS(this);const ce=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=u.ad(ce,ce,b),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=O;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const r=this.cameraWorldSizeForFog,l=this.cameraPixelsPerMeter,p=this._camera.position,y=1/this.height/this._pixelsPerMercatorPixel,v=[r,r,l];u.c1(v,v,y),u.c1(p,p,-1),u.cT(p,p,v);const b=u.bz();u.bo(b,b,p),u.cP(b,b,v),this.mercatorFogMatrix=b,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(r,l,y)}_computeCameraPosition(r){const l=(r=r||this.pixelsPerMeter)/this.pixelsPerMeter,p=this._camera.forward(),y=this.point,v=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*l-r/this.worldSize*this._centerAltitude;return[y.x/this.worldSize-p[0]*v,y.y/this.worldSize-p[1]*v,r/this.worldSize*this._centerAltitude-p[2]*v]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(r){const l=this._maxCameraBoundsDistance()*Math.cos(this._pitch),p=this._camera.position[2],y=r[2];let v=1;this.projection.wrap&&(this.center=this.center.wrap()),y>0&&(v=Math.min((l-p)/y,1)),this._camera.position=u.bE([],this._camera.position,r,v),this._updateStateFromCamera()}_updateStateFromCamera(){const r=this._camera.position,l=this._camera.forward(),{pitch:p,bearing:y}=this._camera.getPitchBearing(),v=u.cb(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,b=this._mercatorZfromZoom(this._maxZoom)*Math.cos(u.al(this._maxPitch)),D=Math.max((r[2]-v)/Math.cos(p),b),C=this._zoomFromMercatorZ(D);u.bE(r,r,l,D),this._pitch=u.ay(p,u.al(this.minPitch),u.al(this.maxPitch)),this.angle=u.bQ(y,-Math.PI,Math.PI),this._setZoom(u.ay(C,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new u.ac(r[0],r[1],r[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(r){return Math.pow(2,r)*this.tileSize}_mercatorZfromZoom(r){return this.cameraToCenterDistance/this._worldSizeFromZoom(r)}_minimumHeightOverTerrain(){const r=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(r)}_zoomFromMercatorZ(r){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,r)*this.tileSize))}zoomFromMercatorZAdjusted(r){let l=0,p=u.cI,y=0,v=1/0;for(;p-l>1e-6&&p>l;){const b=l+.5*(p-l),D=this.tileSize*Math.pow(2,b),C=this.getCameraToCenterDistance(this.projection,b,D),P=this.scaleZoom(C/(Math.max(0,r)*this.tileSize)),O=Math.abs(b-P);O<v&&(v=O,y=b),b<P?l=b:p=b}return y}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(u.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(r,l){const p=Math.min(r.x,l.x),y=Math.max(r.x,l.x),v=Math.min(r.y,l.y),b=Math.max(r.y,l.y);if(v<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const D=[new u.P(p,v),new u.P(y,b),new u.P(p,b),new u.P(y,v)],C=this.renderWorldCopies?-3:0,P=this.renderWorldCopies?4:1;for(const O of D){const N=this.pointRayIntersection(O);if(N.t<0)return!0;const F=this.rayIntersectionCoordinate(N);if(F.x<C||F.y<0||F.x>P||F.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+u.cU(this.fovAboveCenter)>88||this.anyCornerOffEdge(new u.P(0,0),new u.P(this.width,this.height))}zoomDeltaToMovement(r,l){const p=u.ae(u.at([],this._camera.position,r)),y=this._zoomFromMercatorZ(p)+l;return p-this._mercatorZfromZoom(y)}getCameraPoint(){if("globe"===this.projection.name){const r=function([l,p,y],v){const b=[l,p,y,1];u.aA(b,b,v);const D=b[3]=Math.max(b[3],1e-6);return b[0]/=D,b[1]/=D,b[2]/=D,b}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new u.P(r[0],r[1])}{const r=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new u.P(0,r))}}getCameraToCenterDistance(r,l=this.zoom,p=this.worldSize){const y=u.cL(r,l,this.width,this.height,1024),v=r.pixelSpaceConversion(this.center.lat,p,y);let b=.5/Math.tan(.5*this._fov)*this.height*v;return this.isOrthographic&&(b=u.ai(1,b,u.cZ(this.pitch>=15?1:this.pitch/15))),b}getWorldToCameraMatrix(){const r=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&u.az(r,r,this.globeMatrix),r}getFrustum(r){return u.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,r,"meters"===this.projection.zAxisUnit)}}const xo=(f,r)=>{if(r>0&&f.terrain&&u.w("Cutoff is currently disabled on terrain"),r<=0||f.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const l=f.transform,p=Math.max(Math.abs(l._zoom-(f.minCutoffZoom-1)),1),y=l.isLODDisabled(!1)?u.af(60,45,l.pitch):u.af(30,15,l.pitch),v=l._farZ-l._nearZ,b=r*l.height,D=((1-(C=y))*l.cameraToCenterDistance+C*(l._farZ+b))*p;var C;return{shouldRenderCutoff:y<1,uniformValues:{u_cutoff_params:[l._nearZ,l._farZ,(D-l._nearZ)/v,(D-b-l._nearZ)/v]}}},eo={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Go{constructor(r,l){this.aabb=r,this.lastCascade=l}}class Oa{add(r,l){const p=this.receivers[r.key];void 0!==p?(p.aabb.min[0]=Math.min(p.aabb.min[0],l.min[0]),p.aabb.min[1]=Math.min(p.aabb.min[1],l.min[1]),p.aabb.min[2]=Math.min(p.aabb.min[2],l.min[2]),p.aabb.max[0]=Math.max(p.aabb.max[0],l.max[0]),p.aabb.max[1]=Math.max(p.aabb.max[1],l.max[1]),p.aabb.max[2]=Math.max(p.aabb.max[2],l.max[2])):this.receivers[r.key]=new Go(l,null)}clear(){this.receivers={}}get(r){return this.receivers[r.key]}computeRequiredCascades(r,l,p){const y=u.d6.fromPoints(r.points);let v=0;for(const b in this.receivers){const D=this.receivers[b];if(!D||!y.intersectsAabb(D.aabb))continue;D.aabb.min=y.closestPoint(D.aabb.min),D.aabb.max=y.closestPoint(D.aabb.max);const C=D.aabb.getCorners();for(let P=0;P<p.length;P++){let O=!0;for(const N of C){const F=[N[0]*l,N[1]*l,N[2]];if(u.ad(F,F,p[P].matrix),F[0]<-1||F[0]>1||F[1]<-1||F[1]>1){O=!1;break}}if(D.lastCascade=P,v=Math.max(v,P),O)break}}return v+1}}class qi{constructor(r){this.painter=r,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Oa,this._depthMode=new bt(r.context.gl.LEQUAL,bt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,r.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),r.tp.registerParameter(eo,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),r.tp.registerParameter(eo,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),r.tp.registerParameter(eo,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),r.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const r of this._cascades)r.texture.destroy(),r.framebuffer.destroy();this._cascades=[]}updateShadowParameters(r,l){const p=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!l||!l.properties)return;const y=l.properties.get("shadow-intensity");if(!l.shadowsEnabled()||y<=0||(this._shadowLayerCount=p.style.order.reduce((H,U)=>{const q=p.style._mergedLayers[U];return H+(q.hasShadowPass()&&!q.isHidden(r.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const v=p.context,b=eo.shadowMapResolution,D=eo.shadowMapResolution;if(0===this._cascades.length||eo.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let H=0;H<eo.cascadeCount;++H){const U=p._shadowMapDebug,q=v.gl,G=v.createFramebuffer(b,D,U,"texture"),Y=new u.T(v,{width:b,height:D,data:null},q.DEPTH_COMPONENT16);if(G.depthAttachment.set(Y.texture),U){const ee=new u.T(v,{width:b,height:D,data:null},q.RGBA8);G.colorAttachment.set(ee.texture)}this._cascades.push({framebuffer:G,texture:Y,matrix:[],far:0,boundingSphereRadius:0,frustum:new u.cy,scale:0})}}this.shadowDirection=Wl(l);let C=0;if(r.elevation){const H=r.elevation,U=[1e4,-1e4];H.visibleDemTiles.filter(q=>q.dem).forEach(q=>{const G=q.dem.tree;U[0]=Math.min(U[0],G.minimums[0]),U[1]=Math.max(U[1],G.maximums[0])}),1e4!==U[0]&&(C=(U[1]-U[0])*H.exaggeration())}const P=1.5*r.cameraToCenterDistance,O=3*P,N=new Float64Array(16);for(let H=0;H<this._cascades.length;++H){const U=this._cascades[H];let q=r.height/50,G=1;1===eo.cascadeCount?G=O:0===H?G=P:(q=P,G=O);const[Y,ee]=Bc(r,this.shadowDirection,q,G,eo.shadowMapResolution,C);U.scale=r.scale,U.matrix=Y,U.boundingSphereRadius=ee,u.bi(N,U.matrix),U.frustum=u.cy.fromInvProjectionMatrix(N,1,0,!0),U.far=G}const F=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[F].far,this._cascades[F].far],this._uniformValues.u_shadow_intensity=y,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/eo.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=eo.shadowMapResolution,this._uniformValues.u_shadowmap_0=Qr.ShadowMap0,this._uniformValues.u_shadowmap_1=Qr.ShadowMap0+1,this._groundShadowTiles=p.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const B=p.transform.elevation;for(const H of this._groundShadowTiles){let U={min:0,max:0};if(B){const q=B.getMinMaxForTile(H);q&&(U=q)}this.addShadowReceiver(H.toUnwrapped(),U.min,U.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(r){this._enabled=r}drawShadowPass(r,l){if(!this.enabled)return;const p=this.painter,y=p.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(p.transform.getFrustum(0),p.transform.worldSize,this._cascades),y.viewport.set([0,0,eo.shadowMapResolution,eo.shadowMapResolution]);for(let v=0;v<this._numCascadesToRender;++v){p.currentShadowCascade=v,y.bindFramebuffer.set(this._cascades[v].framebuffer.framebuffer),y.clear({color:u.am.white,depth:1});for(const b of r.order){const D=r._mergedLayers[b];if(!D.hasShadowPass()||D.isHidden(p.transform.zoom))continue;const C=r.getLayerSourceCache(D),P=C?l[C.id]:void 0;("model"===D.type||P&&P.length)&&p.renderLayer(p,C,D,P)}}p.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const r=this.painter,l=r.style,p=r.context,y=p.gl,v=l.directionalLight,b=l.ambientLight;if(!v||!b)return;const D=[],C=xo(r,r.longestCutoffRange);C.shouldRenderCutoff&&D.push("RENDER_CUTOFF"),D.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&D.push("NORMAL_OFFSET");const P=nl(l,v,b),O=new bt(y.LEQUAL,bt.ReadOnly,r.depthRangeFor3D),N=new Vt({func:y.EQUAL,mask:255},0,255,y.KEEP,y.KEEP,y.KEEP);for(const F of this._groundShadowTiles){const B=F.toUnwrapped(),H=r.isTileAffectedByFog(F),U=r.getOrCreateProgram("groundShadow",{defines:D,overrideFog:H});this.setupShadows(B,U),r.uploadCommonUniforms(p,U,B,null,C);const q={u_matrix:r.transform.calculateProjMatrix(B),u_ground_shadow_factor:P};U.draw(r,y.TRIANGLES,O,N,an.multiply,Bt.disabled,q,"ground_shadow",r.tileExtentBuffer,r.quadTriangleIndexBuffer,r.tileExtentSegments,null,r.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?an.unblended:an.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(r){const l=this.painter.transform,p=l.calculatePosMatrix(r,l.worldSize);return u.az(p,this._cascades[this.painter.currentShadowCascade].matrix,p),Float32Array.from(p)}calculateShadowPassMatrixFromMatrix(r){return u.az(r,this._cascades[this.painter.currentShadowCascade].matrix,r),Float32Array.from(r)}setupShadows(r,l,p){if(!this.enabled)return;const y=this.painter.transform,v=this.painter.context,b=v.gl,D=this._uniformValues,C=new Float64Array(16),P=y.calculatePosMatrix(r,y.worldSize);for(let O=0;O<this._cascades.length;O++)u.az(C,this._cascades[O].matrix,P),D[0===O?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(C),v.activeTexture.set(b.TEXTURE0+Qr.ShadowMap0+O),this._cascades[O].texture.bindExtraParam(b.LINEAR,b.LINEAR,b.CLAMP_TO_EDGE,b.CLAMP_TO_EDGE,b.GREATER);if(this.useNormalOffset=!!p,this.useNormalOffset){const O=u.d4(r.canonical),N=2/y.tileSize*u.aj/eo.shadowMapResolution,F=N*this._cascades[0].boundingSphereRadius,B=N*this._cascades[this._cascades.length-1].boundingSphereRadius,H=("vector-tile"===p?1:3)*function(U,q,G,Y,ee){const ne=u.ay((U-22)/-22,0,1);return.125*(1-ne)+4*ne}(y.zoom);D.u_shadow_normal_offset=[O,F*H,B*H],D.u_shadow_bias=[1e-4,.0012,.012]}else D.u_shadow_bias=[36e-5,.0012,.012];l.setShadowUniformValues(v,D)}setupShadowsFromMatrix(r,l,p=!1){if(!this.enabled)return;const y=this.painter.context,v=y.gl,b=this._uniformValues,D=new Float64Array(16);for(let C=0;C<eo.cascadeCount;C++)u.az(D,this._cascades[C].matrix,r),b[0===C?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(D),y.activeTexture.set(v.TEXTURE0+Qr.ShadowMap0+C),this._cascades[C].texture.bindExtraParam(v.LINEAR,v.LINEAR,v.CLAMP_TO_EDGE,v.CLAMP_TO_EDGE,v.GREATER);if(this.useNormalOffset=p,p){const C=eo.normalOffset;b.u_shadow_normal_offset=[1,C,C],b.u_shadow_bias=[6e-5,.0012,.012]}else b.u_shadow_bias=[36e-5,.0012,.012];l.setShadowUniformValues(y,b)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(r,l,p,y){if(y[2]>=0)return{};const v=function(C,P,O){const N=O/(1<<C.canonical.z);return new u.d6([C.canonical.x*N+C.wrap*O,C.canonical.y*N+C.wrap*O,0],[(C.canonical.x+1)*N+C.wrap*O,(C.canonical.y+1)*N+C.wrap*O,P])}(r,l,p).getCorners(),b=l/-y[2];y[0]<0?(u.d5(v[0],v[0],[y[0]*b,0,0]),u.d5(v[3],v[3],[y[0]*b,0,0])):y[0]>0&&(u.d5(v[1],v[1],[y[0]*b,0,0]),u.d5(v[2],v[2],[y[0]*b,0,0])),y[1]<0?(u.d5(v[0],v[0],[0,y[1]*b,0]),u.d5(v[1],v[1],[0,y[1]*b,0])):y[1]>0&&(u.d5(v[2],v[2],[0,y[1]*b,0]),u.d5(v[3],v[3],[0,y[1]*b,0]));const D={};return D.vertices=v,D.planes=[ma(v[1],v[0],v[4]),ma(v[2],v[1],v[5]),ma(v[3],v[2],v[6]),ma(v[0],v[3],v[7])],D}addShadowReceiver(r,l,p){this._receivers.add(r,u.d6.fromTileIdAndHeight(r,l,p))}getMaxCascadeForTile(r){const l=this._receivers.get(r);return l&&l.lastCascade?l.lastCascade:0}}function ma(f,r,l){const p=u.at([],l,r),y=u.at([],f,r),v=u.bF([],p,y),b=u.ae(v);return 0===b?[0,0,1,0]:(u.c1(v,v,1/b),[v[0],v[1],v[2],-u.bG(v,r)])}function Wl(f){const r=f.properties.get("direction"),l=u.d1(r.x,r.y,r.z);l[2]=u.ay(l[2],0,75);const p=u.d3([l[0],l[1],l[2]]);return u.d2(p.x,p.y,p.z)}function nl(f,r,l){const p="none"===r.properties.get("color-use-theme"),y=r.properties.get("color"),v=r.properties.get("intensity"),b=r.properties.get("direction"),D=[b.x,b.y,b.z],C="none"===l.properties.get("color-use-theme"),P=l.properties.get("color"),O=l.properties.get("intensity"),N=Math.max(u.bG([0,0,1],D),0),F=[0,0,0];u.c1(F,P.toPremultipliedRenderColor(C?null:f.getLut(r.scope)).toArray01Linear().slice(0,3),O);const B=[0,0,0];return u.c1(B,y.toPremultipliedRenderColor(p?null:f.getLut(l.scope)).toArray01Linear().slice(0,3),N*v),u.d8([F[0]>0?F[0]/(F[0]+B[0]):0,F[1]>0?F[1]/(F[1]+B[1]):0,F[2]>0?F[2]/(F[2]+B[2]):0])}function Bc(f,r,l,p,y,v){const b=f.zoom,D=f.scale,C=f.worldSize,P=1/C,O=f.aspect,N=Math.sqrt(1+O*O)*Math.tan(.5*f.fovX),F=N*N,B=p-l,H=p+l;let U,q;F>B/H?(U=p,q=p*N):(U=.5*H*(1+F),q=.5*Math.sqrt(B*B+2*(p*p+l*l)*F+H*H*F*F));const G=f.projection.pixelsPerMeter(f.center.lat,C),Y=f._camera.getCameraToWorldMercator(),ee=[0,0,-U*P];u.ad(ee,ee,Y);let ne=q*P;const le=f._edgeInsets;if(!(0===le.left&&0===le.top&&0===le.right&&0===le.bottom||le.left===le.right&&le.top===le.bottom)){const We=f._camera.getWorldToCamera(f.worldSize,"meters"===f.projection.zAxisUnit?G:1),Ze=f._camera.getCameraToClipPerspective(f._fov,f.width/f.height,l,p);Ze[8]=2*-f.centerOffset.x/f.width,Ze[9]=2*f.centerOffset.y/f.height;const Ye=new Float64Array(16);u.cM(Ye,Ze,We);const ct=new Float64Array(16);u.bi(ct,Ye);const Mt=u.cy.fromInvProjectionMatrix(ct,C,b,!0);for(const kt of Mt.points){const vt=((de=kt)[0]/=D,de[1]/=D,de[2]=u.cb(de[2],f._center.lat),de);ne=Math.max(ne,u.c2(u.d7([],ee,vt)))}}var de;ne*=y/(y-1);const pe=Math.acos(r[2]),ae=Math.atan2(-r[0],-r[1]),ce=new bs;ce.position=ee,ce.setPitchBearing(pe,ae);const ue=ce.getWorldToCamera(C,G),Me=ne*C,ye=Math.min(f._mercatorZfromZoom(17)*C*-2,-2*Me),je=ce.getCameraToClipOrthographic(-Me,Me,-Me,Me,ye,(Me+v*G)/r[2]),Fe=new Float64Array(16);u.az(Fe,je,ue);const Ge=u.d2(Math.floor(1e6*ee[0])/1e6*C,Math.floor(1e6*ee[1])/1e6*C,0),rt=.5*y,De=[0,0,0];u.ad(De,Ge,Fe),u.c1(De,De,rt);const _e=[Math.floor(De[0]),Math.floor(De[1]),Math.floor(De[2])],Ne=[0,0,0];u.at(Ne,De,_e),u.c1(Ne,Ne,-1/rt);const Re=new Float64Array(16);return u.bx(Re),u.bo(Re,Re,Ne),u.az(Fe,Re,Fe),[Fe,Me]}class Fa extends u.E{constructor(r){super(),this.requestManager=r,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(r,l){return u.aS(this.requestManager.transformRequest(l,u.R.Model).url).then(p=>{if(!p)return;const y=u.aT(p),v=new u.aU(r,void 0,void 0,y);return v.computeBoundsAndApplyParent(),v}).catch(p=>{if(p&&404===p.status)return null;this.fire(new u.z(new Error(`Could not load model ${r} from ${l}: ${p.message}`)))})}load(r,l,p={forceReload:!1}){this.models[l]||(this.models[l]={});const y=Object.keys(r),v=[],b=[];for(const D of y){const C=r[D];this.hasURLBeenRequested(C)&&!p.forceReload||(this.modelByURL[C]={modelId:D,scope:l},v.push(this.loadModel(D,C)),b.push(D)),this.models[l][D]||(this.models[l][D]={model:null,numReferences:1})}this.numModelsLoading[l]=(this.numModelsLoading[l]||0)+b.length,Promise.allSettled(v).then(D=>{for(let C=0;C<D.length;C++){const{status:P}=D[C];if("rejected"===P)continue;const{value:O}=D[C];this.models[l][b[C]]||(this.models[l][b[C]]={model:null,numReferences:1}),this.models[l][b[C]].model=O}this.numModelsLoading[l]-=b.length,this.fire(new u.A("data",{dataType:"style"}))}).catch(D=>{this.fire(new u.z(new Error(`Could not load models: ${D.message}`)))})}isLoaded(){for(const r in this.numModelsLoading)if(this.numModelsLoading[r]>0)return!1;return!0}hasModel(r,l,p={exactIdMatch:!1}){return!!(p.exactIdMatch?this.getModel(r,l):this.getModelByURL(this.modelUris[l][r]))}getModel(r,l){return this.models[l]||(this.models[l]={}),this.models[l][r]?this.models[l][r].model:void 0}getModelByURL(r){if(!r)return null;const l=this.modelByURL[r];return l?this.models[l.scope][l.modelId].model:null}hasModelBeenAdded(r,l){return this.models[l]&&void 0!==this.models[l][r]}getModelURIs(r){return this.modelUris[r]||{}}addModel(r,l,p){this.models[p]||(this.models[p]={}),this.modelUris[p]||(this.modelUris[p]={});const y=this.requestManager.normalizeModelURL(l);if((this.hasModel(r,p,{exactIdMatch:!0})||this.hasModelBeenAdded(r,p))&&this.modelUris[p][r]===y)this.models[p][r].numReferences++;else if(this.hasURLBeenRequested(y)){const{scope:v,modelId:b}=this.modelByURL[y];this.models[v][b].numReferences++}else this.modelUris[p][r]=y,this.load({[r]:this.modelUris[p][r]},p)}addModelURLs(r,l){this.models[l]||(this.models[l]={}),this.modelUris[l]||(this.modelUris[l]={});const p=this.modelUris[l];for(const y in r)p[y]=this.requestManager.normalizeModelURL(r[y])}reloadModels(r){this.load(this.modelUris[r],r,{forceReload:!0})}addModelsFromBucket(r,l){this.models[l]||(this.models[l]={}),this.modelUris[l]||(this.modelUris[l]={});const p={};for(const y of r)this.hasModel(y,l,{exactIdMatch:!0})||this.hasURLBeenRequested(y)?this.models[l][y].numReferences++:this.modelUris[l][y]&&!this.hasURLBeenRequested(y)?p[y]=this.modelUris[l][y]:!this.hasURLBeenRequested(y)&&u.d9(y,!1)&&(this.modelUris[l][y]=this.requestManager.normalizeModelURL(y),p[y]=this.modelUris[l][y]);this.load(p,l)}hasURLBeenRequested(r){return void 0!==this.modelByURL[r]}removeModel(r,l,p=!1,y=!1){if(this.models[l]&&this.models[l][r]&&(this.models[l][r].numReferences--,0===this.models[l][r].numReferences||y)){const v=this.modelUris[l][r];p||delete this.modelUris[l][r],delete this.modelByURL[v];const b=this.models[l][r].model;if(!b)return;delete this.models[l][r],b.destroy()}}destroy(){for(const r of Object.keys(this.models))for(const l of Object.keys(this.models[r])){const p=this.models[r][l].model;delete this.models[r][l],p&&p.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(r){return this.models[r]||(this.models[r]={}),Object.keys(this.models[r])}upload(r,l){this.models[l]||(this.models[l]={});for(const p in this.models[l])this.models[l][p].model&&this.models[l][p].model.upload(r.context)}}const Zl=new u.a7({data:new u.a8(u.a5.colorTheme.data)});class bf{constructor(r){this._scope=r,this._buildingQueryParams={target:{featuresetId:"building-outline",importId:this._scope}},this._floorQueryParams={target:{featuresetId:"floor-outline",importId:this._scope}}}execute(r){const l=this._makeBuildingsQueryArea(r),p=this._makeFloorsQueryArea(r),y=r.queryRenderedFeatures(l,this._buildingQueryParams).filter(D=>"building"===D.properties.shape_type).reduce((D,C)=>{const P=C.properties.id;return"building"!==C.properties.shape_type||D.some(O=>O.properties.id===P)||D.push(C),D},[]),v=r.queryRenderedFeatures(p,this._floorQueryParams).filter(D=>"floor"===D.properties.shape_type).reduce((D,C)=>{const P=C.properties.id;return"floor"!==C.properties.shape_type||D.some(O=>O.properties.id===P)||D.push(C),D},[]),b=[r.getCenter().lng,r.getCenter().lat];return{floors:v,building:this._findBuildingAtCenter(b,y)||(y.length>0?y[0]:null)}}_makeBuildingsQueryArea(r){const l=r.transform.width,p=r.transform.height,y=Math.min(l,p),v=y*(1/8),b=y*(1/8),D=.5*(l-v),C=.5*(p-b);return[new u.P(D,C),new u.P(D+v,C+b)]}_makeFloorsQueryArea(r){const l=r.transform.width,p=r.transform.height,y=l*(2/3),v=p*(2/3),b=.5*(l-y),D=.5*(p-v);return[new u.P(b,D),new u.P(b+y,D+v)]}_findBuildingAtCenter(r,l){for(const p of l)if("Polygon"===p.geometry.type&&this._pointInPolygon(r,p.geometry.coordinates[0]))return p;return null}_pointInPolygon(r,l){let p=!1;for(let y=0,v=l.length-1;y<l.length;v=y++){const b=l[y][0],D=l[y][1],C=l[v][1];D>r[1]!=C>r[1]&&r[0]<(l[v][0]-b)*(r[1]-D)/(C-D)+b&&(p=!p)}return p}}class il{constructor(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}setBuildingId(r){this._selectedBuildingId=r}setFloors(r){if(this._floors=r.filter(l=>l.properties.building_id===this._selectedBuildingId),!this._selectedFloorId||!this._floors.map(l=>l.properties.id).includes(this._selectedFloorId)){const l=this._floors.map(p=>({id:p.properties.id,level:p.properties.floor_level})).reduce((p,y)=>{const v=Math.abs(p.level-1),b=Math.abs(y.level-1);return b<v||b===v&&y.level>p.level?y:p});this._selectedFloorId=l.id}}setFloorId(r){this._selectedFloorId=r}getSelectedFloorId(){return this._selectedFloorId}getCurrentBuildingFloors(){return this._floors}reset(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}}const Kp={"mbx-indoor-level-selected":{default:["literal",[]]}};function Qp(f){return f=f||{},Object.assign(f,Kp)}class Jg extends u.E{constructor(r){super(),u.aV(["_onLoad","_onMove"],this),this._map=r,this._floorSelectionState=new il,this._queryIndoor(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=null,this._floorSelectionState=null}_onLoad(){this._map.style.forEachFragmentStyle(r=>{r.stylesheet.indoor&&(this._indoorDataQuery?this.fire(new u.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._scope=r.scope,this._indoorDataQuery=new bf(this._scope)))}),this._map._addIndoorControl(),this._queryIndoor()}_onMove(){this._queryIndoor()}_queryIndoor(){if(!this._indoorDataQuery||!this._map.isStyleLoaded())return;if(this._map.transform.zoom<16)return void this._clearIndoorData();const r=this._indoorDataQuery.execute(this._map);r&&0!==r.floors.length?(this._floorSelectionState.getSelectedFloorId()||this._map._addIndoorControl(),this._selectFloors(r)):this._clearIndoorData()}_selectFloors(r){if(r.building)this._floorSelectionState.setBuildingId(r.building.properties.id),this._floorSelectionState.setFloors(r.floors),this._updateUI();else{const l=this._floorSelectionState.getSelectedFloorId();if(l&&r.floors.some(p=>p.properties.id===l))return;this._clearIndoorData()}}_clearIndoorData(){this._floorSelectionState.reset(),this._map._removeIndoorControl(),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[]])}_updateUI(){const r=this._floorSelectionState.getCurrentBuildingFloors().map(p=>({id:p.properties.id,name:p.properties.name,shortName:p.properties.floor_level,levelOrder:p.properties.floor_level})),l=this._floorSelectionState.getSelectedFloorId();l?(this._updateIndoorConfig(),this.fire(new u.A("indoorupdate",{selectedFloorId:l,floors:r}))):console.warn("IndoorManager: Selected floor is not set")}_updateIndoorConfig(){const r=this._floorSelectionState.getSelectedFloorId();r?this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[r]]):console.warn("IndoorManager: Selected floor is not set")}selectFloor(r){this._floorSelectionState.setFloorId(r),this._updateIndoorConfig()}}function Uu(f){if(!f.metadata||!f.metadata.content_area)return;const r=u.q.devicePixelRatio,{left:l,top:p,width:y,height:v}=f.metadata.content_area,b=l*r,D=p*r;return[b,D,b+y*r,D+v*r]}function Jp(f){if(f)return f.map(([r,l])=>[r*u.q.devicePixelRatio,l*u.q.devicePixelRatio])}class wf{constructor(r,l,p){this.id=r,this.scope=l,this.sourceCache=p,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(r){this.missingRequests.has(r.name)||this.pendingRequests.has(r.name)||this.pendingRequests.add(r.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const r=new Map;if(!this.sourceCache.loaded())return r;const l=this.sourceCache.getVisibleCoordinates();if(0===l.length)return r;const p=this.sourceCache.getSource();if(!(p instanceof Hl))return r;const y=l.map(b=>this.sourceCache.getTile(b)),v=p.getImages(y,Array.from(this.pendingRequests));for(const[b,D]of v)r.set(u.I.from({name:b,iconsetId:this.id}),D),this.pendingRequests.delete(b);for(const b of this.pendingRequests)this.missingRequests.add(b);return this.pendingRequests.clear(),r}}const Xl=(f,r)=>se(f,r&&r.filter(l=>"source.canvas"!==l.identifier)),em=u.aF(On,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),e_=u.aF(On,["setCenter","setZoom","setBearing","setPitch"]),Ef=new Set(["background","sky","slot","custom"]),bo={version:8,layers:[],sources:{}},Qd={duration:300,delay:0};class js extends u.E{constructor(r,l={}){super(),this.map=r,this.scope=l.scope||"",this.globalId=null,this.fragments=[],this.importDepth=l.importDepth||0,this.importsCache=l.importsCache||new Map,this.resolvedImports=l.resolvedImports||new Set,this.transition=u.h({},Qd),this._buildingIndex=new Gd(this),this.crossTileSymbolIndex=new vo,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=l.styleChanges||new Ld,this.dispatcher=l.dispatcher?l.dispatcher:new u.D(u.db(),this),l.imageManager?this.imageManager=l.imageManager:(this.imageManager=new cr(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=l.glyphManager?l.glyphManager:new u.dc(r._requestManager,l.localFontFamily?u.dd.all:l.localIdeographFontFamily?u.dd.ideographs:u.dd.none,l.localFontFamily||l.localIdeographFontFamily),l.modelManager?this.modelManager=l.modelManager:(this.modelManager=new Fa(r._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=l.configOptions?l.configOptions:new Map,this._configDependentLayers=l.configDependentLayers?l.configDependentLayers:new Set,this._config=l.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:l.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=l.initialConfig,this.dispatcher.broadcast("setReferrer",u.de());const p=this;this._rtlTextPluginCallback=js.registerForPluginStateChange(y=>{p.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:y.pluginStatus,pluginURL:y.pluginURL},(v,b)=>{if(u.df(v),b&&b.every(D=>D))for(const D in p._sourceCaches){const C=p._sourceCaches[D],P=C.getSource().type;"vector"!==P&&"geojson"!==P||C.reload()}})}),this.on("data",y=>{if("source"!==y.dataType||"metadata"!==y.sourceDataType)return;const v=this.getOwnSource(y.sourceId);if(v&&v.vectorLayerIds)for(const b in this._layers){const D=this._layers[b];D.source===v.id&&this._validateLayer(D)}})}load(r){return r?("string"==typeof r?this.loadURL(r):this.loadJSON(r),this):this}_getGlobalId(r){if(!r)return null;if("string"==typeof r){if(u.j(r))return r;const l=u.dg(r);if(!l.startsWith("http"))try{return new URL(l,location.href).toString()}catch{return l}return l}return`json://${u.dh(JSON.stringify(r))}`}_diffStyle(r,l,p){this.globalId=this._getGlobalId(r);const y=(v,b)=>{try{b(null,this.setState(v,p))}catch(D){b(D,!1)}};if("string"==typeof r){const v=this.map._requestManager.normalizeStyleURL(r),b=this.map._requestManager.transformRequest(v,u.R.Style);u.n(b,(D,C)=>{D?this.fire(new u.z(D)):C&&y(C,l)})}else"object"==typeof r&&y(r,l)}loadURL(r,l={}){this.fire(new u.A("dataloading",{dataType:"style"}));const p="boolean"==typeof l.validate?l.validate:!u.j(r);this.globalId=this._getGlobalId(r),r=this.map._requestManager.normalizeStyleURL(r,l.accessToken),this.resolvedImports.add(r);const y=this.importsCache.get(r);if(y)return this._load(y,p);const v=this.map._requestManager.transformRequest(r,u.R.Style);this._request=u.n(v,(b,D)=>{if(this._request=null,b)this.fire(new u.z(b));else if(D)return this.importsCache.set(r,D),this._load(D,p)})}loadJSON(r,l={}){this.fire(new u.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(r),this._request=u.q.frame(()=>{this._request=null,this._load(r,!1!==l.validate)})}loadEmpty(){this.fire(new u.A("dataloading",{dataType:"style"})),this._load(bo,!1)}_loadImports(r,l,p){if(this.importDepth>=4)return u.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const y=[];for(const v of r){const b=this._createFragmentStyle(v),D=new Promise(O=>{b.once("style.import.load",O),b.once("error",O)}).then(()=>this.mergeAll());if(y.push(D),this.resolvedImports.has(v.url)){b.loadEmpty();continue}const C=v.data||this.importsCache.get(v.url);C?(b.loadJSON(C,{validate:l}),this._isInternalStyle(C)&&(b.globalId=null)):v.url?b.loadURL(v.url,{validate:l}):b.loadEmpty();const P={style:b,id:v.id,config:v.config};if(p){const O=this.fragments.findIndex(({id:N})=>N===p);this.fragments=this.fragments.slice(0,O).concat(P).concat(this.fragments.slice(O))}else this.fragments.push(P)}return Promise.allSettled(y)}getImportGlobalIds(r=this,l=new Set){for(const p of r.fragments)p.style.globalId&&l.add(p.style.globalId),this.getImportGlobalIds(p.style,l);return[...l.values()]}_createFragmentStyle(r){const l=this.scope?u.C(r.id,this.scope):r.id;let p;const y=this._initialConfig&&this._initialConfig[l];(r.config||y)&&(p=u.h({},r.config,y));const v=new js(this.map,{scope:l,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:p,configOptions:this.options,colorThemeOverride:r["color-theme"],configDependentLayers:this._configDependentLayers});return v.setEventedParent(this.map,{style:v}),v}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(r){return this.isRootStyle()&&(r.fragment||!!r.schema&&!1!==r.fragment)}_load(r,l){const p=r.indoor?Qp(r.schema):r.schema;if(this._isInternalStyle(r)){const b=u.h({},bo,{imports:[{id:"basemap",data:r,url:""}]});return void this._load(b,l)}if(this.updateConfig(this._config,p),l&&Xl(this,zs(r)))return;this._loaded=!0,this.stylesheet=u.di(r);const y=()=>{for(const P in r.sources)this.addSource(P,r.sources[P],{validate:!1,isInitialLoad:!0});if(r.iconsets)for(const P in r.iconsets)this.addIconset(P,r.iconsets[P]);r.sprite?this._loadIconset(r.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&r.glyphs&&this.glyphManager.setURL(r.glyphs);const b=Li(this.stylesheet.layers);if(this._order=b.map(P=>P.id),this.stylesheet.light&&u.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const P=this.stylesheet.lights[0];this.light=new ke(P.properties,P.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new ke(this.stylesheet.light)),this._layers={};for(const P of b){const O=u.dn(P,this.scope,this._styleColorTheme.lut,this.options);0!==O.configDependencies.size&&this._configDependentLayers.add(O.fqid),O.setEventedParent(this,{layer:{id:O.id}}),this._layers[O.id]=O;const N=this.getOwnLayerSourceCache(O),F=!!this.directionalLight&&this.directionalLight.shadowsEnabled();N&&O.canCastShadows()&&F&&(N.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const D=this.stylesheet.terrain;D&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(D,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new u.A("data",{dataType:"style"}));const C=this.isRootStyle();r.imports?this._loadImports(r.imports,l).then(()=>{this._reloadImports(),this.fire(new u.A(C?"style.load":"style.import.load"))}).catch(P=>{this.fire(new u.z(new Error("Failed to load imports",P))),this.fire(new u.A(C?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new u.A(C?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const v=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(v){const b=this._evaluateColorThemeData(v);this._loadColorTheme(b).then(()=>{y()}).catch(D=>{u.w(`Couldn't load color theme from the stylesheet: ${D}`),y()})}else this._styleColorTheme.lut=null,y()}isRootStyle(){return 0===this.importDepth}mergeAll(){let r,l,p,y,v,b,D,C,P,O;const N={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(F=>{if(F.stylesheet){if(null!=F.light&&(r=F.light),F.stylesheet.lights)for(const B of F.stylesheet.lights)"ambient"===B.type&&null!=F.ambientLight&&(l=F.ambientLight),"directional"===B.type&&null!=F.directionalLight&&(p=F.directionalLight);y=this._prioritizeTerrain(y,F.terrain,F.stylesheet.terrain),F.stylesheet.fog&&null!=F.fog&&(v=F.fog),F.stylesheet.snow&&null!=F.snow&&(b=F.snow),F.stylesheet.rain&&null!=F.rain&&(D=F.rain),null!=F.stylesheet.camera&&(O=F.stylesheet.camera),null!=F.stylesheet.projection&&(C=F.stylesheet.projection),null!=F.stylesheet.transition&&(P=F.stylesheet.transition),N[F.scope]=F._styleColorTheme}}),this.light=r,this.ambientLight=l,this.directionalLight=p,this.fog=v,this.snow=b,this.rain=D,this._styleColorThemeForScope=N,null===y?delete this.terrain:this.terrain=y,this.camera=O||{"camera-projection":"perspective"},this.projection=C||{name:"mercator"},this.transition=u.h({},Qd,P),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(r){const l=p=>{for(const y of p.fragments)l(y.style);r(p)};l(this)}_prioritizeTerrain(r,l,p){const y=r&&0===r.drapeRenderMode;return null===p?l&&0===l.drapeRenderMode?l:y?r:null:null!=l&&(!r||y||l&&1===l.drapeRenderMode)?l:r}mergeTerrain(){let r;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(l=>{r=this._prioritizeTerrain(r,l.terrain,l.stylesheet.terrain)}),null===r?delete this.terrain:this.terrain=r}mergeProjection(){let r;this.forEachFragmentStyle(l=>{null!=l.stylesheet.projection&&(r=l.stylesheet.projection)}),this.projection=r||{name:"mercator"}}mergeSources(){const r={},l={},p={};this.forEachFragmentStyle(y=>{for(const v in y._sourceCaches){const b=u.C(v,y.scope);r[b]=y._sourceCaches[v]}for(const v in y._otherSourceCaches){const b=u.C(v,y.scope);l[b]=y._otherSourceCaches[v]}for(const v in y._symbolSourceCaches){const b=u.C(v,y.scope);p[b]=y._symbolSourceCaches[v]}}),this._mergedSourceCaches=r,this._mergedOtherSourceCaches=l,this._mergedSymbolSourceCaches=p}mergeLayers(){const r={},l=[],p={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(v=>{for(const b of v._order){const D=v._layers[b];if("slot"===D.type){const C=u.dj(b);if(r[C])continue;r[C]=[]}D.slot&&r[D.slot]?r[D.slot].push(D):l.push(D)}}),this._mergedOrder=[];const y=(v=[])=>{for(const b of v)if("slot"===b.type){const D=u.dj(b.id);r[D]&&y(r[D]),this._mergedSlots.push(D)}else{const D=u.C(b.id,b.scope);this._mergedOrder.push(D),p[D]=b,b.is3D(!!this.terrain)&&(this._has3DLayers=!0),"circle"===b.type&&(this._hasCircleLayers=!0),"symbol"===b.type&&(this._hasSymbolLayers=!0),"clip"===b.type&&(this._clipLayerPresent=!0)}};y(l),this._mergedOrder.sort((v,b)=>{const D=p[v],C=p[b];return D.hasInitialOcclusionOpacityProperties?C.is3D(!!this.terrain)?1:0:D.is3D(!!this.terrain)&&C.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=p,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(r){return this.stylesheet.camera=u.h({},this.stylesheet.camera,r),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(r){return r.data?function(l,p,y,v){const b=u.h({},p);for(const C of Object.keys(u.a5.colorTheme))void 0===b[C]&&(b[C]=u.a5.colorTheme[C].default);const D=new u.a6(Zl,l,new Map(y));return D.setTransitionOrValue(b,y),D.untransitioned().possiblyEvaluate(new u.aa(0,{worldview:void 0}))}(this.scope,r,this.options).get("data"):null}_loadColorTheme(r){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const l=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((p,y)=>{const v="data:image/png;base64,";if(!r||0===r.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void p();let b=r;b.startsWith(v)||(b=v+b);const D=u.I.from("mapbox-reserved-lut"),C=new Image;C.src=b,C.onerror=()=>{this._styleColorTheme.lutLoading=!1,y(new Error("Failed to load image data"))},C.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==l)return void p();this._styleColorTheme.lutLoading=!1;const{width:P,height:O,data:N}=u.q.getImageData(C);if(O>32)return void y(new Error("The height of the image must be less than or equal to 32 pixels."));if(P!==O*O)return void y(new Error("The width of the image must be equal to the height squared."));this.getImage(D)&&this.removeImage(D),this.addImage(D,{data:new u.r({width:P,height:O},N),pixelRatio:1,sdf:!1,usvg:!1,version:0});const F=this.imageManager.getImage(D,this.scope);F?(this._styleColorTheme.lut={image:F.data,data:r},p()):y(new Error("Missing LUT image."))}})}getLut(r){const l=this._styleColorThemeForScope[r];return l?l.lut:null}setProjection(r){r?this.stylesheet.projection=r:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(r){this._spriteRequest=function(l,p,y){let v,b,D;const C=u.q.devicePixelRatio>1?"@2x":"";let P=u.n(p.transformRequest(p.normalizeSpriteURL(l,C,".json"),u.R.SpriteJSON),(F,B)=>{P=null,D||(D=F,v=B,N())}),O=u.o(p.transformRequest(p.normalizeSpriteURL(l,C,".png"),u.R.SpriteImage),(F,B)=>{O=null,D||(D=F,b=B,N())});function N(){if(D)y(D);else if(v&&b){const F=u.q.getImageData(b),B={};for(const H in v){const{width:U,height:q,x:G,y:Y,sdf:ee,pixelRatio:ne,stretchX:le,stretchY:de,content:pe}=v[H],ae=new u.r({width:U,height:q});u.r.copy(F,ae,{x:G,y:Y},{x:0,y:0},{width:U,height:q},null),B[H]={data:ae,pixelRatio:ne,sdf:ee,stretchX:le,stretchY:de,content:pe,usvg:!1}}y(null,B)}}return{cancel(){P&&(P.cancel(),P=null),O&&(O.cancel(),O=null)}}}(r,this.map._requestManager,(l,p)=>{if(this._spriteRequest=null,l)this.fire(new u.z(l));else if(p){const y=new Map;for(const v in p)y.set(u.I.from(v),p[v]);this.addImages(y)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new u.A("data",{dataType:"style"}))})}addIconset(r,l){if("sprite"===l.type)return void this._loadSprite(l.url);const p=this.getOwnSourceCache(l.source);if(!p)return void this.fire(new u.z(new Error(`Source "${l.source}" as specified by iconset "${r}" does not exist and cannot be used as an iconset source`)));const y=p.getSource();if("raster-array"!==y.type)return void this.fire(new u.z(new Error(`Source "${l.source}" as specified by iconset "${r}" is not a "raster-array" source and cannot be used as an iconset source`)));y.partial=!1;const v=new wf(r,this.scope,p);this.imageManager.addImageProvider(v,this.scope)}removeIconset(r){this.imageManager.removeImageProvider(r,this.scope)}_loadIconset(r){if(!u.j(r)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(r);const l="auto"===this.map._spriteFormat;var p,y;this._spriteRequest=(y=(v,b)=>{if(this._spriteRequest=null,v)l?this._loadSprite(r):this.fire(new u.z(v));else if(b){const D=new Map;for(const C in b)D.set(u.I.from(C),b[C]);this.addImages(D)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new u.A("data",{dataType:"style"}))},u.br((p=this.map._requestManager).transformRequest(p.normalizeIconsetURL(r),u.R.Iconset),(v,b)=>{if(v)return void y(v);const D={},C=u.da(new u.bq(b));for(const P of C.icons){const O={version:1,pixelRatio:u.q.devicePixelRatio,content:Uu(P),stretchX:P.metadata?Jp(P.metadata.stretch_x_areas):void 0,stretchY:P.metadata?Jp(P.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:P};D[P.name]=O}y(null,D)}))}_validateLayer(r){const l=this.getOwnSource(r.source);if(!l)return;const p=r.sourceLayer;p&&("geojson"===l.type||l.vectorLayerIds&&-1===l.vectorLayerIds.indexOf(p))&&this.fire(new u.z(new Error(`Source layer "${p}" does not exist on source "${l.id}" as specified by style layer "${r.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const r in this._sourceCaches)if(!this._sourceCaches[r].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:r}of this.fragments)if(!r.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((r,l)=>{const p=this.fragments[l];return p&&p.style&&(r.data=p.style.serialize()),r})}_serializeSources(){const r={};for(const l in this._sourceCaches){const p=this._sourceCaches[l].getSource();r[p.id]||(r[p.id]=p.serialize())}return r}_serializeLayers(r){const l=[];for(const p of r){const y=this._layers[p];y&&"custom"!==y.type&&l.push(y.serialize())}return l}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const r in this._sourceCaches)if(this._sourceCaches[r].hasTransition())return!0;for(const r in this._layers)if(this._layers[r].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(r){return r?this.order:this._mergedOrder}isLayerDraped(r){return!!this.terrain&&r.isDraped(this.getLayerSourceCache(r))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(r){const l=this.getOwnLayer(r);if(l)return l;this.fire(new u.z(new Error(`The layer '${r}' does not exist in the map's style.`)))}_checkSource(r){const l=this.getOwnSource(r);if(l)return l;this.fire(new u.z(new Error(`The source '${r}' does not exist in the map's style.`)))}precompilePrograms(r,l){const p=this.map.painter;if(p)for(let y=r.minzoom||0;y<(r.maxzoom||25.5);y++){const v=r.getProgramIds();if(v)for(const b of v){const D=r.getDefaultProgramParams(b,l.zoom,this._styleColorTheme.lut);D&&(p.style=this,this.fog&&(p._fogVisible=!0,D.overrideFog=!0,p.getOrCreateProgram(b,D)),p._fogVisible=!1,D.overrideFog=!1,p.getOrCreateProgram(b,D),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(D.overrideRtt=!0,p.getOrCreateProgram(b,D)))}}}update(r){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(r),this.directionalLight&&this.directionalLight.recalculate(r);const l=this.calculateLightsBrightness();r.brightness=l||0,l!==this._brightness&&(this._brightness=l,this.dispatcher.broadcast("setBrightness",l)),r.worldview!==this._worldview&&(this._worldview=r.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const p=this._changes.isDirty();let y=!1;if(this._changes.isDirty()){const D=this._changes.getLayerUpdatesByScope();for(const C in D){const{updatedIds:P,removedIds:O}=D[C];(P||O)&&(this._updateWorkerLayers(C,P,O),y=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(r),this.light&&this.light.updateTransitions(r),this.ambientLight&&this.ambientLight.updateTransitions(r),this.directionalLight&&this.directionalLight.updateTransitions(r),this.fog&&this.fog.updateTransitions(r),this.snow&&this.snow.updateTransitions(r),this.rain&&this.rain.updateTransitions(r),this._changes.reset()}const v={};for(const D in this._mergedSourceCaches){const C=this._mergedSourceCaches[D];v[D]=C.used,C.used=!1,C.tileCoverLift=0}for(const D of this._mergedOrder){const C=this._mergedLayers[D];if(C.recalculate(r,this._availableImages),!C.isHidden(r.zoom)){const P=this.getLayerSourceCache(C);P&&(P.used=!0,P.tileCoverLift=Math.max(P.tileCoverLift,C.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(C,r)}):this.precompilePrograms(C,r))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&y&&this.mergeLayers();const b=this.imageManager.getPendingImageProviders();for(const D of b)D.sourceCache.used=!0;for(const D in v){const C=this._mergedSourceCaches[D];v[D]!==C.used&&C.getSource().fire(new u.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:C.getSource().id}))}this.light&&this.light.recalculate(r),this.terrain&&this.terrain.recalculate(r),this.fog&&this.fog.recalculate(r),this.snow&&this.snow.recalculate(r),this.rain&&this.rain.recalculate(r),this.z=r.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),p&&this.fire(new u.A("data",{dataType:"style"}))}updateImageProviders(){const r=this.imageManager.getPendingImageProviders();for(const l of r){const p=l.resolvePendingRequests(),y=this.getFragmentStyle(l.scope);y&&y.addImages(p)}}_updateTilesForChangedImages(){const r={};for(const l in this._mergedSourceCaches){const p=this._mergedSourceCaches[l].getSource().scope;r[p]=r[p]||this._changes.getUpdatedImages(p),0!==r[p].length&&this._mergedSourceCaches[l].reloadTilesForDependencies(["icons","patterns"],r[p])}for(const l in r)this._changes.resetUpdatedImages(l)}_updateWorkerLayers(r,l,p){const y=this.getFragmentStyle(r);y&&this.dispatcher.broadcast("updateLayers",{layers:l?y._serializeLayers(l):[],scope:r,removedIds:p||[],options:y.options})}setState(r,l){if(this._checkLoaded(),Xl(this,zs(r)))return!1;(r=u.di(r)).layers=Li(r.layers);const p=function(b,D){if(!b)return[{command:On.setStyle,args:[D]}];let C=[];try{if(!u.bv(b.version,D.version))return[{command:On.setStyle,args:[D]}];if(u.bv(b.center,D.center)||C.push({command:On.setCenter,args:[D.center]}),u.bv(b.zoom,D.zoom)||C.push({command:On.setZoom,args:[D.zoom]}),u.bv(b.bearing,D.bearing)||C.push({command:On.setBearing,args:[D.bearing]}),u.bv(b.pitch,D.pitch)||C.push({command:On.setPitch,args:[D.pitch]}),u.bv(b.sprite,D.sprite)||C.push({command:On.setSprite,args:[D.sprite]}),u.bv(b.glyphs,D.glyphs)||C.push({command:On.setGlyphs,args:[D.glyphs]}),u.bv(b.imports,D.imports)||function(B=[],H=[],U){H=H||[];const q=(B=B||[]).map(Ac),G=H.map(Ac),Y=B.reduce(Mc,{}),ee=H.reduce(Mc,{}),ne=q.slice();let le,de,pe,ae;for(le=0,de=0;le<q.length;le++)pe=q[le],ee.hasOwnProperty(pe)?de++:(U.push({command:On.removeImport,args:[pe]}),ne.splice(ne.indexOf(pe,de),1));for(le=0,de=0;le<G.length;le++)pe=G[G.length-1-le],ne[ne.length-1-le]!==pe&&(Y.hasOwnProperty(pe)?(U.push({command:On.removeImport,args:[pe]}),ne.splice(ne.lastIndexOf(pe,ne.length-de),1)):de++,ae=ne[ne.length-le],U.push({command:On.addImport,args:[ee[pe],ae]}),ne.splice(ne.length-le,0,pe));for(const ce of H){const ue=Y[ce.id];ue&&(delete ue.data,u.bv(ue,ce)||U.push({command:On.updateImport,args:[ce.id,ce]}))}}(b.imports,D.imports,C),u.bv(b.transition,D.transition)||C.push({command:On.setTransition,args:[D.transition]}),u.bv(b.light,D.light)||C.push({command:On.setLight,args:[D.light]}),u.bv(b.fog,D.fog)||C.push({command:On.setFog,args:[D.fog]}),u.bv(b.snow,D.snow)||C.push({command:On.setSnow,args:[D.snow]}),u.bv(b.rain,D.rain)||C.push({command:On.setRain,args:[D.rain]}),u.bv(b.projection,D.projection)||C.push({command:On.setProjection,args:[D.projection]}),u.bv(b.lights,D.lights)||C.push({command:On.setLights,args:[D.lights]}),u.bv(b.camera,D.camera)||C.push({command:On.setCamera,args:[D.camera]}),u.bv(b.iconsets,D.iconsets)||function(B,H,U){let q;for(q in H=H||{},B=B||{})B.hasOwnProperty(q)&&(H.hasOwnProperty(q)||U.push({command:On.removeIconset,args:[q]}));for(q in H){if(!H.hasOwnProperty(q))continue;const G=H[q];B.hasOwnProperty(q)?u.bv(B[q],G)||(U.push({command:On.removeIconset,args:[q]}),U.push({command:On.addIconset,args:[q,G]})):U.push({command:On.addIconset,args:[q,G]})}}(b.iconsets,D.iconsets,C),!u.bv(b["color-theme"],D["color-theme"]))return[{command:On.setStyle,args:[D]}];const P={},O=[];!function(B,H,U,q){let G;for(G in H=H||{},B=B||{})B.hasOwnProperty(G)&&(H.hasOwnProperty(G)||Lu(G,U,q));for(G in H){if(!H.hasOwnProperty(G))continue;const Y=H[G];B.hasOwnProperty(G)?u.bv(B[G],Y)||("geojson"===B[G].type&&"geojson"===Y.type&&Bs(B,H,G)?U.push({command:On.setGeoJSONSourceData,args:[G,Y.data]}):Ic(G,H,U,q)):qp(G,H,U)}}(b.sources,D.sources,O,P);const N=[];b.layers&&b.layers.forEach(B=>{B.source&&P[B.source]?C.push({command:On.removeLayer,args:[B.id]}):N.push(B)});let F=b.terrain;F&&P[F.source]&&(C.push({command:On.setTerrain,args:[void 0]}),F=void 0),C=C.concat(O),u.bv(F,D.terrain)||C.push({command:On.setTerrain,args:[D.terrain]}),function(B,H,U){H=H||[];const q=(B=B||[]).map(Ac),G=H.map(Ac),Y=B.reduce(Mc,{}),ee=H.reduce(Mc,{}),ne=q.slice(),le=Object.create(null);let de,pe,ae,ce,ue,Me,ye;for(de=0,pe=0;de<q.length;de++)ae=q[de],ee.hasOwnProperty(ae)?pe++:(U.push({command:On.removeLayer,args:[ae]}),ne.splice(ne.indexOf(ae,pe),1));for(de=0,pe=0;de<G.length;de++)ae=G[G.length-1-de],ne[ne.length-1-de]!==ae&&(Y.hasOwnProperty(ae)?(U.push({command:On.removeLayer,args:[ae]}),ne.splice(ne.lastIndexOf(ae,ne.length-pe),1)):pe++,Me=ne[ne.length-de],U.push({command:On.addLayer,args:[ee[ae],Me]}),ne.splice(ne.length-de,0,ae),le[ae]=!0);for(de=0;de<G.length;de++)if(ae=G[de],ce=Y[ae],ue=ee[ae],!le[ae]&&!u.bv(ce,ue))if(u.bv(ce.source,ue.source)&&u.bv(ce["source-layer"],ue["source-layer"])&&u.bv(ce.type,ue.type)){for(ye in _f(ce.layout,ue.layout,U,ae,null,On.setLayoutProperty),_f(ce.paint,ue.paint,U,ae,null,On.setPaintProperty),u.bv(ce.slot,ue.slot)||U.push({command:On.setSlot,args:[ae,ue.slot]}),u.bv(ce.filter,ue.filter)||U.push({command:On.setFilter,args:[ae,ue.filter]}),u.bv(ce.minzoom,ue.minzoom)&&u.bv(ce.maxzoom,ue.maxzoom)||U.push({command:On.setLayerZoomRange,args:[ae,ue.minzoom,ue.maxzoom]}),ce)ce.hasOwnProperty(ye)&&"layout"!==ye&&"paint"!==ye&&"filter"!==ye&&"metadata"!==ye&&"minzoom"!==ye&&"maxzoom"!==ye&&"slot"!==ye&&(0===ye.indexOf("paint.")?_f(ce[ye],ue[ye],U,ae,ye.slice(6),On.setPaintProperty):u.bv(ce[ye],ue[ye])||U.push({command:On.setLayerProperty,args:[ae,ye,ue[ye]]}));for(ye in ue)ue.hasOwnProperty(ye)&&!ce.hasOwnProperty(ye)&&"layout"!==ye&&"paint"!==ye&&"filter"!==ye&&"metadata"!==ye&&"minzoom"!==ye&&"maxzoom"!==ye&&"slot"!==ye&&(0===ye.indexOf("paint.")?_f(ce[ye],ue[ye],U,ae,ye.slice(6),On.setPaintProperty):u.bv(ce[ye],ue[ye])||U.push({command:On.setLayerProperty,args:[ae,ye,ue[ye]]}))}else U.push({command:On.removeLayer,args:[ae]}),Me=ne[ne.lastIndexOf(ae)+1],U.push({command:On.addLayer,args:[ue,Me]})}(N,D.layers,C)}catch(P){console.warn("Unable to compute style diff:",P),C=[{command:On.setStyle,args:[D]}]}return C}(this.serialize(),r).filter(b=>!(b.command in e_));if(0===p.length)return!1;const y=p.filter(b=>!(b.command in em));if(y.length>0)throw new Error(`Unimplemented: ${y.map(b=>b.command).join(", ")}.`);const v=[];return p.forEach(b=>{v.push(this[b.command](...b.args))}),l&&Promise.all(v).then(l).catch(l),this.stylesheet=r,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(r){if(0===r.size)return this;for(const[l,p]of r.entries()){if(this.getImage(l))return this.fire(new u.z(new Error(`An image with the name "${l.name}" already exists.`)));this.imageManager.addImage(l,this.scope,p),this._changes.updateImage(l,this.scope)}return this._updateWorkerImages(),this.fire(new u.A("data",{dataType:"style"})),this}addImage(r,l){return this.getImage(r)?this.fire(new u.z(new Error(`An image with the name "${r.name}" already exists.`))):(this.imageManager.addImage(r,this.scope,l),this._changes.updateImage(r,this.scope),this._updateWorkerImages(),this.fire(new u.A("data",{dataType:"style"})),this)}updateImage(r,l,p=!1){this.imageManager.updateImage(r,this.scope,l),p&&(this._changes.updateImage(r,this.scope),this._updateWorkerImages(),this.fire(new u.A("data",{dataType:"style"})))}getImage(r){return this.imageManager.getImage(r,this.scope)}removeImage(r){return this.getImage(r)?(this.imageManager.removeImage(r,this.scope),this._changes.updateImage(r,this.scope),this._updateWorkerImages(),this.fire(new u.A("data",{dataType:"style"})),this):this.fire(new u.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(r){return this.modelManager.addModelURLs(r,this.scope),this._updateWorkerModels(),this.fire(new u.A("data",{dataType:"style"})),this}addModel(r,l,p={}){return this._checkLoaded(),this._validate(oe,`models.${r}`,l,null,p)||(this.modelManager.addModel(r,l,this.scope),this.fire(new u.A("data",{dataType:"style"}))),this}hasModel(r){return this.modelManager.hasModel(r,this.scope)}removeModel(r){return this.hasModel(r)?(this.modelManager.removeModel(r,this.scope,!1,!0),this.fire(new u.A("data",{dataType:"style"})),this):this.fire(new u.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(r,l,p={}){if(this._checkLoaded(),void 0!==this.getOwnSource(r))throw new Error(`There is already a source with ID "${r}".`);if(!l.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(l).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(l.type)>=0&&this._validate(Vd,`sources.${r}`,l,null,p))return;this.map&&this.map._collectResourceTiming&&(l.collectResourceTiming=!0);const y=Ru(r,l,this.dispatcher,this);y.scope=this.scope,y.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(y.id),source:y.serialize(),sourceId:y.id}));const v=b=>{const D=(b?"symbol:":"other:")+y.id,C=u.C(D,this.scope),P=this._sourceCaches[D]=new Po(C,y,b);(b?this._symbolSourceCaches:this._otherSourceCaches)[y.id]=P,P.onAdd(this.map)};v(!1),"vector"!==l.type&&"geojson"!==l.type||v(!0),y.onAdd&&y.onAdd(this.map),p.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(r){this._checkLoaded();const l=this.getOwnSource(r);if(!l)throw new Error("There is no source with this ID");for(const y in this._layers)if(this._layers[y].source===r)return this.fire(new u.z(new Error(`Source "${r}" cannot be removed while layer "${y}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===r)return this.fire(new u.z(new Error(`Source "${r}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const y=Object.entries(this.stylesheet.iconsets).find(([v,b])=>"source"===b.type&&b.source===r);if(y)return this.fire(new u.z(new Error(`Source "${r}" cannot be removed while iconset "${y[0]}" is using it.`)))}const p=this.getOwnSourceCaches(r);for(const y of p){const v=u.dj(y.id);delete this._sourceCaches[v],this._changes.discardSourceCacheUpdate(y.id),y.fire(new u.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:y.getSource().id})),y.setEventedParent(null),y.clearTiles()}return delete this._otherSourceCaches[r],delete this._symbolSourceCaches[r],this.mergeSources(),l.setEventedParent(null),l.onRemove&&l.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(r,l){this._checkLoaded(),this.getOwnSource(r).setData(l),this._changes.setDirty()}getOwnSource(r){const l=this.getOwnSourceCache(r);return l&&l.getSource()}getOwnSources(){const r=[];for(const l in this._otherSourceCaches){const p=this.getOwnSourceCache(l);p&&r.push(p.getSource())}return r}areTilesLoaded(){const r=this._mergedSourceCaches;for(const l in r){const p=r[l]._tiles;for(const y in p){const v=p[y];if("loaded"!==v.state&&"errored"!==v.state)return!1}}return!0}setLights(r){if(this._checkLoaded(),!r)return delete this.ambientLight,void delete this.directionalLight;const l=this._getTransitionParameters();for(const v of r){if(this._validate(Pu,"lights",v))return;switch(v.type){case"ambient":if(this.ambientLight){const b=this.ambientLight;b.set(v),b.updateTransitions(l)}else this.ambientLight=new ci(v,yn||(yn=new u.a7({color:new u.a8(u.a5.properties_light_ambient.color),"color-use-theme":new u.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new u.a8(u.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const b=this.directionalLight;b.set(v),b.updateTransitions(l)}else this.directionalLight=new ci(v,ir||(ir=new u.a7({direction:new u.an(u.a5.properties_light_directional.direction),color:new u.a8(u.a5.properties_light_directional.color),"color-use-theme":new u.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new u.a8(u.a5.properties_light_directional.intensity),"cast-shadows":new u.a8(u.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new u.a8(u.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new u.a8(u.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const p=Object.assign(l,{worldview:this.map.getWorldview()}),y=new u.aa(this.z||0,p);this.ambientLight&&this.ambientLight.recalculate(y),this.directionalLight&&this.directionalLight.recalculate(y),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const r=this.directionalLight,l=this.ambientLight;if(!r||!l)return;const p=F=>.2126*(F[0]<=.03928?F[0]/12.92:Math.pow((F[0]+.055)/1.055,2.4))+.7152*(F[1]<=.03928?F[1]/12.92:Math.pow((F[1]+.055)/1.055,2.4))+.0722*(F[2]<=.03928?F[2]/12.92:Math.pow((F[2]+.055)/1.055,2.4)),y=r.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),v=r.properties.get("intensity"),b=r.properties.get("direction"),D=1-u.d1(b.x,b.y,b.z)[2]/90,C=p(y)*v*D,P=l.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),O=l.properties.get("intensity"),N=p(P)*O;return Number(((C+N)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const r=[];return this.directionalLight&&r.push(this.directionalLight.get()),this.ambientLight&&r.push(this.ambientLight.get()),r}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(r){if(null==r||""===r&&this.isRootStyle())return this;if(u.dk(r)){const l=u.dl(r),p=this.fragments.find(({id:v})=>v===l);if(!p)return;const y=u.dj(r);return p.style.getFragmentStyle(y)}{const l=this.fragments.find(({id:p})=>p===r);return l?l.style:void 0}}setFeaturesetSelectors(r){if(!r)return;const l={},p=(y,v="")=>`${y}::${v}`;this._featuresetSelectors={};for(const y in r){const v=this._featuresetSelectors[y]=[];for(const b of r[y].selectors){if(b.featureNamespace){const C=this.getOwnLayer(b.layer);if(!C){u.w(`Layer is undefined for selector: ${b.layer}`);continue}const P=p(C.source,C.sourceLayer);if(P in l&&l[P]!==b.featureNamespace){u.w(`"featureNamespace ${b.featureNamespace} of featureset ${y}'s selector is not associated to the same source, skip this selector`);continue}l[P]=b.featureNamespace}let D;if(b.properties)for(const C in b.properties){const P=u.X(b.properties[C]);"success"===P.result&&(D=D||{},D[C]=P.value)}v.push({layerId:b.layer,namespace:b.featureNamespace,properties:D,uniqueFeatureID:b._uniqueFeatureID})}}}getFeaturesetDescriptors(r){const l=this.getFragmentStyle(r);if(!l||!l.stylesheet.featuresets)return[];const p=[];for(const y in l.stylesheet.featuresets)p.push({featuresetId:y,importId:l.scope?l.scope:void 0});return p}getFeaturesetLayers(r,l){const p=this.getFragmentStyle(l),y=p.stylesheet.featuresets;if(!y||!y[r])return this.fire(new u.z(new Error(`The featureset '${r}' does not exist in the map's style and cannot be queried.`))),[];const v=[];for(const b of y[r].selectors){const D=p.getOwnLayer(b.layer);D&&v.push(D)}return v}getConfigProperty(r,l){const p=this.getFragmentStyle(r);if(!p)return null;const y=u.C(l,p.scope),v=p.options.get(y),b=v?v.value||v.default:null;return b?b.serialize():null}setConfigProperty(r,l,p){const y=this.getFragmentStyle(r);if(!y)return;const v=y.stylesheet.indoor?Qp(y.stylesheet.schema):y.stylesheet.schema;if(!v||!v[l])return;const b=u.X(p);if("success"!==b.result)return void Xl(this,b.value);const D=b.value.expression,C=u.C(l,y.scope),P=y.options.get(C);if(!P)return;let O;const{minValue:N,maxValue:F,stepValue:B,type:H,values:U}=v[l],q=u.X(v[l].default);"success"===q.result&&(O=q.value.expression),O?(this.options.set(C,Object.assign({},P,{value:D,default:O,minValue:N,maxValue:F,stepValue:B,type:H,values:U})),this.updateConfigDependencies(l)):this.fire(new u.z(new Error(`No schema defined for the config option "${l}" in the "${r}" fragment.`)))}getConfig(r){const l=this.getFragmentStyle(r);if(!l)return null;const p=l.stylesheet.schema;if(!p)return null;const y={};for(const v in p){const b=u.C(v,l.scope),D=l.options.get(b),C=D?D.value||D.default:null;y[v]=C?C.serialize():null}return y}setConfig(r,l){const p=this.getFragmentStyle(r);p&&(p.updateConfig(l,p.stylesheet.schema),this.updateConfigDependencies())}getSchema(r){const l=this.getFragmentStyle(r);return l?l.stylesheet.schema:null}setSchema(r,l){const p=this.getFragmentStyle(r);p&&(p.stylesheet.schema=l,p.updateConfig(p._config,l),this.updateConfigDependencies())}updateConfig(r,l){if(this._config=r,r||l)if(l)for(const p in l){let y,v;const b=u.X(l[p].default);if("success"===b.result&&(y=b.value.expression),r&&void 0!==r[p]){const F=u.X(r[p]);"success"===F.result&&(v=F.value.expression)}const{minValue:D,maxValue:C,stepValue:P,type:O,values:N}=l[p];if(y){const F=u.C(p,this.scope);this.options.set(F,{default:y,value:v,minValue:D,maxValue:C,stepValue:P,type:O,values:N})}else this.fire(new u.z(new Error(`No schema defined for config option "${p}".`)))}else this.fire(new u.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(r){for(const l of this._configDependentLayers){const p=this.getLayer(l);if(p){if(r&&!p.configDependencies.has(r))continue;p.possiblyEvaluateVisibility(),this._updateLayer(p)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(l=>{const p=l._styleColorTheme.colorThemeOverride?l._styleColorTheme.colorThemeOverride:l._styleColorTheme.colorTheme;if(p){const y=l._evaluateColorThemeData(p);(!l._styleColorTheme.lut&&""!==y||l._styleColorTheme.lut&&y!==l._styleColorTheme.lut.data)&&l.setColorTheme(p)}}),this._changes.setDirty()}addLayer(r,l,p={}){this._checkLoaded();const y=r.id;if(this._layers[y])return void this.fire(new u.z(new Error(`Layer with id "${y}" already exists on this map`)));let v;if("custom"===r.type){if(Xl(this,u.dm(r)))return;v=u.dn(r,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof r.source&&(this.addSource(y,r.source),r=u.di(r),r=u.h(r,{source:y})),this._validate(Rn,`layers.${y}`,r,{arrayIndex:-1},p))return;v=u.dn(r,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(v),v.setEventedParent(this,{layer:{id:y}})}0!==v.configDependencies.size&&this._configDependentLayers.add(v.fqid);let b=this._order.length;if(l){const O=this._order.indexOf(l);if(-1===O)return void this.fire(new u.z(new Error(`Layer with id "${l}" does not exist on this map.`)));v.slot===this._layers[l].slot?b=O:u.w(`Layer with id "${l}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(b,0,y),this._layerOrderChanged=!0,this._layers[y]=v;const D=this.getOwnLayerSourceCache(v),C=!!this.directionalLight&&this.directionalLight.shadowsEnabled();D&&v.canCastShadows()&&C&&(D.castsShadows=!0);const P=this._changes.getRemovedLayer(v);if(P&&v.source&&D&&"custom"!==v.type){this._changes.discardLayerRemoval(v);const O=u.C(v.source,v.scope);P.type!==v.type?this._changes.updateSourceCache(O,"clear"):(this._changes.updateSourceCache(O,"reload"),D.pause())}this._updateLayer(v),v.onAdd&&v.onAdd(this.map),v.scope=this.scope,this.mergeLayers()}moveLayer(r,l){this._checkLoaded();const p=this._checkLayer(r);if(!p||r===l)return;const y=this._order.indexOf(r);this._order.splice(y,1);let v=this._order.length;if(l){const b=this._order.indexOf(l);if(-1===b)return void this.fire(new u.z(new Error(`Layer with id "${l}" does not exist on this map.`)));p.slot===this._layers[l].slot?v=b:u.w(`Layer with id "${l}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(v,0,r),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(r){this._checkLoaded();const l=this._checkLayer(r);if(!l)return;l.setEventedParent(null);const p=this._order.indexOf(r);this._order.splice(p,1),delete this._layers[r],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(l.fqid),this._changes.removeLayer(l);const y=this.getOwnLayerSourceCache(l);if(y&&y.castsShadows){let v=!1;for(const b in this._layers)if(this._layers[b].source===l.source&&this._layers[b].canCastShadows()){v=!0;break}y.castsShadows=v}l.onRemove&&l.onRemove(this.map),this.mergeLayers()}getOwnLayer(r){return this._layers[r]}hasLayer(r){return r in this._mergedLayers}hasLayerType(r){for(const l in this._layers)if(this._layers[l].type===r)return!0;return!1}setLayerZoomRange(r,l,p){this._checkLoaded();const y=this._checkLayer(r);y&&(y.minzoom===l&&y.maxzoom===p||(null!=l&&(y.minzoom=l),null!=p&&(y.maxzoom=p),this._updateLayer(y)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(r,l){this._checkLoaded();const p=this._checkLayer(r);p&&p.slot!==l&&(p.slot=l,this._updateLayer(p))}setFilter(r,l,p={}){this._checkLoaded();const y=this._checkLayer(r);if(y&&!u.bv(y.filter,l))return null==l?(y.filter=void 0,void this._updateLayer(y)):void(this._validate(Pe,`layers.${y.id}.filter`,l,{layerType:y.type},p)||(y.filter=u.di(l),this._updateLayer(y)))}getFilter(r){const l=this._checkLayer(r);if(l)return u.di(l.filter)}setLayoutProperty(r,l,p,y={}){this._checkLoaded();const v=this._checkLayer(r);if(v&&!u.bv(v.getLayoutProperty(l),p)){if(null!=p&&(!y||!1!==y.validate)&&Xl(v,X.call(zs,{key:`layers.${r}.layout.${l}`,layerType:v.type,objectKey:l,value:p,styleSpec:u.a5,style:{glyphs:!0,sprite:!0}})))return;v.setLayoutProperty(l,p),0!==v.configDependencies.size&&this._configDependentLayers.add(v.fqid),this._updateLayer(v)}}getLayoutProperty(r,l){const p=this._checkLayer(r);if(p)return p.getLayoutProperty(l)}setPaintProperty(r,l,p,y={}){this._checkLoaded();const v=this._checkLayer(r);if(!v||u.bv(v.getPaintProperty(l),p)||null!=p&&(!y||!1!==y.validate)&&Xl(v,Z.call(zs,{key:`layers.${r}.paint.${l}`,layerType:v.type,objectKey:l,value:p,styleSpec:u.a5})))return;const b=v.setPaintProperty(l,p);0!==v.configDependencies.size&&this._configDependentLayers.add(v.fqid),b&&this._updateLayer(v),this._changes.updatePaintProperties(v)}getPaintProperty(r,l){const p=this._checkLayer(r);if(p)return p.getPaintProperty(l)}setFeatureState(r,l){if(this._checkLoaded(),"target"in r){if("featuresetId"in r.target){const{featuresetId:C,importId:P}=r.target,O=this.getFragmentStyle(P),N=O.getFeaturesetLayers(C);for(const{source:F,sourceLayer:B}of N)O.setFeatureState({id:r.id,source:F,sourceLayer:B},l)}else if("layerId"in r.target){const{layerId:C}=r.target,P=this.getLayer(C);this.setFeatureState({id:r.id,source:P.source,sourceLayer:P.sourceLayer},l)}return}const p=r.source,y=r.sourceLayer,v=this._checkSource(p);if(!v)return;const b=v.type;if("geojson"===b&&y)return void this.fire(new u.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===b&&!y)return void this.fire(new u.z(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===r.id&&this.fire(new u.z(new Error("The feature id parameter must be provided.")));const D=this.getOwnSourceCaches(p);for(const C of D)C.setFeatureState(y,r.id,l)}removeFeatureState(r,l){if(this._checkLoaded(),"target"in r){if("featuresetId"in r.target){const{featuresetId:C,importId:P}=r.target,O=this.getFragmentStyle(P),N=O.getFeaturesetLayers(C);for(const{source:F,sourceLayer:B}of N)O.removeFeatureState({id:r.id,source:F,sourceLayer:B},l)}else if("layerId"in r.target){const{layerId:C}=r.target,P=this.getLayer(C);this.removeFeatureState({id:r.id,source:P.source,sourceLayer:P.sourceLayer},l)}return}const p=r.source,y=this._checkSource(p);if(!y)return;const v=y.type,b="vector"===v?r.sourceLayer:void 0;if("vector"===v&&!b)return void this.fire(new u.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(l&&"string"!=typeof r.id&&"number"!=typeof r.id)return void this.fire(new u.z(new Error("A feature id is required to remove its specific state property.")));const D=this.getOwnSourceCaches(p);for(const C of D)C.removeFeatureState(b,r.id,l)}getFeatureState(r){if(this._checkLoaded(),"target"in r){let v;if("featuresetId"in r.target){const{featuresetId:b,importId:D}=r.target,C=this.getFragmentStyle(D),P=C.getFeaturesetLayers(b);for(const{source:O,sourceLayer:N}of P){const F=C.getFeatureState({id:r.id,source:O,sourceLayer:N});if(F&&!v)v=F;else if(!u.bv(v,F))return void this.fire(new u.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in r.target){const{layerId:b}=r.target,D=this.getLayer(b);v=this.getFeatureState({id:r.id,source:D.source,sourceLayer:D.sourceLayer})}return v}const l=r.source,p=r.sourceLayer,y=this._checkSource(l);if(y){if("vector"!==y.type||p)return void 0===r.id&&this.fire(new u.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(l)[0].getFeatureState(p,r.id);this.fire(new u.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(r){return this.stylesheet.transition=u.h({},this.stylesheet.transition,r),this.transition=this.stylesheet.transition,this}getTransition(){return u.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();const r=this.getTerrain(),l=r&&this.terrain&&this.terrain.scope===this.scope?r:this.stylesheet.terrain;return u.dp({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:l,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},p=>void 0!==p)}_updateFilteredLayers(r){for(const l of Object.values(this._mergedLayers))r(l)&&this._updateLayer(l)}_updateLayer(r){this._changes.updateLayer(r);const l=this.getLayerSourceCache(r),p=u.C(r.source,r.scope),y=this._changes.getUpdatedSourceCaches();r.source&&!y[p]&&l&&"raster"!==l.getSource().type&&(this._changes.updateSourceCache(p,"reload"),l.pause()),r.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(r){const l=D=>this._mergedLayers[D].is3D(!!this.terrain),p=this.order,y={},v=[];for(let D=p.length-1;D>=0;D--){const C=p[D];if(l(C)){y[C]=D;for(const P of r){const O=P[C];if(O)for(const N of O)v.push(N)}}}v.sort((D,C)=>C.intersectionZ-D.intersectionZ);const b=[];for(let D=p.length-1;D>=0;D--){const C=p[D];if(l(C))for(let P=v.length-1;P>=0;P--){const O=v[P].feature;if(O.layer&&y[O.layer.id]<D)break;b.push(O),v.pop()}else for(const P of r){const O=P[C];if(O)for(const N of O)b.push(N.feature)}}return b}queryRenderedFeatures(r,l,p){let y;l&&!Array.isArray(l)&&l.filter&&(this._validate(Pe,"queryRenderedFeatures.filter",l.filter,null,l),y=u.b3(l.filter));const v={},b=O=>{if(Ef.has(O.type))return;const N=this.getOwnLayerSourceCache(O),F=v[N.id]=v[N.id]||{sourceCache:N,layers:{},has3DLayers:!1};O.is3D(!!this.terrain)&&(F.has3DLayers=!0),F.layers[O.fqid]=F.layers[O.fqid]||{styleLayer:O,targets:[]},F.layers[O.fqid].targets.push({filter:y})};if(l&&l.layers){if(!Array.isArray(l.layers))return this.fire(new u.z(new Error("parameters.layers must be an Array."))),[];for(const O of l.layers){const N=this._layers[O];if(!N)return this.fire(new u.z(new Error(`The layer '${O}' does not exist in the map's style and cannot be queried for features.`))),[];b(N)}}else for(const O in this._layers)b(this._layers[O]);const D=this._queryRenderedFeatures(r,v,p),C=this._flattenAndSortRenderedFeatures(D),P=[];for(const O of C)u.dq(O.layer.id)===this.scope&&P.push(O);return P}queryRenderedFeatureset(r,l,p){let y;l&&!Array.isArray(l)&&l.filter&&(this._validate(Pe,"queryRenderedFeatures.filter",l.filter,null,l),y=u.b3(l.filter));const v="mock",b=[];if(l&&l.target)b.push(Object.assign({},l,{targetId:v,filter:y}));else{const O=this.getFeaturesetDescriptors();for(const N of O)b.push({targetId:v,filter:y,target:N});for(const{style:N}of this.fragments){const F=N.getFeaturesetDescriptors();for(const B of F)b.push({targetId:v,filter:y,target:B})}}const D=this.queryRenderedTargets(r,b,p),C=[],P=new Set;for(const O of D)for(const N of O.variants[v])gf(N,O,P)||C.push(new u.dr(O,N));return C}queryRenderedTargets(r,l,p){const y={},v=(D,C,P,O)=>{const N=y[C.id]=y[C.id]||{sourceCache:C,layers:{},has3DLayers:!1};if(N.layers[D.fqid]=N.layers[D.fqid]||{styleLayer:D,targets:[]},D.is3D(!!this.terrain)&&(N.has3DLayers=!0),!O)return P.uniqueFeatureID=!1,void N.layers[D.fqid].targets.push(P);N.layers[D.fqid].targets.push(Object.assign({},P,{namespace:O.namespace,properties:O.properties,uniqueFeatureID:O.uniqueFeatureID}))};for(const D of l)if("featuresetId"in D.target){const{featuresetId:C,importId:P}=D.target,O=this.getFragmentStyle(P);if(!O||!O._featuresetSelectors)continue;const N=O._featuresetSelectors[C];if(!N){this.fire(new u.z(new Error(`The featureset '${C}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const F of N){const B=O.getOwnLayer(F.layerId);B&&!Ef.has(B.type)&&v(B,O.getOwnLayerSourceCache(B),D,F)}}else if("layerId"in D.target){const{layerId:C}=D.target,P=this.getLayer(C);if(!P||Ef.has(P.type))continue;v(P,this.getLayerSourceCache(P),D)}const b=this._queryRenderedFeatures(r,y,p);return this._flattenAndSortRenderedFeatures(b)}_queryRenderedFeatures(r,l,p){const y=[],v=!!this.map._showQueryGeometry,b=Vn.createFromScreenPoints(r,p);for(const D in l){const C=el(b,l[D],this._availableImages,p,v);Object.keys(C).length&&y.push(C)}if(this.placement)for(const D in l){if(!l[D].sourceCache._onlySymbols)continue;const C=tl(b.screenGeometry,l[D],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(C).length&&y.push(C)}return y}querySourceFeatures(r,l){const p=l&&l.filter;p&&this._validate(Pe,"querySourceFeatures.filter",p,null,l);let y=[];const v=this.getOwnSourceCaches(r);for(const b of v)y=y.concat(Ou(b,l));return y}addSourceType(r,l,p){return js.getSourceType(r)?p(new Error(`A source type called "${r}" already exists.`)):(js.setSourceType(r,l),l.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:r,url:l.workerSourceURL},p):p(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(r,l,p={}){this._checkLoaded();const y=this.light.getLight();let v=!1;for(const D in r)if(!u.bv(r[D],y[D])){v=!0;break}if(!v)return;const b=this._getTransitionParameters();this.light.setLight(r,l,p),this.light.updateTransitions(b)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=u.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&u.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(r,l=1){if(this._checkLoaded(),!r)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===l&&delete this.terrain,null===r?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let p=r;const y=null==r.source;if(1===l){if(this.disableElevatedTerrain)return;if("object"==typeof p.source){const D="terrain-dem-src";this.addSource(D,p.source),p=u.di(p),p=u.h(p,{source:D})}const v=u.h({},p),b={};if(this.terrain&&y){v.source=this.terrain.get().source;const D=this.terrain?this.getFragmentStyle(this.terrain.scope):null;D&&(b.style=D.serialize())}if(this._validate(Je,"terrain",v,b))return}if(!this.terrain||this.terrain.scope!==this.scope&&!y||this.terrain&&l!==this.terrain.drapeRenderMode){if(!p)return;this._createTerrain(p,l),this.fire(new u.A("data",{dataType:"style"}))}else{const v=this.terrain,b=v.get();for(const D of Object.keys(u.a5.terrain))!p.hasOwnProperty(D)&&u.a5.terrain[D].default&&(p[D]=u.a5.terrain[D].default);for(const D in r)if(!u.bv(r[D],b[D])){v.set(r,this.options),this.stylesheet.terrain=r;const C=this._getTransitionParameters({duration:0});v.updateTransitions(C),this.fire(new u.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(r){const l=this.fog=new pn(r,this.map.transform,this.scope,this.options);this.stylesheet.fog=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}_createSnow(r){const l=this.snow=new Cr(r,this.map.transform,this.scope,this.options);this.stylesheet.snow=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}_createRain(r){const l=this.rain=new Lr(r,this.map.transform,this.scope,this.options);this.stylesheet.rain=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(const r of this.map._markers)r._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(r){if(this._checkLoaded(),!r)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const l=this.fog;if(!u.bv(l.get(),r)){l.set(r,this.options),this.stylesheet.fog=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}}else this._createFog(r);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(r){if(this._checkLoaded(),!r)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const l=this.snow;if(!u.bv(l.get(),r)){l.set(r,this.options),this.stylesheet.snow=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}}else this._createSnow(r);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(r){if(this._checkLoaded(),!r)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const l=this.rain;if(!u.bv(l.get(),r)){l.set(r,this.options),this.stylesheet.rain=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}}else this._createRain(r);this._markersNeedUpdate=!0}_reloadColorTheme(){const r=()=>{for(const y in this._layers)this._layers[y].lut=this._styleColorTheme.lut;for(const y in this._sourceCaches)this._sourceCaches[y].clearTiles()},l=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!l)return this._styleColorTheme.lut=null,void r();const p=this._evaluateColorThemeData(l);this._loadColorTheme(p).then(()=>{this.fire(new u.A("colorthemeset")),r()}).catch(y=>{u.w(`Couldn't set color theme: ${y}`)})}setColorTheme(r){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&u.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=r,this._reloadColorTheme()}setImportColorTheme(r,l){const p=this.getFragmentStyle(r);p&&(p._styleColorTheme.colorThemeOverride=l,p._reloadColorTheme())}_getTransitionParameters(r){return{now:u.q.now(),transition:u.h(this.transition,r)}}updateDrapeFirstLayers(){if(!this.terrain)return;const r=[],l=[];for(const p of this._mergedOrder)this.isLayerDraped(this._mergedLayers[p])?r.push(p):l.push(p);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...r),this._drapedFirstOrder.push(...l)}_createTerrain(r,l){const p=this.terrain=new Te(r,l,this.scope,this.options,this.map.getWorldview());1===l&&(this.stylesheet.terrain=r),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const y=this._getTransitionParameters({duration:0});p.updateTransitions(y)}_force3DLayerUpdate(){for(const r in this._layers){const l=this._layers[r];"fill-extrusion"===l.type&&this._updateLayer(l)}}_forceSymbolLayerUpdate(){for(const r in this._layers){const l=this._layers[r];"symbol"===l.type&&this._updateLayer(l)}}_validate(r,l,p,y,v={}){if(v&&!1===v.validate)return!1;const b=u.h({},this.serialize());return Xl(this,r.call(zs,u.h({key:l,style:b,value:p,styleSpec:u.a5},y)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),u.ds.off("pluginStateChange",this._rtlTextPluginCallback);for(const r in this._mergedLayers)this._mergedLayers[r].setEventedParent(null);for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].clearTiles(),this._mergedSourceCaches[r].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(r){const l=this.getSourceCaches(r);for(const p of l)p.clearTiles()}clearSources(){for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].clearTiles()}clearLayers(){for(const r in this._mergedLayers){const l=this._mergedLayers[r];l._clear&&l._clear()}}reloadSource(r){const l=this.getSourceCaches(r);for(const p of l)p.resume(),p.reload()}reloadSources(){for(const r of this.getSources())r.reload&&r.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(r=>{r.modelManager.reloadModels(r.scope)})}updateSources(r){let l;this.directionalLight&&(l=Wl(this.directionalLight));const p=new Set;for(const y in this._mergedLayers){const v=this._mergedLayers[y];v.hasElevation()&&!p.has(v.source)&&p.add(v.source)}for(const y in this._mergedSourceCaches){const v=this._mergedSourceCaches[y],b=p.has(v._source.id);v.update(r,void 0,void 0,l,b)}}_generateCollisionBoxes(){for(const r in this._sourceCaches){const l=this._sourceCaches[r];l.resume(),l.reload()}}_updatePlacement(r,l,p,y,v,b,D=!1){let C=!1,P=!1;const O={},N={};for(const F of this._mergedOrder){const B=this._mergedLayers[F];if("symbol"!==B.type)continue;const H=u.C(B.source,B.scope);let U=O[H];if(!U){const G=this.getLayerSourceCache(B);if(!G)continue;const Y=G.getRenderableIds(!0).map(ee=>G.getTileByID(ee));N[H]=Y.slice(),U=O[H]=Y.sort((ee,ne)=>ne.tileID.overscaledZ-ee.tileID.overscaledZ||(ee.tileID.isLessThan(ne.tileID)?-1:1))}const q=this.crossTileSymbolIndex.addLayer(B,U,l.center.lng,l.projection);C=C||q}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),D=D||this._layerOrderChanged||0===y,this._layerOrderChanged&&this.fire(new u.A("neworder")),(D||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(u.q.now(),l.zoom))&&(this.pauseablePlacement=new Zp(l,this._mergedOrder,D,p,y,v,this.placement,this.fog&&l.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,O,N,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(u.q.now()),P=!0),C&&this.pauseablePlacement.placement.setStale()),P||C){this._buildingIndex.onNewFrame(l.zoom);for(let F=0;F<this._mergedOrder.length;F++){const B=this._mergedLayers[this._mergedOrder[F]];if("symbol"!==B.type)continue;const H=this.isLayerClipped(B);this.placement.updateLayerOpacities(B,O[u.C(B.source,B.scope)],F,H?b:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(u.q.now())}}_releaseSymbolFadeTiles(){for(const r in this._sourceCaches)this._sourceCaches[r].releaseSymbolFadeTiles()}addImport(r,l){this._checkLoaded();const p=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==p.findIndex(({id:v})=>v===r.id))return void this.fire(new u.z(new Error(`Import with id '${r.id}' already exists in the map's style.`)));if(!l)return p.push(r),this._loadImports([r],!0);const y=p.findIndex(({id:v})=>v===l);return-1===y&&this.fire(new u.z(new Error(`Import with id "${l}" does not exist on this map.`))),this.stylesheet.imports=p.slice(0,y).concat(r).concat(p.slice(y)),this._loadImports([r],!0,l)}updateImport(r,l){this._checkLoaded();const p=this.stylesheet.imports||[],y=this.getImportIndex(r);return-1===y?this:"string"==typeof l?(this.setImportUrl(r,l),this):(l.url&&l.url!==p[y].url&&this.setImportUrl(r,l.url),u.bv(l.config,p[y].config)||this.setImportConfig(r,l.config,l.data.schema),u.bv(l.data,p[y].data)||this.setImportData(r,l.data),this)}moveImport(r,l){this._checkLoaded();let p=this.stylesheet.imports||[];const y=this.getImportIndex(r);if(-1===y)return this;const v=this.getImportIndex(l);if(-1===v)return this;const b=p[y],D=this.fragments[y];return p=p.filter(({id:C})=>C!==r),this.fragments=this.fragments.filter(({id:C})=>C!==r),this.stylesheet.imports=p.slice(0,v).concat(b).concat(p.slice(v)),this.fragments=this.fragments.slice(0,v).concat(D).concat(this.fragments.slice(v)),this.mergeLayers(),this}setImportUrl(r,l){this._checkLoaded();const p=this.stylesheet.imports||[],y=this.getImportIndex(r);if(-1===y)return this;p[y].url=l;const v=this.fragments[y];return v.style=this._createFragmentStyle(p[y]),v.style.on("style.import.load",()=>this.mergeAll()),v.style.loadURL(l),this}setImportData(r,l){this._checkLoaded();const p=this.getImportIndex(r),y=this.stylesheet.imports||[];return-1===p?this:l?(this.fragments[p].style.setState(l),this._reloadImports(),this):(delete y[p].data,this.setImportUrl(r,y[p].url))}setImportConfig(r,l,p){this._checkLoaded();const y=this.getImportIndex(r),v=this.stylesheet.imports||[];if(-1===y)return this;l?v[y].config=l:delete v[y].config;const b=this.fragments[y];p&&b.style.stylesheet&&(b.style.stylesheet.schema=p);const D=b.style.stylesheet&&b.style.stylesheet.schema;return b.config=l,b.style.updateConfig(l,D),this.updateConfigDependencies(),this}removeImport(r){this._checkLoaded();const l=this.stylesheet.imports||[],p=this.getImportIndex(r);-1!==p&&(l.splice(p,1),this.fragments[p].style._remove(),this.fragments.splice(p,1),this._reloadImports())}getImportIndex(r){const l=(this.stylesheet.imports||[]).findIndex(p=>p.id===r);return-1===l&&this.fire(new u.z(new Error(`Import '${r}' does not exist in the map's style and cannot be updated.`))),l}getLayer(r){return this._mergedLayers[r]}getSources(){const r=[];for(const l in this._mergedOtherSourceCaches){const p=this._mergedOtherSourceCaches[l];p&&r.push(p.getSource())}return r}getSource(r,l){const p=this.getSourceCache(r,l);return p&&p.getSource()}getLayerSource(r){const l=this.getLayerSourceCache(r);return l&&l.getSource()}getSourceCache(r,l){const p=u.C(r,l);return this._mergedOtherSourceCaches[p]}getLayerSourceCache(r){const l=u.C(r.source,r.scope);return"symbol"===r.type?this._mergedSymbolSourceCaches[l]:this._mergedOtherSourceCaches[l]}getSourceCaches(r){if(null==r)return Object.values(this._mergedSourceCaches);const l=[];return this._mergedOtherSourceCaches[r]&&l.push(this._mergedOtherSourceCaches[r]),this._mergedSymbolSourceCaches[r]&&l.push(this._mergedSymbolSourceCaches[r]),l}updateSourceCaches(){const r=this._changes.getUpdatedSourceCaches();for(const l in r){const p=r[l];"reload"===p?this.reloadSource(l):"clear"===p&&this.clearSource(l)}}updateLayers(r){const l=this._changes.getUpdatedPaintProperties();for(const p of l){const y=this.getLayer(p);y&&y.updateTransitions(r)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(r){this.stylesheet.glyphs=r,this.glyphManager.setURL(r)}getImages(r,l,p){this.imageManager.getImages(l.images,l.scope,p),this._updateTilesForChangedImages();const y=b=>{if(b){const D=l.images.map(C=>u.I.toString(C));b.setDependencies(l.tileID.key,l.type,D)}},v=u.C(l.source,l.scope);y(this._mergedOtherSourceCaches[v]),y(this._mergedSymbolSourceCaches[v]),l.images.some(b=>b.iconsetId)&&this.fire(new u.A("data",{dataType:"style"}))}rasterizeImages(r,l,p){this.imageManager.rasterizeImages(l,p)}getGlyphs(r,l,p){this.glyphManager.getGlyphs(l.stacks,p)}getResource(r,l,p){return u.dt(l,p)}getOwnSourceCache(r){return this._otherSourceCaches[r]}getOwnLayerSourceCache(r){return"symbol"===r.type?this._symbolSourceCaches[r.source]:this._otherSourceCaches[r.source]}getOwnSourceCaches(r){const l=[];return this._otherSourceCaches[r]&&l.push(this._otherSourceCaches[r]),this._symbolSourceCaches[r]&&l.push(this._symbolSourceCaches[r]),l}_isSourceCacheLoaded(r){const l=this.getOwnSourceCaches(r);return 0===l.length?(this.fire(new u.z(new Error(`There is no source with ID '${r}'`))),!1):l.every(p=>p.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(r,l){if(!this._clipLayerPresent&&"fill-extrusion"!==r.type&&"building"!==r.type)return!1;const p="fill-extrusion"===r.type&&("building"===r.sourceLayer||"procedural_buildings"===r.sourceLayer),y="building"===r.type;if(r.is3D(!!this.terrain)){if(p||y||l&&"batched-model"===l.type||"model"===r.type)return!0}else if("symbol"===r.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(r=>{r.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}js.getSourceType=function(f){return mf[f]},js.setSourceType=function(f,r){mf[f]=r},js.registerForPluginStateChange=u.du;var tm="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",Hu="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",Gu="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",nm="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Jd="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",Us="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",Tf="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",ht="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",Yl="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",Df="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",Sf="#ifdef RENDER_SHADOWS\nprecision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {\n#ifdef CLIP_ZERO_TO_ONE\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);\n#else\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);\n#endif\nreturn texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;\n#ifdef SHADOWS_SINGLE_CASCADE\nvec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);\n#else\nlight_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const eh=[];Jn(tm,eh),Jn(Gu,eh),Jn(Hu,eh);const _r={"_prelude_fog.vertex.glsl":Us,"_prelude_terrain.vertex.glsl":Jd,"_prelude_shadow.vertex.glsl":Df,"_prelude_fog.fragment.glsl":Tf,"_prelude_shadow.fragment.glsl":Sf,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":ht,"_prelude_raster_particle.glsl":Yl},Ks={};nn("",Jd),nn(Tf,Us),nn(Sf,Df),nn(ht,""),nn(Yl,"");const th=nn(Hu,Gu),Dn=tm;var wo={background:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),building:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nconst float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nin lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;\n#endif\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\nuniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}\n#ifdef BUILDING_FAUX_FACADE\nfloat hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;\n#if 0\nif (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;\n#else\nif (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;\n#endif\nreturn out_color;}\n#endif\nvec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;\n#ifdef BUILDING_FAUX_FACADE\nif (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}\n#endif\nvec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;\n#ifdef RENDER_SHADOWS\nshadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nshadowed_lighting_factor=dot(normal,u_lighting_directional_dir);\n#endif\ncolor.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,base_color.rgb,emissive);\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));\n#endif\ncolor.rgb=linearTosRGB(color.rgb);color*=u_opacity;\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_pos.z);\n#endif\nglFragColor=color; \n#ifdef DEBUG_SHOW_NORMALS\ncolor.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nout lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nconst float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#ifdef BUILDING_FAUX_FACADE\nmat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}\n#endif\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive\nvoid main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive\nvec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;\n#ifdef BUILDING_FAUX_FACADE\nv_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}\n#endif\nv_pos=a_pos_3f;\n#ifdef RENDER_CUTOFF\nvec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=v_pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(v_pos);\n#endif\ngl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}'),buildingBloom:nn("in vec4 v_color_emissive;\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\nfloat saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;\n#ifdef HAS_ATTRIBUTE_a_bloom_attenuation\nfloat distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);\n#endif\nglFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}","in vec3 a_pos_3f;\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\nout vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\n#ifdef HAS_ATTRIBUTE_a_part_color_emissive\nvec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);\n#else\nv_color_emissive=vec4(1.0);\n#endif\ngl_Position=u_matrix*vec4(a_pos_3f,1.0);}"),buildingDepth:nn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:nn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:nn('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:nn("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:nn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;\n#endif\nout float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);\n#ifdef PROJECTION_GLOBE_VIEW\n#ifndef PROJECTED_POS_ON_VIEWPORT\nvec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);\n#endif\n#endif\nvec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:nn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:nn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:nn("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:nn("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)\n{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nvec3 color=structure_color.xyz;\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,transformed_normal);\n#endif\ncolor=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nv_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef FLIP_Y\nv_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FLIP_Y\nv_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);\n#ifdef CLIP_ZERO_TO_ONE\ncutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);\n#else\ncutoff=cutoff_opacity(u_cutoff_params,ground.z);\n#endif\nif (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:nn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:nn('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:nn("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:nn("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;\n#ifdef LINE_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LINE_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:nn("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:nn("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:nn('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:nn('#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nin highp float v_z_offset;\n#endif\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef TERRAIN\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#else\nout_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef ELEVATED_ROADS\nin vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nout highp float v_z_offset;\n#endif\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;\n#else\nz+=u_pitch_with_map ? z_offset : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\n#ifdef ELEVATED_ROADS\nvec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\npos=vec3(projected_pos.xy/projected_pos.w+offset,z);\n#endif\n#endif\ngl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#else\n#ifdef RENDER_SHADOWS\nv_z_offset=e;\n#endif\n#endif\n}'),terrainRaster:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:nn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:nn('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',nm),skyboxGradient:nn('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',nm),skyboxCapture:nn("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:nn('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:nn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;\n#ifdef FLIP_Y\nT=-T;B=-B;\n#endif\nhighp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));\n#ifdef FLIP_Y\nn=normalize(cross(fdx,fdy));\n#else\nn=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\n#ifdef FEATURE_CUTOUT\nfinalColor=apply_feature_cutout(finalColor,gl_FragCoord);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:nn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:nn("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:nn("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:nn("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:nn("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:nn("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Jn(f,r){const l=f.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let p of l)if(p=p.trim(),"#"===p[0]&&p.includes("if")&&!p.includes("endif")){p=p.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const y=p.split(" ");for(const v of y)r.includes(v)||r.push(v)}}function nn(f,r){const l=/#include\s+"([^"]+)"/g,p=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let y=r.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);y&&(y=y.map(P=>{const O=P.split(" ");return O[O.length-1]}),y=[...new Set(y)]);const v={},b=[],D=[];if(f=f.replace(l,(P,O)=>(D.push(O),"")),(r=r.replace(l,(P,O)=>(b.push(O),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let C=[...eh];Jn(f,C),Jn(r,C);for(const P of[...b,...D])_r[P]||console.error(`Undefined include: ${P}`),Ks[P]||(Ks[P]=[],Jn(_r[P],Ks[P])),C=[...C,...Ks[P]];return{fragmentSource:f=f.replace(p,(P,O,N,F,B)=>(v[B]=!0,"define"===O?`\n#ifndef HAS_UNIFORM_u_${B}\nin ${N} ${F} ${B};\n#else\nuniform ${N} ${F} u_${B};\n#endif\n`:"initialize"===O?`\n#ifdef HAS_UNIFORM_u_${B}\n    ${N} ${F} ${B} = u_${B};\n#endif\n`:"define-attribute"===O?`\n#ifdef HAS_ATTRIBUTE_a_${B}\n    in ${N} ${F} ${B};\n#endif\n`:"initialize-attribute"===O?"":void 0)),vertexSource:r=r.replace(p,(P,O,N,F,B)=>{const H="float"===F?"vec2":F,U=B.match(/color/)?"color":H;return"define-attribute-vertex-shader-only"===O?`\n#ifdef HAS_ATTRIBUTE_a_${B}\nin ${N} ${F} a_${B};\n#endif\n`:v[B]?"define"===O?`\n#ifndef HAS_UNIFORM_u_${B}\nuniform lowp float u_${B}_t;\nin ${N} ${H} a_${B};\nout ${N} ${F} ${B};\n#else\nuniform ${N} ${F} u_${B};\n#endif\n`:"initialize"===O?"vec4"===U?`\n#ifndef HAS_UNIFORM_u_${B}\n    ${B} = a_${B};\n#else\n    ${N} ${F} ${B} = u_${B};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${B}\n    ${B} = unpack_mix_${U}(a_${B}, u_${B}_t);\n#else\n    ${N} ${F} ${B} = u_${B};\n#endif\n`:"define-attribute"===O?`\n#ifdef HAS_ATTRIBUTE_a_${B}\n    in ${N} ${F} a_${B};\n    out ${N} ${F} ${B};\n#endif\n`:"initialize-attribute"===O?`\n#ifdef HAS_ATTRIBUTE_a_${B}\n    ${B} = a_${B};\n#endif\n`:void 0:"define"===O?`\n#ifndef HAS_UNIFORM_u_${B}\nuniform lowp float u_${B}_t;\nin ${N} ${H} a_${B};\n#else\nuniform ${N} ${F} u_${B};\n#endif\n`:"define-instanced"===O?"mat4"===U?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${B}0;\nin vec4 a_${B}1;\nin vec4 a_${B}2;\nin vec4 a_${B}3;\n#else\nuniform ${N} ${F} u_${B};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${N} ${H} a_${B};\n#else\nuniform ${N} ${F} u_${B};\n#endif\n`:"initialize-attribute-custom"===O?`\n#ifdef HAS_ATTRIBUTE_a_${B}\n    ${N} ${F} ${B} = a_${B};\n#endif\n`:"vec4"===U?`\n#ifndef HAS_UNIFORM_u_${B}\n    ${N} ${F} ${B} = a_${B};\n#else\n    ${N} ${F} ${B} = u_${B};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${B}\n    ${N} ${F} ${B} = unpack_mix_${U}(a_${B}, u_${B}_t);\n#else\n    ${N} ${F} ${B} = u_${B};\n#endif\n`}),staticAttributes:y,usedDefines:C,vertexIncludes:b,fragmentIncludes:D}}class os{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(r,l,p,y,v,b,D,C){this.context=r;let P=this.boundPaintVertexBuffers.length!==y.length;for(let N=0;!P&&N<y.length;N++)this.boundPaintVertexBuffers[N]!==y[N]&&(P=!0);let O=this.boundDynamicVertexBuffers.length!==D.length;for(let N=0;!O&&N<D.length;N++)this.boundDynamicVertexBuffers[N]!==D[N]&&(O=!0);if(!this.vao||this.boundProgram!==l||this.boundLayoutVertexBuffer!==p||P||O||this.boundIndexBuffer!==v||this.boundVertexOffset!==b)this.freshBind(l,p,y,v,b,D,C);else{r.bindVertexArrayOES.set(this.vao);for(const N of D)N&&(N.bind(),C&&N.instanceCount&&N.setVertexAttribDivisor(r.gl,l,C));v&&v.dynamicDraw&&v.bind()}}freshBind(r,l,p,y,v,b,D){const C=r.numAttributes,P=this.context,O=P.gl;this.vao&&this.destroy(),this.vao=P.gl.createVertexArray(),P.bindVertexArrayOES.set(this.vao),this.boundProgram=r,this.boundLayoutVertexBuffer=l,this.boundPaintVertexBuffers=p,this.boundIndexBuffer=y,this.boundVertexOffset=v,this.boundDynamicVertexBuffers=b,l.enableAttributes(O,r),l.bind(),l.setVertexAttribPointers(O,r,v);for(const N of p)N.enableAttributes(O,r),N.bind(),N.setVertexAttribPointers(O,r,v);for(const N of b)N&&(N.enableAttributes(O,r),N.bind(),N.setVertexAttribPointers(O,r,v),D&&N.instanceCount&&N.setVertexAttribDivisor(O,r,D));y&&y.bind(),P.currentNumAttributes=C}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Vc(f,r){const l=Math.pow(2,r.canonical.z),p=r.canonical.y;return[new u.ac(0,p/l).toLngLat().lat,new u.ac(0,(p+1)/l).toLngLat().lat]}function Hs(f,r,l,p,y,v,b){const D=f.context,C=D.gl,P=l.hillshadeFBO;if(!P)return;f.prepareDrawTile();const O=f.isTileAffectedByFog(r),N=f.getOrCreateProgram("hillshade",{overrideFog:O});D.activeTexture.set(C.TEXTURE0),C.bindTexture(C.TEXTURE_2D,P.colorAttachment.get());const F=((q,G,Y,ee)=>{const ne=Y.paint.get("hillshade-shadow-color"),le="none"===Y.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),de=Y.paint.get("hillshade-highlight-color"),pe="none"===Y.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),ae=Y.paint.get("hillshade-accent-color"),ce="none"===Y.paint.get("hillshade-accent-color-use-theme").constantOr("default"),ue=Y.paint.get("hillshade-emissive-strength");let Me=u.al(Y.paint.get("hillshade-illumination-direction"));if("viewport"===Y.paint.get("hillshade-illumination-anchor"))Me-=q.transform.angle;else if(q.style&&q.style.enable3dLights()&&q.style.directionalLight){const je=q.style.directionalLight.properties.get("direction"),Fe=u.d1(je.x,je.y,je.z);Me=u.al(Fe[1])}const ye=!q.options.moving;return{u_matrix:ee||q.transform.calculateProjMatrix(G.tileID.toUnwrapped(),ye),u_image:0,u_latrange:Vc(0,G.tileID),u_light:[Y.paint.get("hillshade-exaggeration"),Me],u_shadow:ne.toPremultipliedRenderColor(le?null:Y.lut),u_highlight:de.toPremultipliedRenderColor(pe?null:Y.lut),u_emissive_strength:ue,u_accent:ae.toPremultipliedRenderColor(ce?null:Y.lut)}})(f,l,p,f.terrain?r.projMatrix:null);f.uploadCommonUniforms(D,N,r.toUnwrapped());const{tileBoundsBuffer:B,tileBoundsIndexBuffer:H,tileBoundsSegments:U}=f.getTileBoundsBuffers(l);N.draw(f,C.TRIANGLES,y,v,b,Bt.disabled,F,p.id,B,H,U)}function Cf(f,r,l){if(!r.needsDEMTextureUpload)return;const p=f.context,y=p.gl;p.pixelStoreUnpackPremultiplyAlpha.set(!1),r.demTexture=r.demTexture||f.getTileTexture(l.stride);const v=l.getPixels();r.demTexture?r.demTexture.update(v,{premultiply:!1}):r.demTexture=new u.T(p,v,y.R32F,{premultiply:!1}),r.needsDEMTextureUpload=!1}function im(f,r,l){const p=f.context,y=p.gl;if(!r.dem)return;const v=r.dem;if(p.activeTexture.set(y.TEXTURE1),Cf(f,r,v),!r.demTexture)return;r.demTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE);const b=v.dim;p.activeTexture.set(y.TEXTURE0);let D=r.hillshadeFBO;if(!D){const F=new u.T(p,{width:b,height:b,data:null},y.RGBA8);F.bind(y.LINEAR,y.CLAMP_TO_EDGE),D=r.hillshadeFBO=p.createFramebuffer(b,b,!0,"renderbuffer"),D.colorAttachment.set(F.texture)}p.bindFramebuffer.set(D.framebuffer),p.viewport.set([0,0,b,b]);const{tileBoundsBuffer:C,tileBoundsIndexBuffer:P,tileBoundsSegments:O}=f.getMercatorTileBoundsBuffers(),N=[];f.linearFloatFilteringSupported()&&N.push("TERRAIN_DEM_FLOAT_FORMAT"),f.getOrCreateProgram("hillshadePrepare",{defines:N}).draw(f,y.TRIANGLES,bt.disabled,Vt.disabled,an.unblended,Bt.disabled,((F,B)=>{const H=B.stride,U=u.bz();return u.ca(U,0,u.aj,-u.aj,0,0,1),u.bo(U,U,[0,-u.aj,0]),{u_matrix:U,u_image:1,u_dimension:[H,H],u_zoom:F.overscaledZ}})(r.tileID,v),l.id,C,P,O),r.needsHillshadePrepare=!1}class Ii{constructor(r){this.gl=r.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(r){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class xv extends Ii{getDefault(){return u.am.transparent.toNonPremultipliedRenderColor(null)}set(r){const l=this.current;(r.r!==l.r||r.g!==l.g||r.b!==l.b||r.a!==l.a||this.dirty)&&(this.gl.clearColor(r.r,r.g,r.b,r.a),this.current=r,this.dirty=!1)}}class bv extends Ii{getDefault(){return 1}set(r){(r!==this.current||this.dirty)&&(this.gl.clearDepth(r),this.current=r,this.dirty=!1)}}class zr extends Ii{getDefault(){return 0}set(r){(r!==this.current||this.dirty)&&(this.gl.clearStencil(r),this.current=r,this.dirty=!1)}}class Qt extends Ii{getDefault(){return[!0,!0,!0,!0]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||r[2]!==l[2]||r[3]!==l[3]||this.dirty)&&(this.gl.colorMask(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class ei extends Ii{getDefault(){return!0}set(r){(r!==this.current||this.dirty)&&(this.gl.depthMask(r),this.current=r,this.dirty=!1)}}class Or extends Ii{getDefault(){return 255}set(r){(r!==this.current||this.dirty)&&(this.gl.stencilMask(r),this.current=r,this.dirty=!1)}}class ws extends Ii{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(r){const l=this.current;(r.func!==l.func||r.ref!==l.ref||r.mask!==l.mask||this.dirty)&&(this.gl.stencilFunc(r.func,r.ref,r.mask),this.current=r,this.dirty=!1)}}class nh extends Ii{getDefault(){const r=this.gl;return[r.KEEP,r.KEEP,r.KEEP]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||r[2]!==l[2]||this.dirty)&&(this.gl.stencilOp(r[0],r[1],r[2]),this.current=r,this.dirty=!1)}}class Ro extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;r?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),this.current=r,this.dirty=!1}}class Kl extends Ii{getDefault(){return[0,1]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||this.dirty)&&(this.gl.depthRange(r[0],r[1]),this.current=r,this.dirty=!1)}}class Fr extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;r?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),this.current=r,this.dirty=!1}}class ka extends Ii{getDefault(){return this.gl.LESS}set(r){(r!==this.current||this.dirty)&&(this.gl.depthFunc(r),this.current=r,this.dirty=!1)}}class Qs extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;r?l.enable(l.BLEND):l.disable(l.BLEND),this.current=r,this.dirty=!1}}class Fn extends Ii{getDefault(){const r=this.gl;return[r.ONE,r.ZERO,r.ONE,r.ZERO]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||r[2]!==l[2]||r[3]!==l[3]||this.dirty)&&(this.gl.blendFuncSeparate(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class Ql extends Ii{getDefault(){return u.am.transparent.toNonPremultipliedRenderColor(null)}set(r){const l=this.current;(r.r!==l.r||r.g!==l.g||r.b!==l.b||r.a!==l.a||this.dirty)&&(this.gl.blendColor(r.r,r.g,r.b,r.a),this.current=r,this.dirty=!1)}}class ih extends Ii{getDefault(){return this.gl.FUNC_ADD}set(r){(r!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(r,r),this.current=r,this.dirty=!1)}}class ga extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;r?l.enable(l.CULL_FACE):l.disable(l.CULL_FACE),this.current=r,this.dirty=!1}}class Br extends Ii{getDefault(){return this.gl.BACK}set(r){(r!==this.current||this.dirty)&&(this.gl.cullFace(r),this.current=r,this.dirty=!1)}}class jc extends Ii{getDefault(){return this.gl.CCW}set(r){(r!==this.current||this.dirty)&&(this.gl.frontFace(r),this.current=r,this.dirty=!1)}}let Uc=class extends Ii{getDefault(){return null}set(f){(f!==this.current||this.dirty)&&(this.gl.useProgram(f),this.current=f,this.dirty=!1)}};class ss extends Ii{getDefault(){return this.gl.TEXTURE0}set(r){(r!==this.current||this.dirty)&&(this.gl.activeTexture(r),this.current=r,this.dirty=!1)}}class Jl extends Ii{getDefault(){const r=this.gl;return[0,0,r.drawingBufferWidth,r.drawingBufferHeight]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||r[2]!==l[2]||r[3]!==l[3]||this.dirty)&&(this.gl.viewport(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class rh extends Ii{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.bindFramebuffer(l.FRAMEBUFFER,r),this.current=r,this.dirty=!1}}class La extends Ii{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.bindRenderbuffer(l.RENDERBUFFER,r),this.current=r,this.dirty=!1}}class Js extends Ii{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.bindTexture(l.TEXTURE_2D,r),this.current=r,this.dirty=!1}}class rl extends Ii{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.bindBuffer(l.ARRAY_BUFFER,r),this.current=r,this.dirty=!1}}class $u extends Ii{getDefault(){return null}set(r){const l=this.gl;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,r),this.current=r,this.dirty=!1}}class xi extends Ii{getDefault(){return null}set(r){this.gl&&(r!==this.current||this.dirty)&&(this.gl.bindVertexArray(r),this.current=r,this.dirty=!1)}}class wv extends Ii{getDefault(){return 4}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_ALIGNMENT,r),this.current=r,this.dirty=!1}}class ec extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r),this.current=r,this.dirty=!1}}class rm extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,r),this.current=r,this.dirty=!1}}class ea extends Ii{constructor(r,l){super(r),this.context=r,this.parent=l}getDefault(){return null}}class If extends ea{setDirty(){this.dirty=!0}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,r,0),this.current=r,this.dirty=!1}}class Hc extends ea{attachment(){return this.gl.DEPTH_ATTACHMENT}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,this.attachment(),l.RENDERBUFFER,r),this.current=r,this.dirty=!1}}class Gc extends ea{attachment(){return this.gl.DEPTH_ATTACHMENT}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferTexture2D(l.FRAMEBUFFER,this.attachment(),l.TEXTURE_2D,r,0),this.current=r,this.dirty=!1}}class ao extends Hc{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const t_=(f,r,l)=>({u_matrix:f,u_image0:0,u_skirt_height:r,u_ground_shadow_factor:l}),Oo=(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U)=>({u_proj_matrix:Float32Array.from(f),u_globe_matrix:r,u_normalize_matrix:Float32Array.from(p),u_merc_matrix:l,u_zoom_transition:y,u_merc_center:v,u_image0:0,u_frustum_tl:b,u_frustum_tr:D,u_frustum_br:C,u_frustum_bl:P,u_globe_pos:O,u_globe_radius:N,u_viewport:F,u_grid_matrix:U?Float32Array.from(U):new Float32Array(9),u_skirt_height:B,u_far_z_cutoff:H});function Fo(f,r){return null!=f&&null!=r&&!(!f.hasData()||!r.hasData())&&null!=f.demTexture&&null!=r.demTexture&&f.tileID.key!==r.tileID.key}const ol=new class{constructor(){this.operations={}}newMorphing(f,r,l,p,y){if(f in this.operations){const v=this.operations[f];v.to.tileID.key!==l.tileID.key&&(v.queued=l)}else this.operations[f]={startTime:p,phase:0,duration:y,from:r,to:l,queued:null}}getMorphValuesForProxy(f){if(!(f in this.operations))return null;const r=this.operations[f];return{from:r.from,to:r.to,phase:r.phase}}update(f){for(const r in this.operations){const l=this.operations[r];for(l.phase=(f-l.startTime)/l.duration;l.phase>=1||!this._validOp(l);)if(!this._nextOp(l,f)){delete this.operations[r];break}}}_nextOp(f,r){return!!f.queued&&(f.from=f.to,f.to=f.queued,f.queued=null,f.phase=0,f.startTime=r,!0)}_validOp(f){return f.from.hasData()&&f.to.hasData()}},tc={0:null,1:"TERRAIN_VERTEX_MORPHING"};function sl(f,r,l){if(0===r)return 0;const p=r<1&&514===l?.25/r:1;return 6*Math.pow(1.5,22-f)*Math.max(r,1)*p}function as(f,r){const l=1<<f.z;return!r&&(0===f.x||f.x===l-1)||0===f.y||f.y===l-1}const qu=f=>({u_matrix:f});function ls(f,r,l,p,y){if(y>0){const v=u.q.now(),b=(v-f.timeAdded)/y,D=r?(v-r.timeAdded)/y:-1,C=l.getSource(),P=p.coveringZoomLevel({tileSize:C.tileSize,roundZoom:C.roundZoom}),O=!r||Math.abs(r.tileID.overscaledZ-P)>Math.abs(f.tileID.overscaledZ-P),N=O&&f.refreshedUponExpiration?1:u.ay(O?b:1-D,0,1);return f.refreshedUponExpiration&&b>=1&&(f.refreshedUponExpiration=!1),r?{opacity:1,mix:1-N}:{opacity:N,mix:0}}return{opacity:1,mix:0}}class om extends Po{constructor(r){const l=Ru("mock-dem",{type:"raster-dem",maxzoom:r.transform.maxZoom},r.style.dispatcher,r.style);super("mock-dem",l,!1),l.setEventedParent(this),this._sourceLoaded=!0}_loadTile(r,l){r.state="loaded",l(null)}}class sm extends Po{constructor(r){const l=Ru("proxy",{type:"geojson",maxzoom:r.transform.maxZoom},r.style.dispatcher,r.style);super("proxy",l,!1),l.setEventedParent(this),this.map=this.getSource().map=r,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(r,l,p){if(r.freezeTileCoverage)return;this.transform=r;const y=r.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((v,b)=>{if(v[b.key]="",!this._tiles[b.key]){const D=new Cc(b,this._source.tileSize*b.overscaleFactor(),r.tileZoom,void 0,void 0,this._source.worldview);D.state="loaded",this._tiles[b.key]=D}return v},{});for(const v in this._tiles)v in y||(this.freeFBO(v),this._tiles[v].unloadVectorData(),delete this._tiles[v])}freeFBO(r){const l=this.proxyCachedFBO[r];if(void 0!==l){const p=Object.values(l);this.renderCachePool.push(...p),delete this.proxyCachedFBO[r]}}deallocRenderCache(){this.renderCache.forEach(r=>r.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class oh extends u.aM{constructor(r,l,p){super(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y),this.proxyTileKey=l,this.projMatrix=p}}class Af extends u.dF{constructor(r,l){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},r.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),r.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),r.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=r,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[p,y,v]=function(C){const P=new u.ba,O=new u.a_,N=131;P.reserve(17161),O.reserve(33800);const F=u.aj/128,B=u.aj+F/2,H=B+F;for(let q=-F;q<H;q+=F)for(let G=-F;G<H;G+=F){const Y=G<0||G>B||q<0||q>B?24575:0,ee=u.ay(Math.round(G),0,u.aj),ne=u.ay(Math.round(q),0,u.aj);P.emplaceBack(ee+Y,ne)}const U=(q,G)=>{const Y=G*N+q;O.emplaceBack(Y+1,Y,Y+N),O.emplaceBack(Y+N,Y+N+1,Y+1)};for(let q=1;q<129;q++)for(let G=1;G<129;G++)U(G,q);return[0,129].forEach(q=>{for(let G=0;G<130;G++)U(G,q),U(q,G)}),[P,O,32768]}(),b=r.context;this.gridBuffer=b.createVertexBuffer(p,u.bc.members),this.gridIndexBuffer=b.createIndexBuffer(y),this.gridSegments=u.bd.simpleSegment(0,0,p.length,y.length),this.gridNoSkirtSegments=u.bd.simpleSegment(0,0,p.length,v),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new sm(l.map),this.orthoMatrix=u.bz(),u.ca(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,u.aj,0,u.aj,0,1);const D=b.gl;this._overlapStencilMode=new Vt({func:D.GEQUAL,mask:255},0,255,D.KEEP,D.KEEP,D.REPLACE),this._previousZoom=r.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=l,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new om(l.map),this._pendingGroundEffectLayers=[]}set style(r){r.on("data",this._onStyleDataEvent.bind(this)),this._style=r,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(r,l,p){if(r&&r.terrain){this._style!==r&&(this.style=r,this._evaluationZoom=void 0);const y=r.terrain.properties,v=0===r.terrain.drapeRenderMode,b=r.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=u.q.now();const D=r.terrain&&r.terrain.scope,C=y.get("source"),P=v?this._mockSourceCache:r.getSourceCache(C,D);if(!P)return void u.w(`Couldn't find terrain source "${C}".`);if(this.sourceCache=P,this._attenuationRange=r.terrain.getAttenuationRange(),this._exaggeration=b?this.calculateExaggeration(l):y.get("exaggeration"),!l.projection.requiresDraping&&b&&0===this._exaggeration)return void this._disable();this.enabled=!0;const O=()=>{this.sourceCache.used&&u.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const N=this.getScaledDemTileSize();this.sourceCache.update(l,N,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,O(),this._initializing=!0),O(),l.updateElevation(!0,p),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(l),this._emptyDEMTextureDirty=!0,this._previousZoom=l.zoom}else this._disable()}calculateExaggeration(r){if(this._attenuationRange&&r.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(r.zoom);const l=this._previousCameraAltitude,p=r.getFreeCameraOptions().position.z/r.pixelsPerMeter*r.worldSize;this._previousCameraAltitude=p;const y=null!=l?p-l:Number.MAX_VALUE;if(Math.abs(y)<2)return this._exaggeration;const v=r.zoom,b=this._style.terrain;if(!this._previousUpdateTimestamp)return b.getExaggeration(v);let D=v-this._previousZoom;const C=this._previousUpdateTimestamp;let P=v;null!=this._evaluationZoom&&(P=this._evaluationZoom,Math.abs(v-P)>.5&&(D=.5*(v-P+D)),D*y<0&&(P+=D)),this._evaluationZoom=P;const O=b.getExaggeration(P),N=O===b.getExaggeration(Math.max(0,P-.1));if(N&&Math.abs(O-this._exaggeration)<.01)return O;let F=Math.min(.1,.00375*(this._updateTimestamp-C));return(N||O<.1||Math.abs(D)<1e-4)&&(F=Math.min(.2,4*F)),u.ai(this._exaggeration,O,F)}resetTileLookupCache(r){this._findCoveringTileCache[r]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(r){r.coord&&"source"===r.dataType?this._clearRenderCacheForTile(r.sourceCacheId,r.coord):"style"===r.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const r in this._style._mergedSourceCaches)this._style._mergedSourceCaches[r].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(r=>r.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const r=2*this.proxySourceCache.getSource().tileSize;return[r,r]}set useVertexMorphing(r){this._useVertexMorphing=r}updateTileBinding(r){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const l=this.proxySourceCache,p=this.painter.transform;this._initializing&&(this._initializing=0===p._centerAltitude&&-1===this.getAtPointOrZero(u.ac.fromLngLat(p.center),-1),this._emptyDEMTextureDirty=!this._initializing);const y=this.proxyCoords=l.getIds().map(C=>{const P=l.getTileByID(C).tileID;return P.projMatrix=p.calculateProjMatrix(P.toUnwrapped()),P});!function(C,P){const O=P.transform.pointCoordinate(P.transform.getCameraPoint()),N=new u.P(O.x,O.y);C.sort((F,B)=>{if(B.overscaledZ-F.overscaledZ)return B.overscaledZ-F.overscaledZ;const H=new u.P(F.canonical.x+(1<<F.canonical.z)*F.wrap,F.canonical.y),U=new u.P(B.canonical.x+(1<<B.canonical.z)*B.wrap,B.canonical.y),q=N.mult(1<<F.canonical.z);return q.x-=.5,q.y-=.5,q.distSqr(H)-q.distSqr(U)})}(y,this.painter);const v=this.proxyToSource||{};this.proxyToSource={},y.forEach(C=>{this.proxyToSource[C.key]={}}),this.terrainTileForTile={};const b=this._style._mergedSourceCaches;for(const C in b){const P=b[C];if(!P.used||(P!==this.sourceCache&&this.resetTileLookupCache(P.id),this._setupProxiedCoordsForOrtho(P,r[C],v),P.usedForTerrain))continue;const O=r[C];P.getSource().reparseOverscaled&&this._assignTerrainTiles(O)}this.proxiedCoords[l.id]=y.map(C=>new oh(C,C.key,this.orthoMatrix)),this._assignTerrainTiles(y),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(v),this.renderingToTexture=!1;const D={};this._visibleDemTiles=[];for(const C of this.proxyCoords){const P=this.terrainTileForTile[C.key];if(!P)continue;const O=P.tileID.key;O in D||(this._visibleDemTiles.push(P),D[O]=O)}}_assignTerrainTiles(r){this._initializing||r.forEach(l=>{if(this.terrainTileForTile[l.key])return;const p=this._findTileCoveringTileID(l,this.sourceCache);p&&(this.terrainTileForTile[l.key]=p)})}_prepareDEMTextures(){const r=this.painter.context,l=r.gl;for(const p in this.terrainTileForTile){const y=this.terrainTileForTile[p],v=y.dem;!v||y.demTexture&&!y.needsDEMTextureUpload||(r.activeTexture.set(l.TEXTURE1),Cf(this.painter,y,v))}}_prepareDemTileUniforms(r,l,p,y){if(!l||null==l.demTexture)return!1;const v=r.tileID.canonical,b=Math.pow(2,l.tileID.canonical.z-v.z),D=y||"";return p[`u_dem_tl${D}`]=[v.x*b%1,v.y*b%1],p[`u_dem_scale${D}`]=b,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let r=0;const l=this._visibleDemTiles.reduce((p,y)=>{if(!y.dem)return p;const v=y.dem.tree.minimums[0];return v>0&&r++,p+v},0);return r?l/r:0}_updateEmptyDEMTexture(){const r=this.painter.context,l=r.gl;r.activeTexture.set(l.TEXTURE2);const p=this._getLoadedAreaMinimum(),y=new u.dG({width:1,height:1},new Float32Array([p]));this._emptyDEMTextureDirty=!1;let v=this._emptyDEMTexture;return v?v.update(y,{premultiply:!1}):v=this._emptyDEMTexture=new u.T(r,y,l.R32F,{premultiply:!1}),v}setupElevationDraw(r,l,p){const y=this.painter.context,v=y.gl,b={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};b.u_exaggeration=this.exaggeration();let D=null,C=null,P=1;if(p&&p.morphing&&this._useVertexMorphing){const B=p.morphing.srcDemTile,H=p.morphing.dstDemTile;P=p.morphing.phase,B&&H&&(this._prepareDemTileUniforms(r,B,b,"_prev")&&(C=B),this._prepareDemTileUniforms(r,H,b)&&(D=H))}const O=B=>B&&B.demTexture&&this.painter.linearFloatFilteringSupported()?v.LINEAR:v.NEAREST;let N=null;var F;if(this.enabled?C&&D?(N=D.demTexture,y.activeTexture.set(v.TEXTURE4),C.demTexture.bind(O(C),v.CLAMP_TO_EDGE),b.u_dem_lerp=P):(D=this.terrainTileForTile[r.tileID.key],N=this._prepareDemTileUniforms(r,D,b)?D.demTexture:this.emptyDEMTexture):N=this.emptyDEMTexture,y.activeTexture.set(v.TEXTURE2),N&&(b.u_dem_size=1===(F=N).size[0]?1:F.size[0]-2,N.bind(O(D),v.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(p&&p.useDepthForOcclusion,l,b),p&&p.useMeterToDem&&D){const B=(1<<D.tileID.canonical.z)*u.cb(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;b.u_meter_to_dem=B}if(p&&p.labelPlaneMatrixInv&&(b.u_label_plane_matrix_inv=p.labelPlaneMatrixInv),l.setTerrainUniformValues(y,b),"globe"===this.painter.transform.projection.name){const B=this.globeUniformValues(this.painter.transform,r.tileID.canonical,p&&p.useDenormalizedUpVectorScale);l.setGlobeUniformValues(y,B)}}globeUniformValues(r,l,p){const y=r.projection;return{u_tile_tl_up:y.upVector(l,0,0),u_tile_tr_up:y.upVector(l,u.aj,0),u_tile_br_up:y.upVector(l,u.aj,u.aj),u_tile_bl_up:y.upVector(l,0,u.aj),u_tile_up_scale:p?u.dH(1):y.upVectorScale(l,r.center.lat,r.worldSize).metersToTile}}renderToBackBuffer(r){const l=this.painter,p=this.painter.context;0!==r.length&&(p.bindFramebuffer.set(null),p.viewport.set([0,0,l.width,l.height]),l.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(y,v,b,D,C){if("globe"===y.transform.projection.name)!function(P,O,N,F,B){const H=P.context,U=H.gl;let q,G;const Y=P.transform,ee=u.dy(P,H,Y),ne=(je,Fe)=>{if(G===Fe)return;const Ge=[tc[Fe],"PROJECTION_GLOBE_VIEW"];ee&&Ge.push("CUSTOM_ANTIALIASING");const rt=P.isTileAffectedByFog(je);q=P.getOrCreateProgram("globeRaster",{defines:Ge,overrideFog:rt}),G=Fe},le=P.colorModeForRenderPass(),de=new bt(U.LEQUAL,bt.ReadWrite,P.depthRangeFor3D);ol.update(B);const pe=u.dz(Y),ae=[u.aD(Y.center.lng),u.aH(Y.center.lat)],ce=P.globeSharedBuffers,ue=[Y.width*u.q.devicePixelRatio,Y.height*u.q.devicePixelRatio],Me=Float32Array.from(Y.globeMatrix),ye={useDenormalizedUpVectorScale:!0};{const je=P.transform,Fe=sl(je.zoom,O.exaggeration(),O.sourceCache._source.tileSize);G=-1;const Ge=U.TRIANGLES;for(const rt of F){const De=N.getTile(rt),_e=Vt.disabled,Ne=O.prevTerrainTileForTile[rt.key],Re=O.terrainTileForTile[rt.key];Fo(Ne,Re)&&ol.newMorphing(rt.key,Ne,Re,B,250),H.activeTexture.set(U.TEXTURE0),De.texture&&De.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);const We=ol.getMorphValuesForProxy(rt.key),Ze=We?1:0;We&&u.L(ye,{morphing:{srcDemTile:We.from,dstDemTile:We.to,phase:u.dx(We.phase)}});const Ye=u.dA(rt.canonical),ct=u.dB(Ye.getCenter().lat),Mt=u.dC(rt.canonical,Ye,ct,je.worldSize/je._pixelsPerMercatorPixel),kt=u.bh(u.dD(rt.canonical)),vt=Oo(je.expandedFarZProjMatrix,Me,pe,kt,u.ah(je.zoom),ae,je.frustumCorners.TL,je.frustumCorners.TR,je.frustumCorners.BR,je.frustumCorners.BL,je.globeCenterInViewSpace,je.globeRadius,ue,Fe,je._farZ,Mt);if(ne(rt,Ze),q&&(O.setupElevationDraw(De,q,ye),P.uploadCommonUniforms(H,q,rt.toUnwrapped()),ce)){const[Ot,Pt,Wt]=ce.getGridBuffers(ct,0!==Fe);q.draw(P,Ge,de,_e,le,Bt.backCCW,vt,"globe_raster",Ot,Pt,Wt)}}}if(ce&&(P.renderDefaultNorthPole||P.renderDefaultSouthPole)){const je=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];ee&&je.push("CUSTOM_ANTIALIASING"),q=P.getOrCreateProgram("globeRaster",{defines:je});for(const Fe of F){const{x:Ge,y:rt,z:De}=Fe.canonical,_e=0===rt,Ne=rt===(1<<De)-1,[Re,We,Ze,Ye]=ce.getPoleBuffers(De,!1);if(Ye&&(_e||Ne)){const ct=N.getTile(Fe);H.activeTexture.set(U.TEXTURE0),ct.texture&&ct.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);let Mt=u.dE(De,Ge,Y);const kt=u.bh(u.dD(Fe.canonical)),vt=(Ot,Pt)=>Ot.draw(P,U.TRIANGLES,de,Vt.disabled,le,Bt.disabled,Oo(Y.expandedFarZProjMatrix,Mt,Mt,kt,0,ae,Y.frustumCorners.TL,Y.frustumCorners.TR,Y.frustumCorners.BR,Y.frustumCorners.BL,Y.globeCenterInViewSpace,Y.globeRadius,ue,0,Y._farZ),"globe_pole_raster",Pt,Ze,Ye);O.setupElevationDraw(ct,q,ye),P.uploadCommonUniforms(H,q,Fe.toUnwrapped()),_e&&P.renderDefaultNorthPole&&vt(q,Re),Ne&&P.renderDefaultSouthPole&&(Mt=u.cP(u.bz(),Mt,[1,-1,1]),vt(q,We))}}}}(y,v,b,D,C);else{const P=y.context,O=P.gl;let N,F;const B=y.shadowRenderer,H=xo(y,y.longestCutoffRange),U=le=>{if(F===le)return;const de=[];de.push(tc[le]),H.shouldRenderCutoff&&de.push("RENDER_CUTOFF"),B&&(de.push("RENDER_SHADOWS","DEPTH_TEXTURE"),B.useNormalOffset&&de.push("NORMAL_OFFSET")),N=y.getOrCreateProgram("terrainRaster",{defines:de}),F=le},q=y.colorModeForRenderPass(),G=new bt(O.LEQUAL,bt.ReadWrite,y.depthRangeFor3D);ol.update(C);const Y=y.transform,ee=sl(Y.zoom,v.exaggeration(),v.sourceCache._source.tileSize);let ne=[0,0,0];if(B){const le=y.style.directionalLight,de=y.style.ambientLight;le&&de&&(ne=nl(y.style,le,de))}{F=-1;const le=O.TRIANGLES,[de,pe]=[v.gridIndexBuffer,v.gridSegments];for(const ae of D){const ce=b.getTile(ae),ue=Vt.disabled,Me=v.prevTerrainTileForTile[ae.key],ye=v.terrainTileForTile[ae.key];Fo(Me,ye)&&ol.newMorphing(ae.key,Me,ye,C,250),P.activeTexture.set(O.TEXTURE0),ce.texture&&ce.texture.bind(O.LINEAR,O.CLAMP_TO_EDGE);const je=ol.getMorphValuesForProxy(ae.key),Fe=je?1:0;let Ge;je&&(Ge={morphing:{srcDemTile:je.from,dstDemTile:je.to,phase:u.dx(je.phase)}});const rt=t_(ae.projMatrix,as(ae.canonical,Y.renderWorldCopies)?ee/10:ee,ne);if(U(Fe),!N)continue;v.setupElevationDraw(ce,N,Ge);const De=ae.toUnwrapped();B&&B.setupShadows(De,N),y.uploadCommonUniforms(P,N,De,null,H),N.draw(y,le,G,ue,q,Bt.backCCW,rt,"terrain_raster",v.gridBuffer,de,pe)}}}}(l,this,this.proxySourceCache,r,this._updateTimestamp),this.renderingToTexture=!0,l.gpuTimingDeferredRenderEnd(),r.splice(0,r.length))}renderBatch(r){if(0===this._drapedRenderBatches.length)return r+1;this.renderingToTexture=!0;const l=this.painter,p=this.painter.context,y=this.proxySourceCache,v=this.proxiedCoords[y.id],b=this._drapedRenderBatches.shift(),D=l.style.order,C=[];let P=0;for(const O of v){const N=y.getTileByID(O.proxyTileKey),F=y.proxyCachedFBO[O.key]?y.proxyCachedFBO[O.key][r]:void 0,B=void 0!==F?y.renderCache[F]:this.pool[P++],H=void 0!==F;if(N.texture=B.tex,H&&!B.dirty){C.push(N.tileID);continue}let U;p.bindFramebuffer.set(B.fb.framebuffer),this.renderedToTile=!1,B.dirty&&(p.clear({color:u.am.transparent,stencil:0}),B.dirty=!1);for(let q=b.start;q<=b.end;++q){const G=l.style._mergedLayers[D[q]];if(G.isHidden(l.transform.zoom))continue;const Y=l.style.getLayerSourceCache(G),ee=Y?this.proxyToSource[O.key][Y.id]:[O];if(!ee)continue;const ne=ee;p.viewport.set([0,0,B.fb.width,B.fb.height]),U!==(Y?Y.id:null)&&(this._setupStencil(B,ee,G,Y),U=Y?Y.id:null),l.renderLayer(l,Y,G,ne)}if(0===this._drapedRenderBatches.length)for(const q of this._pendingGroundEffectLayers){const G=l.style._mergedLayers[D[q]];if(G.isHidden(l.transform.zoom))continue;const Y=l.style.getLayerSourceCache(G),ee=Y?this.proxyToSource[O.key][Y.id]:[O];if(!ee)continue;const ne=ee;p.viewport.set([0,0,B.fb.width,B.fb.height]),U!==(Y?Y.id:null)&&(this._setupStencil(B,ee,G,Y),U=Y?Y.id:null),l.renderLayer(l,Y,G,ne)}this.renderedToTile?(B.dirty=!0,C.push(N.tileID)):H||--P,5===P&&(P=0,this.renderToBackBuffer(C))}return this.renderToBackBuffer(C),this.renderingToTexture=!1,p.bindFramebuffer.set(null),p.viewport.set([0,0,l.width,l.height]),b.end+1}postRender(){}isLayerOrderingCorrect(r){const l=r.order.length;let p=-1,y=l;for(let v=0;v<l;++v)this._style.isLayerDraped(r._mergedLayers[r.order[v]])?p=Math.max(p,v):y=Math.min(y,v);return y>p}getMinElevationBelowMSL(){let r=0;return this._visibleDemTiles.filter(l=>l.dem).forEach(l=>{r=Math.min(r,l.dem.tree.minimums[0])}),0===r?r:(r-30)*this._exaggeration}raycast(r,l,p){if(!this._visibleDemTiles)return null;const y=this._visibleDemTiles.filter(v=>v.dem).map(v=>{const b=v.tileID,D=1<<b.overscaledZ,{x:C,y:P}=b.canonical,O=C/D,N=(C+1)/D,F=P/D,B=(P+1)/D;return{minx:O,miny:F,maxx:N,maxy:B,t:v.dem.tree.raycastRoot(O,F,N,B,r,l,p),tile:v}});y.sort((v,b)=>(null!==v.t?v.t:Number.MAX_VALUE)-(null!==b.t?b.t:Number.MAX_VALUE));for(const v of y){if(null==v.t)return null;const b=v.tile.dem.tree.raycast(v.minx,v.miny,v.maxx,v.maxy,r,l,p);if(null!=b)return b}return null}_createFBO(){const r=this.painter.context,l=r.gl,p=this.drapeBufferSize;r.activeTexture.set(l.TEXTURE0);const y=new u.T(r,{width:p[0],height:p[1],data:null},l.RGBA8);y.bind(l.LINEAR,l.CLAMP_TO_EDGE);const v=r.createFramebuffer(p[0],p[1],!0,null);return v.colorAttachment.set(y.texture),v.depthAttachment=new ao(r,v.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=r.createRenderbuffer(r.gl.DEPTH_STENCIL,p[0],p[1]),this._stencilRef=0,v.depthAttachment.set(this._sharedDepthStencil),r.clear({stencil:0})):v.depthAttachment.set(this._sharedDepthStencil),r.extTextureFilterAnisotropic&&l.texParameterf(l.TEXTURE_2D,r.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,r.extTextureFilterAnisotropicMax),{fb:v,tex:y,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const r in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[r].hasTransition())return!0;return this._style.order.some(r=>{const l=this._style._mergedLayers[r],p=l.isHidden(this.painter.transform.zoom);return"hillshade"===l.type||"custom"===l.type?!p&&l.shouldRedrape():!p&&l.hasTransition()})}_clearLineLayersFromRenderCache(){let r=!1;for(const p of this._style.getSources())if(p instanceof jd){r=!0;break}if(!r)return;const l={};for(let p=0;p<this._style.order.length;++p){const y=this._style._mergedLayers[this._style.order[p]],v=this._style.getLayerSourceCache(y);if(v&&!l[v.id]&&!y.isHidden(this.painter.transform.zoom)&&"line"===y.type&&y.widthExpression()instanceof u.ab){l[v.id]=!0;for(const b of this.proxyCoords){const D=this.proxyToSource[b.key][v.id];if(D)for(const C of D)this._clearRenderCacheForTile(v.id,C)}}}}_clearRasterLayersFromRenderCache(){let r=!1;for(const p in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[p]._source instanceof so){r=!0;break}if(!r)return;const l={};for(let p=0;p<this._style.order.length;++p){const y=this._style._mergedLayers[this._style.order[p]],v=this._style.getLayerSourceCache(y);if(!v||l[v.id]||y.isHidden(this.painter.transform.zoom)||"raster"!==y.type)continue;const b=y.paint.get("raster-fade-duration");for(const D of this.proxyCoords){const C=this.proxyToSource[D.key][v.id];if(C)for(const P of C){const O=ls(v.getTile(P),v.findLoadedParent(P,0),v,this.painter.transform,b);(1!==O.opacity||0!==O.mix)&&this._clearRenderCacheForTile(v.id,P)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const r=this._style.order,l=r.length;if(0===l)return;const p=[];this._pendingGroundEffectLayers=[];let y,v=0,b=this._style._mergedLayers[r[v]];for(;!this._style.isLayerDraped(b)&&b.isHidden(this.painter.transform.zoom)&&++v<l;)b=this._style._mergedLayers[r[v]];for(;v<l;++v){const D=this._style._mergedLayers[r[v]];D.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(D)?void 0===y&&(y=v):("fill-extrusion"===D.type&&this._pendingGroundEffectLayers.push(v),void 0!==y&&(p.push({start:y,end:v-1}),y=void 0)))}if(void 0!==y&&p.push({start:y,end:v-1}),0!==p.length){const D=p[p.length-1];this._pendingGroundEffectLayers.every(C=>C>D.end)||u.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=p}_setupRenderCache(r){const l=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,l.renderCache.length>l.renderCachePool.length){const b=Object.values(l.proxyCachedFBO);l.proxyCachedFBO={};for(let D=0;D<b.length;++D){const C=Object.values(b[D]);l.renderCachePool.push(...C)}}return}this._clearRasterLayersFromRenderCache();const p=this.proxyCoords,y=this._tilesDirty;for(let b=p.length-1;b>=0;b--){const D=p[b];if(l.getTileByID(D.key),void 0!==l.proxyCachedFBO[D.key]){const C=r[D.key],P=this.proxyToSource[D.key];let O=0;for(const N in P){const F=P[N],B=C[N];if(!B||B.length!==F.length||F.some((H,U)=>H!==B[U]||y[N]&&y[N].hasOwnProperty(H.key))){O=-1;break}++O}for(const N in l.proxyCachedFBO[D.key])l.renderCache[l.proxyCachedFBO[D.key][N]].dirty=O<0||O!==Object.values(C).length}}const v=[...this._drapedRenderBatches];v.sort((b,D)=>D.end-D.start-(b.end-b.start));for(const b of v)for(const D of p){if(l.proxyCachedFBO[D.key])continue;let C=l.renderCachePool.pop();void 0===C&&l.renderCache.length<50&&(C=l.renderCache.length,l.renderCache.push(this._createFBO())),void 0!==C&&(l.proxyCachedFBO[D.key]={},l.proxyCachedFBO[D.key][b.start]=C,l.renderCache[C].dirty=!0)}this._tilesDirty={}}_setupStencil(r,l,p,y){if(!y||!this._sourceTilesOverlap[y.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const v=this.painter.context,b=v.gl;if(l.length<=1)return void(this._overlapStencilType=!1);let D;if(p.isTileClipped())D=l.length,this._overlapStencilMode.test={func:b.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(l[0].overscaledZ>l[l.length-1].overscaledZ))return void(this._overlapStencilType=!1);D=1,this._overlapStencilMode.test={func:b.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+D>255&&(v.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=D,this._overlapStencilMode.ref=this._stencilRef,p.isTileClipped()&&this._renderTileClippingMasks(l,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(r){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[r.key]),this._overlapStencilMode):Vt.disabled}_renderTileClippingMasks(r,l){const p=this.painter,y=this.painter.context,v=y.gl;p._tileClippingMaskIDs={},y.setColorMode(an.disabled),y.setDepthMode(bt.disabled);const b=p.getOrCreateProgram("clippingMask");for(const D of r){const C=p._tileClippingMaskIDs[D.key]=--l;b.draw(p,v.TRIANGLES,bt.disabled,new Vt({func:v.ALWAYS,mask:0},C,255,v.KEEP,v.KEEP,v.REPLACE),an.disabled,Bt.disabled,qu(D.projMatrix),"$clipping",p.tileExtentBuffer,p.quadTriangleIndexBuffer,p.tileExtentSegments)}}pointCoordinate(r){const l=this.painter.transform;if(r.x<0||r.x>l.width||r.y<0||r.y>l.height)return null;const p=[r.x,r.y,1,1];u.aA(p,p,l.pixelMatrixInverse),u.cH(p,p,1/p[3]),p[0]/=l.worldSize,p[1]/=l.worldSize;const y=l._camera.position,v=u.cb(1,l.center.lat),b=[y[0],y[1],y[2]/v,0],D=u.d7([],p.slice(0,3),b);u.au(D,D);const C=this.raycast(b,D,this._exaggeration);return null!==C&&C?(u.bE(b,b,D,C),b[3]=b[2],b[2]*=v,b):null}_setupProxiedCoordsForOrtho(r,l,p){if(r.getSource()instanceof u.aP)return this._setupProxiedCoordsForImageSource(r,l,p);this._findCoveringTileCache[r.id]=this._findCoveringTileCache[r.id]||{};const y=this.proxiedCoords[r.id]=[],v=this.proxyCoords;for(let C=0;C<v.length;C++){const P=v[C],O=this._findTileCoveringTileID(P,r);if(O){const N=this._createProxiedId(P,O,p[P.key]&&p[P.key][r.id]);y.push(N),this.proxyToSource[P.key][r.id]=[N]}}let b=!1;const D=new Set;for(let C=0;C<l.length;C++){const P=r.getTile(l[C]);if(!P||!P.hasData())continue;const O=this._findTileCoveringTileID(P.tileID,this.proxySourceCache);if(O&&O.tileID.canonical.z!==P.tileID.canonical.z){const N=this.proxyToSource[O.tileID.key][r.id],F=this._createProxiedId(O.tileID,P,p[O.tileID.key]&&p[O.tileID.key][r.id]);N?N.splice(N.length-1,0,F):this.proxyToSource[O.tileID.key][r.id]=[F];const B=this.proxyToSource[O.tileID.key][r.id];D.has(B)||D.add(B),y.push(F),b=!0}}if(this._sourceTilesOverlap[r.id]=b,b&&this._debugParams.sortTilesHiZFirst)for(const C of D)C.sort((P,O)=>O.overscaledZ-P.overscaledZ)}_setupProxiedCoordsForImageSource(r,l,p){if(!r.getSource().loaded())return;const y=this.proxiedCoords[r.id]=[],v=this.proxyCoords,b=r.getSource(),D=b.tileID;if(!D)return;const C=new u.P(D.x,D.y)._div(1<<D.z),P=b.coordinates.map(u.ac.fromLngLat).reduce((N,F)=>(N.min.x=Math.min(N.min.x,F.x-C.x),N.min.y=Math.min(N.min.y,F.y-C.y),N.max.x=Math.max(N.max.x,F.x-C.x),N.max.y=Math.max(N.max.y,F.y-C.y),N),{min:new u.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new u.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),O=(N,F)=>{const B=N.wrap+N.canonical.x/(1<<N.canonical.z),H=N.canonical.y/(1<<N.canonical.z),U=u.aj/(1<<N.canonical.z),q=F.wrap+F.canonical.x/(1<<F.canonical.z),G=F.canonical.y/(1<<F.canonical.z);return B+U<q+P.min.x||B>q+P.max.x||H+U<G+P.min.y||H>G+P.max.y};for(let N=0;N<v.length;N++){const F=v[N];for(let B=0;B<l.length;B++){const H=r.getTile(l[B]);if(!H||!H.hasData()||O(F,H.tileID))continue;const U=this._createProxiedId(F,H,p[F.key]&&p[F.key][r.id]),q=this.proxyToSource[F.key][r.id];q?q.push(U):this.proxyToSource[F.key][r.id]=[U],y.push(U)}}}_createProxiedId(r,l,p){let y=this.orthoMatrix;if(p){const v=p.find(b=>b.key===l.tileID.key);if(v)return v}if(l.tileID.key!==r.key){const v=r.canonical.z-l.tileID.canonical.z;let b,D,C;y=u.bz();const P=l.tileID.wrap-r.wrap<<r.overscaledZ;v>0?(b=u.aj>>v,D=b*((l.tileID.canonical.x<<v)-r.canonical.x+P),C=b*((l.tileID.canonical.y<<v)-r.canonical.y)):(b=u.aj<<-v,D=u.aj*(l.tileID.canonical.x-(r.canonical.x+P<<-v)),C=u.aj*(l.tileID.canonical.y-(r.canonical.y<<-v))),u.ca(y,0,b,0,b,0,1),u.bo(y,y,[D,C,0])}return new oh(l.tileID,r.key,y)}_findTileCoveringTileID(r,l){let p=l.getTile(r);if(p&&p.hasData())return p;const y=this._findCoveringTileCache[l.id],v=y[r.key];if(p=v?l.getTileByID(v):null,p&&p.hasData()||null===v)return p;let b=p?p.tileID:r,D=b.overscaledZ;const C=l.getSource().minzoom,P=[];if(!v){const N=l.getSource().maxzoom;if(r.canonical.z>=N){const F=r.canonical.z-N;l.getSource().reparseOverscaled?(D=Math.max(r.canonical.z+2,l.transform.tileZoom),b=new u.aM(D,r.wrap,N,r.canonical.x>>F,r.canonical.y>>F)):0!==F&&(D=N,b=new u.aM(D,r.wrap,N,r.canonical.x>>F,r.canonical.y>>F))}b.key!==r.key&&(P.push(b.key),p=l.getTile(b))}const O=N=>{P.forEach(F=>{y[F]=N}),P.length=0};for(D-=1;D>=C&&(!p||!p.hasData());D--){p&&O(p.tileID.key);const N=b.calculateScaledKey(D);if(p=l.getTileByID(N),p&&p.hasData())break;const F=y[N];if(null===F)break;void 0===F?P.push(N):p=l.getTileByID(F)}return O(p?p.tileID.key:null),p&&p.hasData()?p:null}findDEMTileFor(r){return this.enabled?this._findTileCoveringTileID(r,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(r,l){let p=this._tilesDirty[r];p||(p=this._tilesDirty[r]={}),p[l.key]=!0}}function n_(f,r,l){const p=function(D,C,P){const O=u.bG(C,D),N=u.bG(P,[.2126,.7152,.0722]),F=(H,U,q)=>(1-q)*H+q*U,B=F(1-.3*Math.min(N,1),1,Math.min(O+1,1));return F(.92,1,Math.asin(u.ay(C[2],-1,1))/Math.PI+.5)*B}(f,[0,0,1],r),y=[0,0,0];u.c1(y,l.slice(0,3),p);const v=[0,0,0];u.c1(v,r.slice(0,3),f[2]);const b=[0,0,0];return u.d5(b,y,v),u.d8(b)}const i_=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],am=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class lm{static cacheKey(r,l,p,y){let v=`${l}${y?y.cacheKey:""}`;for(const b of p)r.usedDefines.includes(b)&&(v+=`/${b}`);return v}constructor(r,l,p,y,v,b){const D=r.gl;this.program=D.createProgram(),this.configuration=y,this.name=l,this.fixedDefines=[...b];const C=y?y.getBinderAttributes():[],P=(p.staticAttributes||[]).concat(C);let O=y?y.defines():[];O=O.concat(b.map(q=>`#define ${q}`));const N="#version 300 es\n";let F=N+O.concat("precision mediump float;",Dn,th.fragmentSource).join("\n");for(const q of p.fragmentIncludes)F+=`\n${_r[q]}`;F+=`\n${p.fragmentSource}`;let B=N+O.concat("precision highp float;",Dn,th.vertexSource).join("\n");for(const q of p.vertexIncludes)B+=`\n${_r[q]}`;this.forceManualRenderingForInstanceIDShaders=r.forceManualRenderingForInstanceIDShaders&&-1!==p.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(B+="\nuniform int u_instanceID;\n"),B+=`\n${p.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(B=B.replaceAll("gl_InstanceID","u_instanceID"));const H=D.createShader(D.FRAGMENT_SHADER);if(D.isContextLost())return void(this.failedToCreate=!0);D.shaderSource(H,F),D.compileShader(H),D.attachShader(this.program,H);const U=D.createShader(D.VERTEX_SHADER);if(D.isContextLost())this.failedToCreate=!0;else{D.shaderSource(U,B),D.compileShader(U),D.attachShader(this.program,U),this.attributes={},this.numAttributes=P.length;for(let q=0;q<this.numAttributes;q++)if(P[q]){const G=P[q].startsWith("a_")?P[q]:`a_${P[q]}`;D.bindAttribLocation(this.program,q,G),this.attributes[G]=q}D.linkProgram(this.program),D.deleteShader(U),D.deleteShader(H),this.fixedUniforms=v(r),this.binderUniforms=y?y.getUniforms(r):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms={u_instanceID:new u.cd(r)}),(b.includes("TERRAIN")||-1!==l.indexOf("symbol")||-1!==l.indexOf("circle"))&&(this.terrainUniforms={u_dem:new u.cd(q=r),u_dem_prev:new u.cd(q),u_dem_tl:new u.cg(q),u_dem_scale:new u.cf(q),u_dem_tl_prev:new u.cg(q),u_dem_scale_prev:new u.cf(q),u_dem_size:new u.cf(q),u_dem_lerp:new u.cf(q),u_exaggeration:new u.cf(q),u_depth:new u.cd(q),u_depth_size_inv:new u.cg(q),u_depth_range_unpack:new u.cg(q),u_occluder_half_size:new u.cf(q),u_occlusion_depth_offset:new u.cf(q),u_meter_to_dem:new u.cf(q),u_label_plane_matrix_inv:new u.ch(q)}),b.includes("GLOBE")&&(this.globeUniforms=(q=>({u_tile_tl_up:new u.ce(q),u_tile_tr_up:new u.ce(q),u_tile_br_up:new u.ce(q),u_tile_bl_up:new u.ce(q),u_tile_up_scale:new u.cf(q)}))(r)),b.includes("FOG")&&(this.fogUniforms=(q=>({u_fog_matrix:new u.ch(q),u_fog_range:new u.cg(q),u_fog_color:new u.d0(q),u_fog_horizon_blend:new u.cf(q),u_fog_vertical_limit:new u.cg(q),u_fog_temporal_offset:new u.cf(q),u_frustum_tl:new u.ce(q),u_frustum_tr:new u.ce(q),u_frustum_br:new u.ce(q),u_frustum_bl:new u.ce(q),u_globe_pos:new u.ce(q),u_globe_radius:new u.cf(q),u_globe_transition:new u.cf(q),u_is_globe:new u.cd(q),u_viewport:new u.cg(q)}))(r)),b.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(q=>({u_cutoff_params:new u.d0(q)}))(r)),b.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(q=>({u_lighting_ambient_color:new u.ce(q),u_lighting_directional_dir:new u.ce(q),u_lighting_directional_color:new u.ce(q),u_ground_radiance:new u.ce(q)}))(r)),b.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(q=>({u_light_matrix_0:new u.ch(q),u_light_matrix_1:new u.ch(q),u_fade_range:new u.cg(q),u_shadow_normal_offset:new u.ce(q),u_shadow_intensity:new u.cf(q),u_shadow_texel_size:new u.cf(q),u_shadow_map_resolution:new u.cf(q),u_shadow_direction:new u.ce(q),u_shadow_bias:new u.ce(q),u_shadowmap_0:new u.cd(q),u_shadowmap_1:new u.cd(q)}))(r))}var q}setTerrainUniformValues(r,l){if(!this.terrainUniforms)return;const p=this.terrainUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const y in l)p[y]&&p[y].set(this.program,y,l[y])}}setGlobeUniformValues(r,l){if(!this.globeUniforms)return;const p=this.globeUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const y in l)p[y]&&p[y].set(this.program,y,l[y])}}setFogUniformValues(r,l){if(!this.fogUniforms)return;const p=this.fogUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const y in l)p[y].set(this.program,y,l[y])}}setCutoffUniformValues(r,l){if(!this.cutoffUniforms)return;const p=this.cutoffUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const y in l)p[y].set(this.program,y,l[y])}}setLightsUniformValues(r,l){if(!this.lightsUniforms)return;const p=this.lightsUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const y in l)p[y].set(this.program,y,l[y])}}setShadowUniformValues(r,l){if(this.failedToCreate||!this.shadowUniforms)return;const p=this.shadowUniforms;r.program.set(this.program);for(const y in l)p[y].set(this.program,y,l[y])}_drawDebugWireframe(r,l,p,y,v,b,D,C,P,O){const N=r.options.wireframe;if(!1===N.terrain&&!1===N.layers2D&&!1===N.layers3D)return;const F=r.context;if(!(()=>!(!N.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!N.layers2D||r._terrain&&r._terrain.renderingToTexture||!i_.includes(this.name))||!(!N.layers3D||!am.includes(this.name)))())return;const B=F.gl,H=r.wireframeDebugCache.getLinesFromTrianglesBuffer(r.frameCounter,v,F);if(!H)return;const U=[...this.fixedDefines];U.push("DEBUG_WIREFRAME");const q=r.getOrCreateProgram(this.name,{config:this.configuration,defines:U});F.program.set(q.program);const G=(ne,le,de)=>{if(le[ne]&&de[ne])for(const pe in le[ne])de[ne][pe]&&de[ne][pe].set(de.program,pe,le[ne][pe].current)};P&&P.setUniforms(q.program,F,q.binderUniforms,D,{zoom:C}),G("fixedUniforms",this,q),G("terrainUniforms",this,q),G("globeUniforms",this,q),G("fogUniforms",this,q),G("lightsUniforms",this,q),G("shadowUniforms",this,q),H.bind(),F.setColorMode(new an([B.ONE,B.ONE_MINUS_SRC_ALPHA,B.ZERO,B.ONE],u.am.transparent,[!0,!0,!0,!1])),F.setDepthMode(new bt(l.func===B.LESS?B.LEQUAL:l.func,bt.ReadOnly,l.range)),F.setStencilMode(Vt.disabled);const Y=3*b.primitiveLength*2,ee=3*b.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const ne=O||1;for(let le=0;le<ne;++le)q.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",le),B.drawElements(B.LINES,Y,B.UNSIGNED_SHORT,ee)}else O&&O>1?B.drawElementsInstanced(B.LINES,Y,B.UNSIGNED_SHORT,ee,O):B.drawElements(B.LINES,Y,B.UNSIGNED_SHORT,ee);v.bind(),F.program.set(this.program),F.setDepthMode(l),F.setStencilMode(p),F.setColorMode(y)}checkUniforms(r,l,p){if(this.fixedDefines.includes(l))for(const y of Object.keys(p))if(!p[y].initialized)throw new Error(`Program '${this.name}', from draw '${r}': uniform ${y} not set but required by ${l} being defined`)}draw(r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q){const G=r.context,Y=G.gl;if(this.failedToCreate)return;G.program.set(this.program),G.setDepthMode(p),G.setStencilMode(y),G.setColorMode(v),G.setCullFace(b);for(const le of Object.keys(this.fixedUniforms))this.fixedUniforms[le].set(this.program,le,D[le]);H&&H.setUniforms(this.program,G,this.binderUniforms,F,{zoom:B});const ee={[Y.POINTS]:1,[Y.LINES]:2,[Y.TRIANGLES]:3,[Y.LINE_STRIP]:1}[l];this.checkUniforms(C,"RENDER_SHADOWS",this.shadowUniforms);const ne=q&&q>0?1:void 0;for(const le of N.get()){const de=le.vaos||(le.vaos={});if((de[C]||(de[C]=new os)).bind(G,this,P,H?H.getPaintVertexBuffers():[],O,le.vertexOffset,U||[],ne),this.forceManualRenderingForInstanceIDShaders){const pe=q||1;for(let ae=0;ae<pe;++ae)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ae),O?Y.drawElements(l,le.primitiveLength*ee,Y.UNSIGNED_SHORT,le.primitiveOffset*ee*2):Y.drawArrays(l,le.vertexOffset,le.vertexLength)}else q&&q>1?Y.drawElementsInstanced(l,le.primitiveLength*ee,Y.UNSIGNED_SHORT,le.primitiveOffset*ee*2,q):O?Y.drawElements(l,le.primitiveLength*ee,Y.UNSIGNED_SHORT,le.primitiveOffset*ee*2):Y.drawArrays(l,le.vertexOffset,le.vertexLength);l===Y.TRIANGLES&&O&&this._drawDebugWireframe(r,p,y,v,O,le,F,B,H,q)}}}function cm(f,r,l=0){const p=Math.pow(2,r.tileID.overscaledZ),y=r.tileSize*Math.pow(2,f.transform.tileZoom)/p,v=y*(r.tileID.canonical.x+r.tileID.wrap*p),b=y*r.tileID.canonical.y;return{u_image:0,u_texsize:r.imageAtlasTexture?r.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/u.aw(r,1,f.transform.tileZoom),u_pixel_coord_upper:[v>>16,b>>16],u_pixel_coord_lower:[65535&v,65535&b],u_pattern_transition:l}}const Wu={terrain:0,flat:1},r_=u.bz(),o_=(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q,G)=>{const Y=r.style.light,ee=Y.properties.get("position"),ne=[ee.x,ee.y,ee.z],le=u.dJ();"viewport"===Y.properties.get("anchor")&&(u.dK(le,-r.transform.angle),u.dL(ne,ne,le));const de=Y.properties.get("color").toPremultipliedRenderColor(null),pe=r.transform,ae={u_matrix:f,u_lightpos:ne,u_lightintensity:Y.properties.get("intensity"),u_lightcolor:[de.r,de.g,de.b],u_vertical_gradient:+l,u_opacity:p,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:r_,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Wu[P],u_base_type:Wu[O],u_ao:y,u_edge_radius:v,u_width_scale:b,u_flood_light_color:H,u_vertical_scale:U,u_flood_light_intensity:q,u_ground_shadow_factor:G};return"globe"===pe.projection.name&&(ae.u_tile_id=[D.canonical.x,D.canonical.y,1<<D.canonical.z],ae.u_zoom_transition=N,ae.u_inv_rot_matrix=B,ae.u_merc_center=F,ae.u_up_dir=pe.projection.upVector(new u.cA(0,0,0),F[0]*u.aj,F[1]*u.aj),ae.u_height_lift=C),ae},Ev=(f,r,l,p,y,v)=>({u_matrix:f,u_edge_radius:r,u_width_scale:l,u_vertical_scale:p,u_height_type:Wu[y],u_base_type:Wu[v]}),sh=(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q,G)=>{const Y=o_(f,r,l,p,y,v,b,D,P,O,N,F,B,H,U,q,1,[0,0,0]),ee={u_height_factor:-Math.pow(2,D.overscaledZ)/C.tileSize/8};return u.h(Y,cm(r,C,G),ee)},Tv=(f,r,l)=>({u_matrix:f,u_emissive_strength:r,u_ground_shadow_factor:l}),Dv=(f,r,l,p,y,v=0)=>u.h(Tv(f,r,y),cm(l,p,v)),s_=(f,r,l,p)=>({u_matrix:f,u_world:l,u_emissive_strength:r,u_ground_shadow_factor:p}),a_=(f,r,l,p,y,v,b=0)=>u.h(Dv(f,r,l,p,v,b),{u_world:y}),Kx=(f,r)=>({u_matrix:f,u_ground_shadow_factor:r}),um=(f,r,l,p,y)=>({u_matrix:f,u_camera_pos:[r[0],r[1],r[2]],u_depth_bias:l,u_height_scale:p,u_reset_depth:y}),l_=(f,r)=>({u_matrix:f,u_normal_matrix:r,u_opacity:1}),al=f=>({u_matrix:f}),ll=f=>({u_matrix:f}),ah=(f,r,l,p,y,v,b,D)=>{const C=u.aj/v.tileSize;return{u_matrix:f,u_inv_rot_matrix:r,u_camera_to_center_distance:l.getCameraToCenterDistance(D),u_extrude_scale:[l.pixelsToGLUnits[0]/C,l.pixelsToGLUnits[1]/C],u_zoom_transition:p,u_tile_id:b,u_merc_center:y}},c_=(f,r,l=1)=>({u_matrix:f,u_color:r,u_overlay:0,u_overlay_scale:l}),Eo=u.bz(),lh=(f,r,l,p,y,v,b)=>{const D=f.transform,C="globe"===D.projection.name,P=C?u.dM(D.zoom,r.canonical)*D._pixelsPerMercatorPixel:u.aw(l,1,v),O={u_matrix:r.projMatrix,u_extrude_scale:P,u_intensity:b,u_inv_rot_matrix:Eo,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(C){O.u_inv_rot_matrix=p,O.u_merc_center=y,O.u_tile_id=[r.canonical.x,r.canonical.y,1<<r.canonical.z],O.u_zoom_transition=u.ah(D.zoom);const N=y[0]*u.aj,F=y[1]*u.aj;O.u_up_dir=D.projection.upVector(new u.cA(0,0,0),N,F)}return O};function cs(f,[r,l,p,y],[v,b]){if(v===b)return[0,0,0,0];const D=255*(f-1)/(f*(b-v));return[r*D,l*D,p*D,y*D]}function cl(f,r,[l,p]){return l===p?0:.5/f+(r-l)*(f-1)/(f*(p-l))}const Mf=(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q,G,Y,ee,ne)=>({u_matrix:f,u_normalize_matrix:r,u_globe_matrix:l,u_merc_matrix:p,u_grid_matrix:y,u_tl_parent:v,u_scale_parent:P,u_fade_t:O.mix,u_opacity:O.opacity*N.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:N.paint.get("raster-brightness-min"),u_brightness_high:N.paint.get("raster-brightness-max"),u_saturation_factor:u.dO(N.paint.get("raster-saturation")),u_contrast_factor:u.dN(N.paint.get("raster-contrast")),u_spin_weights:ul(N.paint.get("raster-hue-rotate")),u_perspective_transform:F,u_raster_elevation:B,u_zoom_transition:b,u_merc_center:D,u_cutoff_params:C,u_colorization_mix:cs(u.dP,U,G),u_colorization_offset:cl(u.dP,q,G),u_color_ramp:H,u_texture_offset:[ee/(Y+2*ee),Y/(Y+2*ee)],u_texture_res:[Y+2*ee,Y+2*ee],u_emissive_strength:ne});function ul(f){f*=Math.PI/180;const r=Math.sin(f),l=Math.cos(f);return[(2*l+1)/3,(-Math.sqrt(3)*r-l+1)/3,(Math.sqrt(3)*r-l+1)/3]}const dl=.05,Zu=(f,r,l,p,y,v,b,D,C,P,O,N)=>({u_matrix:f,u_normalize_matrix:r,u_globe_matrix:l,u_merc_matrix:p,u_grid_matrix:y,u_tl_parent:v,u_scale_parent:P,u_fade_t:O.mix,u_opacity:O.opacity,u_image0:0,u_image1:1,u_raster_elevation:N,u_zoom_transition:b,u_merc_center:D,u_cutoff_params:C}),dm=(f,r,l,p,y,v,b,D,C,P)=>({u_particle_texture:f,u_particle_texture_side_len:r,u_tile_offset:l,u_velocity:p,u_color_ramp:v,u_velocity_res:y,u_max_speed:b,u_uv_offset:D,u_data_scale:[255*C[0],255*C[1]],u_data_offset:P,u_particle_pos_scale:1.1,u_particle_pos_offset:[dl,dl]}),Pf=(f,r,l,p,y,v,b,D,C,P)=>({u_particle_texture:f,u_particle_texture_side_len:r,u_velocity:l,u_velocity_res:p,u_max_speed:y,u_speed_factor:v,u_reset_rate:b,u_rand_seed:Math.random(),u_uv_offset:D,u_data_scale:[255*C[0],255*C[1]],u_data_offset:P,u_particle_pos_scale:1.1,u_particle_pos_offset:[dl,dl]}),Xu=u.bz(),ch=(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q,G,Y,ee,ne,le,de,pe)=>{const ae=y.transform,ce={u_is_size_zoom_constant:+("constant"===f||"source"===f),u_is_size_feature_constant:+("constant"===f||"camera"===f),u_size_t:r?r.uSizeT:0,u_size:r?r.uSize:0,u_camera_to_center_distance:ae.getCameraToCenterDistance(Y),u_rotate_symbol:+l,u_aspect_ratio:ae.width/ae.height,u_fade_change:y.options.fadeDuration?y.symbolFadeChange:1,u_matrix:v,u_label_plane_matrix:b,u_coord_matrix:D,u_is_text:+P,u_elevation_from_sea:C?1:0,u_pitch_with_map:+p,u_texsize:O,u_texsize_icon:N,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Xu,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Xu,u_up_vector:[0,-1,0],u_color_adj_mat:le,u_icon_transition:de||0,u_gamma_scale:p?y.transform.getCameraToCenterDistance(Y)*Math.cos(y.terrain?0:y.transform._pitch):1,u_device_pixel_ratio:u.q.devicePixelRatio,u_is_halo:1,u_scale_factor:pe||1,u_ground_shadow_factor:ee,u_inv_matrix:u.bi(u.bz(),b),u_normal_scale:ne};return"globe"===Y.name&&(ce.u_tile_id=[B.canonical.x,B.canonical.y,1<<B.canonical.z],ce.u_zoom_transition=H,ce.u_inv_rot_matrix=q,ce.u_merc_center=U,ce.u_camera_forward=ae._camera.forward(),ce.u_ecef_origin=u.dQ(ae.globeMatrix,B.toUnwrapped()),ce.u_tile_matrix=Float32Array.from(ae.globeMatrix),ce.u_up_vector=G),ce},hm=(f,r,l,p)=>({u_matrix:f,u_emissive_strength:r,u_opacity:l,u_color:p}),Rf=(f,r,l,p,y,v,b,D,C)=>u.h(function(P,O,N,F,B,H){const{width:U,height:q}=F.imageManager.getPixelSize(O),G=Math.pow(2,H.tileID.overscaledZ),Y=H.tileSize*Math.pow(2,F.transform.tileZoom)/G,ee=Y*(H.tileID.canonical.x+H.tileID.wrap*G),ne=Y*H.tileID.canonical.y;return{u_image:0,u_pattern_tl:N.tl,u_pattern_br:N.br,u_texsize:[U,q],u_pattern_size:N.displaySize,u_pattern_units_to_pixels:B?[F.transform.width,-1*F.transform.height]:[1/u.aw(H,1,F.transform.tileZoom),1/u.aw(H,1,F.transform.tileZoom)],u_pixel_coord_upper:[ee>>16,ne>>16],u_pixel_coord_lower:[65535&ee,65535&ne]}}(0,v,b,p,D,C),{u_matrix:f,u_emissive_strength:r,u_opacity:l}),Na=new Float32Array(u.bx([])),$c=(f,r,l,p,y,v,b,D,C,P,O,N,F,B=[0,0,0],H)=>{const U=y.style.light,q=U.properties.get("position"),G=[-q.x,-q.y,q.z],Y=u.dJ();"viewport"===U.properties.get("anchor")&&(u.dK(Y,-y.transform.angle),u.dL(G,G,Y));const ee="MASK"===O.alphaMode,ne=U.properties.get("color").toNonPremultipliedRenderColor(null),le=F.paint.get("model-ambient-occlusion-intensity"),de=F.paint.get("model-color").constantOr(u.am.white).toNonPremultipliedRenderColor(null);return de.a=F.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:f,u_lighting_matrix:r,u_normal_matrix:l,u_node_matrix:p||Na,u_lightpos:G,u_lightintensity:U.properties.get("intensity"),u_lightcolor:[ne.r,ne.g,ne.b],u_camera_pos:B,u_opacity:v,u_baseTextureIsAlpha:0,u_alphaMask:+ee,u_alphaCutoff:O.alphaCutoff,u_baseColorFactor:b.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:D.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:C,u_roughnessFactor:P,u_baseColorTexture:Qr.BaseColor,u_metallicRoughnessTexture:Qr.MetallicRoughness,u_normalTexture:Qr.Normal,u_occlusionTexture:Qr.Occlusion,u_emissionTexture:Qr.Emission,u_lutTexture:Qr.LUT,u_color_mix:de.toArray01(),u_aoIntensity:le,u_emissive_strength:N,u_occlusionTextureTransform:H||[0,0,0,0]}},qc=(f,r=Na,l=Na)=>({u_matrix:f,u_instance:r,u_node_matrix:l}),fm={fillExtrusion:f=>({u_matrix:new u.ch(f),u_lightpos:new u.ce(f),u_lightintensity:new u.cf(f),u_lightcolor:new u.ce(f),u_vertical_gradient:new u.cf(f),u_opacity:new u.cf(f),u_edge_radius:new u.cf(f),u_width_scale:new u.cf(f),u_ao:new u.cg(f),u_height_type:new u.cd(f),u_base_type:new u.cd(f),u_tile_id:new u.ce(f),u_zoom_transition:new u.cf(f),u_inv_rot_matrix:new u.ch(f),u_merc_center:new u.cg(f),u_up_dir:new u.ce(f),u_height_lift:new u.cf(f),u_flood_light_color:new u.ce(f),u_vertical_scale:new u.cf(f),u_flood_light_intensity:new u.cf(f),u_ground_shadow_factor:new u.ce(f)}),fillExtrusionDepth:f=>({u_matrix:new u.ch(f),u_edge_radius:new u.cf(f),u_width_scale:new u.cf(f),u_vertical_scale:new u.cf(f),u_height_type:new u.cd(f),u_base_type:new u.cd(f)}),fillExtrusionPattern:f=>({u_matrix:new u.ch(f),u_lightpos:new u.ce(f),u_lightintensity:new u.cf(f),u_lightcolor:new u.ce(f),u_vertical_gradient:new u.cf(f),u_height_factor:new u.cf(f),u_edge_radius:new u.cf(f),u_width_scale:new u.cf(f),u_ao:new u.cg(f),u_height_type:new u.cd(f),u_base_type:new u.cd(f),u_tile_id:new u.ce(f),u_zoom_transition:new u.cf(f),u_inv_rot_matrix:new u.ch(f),u_merc_center:new u.cg(f),u_up_dir:new u.ce(f),u_height_lift:new u.cf(f),u_image:new u.cd(f),u_texsize:new u.cg(f),u_pixel_coord_upper:new u.cg(f),u_pixel_coord_lower:new u.cg(f),u_tile_units_to_pixels:new u.cf(f),u_opacity:new u.cf(f),u_pattern_transition:new u.cf(f)}),fillExtrusionGroundEffect:f=>({u_matrix:new u.ch(f),u_opacity:new u.cf(f),u_ao_pass:new u.cf(f),u_meter_to_tile:new u.cf(f),u_ao:new u.cg(f),u_flood_light_intensity:new u.cf(f),u_flood_light_color:new u.ce(f),u_attenuation:new u.cf(f),u_edge_radius:new u.cf(f),u_fb:new u.cd(f),u_fb_size:new u.cf(f),u_dynamic_offset:new u.cf(f)}),fill:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_ground_shadow_factor:new u.ce(f)}),fillPattern:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_image:new u.cd(f),u_texsize:new u.cg(f),u_pixel_coord_upper:new u.cg(f),u_pixel_coord_lower:new u.cg(f),u_tile_units_to_pixels:new u.cf(f),u_ground_shadow_factor:new u.ce(f),u_pattern_transition:new u.cf(f)}),fillOutline:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_world:new u.cg(f),u_ground_shadow_factor:new u.ce(f)}),fillOutlinePattern:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_world:new u.cg(f),u_image:new u.cd(f),u_texsize:new u.cg(f),u_pixel_coord_upper:new u.cg(f),u_pixel_coord_lower:new u.cg(f),u_tile_units_to_pixels:new u.cf(f),u_ground_shadow_factor:new u.ce(f),u_pattern_transition:new u.cf(f)}),building:f=>({u_matrix:new u.ch(f),u_normal_matrix:new u.ch(f),u_opacity:new u.cf(f)}),buildingBloom:f=>({u_matrix:new u.ch(f)}),buildingDepth:f=>({u_matrix:new u.ch(f)}),elevatedStructuresDepth:f=>({u_matrix:new u.ch(f),u_depth_bias:new u.cf(f)}),elevatedStructures:f=>({u_matrix:new u.ch(f),u_ground_shadow_factor:new u.ce(f)}),elevatedStructuresDepthReconstruct:f=>({u_matrix:new u.ch(f),u_camera_pos:new u.ce(f),u_depth_bias:new u.cf(f),u_height_scale:new u.cf(f),u_reset_depth:new u.cf(f)}),circle:u.dT,collisionBox:f=>({u_matrix:new u.ch(f),u_inv_rot_matrix:new u.ch(f),u_camera_to_center_distance:new u.cf(f),u_extrude_scale:new u.cg(f),u_zoom_transition:new u.cf(f),u_merc_center:new u.cg(f),u_tile_id:new u.ce(f)}),collisionCircle:f=>({u_matrix:new u.ch(f),u_inv_matrix:new u.ch(f),u_camera_to_center_distance:new u.cf(f),u_viewport_size:new u.cg(f)}),debug:f=>({u_color:new u.dv(f),u_matrix:new u.ch(f),u_overlay:new u.cd(f),u_overlay_scale:new u.cf(f)}),clippingMask:f=>({u_matrix:new u.ch(f)}),heatmap:f=>({u_extrude_scale:new u.cf(f),u_intensity:new u.cf(f),u_matrix:new u.ch(f),u_inv_rot_matrix:new u.ch(f),u_merc_center:new u.cg(f),u_tile_id:new u.ce(f),u_zoom_transition:new u.cf(f),u_up_dir:new u.ce(f)}),heatmapTexture:f=>({u_image:new u.cd(f),u_color_ramp:new u.cd(f),u_opacity:new u.cf(f)}),hillshade:f=>({u_matrix:new u.ch(f),u_image:new u.cd(f),u_latrange:new u.cg(f),u_light:new u.cg(f),u_shadow:new u.dv(f),u_highlight:new u.dv(f),u_emissive_strength:new u.cf(f),u_accent:new u.dv(f)}),hillshadePrepare:f=>({u_matrix:new u.ch(f),u_image:new u.cd(f),u_dimension:new u.cg(f),u_zoom:new u.cf(f)}),line:u.dS,linePattern:u.dR,raster:f=>({u_matrix:new u.ch(f),u_normalize_matrix:new u.ch(f),u_globe_matrix:new u.ch(f),u_merc_matrix:new u.ch(f),u_grid_matrix:new u.dw(f),u_tl_parent:new u.cg(f),u_scale_parent:new u.cf(f),u_fade_t:new u.cf(f),u_opacity:new u.cf(f),u_image0:new u.cd(f),u_image1:new u.cd(f),u_brightness_low:new u.cf(f),u_brightness_high:new u.cf(f),u_saturation_factor:new u.cf(f),u_contrast_factor:new u.cf(f),u_spin_weights:new u.ce(f),u_perspective_transform:new u.cg(f),u_raster_elevation:new u.cf(f),u_zoom_transition:new u.cf(f),u_merc_center:new u.cg(f),u_cutoff_params:new u.d0(f),u_colorization_mix:new u.d0(f),u_colorization_offset:new u.cf(f),u_color_ramp:new u.cd(f),u_texture_offset:new u.cg(f),u_texture_res:new u.cg(f),u_emissive_strength:new u.cf(f)}),rasterParticle:f=>({u_matrix:new u.ch(f),u_normalize_matrix:new u.ch(f),u_globe_matrix:new u.ch(f),u_merc_matrix:new u.ch(f),u_grid_matrix:new u.dw(f),u_tl_parent:new u.cg(f),u_scale_parent:new u.cf(f),u_fade_t:new u.cf(f),u_opacity:new u.cf(f),u_image0:new u.cd(f),u_image1:new u.cd(f),u_raster_elevation:new u.cf(f),u_zoom_transition:new u.cf(f),u_merc_center:new u.cg(f),u_cutoff_params:new u.d0(f)}),rasterParticleTexture:f=>({u_texture:new u.cd(f),u_opacity:new u.cf(f)}),rasterParticleDraw:f=>({u_particle_texture:new u.cd(f),u_particle_texture_side_len:new u.cf(f),u_tile_offset:new u.cg(f),u_velocity:new u.cd(f),u_color_ramp:new u.cd(f),u_velocity_res:new u.cg(f),u_max_speed:new u.cf(f),u_uv_offset:new u.cg(f),u_data_scale:new u.cg(f),u_data_offset:new u.cf(f),u_particle_pos_scale:new u.cf(f),u_particle_pos_offset:new u.cg(f)}),rasterParticleUpdate:f=>({u_particle_texture:new u.cd(f),u_particle_texture_side_len:new u.cf(f),u_velocity:new u.cd(f),u_velocity_res:new u.cg(f),u_max_speed:new u.cf(f),u_speed_factor:new u.cf(f),u_reset_rate:new u.cf(f),u_rand_seed:new u.cf(f),u_uv_offset:new u.cg(f),u_data_scale:new u.cg(f),u_data_offset:new u.cf(f),u_particle_pos_scale:new u.cf(f),u_particle_pos_offset:new u.cg(f)}),symbol:f=>({u_is_size_zoom_constant:new u.cd(f),u_is_size_feature_constant:new u.cd(f),u_size_t:new u.cf(f),u_size:new u.cf(f),u_camera_to_center_distance:new u.cf(f),u_rotate_symbol:new u.cd(f),u_aspect_ratio:new u.cf(f),u_fade_change:new u.cf(f),u_matrix:new u.ch(f),u_label_plane_matrix:new u.ch(f),u_coord_matrix:new u.ch(f),u_is_text:new u.cd(f),u_elevation_from_sea:new u.cd(f),u_pitch_with_map:new u.cd(f),u_texsize:new u.cg(f),u_texsize_icon:new u.cg(f),u_texture:new u.cd(f),u_texture_icon:new u.cd(f),u_gamma_scale:new u.cf(f),u_device_pixel_ratio:new u.cf(f),u_tile_id:new u.ce(f),u_zoom_transition:new u.cf(f),u_inv_rot_matrix:new u.ch(f),u_merc_center:new u.cg(f),u_camera_forward:new u.ce(f),u_tile_matrix:new u.ch(f),u_up_vector:new u.ce(f),u_ecef_origin:new u.ce(f),u_is_halo:new u.cd(f),u_icon_transition:new u.cf(f),u_color_adj_mat:new u.ch(f),u_scale_factor:new u.cf(f),u_ground_shadow_factor:new u.ce(f),u_inv_matrix:new u.ch(f),u_normal_scale:new u.cf(f)}),background:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_opacity:new u.cf(f),u_color:new u.dv(f)}),backgroundPattern:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_opacity:new u.cf(f),u_image:new u.cd(f),u_pattern_tl:new u.cg(f),u_pattern_br:new u.cg(f),u_texsize:new u.cg(f),u_pattern_size:new u.cg(f),u_pixel_coord_upper:new u.cg(f),u_pixel_coord_lower:new u.cg(f),u_pattern_units_to_pixels:new u.cg(f)}),terrainRaster:f=>({u_matrix:new u.ch(f),u_image0:new u.cd(f),u_skirt_height:new u.cf(f),u_ground_shadow_factor:new u.ce(f)}),skybox:f=>({u_matrix:new u.ch(f),u_sun_direction:new u.ce(f),u_cubemap:new u.cd(f),u_opacity:new u.cf(f),u_temporal_offset:new u.cf(f)}),skyboxGradient:f=>({u_matrix:new u.ch(f),u_color_ramp:new u.cd(f),u_center_direction:new u.ce(f),u_radius:new u.cf(f),u_opacity:new u.cf(f),u_temporal_offset:new u.cf(f)}),skyboxCapture:f=>({u_matrix_3f:new u.dw(f),u_sun_direction:new u.ce(f),u_sun_intensity:new u.cf(f),u_color_tint_r:new u.d0(f),u_color_tint_m:new u.d0(f),u_luminance:new u.cf(f)}),globeRaster:f=>({u_proj_matrix:new u.ch(f),u_globe_matrix:new u.ch(f),u_normalize_matrix:new u.ch(f),u_merc_matrix:new u.ch(f),u_zoom_transition:new u.cf(f),u_merc_center:new u.cg(f),u_image0:new u.cd(f),u_grid_matrix:new u.dw(f),u_skirt_height:new u.cf(f),u_far_z_cutoff:new u.cf(f),u_frustum_tl:new u.ce(f),u_frustum_tr:new u.ce(f),u_frustum_br:new u.ce(f),u_frustum_bl:new u.ce(f),u_globe_pos:new u.ce(f),u_globe_radius:new u.cf(f),u_viewport:new u.cg(f)}),globeAtmosphere:f=>({u_frustum_tl:new u.ce(f),u_frustum_tr:new u.ce(f),u_frustum_br:new u.ce(f),u_frustum_bl:new u.ce(f),u_horizon:new u.cf(f),u_transition:new u.cf(f),u_fadeout_range:new u.cf(f),u_color:new u.d0(f),u_high_color:new u.d0(f),u_space_color:new u.d0(f),u_temporal_offset:new u.cf(f),u_horizon_angle:new u.cf(f)}),model:f=>({u_matrix:new u.ch(f),u_lighting_matrix:new u.ch(f),u_normal_matrix:new u.ch(f),u_node_matrix:new u.ch(f),u_lightpos:new u.ce(f),u_lightintensity:new u.cf(f),u_lightcolor:new u.ce(f),u_camera_pos:new u.ce(f),u_opacity:new u.cf(f),u_baseColorFactor:new u.d0(f),u_emissiveFactor:new u.d0(f),u_metallicFactor:new u.cf(f),u_roughnessFactor:new u.cf(f),u_baseTextureIsAlpha:new u.cd(f),u_alphaMask:new u.cd(f),u_alphaCutoff:new u.cf(f),u_baseColorTexture:new u.cd(f),u_metallicRoughnessTexture:new u.cd(f),u_normalTexture:new u.cd(f),u_occlusionTexture:new u.cd(f),u_emissionTexture:new u.cd(f),u_lutTexture:new u.cd(f),u_color_mix:new u.d0(f),u_aoIntensity:new u.cf(f),u_emissive_strength:new u.cf(f),u_occlusionTextureTransform:new u.d0(f)}),modelDepth:f=>({u_matrix:new u.ch(f),u_instance:new u.ch(f),u_node_matrix:new u.ch(f)}),groundShadow:f=>({u_matrix:new u.ch(f),u_ground_shadow_factor:new u.ce(f)}),stars:f=>({u_matrix:new u.ch(f),u_up:new u.ce(f),u_right:new u.ce(f),u_intensity_multiplier:new u.cf(f)}),snowParticle:f=>({u_modelview:new u.ch(f),u_projection:new u.ch(f),u_time:new u.cf(f),u_cam_pos:new u.ce(f),u_velocityConeAperture:new u.cf(f),u_velocity:new u.cf(f),u_horizontalOscillationRadius:new u.cf(f),u_horizontalOscillationRate:new u.cf(f),u_boxSize:new u.cf(f),u_billboardSize:new u.cf(f),u_simpleShapeParameters:new u.cg(f),u_screenSize:new u.cg(f),u_thinningCenterPos:new u.cg(f),u_thinningShape:new u.ce(f),u_thinningAffectedRatio:new u.cf(f),u_thinningParticleOffset:new u.cf(f),u_particleColor:new u.d0(f),u_direction:new u.ce(f)}),rainParticle:f=>({u_modelview:new u.ch(f),u_projection:new u.ch(f),u_time:new u.cf(f),u_cam_pos:new u.ce(f),u_texScreen:new u.cd(f),u_velocityConeAperture:new u.cf(f),u_velocity:new u.cf(f),u_boxSize:new u.cf(f),u_rainDropletSize:new u.cg(f),u_distortionStrength:new u.cf(f),u_rainDirection:new u.ce(f),u_color:new u.d0(f),u_screenSize:new u.cg(f),u_thinningCenterPos:new u.cg(f),u_thinningShape:new u.ce(f),u_thinningAffectedRatio:new u.cf(f),u_thinningParticleOffset:new u.cf(f),u_shapeDirectionalPower:new u.cf(f),u_shapeNormalPower:new u.cf(f),u_mode:new u.cf(f)}),vignette:f=>({u_vignetteShape:new u.ce(f),u_vignetteColor:new u.d0(f)}),occlusion:f=>({u_matrix:new u.ch(f),u_anchorPos:new u.ce(f),u_screenSizePx:new u.cg(f),u_occluderSizePx:new u.cg(f),u_color:new u.d0(f)})};let Sv=(()=>{class f{constructor(l,p,y,v){this.id=f.uniqueIdxCounter,f.uniqueIdxCounter++,this.context=l;const b=l.gl;this.buffer=b.createBuffer(),this.dynamicDraw=!!y,this.context.unbindVAO(),l.bindElementBuffer.set(this.buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,p.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||v||p.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(l){this.id=f.uniqueIdxCounter,f.uniqueIdxCounter++;const p=this.context.gl;this.context.unbindVAO(),this.bind(),p.bufferSubData(p.ELEMENT_ARRAY_BUFFER,0,l.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return f.uniqueIdxCounter=0,f})();const u_={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class d_{constructor(r,l,p,y,v,b){this.length=l.length,this.attributes=p,this.itemSize=l.bytesPerElement,this.dynamicDraw=y,this.instanceCount=b,this.context=r;const D=r.gl;this.buffer=D.createBuffer(),r.bindVertexBuffer.set(this.buffer),D.bufferData(D.ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?D.DYNAMIC_DRAW:D.STATIC_DRAW),this.dynamicDraw||v||l.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(r){const l=this.context.gl;this.bind(),l.bufferSubData(l.ARRAY_BUFFER,0,r.arrayBuffer)}enableAttributes(r,l){for(let p=0;p<this.attributes.length;p++){const y=l.attributes[this.attributes[p].name];void 0!==y&&r.enableVertexAttribArray(y)}}setVertexAttribPointers(r,l,p){for(let y=0;y<this.attributes.length;y++){const v=this.attributes[y],b=l.attributes[v.name];void 0!==b&&r.vertexAttribPointer(b,v.components,r[u_[v.type]],!1,this.itemSize,v.offset+this.itemSize*(p||0))}}setVertexAttribDivisor(r,l,p){for(let y=0;y<this.attributes.length;y++){const v=l.attributes[this.attributes[y].name];void 0!==v&&this.instanceCount&&this.instanceCount>0&&r.vertexAttribDivisor(v,p)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Wc{constructor(r,l,p,y,v){this.context=r,this.width=l,this.height=p;const b=this.framebuffer=r.gl.createFramebuffer();y&&(this.colorAttachment=new If(r,b)),v&&(this.depthAttachmentType=v,this.depthAttachment="renderbuffer"===v?new Hc(r,b):new Gc(r,b))}destroy(){const r=this.context.gl;if(this.colorAttachment){const l=this.colorAttachment.get();l&&r.deleteTexture(l)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const l=this.depthAttachment.get();l&&r.deleteRenderbuffer(l)}else{const l=this.depthAttachment.get();l&&r.deleteTexture(l)}r.deleteFramebuffer(this.framebuffer)}}class Of{constructor(r,l){this.gl=r,this.clearColor=new xv(this),this.clearDepth=new bv(this),this.clearStencil=new zr(this),this.colorMask=new Qt(this),this.depthMask=new ei(this),this.stencilMask=new Or(this),this.stencilFunc=new ws(this),this.stencilOp=new nh(this),this.stencilTest=new Ro(this),this.depthRange=new Kl(this),this.depthTest=new Fr(this),this.depthFunc=new ka(this),this.blend=new Qs(this),this.blendFunc=new Fn(this),this.blendColor=new Ql(this),this.blendEquation=new ih(this),this.cullFace=new ga(this),this.cullFaceSide=new Br(this),this.frontFace=new jc(this),this.program=new Uc(this),this.activeTexture=new ss(this),this.viewport=new Jl(this),this.bindFramebuffer=new rh(this),this.bindRenderbuffer=new La(this),this.bindTexture=new Js(this),this.bindVertexBuffer=new rl(this),this.bindElementBuffer=new $u(this),this.bindVertexArrayOES=new xi(this),this.pixelStoreUnpack=new wv(this),this.pixelStoreUnpackPremultiplyAlpha=new ec(this),this.pixelStoreUnpackFlipY=new rm(this),this.options=l?Object.assign({},l):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=r.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=r.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=r.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=r.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=l&&!!l.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=r.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=r.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=r.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this.maxPointSize=r.getParameter(r.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(r,l,p){return new Sv(this,r,l,p)}createVertexBuffer(r,l,p,y,v){return new d_(this,r,l,p,y,v)}createRenderbuffer(r,l,p){const y=this.gl,v=y.createRenderbuffer();return this.bindRenderbuffer.set(v),y.renderbufferStorage(y.RENDERBUFFER,r,l,p),this.bindRenderbuffer.set(null),v}createFramebuffer(r,l,p,y){return new Wc(this,r,l,p,y)}clear({color:r,depth:l,stencil:p,colorMask:y}){const v=this.gl;let b=0;r&&(b|=v.COLOR_BUFFER_BIT,this.clearColor.set(r.toNonPremultipliedRenderColor(null)),this.colorMask.set(y||[!0,!0,!0,!0])),void 0!==l&&(b|=v.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(l),this.depthMask.set(!0)),void 0!==p&&(b|=v.STENCIL_BUFFER_BIT,this.clearStencil.set(p),this.stencilMask.set(255)),v.clear(b)}setCullFace(r){!1===r.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(r.mode),this.frontFace.set(r.frontFace))}setDepthMode(r){r.func!==this.gl.ALWAYS||r.mask?(this.depthTest.set(!0),this.depthFunc.set(r.func),this.depthMask.set(r.mask),this.depthRange.set(r.range)):this.depthTest.set(!1)}setStencilMode(r){r.test.func!==this.gl.ALWAYS||r.mask?(this.stencilTest.set(!0),this.stencilMask.set(r.mask),this.stencilOp.set([r.fail,r.depthFail,r.pass]),this.stencilFunc.set({func:r.test.func,ref:r.ref,mask:r.test.mask})):this.stencilTest.set(!1)}setColorMode(r){u.bv(r.blendFunction,an.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(r.blendFunction),this.blendColor.set(r.blendColor),r.blendEquation?this.blendEquation.set(r.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(r.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Zc;function Ff(f,r,l,p,y,v,b){const D=f.context,C=D.gl,P=f.transform,O=[u.aD(P.center.lng),u.aH(P.center.lat)],N=l.layout.get("symbol-placement"),F=l.layout.get("text-variable-anchor"),B="map"===l.layout.get("icon-rotation-alignment"),H="map"===l.layout.get("text-rotation-alignment"),U="point"!==N,q=[];let G=0,Y=0;for(let ce=0;ce<p.length;ce++){const ue=p[ce],Me=r.getTile(ue),ye=Me.getBucket(l);if(!ye)continue;const je=ye.getProjection().createInversionMatrix(P,ue.canonical),Fe=[],Ge=gv(ue,ye,P),rt=!b&&B&&U,De=b&&H&&U,_e=F&&ye.hasTextData(),Ne=ye.hasIconTextFit()&&_e&&ye.hasIconData(),Re=rt||De||b&&_e||Ne,We="globe"===ye.projection.name,Ze=We?u.ah(P.zoom):0;We&&(Fe.push("PROJECTION_GLOBE_VIEW"),Re&&Fe.push("PROJECTED_POS_ON_VIEWPORT"));const Ye=f.getOrCreateProgram("collisionBox",{defines:Fe});let ct=Ge;0===y[0]&&0===y[1]||(ct=f.translatePosMatrix(Ge,Me,y,v));const Mt=b?ye.textCollisionBox:ye.iconCollisionBox,kt=ye.collisionCircleArray;if(kt.length>0){const Ot=u.bz(),Pt=ct;u.cM(Ot,ye.placementInvProjMatrix,P.glCoordMatrix),u.cM(Ot,Ot,ye.placementViewportMatrix),q.push({circleArray:kt,circleOffset:Y,transform:Pt,invTransform:Ot,projection:ye.getProjection()}),G+=kt.length/4,Y=G}if(!Mt)continue;f.terrain&&f.terrain.setupElevationDraw(Me,Ye);const vt=We?[ue.canonical.x,ue.canonical.y,1<<ue.canonical.z]:[0,0,0];Ye.draw(f,C.LINES,bt.disabled,Vt.disabled,f.colorModeForRenderPass(),Bt.disabled,ah(ct,je,P,Ze,O,Me,vt,ye.getProjection()),l.id,Mt.layoutVertexBuffer,Mt.indexBuffer,Mt.segments,null,P.zoom,null,[Mt.collisionVertexBuffer,Mt.collisionVertexBufferExt])}if(!b||!q.length)return;const ee=f.getOrCreateProgram("collisionCircle"),ne=new u.dU;ne.resize(4*G),ne._trim();let le=0;for(const ce of q)for(let ue=0;ue<ce.circleArray.length/4;ue++){const Me=4*ue,ye=ce.circleArray[Me+0],je=ce.circleArray[Me+1],Fe=ce.circleArray[Me+2],Ge=ce.circleArray[Me+3];ne.emplace(le++,ye,je,Fe,Ge,0),ne.emplace(le++,ye,je,Fe,Ge,1),ne.emplace(le++,ye,je,Fe,Ge,2),ne.emplace(le++,ye,je,Fe,Ge,3)}(!Zc||Zc.length<2*G)&&(Zc=function(ce){const ue=2*ce,Me=new u.a_;Me.resize(ue),Me._trim();for(let ye=0;ye<ue;ye++){const je=6*ye;Me.uint16[je+0]=4*ye+0,Me.uint16[je+1]=4*ye+1,Me.uint16[je+2]=4*ye+2,Me.uint16[je+3]=4*ye+2,Me.uint16[je+4]=4*ye+3,Me.uint16[je+5]=4*ye+0}return Me}(G));const de=D.createIndexBuffer(Zc,!0),pe=D.createVertexBuffer(ne,u.dV.members,!0);for(const ce of q){const ue={u_matrix:ce.transform,u_inv_matrix:ce.invTransform,u_camera_to_center_distance:(ae=P).getCameraToCenterDistance(ce.projection),u_viewport_size:[ae.width,ae.height]};ee.draw(f,C.TRIANGLES,bt.disabled,Vt.disabled,f.colorModeForRenderPass(),Bt.disabled,ue,l.id,pe,de,u.bd.simpleSegment(0,2*ce.circleOffset,ce.circleArray.length,ce.circleArray.length/2),null,P.zoom)}var ae;pe.destroy(),de.destroy()}const hl=u.bz();function uh(f){const r=f._camera.getWorldToCamera(f.worldSize,1),l=u.az([],r,f.globeMatrix);u.bi(l,l);const p=[0,0,0],y=[0,1,0,0];return u.aA(y,y,l),p[0]=y[0],p[1]=y[1],p[2]=y[2],u.au(p,p),p}function dh({width:f,height:r,anchor:l,textOffset:p,textScale:y},v){const{horizontalAlign:b,verticalAlign:D}=u.bZ(l),C=-(b-.5)*f,P=-(D-.5)*r,O=u.b_(l,p);return new u.P((C/y+O[0])*v,(P/y+O[1])*v)}function Cv(f,r,l,p,y,v,b,D,C,P){const O=f.text.placedSymbolArray,N=f.text.dynamicLayoutVertexArray,F=f.icon.dynamicLayoutVertexArray,B={},H=f.getProjection(),U=Wp(b,H,y),q=y.elevation,G=H.upVectorScale(b.canonical,y.center.lat,y.worldSize).metersToTile;N.clear();for(let Y=0;Y<O.length;Y++){const ee=O.get(Y),{tileAnchorX:ne,tileAnchorY:le,numGlyphs:de}=ee,pe=ee.hidden||!ee.crossTileID||f.allowVerticalPlacement&&!ee.placedOrientation?null:p[ee.crossTileID];if(pe){let ae=0,ce=0,ue=0;if(q){const Ne=q?q.getAtTileOffset(b,ne,le):0,[Re,We,Ze]=H.upVector(b.canonical,ne,le);ae=Ne*Re*G,ce=Ne*We*G,ue=Ne*Ze*G}let[Me,ye,je,Fe]=_n(ee.projectedAnchorX+ae,ee.projectedAnchorY+ce,ee.projectedAnchorZ+ue,l?U:v);const Ge=Yg(y.getCameraToCenterDistance(H),Fe);let rt=u.bJ(f.textSizeData,C,ee)*Ge/u.bU;l&&(rt*=f.tilePixelRatio/D);const De=dh(pe,rt);l?(({x:Me,y:ye,z:je}=H.projectTilePoint(ne+De.x,le+De.y,b.canonical)),[Me,ye,je]=_n(Me+ae,ye+ce,je+ue,v)):(r&&De._rotate(-y.angle),Me+=De.x,ye+=De.y,je=0);const _e=f.allowVerticalPlacement&&ee.placedOrientation===u.bI.vertical?Math.PI/2:0;for(let Ne=0;Ne<de;Ne++)u.bL(N,Me,ye,je,_e);P&&ee.associatedIconIndex>=0&&(B[ee.associatedIconIndex]={x:Me,y:ye,z:je,angle:_e})}else Vu(de,N)}if(P){F.clear();const Y=f.icon.placedSymbolArray;for(let ee=0;ee<Y.length;ee++){const ne=Y.get(ee),{numGlyphs:le}=ne,de=B[ee];if(ne.hidden||!de)Vu(le,F);else{const{x:pe,y:ae,z:ce,angle:ue}=de;for(let Me=0;Me<le;Me++)u.bL(F,pe,ae,ce,ue)}}f.icon.dynamicLayoutVertexBuffer.updateData(F)}f.text.dynamicLayoutVertexBuffer.updateData(N)}function h_(f,r,l,p,y,v,b={}){const D=l.paint.get("icon-translate"),C=l.paint.get("text-translate"),P=l.paint.get("icon-translate-anchor"),O=l.paint.get("text-translate-anchor"),N=l.layout.get("icon-rotation-alignment"),F=l.layout.get("text-rotation-alignment"),B=l.layout.get("icon-pitch-alignment"),H=l.layout.get("text-pitch-alignment"),U=l.layout.get("icon-keep-upright"),q=l.layout.get("text-keep-upright"),G=l.paint.get("icon-color-saturation"),Y=l.paint.get("icon-color-contrast"),ee=l.paint.get("icon-color-brightness-min"),ne=l.paint.get("icon-color-brightness-max"),le="sea"===l.layout.get("symbol-elevation-reference"),de=f.context,pe=de.gl,ae=f.transform,ce="map"===N,ue="map"===F,Me="map"===B,ye="map"===H,je=void 0!==l.layout.get("symbol-sort-key").constantOr(1);let Fe=!1;const Ge=f.depthModeForSublayer(0,bt.ReadOnly),rt=new bt(f.context.gl.LEQUAL,bt.ReadOnly,f.depthRangeFor3D),De=[u.aD(ae.center.lng),u.aH(ae.center.lat)],_e=l.layout.get("text-variable-anchor"),Ne="globe"===ae.projection.name,Re=[],We=[0,-1,0];for(const Ze of p){const Ye=r.getTile(Ze),ct=Ye.getBucket(l);if(!ct||"mercator"===ct.projection.name&&Ne||ct.fullyClipped)continue;const Mt="globe"===ct.projection.name,kt=Mt?u.ah(ae.zoom):0,vt=Wp(Ze,ct.getProjection(),ae),Ot=ae.calculatePixelsToTileUnitsMatrix(Ye),Pt=_e&&ct.hasTextData(),Wt=ct.hasIconTextFit()&&Pt&&ct.hasIconData(),en=ct.getProjection().createInversionMatrix(ae,Ze.canonical),mn=(1<<Ye.tileID.canonical.z)*u.aj/f.transform.worldSize,Cn=ni=>{let $n=[0,0,0];if(ni){const Ni=f.style.directionalLight,Pn=f.style.ambientLight;Ni&&Pn&&($n=nl(f.style,Ni,Pn))}return $n},Yt=ni=>{ae.depthOcclusionForSymbolsAndCircles&&(l.hasInitialOcclusionOpacityProperties||f.terrain)&&(ni.push("DEPTH_D24"),ni.push("DEPTH_OCCLUSION"))},Mn=()=>{const ni=ce&&"point"!==l.layout.get("symbol-placement"),$n=[];Yt($n);const Ni=ni||Wt,Pn="road"===ct.elevationType,Wn=f.shadowRenderer,di=Pn&&Me&&!!Wn&&Wn.enabled,xr=Cn(di),hr=Pn&&Me&&!f.terrain?rt:Ge,or=l.paint.get("icon-image-cross-fade");f.terrainRenderModeElevated()&&Me&&$n.push("PITCH_WITH_MAP_TERRAIN"),Mt&&($n.push("PROJECTION_GLOBE_VIEW"),Ni&&$n.push("PROJECTED_POS_ON_VIEWPORT")),or>0&&ct.hasAnySecondaryIcon&&$n.push("ICON_TRANSITION"),!ct.icon.zOffsetVertexBuffer||Pn&&f.terrain||$n.push("Z_OFFSET"),0===G&&0===Y&&0===ee&&1===ne||$n.push("COLOR_ADJUSTMENT"),ct.sdfIcons&&$n.push("RENDER_SDF"),di&&$n.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Pn&&Me&&!f.terrain&&ct.icon.orientationVertexBuffer&&$n.push("ELEVATED_ROADS");const Gr=ct.icon.programConfigurations.get(l.id),ba=f.getOrCreateProgram("symbol",{config:Gr,defines:$n}),Lo=Ye.imageAtlasTexture?Ye.imageAtlasTexture.size:[0,0],qs=ct.iconSizeData,uo=u.bH(qs,ae.zoom),ia=Me||!ae.isOrthographic,ra=qd(vt,Ye.tileID.canonical,Me,ce,ae,ct.getProjection(),Ot),Co=Yr(vt,Ye.tileID.canonical,Me,ce,ae,ct.getProjection(),Ot),Qi=f.translatePosMatrix(Co,Ye,D,P,!0),rr=f.translatePosMatrix(vt,Ye,D,P),Ei=Ni?hl:ra,Tr=ce&&!Me&&!ni;let ho=We;!Ne&&!ae.mercatorFromTransition||ce||(ho=uh(ae));const fr=Mt?ho:We,oa=l.getColorAdjustmentMatrix(G,Y,ee,ne),cd=ch(qs.kind,uo,Tr,Me,f,rr,Ei,Qi,le,!1,Lo,[0,0],0,Ze,kt,De,en,fr,ct.getProjection(),xr,mn,oa,or,null),su=Ye.imageAtlasTexture?Ye.imageAtlasTexture:null,ud=1!==l.layout.get("icon-size").constantOr(0)||ct.iconsNeedLinear,yl=ct.sdfIcons||f.options.rotating||f.options.zooming||ud||ia?pe.LINEAR:pe.NEAREST,Wo=ct.sdfIcons&&0!==l.paint.get("icon-halo-width").constantOr(1),wa=f.terrain&&Me&&ni?u.bi(u.bz(),ra):hl;if(ni&&ct.icon){const Mr=ae.elevation,Is=Mr?Mr.getAtTileOffsetFunc(Ze,ae.center.lat,ae.worldSize,ct.getProjection()):null,sa=Wd(vt,Ye.tileID.canonical,Me,ce,ae,ct.getProjection(),Ot);Nu(ct,vt,f,!1,sa,Co,Me,U,Is,Ze)}return{program:ba,buffers:ct.icon,uniformValues:cd,atlasTexture:su,atlasTextureIcon:null,atlasInterpolation:yl,atlasInterpolationIcon:null,isSDF:ct.sdfIcons,hasHalo:Wo,depthMode:hr,tile:Ye,renderWithShadows:di,labelPlaneMatrixInv:wa}},kn=()=>{const ni=ue&&"point"!==l.layout.get("symbol-placement"),$n=[],Ni=ni||_e||Wt,Pn="road"===ct.elevationType,Wn=f.shadowRenderer,di=Pn&&ye&&!!Wn&&Wn.enabled,xr=Cn(di),hr=Pn&&ye&&!f.terrain?rt:Ge;f.terrainRenderModeElevated()&&ye&&$n.push("PITCH_WITH_MAP_TERRAIN"),Mt&&($n.push("PROJECTION_GLOBE_VIEW"),Ni&&$n.push("PROJECTED_POS_ON_VIEWPORT")),!ct.text.zOffsetVertexBuffer||Pn&&f.terrain||$n.push("Z_OFFSET"),ct.iconsInText&&$n.push("RENDER_TEXT_AND_SYMBOL"),$n.push("RENDER_SDF"),di&&$n.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Pn&&ye&&!f.terrain&&ct.text.orientationVertexBuffer&&$n.push("ELEVATED_ROADS"),Yt($n);const or=ct.text.programConfigurations.get(l.id),Gr=f.getOrCreateProgram("symbol",{config:or,defines:$n});let ba,Lo=[0,0],qs=null;const uo=ct.textSizeData;ct.iconsInText&&(Lo=Ye.imageAtlasTexture?Ye.imageAtlasTexture.size:[0,0],qs=Ye.imageAtlasTexture?Ye.imageAtlasTexture:null,ba=ye||!ae.isOrthographic||f.options.rotating||f.options.zooming||"composite"===uo.kind||"camera"===uo.kind?pe.LINEAR:pe.NEAREST);const ia=Ye.glyphAtlasTexture?Ye.glyphAtlasTexture.size:[0,0],ra=l.layout.get("text-size-scale-range"),Co=u.ay(f.scaleFactor,ra[0],ra[1]),Qi=u.bH(uo,ae.zoom,Co),rr=qd(vt,Ye.tileID.canonical,ye,ue,ae,ct.getProjection(),Ot),Ei=Yr(vt,Ye.tileID.canonical,ye,ue,ae,ct.getProjection(),Ot),Tr=f.translatePosMatrix(Ei,Ye,C,O,!0),ho=f.translatePosMatrix(vt,Ye,C,O),fr=Ni?hl:rr,oa=ue&&!ye&&!ni;let cd=We;!Ne&&!ae.mercatorFromTransition||ue||(cd=uh(ae));const su=ch(uo.kind,Qi,oa,ye,f,ho,fr,Tr,le,!0,ia,Lo,0,Ze,kt,De,en,Mt?cd:We,ct.getProjection(),xr,mn,null,null,Co),ud=Ye.glyphAtlasTexture?Ye.glyphAtlasTexture:null,yl=pe.LINEAR,Wo=0!==l.paint.get("text-halo-width").constantOr(1),wa=f.terrain&&ye&&ni?u.bi(u.bz(),rr):hl;if(ni&&ct.text){const Mr=ae.elevation,Is=Mr?Mr.getAtTileOffsetFunc(Ze,ae.center.lat,ae.worldSize,ct.getProjection()):null,sa=Wd(vt,Ye.tileID.canonical,ye,ue,ae,ct.getProjection(),Ot);Nu(ct,vt,f,!0,sa,Ei,ye,q,Is,Ze)}return{program:Gr,buffers:ct.text,uniformValues:su,atlasTexture:ud,atlasTextureIcon:qs,atlasInterpolation:yl,atlasInterpolationIcon:ba,isSDF:!0,hasHalo:Wo,depthMode:hr,tile:Ye,renderWithShadows:di,labelPlaneMatrixInv:wa}},ti=ct.icon.segments.get().length,un=ct.text.segments.get().length,Ln=ti&&!b.onlyText?Mn():null,zn=un&&!b.onlyIcons?kn():null,In=l.paint.get("icon-opacity").constantOr(1),sn=l.paint.get("text-opacity").constantOr(1);if(je&&ct.canOverlap){Fe=!0;const ni=In&&!b.onlyText?ct.icon.segments.get():[],$n=sn&&!b.onlyIcons?ct.text.segments.get():[];for(const Ni of ni)Re.push({segments:new u.bd([Ni]),sortKey:Ni.sortKey,state:Ln});for(const Ni of $n)Re.push({segments:new u.bd([Ni]),sortKey:Ni.sortKey,state:zn})}else b.onlyText||Re.push({segments:In?ct.icon.segments:new u.bd([]),sortKey:0,state:Ln}),b.onlyIcons||Re.push({segments:sn?ct.text.segments:new u.bd([]),sortKey:0,state:zn})}Fe&&Re.sort((Ze,Ye)=>Ze.sortKey-Ye.sortKey);for(const Ze of Re){const Ye=Ze.state;if(Ye)if(f.terrain?f.terrain.setupElevationDraw(Ye.tile,Ye.program,{useDepthForOcclusion:ae.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Ye.labelPlaneMatrixInv}):f.setupDepthForOcclusion(ae.depthOcclusionForSymbolsAndCircles,Ye.program),de.activeTexture.set(pe.TEXTURE0),Ye.atlasTexture&&Ye.atlasTexture.bind(Ye.atlasInterpolation,pe.CLAMP_TO_EDGE,!0),Ye.atlasTextureIcon&&(de.activeTexture.set(pe.TEXTURE1),Ye.atlasTextureIcon&&Ye.atlasTextureIcon.bind(Ye.atlasInterpolationIcon,pe.CLAMP_TO_EDGE,!0)),Ye.renderWithShadows&&f.shadowRenderer.setupShadows(Ye.tile.tileID.toUnwrapped(),Ye.program,"vector-tile"),f.uploadCommonLightUniforms(f.context,Ye.program),Ye.hasHalo){const ct=Ye.uniformValues;ct.u_is_halo=1,nc(Ye.buffers,Ze.segments,l,f,Ye.program,Ye.depthMode,y,v,ct,2),ct.u_is_halo=0}else{if(Ye.isSDF){const ct=Ye.uniformValues;Ye.hasHalo&&(ct.u_is_halo=1,nc(Ye.buffers,Ze.segments,l,f,Ye.program,Ye.depthMode,y,v,ct,1)),ct.u_is_halo=0}nc(Ye.buffers,Ze.segments,l,f,Ye.program,Ye.depthMode,y,v,Ye.uniformValues,1)}}}function nc(f,r,l,p,y,v,b,D,C,P){const O=[f.dynamicLayoutVertexBuffer,f.opacityVertexBuffer,f.iconTransitioningVertexBuffer,f.globeExtVertexBuffer,f.zOffsetVertexBuffer,f.orientationVertexBuffer];y.draw(p,p.context.gl.TRIANGLES,v,b,D,Bt.disabled,C,l.id,f.layoutVertexBuffer,f.indexBuffer,r,l.paint,p.transform.zoom,f.programConfigurations.get(l.id),O,P)}function Yu(f,r){const l=1<<f.canonical.z,p=(r.x*l-f.canonical.x-f.wrap*l)*u.aj,y=(r.y*l-f.canonical.y)*u.aj,v=u.e2(r.z,r.y);return u.d2(p,y,v)}function Et(f,r,l,p,y){if(!l.layout||"none"===l.layout.get("fill-elevation-reference"))return;const v=f.context.gl,b=new bt(f.context.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D),D=new bt(f.context.gl.GREATER,bt.ReadWrite,f.depthRangeFor3D),C=function(B){const H=u.cU(B.pitch);let U=.01;return B.isOrthographic&&(U=u.ai(1e-4,U,u.cZ(H>=15?1:H/15))),2*U}(f.transform),P=f.transform.getFreeCameraOptions().position,O="elevatedStructuresDepthReconstruct",N=f.getOrCreateProgram(O,{defines:["DEPTH_RECONSTRUCTION"]}),F=f.getOrCreateProgram(O);for(const B of p){const H=r.getTile(B),U=H.getBucket(l);if(!U)continue;const q=U.elevatedStructures;if(!q)continue;const G=U.elevationBufferData.heightRange,Y=Yu(B.toUnwrapped(),P),ee=f.translatePosMatrix(B.projMatrix,H,l.paint.get("fill-translate"),l.paint.get("fill-translate-anchor"));let ne,le,de,pe;if("initialize"===y){if(!G||G.min>=1||0===q.depthSegments.segments[0].primitiveLength)continue;ne=um(ee,Y,C,1,0),le=b,de=q.depthSegments,pe=N}else if("reset"===y){if(!G||G.min>=0||0===q.maskSegments.segments[0].primitiveLength)continue;ne=um(ee,Y,0,0,1),le=D,de=q.maskSegments,pe=N}else if("geometry"===y){if(0===q.depthSegments.segments[0].primitiveLength)continue;ne=um(ee,Y,C,1,0),le=b,de=q.depthSegments,pe=F}pe.draw(f,v.TRIANGLES,le,Vt.disabled,an.disabled,Bt.disabled,ne,l.id,q.vertexBuffer,q.indexBuffer,de,l.paint,f.transform.zoom)}}function kf(f,r,l){const{painter:p,sourceCache:y,layer:v,coords:b,colorMode:D,elevationType:C,terrainEnabled:P,pass:O}=f,N=p.context.gl,F=v.paint.get("fill-pattern"),B=v.paint.get("fill-pattern-cross-fade"),H=F.constantOr(null);let U=C;"road"!==C||r&&!P||(U="none");const q="road"===U,G=f.painter.shadowRenderer,Y=q&&!!G&&G.enabled,ee=new bt(p.context.gl.LEQUAL,bt.ReadOnly,p.depthRangeFor3D);let ne=[0,0,0];if(Y){const pe=p.style.directionalLight,ae=p.style.ambientLight;pe&&ae&&(ne=nl(p.style,pe,ae))}const le=F&&F.constantOr(1),de=(pe,ae)=>{let ce,ue,Me,ye,je;ae?(ce=le&&!v.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Me=N.LINES):(ce=le?"fillPattern":"fill",Me=N.TRIANGLES);for(const Fe of b){const Ge=y.getTile(Fe);if(le&&!Ge.patternsLoaded())continue;const rt=Ge.getBucket(v);if(!rt)continue;const De=r?rt.elevationBufferData:rt.bufferData;if(De.isEmpty())continue;p.prepareDrawTile();const _e=De.programConfigurations.get(v.id),Ne=p.isTileAffectedByFog(Fe),Re=[],We=[];q&&(Re.push("ELEVATED_ROADS"),We.push(De.elevatedLayoutVertexBuffer)),Y&&Re.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),le&&(p.context.activeTexture.set(N.TEXTURE0),Ge.imageAtlasTexture&&Ge.imageAtlasTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),_e.updatePaintBuffers());let Ze=!1;if(H&&Ge.imageAtlas){const vt=Ge.imageAtlas,Ot=u.dZ.from(H),Pt=Ot.getPrimary().scaleSelf(u.q.devicePixelRatio).toString(),Wt=Ot.getSecondary(),en=vt.patternPositions.get(Pt),mn=Wt?vt.patternPositions.get(Wt.scaleSelf(u.q.devicePixelRatio).toString()):null;Ze=!!en&&!!mn,en&&_e.setConstantPatternPositions(en,mn)}B>0&&(Ze||_e.getPatternTransitionVertexBuffer("fill-pattern"))&&Re.push("FILL_PATTERN_TRANSITION");const Ye=p.getOrCreateProgram(ce,{config:_e,overrideFog:Ne,defines:Re}),ct=p.translatePosMatrix(Fe.projMatrix,Ge,v.paint.get("fill-translate"),v.paint.get("fill-translate-anchor"));Y&&G.setupShadows(Ge.tileID.toUnwrapped(),Ye,"vector-tile");const Mt=v.paint.get("fill-emissive-strength");if(ae){ye=De.lineIndexBuffer,je=De.lineSegments;const vt=p.terrain&&p.terrain.renderingToTexture?p.terrain.drapeBufferSize:[N.drawingBufferWidth,N.drawingBufferHeight];ue="fillOutlinePattern"===ce&&le?a_(ct,Mt,p,Ge,vt,ne,B):s_(ct,Mt,vt,ne)}else ye=De.indexBuffer,je=De.triangleSegments,ue=le?Dv(ct,Mt,p,Ge,ne,B):Tv(ct,Mt,ne);p.uploadCommonUniforms(p.context,Ye,Fe.toUnwrapped());let kt=pe;("road"===C&&!P||"offset"===C)&&(kt=ee),Ye.draw(p,Me,kt,l||p.stencilModeForClipping(Fe),D,Bt.disabled,ue,v.id,De.layoutVertexBuffer,ye,je,v.paint,p.transform.zoom,_e,We)}};p.renderPass===O&&de(p.depthModeForSublayer(1,"opaque"===p.renderPass?bt.ReadWrite:bt.ReadOnly),!1),"none"===U&&"translucent"===p.renderPass&&v.paint.get("fill-antialias")&&de(p.depthModeForSublayer(v.getPaintProperty("fill-outline-color")?2:0,bt.ReadOnly),!0)}function hh(f,r,l,p,y,v,b,D){l.resetLayerRenderingStats(f);const C=f.context,P=C.gl,O=f.transform,N=l.paint.get("fill-extrusion-pattern"),F=l.paint.get("fill-extrusion-pattern-cross-fade"),B=N.constantOr(null),H=N.constantOr(1),U=l.paint.get("fill-extrusion-opacity"),q=f.style.enable3dLights(),G=l.paint.get(q&&!H?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Y=[l.paint.get("fill-extrusion-ambient-occlusion-intensity"),G],ee=l.layout.get("fill-extrusion-edge-radius"),ne=ee>0&&!l.paint.get("fill-extrusion-rounded-roof"),le=ne?0:ee,de="globe"===O.projection.name?u.e5():0,pe="globe"===O.projection.name,ae=pe?u.ah(O.zoom):0,ce=[u.aD(O.center.lng),u.aH(O.center.lat)],ue="none"===l.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),Me=l.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(ue?null:l.lut).toArray01().slice(0,3),ye=l.paint.get("fill-extrusion-flood-light-intensity"),je=l.paint.get("fill-extrusion-vertical-scale"),Fe=0!==l.paint.get("fill-extrusion-line-width").constantOr(1),Ge=l.paint.get("fill-extrusion-height-alignment"),rt=l.paint.get("fill-extrusion-base-alignment"),De=xo(f,l.paint.get("fill-extrusion-cutoff-fade-range")),_e=[];let Ne;pe&&_e.push("PROJECTION_GLOBE_VIEW"),Y[0]>0&&_e.push("FAUX_AO"),ne&&_e.push("ZERO_ROOF_RADIUS"),D&&_e.push("HAS_CENTROID"),ye>0&&_e.push("FLOOD_LIGHT"),De.shouldRenderCutoff&&_e.push("RENDER_CUTOFF"),Fe&&_e.push("RENDER_WALL_MODE");const Re="shadow"===f.renderPass,We=f.shadowRenderer,Ze=Re&&!!We,Ye=Re?Bt.disabled:Bt.backCCW;f.shadowRenderer&&(f.shadowRenderer.useNormalOffset=!0);let ct=[0,0,0];if(We){const vt=f.style.directionalLight,Ot=f.style.ambientLight;vt&&Ot&&(ct=nl(f.style,vt,Ot)),Re||(_e.push("RENDER_SHADOWS","DEPTH_TEXTURE"),We.useNormalOffset&&_e.push("NORMAL_OFFSET")),Ne=_e.concat(["SHADOWS_SINGLE_CASCADE"])}const Mt=Ze?"fillExtrusionDepth":H?"fillExtrusionPattern":"fillExtrusion",kt=l.getLayerRenderingStats();for(const vt of p){const Ot=r.getTile(vt),Pt=Ot.getBucket(l);if(!Pt||Pt.projection.name!==O.projection.name)continue;let Wt=!1;We&&(Wt=0===We.getMaxCascadeForTile(vt.toUnwrapped()));const en=f.isTileAffectedByFog(vt),mn=Pt.programConfigurations.get(l.id);let Cn=!1;if(B&&Ot.imageAtlas){const zn=Ot.imageAtlas,In=u.dZ.from(B),sn=In.getPrimary().scaleSelf(u.q.devicePixelRatio).toString(),ni=In.getSecondary(),$n=zn.patternPositions.get(sn),Ni=ni?zn.patternPositions.get(ni.scaleSelf(u.q.devicePixelRatio).toString()):null;Cn=!!$n&&!!Ni,$n&&mn.setConstantPatternPositions($n,Ni)}F>0&&(Cn||mn.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&_e.push("FILL_EXTRUSION_PATTERN_TRANSITION");const Yt=f.getOrCreateProgram(Mt,{config:mn,defines:Wt?Ne:_e,overrideFog:en});if(f.terrain&&f.terrain.setupElevationDraw(Ot,Yt,{useMeterToDem:!0}),!Pt.centroidVertexBuffer){const zn=Yt.attributes.a_centroid_pos;void 0!==zn&&P.vertexAttrib2f(zn,0,0)}!Re&&We&&We.setupShadows(Ot.tileID.toUnwrapped(),Yt,"vector-tile"),H&&(f.context.activeTexture.set(P.TEXTURE0),Ot.imageAtlasTexture&&Ot.imageAtlasTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),mn.updatePaintBuffers());const Mn=l.paint.get("fill-extrusion-vertical-gradient"),kn=1/Pt.tileToMeter;let ti;if(Re&&We){if(Nf(Ot.tileID,Pt.maxHeight,f))continue;const zn=We.calculateShadowPassMatrixFromTile(Ot.tileID.toUnwrapped());ti=Ev(zn,le,kn,je,Ge,rt)}else{const zn=f.translatePosMatrix(vt.expandedProjMatrix,Ot,l.paint.get("fill-extrusion-translate"),l.paint.get("fill-extrusion-translate-anchor")),In=O.projection.createInversionMatrix(O,vt.canonical);ti=H?sh(zn,f,Mn,U,Y,le,kn,vt,Ot,de,Ge,rt,ae,ce,In,Me,je,F):o_(zn,f,Mn,U,Y,le,kn,vt,de,Ge,rt,ae,ce,In,Me,je,ye,ct)}f.uploadCommonUniforms(C,Yt,vt.toUnwrapped(),null,De);let un=Pt.segments;if("mercator"===O.projection.name&&!Re&&(un=Pt.getVisibleSegments(Ot.tileID,f.terrain,f.transform.getFrustum(0)),!un.get().length))continue;if(kt)if(Re)for(const zn of un.get())kt.numRenderedVerticesInShadowPass+=zn.primitiveLength;else for(const zn of un.get())kt.numRenderedVerticesInTransparentPass+=zn.primitiveLength;const Ln=[];(f.terrain||D)&&Ln.push(Pt.centroidVertexBuffer),pe&&Ln.push(Pt.layoutVertexExtBuffer),Fe&&Ln.push(Pt.wallVertexBuffer),Yt.draw(f,C.gl.TRIANGLES,y,v,b,Ye,ti,l.id,Pt.layoutVertexBuffer,Pt.indexBuffer,un,l.paint,f.transform.zoom,mn,Ln)}f.shadowRenderer&&(f.shadowRenderer.useNormalOffset=!1)}class fl{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function $o(f,r,l,p,y,v,b,D,C,P,O,N,F,B,H,U,q,G,Y,ee){const ne=r.context,le=ne.gl,de=r.transform,pe=r.transform.zoom,ae=[],ce=f.translate,ue=f.translateAnchor,Me=f.edgeRadius,ye=xo(r,f.cutoffFadeRange);"clear"===O?(ae.push("CLEAR_SUBPASS"),ee&&(ae.push("CLEAR_FROM_TEXTURE"),ne.activeTexture.set(le.TEXTURE0),ee.bind(le.LINEAR,le.CLAMP_TO_EDGE))):"sdf"===O&&ae.push("SDF_SUBPASS"),G&&ae.push("HAS_CENTROID"),ye.shouldRenderCutoff&&ae.push("RENDER_CUTOFF");const je=(Fe,Ge,rt,De,_e)=>{const Ne=Ge.programConfigurations.get(p.id),Re=r.isTileAffectedByFog(Fe),We=r.getOrCreateProgram("fillExtrusionGroundEffect",{config:Ne,defines:ae,overrideFog:Re}),Ze={u_matrix:De,u_opacity:N,u_ao_pass:P?1:0,u_meter_to_tile:_e,u_ao:[F,B*_e],u_flood_light_intensity:H,u_flood_light_color:U,u_attenuation:q,u_edge_radius:pe>=17?0:Me*_e,u_fb:0,u_fb_size:ee?ee.size[0]:0,u_dynamic_offset:1},Ye=[];G&&Ye.push(Ge.hiddenByLandmarkVertexBuffer),r.uploadCommonUniforms(ne,We,Fe.toUnwrapped(),null,ye),We.draw(r,ne.gl.TRIANGLES,v,b,D,C,Ze,p.id,Ge.vertexBuffer,Ge.indexBuffer,rt,p.paint,pe,Ne,Ye)};for(const Fe of y){const Ge=l.getTile(Fe),rt=Ge.getBucket(p);if(!rt||rt.projection.name!==de.projection.name||!rt.groundEffect||rt.groundEffect&&!rt.groundEffect.hasData())continue;const De=rt.groundEffect,_e=1/rt.tileToMeter;{const Ne=r.translatePosMatrix(Fe.projMatrix,Ge,ce,ue),Re=De.getDefaultSegment();je(Fe,De,Re,Ne,_e)}if(Y)for(let Ne=0;Ne<4;Ne++){const Re=u.e3[Ne](Fe),We=l.getTile(Re);if(!We)continue;const Ze=We.getBucket(p);if(!Ze||Ze.projection.name!==de.projection.name||!Ze.groundEffect||Ze.groundEffect&&!Ze.groundEffect.hasData())continue;const Ye=Ze.groundEffect;let ct,Mt;0===Ne?(ct=[-u.aj,0,0],Mt=1):1===Ne?(ct=[u.aj,0,0],Mt=0):2===Ne?(ct=[0,-u.aj,0],Mt=3):(ct=[0,u.aj,0],Mt=2);const kt=Ye.regionSegments[Mt];if(!kt)continue;const vt=new Float32Array(16);u.bo(vt,Fe.projMatrix,ct),je(Fe,Ye,kt,r.translatePosMatrix(vt,Ge,ce,ue),_e)}}}function jt(f,r,l,p,y,v,b){0===p.centroidVertexArray.length&&p.createCentroidsBuffer();const D=v?v.findDEMTileFor(l):null;if(!(D&&D.dem||b))return;v&&D&&D.dem&&p.selfDEMTileTimestamp!==D.dem._timestamp&&(p.borderDoneWithNeighborZ=[-1,-1,-1,-1],p.selfDEMTileTimestamp=D.dem._timestamp);const C=G=>new u.P(Math.ceil((G+u.e7)*u.e8),0),P=G=>{const Y=r.getSource().minzoom,ee=le=>{const de=r.getTileByID(le);if(de&&de.hasData())return de.getBucket(y)},ne=[0,-1,1];for(const le of ne){if(G.overscaledZ+le<Y)continue;const de=ee(G.calculateScaledKey(G.overscaledZ+le));if(de)return de}},O=[0,0,0],N=(G,Y)=>(O[0]=Math.min(G.min.y,Y.min.y),O[1]=Math.max(G.max.y,Y.max.y),O[2]=u.aj-Y.min.x>G.max.x?Y.min.x-u.aj:G.max.x,O),F=(G,Y)=>(O[0]=Math.min(G.min.x,Y.min.x),O[1]=Math.max(G.max.x,Y.max.x),O[2]=u.aj-Y.min.y>G.max.y?Y.min.y-u.aj:G.max.y,O),B=[(G,Y)=>N(G,Y),(G,Y)=>N(Y,G),(G,Y)=>F(G,Y),(G,Y)=>F(Y,G)],H=(G,Y,ee,ne,le,de,pe)=>{if(!v)return 0;const ae=[[de?ee:G,de?G:ee,0],[de?ee:Y,de?Y:ee,0]],ce=pe<0?u.aj+pe:pe,ue=[de?ce:(G+Y)/2,de?(G+Y)/2:ce,0];return 0===ee&&pe<0||0!==ee&&pe>0?v.getForTilePoints(le,[ue],!0,ne):ae.push(ue),v.getForTilePoints(l,ae,!0,D),Math.max(ae[0][2],ae[1][2],ue[2])/v.exaggeration()};for(let G=0;G<4;G++){const Y=p.borderFeatureIndices[G];if(0===Y.length)continue;const ee=u.e3[G](l),ne=P(ee);if(!(ne&&ne instanceof u.e4))continue;const le=v?v.findDEMTileFor(ee):null;if(!(le&&le.dem||b)||(v&&le&&le.dem&&p.borderDEMTileTimestamp[G]!==le.dem._timestamp&&(p.borderDoneWithNeighborZ[G]=-1,p.borderDEMTileTimestamp[G]=le.dem._timestamp),p.borderDoneWithNeighborZ[G]===ne.canonical.z))continue;0===ne.centroidVertexArray.length&&ne.createCentroidsBuffer();const de=(G<2?1:5)-G,pe=ne.borderDoneWithNeighborZ[de]!==p.canonical.z,ae=ne.borderFeatureIndices[de];let ce=0;if(p.canonical.z!==ne.canonical.z){for(const ue of Y)p.showCentroid(p.featuresOnBorder[ue]);if(pe)for(const ue of ae)ne.showCentroid(ne.featuresOnBorder[ue]);p.borderDoneWithNeighborZ[G]=ne.canonical.z,ne.borderDoneWithNeighborZ[de]=p.canonical.z}for(const ue of Y){const Me=p.featuresOnBorder[ue],ye=p.centroidData[Me.centroidDataIndex],je=Me.borders[G];let Fe;for(;ce<ae.length;){Fe=ne.featuresOnBorder[ae[ce]];const Ge=Fe.borders[de];if(Ge[1]>je[0]+3||Ge[0]>je[0]-3)break;ne.showCentroid(Fe),ce++}if(Fe&&ce<ae.length){const Ge=ce;let rt=0;for(;!(Fe.borders[de][0]>je[1]-3)&&(rt++,++ce!==ae.length);)Fe=ne.featuresOnBorder[ae[ce]];Fe=ne.featuresOnBorder[ae[Ge]];let De=!1;if(rt>=1){const Re=Fe.borders[de];Math.abs(je[0]-Re[0])<3&&Math.abs(je[1]-Re[1])<3&&(rt=1,De=!0,ce=Ge+1)}else if(0===rt){p.showCentroid(Me);continue}const _e=ne.centroidData[Fe.centroidDataIndex];b&&De&&(((U=ye).flags|(q=_e).flags)&u.e6?(U.flags|=u.e6,q.flags|=u.e6):(U.flags&=~u.e6,q.flags&=~u.e6));const Ne=Me.intersectsCount()>1||Fe.intersectsCount()>1;if(rt>1)ce=Ge,ye.centroidXY=_e.centroidXY=new u.P(0,0);else if(le&&le.dem&&!Ne){const Re=B[G](ye,_e),We=G%2?u.aj-1:0,Ze=H(Re[0],Math.min(u.aj-1,Re[1]),We,le,ee,G<2,Re[2]);ye.centroidXY=_e.centroidXY=C(Ze)}else Ne?ye.centroidXY=_e.centroidXY=new u.P(0,0):(ye.centroidXY=p.encodeBorderCentroid(Me),_e.centroidXY=ne.encodeBorderCentroid(Fe));p.writeCentroidToBuffer(ye),ne.writeCentroidToBuffer(_e)}else p.showCentroid(Me)}p.borderDoneWithNeighborZ[G]=ne.canonical.z,ne.borderDoneWithNeighborZ[de]=p.canonical.z}var U,q;(p.needsCentroidUpdate||!p.centroidVertexBuffer&&0!==p.centroidVertexArray.length)&&p.uploadCentroid(f)}const Lf=[1,0,0],Iv=[0,1,0],Qx=[0,0,1];function Nf(f,r,l){const p=l.transform,y=l.shadowRenderer;if(!y)return!0;const v=f.toUnwrapped(),b=p.tileSize*y._cascades[l.currentShadowCascade].scale;let D=r;if(p.elevation){const U=p.elevation.getMinMaxForTile(f);U&&(D+=U.max)}const C=[...y.shadowDirection];C[2]=-C[2];const P=y.computeSimplifiedTileShadowVolume(v,D,b,C);if(!P)return!1;const O=[Lf,Iv,Qx,C,[C[0],0,C[2]],[0,C[1],C[2]]],N="globe"===p.projection.name,F=p.scaleZoom(b),B=u.cy.fromInvProjectionMatrix(p.invProjMatrix,p.worldSize,F,!N),H=y.getCurrentCascadeFrustum();return 0===B.intersectsPrecise(P.vertices,P.planes,O)||0===H.intersectsPrecise(P.vertices,P.planes,O)}function ta(f){const{painter:r,source:l,layer:p,coords:y}=f,v=f.defines,b=r.context,D="shadow"===r.renderPass,C="light-beam"===r.renderPass,P=r.shadowRenderer;let O;P&&(O=v.concat(["SHADOWS_SINGLE_CASCADE"]));const N=u.e9(r.transform.center.lat,r.transform.zoom);for(const F of y){const B=l.getTile(F),H=B.getBucket(p);if(!H)continue;let U=!1;P&&(U=0===P.getMaxCascadeForTile(F.toUnwrapped()));const q=H.programConfigurations.get(p.id);let G,Y,ee=r.translatePosMatrix(F.expandedProjMatrix,B,[0,0],"map");if(ee=u.cP(u.bz(),ee,[1,1,f.verticalScale]),D&&P){if(Nf(B.tileID,H.maxHeight*N,r))continue;let ne=P.calculateShadowPassMatrixFromTile(B.tileID.toUnwrapped());ne=u.cP(u.bz(),ne,[1,1,f.verticalScale]),Y=ll(ne),G=r.getOrCreateProgram("buildingDepth",{config:q,defines:U?O:v,overrideFog:!1})}else if(C)G=r.getOrCreateProgram("buildingBloom",{config:q,defines:U?O:v,overrideFog:!1}),Y=al(ee);else{const ne=r.transform.calculatePosMatrix(F.toUnwrapped(),r.transform.worldSize);u.cP(ne,ne,[1,1,f.verticalScale]);const le=u.bz();u.cP(le,ne,[1,-1,1/N]),u.bi(le,le),u.ea(le,le),Y=l_(ee,le),G=r.getOrCreateProgram("building",{config:q,defines:U?O:v,overrideFog:!1}),P&&P.setupShadowsFromMatrix(ne,G,!0)}if(r.uploadCommonUniforms(b,G,F.toUnwrapped(),null,null),C){const ne=H.bloomGeometry;G.draw(r,b.gl.TRIANGLES,f.depthMode,Vt.disabled,f.blendMode,Bt.disabled,Y,p.id,ne.layoutVertexBuffer,ne.indexBuffer,ne.segmentsBucket,p.paint,r.transform.zoom,q,[ne.layoutAttenuationBuffer,ne.layoutColorBuffer])}else G.draw(r,b.gl.TRIANGLES,f.depthMode,Vt.disabled,f.blendMode,D?Bt.disabled:Bt.backCW,Y,p.id,H.layoutVertexBuffer,H.indexBuffer,H.segments,p.paint,r.transform.zoom,q,[H.layoutNormalBuffer,H.layoutColorBuffer])}}function pm(f){return[f[0]*u.eb,f[1]*u.eb,f[2]*u.eb,0]}function zf(f,r,l,p,y,v,b,D,C){const P=p.getSource(),O=l.globeSharedBuffers;if(!O)return;let N,F,B;if(r&&(N=p.getTile(r)),P instanceof u.aP?(F=P.texture,B=u.dE(0,0,l.transform)):N&&r&&(F=N.texture,B=u.dE(r.canonical.z,r.canonical.x,l.transform)),!F||!B)return;f||(B=u.cP(u.bz(),B,[1,-1,1]));const H=l.context,U=H.gl,q="nearest"===y.paint.get("raster-resampling")?U.NEAREST:U.LINEAR,G=l.colorModeForDrapableLayerRenderPass(v),Y=b.defines;Y.push("GLOBE_POLES");const ee=new bt(U.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),ne=Float32Array.from(l.transform.expandedFarZProjMatrix),le=Float32Array.from(u.bh(u.dD(new u.cA(0,0,0))));l.terrain&&l.terrain.prepareDrawTile(),H.activeTexture.set(U.TEXTURE0),F.bind(q,U.CLAMP_TO_EDGE),H.activeTexture.set(U.TEXTURE1),F.bind(q,U.CLAMP_TO_EDGE),"useMipmap"in F&&H.extTextureFilterAnisotropic&&l.transform.pitch>20&&U.texParameterf(U.TEXTURE_2D,H.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,H.extTextureFilterAnisotropicMax);const[de,pe,ae,ce]=r?O.getPoleBuffers(r.canonical.z,!1):O.getPoleBuffers(0,!0),ue=y.paint.get("raster-elevation");let Me;f?(Me=de,l.renderDefaultNorthPole=0!==ue):(Me=pe,l.renderDefaultSouthPole=0!==ue);const ye=pm(b.mix),je=(Ge=ne,rt=le,De=B,_e=u.ah(l.transform.zoom),Re=y,Ze=ue,ct=ye,Mt=b.offset,kt=b.range,vt=v,Mf(Ge,rt,De,new Float32Array(16),new Float32Array(9),[0,0],_e,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Re,[0,0],Ze,2,ct,Mt,kt,1,0,vt)),Fe=l.getOrCreateProgram("raster",{defines:Y});var Ge,rt,De,_e,Re,Ze,ct,Mt,kt,vt;l.uploadCommonUniforms(H,Fe,null),Fe.draw(l,U.TRIANGLES,ee,C,G,D,je,y.id,Me,ae,ce)}function Av(f){const r=f._nearZ,l=f.projection.farthestPixelDistance(f),p=l-r,y=.2*f.height,v=r+y;return[r,l,(v-y-r)/p,(v-r)/p]}function f_(f,r,l,p){if(f)return r instanceof Hl&&f instanceof Yi?r.getTextureDescriptor(f,l,!0):{texture:f.texture,mix:pm(p.mix),offset:p.offset,buffer:0,tileSize:1}}var us=u.ec([{name:"a_index",type:"Int16",components:1}]);class mm{constructor(r,l,p,y){const v={width:p[0],height:p[1],data:null},b=r.gl;this.targetColorTexture=new u.T(r,v,b.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new u.T(r,v,b.RGBA8,{useMipmap:!1}),this.context=r,this.updateParticleTexture(l,y),this.lastInvalidatedAt=0}updateParticleTexture(r,l){if(this.particleTextureDimension===l.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const p=this.context.gl,y=l.width*l.height;this.particleTexture0=new u.T(this.context,l,p.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new u.T(this.context,l,p.RGBA8,{premultiply:!1,useMipmap:!1});const v=new u.ed;v.reserve(y);for(let b=0;b<y;b++)v.emplaceBack(b);this.particleIndexBuffer=this.context.createVertexBuffer(v,us.members,!0),this.particleSegment=u.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=l.width}update(r){return!(this.lastInvalidatedAt<r&&(this.lastInvalidatedAt=u.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function To(f,r,l){if(!f)return null;const p=r.getTextureDescriptor(f,l,!0);if(!p)return null;let{texture:y,mix:v,offset:b,tileSize:D,buffer:C,format:P}=p;if(!y||!P)return null;let O=!1;return"uint32"===P&&(O=!0,v[3]=0,v=cs(u.ee,v,[0,l.paint.get("raster-particle-max-speed")]),b=cl(u.ee,b,[0,l.paint.get("raster-particle-max-speed")])),{texture:y,textureOffset:[C/(D+2*C),D/(D+2*C)],tileSize:D,scalarData:O,scale:v,offset:b,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[P]]}}function ic(f){const r=f._nearZ,l=f.projection.farthestPixelDistance(f),p=l-r,y=.2*f.height,v=r+y;return[r,l,(v-y-r)/p,(v-r)/p]}const _a=new u.am(1,0,0,1),Bf=new u.am(0,1,0,1),Vf=new u.am(0,0,1,1),dr=new u.am(1,0,1,1),jf=new u.am(0,1,1,1);function Gs(f,r,l,p,y,v){for(let b=0;b<l.length;b++)if(y){const P=new u.am(.8*p.r,.8*p.g,.8*p.b,1);Tn(f,r,l[b],p,-1,-1,v),Tn(f,r,l[b],p,-1,1,v),Tn(f,r,l[b],p,1,1,v),Tn(f,r,l[b],p,1,-1,v),Tn(f,r,l[b],P,0,0,v)}else Tn(f,r,l[b],p,0,0,v)}function Tn(f,r,l,p,y,v,b){const D=f.context,C=f.transform,P=D.gl,O="globe"===C.projection.name,N=O?["PROJECTION_GLOBE_VIEW"]:[];let F=u.bw(l.projMatrix);if(O&&u.ah(C.zoom)>0){const ye=u.bg(l.canonical,C),je=u.ef(ye);F=u.az(new Float32Array(16),C.globeMatrix,je),u.az(F,C.projMatrix,F)}const B=u.bz();B[12]+=2*y/(u.q.devicePixelRatio*C.width),B[13]+=2*v/(u.q.devicePixelRatio*C.height),u.az(F,B,F);const H=f.getOrCreateProgram("debug",{defines:N}),U=r.getTileByID(l.key);f.terrain&&f.terrain.setupElevationDraw(U,H);const q=bt.disabled,G=Vt.disabled,Y=f.colorModeForRenderPass();D.activeTexture.set(P.TEXTURE0),f.emptyTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),O?U._makeGlobeTileDebugBuffers(f.context,C):U._makeDebugTileBoundsBuffers(f.context,C.projection);const ne=U._tileDebugBuffer||f.debugBuffer,le=U._tileDebugIndexBuffer||f.debugIndexBuffer,de=U._tileDebugSegments||f.debugSegments;if(H.draw(f,P.LINE_STRIP,q,G,Y,Bt.disabled,c_(F,p.toPremultipliedRenderColor(null)),"$debug",ne,le,de,null,null,null,[U._globeTileDebugBorderBuffer]),b){const ye=U.latestRawTileData,je=Math.floor((ye&&ye.byteLength||0)/1024);let Fe=l.canonical.toString();l.overscaledZ!==l.canonical.z&&(Fe+=` => ${l.overscaledZ}`),Fe+=` ${U.state}`,Fe+=` ${je}kb`,function(Ge,rt){Ge.initDebugOverlayCanvas();const De=Ge.debugOverlayCanvas,_e=Ge.context.gl,Ne=Ge.debugOverlayCanvas.getContext("2d");Ne.clearRect(0,0,De.width,De.height),Ne.shadowColor="white",Ne.shadowBlur=2,Ne.lineWidth=1.5,Ne.strokeStyle="white",Ne.textBaseline="top",Ne.font="bold 36px Open Sans, sans-serif",Ne.fillText(rt,5,5),Ne.strokeText(rt,5,5),Ge.debugOverlayTexture.update(De),Ge.debugOverlayTexture.bind(_e.LINEAR,_e.CLAMP_TO_EDGE)}(f,Fe)}const pe=r.getTile(l).tileSize,ae=512/Math.min(pe,512)*(l.overscaledZ/C.zoom)*.5,ce=U._tileDebugTextBuffer||f.debugBuffer,ue=U._tileDebugTextIndexBuffer||f.quadTriangleIndexBuffer,Me=U._tileDebugTextSegments||f.debugSegments;H.draw(f,P.TRIANGLES,q,G,an.alphaBlended,Bt.disabled,c_(F,u.am.transparent.toPremultipliedRenderColor(null),ae),"$debug",ce,ue,Me,null,null,null,[U._globeTileDebugTextBuffer])}function fh(f,r,l,p){za(f,0,r+l/2,f.transform.width,l,p)}function ph(f,r,l,p){za(f,r-l/2,0,l,f.transform.height,p)}function za(f,r,l,p,y,v){const b=f.context,D=b.gl;D.enable(D.SCISSOR_TEST),D.scissor(r*u.q.devicePixelRatio,l*u.q.devicePixelRatio,p*u.q.devicePixelRatio,y*u.q.devicePixelRatio),b.clear({color:v}),D.disable(D.SCISSOR_TEST)}const Es=u.ec([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:p_}=Es;function rc(f,r,l,p){f.emplaceBack(r,l,p)}class Xc{constructor(r){this.vertexArray=new u.eg,this.indices=new u.a_,rc(this.vertexArray,-1,-1,1),rc(this.vertexArray,1,-1,1),rc(this.vertexArray,-1,1,1),rc(this.vertexArray,1,1,1),rc(this.vertexArray,-1,-1,-1),rc(this.vertexArray,1,-1,-1),rc(this.vertexArray,-1,1,-1),rc(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=r.createVertexBuffer(this.vertexArray,p_),this.indexBuffer=r.createIndexBuffer(this.indices),this.segment=u.bd.simpleSegment(0,0,36,12)}}function Do(f,r,l,p,y,v){const b=f.context.gl,D=r.paint.get("sky-atmosphere-color"),C=r.paint.get("sky-atmosphere-halo-color"),P=r.paint.get("sky-atmosphere-sun-intensity"),O=(N=u.ei(u.dJ(),p),F=y,B=P,H=D.toPremultipliedRenderColor(null),U=C.toPremultipliedRenderColor(null),{u_matrix_3f:N,u_sun_direction:F,u_sun_intensity:B,u_color_tint_r:[H.r,H.g,H.b,H.a],u_color_tint_m:[U.r,U.g,U.b,U.a],u_luminance:5e-5});var N,F,B,H,U;b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+v,r.skyboxTexture,0),l.draw(f,b.TRIANGLES,bt.disabled,Vt.disabled,an.unblended,Bt.frontCW,O,"skyboxCapture",r.skyboxGeometry.vertexBuffer,r.skyboxGeometry.indexBuffer,r.skyboxGeometry.segment)}const it=u.ec([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class _t{constructor(r){const l=new u.ej;l.emplaceBack(-1,1,1,0,0),l.emplaceBack(1,1,1,1,0),l.emplaceBack(1,-1,1,1,1),l.emplaceBack(-1,-1,1,0,1);const p=new u.a_;p.emplaceBack(0,1,2),p.emplaceBack(2,3,0),this.vertexBuffer=r.createVertexBuffer(l,it.members),this.indexBuffer=r.createIndexBuffer(p),this.segments=u.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Yc=u.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Ki{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Se{constructor(r){this.colorModeAlphaBlendedWriteRGB=new an([1,771,1,771],u.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new an([1,0,1,0],u.am.transparent,[!1,!1,!1,!0]),this.params=new Ki,this.updateNeeded=!0,r.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),r.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),r.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),r.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(r){const l=r.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new _t(l);const p=this.params.sizeRange,y=this.params.intensityRange,v=function(O){const N=u.el(30),F=[];for(let B=0;B<O;++B){const H=2*Math.PI*N(),U=Math.acos(1-2*N())-.5*Math.PI;F.push(u.d2(Math.cos(U)*Math.cos(H),Math.cos(U)*Math.sin(H),Math.sin(U)))}return F}(this.params.starsCount),b=u.el(300),D=new u.ek,C=new u.a_;let P=0;for(let O=0;O<v.length;++O){const N=u.c1([],v[O],200),F=Math.max(0,1+.01*p*(1*b()-.5)),B=Math.max(0,1+.01*y*(1*b()-.5));D.emplaceBack(N[0],N[1],N[2],-1,-1,F,B),D.emplaceBack(N[0],N[1],N[2],1,-1,F,B),D.emplaceBack(N[0],N[1],N[2],1,1,F,B),D.emplaceBack(N[0],N[1],N[2],-1,1,F,B),C.emplaceBack(P+0,P+1,P+2),C.emplaceBack(P+0,P+2,P+3),P+=4}this.starsVx=l.createVertexBuffer(D,Yc.members),this.starsIdx=l.createIndexBuffer(C),this.starsSegments=u.bd.simpleSegment(0,0,D.length,C.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(r,l){const p=r.context,y=p.gl,v=r.transform,b=new bt(y.LEQUAL,bt.ReadOnly,[0,1]),D=u.ah(v.zoom),C=r.style.getLut(l.scope),P="none"===l.properties.get("color-use-theme"),O=l.properties.get("color").toNonPremultipliedRenderColor(P?null:C).toArray01(),N="none"===l.properties.get("high-color-use-theme"),F=l.properties.get("high-color").toNonPremultipliedRenderColor(N?null:C).toArray01(),B="none"===l.properties.get("space-color-use-theme"),H=l.properties.get("space-color").toNonPremultipliedRenderColor(B?null:C).toArray01(),U=5e-4,q=u.em(l.properties.get("horizon-blend"),0,1,U,.25),G=u.dy(r,p,v)&&q===U?v.worldSize/(2*Math.PI*1.025)-1:v.globeRadius,Y=r.frameCounter/1e3%1,ee=u.ae(v.globeCenterInViewSpace),ne=Math.sqrt(Math.pow(ee,2)-Math.pow(G,2)),le=Math.acos(ne/ee),de=pe=>{const ae="globe"===v.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];pe&&ae.push("ALPHA_PASS");const ce=r.getOrCreateProgram("globeAtmosphere",{defines:ae}),ue={u_frustum_tl:v.frustumCorners.TL,u_frustum_tr:v.frustumCorners.TR,u_frustum_br:v.frustumCorners.BR,u_frustum_bl:v.frustumCorners.BL,u_horizon:v.frustumCorners.horizon,u_transition:D,u_fadeout_range:q,u_color:O,u_high_color:F,u_space_color:H,u_temporal_offset:Y,u_horizon_angle:le};r.uploadCommonUniforms(p,ce);const Me=this.atmosphereBuffer;Me&&ce.draw(r,y.TRIANGLES,b,Vt.disabled,pe?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Bt.backCW,ue,pe?"atmosphere_glow_alpha":"atmosphere_glow",Me.vertexBuffer,Me.indexBuffer,Me.segments)};de(!1),de(!0)}drawStars(r,l){const p=u.ay(l.properties.get("star-intensity"),0,1);if(0===p)return;const y=r.context,v=y.gl,b=r.transform,D=r.getOrCreateProgram("stars"),C=u.c3([]);u.c5(C,C,-b._pitch),u.c4(C,C,-b.angle),u.c5(C,C,u.al(b._center.lat)),u.en(C,C,-u.al(b._center.lng));const P=u.c8(new Float32Array(16),C),O=u.az([],b.starsProjMatrix,P),N=u.ei([],P),F=u.eo([],N),B=[0,1,0];u.dL(B,B,F),u.c1(B,B,this.params.sizeMultiplier);const H=[1,0,0];u.dL(H,H,F),u.c1(H,H,this.params.sizeMultiplier);const U=(q=B,G=H,Y=p,{u_matrix:Float32Array.from(O),u_up:q,u_right:G,u_intensity_multiplier:Y});var q,G,Y;r.uploadCommonUniforms(y,D),this.starsVx&&this.starsIdx&&D.draw(r,v.TRIANGLES,bt.disabled,Vt.disabled,this.colorModeAlphaBlendedWriteRGB,Bt.disabled,U,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class m_{constructor(){this.visibleTiles=[]}updateBorders(r,l){const p=[],y=[],v=r._getRenderableCoordinates(!1,!0);for(const C of v){const P=r.getTile(C);if(!P.hasData())continue;const O=P.getBucket(l);O&&(O.isEmpty()||(p.push(C.key),y.push({bucket:O,tileID:C.canonical})))}let b=p.length!==this.visibleTiles.length;if(!b){p.sort();for(let C=0;C<p.length;C++)if(p[C]!==this.visibleTiles[C]){b=!0;break}}if(!b)return;const D=new Set;this.visibleTiles=p,y.sort((C,P)=>C.tileID.z-P.tileID.z||C.tileID.x-P.tileID.x||C.tileID.y-P.tileID.y);for(const C of y){const P=new Array,O=new Array,N=C.bucket;for(const F of N.featuresOnBorder)D.has(F.featureId)?O.push(F.footprintIndex):(D.add(F.featureId),P.push(F.footprintIndex));N.updateFootprintHiddenFlags(P,u.ep,!1),N.updateFootprintHiddenFlags(O,u.ep,!0)}}}function Sn(f,r){const l=[...f],p=r.cameraWorldSizeForFog/r.worldSize,y=u.bx([]);return u.cP(y,y,[p,p,1]),u.az(l,y,l),u.az(l,r.worldToFogMatrix,l),l}function Ku(f,r,l,p,y){const v=l.material,b=p.context,{baseColorTexture:D,metallicRoughnessTexture:C}=v.pbrMetallicRoughness,{normalTexture:P,occlusionTexture:O,emissionTexture:N}=v;function F(H,U,q){if(H&&(f.push(U),b.activeTexture.set(b.gl.TEXTURE0+q),H.gfxTexture)){const{minFilter:G,magFilter:Y,wrapS:ee,wrapT:ne}=H.sampler;H.gfxTexture.bindExtraParam(G,Y,ee,ne)}}F(D,"HAS_TEXTURE_u_baseColorTexture",Qr.BaseColor),F(C,"HAS_TEXTURE_u_metallicRoughnessTexture",Qr.MetallicRoughness),F(P,"HAS_TEXTURE_u_normalTexture",Qr.Normal),F(O,"HAS_TEXTURE_u_occlusionTexture",Qr.Occlusion),F(N,"HAS_TEXTURE_u_emissionTexture",Qr.Emission),y&&(y.texture||(y.texture=new u.et(p.context,y.image,[y.image.height,y.image.height,y.image.height],b.gl.RGBA8)),b.activeTexture.set(b.gl.TEXTURE0+Qr.LUT),y.texture&&y.texture.bind(b.gl.LINEAR,b.gl.CLAMP_TO_EDGE),f.push("APPLY_LUT_ON_GPU")),l.texcoordBuffer&&(f.push("HAS_ATTRIBUTE_a_uv_2f"),r.push(l.texcoordBuffer)),l.colorBuffer&&(f.push(12===l.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),r.push(l.colorBuffer)),l.normalBuffer&&(f.push("HAS_ATTRIBUTE_a_normal_3f"),r.push(l.normalBuffer)),l.pbrBuffer&&(f.push("HAS_ATTRIBUTE_a_pbr"),f.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),r.push(l.pbrBuffer)),"OPAQUE"!==v.alphaMode&&"MASK"!==v.alphaMode||f.push("UNPREMULT_TEXTURE_IN_SHADER"),v.defined||f.push("DIFFUSE_SHADED");const B=p.shadowRenderer;B&&(f.push("RENDER_SHADOWS","DEPTH_TEXTURE"),B.useNormalOffset&&f.push("NORMAL_OFFSET"))}function mh(f,r,l,p,y,v){const b=l.paint.get("model-opacity").constantOr(1),D=r.context,C=new bt(r.context.gl.LEQUAL,bt.ReadWrite,r.depthRangeFor3D),P=r.transform,O=f.mesh,N=O.material,F=N.pbrMetallicRoughness,B=r.style.fog;let H;H="pixels"===r.transform.projection.zAxisUnit?[...f.nodeModelMatrix]:u.az([],p.zScaleMatrix,f.nodeModelMatrix),u.az(H,p.negCameraPosMatrix,H);const U=u.bi([],H);u.ea(U,U);const q="none"===l.paint.get("model-color-use-theme").constantOr("default"),G=l.paint.get("model-emissive-strength").constantOr(0),Y=$c(new Float32Array(f.worldViewProjection),new Float32Array(H),new Float32Array(U),null,r,b,F.baseColorFactor,N.emissiveFactor,F.metallicFactor,F.roughnessFactor,N,G,l),ee={defines:[]},ne=[],le=r.shadowRenderer;le&&(le.useNormalOffset=!1),Ku(ee.defines,ne,O,r,q?null:l.lut);let de=null;if(B){const ce=Sn(f.nodeModelMatrix,r.transform);if(de=new Float32Array(ce),"globe"!==P.projection.name){const ue=O.aabb.min,Me=O.aabb.max,[ye,je]=B.getOpacityForBounds(ce,ue[0],ue[1],Me[0],Me[1]);ee.overrideFog=ye>=qe||je>=qe}}const pe=xo(r,l.paint.get("model-cutoff-fade-range"));pe.shouldRenderCutoff&&ee.defines.push("RENDER_CUTOFF");const ae=r.getOrCreateProgram("model",ee);r.uploadCommonUniforms(D,ae,null,de,pe),"shadow"!==r.renderPass&&le&&le.setupShadowsFromMatrix(f.nodeModelMatrix,ae),ae.draw(r,D.gl.TRIANGLES,C,y,v,O.material.doubleSided?Bt.disabled:Bt.backCCW,Y,l.id,O.vertexBuffer,O.indexBuffer,O.segments,l.paint,r.transform.zoom,void 0,ne)}function gm(f,r,l,p,y,v,b){let D;D="globe"===f.projection.name?u.er(l,f):[...l],u.az(D,D,r.matrix);const C=u.az([],p,D);if(r.meshes)for(const P of r.meshes){if("BLEND"!==P.material.alphaMode){b.push({mesh:P,depth:0,modelIndex:y,worldViewProjection:C,nodeModelMatrix:D});continue}const O=u.ad([],P.centroid,C);!f.isOrthographic&&O[2]<=0||v.push({mesh:P,depth:O[2],modelIndex:y,worldViewProjection:C,nodeModelMatrix:D})}if(r.children)for(const P of r.children)gm(f,P,l,p,y,v,b)}function Uf(f,r,l,p){const y=l.shadowRenderer;if(!y)return;const v=y.getShadowPassDepthMode(),b=y.getShadowPassColorMode(),D=y.calculateShadowPassMatrixFromMatrix(r),C=qc(D);l.getOrCreateProgram("modelDepth",{defines:l._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(l,l.context.gl.TRIANGLES,v,Vt.disabled,b,Bt.backCCW,C,p.id,f.vertexBuffer,f.indexBuffer,f.segments,p.paint,l.transform.zoom,void 0,void 0)}function Qu(f,r,l){const p=r.updateZoomBasedPaintProperties(),y=function(v,b,D){let C,P,O,N=v.terrain?v.terrain.exaggeration():0;if(v.terrain&&N>0){const F=v.terrain,B=F.findDEMTileFor(D);B&&B.dem?C=u.eu.create(F,D,B):N=0}if(0===N&&(b.terrainElevationMin=0,b.terrainElevationMax=0),N===b.validForExaggeration&&(0===N||C&&C._demTile&&C._demTile.tileID===b.validForDEMTile.id&&C._dem._timestamp===b.validForDEMTile.timestamp))return!1;for(const F in b.instancesPerModel){const B=b.instancesPerModel[F];for(let H=0;H<B.instancedDataArray.length;++H){const U=(C?N*C.getElevationAt(0|B.instancedDataArray.float32[16*H],0|B.instancedDataArray.float32[16*H+1],!0,!0):0)+B.instancesEvaluatedElevation[H];B.instancedDataArray.float32[16*H+6]=U,P=P?Math.min(b.terrainElevationMin,U):U,O=O?Math.max(b.terrainElevationMax,U):U}}return b.terrainElevationMin=P||0,b.terrainElevationMax=O||0,b.validForExaggeration=N,b.validForDEMTile=C&&C._demTile?{id:C._demTile.tileID,timestamp:C._dem._timestamp}:{id:void 0,timestamp:0},!0}(f,r,l);(p||y)&&(r.uploaded=!1,r.upload(f.context))}const ya={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new u.d6([0,0,0],[u.aj,u.aj,0])};function Ju(f,r){const l=1<<f.canonical.z,p=r.getFreeCameraOptions().position,y=r.elevation,v=f.canonical.x/l,b=(f.canonical.x+1)/l,D=f.canonical.y/l,C=(f.canonical.y+1)/l;let P=r._centerAltitude;if(y){const B=y.getMinMaxForTile(f);B&&B.max>P&&(P=B.max)}const O=u.ay(p.x,v,b)-p.x,N=u.ay(p.y,D,C)-p.y,F=u.cb(P,r.center.lat)-p.z;return r._zoomFromMercatorZ(Math.sqrt(O*O+N*N+F*F))}function _m(f,r,l,p,y,v,b){const D=f.context,C="shadow"===f.renderPass,P=f.shadowRenderer,O=C&&P?P.getShadowPassDepthMode():new bt(D.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D),N=f.isTileAffectedByFog(v);if(l.meshes)for(const F of l.meshes){const B=["MODEL_POSITION_ON_GPU"],H=[];let U,q,G;p.instancedDataArray.length>20&&B.push("INSTANCED_ARRAYS");const Y=xo(f,r.paint.get("model-cutoff-fade-range"));if(Y.shouldRenderCutoff&&B.push("RENDER_CUTOFF"),C&&P)U=f.getOrCreateProgram("modelDepth",{defines:B}),q=qc(b.shadowTileMatrix,b.shadowTileMatrix,Float32Array.from(l.matrix)),G=P.getShadowPassColorMode();else{Ku(B,H,F,f,"none"===r.paint.get("model-color-use-theme").constantOr("default")?null:r.lut),U=f.getOrCreateProgram("model",{defines:B,overrideFog:N});const ne=F.material,le=ne.pbrMetallicRoughness,de=r.paint.get("model-opacity").constantOr(1),pe=r.paint.get("model-emissive-strength").constantOr(0);q=$c(v.expandedProjMatrix,Float32Array.from(l.matrix),new Float32Array(16),null,f,de,le.baseColorFactor,ne.emissiveFactor,le.metallicFactor,le.roughnessFactor,ne,pe,r,y),P&&(b.shadowUniformsInitialized?U.setShadowUniformValues(D,P.getShadowUniformValues()):(P.setupShadows(v.toUnwrapped(),U,"model-tile"),b.shadowUniformsInitialized=!0)),G=Y.shouldRenderCutoff||de<1||"OPAQUE"!==ne.alphaMode?an.alphaBlended:an.unblended}f.uploadCommonUniforms(D,U,v.toUnwrapped(),null,Y);const ee=F.material.doubleSided?Bt.disabled:Bt.backCCW;if(p.instancedDataArray.length>20)H.push(p.instancedDataBuffer),U.draw(f,D.gl.TRIANGLES,O,Vt.disabled,G,ee,q,r.id,F.vertexBuffer,F.indexBuffer,F.segments,r.paint,f.transform.zoom,void 0,H,p.instancedDataArray.length);else{const ne=C?"u_instance":"u_normal_matrix";for(let le=0;le<p.instancedDataArray.length;++le)q[ne]=new Float32Array(p.instancedDataArray.arrayBuffer,64*le,16),U.draw(f,D.gl.TRIANGLES,O,Vt.disabled,G,ee,q,r.id,F.vertexBuffer,F.indexBuffer,F.segments,r.paint,f.transform.zoom,void 0,H)}}if(l.children)for(const F of l.children)_m(f,r,F,p,y,v,b)}const Hf=[1,-1,1];function ym(f,r,l,p){if(!l.modelManager)return!0;const y=l.modelManager;if(!l.shadowRenderer)return!0;const v=l.shadowRenderer,b=r.aabb;let D=!0,C=f.maxHeight;if(0===C){let O=0;for(const N in f.instancesPerModel){const F=y.getModel(N,p);F?O=Math.max(O,Math.max(Math.max(F.aabb.max[0],F.aabb.max[1]),F.aabb.max[2])):D=!1}C=f.maxScale*O*1.41+f.maxVerticalOffset,D&&(f.maxHeight=C)}b.max[2]=C,b.min[2]+=f.terrainElevationMin,b.max[2]+=f.terrainElevationMax,u.ad(b.min,b.min,r.tileMatrix),u.ad(b.max,b.max,r.tileMatrix);const P=b.intersects(v.getCurrentCascadeFrustum());return 0===l.currentShadowCascade&&(f.isInsideFirstShadowMapFrustum=2===P),0===P}function g_(f,r){const l=f.uniformValues.u_cutoff_params[0],p=f.uniformValues.u_cutoff_params[1],y=f.uniformValues.u_cutoff_params[2],v=f.uniformValues.u_cutoff_params[3];return p===l||v===y?1:u.ay(((r-l)/(p-l)-y)/(v-y),0,1)}function __(f,r,l,p){if(r.pitch<20)return 1;const y=r.getWorldToCameraMatrix();u.az(y,y,f);const v=u.bR(l.min[0],l.min[1],l.min[2],1);let b=u.aA(u.ev(),v,y),D=b,C=b;v[1]=l.max[1],b=u.aA(u.ev(),v,y),D=b[1]<D[1]?b:D,C=b[1]>C[1]?b:C,v[0]=l.max[0],b=u.aA(u.ev(),v,y),D=b[1]<D[1]?b:D,C=b[1]>C[1]?b:C,v[1]=l.min[1],b=u.aA(u.ev(),v,y),D=b[1]<D[1]?b:D,C=b[1]>C[1]?b:C;const P=u.ay(p[0],0,1),O=100*r.pixelsPerMeter*u.ay(p[1],0,1),N=u.ay(p[2],0,1),F=u.ew(u.ev(),D,C,P),B=Math.tan(.5*r.fovX),H=-F[2]*B;if(0===O)return F[1]<-Math.abs(H)?N:1;const U=(-Math.abs(H)-F[1])/O,q=(Y,ee,ne)=>(1-ne)*Y+ne*ee,G=u.ay(q(1,N,U),N,1);return q(1,G,u.ay((r.pitch-20)/20,0,1))}class At{}class bi{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(r,l,p){{const N=this._storage.get(l.id);if(N)return N.lastUsedFrameIdx=r,N.buf}const y=p.gl,v=y.getBufferParameter(y.ELEMENT_ARRAY_BUFFER,y.BUFFER_SIZE),b=new ArrayBuffer(v),D=new Int16Array(b);y.getBufferSubData(y.ELEMENT_ARRAY_BUFFER,0,new Int16Array(b));const C=new u.ey;for(let N=0;N<v/2;N+=3){const F=D[N],B=D[N+1],H=D[N+2];C.emplaceBack(F,B),C.emplaceBack(B,H),C.emplaceBack(H,F)}const P=p.bindVertexArrayOES.current,O=new At;return O.buf=new Sv(p,C),O.lastUsedFrameIdx=r,this._storage.set(l.id,O),p.bindVertexArrayOES.set(P),O.buf}update(r){for(const[l,p]of this._storage)r-p.lastUsedFrameIdx>30&&(p.buf.destroy(),this._storage.delete(l))}destroy(){for(const[r,l]of this._storage)l.buf.destroy(),this._storage.delete(r)}}class ed{constructor(r){this.occluderSize=30,this.depthOffset=-1e-4,r.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),r.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const y_=u.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class ko{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class So{constructor(r,l){this.revealStart=11,this.revealRange=2,r.registerParameter(this,[...l,"Reveal"],"revealStart",{min:0,max:17,step:.05}),r.registerParameter(this,[...l,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const gh=u.ec([{type:"Float32",name:"a_pos_2f",components:2}]);class Ts{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(r,l){const p=r.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const b=new u.ez,D=new u.a_;b.emplaceBack(-1,-1),b.emplaceBack(1,-1),b.emplaceBack(1,1),b.emplaceBack(-1,1),D.emplaceBack(0,1,2),D.emplaceBack(0,2,3),this.vignetteVx=r.context.createVertexBuffer(b,gh.members),this.vignetteIdx=r.context.createIndexBuffer(D)}const y=u.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){r.uploadCommonUniforms(r.context,p);const b={u_vignetteShape:(v={vignetteShape:[l.start,l.range,Math.pow(10,l.fadePower)],vignetteColor:[l.color.r,l.color.g,l.color.b,l.color.a*l.strength]}).vignetteShape,u_vignetteColor:v.vignetteColor};p.draw(r,r.context.gl.TRIANGLES,bt.disabled,Vt.disabled,an.alphaBlended,Bt.disabled,b,"vignette",this.vignetteVx,this.vignetteIdx,y)}var v}}class wi{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(r,l){const p=r.getFreeCameraOptions().position,y=p.toAltitude(),v=p.toLngLat(),b=u.al(v.lng),D=u.al(v.lat),C=r.pixelsPerMeter/l,P=b*u.eB,O=u.eB*Math.log(Math.tan(Math.PI/4+D/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const N=-this._offsetYPrev+O,F=-this._elevationPrev+y;this._accumulatedOffsetX+=(-this._offsetXPrev+P)*C,this._accumulatedOffsetY+=N*C,this._accumulatedElevation+=F*C,this._offsetXPrev=P,this._offsetYPrev=O,this._elevationPrev=y}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function En(f,r){return[-(f[0]-Math.floor(f[0]/r)*r),-(f[1]-Math.floor(f[1]/r)*r),-(f[2]-Math.floor(f[2]/r)*r)]}function vm(f){const r=u.el(1323123451230),l=[];for(let p=0;p<f;++p){const y=2*r()-1,v=2*r()-1,b=2*r()-1;l.push(u.d2(y,v,b))}return l}function Ds(f,r,l,p,y){const v=u.ay((y-l)/(p-l),0,1);return(1-v)*f+v*r}class Kc{constructor(r){this._movement=new wi,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Ts,this._ppmScaleFactor=r}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(r,l){const p=r.transform;this._movement.update(p,this._ppmScaleFactor);const y=p.starsProjMatrix,v=u.c3([]);u.c5(v,v,u.al(90)-p._pitch),u.c4(v,v,-p.angle);const b=u.c8(new Float32Array(16),v),D=u.eA(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),C=u.ea([],D),P=u.az([],C,b),O=Date.now()/1e3;return this._accumulatedTimeFromStart+=(O-this._prevTime)*l,this._prevTime=O,{projectionMatrix:y,modelviewMatrix:P}}}class to extends Kc{constructor(r){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new So(r.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(r){const l=r.context;if(!this.particlesVx){const p=vm(this.particlesCount),y=new u.eC,v=new u.a_;let b=0;const D=u.el(1323123451230);for(let C=0;C<p.length;++C){const P=p[C],O=[2*D()-1,D(),D(),D()];y.emplaceBack(P[0],P[1],P[2],-1,-1,...O),y.emplaceBack(P[0],P[1],P[2],1,-1,...O),y.emplaceBack(P[0],P[1],P[2],1,1,...O),y.emplaceBack(P[0],P[1],P[2],-1,1,...O),v.emplaceBack(b+0,b+1,b+2),v.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=l.createVertexBuffer(y,y_.members),this.particlesIdx=l.createIndexBuffer(v)}}draw(r){if(!this._params.overrideStyleParameters&&!r.style.rain)return;const l=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},p=r.transform.zoom;if(l.revealStart>p)return;const y=Ds(0,1,l.revealStart,l.revealStart+l.revealRange,p);if(!this.particlesVx||!this.particlesIdx)return;const v=structuredClone(this._params);let b=[-v.direction.x,v.direction.y,-100];u.au(b,b);const D=structuredClone(this._vignetteParams);D.strength*=y,v.overrideStyleParameters||(v.intensity=r.style.rain.state.density,v.timeFactor=r.style.rain.state.intensity,v.color=structuredClone(r.style.rain.state.color),b=structuredClone(r.style.rain.state.direction),v.screenThinning.intensity=r.style.rain.state.centerThinning,v.dropletSizeX=r.style.rain.state.dropletSize[0],v.dropletSizeYScale=r.style.rain.state.dropletSize[1]/r.style.rain.state.dropletSize[0],v.distortionStrength=100*r.style.rain.state.distortionStrength,D.strength=1,D.color=structuredClone(r.style.rain.state.vignetteColor));const C=this.updateOnRender(r,v.timeFactor),P=r.context,O=P.gl,N=r.transform;this.screenTexture&&this.screenTexture.size[0]===r.width&&this.screenTexture.size[1]===r.height||(this.screenTexture=new u.T(P,{width:r.width,height:r.height,data:null},O.RGBA8)),v.distortionStrength>0&&(P.activeTexture.set(O.TEXTURE0),this.screenTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),O.copyTexSubImage2D(O.TEXTURE_2D,0,0,0,0,0,r.width,r.height));const F=r.getOrCreateProgram("rainParticle");r.uploadCommonUniforms(P,F),P.activeTexture.set(O.TEXTURE0),this.screenTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE);const B=[v.color.r,v.color.g,v.color.b,v.color.a],H=(U,q)=>{const G=En(this._movement.getPosition(),U),Y=v.dropletSizeX,ee=v.dropletSizeX*v.dropletSizeYScale,ne=r.width/2,le=r.height/2,de=Ds(0,v.screenThinning.start,0,1,v.screenThinning.intensity),pe=Ds(.001,v.screenThinning.range,0,1,v.screenThinning.intensity),ae=Ds(0,v.screenThinning.particleOffset,0,1,v.screenThinning.intensity),ce=(ue={modelview:C.modelviewMatrix,projection:C.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:G,velocityConeAperture:v.velocityConeAperture,velocity:v.velocity,boxSize:U,rainDropletSize:[Y,ee],distortionStrength:v.distortionStrength,rainDirection:b,color:B,screenSize:[N.width,N.height],thinningCenterPos:[ne,le],thinningShape:[de,pe,Math.pow(10,v.screenThinning.fadePower)],thinningAffectedRatio:v.screenThinning.affectedRatio,thinningParticleOffset:ae,shapeDirectionalPower:v.shapeDirPower,shapeNormalPower:v.shapeNormalPower,mode:q?0:1},{u_modelview:Float32Array.from(ue.modelview),u_projection:Float32Array.from(ue.projection),u_time:ue.time,u_cam_pos:ue.camPos,u_texScreen:0,u_velocityConeAperture:ue.velocityConeAperture,u_velocity:ue.velocity,u_boxSize:ue.boxSize,u_rainDropletSize:ue.rainDropletSize,u_distortionStrength:ue.distortionStrength,u_rainDirection:ue.rainDirection,u_color:ue.color,u_screenSize:ue.screenSize,u_thinningCenterPos:ue.thinningCenterPos,u_thinningShape:ue.thinningShape,u_thinningAffectedRatio:ue.thinningAffectedRatio,u_thinningParticleOffset:ue.thinningParticleOffset,u_shapeDirectionalPower:ue.shapeDirectionalPower,u_shapeNormalPower:ue.shapeNormalPower,u_mode:ue.mode});var ue;const Me=Math.round(v.intensity*this.particlesCount),ye=u.bd.simpleSegment(0,0,4*Me,2*Me);F.draw(r,O.TRIANGLES,bt.disabled,Vt.disabled,an.alphaBlended,Bt.disabled,ce,"rain_particles",this.particlesVx,this.particlesIdx,ye)};v.distortionStrength>0&&H(v.boxSize,!0),H(v.boxSize,!1),this._vignette.draw(r,D)}}const ds=u.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class Gf extends Kc{constructor(r){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new So(r.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(r){const l=r.context;if(!this.particlesVx){const p=vm(this.particlesCount),y=new u.eD,v=new u.a_;let b=0;const D=u.el(1323123451230);for(let C=0;C<p.length;++C){const P=p[C],O=D(),N=D(),F=D(),B=[C/p.length,O,N,F],H=[D(),D()];y.emplaceBack(P[0],P[1],P[2],-1,-1,...B,...H),y.emplaceBack(P[0],P[1],P[2],1,-1,...B,...H),y.emplaceBack(P[0],P[1],P[2],1,1,...B,...H),y.emplaceBack(P[0],P[1],P[2],-1,1,...B,...H),v.emplaceBack(b+0,b+1,b+2),v.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=l.createVertexBuffer(y,ds.members),this.particlesIdx=l.createIndexBuffer(v)}}draw(r){if(!this._params.overrideStyleParameters&&!r.style.snow)return;const l=structuredClone(this._params);let p=[-l.direction.x,l.direction.y,-100];u.au(p,p);const y=structuredClone(this._vignetteParams),v=l.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},b=r.transform.zoom;if(v.revealStart>b)return;const D=Ds(0,1,v.revealStart,v.revealStart+v.revealRange,b);y.strength*=D,l.overrideStyleParameters||(l.intensity=r.style.snow.state.density,l.timeFactor=r.style.snow.state.intensity,l.color=structuredClone(r.style.snow.state.color),p=structuredClone(r.style.snow.state.direction),l.screenThinning.intensity=r.style.snow.state.centerThinning,l.billboardSize=2.79*r.style.snow.state.flakeSize,y.strength=1,y.color=structuredClone(r.style.snow.state.vignetteColor));const C=this.updateOnRender(r,l.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const P=r.context,O=P.gl,N=r.transform,F=r.getOrCreateProgram("snowParticle");r.uploadCommonUniforms(P,F),((B,H,U)=>{const q=En(this._movement.getPosition(),B),G=N.width/2,Y=N.height/2,ee=Ds(0,U.screenThinning.start,0,1,U.screenThinning.intensity),ne=Ds(.001,U.screenThinning.range,0,1,U.screenThinning.intensity),le=Ds(0,U.screenThinning.particleOffset,0,1,U.screenThinning.intensity),de=(pe={modelview:C.modelviewMatrix,projection:C.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:q,velocityConeAperture:U.velocityConeAperture,velocity:U.velocity,horizontalOscillationRadius:U.horizontalOscillationRadius,horizontalOscillationRate:U.horizontalOscillationRate,boxSize:B,billboardSize:1*U.billboardSize,simpleShapeParameters:[U.shapeFadeStart,U.shapeFadePower],screenSize:[N.width,N.height],thinningCenterPos:[G,Y],thinningShape:[ee,ne,Math.pow(10,U.screenThinning.fadePower)],thinningAffectedRatio:U.screenThinning.affectedRatio,thinningParticleOffset:le,color:[U.color.r,U.color.g,U.color.b,U.color.a],direction:p},{u_modelview:Float32Array.from(pe.modelview),u_projection:Float32Array.from(pe.projection),u_time:pe.time,u_cam_pos:pe.camPos,u_velocityConeAperture:pe.velocityConeAperture,u_velocity:pe.velocity,u_horizontalOscillationRadius:pe.horizontalOscillationRadius,u_horizontalOscillationRate:pe.horizontalOscillationRate,u_boxSize:pe.boxSize,u_billboardSize:pe.billboardSize,u_simpleShapeParameters:pe.simpleShapeParameters,u_screenSize:pe.screenSize,u_thinningCenterPos:pe.thinningCenterPos,u_thinningShape:pe.thinningShape,u_thinningAffectedRatio:pe.thinningAffectedRatio,u_thinningParticleOffset:pe.thinningParticleOffset,u_particleColor:pe.color,u_direction:pe.direction});var pe;const ae=Math.round(U.intensity*this.particlesCount),ce=u.bd.simpleSegment(0,0,4*ae,2*ae);this.particlesVx&&this.particlesIdx&&F.draw(r,O.TRIANGLES,bt.disabled,Vt.disabled,an.alphaBlended,Bt.disabled,de,"snow_particles",this.particlesVx,this.particlesIdx,ce)})(l.boxSize,0,l),this._vignette.draw(r,y)}}const oc={symbol:function(f,r,l,p,y){if("translucent"!==f.renderPass)return;const v=Vt.disabled,b=f.colorModeForRenderPass(),D=l.layout.get("text-variable-anchor"),C=l.layout.get("text-size-scale-range"),P=u.ay(f.scaleFactor,C[0],C[1]);D&&function(F,B,H,U,q,G,Y,ee){const ne=B.transform,le="map"===q,de="map"===G;for(const pe of F){const ae=U.getTile(pe),ce=ae.getBucket(H);if(!ce||!ce.text||!ce.text.segments.get().length)continue;const ue=u.bH(ce.textSizeData,ne.zoom,ee),Me=Wp(pe,ce.getProjection(),ne),ye=ne.calculatePixelsToTileUnitsMatrix(ae),je=qd(Me,ae.tileID.canonical,de,le,ne,ce.getProjection(),ye),Fe=ce.hasIconTextFit()&&ce.hasIconData();ue&&Cv(ce,le,de,Y,ne,je,pe,Math.pow(2,ne.zoom-ae.tileID.overscaledZ),ue,Fe)}}(p,f,l,r,l.layout.get("text-rotation-alignment"),l.layout.get("text-pitch-alignment"),y,P);const O=0!==l.paint.get("icon-opacity").constantOr(1),N=0!==l.paint.get("text-opacity").constantOr(1);void 0!==l.layout.get("symbol-sort-key").constantOr(1)&&(O||N)?h_(f,r,l,p,v,b):(O&&h_(f,r,l,p,v,b,{onlyIcons:!0}),N&&h_(f,r,l,p,v,b,{onlyText:!0})),r.map.showCollisionBoxes&&(Ff(f,r,l,p,l.paint.get("text-translate"),l.paint.get("text-translate-anchor"),!0),Ff(f,r,l,p,l.paint.get("icon-translate"),l.paint.get("icon-translate-anchor"),!1))},circle:function(f,r,l,p){if("translucent"!==f.renderPass)return;const y=l.paint.get("circle-opacity"),v=l.paint.get("circle-stroke-width"),b=l.paint.get("circle-stroke-opacity"),D=void 0!==l.layout.get("circle-sort-key").constantOr(1),C=l.paint.get("circle-emissive-strength");if(0===y.constantOr(1)&&(0===v.constantOr(1)||0===b.constantOr(1)))return;const P=f.context,O=P.gl,N=f.transform,F=!(!f.terrain||!f.terrain.enabled),B=l.layout.get("circle-elevation-reference"),H=f.depthModeForSublayer(0,bt.ReadOnly),U=new bt(f.context.gl.LEQUAL,bt.ReadOnly,f.depthRangeFor3D),q="none"===B||F?H:U,G=Vt.disabled,Y=f.colorModeForDrapableLayerRenderPass(C),ee="globe"===N.projection.name,ne=[u.aD(N.center.lng),u.aH(N.center.lat)],le=[];for(let pe=0;pe<p.length;pe++){const ae=p[pe],ce=r.getTile(ae),ue=ce.getBucket(l);if(!ue||ue.projection.name!==N.projection.name)continue;const Me=ue.programConfigurations.get(l.id),ye=ue.layoutVertexBuffer,je=ue.globeExtVertexBuffer,Fe=ue.indexBuffer,Ge=u.dW(l),rt=[je],De=f.isTileAffectedByFog(ae);ee&&Ge.push("PROJECTION_GLOBE_VIEW"),Ge.push("DEPTH_D24"),f.terrain&&N.depthOcclusionForSymbolsAndCircles&&Ge.push("DEPTH_OCCLUSION"),ue.hasElevation&&!f.terrain&&(Ge.push("ELEVATED_ROADS"),rt.push(ue.elevatedLayoutVertexBuffer));const _e=f.getOrCreateProgram("circle",{config:Me,defines:Ge,overrideFog:De}),Ne=N.projection.createInversionMatrix(N,ae.canonical),Re={programConfiguration:Me,program:_e,layoutVertexBuffer:ye,dynamicBuffers:rt,indexBuffer:Fe,uniformValues:u.dX(f,ae,ce,Ne,ne,l),tile:ce};if(D){const We=ue.segments.get();for(const Ze of We)le.push({segments:new u.bd([Ze]),sortKey:Ze.sortKey,state:Re})}else le.push({segments:ue.segments,sortKey:0,state:Re})}D&&le.sort((pe,ae)=>pe.sortKey-ae.sortKey);const de={useDepthForOcclusion:N.depthOcclusionForSymbolsAndCircles};for(const pe of le){const{programConfiguration:ae,program:ce,layoutVertexBuffer:ue,dynamicBuffers:Me,indexBuffer:ye,uniformValues:je,tile:Fe}=pe.state,Ge=pe.segments;f.terrain&&f.terrain.setupElevationDraw(Fe,ce,de),f.uploadCommonUniforms(P,ce,Fe.tileID.toUnwrapped()),ce.draw(f,O.TRIANGLES,q,G,Y,Bt.disabled,je,l.id,ue,ye,Ge,l.paint,N.zoom,ae,Me)}},heatmap:function(f,r,l,p){if(0!==l.paint.get("heatmap-opacity"))if("offscreen"===f.renderPass){const y=f.context,v=y.gl,b=Vt.disabled,D=new an([v.ONE,v.ONE,v.ONE,v.ONE],u.am.transparent,[!0,!0,!0,!0]);(function(B,H,U,q){const G=B.gl,Y=H.width*q,ee=H.height*q;B.activeTexture.set(G.TEXTURE1),B.viewport.set([0,0,Y,ee]);let ne=U.heatmapFbo;if(!ne||ne&&(ne.width!==Y||ne.height!==ee)){ne&&ne.destroy();const le=G.createTexture();G.bindTexture(G.TEXTURE_2D,le),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_WRAP_S,G.CLAMP_TO_EDGE),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_WRAP_T,G.CLAMP_TO_EDGE),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_MIN_FILTER,G.LINEAR),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_MAG_FILTER,G.LINEAR),ne=U.heatmapFbo=B.createFramebuffer(Y,ee,!0,null),function(de,pe,ae,ce,ue,Me){const ye=de.gl;ye.texImage2D(ye.TEXTURE_2D,0,de.extRenderToTextureHalfFloat?ye.RGBA16F:ye.RGBA,ue,Me,0,ye.RGBA,de.extRenderToTextureHalfFloat?ye.HALF_FLOAT:ye.UNSIGNED_BYTE,null),ce.colorAttachment.set(ae)}(B,0,le,ne,Y,ee)}else G.bindTexture(G.TEXTURE_2D,ne.colorAttachment.get()),B.bindFramebuffer.set(ne.framebuffer)})(y,f,l,"globe"===f.transform.projection.name?.5:.25),y.clear({color:u.am.transparent});const C=f.transform,P="globe"===C.projection.name,O=P?["PROJECTION_GLOBE_VIEW"]:[],N=P?Bt.frontCCW:Bt.disabled,F=[u.aD(C.center.lng),u.aH(C.center.lat)];for(let B=0;B<p.length;B++){const H=p[B];if(r.hasRenderableParent(H))continue;const U=r.getTile(H),q=U.getBucket(l);if(!q||q.projection.name!==C.projection.name)continue;const G=f.isTileAffectedByFog(H),Y=q.programConfigurations.get(l.id),ee=f.getOrCreateProgram("heatmap",{config:Y,defines:O,overrideFog:G}),{zoom:ne}=f.transform;f.terrain&&f.terrain.setupElevationDraw(U,ee),f.uploadCommonUniforms(y,ee,H.toUnwrapped());const le=C.projection.createInversionMatrix(C,H.canonical);ee.draw(f,v.TRIANGLES,bt.disabled,b,D,N,lh(f,H,U,le,F,ne,l.paint.get("heatmap-intensity")),l.id,q.layoutVertexBuffer,q.indexBuffer,q.segments,l.paint,f.transform.zoom,Y,P?[q.globeExtVertexBuffer]:null)}y.viewport.set([0,0,f.width,f.height])}else"translucent"===f.renderPass&&(f.context.setColorMode(f.colorModeForRenderPass()),function(y,v){const b=y.context,D=b.gl,C=v.heatmapFbo;if(!C)return;b.activeTexture.set(D.TEXTURE0),D.bindTexture(D.TEXTURE_2D,C.colorAttachment.get()),b.activeTexture.set(D.TEXTURE1);let P=v.colorRampTexture;P||(P=v.colorRampTexture=new u.T(b,v.colorRamp,D.RGBA8)),P.bind(D.LINEAR,D.CLAMP_TO_EDGE),y.getOrCreateProgram("heatmapTexture").draw(y,D.TRIANGLES,bt.disabled,Vt.disabled,y.colorModeForRenderPass(),Bt.disabled,{u_image:0,u_color_ramp:1,u_opacity:v.paint.get("heatmap-opacity")},v.id,y.viewportBuffer,y.quadTriangleIndexBuffer,y.viewportSegments,v.paint,y.transform.zoom)}(f,l))},line:function(f,r,l,p){if("translucent"!==f.renderPass)return;const y=l.paint.get("line-opacity"),v=l.paint.get("line-width");if(0===y.constantOr(1)||0===v.constantOr(1))return;const b=l.paint.get("line-emissive-strength"),D=l.paint.get("line-occlusion-opacity"),C=l.layout.get("line-elevation-reference"),P="meters"===l.layout.get("line-width-unit"),O="sea"===C,N=!(!f.terrain||!f.terrain.enabled),F=f.context,B=F.gl;if(l.hasElevatedBuckets&&"globe"===f.transform.projection.name)return;const H=l.layout.get("line-cross-slope"),U=void 0!==H,q=H<1,G=f.colorModeForDrapableLayerRenderPass(b),Y=f.terrain&&f.terrain.renderingToTexture,ee=Y?1:u.q.devicePixelRatio,ne=l.paint.get("line-dasharray"),le=ne.constantOr(1),de=l.layout.get("line-cap"),pe=ne.constantOr(null),ae=de.constantOr(null),ce=l.paint.get("line-pattern"),ue=ce.constantOr(1),Me=l.paint.get("line-pattern-cross-fade"),ye=ce.constantOr(null),je=l.paint.get("line-opacity").constantOr(1);let Fe=!ue&&1!==je||f.depthOcclusion&&D>0&&D<1;const Ge=l.paint.get("line-gradient"),rt=ue?"linePattern":"line",De=u.dY(l);let _e;if(Y&&f.terrain&&f.terrain.clipOrMaskOverlapStencilType()&&(Fe=!1),0!==D&&f.depthOcclusion){const Ze=l.paint._values["line-opacity"];Ze&&Ze.value&&"constant"===Ze.value.kind?_e=Ze.value:u.w(`Occlusion opacity for layer ${l.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==v.value.kind&&!1===v.value.isLineProgressConstant&&De.push("VARIABLE_LINE_WIDTH");const Ne=(Ze,Ye,ct,Mt,kt,vt)=>{for(const Ot of Ze){const Pt=r.getTile(Ot);if(ue&&!Pt.patternsLoaded())continue;const Wt=Pt.getBucket(l);if(!Wt||"none"!==Wt.elevationType&&!kt||"none"===Wt.elevationType&&kt)continue;f.prepareDrawTile();const en=[...Ye],mn=f.shadowRenderer,Cn="road"===Wt.elevationType&&!!mn&&mn.enabled;let Yt=[0,0,0];if(Cn){const Pn=f.style.directionalLight,Wn=f.style.ambientLight;Pn&&Wn&&(Yt=nl(f.style,Pn,Wn)),en.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const Mn=Wt.programConfigurations.get(l.id);let kn=!1;if(ye&&Pt.imageAtlas){const Pn=u.dZ.from(ye),Wn=Pn.getPrimary().scaleSelf(ee).toString(),di=Pt.imageAtlas.patternPositions.get(Wn),xr=Pn.getSecondary(),hr=xr?Pt.imageAtlas.patternPositions.get(xr.scaleSelf(ee).toString()):null;kn=!!di&&!!hr,di&&Mn.setConstantPatternPositions(di,hr)}Me>0&&(kn||Mn.getPatternTransitionVertexBuffer("line-pattern"))&&en.push("LINE_PATTERN_TRANSITION");const ti=f.isTileAffectedByFog(Ot),un=f.getOrCreateProgram(rt,{config:Mn,defines:en,overrideFog:ti});if(!ue&&pe&&ae&&Pt.lineAtlas){const Pn=Pt.lineAtlas.getDash(pe,ae);Pn&&Mn.setConstantPatternPositions(Pn)}Cn&&mn.setupShadows(Pt.tileID.toUnwrapped(),un,"vector-tile");let[Ln,zn]=l.paint.get("line-trim-offset");("round"===ae||"square"===ae)&&Ln!==zn&&(0===Ln&&(Ln-=1),1===zn&&(zn+=1));const In=Y?Ot.projMatrix:null,sn=P?1/Wt.tileToMeter/u.aw(Pt,1,f.transform.zoom):1,ni=P?1/Wt.tileToMeter/u.aw(Pt,1,Math.floor(f.transform.zoom)):1,$n=ue?u.d_(f,Pt,l,In,ee,sn,ni,[Ln,zn],Yt,Me):u.d$(f,Pt,l,In,Wt.lineClipsArray.length,ee,sn,ni,[Ln,zn],Yt);if(Ge){const Pn=Wt.gradients[l.id];let Wn=Pn.texture;if(l.gradientVersion!==Pn.version){let di=256;if(l.stepInterpolant){const xr=r.getSource().maxzoom,hr=Ot.canonical.z===xr?Math.ceil(1<<f.transform.maxZoom-Ot.canonical.z):1;di=u.ay(u.e0(Wt.maxLineLength/u.aj*1024*hr),256,F.maxTextureSize)}Pn.gradient=u.e1({expression:l.gradientExpression(),evaluationKey:"lineProgress",resolution:di,image:Pn.gradient||void 0,clips:Wt.lineClipsArray}),Pn.texture?Pn.texture.update(Pn.gradient):Pn.texture=new u.T(F,Pn.gradient,B.RGBA8),Pn.version=l.gradientVersion,Wn=Pn.texture}F.activeTexture.set(B.TEXTURE1),Wn.bind(l.stepInterpolant?B.NEAREST:B.LINEAR,B.CLAMP_TO_EDGE)}le&&(F.activeTexture.set(B.TEXTURE0),Pt.lineAtlasTexture&&Pt.lineAtlasTexture.bind(B.LINEAR,B.REPEAT),Mn.updatePaintBuffers()),ue&&(F.activeTexture.set(B.TEXTURE0),Pt.imageAtlasTexture&&Pt.imageAtlasTexture.bind(B.LINEAR,B.CLAMP_TO_EDGE),Mn.updatePaintBuffers()),kt&&!O&&f.terrain.setupElevationDraw(Pt,un),f.uploadCommonUniforms(F,un,Ot.toUnwrapped());const Ni=Pn=>{null!=_e&&(_e.value=je*D),un.draw(f,B.TRIANGLES,ct,Pn,G,Bt.disabled,$n,l.id,Wt.layoutVertexBuffer,Wt.indexBuffer,Wt.segments,l.paint,f.transform.zoom,Mn,[Wt.layoutVertexBuffer2,Wt.patternVertexBuffer,Wt.zOffsetVertexBuffer]),null!=_e&&(_e.value=je)};if(Fe&&!kt){const Pn=f.stencilModeForClipping(Ot).ref;0===Pn&&Y&&F.clear({stencil:0});const Wn={func:B.EQUAL,mask:255};$n.u_alpha_discard_threshold=.8,Ni(new Vt(Wn,Pn,255,B.KEEP,B.KEEP,B.INVERT)),$n.u_alpha_discard_threshold=0,Ni(new Vt(Wn,Pn,255,B.KEEP,B.KEEP,B.KEEP))}else $n.u_alpha_discard_threshold=Fe&&kt&&vt?.8:0,Ni(kt?Mt:f.stencilModeForClipping(Ot))}};let Re=f.depthModeForSublayer(0,bt.ReadOnly);const We=new bt(f.depthOcclusion?B.GREATER:B.LEQUAL,bt.ReadOnly,f.depthRangeFor3D);if(l.hasNonElevatedBuckets){const Ze=!Y&&f.terrain;0!==D&&Ze?u.w(`Occlusion opacity for layer ${l.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ze?u.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${l.id}.`):Ne(p,De,Re,Vt.disabled,!1,!0)}if(l.hasElevatedBuckets){"hd-road-markup"===C?N||(Re=We,De.push("ELEVATED_ROADS")):(De.push("ELEVATED"),Re=We,U&&De.push(q?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),O&&De.push("ELEVATION_REFERENCE_SEA"));const Ze=Fe?f.stencilModeFor3D():Vt.disabled;f.forceTerrainMode=!0,Ne(p,De,Re,Ze,!0,!0),Fe&&Ne(p,De,Re,Ze,!0,!1),f.forceTerrainMode=!1}Fe&&(f.resetStencilClippingMasks(),Y&&F.clear({stencil:0})),0===D||f.depthOcclusion||Y||f.layersWithOcclusionOpacity.push(f.currentLayer)},fill:function(f,r,l,p){const y=l.paint.get("fill-color"),v=l.paint.get("fill-opacity");if(0===v.constantOr(1))return;const b=l.paint.get("fill-emissive-strength"),D=f.colorModeForDrapableLayerRenderPass(b),C=l.paint.get("fill-pattern"),P=f.opaquePassEnabledForLayer()&&!C.constantOr(1)&&1===y.constantOr(u.am.transparent).a&&1===v.constantOr(0)?"opaque":"translucent";let O="none";"none"!==l.layout.get("fill-elevation-reference")?O="road":0!==l.paint.get("fill-z-offset").constantOr(1)&&(O="offset");const N=!(!f.terrain||!f.terrain.enabled),F={painter:f,sourceCache:r,layer:l,coords:p,colorMode:D,elevationType:O,terrainEnabled:N,pass:P};if("shadow"!==f.renderPass)if("offset"!==O){if(kf(F,!1),"road"===O){const B=!N&&"translucent"===f.renderPass;B&&Et(f,r,l,p,"geometry"),kf(F,!0,Vt.disabled),B&&function(H){const{painter:U,sourceCache:q,layer:G,coords:Y,colorMode:ee}=H,ne=U.context.gl,le=H.painter.shadowRenderer,de=!!le&&le.enabled,pe=new bt(U.context.gl.LEQUAL,bt.ReadOnly,U.depthRangeFor3D);let ae=[0,0,0];if(de){const ue=U.style.directionalLight,Me=U.style.ambientLight;ue&&Me&&(ae=nl(U.style,ue,Me))}const ce=ue=>{for(const Me of Y){const ye=q.getTile(Me),je=ye.getBucket(G);if(!je)continue;const Fe=je.elevatedStructures;if(!Fe)continue;let Ge,rt;if(ue?(Ge=Fe.renderableBridgeSegments,rt=Fe.bridgeProgramConfigurations.get(G.id)):(Ge=Fe.renderableTunnelSegments,rt=Fe.tunnelProgramConfigurations.get(G.id)),!Ge||0===Ge.segments[0].primitiveLength)continue;rt.updatePaintBuffers(),U.prepareDrawTile();const De=U.isTileAffectedByFog(Me),_e=[];de&&_e.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Ne=U.getOrCreateProgram("elevatedStructures",{config:rt,overrideFog:De,defines:_e}),Re=U.translatePosMatrix(Me.projMatrix,ye,G.paint.get("fill-translate"),G.paint.get("fill-translate-anchor"));de&&le.setupShadows(ye.tileID.toUnwrapped(),Ne,"vector-tile");const We=Kx(Re,ae);U.uploadCommonUniforms(U.context,Ne,Me.toUnwrapped()),Ne.draw(U,ne.TRIANGLES,pe,Vt.disabled,ee,Bt.backCCW,We,G.id,Fe.vertexBuffer,Fe.indexBuffer,Ge,G.paint,U.transform.zoom,rt,[Fe.vertexBufferNormal])}};ce(!0),ce(!1)}(F)}}else kf(F,!1,f.stencilModeFor3D());else f.shadowRenderer&&"road"===O&&!N&&function(B){const{painter:H,sourceCache:U,layer:q,coords:G}=B,Y=H.context.gl,ee=B.painter.shadowRenderer;for(const ne of G){const le=U.getTile(ne),de=le.getBucket(q);if(!de)continue;const pe=de.elevatedStructures;if(!pe||!pe.shadowCasterSegments||0===pe.shadowCasterSegments.segments[0].primitiveLength)continue;H.prepareDrawTile();const ae=de.bufferData.programConfigurations.get(q.id),ce=H.isTileAffectedByFog(ne),ue=H.getOrCreateProgram("elevatedStructuresDepth",{config:ae,overrideFog:ce}),Me=ee.calculateShadowPassMatrixFromTile(le.tileID.toUnwrapped());H.uploadCommonUniforms(H.context,ue,ne.toUnwrapped());const ye={u_matrix:Me,u_depth_bias:0};ue.draw(H,Y.TRIANGLES,ee.getShadowPassDepthMode(),Vt.disabled,ee.getShadowPassColorMode(),Bt.disabled,ye,q.id,pe.vertexBuffer,pe.indexBuffer,pe.shadowCasterSegments,q.paint,H.transform.zoom,ae)}}(F)},"fill-extrusion":function(f,r,l,p){const y=l.paint.get("fill-extrusion-opacity"),v=f.context,b=v.gl,D=f.terrain,C=D&&D.renderingToTexture;if(0===y)return;const P=f.conflationActive&&f.style.isLayerClipped(l,r.getSource()),O=f.style.order.indexOf(l.fqid);if(P&&function(N,F,B,H,U){for(const q of H){const G=F.getTile(q).getBucket(B);G&&(G.updateReplacement(q,N.replacementSource,U),G.uploadCentroid(N.context))}}(f,r,l,p,O),D||P)for(const N of p){const F=r.getTile(N).getBucket(l);F&&jt(f.context,r,N,F,l,D,P)}if("shadow"===f.renderPass&&f.shadowRenderer){const N=f.shadowRenderer;if(D&&y<.65&&l._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof u.ab)return;const F=N.getShadowPassDepthMode(),B=N.getShadowPassColorMode();hh(f,r,l,p,F,Vt.disabled,B,P)}else if("translucent"===f.renderPass){const N=!l.paint.get("fill-extrusion-pattern").constantOr(1),F=l.paint.get("fill-extrusion-color").constantOr(u.am.white);if(!C&&0!==F.a){const B=new bt(f.context.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D);1===y&&N?hh(f,r,l,p,B,Vt.disabled,an.unblended,P):(hh(f,r,l,p,B,Vt.disabled,an.disabled,P),hh(f,r,l,p,B,f.stencilModeFor3D(),f.colorModeForRenderPass(),P),f.resetStencilClippingMasks())}if(f.style.enable3dLights()&&N&&(!D&&"globe"!==f.transform.projection.name||C)){const B=l.paint.get("fill-extrusion-opacity"),H=l.paint.get("fill-extrusion-ambient-occlusion-intensity"),U=l.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),q=l.paint.get("fill-extrusion-flood-light-intensity"),G="none"===l.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),Y=l.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(G?null:l.lut).toArray01().slice(0,3),ee=H>0&&U>0,ne=q>0,le=(ae,ce,ue)=>(1-ue)*ae+ue*ce,de=new fl;de.translate=l.paint.get("fill-extrusion-translate"),de.translateAnchor=l.paint.get("fill-extrusion-translate-anchor"),de.edgeRadius=l.layout.get("fill-extrusion-edge-radius"),de.cutoffFadeRange=l.paint.get("fill-extrusion-cutoff-fade-range");const pe=ae=>{const ce=f.depthModeForSublayer(1,bt.ReadOnly,b.LEQUAL,!0),ue=l.paint.get(ae?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Me=le(.1,3,ue),ye=f._showOverdrawInspector;if(!ye){const je=new Vt({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),Fe=new an([b.ONE,b.ONE,b.ONE,b.ONE],u.am.transparent,[!1,!1,!1,!0],b.MIN);$o(de,f,r,l,p,ce,je,Fe,Bt.disabled,ae,"sdf",B,H,U,q,Y,Me,P,!1)}{const je=ye?Vt.disabled:new Vt({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),Fe=ye?f.colorModeForRenderPass():new an([b.ONE_MINUS_DST_ALPHA,b.DST_ALPHA,b.ONE,b.ONE],u.am.transparent,[!0,!0,!0,!0]);$o(de,f,r,l,p,ce,je,Fe,Bt.disabled,ae,"color",B,H,U,q,Y,Me,P,!1)}};if(C){const ae=(ce,ue,Me)=>{const ye=f.depthModeForSublayer(1,bt.ReadOnly,b.LEQUAL,!1),je=l.paint.get(ce?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Fe=le(.1,3,je);{const Ge=new an([b.ONE,b.ONE,b.ONE,b.ONE],u.am.transparent,[!1,!1,!1,!0]);$o(de,f,r,l,p,ye,Vt.disabled,Ge,Bt.disabled,ce,"clear",B,H,U,q,Y,Fe,P,ue)}{const Ge=new Vt({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),rt=new an([b.ONE,b.ONE,b.ONE,b.ONE],u.am.transparent,[!1,!1,!1,!0],b.MIN);$o(de,f,r,l,p,ye,Ge,rt,Bt.disabled,ce,"sdf",B,H,U,q,Y,Fe,P,ue)}{const Ge=ce?b.ZERO:b.ONE_MINUS_DST_ALPHA,rt=new Vt({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),De=new an([Ge,b.DST_ALPHA,b.ONE_MINUS_DST_ALPHA,b.ZERO],u.am.transparent,[!0,!0,!0,!0]);$o(de,f,r,l,p,ye,rt,De,Bt.disabled,ce,"color",B,H,U,q,Y,Fe,P,ue)}{const Ge=new an([b.ONE,b.ONE,b.ONE,ce?b.ZERO:b.ONE],u.am.transparent,[!1,!1,!1,!0],ce?b.FUNC_ADD:b.MAX);$o(de,f,r,l,p,ye,Vt.disabled,Ge,Bt.disabled,ce,"clear",B,H,U,q,Y,Fe,P,ue,Me)}};if(ee||ne){let ce;if(f.prepareDrawTile(),D){const ue=D.drapeBufferSize[0],Me=D.drapeBufferSize[1];ce=D.framebufferCopyTexture,ce&&(!ce||ce.size[0]===ue&&ce.size[1]===Me)||(ce&&ce.destroy(),ce=D.framebufferCopyTexture=new u.T(v,new u.r({width:ue,height:Me}),b.RGBA8)),ce.bind(b.LINEAR,b.CLAMP_TO_EDGE),b.copyTexSubImage2D(b.TEXTURE_2D,0,0,0,0,0,ue,Me)}ee&&ae(!0,!1,ce),ne&&ae(!1,!0,ce)}}else ee&&pe(!0),ne&&pe(!1),(ee||ne)&&f.resetStencilClippingMasks()}}},building:function(f,r,l,p){f.currentLayer<f.firstLightBeamLayer&&(f.firstLightBeamLayer=f.currentLayer);const y=l.paint.get("building-ambient-occlusion-ground-intensity"),v=l.paint.get("building-ambient-occlusion-ground-radius"),b=l.paint.get("building-ambient-occlusion-ground-attenuation");let D=y>0&&v>0,C=!0;const P=l.paint.get("building-vertical-scale");P<1&&(C=!1);const O=f.conflationActive&&f.style.isLayerClipped(l,r.getSource()),N=f.style.order.indexOf(l.fqid);if(function(F,B,H,U,q,G){for(const Y of G){const ee=B.getTile(Y).getBucket(H);ee&&(q&&ee.updateReplacement(Y,F.replacementSource,U),ee.uploadUpdatedIndexBuffer(F.context))}}(f,r,l,N,O,p),function(F,B,H,U){for(const q of U){const G=B.getTile(q).getBucket(H);G&&G.needsEvaluation(F,H)&&(G.evaluate(H),G.uploadUpdatedColorBuffer(F.context))}}(f,r,l,p),l.resetLayerRenderingStats(f),f.shadowRenderer&&(f.shadowRenderer.useNormalOffset=!0),"shadow"===f.renderPass&&f.shadowRenderer){const F=f.shadowRenderer,B=[],H=F.getShadowPassDepthMode();ta({painter:f,source:r,layer:l,coords:p,defines:B,blendMode:F.getShadowPassColorMode(),depthMode:H,verticalScale:P})}else if("translucent"===f.renderPass){D&&function(U,q,G,Y,ee,ne,le,de,pe,ae,ce,ue,Me){const ye=U.context.gl,je=U.depthModeForSublayer(1,bt.ReadOnly,ye.LEQUAL,!0),Fe=.1*(1-(Ge=ce))+3*Ge;var Ge;const rt=U._showOverdrawInspector,De=ue,_e=new fl;rt||$o(_e,U,q,G,Y,je,new Vt({func:ye.ALWAYS,mask:255},255,255,ye.KEEP,ye.KEEP,ye.REPLACE),new an([ye.ONE,ye.ONE,ye.ONE,ye.ONE],u.am.transparent,[!1,!1,!1,!0],ye.MIN),Bt.disabled,true,"sdf",1,le,de,0,ae,Fe,De,!1);{const Ne=rt?Vt.disabled:new Vt({func:ye.EQUAL,mask:255},255,255,ye.KEEP,ye.DECR,ye.DECR),Re=rt?U.colorModeForRenderPass():new an([ye.ONE_MINUS_DST_ALPHA,ye.DST_ALPHA,ye.ONE,ye.ONE],u.am.transparent,[!0,!0,!0,!0]);$o(_e,U,q,G,Y,je,Ne,Re,Bt.disabled,true,"color",1,le,de,0,ae,Fe,De,!1)}}(f,r,l,p,0,0,y,v,0,[0,0,0],b,O);let F=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];C&&(F=F.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),f.shadowRenderer.useNormalOffset&&(F=F.concat("NORMAL_OFFSET"));const B=new bt(f.context.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D),H=f.colorModeForRenderPass();ta({painter:f,source:r,layer:l,coords:p,defines:F,blendMode:H,depthMode:B,verticalScale:P})}else if("light-beam"===f.renderPass){const F=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],B=new bt(f.context.gl.LEQUAL,bt.ReadOnly,f.depthRangeFor3D);ta({painter:f,source:r,layer:l,coords:p,defines:F,blendMode:an.alphaBlended,depthMode:B,verticalScale:P})}f.shadowRenderer&&(f.shadowRenderer.useNormalOffset=!1),f.resetStencilClippingMasks()},hillshade:function(f,r,l,p){if("offscreen"!==f.renderPass&&"translucent"!==f.renderPass||f.style.disableElevatedTerrain)return;const y=f.context,v=f.terrain&&f.terrain.renderingToTexture,[b,D]="translucent"!==f.renderPass||v?[{},p]:f.stencilConfigForOverlap(p);for(const C of D){const P=r.getTile(C);if(P.needsHillshadePrepare&&"offscreen"===f.renderPass)im(f,P,l);else if("translucent"===f.renderPass){const O=f.depthModeForSublayer(0,bt.ReadOnly),N=l.paint.get("hillshade-emissive-strength"),F=f.colorModeForDrapableLayerRenderPass(N),B=v&&f.terrain?f.terrain.stencilModeForRTTOverlap(C):b[C.overscaledZ];Hs(f,C,P,l,O,B,F)}}y.viewport.set([0,0,f.width,f.height]),f.resetStencilClippingMasks()},raster:function(f,r,l,p,y,v){if("translucent"!==f.renderPass||0===l.paint.get("raster-opacity"))return;const b="globe"===f.transform.projection.name,D=0!==l.paint.get("raster-elevation"),C=D&&b;if(f.renderElevatedRasterBackface&&!C)return;const P=f.context,O=P.gl,N=r.getSource(),F=function(de,pe,ae,ce){const ue=pe.paint.get("raster-color"),Me="raster-array"===de.type,ye=[],je=pe.paint.get("raster-resampling"),Fe=pe.paint.get("raster-color-mix");let Ge=pe.paint.get("raster-color-range");const rt=[Fe[0],Fe[1],Fe[2],0],De=Fe[3];let _e="nearest"===je?ce.NEAREST:ce.LINEAR;if(Me&&(ye.push("RASTER_ARRAY"),ue||ye.push("RASTER_COLOR"),"linear"===je&&ye.push("RASTER_ARRAY_LINEAR"),_e=ce.NEAREST,!Ge&&de.rasterLayers)){const Ne=de.rasterLayers.find(({id:Re})=>Re===pe.sourceLayer);Ne&&Ne.fields&&Ne.fields.range&&(Ge=Ne.fields.range)}if(Ge=Ge||[0,1],ue){ye.push("RASTER_COLOR"),ae.activeTexture.set(ce.TEXTURE2),pe.updateColorRamp(Ge);let Ne=pe.colorRampTexture;Ne||(Ne=pe.colorRampTexture=new u.T(ae,pe.colorRamp,ce.RGBA8)),Ne.bind(ce.LINEAR,ce.CLAMP_TO_EDGE)}return{mix:rt,range:Ge,offset:De,defines:ye,resampling:_e}}(N,l,P,O);if(N instanceof u.aP&&!p.length&&!b)return;const B=l.paint.get("raster-emissive-strength"),H=f.colorModeForDrapableLayerRenderPass(B),U=f.terrain&&f.terrain.renderingToTexture,q=!f.options.moving,G="nearest"===l.paint.get("raster-resampling")?O.NEAREST:O.LINEAR;if(N instanceof u.aP&&!p.length&&(N.onNorthPole||N.onSouthPole)){const de=D?f.stencilModeFor3D():Vt.disabled;return void zf(!!N.onNorthPole,null,f,r,l,B,F,Bt.disabled,de)}if(!p.length)return;const[Y,ee]=N instanceof u.aP||U?[{},p]:f.stencilConfigForOverlap(p),ne=ee[ee.length-1].overscaledZ;C&&F.defines.push("PROJECTION_GLOBE_VIEW"),D&&F.defines.push("RENDER_CUTOFF");const le=(de,pe,ae)=>{for(const ce of de){const ue=ce.toUnwrapped(),Me=r.getTile(ce);if(U&&(!Me||!Me.hasData()))continue;P.activeTexture.set(O.TEXTURE0);const ye=f_(Me,N,l,F);if(!ye||!ye.texture)continue;const{texture:je,mix:Fe,offset:Ge,tileSize:rt,buffer:De}=ye;let _e,Ne;U?(_e=bt.disabled,Ne=ce.projMatrix):D?(_e=new bt(O.LEQUAL,bt.ReadWrite,f.depthRangeFor3D),Ne=b?Float32Array.from(f.transform.expandedFarZProjMatrix):f.transform.calculateProjMatrix(ue,q)):(_e=f.depthModeForSublayer(ce.overscaledZ-ne,1===l.paint.get("raster-opacity")?bt.ReadWrite:bt.ReadOnly,O.LESS),Ne=f.transform.calculateProjMatrix(ue,q));const Re=f.terrain&&U?f.terrain.stencilModeForRTTOverlap(ce):Y[ce.overscaledZ],We=v?0:l.paint.get("raster-fade-duration");Me.registerFadeDuration(We);const Ze=r.findLoadedParent(ce,0),Ye=ls(Me,Ze,r,f.transform,We);let ct,Mt;f.terrain&&f.terrain.prepareDrawTile(),P.activeTexture.set(O.TEXTURE0),je.bind(G,O.CLAMP_TO_EDGE),P.activeTexture.set(O.TEXTURE1),Ze?(Ze.texture&&Ze.texture.bind(G,O.CLAMP_TO_EDGE),ct=Math.pow(2,Ze.tileID.overscaledZ-Me.tileID.overscaledZ),Mt=[Me.tileID.canonical.x*ct%1,Me.tileID.canonical.y*ct%1]):je.bind(G,O.CLAMP_TO_EDGE),"useMipmap"in je&&P.extTextureFilterAnisotropic&&f.transform.pitch>20&&O.texParameterf(O.TEXTURE_2D,P.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,P.extTextureFilterAnisotropicMax);const kt=f.transform;let vt;const Ot=D?Av(kt):[0,0,0,0];let Pt,Wt,en,mn,Cn,Yt=0;if(C&&N instanceof u.aP&&N.coordinates.length>3)Pt=Float32Array.from(u.bh(u.dD(new u.cA(0,0,0)))),Wt=Float32Array.from(kt.globeMatrix),en=Float32Array.from(u.dz(kt)),mn=[u.aD(kt.center.lng),u.aH(kt.center.lat)],vt=N.elevatedGlobePerspectiveTransform,Cn=N.elevatedGlobeGridMatrix||new Float32Array(9);else if(C){const un=u.dA(ce.canonical);Yt=u.dB(un.getCenter().lat),Pt=Float32Array.from(u.bh(u.dD(ce.canonical))),Wt=Float32Array.from(kt.globeMatrix),en=Float32Array.from(u.dz(kt)),mn=[u.aD(kt.center.lng),u.aH(kt.center.lat)],vt=[0,0],Cn=Float32Array.from(u.dC(ce.canonical,un,Yt,kt.worldSize/kt._pixelsPerMercatorPixel))}else vt=N instanceof u.aP?N.perspectiveTransform:[0,0],Pt=new Float32Array(16),Wt=new Float32Array(9),en=new Float32Array(16),mn=[0,0],Cn=new Float32Array(9);const Mn=Mf(Ne,Pt,Wt,en,Cn,Mt||[0,0],u.ah(f.transform.zoom),mn,Ot,ct||1,Ye,l,vt,D?l.paint.get("raster-elevation"):0,2,Fe,Ge,F.range,rt,De,B),kn=f.isTileAffectedByFog(ce),ti=f.getOrCreateProgram("raster",{defines:F.defines,overrideFog:kn});if(f.uploadCommonUniforms(P,ti,ue),N instanceof u.aP){const un=N.elevatedGlobeVertexBuffer,Ln=N.elevatedGlobeIndexBuffer;if(U||!b)N.boundsBuffer&&N.boundsSegments&&ti.draw(f,O.TRIANGLES,_e,Vt.disabled,H,Bt.disabled,Mn,l.id,N.boundsBuffer,f.quadTriangleIndexBuffer,N.boundsSegments);else if(un&&Ln){const zn=kt.zoom<=u.cX?N.elevatedGlobeSegments:N.getSegmentsForLongitude(kt.center.lng);zn&&ti.draw(f,O.TRIANGLES,_e,Vt.disabled,H,pe,Mn,l.id,un,Ln,zn)}}else if(C){_e=new bt(O.LEQUAL,bt.ReadOnly,f.depthRangeFor3D);const un=f.globeSharedBuffers;if(un){const[Ln,zn,In]=un.getGridBuffers(Yt,!1);ti.draw(f,O.TRIANGLES,_e,ae||Re,f.colorModeForRenderPass(),pe,Mn,l.id,Ln,zn,In)}}else{const{tileBoundsBuffer:un,tileBoundsIndexBuffer:Ln,tileBoundsSegments:zn}=f.getTileBoundsBuffers(Me);ti.draw(f,O.TRIANGLES,_e,Re,H,Bt.disabled,Mn,l.id,un,Ln,zn)}}if(!(N instanceof u.aP)&&C)for(const ce of de){const ue=ce.canonical.y===(1<<ce.canonical.z)-1;0===ce.canonical.y&&zf(!0,ce,f,r,l,B,F,pe,ae||Vt.disabled),ue&&zf(!1,ce,f,r,l,B,F,pe===Bt.frontCW?Bt.backCW:Bt.frontCW,ae||Vt.disabled)}};C?le(ee,f.renderElevatedRasterBackface?Bt.backCW:Bt.frontCW,f.stencilModeFor3D()):le(ee,Bt.disabled,void 0),f.resetStencilClippingMasks()},"raster-particle":function(f,r,l,p,y,v){"offscreen"===f.renderPass&&function(b,D,C,P){if(!P.length)return;const O=b.context,N=O.gl,F=D.getSource();if(!(F instanceof Hl))return;const B=Math.ceil(Math.sqrt(C.paint.get("raster-particle-count")));let H=C.particlePositionRGBAImage;if(!H||H.width!==B){const ee=function(ne){const le=ne*ne,de=new Uint8Array(4*le),pe=function(ce){return ce|=0,ce=Math.imul(2747636419^ce,2654435769),ce=Math.imul(ce^ce>>>16,2654435769),((ce=Math.imul(ce^ce>>>16,2654435769))>>>0)/4294967296},ae=1/1.1;for(let ce=0;ce<le;ce++){const ue=ae*(pe(2*ce+0)+dl),Me=ae*(pe(2*ce+1)+dl),ye=255*ue%1,je=255*Me%1,Fe=ye,Ge=Me-je/255,rt=je;de[4*ce+0]=255*(ue-ye/255),de[4*ce+1]=255*Fe,de[4*ce+2]=255*Ge,de[4*ce+3]=255*rt}return de}(B);H=C.particlePositionRGBAImage=new u.r({width:B,height:B},ee)}let U=C.particleFramebuffer;U?U.width!==B&&(U.destroy(),U=C.particleFramebuffer=O.createFramebuffer(B,B,!0,null)):U=C.particleFramebuffer=O.createFramebuffer(B,B,!0,null);const q=[];for(const ee of P){const ne=D.getTile(ee);if(!(ne instanceof Yi))continue;const le=To(ne,F,C);if(!le)continue;const de=[ne.tileSize,ne.tileSize];let pe=C.tileFramebuffer;pe||(pe=C.tileFramebuffer=O.createFramebuffer(de[0],de[1],!0,null));let ae=ne.rasterParticleState;ae||(ae=ne.rasterParticleState=new mm(O,ee,de,H));const ce=ae.update(C.lastInvalidatedAt);ae.particleTextureDimension!==B&&ae.updateParticleTexture(ee,H);const ue=ae.targetColorTexture;ae.targetColorTexture=ae.backgroundColorTexture,ae.backgroundColorTexture=ue;const Me=ae.particleTexture0;ae.particleTexture0=ae.particleTexture1,ae.particleTexture1=Me,q.push([ee,le,ae,ce])}if(0===q.length)return;const G=u.q.now(),Y=C.previousDrawTimestamp?.001*(G-C.previousDrawTimestamp):.0167;if(C.previousDrawTimestamp=G,C.hasColorMap()){O.activeTexture.set(N.TEXTURE0+2);let ee=C.colorRampTexture;ee||(ee=C.colorRampTexture=new u.T(O,C.colorRamp,N.RGBA8)),ee.bind(N.LINEAR,N.CLAMP_TO_EDGE)}O.bindFramebuffer.set(C.tileFramebuffer.framebuffer),function(ee,ne,le){const de=ee.context,pe=de.gl,ae=ne.tileFramebuffer;de.activeTexture.set(pe.TEXTURE0);const ce={u_texture:0,u_opacity:1.05*(Me=ne.paint.get("raster-particle-fade-opacity-factor"))/(Me+.05)},ue=ee.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Me;for(const ye of le){const[,,je,Fe]=ye;ae.colorAttachment.set(je.targetColorTexture.texture),de.viewport.set([0,0,ae.width,ae.height]),de.clear({color:u.am.transparent}),Fe&&(je.backgroundColorTexture.bind(pe.NEAREST,pe.CLAMP_TO_EDGE),ue.draw(ee,pe.TRIANGLES,bt.disabled,Vt.disabled,an.alphaBlended,Bt.disabled,ce,ne.id,ee.viewportBuffer,ee.quadTriangleIndexBuffer,ee.viewportSegments))}}(b,C,q),function(ee,ne,le,de){const pe=ee.context,ae=pe.gl,ce=le.tileFramebuffer,ue="globe"===ee.transform.projection.name,Me=le.paint.get("raster-particle-max-speed");for(const ye of de){const[je,Fe,Ge]=ye;pe.activeTexture.set(ae.TEXTURE0+0),Fe.texture.bind(ae.LINEAR,ae.CLAMP_TO_EDGE),ce.colorAttachment.set(Ge.targetColorTexture.texture);const rt=ee.getOrCreateProgram("rasterParticleDraw",{defines:Fe.defines,overrideFog:!1});pe.activeTexture.set(ae.TEXTURE0+1);const De=Fe.scalarData?[]:[0,1,2,3].map(Re=>u.e3[Re](je));De.push(je);const _e=je.canonical.x,Ne=je.canonical.y;for(const Re of De){const We=ne.getTile(ue?Re.wrapped():Re);if(!We)continue;const Ze=We.rasterParticleState;if(!Ze)continue;const Ye=Re.canonical.x+(1<<Re.canonical.z)*(Re.wrap-je.wrap),ct=Re.canonical.y;Ze.particleTexture0.bind(ae.NEAREST,ae.CLAMP_TO_EDGE);const Mt=dm(1,Ze.particleTexture0.size[0],[Ye-_e,ct-Ne],0,Fe.texture.size,2,Me,Fe.textureOffset,Fe.scale,Fe.offset);rt.draw(ee,ae.POINTS,bt.disabled,Vt.disabled,an.alphaBlended,Bt.disabled,Mt,le.id,Ze.particleIndexBuffer,void 0,Ze.particleSegment)}}}(b,D,C,q),O.bindFramebuffer.set(C.particleFramebuffer.framebuffer),function(ee,ne,le,de){const pe=ee.context,ae=pe.gl,ce=ne.paint.get("raster-particle-max-speed"),ue=de*ne.paint.get("raster-particle-speed-factor")*.15,Me=(je=.01+1*ne.paint.get("raster-particle-reset-rate-factor"),Math.pow(je,6)),ye=ne.particleFramebuffer;var je;pe.viewport.set([0,0,ye.width,ye.height]);for(const je of le){const[,Fe,Ge]=je;pe.activeTexture.set(ae.TEXTURE0+0),Fe.texture.bind(ae.LINEAR,ae.CLAMP_TO_EDGE),pe.activeTexture.set(ae.TEXTURE0+1);const rt=Ge.particleTexture0;rt.bind(ae.NEAREST,ae.CLAMP_TO_EDGE);const De=Pf(1,rt.size[0],0,Fe.texture.size,ce,ue,Me,Fe.textureOffset,Fe.scale,Fe.offset);ye.colorAttachment.set(Ge.particleTexture1.texture),pe.clear({color:u.am.transparent}),ee.getOrCreateProgram("rasterParticleUpdate",{defines:Fe.defines}).draw(ee,ae.TRIANGLES,bt.disabled,Vt.disabled,an.unblended,Bt.disabled,De,ne.id,ee.viewportBuffer,ee.quadTriangleIndexBuffer,ee.viewportSegments)}}(b,C,q,Y)}(f,r,l,p),"translucent"===f.renderPass&&(function(b,D,C,P,O){const N=b.context,F=N.gl,B=D.getSource().tileSize,H=5*(1-u.af(u.cI,u.cI+1,b.transform.zoom))*B+C.paint.get("raster-particle-elevation"),U=!b.options.moving,q="globe"===b.transform.projection.name;if(!P.length)return;const[G,Y]=b.stencilConfigForOverlap(P),ee=[];q&&ee.push("PROJECTION_GLOBE_VIEW");const ne=b.stencilModeFor3D();for(const le of Y){const de=le.toUnwrapped(),pe=D.getTile(le);if(!pe.rasterParticleState)continue;const ae=pe.rasterParticleState,ce=100;pe.registerFadeDuration(ce);const ue=D.findLoadedParent(le,0),Me=ls(pe,ue,D,b.transform,ce);let ye,je;b.terrain&&b.terrain.prepareDrawTile(),N.activeTexture.set(F.TEXTURE0),ae.targetColorTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),N.activeTexture.set(F.TEXTURE1),ue&&ue.rasterParticleState?(ue.rasterParticleState.targetColorTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),ye=Math.pow(2,ue.tileID.overscaledZ-pe.tileID.overscaledZ),je=[pe.tileID.canonical.x*ye%1,pe.tileID.canonical.y*ye%1]):ae.targetColorTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE);const Fe=q?Float32Array.from(b.transform.expandedFarZProjMatrix):b.transform.calculateProjMatrix(de,U),Ge=b.transform,rt=ic(Ge),De=u.dA(le.canonical),_e=u.dB(De.getCenter().lat);let Ne,Re,We,Ze,Ye;q?(Ne=Float32Array.from(u.bh(u.dD(le.canonical))),Re=Float32Array.from(Ge.globeMatrix),We=Float32Array.from(u.dz(Ge)),Ze=[u.aD(Ge.center.lng),u.aH(Ge.center.lat)],Ye=Float32Array.from(u.dC(le.canonical,De,_e,Ge.worldSize/Ge._pixelsPerMercatorPixel))):(Ne=new Float32Array(16),Re=new Float32Array(9),We=new Float32Array(16),Ze=[0,0],Ye=new Float32Array(9));const ct=Zu(Fe,Ne,Re,We,Ye,je||[0,0],u.ah(b.transform.zoom),Ze,rt,ye||1,Me,H),Mt=b.isTileAffectedByFog(le),kt=b.getOrCreateProgram("rasterParticle",{defines:ee,overrideFog:Mt});if(b.uploadCommonUniforms(N,kt,de),q){const vt=new bt(F.LEQUAL,bt.ReadOnly,b.depthRangeFor3D),Ot=0,Pt=b.globeSharedBuffers;if(Pt){const[Wt,en,mn]=Pt.getGridBuffers(_e,0!==Ot);kt.draw(b,F.TRIANGLES,vt,ne,an.alphaBlended,b.renderElevatedRasterBackface?Bt.frontCCW:Bt.backCCW,ct,C.id,Wt,en,mn)}}else{const vt=b.depthModeForSublayer(0,bt.ReadOnly),Ot=G[le.overscaledZ],{tileBoundsBuffer:Pt,tileBoundsIndexBuffer:Wt,tileBoundsSegments:en}=b.getTileBoundsBuffers(pe);kt.draw(b,F.TRIANGLES,vt,Ot,an.alphaBlended,Bt.disabled,ct,C.id,Pt,Wt,en)}}b.resetStencilClippingMasks()}(f,r,l,p),f.style.map.triggerRepaint())},background:function(f,r,l,p){const y=l.paint.get("background-color"),v="none"===l.paint.get("background-color-use-theme").constantOr("default"),b=l.paint.get("background-opacity"),D=l.paint.get("background-emissive-strength"),C="viewport"===l.paint.get("background-pitch-alignment");if(0===b)return;const P=f.context,O=P.gl,N=f.transform,F=N.tileSize,B=l.paint.get("background-pattern");let H;if(void 0!==B&&(null===B||(H=f.imageManager.getPattern(u.I.from(B.toString()),l.scope,f.style.getLut(l.scope)),!H)))return;const U=!B&&1===y.a&&1===b&&f.opaquePassEnabledForLayer()?"opaque":"translucent";if(f.renderPass!==U)return;const q=Vt.disabled,G=f.depthModeForSublayer(0,"opaque"===U?bt.ReadWrite:bt.ReadOnly),Y=f.colorModeForDrapableLayerRenderPass(D),ee=B?"backgroundPattern":"background";let ne,le=p;if(le||(ne=f.getBackgroundTiles(),le=Object.values(ne).map(de=>de.tileID)),B&&(P.activeTexture.set(O.TEXTURE0),f.imageManager.bind(f.context,l.scope)),C){const de=f.getOrCreateProgram(ee,{overrideFog:!1,overrideRtt:!0}),pe=new Float32Array(u.bx([])),ae=new u.aM(0,0,0,0,0),ce=B?Rf(pe,D,b,f,0,l.scope,H,C,{tileID:ae,tileSize:F}):hm(pe,D,b,y.toPremultipliedRenderColor(v?null:l.lut));de.draw(f,O.TRIANGLES,G,q,Y,Bt.disabled,ce,l.id,f.viewportBuffer,f.quadTriangleIndexBuffer,f.viewportSegments)}else for(const de of le){const pe=f.isTileAffectedByFog(de),ae=f.getOrCreateProgram(ee,{overrideFog:pe}),ce=de.toUnwrapped(),ue=p?de.projMatrix:f.transform.calculateProjMatrix(ce);f.prepareDrawTile();const Me=r?r.getTile(de):ne?ne[de.key]:new Cc(de,F,N.zoom,f),ye=B?Rf(ue,D,b,f,0,l.scope,H,C,{tileID:de,tileSize:F}):hm(ue,D,b,y.toPremultipliedRenderColor(v?null:l.lut));f.uploadCommonUniforms(P,ae,ce);const{tileBoundsBuffer:je,tileBoundsIndexBuffer:Fe,tileBoundsSegments:Ge}=f.getTileBoundsBuffers(Me);ae.draw(f,O.TRIANGLES,G,q,Y,Bt.disabled,ye,l.id,je,Fe,Ge)}},sky:function(f,r,l){const p=f._atmosphere?u.ah(f.transform.zoom):1,y=l.paint.get("sky-opacity")*p;if(0===y)return;const v=f.context,b=l.paint.get("sky-type"),D=new bt(v.gl.LEQUAL,bt.ReadOnly,[0,1]),C=f.frameCounter/1e3%1;"atmosphere"===b?"offscreen"===f.renderPass?l.needsSkyboxCapture(f)&&(function(P,O,N,F){const B=P.context,H=B.gl;let U=O.skyboxFbo;if(!U){U=O.skyboxFbo=B.createFramebuffer(32,32,!0,null),O.skyboxGeometry=new Xc(B),O.skyboxTexture=B.gl.createTexture(),H.bindTexture(H.TEXTURE_CUBE_MAP,O.skyboxTexture),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MIN_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MAG_FILTER,H.LINEAR);for(let ee=0;ee<6;++ee)H.texImage2D(H.TEXTURE_CUBE_MAP_POSITIVE_X+ee,0,H.RGBA,32,32,0,H.RGBA,H.UNSIGNED_BYTE,null)}B.bindFramebuffer.set(U.framebuffer),B.viewport.set([0,0,32,32]);const q=O.getCenter(P,!0),G=P.getOrCreateProgram("skyboxCapture"),Y=new Float64Array(16);u.bx(Y),u.eh(Y,Y,.5*-Math.PI),Do(P,O,G,Y,q,0),u.bx(Y),u.eh(Y,Y,.5*Math.PI),Do(P,O,G,Y,q,1),u.bx(Y),u.cR(Y,Y,.5*-Math.PI),Do(P,O,G,Y,q,2),u.bx(Y),u.cR(Y,Y,.5*Math.PI),Do(P,O,G,Y,q,3),u.bx(Y),Do(P,O,G,Y,q,4),u.bx(Y),u.eh(Y,Y,Math.PI),Do(P,O,G,Y,q,5),B.viewport.set([0,0,P.width,P.height])}(f,l),l.markSkyboxValid(f)):"sky"===f.renderPass&&function(P,O,N,F,B){const H=P.context,U=H.gl,q=P.transform,G=P.getOrCreateProgram("skybox");H.activeTexture.set(U.TEXTURE0),U.bindTexture(U.TEXTURE_CUBE_MAP,O.skyboxTexture);const Y={u_matrix:q.skyboxMatrix,u_sun_direction:O.getCenter(P,!1),u_cubemap:0,u_opacity:F,u_temporal_offset:B};P.uploadCommonUniforms(H,G),G.draw(P,U.TRIANGLES,N,Vt.disabled,P.colorModeForRenderPass(),Bt.backCW,Y,"skybox",O.skyboxGeometry.vertexBuffer,O.skyboxGeometry.indexBuffer,O.skyboxGeometry.segment)}(f,l,D,y,C):"gradient"===b&&"sky"===f.renderPass&&function(P,O,N,F,B){const H=P.context,U=H.gl,q=P.transform,G=P.getOrCreateProgram("skyboxGradient");O.skyboxGeometry||(O.skyboxGeometry=new Xc(H)),H.activeTexture.set(U.TEXTURE0);let Y=O.colorRampTexture;Y||(Y=O.colorRampTexture=new u.T(H,O.colorRamp,U.RGBA8)),Y.bind(U.LINEAR,U.CLAMP_TO_EDGE);const ee=(ne=q.skyboxMatrix,le=O.getCenter(P,!1),de=O.paint.get("sky-gradient-radius"),pe=F,ae=B,{u_matrix:ne,u_color_ramp:0,u_center_direction:le,u_radius:u.al(de),u_opacity:pe,u_temporal_offset:ae});var ne,le,de,pe,ae;P.uploadCommonUniforms(H,G),G.draw(P,U.TRIANGLES,N,Vt.disabled,P.colorModeForRenderPass(),Bt.backCW,ee,"skyboxGradient",O.skyboxGeometry.vertexBuffer,O.skyboxGeometry.indexBuffer,O.skyboxGeometry.segment)}(f,l,D,y,C)},custom:function(f,r,l,p){const y=f.context,v=l.implementation;if(!f.transform.projection.unsupportedLayers||!f.transform.projection.unsupportedLayers.includes("custom")||f.terrain&&(f.terrain.renderingToTexture||"offscreen"===f.renderPass)&&l.isDraped(r)){if("offscreen"===f.renderPass){const b=v.prerender;if(b){if(f.setCustomLayerDefaults(),y.setColorMode(f.colorModeForRenderPass()),"globe"===f.transform.projection.name){const D=f.transform.pointMerc;b.call(v,y.gl,f.transform.customLayerMatrix(),f.transform.getProjection(),f.transform.globeToMercatorMatrix(),u.ah(f.transform.zoom),[D.x,D.y],f.transform.pixelsPerMeterRatio)}else b.call(v,y.gl,f.transform.customLayerMatrix());y.setDirty(),f.setBaseState()}}else if("translucent"===f.renderPass){if(f.terrain&&f.terrain.renderingToTexture){const D=v.renderToTile;if(D){const C=p[0].canonical,P={x:C.x+p[0].wrap*(v.wrapTileId?0:1<<C.z),y:C.y,z:C.z};y.setDepthMode(bt.disabled),y.setStencilMode(Vt.disabled),y.setColorMode(f.colorModeForRenderPass()),f.setCustomLayerDefaults(),D.call(v,y.gl,P),y.setDirty(),f.setBaseState()}return}f.setCustomLayerDefaults(),y.setColorMode(f.colorModeForRenderPass()),y.setStencilMode(Vt.disabled);const b="3d"===v.renderingMode?new bt(f.context.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D):f.depthModeForSublayer(0,bt.ReadOnly);if(y.setDepthMode(b),"globe"===f.transform.projection.name){const D=f.transform.pointMerc;v.render(y.gl,f.transform.customLayerMatrix(),f.transform.getProjection(),f.transform.globeToMercatorMatrix(),u.ah(f.transform.zoom),[D.x,D.y],f.transform.pixelsPerMeterRatio)}else v.render(y.gl,f.transform.customLayerMatrix());y.setDirty(),f.setBaseState(),y.bindFramebuffer.set(null)}}else u.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(f,r,l,p){if("opaque"===f.renderPass)return;const y=l.paint.get("model-opacity").constantOr(1);if(0===y)return;const v=l.paint.get("model-cast-shadows");if("shadow"===f.renderPass&&(!v||f.terrain&&y<.65&&l._transitionablePaint._values["model-opacity"].value.expression instanceof u.ab))return;const b=f.shadowRenderer,D=l.paint.get("model-receive-shadows");b&&(b.useNormalOffset=!0,D||(b.enabled=!1));const C=()=>{b&&(b.useNormalOffset=!0,D||(b.enabled=!0))},P=r.getSource();if("light-beam"===f.renderPass&&"batched-model"!==P.type)return;if("vector"===P.type||"geojson"===P.type)return function(G,Y,ee,ne,le){const de=G.transform;if("mercator"!==de.projection.name)return void u.w(`Drawing 3D models for ${de.projection.name} projection is not yet implemented`);const pe=de.getFreeCameraOptions().position;if(!G.modelManager)return;const ae=G.modelManager;ee.modelManager=ae;const ce=G.shadowRenderer;if(!ee._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ue=ee._unevaluatedLayout._values["model-id"],Me=Object.assign({},ee.layout.get("model-id").parameters),ye=G.style.order.indexOf(ee.fqid);for(const je of ne){const Fe=Y.getTile(je).getBucket(ee);if(!Fe||Fe.projection.name!==de.projection.name)continue;const Ge=Fe.getModelUris();Ge&&!Fe.modelsRequested&&(ae.addModelsFromBucket(Ge,le),Fe.modelsRequested=!0);const rt=Ju(je,de);Me.zoom=rt;const De=ue.possiblyEvaluate(Me);if(Qu(G,Fe,je),ya.shadowUniformsInitialized=!1,ya.useSingleShadowCascade=!!ce&&0===ce.getMaxCascadeForTile(je.toUnwrapped()),"shadow"===G.renderPass&&ce){if(1===G.currentShadowCascade&&Fe.isInsideFirstShadowMapFrustum)continue;const Re=de.calculatePosMatrix(je.toUnwrapped(),de.worldSize);if(ya.tileMatrix.set(Re),ya.shadowTileMatrix=Float32Array.from(ce.calculateShadowPassMatrixFromMatrix(Re)),ya.aabb.min.fill(0),ya.aabb.max[0]=ya.aabb.max[1]=u.aj,ya.aabb.max[2]=0,ym(Fe,ya,G,ee.scope))continue}const _e=1<<je.canonical.z,Ne=[((pe.x-je.wrap)*_e-je.canonical.x)*u.aj,(pe.y*_e-je.canonical.y)*u.aj,pe.z*_e*u.aj];G.conflationActive&&Object.keys(Fe.instancesPerModel).length>0&&G.style.isLayerClipped(ee,Y.getSource())&&Fe.updateReplacement(je,G.replacementSource,ye,le)&&(Fe.uploaded=!1,Fe.upload(G.context));for(let Re in Fe.instancesPerModel){const We=Fe.instancesPerModel[Re];We.features.length>0&&(Re=De.evaluate(We.features[0].feature,{}));const Ze=ae.getModel(Re,le);if(Ze||ae.hasURLBeenRequested(Re)||Fe.modelUris.includes(Re)||(Fe.modelUris.push(Re),Fe.modelsRequested=!1),Ze&&Ze.uploaded)for(const Ye of Ze.nodes)_m(G,ee,Ye,We,Ne,je,ya)}}}(f,r,l,p,"vector"===P.type?l.scope:""),void C();if(!P.loaded())return;if("batched-model"===P.type)return function(G,Y,ee,ne){ee.resetLayerRenderingStats(G);const le=G.context,de=G.transform,pe=G.style.fog,ae=G.shadowRenderer;if("mercator"!==de.projection.name)return void u.w(`Drawing 3D landmark models for ${de.projection.name} projection is not yet implemented`);const ce=G.transform.getFreeCameraOptions().position,ue=u.c1([],[ce.x,ce.y,ce.z],G.transform.worldSize),Me=u.eq([],ue),ye=u.bx([]),je=u.e9(de.center.lat,de.zoom),Fe=u.bn([],[1,1,1/je]);u.bo(ye,ye,Me);const Ge=ee.paint.get("model-opacity").constantOr(1),rt=new bt(le.gl.LEQUAL,bt.ReadWrite,G.depthRangeFor3D),De=new bt(le.gl.LEQUAL,bt.ReadOnly,G.depthRangeFor3D),_e=new u.d6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Ne="shadow"===G.renderPass,Re=Ne&&ae?ae.getCurrentCascadeFrustum():de.getFrustum(de.scaleZoom(de.worldSize)),We=ee.paint.get("model-front-cutoff"),Ze=We[2]<1,Ye=xo(G,ee.paint.get("model-cutoff-fade-range")),ct=ee.getLayerRenderingStats();(function(Mt,kt,vt,Ot){const Pt=Mt.terrain?Mt.terrain.exaggeration():0,Wt=Mt.transform.zoom;for(const en of Ot){const mn=kt.getTile(en).getBucket(vt);mn&&(mn.setFilter(vt.filter),Mt.conflationActive&&mn.updateReplacement(en,Mt.replacementSource),mn.evaluateTransform(Mt,vt),Mt.terrain&&Pt>0&&mn.elevationUpdate(Mt.terrain,Pt,en,vt.source),mn.needsReEvaluation(Mt,Wt,vt)&&mn.evaluate(vt))}})(G,Y,ee,ne),function(){let Mt,kt,vt;Ze?(Mt=ne.length-1,kt=-1,vt=-1):(Mt=0,kt=ne.length,vt=1);const Ot=new Float64Array(16),Pt=u.cx(),Wt=new u.P(0,0);for(let en=Mt;en!==kt;en+=vt){const mn=ne[en],Cn=Y.getTile(mn).getBucket(ee);if(!Cn||!Cn.uploaded)continue;let Yt=!1;ae&&(Yt=0===ae.getMaxCascadeForTile(mn.toUnwrapped()));const Mn=de.calculatePosMatrix(mn.toUnwrapped(),de.worldSize),kn=Cn.modelTraits;!Ne&&Ze&&(u.bi(Ot,Mn),u.ad(Pt,ue,Ot),Wt.x=Pt[0],Wt.y=Pt[1]);const ti=[];Cn.setFilter(ee.filter);for(const un of Cn.getNodesInfo()){if(un.hiddenByReplacement||!un.node.meshes)continue;const Ln=un.node;let zn=0;G.terrain&&Ln.elevation&&(zn=Ln.elevation*G.terrain.exaggeration());const In=(()=>{const Gr=un.aabb;return _e.min=[...Gr.min],_e.max=[...Gr.max],_e.min[2]+=zn,_e.max[2]+=zn,u.ad(_e.min,_e.min,Mn),u.ad(_e.max,_e.max,Mn),_e})(),sn=un.evaluatedScale;if(sn[0]<=1&&sn[1]<=1&&sn[2]<=1&&0===In.intersects(Re))continue;if(!Ne&&Ze){const Gr=.16666666666666666;un.cameraCollisionOpacity=ue[0]>In.min[0]&&ue[0]<In.max[0]&&ue[1]>In.min[1]&&ue[1]<In.max[1]&&ue[2]*je<In.max[2]&&Ln.footprint&&u.bY(Wt,Ln.footprint)?Math.max(un.cameraCollisionOpacity-Gr,0):Math.min(1,un.cameraCollisionOpacity+Gr)}const ni=[...Mn],$n=1/u.d4(mn.canonical),Ni=Ln.anchor?Ln.anchor[0]:0,Pn=Ln.anchor?Ln.anchor[1]:0;u.bo(ni,ni,[Ni*(sn[0]-1)+un.evaluatedTranslation[0]*$n,Pn*(sn[1]-1)+un.evaluatedTranslation[1]*$n,zn+un.evaluatedTranslation[2]]),u.cn(sn,u.es)||u.cP(ni,ni,sn);const Wn=u.az([],ni,Ln.matrix),di=u.az([],de.expandedFarZProjMatrix,Wn),xr=u.az([],de.expandedFarZProjMatrix,ni),hr=u.aA([],[Ni,Pn,zn,1],di)[2];Ln.hidden=!1;let or=Ge;Ne||(Ze&&(or*=un.cameraCollisionOpacity,or*=__(ni,de,un.aabb,We)),or*=g_(Ye,hr)),0!==or?ti.push({nodeInfo:un,depth:hr,opacity:or,wvpForNode:di,wvpForTile:xr,nodeModelMatrix:Wn,tileModelMatrix:ni}):Ln.hidden=!0}Ne||ti.sort((un,Ln)=>!Ze||1===un.opacity&&1===Ln.opacity?un.depth<Ln.depth?-1:1:1===un.opacity?-1:1===Ln.opacity?1:un.depth>Ln.depth?-1:1);for(const un of ti){const Ln=un.nodeInfo,zn=Ln.node;let In=u.az([],Fe,un.tileModelMatrix);u.az(In,ye,In);const sn=u.bi([],In);u.ea(sn,sn),u.cP(sn,sn,Hf),In=u.az(In,In,zn.matrix);const ni="light-beam"===G.renderPass,$n="none"===ee.paint.get("model-color-use-theme").constantOr("default"),Ni=kn&u.ex.HasMapboxMeshFeatures,Pn=Ni?0:Ln.evaluatedRMEA[0][2];for(let Wn=0;Wn<zn.meshes.length;++Wn){const di=zn.meshes[Wn],xr=Wn===zn.lightMeshIndex;let hr=un.wvpForNode;if(xr){if(!ni&&!G.terrain&&G.shadowRenderer){G.currentLayer<G.firstLightBeamLayer&&(G.firstLightBeamLayer=G.currentLayer);continue}hr=un.wvpForTile}else if(ni)continue;const or={defines:[]},Gr=[];if(!Ne&&ae&&(ae.useNormalOffset=!!di.normalBuffer),Ku(or.defines,Gr,di,G,$n?null:ee.lut),Ni||or.defines.push("DIFFUSE_SHADED"),Yt&&or.defines.push("SHADOWS_SINGLE_CASCADE"),ct&&(Ne?ct.numRenderedVerticesInShadowPass+=di.vertexArray.length:ct.numRenderedVerticesInTransparentPass+=di.vertexArray.length),Ne){Uf(di,un.nodeModelMatrix,G,ee);continue}let ba=null;if(pe){const Co=Sn(un.nodeModelMatrix,G.transform);if(ba=new Float32Array(Co),"globe"!==de.projection.name){const Qi=di.aabb.min,rr=di.aabb.max,[Ei,Tr]=pe.getOpacityForBounds(Co,Qi[0],Qi[1],rr[0],rr[1]);or.overrideFog=Ei>=qe||Tr>=qe}}const Lo=di.material;let qs;Lo.occlusionTexture&&Lo.occlusionTexture.offsetScale&&(qs=Lo.occlusionTexture.offsetScale,or.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const uo=G.getOrCreateProgram("model",or);!Ne&&ae&&ae.setupShadowsFromMatrix(un.tileModelMatrix,uo,ae.useNormalOffset),G.uploadCommonUniforms(le,uo,null,ba);const ia=Lo.pbrMetallicRoughness;ia.metallicFactor=.9,ia.roughnessFactor=.5;const ra=$c(new Float32Array(hr),new Float32Array(In),new Float32Array(sn),new Float32Array(zn.matrix),G,un.opacity,ia.baseColorFactor,Lo.emissiveFactor,ia.metallicFactor,ia.roughnessFactor,Lo,Pn,ee,[0,0,0],qs);!xr&&(Ln.hasTranslucentParts||un.opacity<1)&&uo.draw(G,le.gl.TRIANGLES,rt,Vt.disabled,an.disabled,Bt.backCCW,ra,ee.id,di.vertexBuffer,di.indexBuffer,di.segments,ee.paint,G.transform.zoom,void 0,Gr),uo.draw(G,le.gl.TRIANGLES,xr?De:rt,Vt.disabled,xr||un.opacity<1||Ln.hasTranslucentParts?an.alphaBlended:an.unblended,Bt.backCCW,ra,ee.id,di.vertexBuffer,di.indexBuffer,di.segments,ee.paint,G.transform.zoom,void 0,Gr)}}}}()}(f,r,l,p),void C();if("model"!==P.type)return;const O=P.getModels(),N=[],F=f.transform.getFreeCameraOptions().position,B=u.c1([],[F.x,F.y,F.z],f.transform.worldSize);u.eq(B,B);const H=[],U=[];let q=0;for(const G of O){const Y=l.paint.get("model-rotation").constantOr(null),ee=l.paint.get("model-scale").constantOr(null),ne=l.paint.get("model-translation").constantOr(null);G.computeModelMatrix(f,Y,ee,ne,!0,!0,!1);const le=u.bx([]),de=u.e9(G.position.lat,f.transform.zoom),pe=u.bn([],[1,1,1/de]);u.bo(le,le,B),N.push({zScaleMatrix:pe,negCameraPosMatrix:le});for(const ae of G.nodes)gm(f.transform,ae,G.matrix,f.transform.expandedFarZProjMatrix,q,H,U);q++}if(H.sort((G,Y)=>Y.depth-G.depth),"shadow"!==f.renderPass){if(1===y)for(const G of U)mh(G,f,l,N[G.modelIndex],Vt.disabled,f.colorModeForRenderPass());else{for(const G of U)mh(G,f,l,N[G.modelIndex],Vt.disabled,an.disabled);for(const G of U)mh(G,f,l,N[G.modelIndex],f.stencilModeFor3D(),f.colorModeForRenderPass());f.resetStencilClippingMasks()}for(const G of H)mh(G,f,l,N[G.modelIndex],Vt.disabled,f.colorModeForRenderPass());C()}else{for(const G of U)Uf(G.mesh,G.nodeModelMatrix,f,l);for(const G of H)Uf(G.mesh,G.nodeModelMatrix,f,l);C()}}},na={line:function(f,r,l){if(f.hasElevatedBuckets=!1,f.hasNonElevatedBuckets=!1,void 0!==f._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==f._unevaluatedLayout.getValue("line-z-offset")){if(r){const p=r.getVisibleCoordinates();for(const y of p){const v=r.getTile(y).getBucket(f);if(v&&("none"!==v.elevationType?f.hasElevatedBuckets=!0:f.hasNonElevatedBuckets=!0,f.hasElevatedBuckets&&f.hasNonElevatedBuckets))break}}}else f.hasNonElevatedBuckets=!0},model:function(f,r,l){const p=r.getSource();if(!p.loaded())return;if("vector"===p.type||"geojson"===p.type)return void(l.modelManager&&l.modelManager.upload(l,"vector"===p.type?f.scope:""));if("batched-model"===p.type||"model"!==p.type)return;const y=p.getModels();for(const v of y)v.upload(l.context)},raster:function(f,r,l){const p=r.getSource();if(!(p instanceof Hl&&p.loaded()))return;const y=f.sourceLayer||p.rasterLayerIds&&p.rasterLayerIds[0];if(!y)return;const v=f.paint.get("raster-array-band")||p.getInitialBand(y);if(null==v)return;const b=r.getIds().map(D=>r.getTileByID(D));for(const D of b)D.updateNeeded(f.id,v)&&p.prepareTile(D,y,f.id,v)},"raster-particle":function(f,r,l){const p=r.getSource();if(!(p instanceof Hl&&p.loaded()))return;const y=f.sourceLayer||p.rasterLayerIds&&p.rasterLayerIds[0];if(!y)return;const v=f.paint.get("raster-particle-array-band")||p.getInitialBand(y);if(null==v)return;const b=r.getIds().map(D=>r.getTileByID(D));for(const D of b)D.updateNeeded(f.id,v)&&p.prepareTile(D,y,f.id,v)}},$f={fill:Et},Ss={fill:function(f,r,l,p){if(!l.layout||"none"===l.layout.get("fill-elevation-reference"))return;const y=f.context.gl,v=new bt(y.LEQUAL,bt.ReadOnly,f.depthRangeFor3D),b=new Vt({func:y.ALWAYS,mask:255},255,255,y.KEEP,y.KEEP,y.REPLACE),D=f.transform.getFreeCameraOptions().position,C=f.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const P of p){const O=r.getTile(P),N=O.getBucket(l);if(!N)continue;const F=N.elevatedStructures;if(!F||0===F.depthSegments.segments[0].primitiveLength)continue;const B=Yu(P.toUnwrapped(),D),H=f.translatePosMatrix(P.projMatrix,O,l.paint.get("fill-translate"),l.paint.get("fill-translate-anchor")),U=um(H,B,0,1,0);C.draw(f,y.TRIANGLES,v,b,an.disabled,Bt.disabled,U,l.id,F.vertexBuffer,F.indexBuffer,F.depthSegments,l.paint,f.transform.zoom)}}};class sc{constructor(r,l,p,y,v,b){this.context=new Of(r,l),this.transform=p,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=v,this._timeStamp=u.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const D=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const P of D)this._debugParams.enabledLayers[P]=!0;v.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),v.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),v.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),v.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),v.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),v.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const P of D)v.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],P);this.occlusionParams=new ed(v),this.setup(),this.numSublayers=Po.maxUnderzooming+Po.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new u.eE,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new qi(this),this._wireframeDebugCache=new bi,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const C=new u.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new u.T(this.context,C,r.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=y,this.worldview=b}updateTerrain(r,l){const p=!!r&&!!r.terrain&&this.transform.projection.supportsTerrain;if(!(p||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Af(this,r));const y=this._terrain;this.transform.elevation=p?y:null,y.update(r,this.transform,l),this.transform.elevation&&!y.enabled&&(this.transform.elevation=null)}_updateFog(r){const l=r.fog;if(!l||"globe"===this.transform.projection.name||l.getOpacity(this.transform.pitch)<1||l.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[p,y]=l.getFovAdjustedRange(this.transform._fov);if(p>y)return void(this.transform.fogCullDistSq=null);const v=p+.78*(y-p);this.transform.fogCullDistSq=v*v}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(r){r&&!this._terrain&&(this._terrain=new Af(this,this.style)),this._forceTerrainMode=r}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(r,l){if(this.width=r*u.q.devicePixelRatio,this.height=l*u.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const p of this.style.order)this.style._mergedLayers[p].resize()}setup(){const r=this.context,l=new u.ba;l.emplaceBack(0,0),l.emplaceBack(u.aj,0),l.emplaceBack(0,u.aj),l.emplaceBack(u.aj,u.aj),this.tileExtentBuffer=r.createVertexBuffer(l,u.bc.members),this.tileExtentSegments=u.bd.simpleSegment(0,0,4,2);const p=new u.ba;p.emplaceBack(0,0),p.emplaceBack(u.aj,0),p.emplaceBack(0,u.aj),p.emplaceBack(u.aj,u.aj),this.debugBuffer=r.createVertexBuffer(p,u.bc.members),this.debugSegments=u.bd.simpleSegment(0,0,4,5);const y=new u.ba;y.emplaceBack(-1,-1),y.emplaceBack(1,-1),y.emplaceBack(-1,1),y.emplaceBack(1,1),this.viewportBuffer=r.createVertexBuffer(y,u.bc.members),this.viewportSegments=u.bd.simpleSegment(0,0,4,2);const v=new u.aZ;v.emplaceBack(0,0,0,0),v.emplaceBack(u.aj,0,u.aj,0),v.emplaceBack(0,u.aj,0,u.aj),v.emplaceBack(u.aj,u.aj,u.aj,u.aj),this.mercatorBoundsBuffer=r.createVertexBuffer(v,u.bf.members),this.mercatorBoundsSegments=u.bd.simpleSegment(0,0,4,2);const b=new u.a_;b.emplaceBack(0,1,2),b.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=r.createIndexBuffer(b);const D=new u.bb;for(const P of[0,1,3,2,0])D.emplaceBack(P);this.debugIndexBuffer=r.createIndexBuffer(D),this.emptyTexture=new u.T(r,new u.r({width:1,height:1},Uint8Array.of(0,0,0,0)),r.gl.RGBA8),this.identityMat=u.bz();const C=this.context.gl;this.stencilClearMode=new Vt({func:C.ALWAYS,mask:0},0,255,C.ZERO,C.ZERO,C.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(r){return r._makeTileBoundsBuffers(this.context,this.transform.projection),r._tileBoundsBuffer?{tileBoundsBuffer:r._tileBoundsBuffer,tileBoundsIndexBuffer:r._tileBoundsIndexBuffer,tileBoundsSegments:r._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const r=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,r.TRIANGLES,bt.disabled,this.stencilClearMode,an.disabled,Bt.disabled,qu(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(r,l,p){if(!l||this.currentStencilSource===l.id||!r.isTileClipped()||!p||0===p.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let D=!1;for(const C of p)if(void 0===this._tileClippingMaskIDs[C.key]){D=!0;break}if(!D)return}this.currentStencilSource=l.id;const y=this.context,v=y.gl;this.nextStencilID+p.length>256&&this.clearStencil(),y.setColorMode(an.disabled),y.setDepthMode(bt.disabled);const b=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const D of p){const C=l.getTile(D),P=this._tileClippingMaskIDs[D.key]=this.nextStencilID++,{tileBoundsBuffer:O,tileBoundsIndexBuffer:N,tileBoundsSegments:F}=this.getTileBoundsBuffers(C);b.draw(this,v.TRIANGLES,bt.disabled,new Vt({func:v.ALWAYS,mask:0},P,255,v.KEEP,v.KEEP,v.REPLACE),an.disabled,Bt.disabled,qu(D.projMatrix),"$clipping",O,N,F)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const r=this.nextStencilID++,l=this.context.gl;return new Vt({func:l.NOTEQUAL,mask:255},r,255,l.KEEP,l.KEEP,l.REPLACE)}stencilModeForClipping(r){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(r);const l=this.context.gl;return new Vt({func:l.EQUAL,mask:255},this._tileClippingMaskIDs[r.key],0,l.KEEP,l.KEEP,l.REPLACE)}stencilConfigForOverlap(r){const l=this.context.gl,p=r.sort((b,D)=>D.overscaledZ-b.overscaledZ),y=p[p.length-1].overscaledZ,v=p[0].overscaledZ-y+1;if(v>1){this.currentStencilSource=void 0,this.nextStencilID+v>256&&this.clearStencil();const b={};for(let D=0;D<v;D++)b[D+y]=new Vt({func:l.GEQUAL,mask:255},D+this.nextStencilID,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID+=v,[b,p]}return[{[y]:Vt.disabled},p]}colorModeForRenderPass(){const r=this.context.gl;return this._showOverdrawInspector?new an([r.CONSTANT_COLOR,r.ONE,r.CONSTANT_COLOR,r.ONE],new u.am(.125,.125,.125,0),[!0,!0,!0,!0]):"opaque"===this.renderPass?an.unblended:an.alphaBlended}colorModeForDrapableLayerRenderPass(r){const l=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new an([l.ONE,l.ONE_MINUS_SRC_ALPHA,l.CONSTANT_ALPHA,l.ONE_MINUS_SRC_ALPHA],new u.am(0,0,0,void 0===r?0:r),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(r,l,p,y=!1){if(this.depthOcclusion)return new bt(this.context.gl.GREATER,bt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!y)return bt.disabled;const v=1-((1+this.currentLayer)*this.numSublayers+r)*this.depthEpsilon;return new bt(p||this.context.gl.LEQUAL,l,[v,v])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const r=this.context.gl,l=Math.ceil(this.width),p=Math.ceil(this.height),y=this.context.bindFramebuffer.get(),v=r.getParameter(r.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===l&&this.depthFBO.height===p||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==l&&0!==p&&(this.depthFBO=new Wc(this.context,l,p,!1,"texture"),this.depthTexture=new u.T(this.context,{width:l,height:p,data:null},r.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(y),r.bindTexture(r.TEXTURE_2D,v),this.depthFBO&&(r.bindFramebuffer(r.READ_FRAMEBUFFER,null),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),r.blitFramebuffer(0,0,l,p,0,0,l,p,r.DEPTH_BUFFER_BIT,r.NEAREST),r.bindFramebuffer(r.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((r,l)=>r+l/this._fpsHistory.length,0))}render(r,l){const p=u.q.now();this._dt=p-this._timeStamp,this._timeStamp=p,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=r.map.repaint,this.style=r,this.options=l;const y=this.style._mergedLayers,v=!(!this.terrain||!this.terrain.enabled),b=()=>this.style._getOrder(v).filter(De=>{const _e=y[De];return!(_e.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[_e.type]});let D=b(),C=!1,P=!1,O=null;for(const De of D){const _e=y[De];"circle"===_e.type?C=!0:"building"===_e.type?O=_e:"symbol"===_e.type&&(_e.hasInitialOcclusionOpacityProperties?P=!0:C=!0)}let N=D.map(De=>y[De]);const F=this.style._mergedSourceCaches;this.imageManager=r.imageManager,this.modelManager=r.modelManager,this.symbolFadeChange=r.placement.symbolFadeChange(u.q.now()),this.imageManager.beginFrame();let B=0,H=!1;for(const De in F){const _e=F[De];_e.used&&(_e.prepare(this.context),_e.getSource().usedInConflation&&++B)}let U=!1;for(const De of N)De.isHidden(this.transform.zoom)||("clip"===De.type&&(U=!0),this.prepareLayer(De));const q={},G={},Y={},ee={},ne={};for(const De in F){const _e=F[De];q[De]=_e.getVisibleCoordinates(),G[De]=q[De].slice().reverse(),Y[De]=_e.getVisibleCoordinates(!0).reverse(),ee[De]=_e.getShadowCasterCoordinates(),ne[De]=_e.sortCoordinatesByDistance(q[De])}const le=De=>{const _e=this.style.getLayerSourceCache(De);return _e&&_e.used?_e.getSource():null};if(B||U||this._clippingActiveLastFrame){const De=[],_e=[];let Ne=0;for(const Re of N)this.isSourceForClippingOrConflation(Re,le(Re))&&(De.push(Re),_e.push(Ne)),Ne++;if(De&&(U||De.length>1)||this._clippingActiveLastFrame){U=!1;const Re=[];for(let We=0;We<De.length;We++){const Ze=De[We],Ye=_e[We],ct=this.style.getLayerSourceCache(Ze);if(!ct||!ct.used||!ct.getSource().usedInConflation&&"clip"!==Ze.type&&"building"!==Ze.type)continue;let Mt=u.eF,kt=u.bW.None;const vt=[];let Ot=!0;if("building"===Ze.type)Mt=u.eH;else if("clip"===Ze.type){Mt=Ye;for(const Pt of Ze.layout.get("clip-layer-types"))kt|="model"===Pt?u.bW.Model:"symbol"===Pt?u.bW.Symbol:u.bW.FillExtrusion;for(const Pt of Ze.layout.get("clip-layer-scope"))vt.push(Pt);Ze.isHidden(this.transform.zoom)?Ot=!1:U=!0}Ot&&Re.push({layer:Ze.fqid,cache:ct,order:Mt,clipMask:kt,clipScope:vt})}this.replacementSource.setSources(Re),H=!0}}this._clippingActiveLastFrame=U,H||this.replacementSource.clear(),this.conflationActive=H,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let De=0;De<N.length;De++){const _e=N[De],Ne=_e.cutoffRange();if(this.longestCutoffRange=Math.max(Ne,this.longestCutoffRange),Ne>0){const Re=le(_e);Re&&(this.minCutoffZoom=Math.max(Re.minzoom,this.minCutoffZoom)),_e.minzoom&&(this.minCutoffZoom=Math.max(_e.minzoom,this.minCutoffZoom))}_e.is3D(v)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=De),this._lastOcclusionLayer=De)}const de=this.style&&this.style.fog;de?(this._fogVisible=0!==de.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=de.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Y),this.opaquePassCutoff=0,D=b(),N=D.map(De=>y[De]));const pe=this._shadowRenderer;if(pe){pe.updateShadowParameters(this.transform,this.style.directionalLight);for(const De in F)for(const _e of q[De]){let Ne={min:0,max:0};this.terrain&&(Ne=this.terrain.getMinMaxForTile(_e)||Ne),pe.addShadowReceiver(_e.toUnwrapped(),Ne.min,Ne.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new u.eG(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Se(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const ae=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),ce=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(ae&&!this._snow&&(this._snow=new Gf(this)),!ae&&this._snow&&(this._snow.destroy(),delete this._snow),ce&&!this._rain&&(this._rain=new to(this)),!ce&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),O){this.buildingTileBorderManager||(this.buildingTileBorderManager=new m_);const De=this.style.getLayerSourceCache(O);this.buildingTileBorderManager.updateBorders(De,O)}if(!Ls.has(this.context.gl))return;this.renderPass="offscreen";for(const De of N){const _e=r.getLayerSourceCache(De);if(!De.hasOffscreenPass()||De.isHidden(this.transform.zoom))continue;const Ne=_e?G[_e.id]:void 0;("custom"===De.type||"raster"===De.type||"raster-particle"===De.type||De.isSky()||Ne&&Ne.length)&&this.renderLayer(this,_e,De,Ne)}this.depthRangeFor3D=[0,1-(N.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,ee)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ue="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),Me=(()=>{if(l.showOverdrawInspector)return u.am.black;const De=this.style.fog;if(De&&this.transform.projection.supportsFog){const _e=this.style.getLut(De.scope);if(!ue){const Ne="none"===De.properties.get("color-use-theme"),Re=De.properties.get("color").toNonPremultipliedRenderColor(Ne?null:_e).toArray01();return new u.am(...Re)}if(ue){const Ne="none"===De.properties.get("space-color-use-theme"),Re=De.properties.get("space-color").toNonPremultipliedRenderColor(Ne?null:_e).toArray01();return new u.am(...Re)}}return u.am.transparent})();if(this.context.clear({color:Me,depth:1}),this.clearStencil(),this._showOverdrawInspector=l.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ue&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=D.length-1;this.currentLayer>=0;this.currentLayer--){const De=N[this.currentLayer],_e=r.getLayerSourceCache(De);if(De.isSky())continue;const Ne=_e?(De.is3D(v)?ne:G)[_e.id]:void 0;this._renderTileClippingMasks(De,_e,Ne),this.renderLayer(this,_e,De,Ne)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ue&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||u.ah(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<D.length;this.currentLayer++){const De=N[this.currentLayer],_e=r.getLayerSourceCache(De);De.isSky()&&this.renderLayer(this,_e,De,_e?G[_e.id]:void 0)}function ye(De,_e){let Ne;return _e&&(Ne=("symbol"===De.type?Y:De.is3D(v)?ne:G)[_e.id]),Ne}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<D.length;){const De=N[this.currentLayer];if("raster"===De.type||"raster-particle"===De.type){const _e=r.getLayerSourceCache(De);this.renderLayer(this,_e,De,ye(De,_e))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let je=0;pe&&(je=pe.getShadowCastingLayerCount());let Fe=!1,Ge=-1;for(let De=0;De<D.length;++De){const _e=N[De];_e.isHidden(this.transform.zoom)||_e.is3D(v)&&(Ge=De)}P&&-1===Ge&&(C=!0);let rt=!1;for(;this.currentLayer<D.length;){const De=N[this.currentLayer],_e=r.getLayerSourceCache(De);if(De.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(De)){if(De.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!rt&&De.is3D(v)&&!v){const Ne=this.currentLayer,Re=We=>{for(this.currentLayer=0;this.currentLayer<N.length;this.currentLayer++){const Ze=N[this.currentLayer];if($f[Ze.type]){const Ye=this.style.getLayerSourceCache(Ze);$f[Ze.type](this,Ye,Ze,ye(Ze,Ye),We)}}};Re("initialize"),Re("reset"),this.currentLayer=Ne,rt=!0}if(C&&!Fe&&this.terrain&&!this.transform.isOrthographic&&(Fe=!0,this.blitDepth()),P&&-1!==Ge&&this.currentLayer===Ge+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(De,_e,_e?q[_e.id]:void 0),this.renderLayer(this,_e,De,ye(De,_e)),!this.terrain&&pe&&je>0&&De.hasShadowPass()&&0==--je){{this.clearStencil(),this.resetStencilClippingMasks();const Ne=this.currentLayer;for(this.currentLayer=0;this.currentLayer<N.length;this.currentLayer++){const Re=N[this.currentLayer];if(Ss[Re.type]){const We=this.style.getLayerSourceCache(Re);Ss[Re.type](this,We,Re,ye(Re,We))}}this.currentLayer=Ne}if(pe.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const Ne=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Ne;this.currentLayer++){const Re=N[this.currentLayer];if(!Re.hasLightBeamPass())continue;const We=r.getLayerSourceCache(Re);this.renderLayer(this,We,Re,We?G[We.id]:void 0)}this.currentLayer=Ne,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Ne=this.currentLayer;this.depthOcclusion=!0;for(const Re of this.layersWithOcclusionOpacity){this.currentLayer=Re;const We=N[this.currentLayer],Ze=r.getLayerSourceCache(We),Ye=Ze?G[Ze.id]:void 0;this.terrain||this._renderTileClippingMasks(We,Ze,Ze?q[Ze.id]:void 0),this.renderLayer(this,Ze,We,Ye)}this.depthOcclusion=!1,this.currentLayer=Ne,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let De=null;N.forEach(_e=>{const Ne=r.getLayerSourceCache(_e);Ne&&!_e.isHidden(this.transform.zoom)&&Ne.getVisibleCoordinates().length&&(!De||De.getSource().maxzoom<Ne.getSource().maxzoom)&&(De=Ne)}),De&&this.options.showTileBoundaries&&Gs(this,De,De.getVisibleCoordinates(),u.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Gs(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new u.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(De){const _e=De.transform.padding;fh(De,De.transform.height-(_e.top||0),3,_a),fh(De,_e.bottom||0,3,Bf),ph(De,_e.left||0,3,Vf),ph(De,De.transform.width-(_e.right||0),3,dr);const Ne=De.transform.centerPoint;var Re,We,Ze,Ye;za(Re=De,(We=Ne.x)-1,(Ze=De.transform.height-Ne.y)-10,2,20,Ye=jf),za(Re,We-10,Ze-1,20,2,Ye)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),H||(this.conflationActive=!1)}prepareLayer(r){this.gpuTimingStart(r);const{unsupportedLayers:l}=this.transform.projection,p=!l||!l.includes(r.type);if(na[r.type]&&(p||this.terrain&&"custom"===r.type)){const y=this.style.getLayerSourceCache(r);na[r.type](r,y,this)}this.gpuTimingEnd()}renderLayer(r,l,p,y){p.isHidden(this.transform.zoom)||("background"===p.type||"sky"===p.type||"custom"===p.type||"model"===p.type||"raster"===p.type||"raster-particle"===p.type||y&&y.length)&&(this.id=p.id,this.gpuTimingStart(p),r.transform.projection.unsupportedLayers&&r.transform.projection.unsupportedLayers.includes(p.type)&&(!r.terrain||"custom"!==p.type)||"clip"===p.type||oc[p.type](r,l,p,y,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(r){if(!this.options.gpuTiming)return;const l=this.context.extTimerQuery,p=this.context.gl;let y=this.gpuTimers[r.id];y||(y=this.gpuTimers[r.id]={calls:0,cpuTime:0,query:p.createQuery()}),y.calls++,p.beginQuery(l.TIME_ELAPSED_EXT,y.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const r=this.context.extTimerQuery,l=this.context.gl,p=l.createQuery();this.deferredRenderGpuTimeQueries.push(p),l.beginQuery(r.TIME_ELAPSED_EXT,p)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const r=this.gpuTimers;return this.gpuTimers={},r}collectDeferredRenderGpuQueries(){const r=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],r}queryGpuTimers(r){const l={};for(const p in r){const y=r[p],v=this.context.extTimerQuery,b=v.getQueryParameter(y.query,this.context.gl.QUERY_RESULT)/1e6;v.deleteQueryEXT(y.query),l[p]=b}return l}queryGpuTimeDeferredRender(r){if(!this.options.gpuTimingDeferredRender)return 0;const l=this.context.gl;let p=0;for(const y of r)p+=l.getQueryParameter(y,l.QUERY_RESULT)/1e6,l.deleteQuery(y);return p}translatePosMatrix(r,l,p,y,v){if(!p[0]&&!p[1])return r;const b=v?"map"===y?this.transform.angle:0:"viewport"===y?-this.transform.angle:0;if(b){const P=Math.sin(b),O=Math.cos(b);p=[p[0]*O-p[1]*P,p[0]*P+p[1]*O]}const D=[v?p[0]:u.aw(l,p[0],this.transform.zoom),v?p[1]:u.aw(l,p[1],this.transform.zoom),0],C=new Float32Array(16);return u.bo(C,r,D),C}saveTileTexture(r){if(r.context!==this.context)return;const l=r.size[0],p=this._tileTextures[l];p?p.push(r):this._tileTextures[l]=[r]}getTileTexture(r){const l=this._tileTextures[r];return l&&l.length>0?l.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(r,l,p){const y=void 0===p?this.terrain&&this.terrain.renderingToTexture:p,v=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===r||"terrainRaster"===r?(v.push("LIGHTING_3D_MODE"),v.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):y||v.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||v.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(v.push("TERRAIN"),this.linearFloatFilteringSupported()&&v.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&v.push("GLOBE"),!this._fogVisible||y||void 0!==l&&!l||v.push("FOG","FOG_DITHERING"),y&&v.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&v.push("OVERDRAW_INSPECTOR"),v}getOrCreateProgram(r,l){this.cache=this.cache||{};const p=l&&l.defines||[],y=l&&l.config,v=this.currentGlobalDefines(r,l&&l.overrideFog,l&&l.overrideRtt).concat(p),b=lm.cacheKey(wo[r],r,v,y);return this.cache[b]||(this.cache[b]=new lm(this.context,r,wo[r],y,fm[r],v)),this.cache[b]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const r=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(r.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new u.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(r,l){if(this.style.enable3dLights()){const p=this.style.directionalLight,y=this.style.ambientLight;if(p&&y){const v=((b,D,C)=>{const P=b.properties.get("direction"),O="none"===b.properties.get("color-use-theme"),N=b.properties.get("color").toNonPremultipliedRenderColor(O?null:C.getLut(b.scope)).toArray01(),F=b.properties.get("intensity"),B="none"===D.properties.get("color-use-theme"),H=D.properties.get("color").toNonPremultipliedRenderColor(B?null:C.getLut(D.scope)).toArray01(),U=D.properties.get("intensity"),q=[P.x,P.y,P.z],G=u.dI(H,U),Y=u.dI(N,F);return{u_lighting_ambient_color:G,u_lighting_directional_dir:q,u_lighting_directional_color:Y,u_ground_radiance:n_(q,Y,G)}})(p,y,this.style);l.setLightsUniformValues(r,v)}}}uploadCommonUniforms(r,l,p,y,v){if(this.uploadCommonLightUniforms(r,l),this.terrain&&this.terrain.renderingToTexture)return;const b=this.style.fog;if(b){const D=b.getOpacity(this.transform.pitch),C=((P,O,N,F,B,H,U,q,G,Y,ee,ne)=>{const le=P.transform,de="none"===O.properties.get("color-use-theme"),pe=O.properties.get("color").toNonPremultipliedRenderColor(de?null:P.style.getLut(O.scope)).toArray01();pe[3]=F;const ae=P.frameCounter/1e3%1,[ce,ue]=O.properties.get("vertical-range");return{u_fog_matrix:N?le.calculateFogTileMatrix(N):ne||P.identityMat,u_fog_range:O.getFovAdjustedRange(le._fov),u_fog_color:pe,u_fog_horizon_blend:O.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(ce,ue),ue],u_fog_temporal_offset:ae,u_frustum_tl:B,u_frustum_tr:H,u_frustum_br:U,u_frustum_bl:q,u_globe_pos:G,u_globe_radius:Y,u_viewport:ee,u_globe_transition:u.ah(le.zoom),u_is_globe:+("globe"===le.projection.name)}})(this,b,p,D,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*u.q.devicePixelRatio,this.transform.height*u.q.devicePixelRatio],y);l.setFogUniformValues(r,C)}v&&l.setCutoffUniformValues(r,v.uniformValues)}setTileLoadedFlag(r){this.tileLoaded=r}saveCanvasCopy(){const r=this.canvasCopy();r&&(this.frameCopies.push(r),this.tileLoaded=!1)}canvasCopy(){const r=this.context.gl,l=r.createTexture();return r.bindTexture(r.TEXTURE_2D,l),r.copyTexImage2D(r.TEXTURE_2D,0,r.RGBA,0,0,r.drawingBufferWidth,r.drawingBufferHeight,0),l}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const r=this.style&&this.style.fog;return!!r&&0!==r.getOpacity(this.transform.pitch)}getBackgroundTiles(){const r=this._backgroundTiles,l=this._backgroundTiles={},p=this.transform.coveringTiles({tileSize:512});for(const y of p)l[y.key]=r[y.key]||new Cc(y,512,this.transform.tileZoom,this,void 0,this.worldview);return l}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(r,l){return!(!r.is3D(!(!this.terrain||!this.terrain.enabled))||"clip"!==r.type&&"building"!==r.type&&(r.minzoom&&r.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==r.sourceLayer&&"procedural_buildings"!==r.sourceLayer)&&(!l||"batched-model"!==l.type)))}isTileAffectedByFog(r){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let l=this._cachedTileFogOpacities[r.key];return l||(this._cachedTileFogOpacities[r.key]=l=this.style.fog.getOpacityForTile(r)),l[0]>=qe||l[1]>=qe}setupDepthForOcclusion(r,l,p){const y=this.context,v=y.gl,b=!!p;var D;p||(p={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),y.activeTexture.set(v.TEXTURE3),r&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(v.NEAREST,v.CLAMP_TO_EDGE),p.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],p.u_depth_range_unpack=[2/((D=this.depthRangeFor3D)[1]-D[0]),-1-2*D[0]/(D[1]-D[0])],p.u_occluder_half_size=.5*this.occlusionParams.occluderSize,p.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(v.NEAREST,v.CLAMP_TO_EDGE),y.activeTexture.set(v.TEXTURE0),b||l.setTerrainUniformValues(y,p)}}function td(f,r){let l=!1,p=null;const y=()=>{p=null,l&&(f(),p=setTimeout(y,r),l=!1)};return()=>(l=!0,p||y(),p)}class nd{constructor(r){this._hashName=r&&encodeURIComponent(r),u.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=td(this._updateHashUnthrottled.bind(this),300)}addTo(r){return this._map=r,window.addEventListener("hashchange",this._onHashChange,!1),r.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const r=this._map;if(!r)return"";const l=id(r);if(this._hashName){const p=this._hashName;let y=!1;const v=location.hash.slice(1).split("&").map(b=>{const D=b.split("=")[0];return D===p?(y=!0,`${D}=${l}`):b}).filter(b=>b);return y||v.push(`${p}=${l}`),`#${v.join("&")}`}return`#${l}`}_getCurrentHash(){const r=location.hash.replace("#","");if(this._hashName){let l;return r.split("&").map(p=>p.split("=")).forEach(p=>{p[0]===this._hashName&&(l=p)}),(l&&l[1]||"").split("/")}return r.split("/")}_onHashChange(){const r=this._map;if(!r)return!1;const l=this._getCurrentHash();if(l.length>=3&&!l.some(p=>isNaN(Number(p)))){const p=r.dragRotate.isEnabled()&&r.touchZoomRotate.isEnabled()?+(l[3]||0):r.getBearing();return r.jumpTo({center:[+l[2],+l[1]],zoom:+l[0],bearing:p,pitch:+(l[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function id(f,r){const l=f.getCenter(),p=Math.round(100*f.getZoom())/100,y=Math.ceil((p*Math.LN2+Math.log(512/360/.5))/Math.LN10),v=Math.pow(10,y),b=Math.round(l.lng*v)/v,D=Math.round(l.lat*v)/v,C=f.getBearing(),P=f.getPitch();let O=r?`/${b}/${D}/${p}`:`${p}/${D}/${b}`;return(C||P)&&(O+="/"+Math.round(10*C)/10),P&&(O+=`/${Math.round(P)}`),O}const Qc={linearity:.3,easing:u.eI(0,0,.3,1)},Ba=u.h({deceleration:2500,maxSpeed:1400},Qc),xm=u.h({deceleration:20,maxSpeed:1400},Qc),va=u.h({deceleration:1e3,maxSpeed:360},Qc),_h=u.h({deceleration:1e3,maxSpeed:90},Qc);class yh{constructor(r){this._map=r,this.clear()}clear(){this._inertiaBuffer=[]}record(r){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:u.q.now(),settings:r})}_drainInertiaBuffer(){const r=this._inertiaBuffer,l=u.q.now();for(;r.length>0&&l-r[0].time>160;)r.shift()}_onMoveEnd(r){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const l={zoom:0,bearing:0,pitch:0,pan:new u.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:v}of this._inertiaBuffer)l.zoom+=v.zoomDelta||0,l.bearing+=v.bearingDelta||0,l.pitch+=v.pitchDelta||0,v.panDelta&&l.pan._add(v.panDelta),v.around&&(l.around=v.around),v.pinchAround&&(l.pinchAround=v.pinchAround);const p=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,y={};if(l.pan.mag()){const v=eu(l.pan.mag(),p,u.h({},Ba,r||{}));y.offset=l.pan.mult(v.amount/l.pan.mag()),y.center=this._map.transform.center,Jc(y,v)}if(l.zoom){const v=eu(l.zoom,p,xm);y.zoom=this._map.transform.zoom+v.amount,Jc(y,v)}if(l.bearing){const v=eu(l.bearing,p,va);y.bearing=this._map.transform.bearing+u.ay(v.amount,-179,179),Jc(y,v)}if(l.pitch){const v=eu(l.pitch,p,_h);y.pitch=this._map.transform.pitch+v.amount,Jc(y,v)}if(y.zoom||y.bearing){const v=void 0===l.pinchAround?l.around:l.pinchAround;y.around=v?this._map.unproject(v):this._map.getCenter()}return this.clear(),y.noMoveStart=!0,y}}function Jc(f,r){(!f.duration||f.duration<r.duration)&&(f.duration=r.duration,f.easing=r.easing)}function eu(f,r,l){const{maxSpeed:p,linearity:y,deceleration:v}=l,b=u.ay(f*y/(r/1e3),-p,p),D=Math.abs(b)/(v*y);return{easing:l.easing,duration:1e3*D,amount:b*(D/2)}}class Pi extends u.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,l,p,y={}){const v=da(l.getCanvasContainer(),p),b=l.unproject(v);super(r,u.h({point:v,lngLat:b,originalEvent:p},y)),this._defaultPrevented=!1,this.target=l}}class ac extends u.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,l,p){const y="touchend"===r?p.changedTouches:p.touches,v=Ia(l.getCanvasContainer(),y),b=v.map(C=>l.unproject(C)),D=v.reduce((C,P,O,N)=>C.add(P.div(N.length)),new u.P(0,0));super(r,{points:v,point:D,lngLats:b,lngLat:l.unproject(D),originalEvent:p}),this._defaultPrevented=!1}}class bm extends u.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,l){super("wheel",{originalEvent:l}),this._defaultPrevented=!1}}class wm{constructor(r,l){this._map=r,this._clickTolerance=l.clickTolerance}reset(){this._mousedownPos=void 0}wheel(r){return this._firePreventable(new bm(this._map,r))}mousedown(r,l){return this._mousedownPos=l,this._firePreventable(new Pi(r.type,this._map,r))}mouseup(r){this._map.fire(new Pi(r.type,this._map,r))}preclick(r){const l=u.h({},r);l.type="preclick",this._map.fire(new Pi(l.type,this._map,l))}click(r,l){this._mousedownPos&&this._mousedownPos.dist(l)>=this._clickTolerance||(this.preclick(r),this._map.fire(new Pi(r.type,this._map,r)))}dblclick(r){return this._firePreventable(new Pi(r.type,this._map,r))}mouseover(r){this._map.fire(new Pi(r.type,this._map,r))}mouseout(r){this._map.fire(new Pi(r.type,this._map,r))}touchstart(r){return this._firePreventable(new ac(r.type,this._map,r))}touchmove(r){this._map.fire(new ac(r.type,this._map,r))}touchend(r){this._map.fire(new ac(r.type,this._map,r))}touchcancel(r){this._map.fire(new ac(r.type,this._map,r))}_firePreventable(r){if(this._map.fire(r),r.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Hr{constructor(r){this._map=r}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(r){this._map.fire(new Pi(r.type,this._map,r))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Pi("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(r){this._delayContextMenu?this._contextMenuEvent=r:this._map.fire(new Pi(r.type,this._map,r)),this._map.listens("contextmenu")&&r.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class pl{constructor(r,l){this._map=r,this._el=r.getCanvasContainer(),this._container=r.getContainer(),this._clickTolerance=l.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(r,l){this.isEnabled()&&r.shiftKey&&0===r.button&&(ys(),this._startPos=this._lastPos=l,this._active=!0)}mousemoveWindow(r,l){if(!this._active)return;const p=l,y=this._startPos,v=this._lastPos;if(!y||!v||v.equals(p)||!this._box&&p.dist(y)<this._clickTolerance)return;this._lastPos=p,this._box||(this._box=fn("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",r));const b=Math.min(y.x,p.x),D=Math.max(y.x,p.x),C=Math.min(y.y,p.y),P=Math.max(y.y,p.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${b}px,${C}px)`,this._box.style.width=D-b+"px",this._box.style.height=P-C+"px")})}mouseupWindow(r,l){if(!this._active)return;const p=this._startPos,y=l;if(p&&0===r.button){if(this.reset(),Bl(),p.x!==y.x||p.y!==y.y)return this._map.fire(new u.A("boxzoomend",{originalEvent:r})),{cameraAnimation:v=>v.fitScreenCoordinates(p,y,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",r)}}keydown(r){this._active&&27===r.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",r))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Ws(),delete this._startPos,delete this._lastPos}_fireEvent(r,l){return this._map.fire(new u.A(r,{originalEvent:l}))}}function yr(f,r){const l={};for(let p=0;p<f.length;p++)l[f[p].identifier]=r[p];return l}class Em{constructor(r){this.reset(),this.numTouches=r.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(r,l,p){(this.centroid||p.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=r.timeStamp),p.length===this.numTouches&&(this.centroid=function(y){const v=new u.P(0,0);for(const b of y)v._add(b);return v.div(y.length)}(l),this.touches=yr(p,l)))}touchmove(r,l,p){if(this.aborted||!this.centroid)return;const y=yr(p,l);for(const v in this.touches){const b=y[v];(!b||b.dist(this.touches[v])>30)&&(this.aborted=!0)}}touchend(r,l,p){if((!this.centroid||r.timeStamp-this.startTime>500)&&(this.aborted=!0),0===p.length){const y=!this.aborted&&this.centroid;if(this.reset(),y)return y}}}class lc{constructor(r){this.singleTap=new Em(r),this.numTaps=r.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(r,l,p){this.singleTap.touchstart(r,l,p)}touchmove(r,l,p){this.singleTap.touchmove(r,l,p)}touchend(r,l,p){const y=this.singleTap.touchend(r,l,p);if(y){const v=r.timeStamp-this.lastTime<500,b=!this.lastTap||this.lastTap.dist(y)<30;if(v&&b||this.reset(),this.count++,this.lastTime=r.timeStamp,this.lastTap=y,this.count===this.numTaps)return this.reset(),y}}}class Tm{constructor(){this._zoomIn=new lc({numTouches:1,numTaps:2}),this._zoomOut=new lc({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(r,l,p){this._zoomIn.touchstart(r,l,p),this._zoomOut.touchstart(r,l,p)}touchmove(r,l,p){this._zoomIn.touchmove(r,l,p),this._zoomOut.touchmove(r,l,p)}touchend(r,l,p){const y=this._zoomIn.touchend(r,l,p),v=this._zoomOut.touchend(r,l,p);return y?(this._active=!0,r.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()+1,around:b.unproject(y)},{originalEvent:r})}):v?(this._active=!0,r.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()-1,around:b.unproject(v)},{originalEvent:r})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Dm={0:1,2:2},vh={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class tu{constructor(r){this.reset(),this._clickTolerance=r.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(r,l){return!1}_move(r,l){return{}}mousedown(r,l){if(this._lastPoint)return;const p=df(r);this._correctButton(r,p)&&(this._lastPoint=l,this._eventButton=p)}mousemoveWindow(r,l){const p=this._lastPoint;if(p)if(r.preventDefault(),null!=this._eventButton&&function(y,v){const b=Dm[v];return void 0===y.buttons||(y.buttons&b)!==b}(r,this._eventButton))this.reset();else if(this._moved||!(l.dist(p)<this._clickTolerance))return this._moved=!0,this._lastPoint=l,this._move(p,l)}mouseupWindow(r){this._lastPoint&&df(r)===this._eventButton&&(this._moved&&Bl(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class rd extends tu{mousedown(r,l){super.mousedown(r,l),this._lastPoint&&(this._active=!0)}_correctButton(r,l){return 0===l&&!r.ctrlKey}_move(r,l){return{around:l,panDelta:l.sub(r)}}}class xa extends tu{constructor(r){super(r),this._pitchRotateKey=r.pitchRotateKey?vh[r.pitchRotateKey]:void 0}_correctButton(r,l){return this._pitchRotateKey?0===l&&r[this._pitchRotateKey]:0===l&&r.ctrlKey||2===l}_move(r,l){const p=.8*(l.x-r.x);if(p)return this._active=!0,{bearingDelta:p}}contextmenu(r){this._pitchRotateKey||r.preventDefault()}}class Sm extends tu{constructor(r){super(r),this._pitchRotateKey=r.pitchRotateKey?vh[r.pitchRotateKey]:void 0}_correctButton(r,l){return this._pitchRotateKey?0===l&&r[this._pitchRotateKey]:0===l&&r.ctrlKey||2===l}_move(r,l){const p=-.5*(l.y-r.y);if(p)return this._active=!0,{pitchDelta:p}}contextmenu(r){this._pitchRotateKey||r.preventDefault()}}class xh{constructor(r,l){this._map=r,this._el=r.getCanvasContainer(),this._minTouches=1,this._clickTolerance=l.clickTolerance||1,this.reset(),u.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new u.P(0,0)}touchstart(r,l,p){return this._calculateTransform(r,l,p)}touchmove(r,l,p){if(this._active&&!(p.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===p.length&&!u.eJ())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return r.cancelable&&r.preventDefault(),this._calculateTransform(r,l,p)}}touchend(r,l,p){this._calculateTransform(r,l,p),this._active&&p.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(r,l,p){p.length>0&&(this._active=!0);const y=yr(p,l),v=new u.P(0,0),b=new u.P(0,0);let D=0;for(const P in y){const O=y[P],N=this._touches[P];N&&(v._add(O),b._add(O.sub(N)),D++,y[P]=O)}if(this._touches=y,D<this._minTouches||!b.mag())return;const C=b.div(D);return this._sum._add(C),this._sum.mag()<this._clickTolerance?void 0:{around:v.div(D),panDelta:C}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=fn("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class nu{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(r){}_move(r,l,p){return{}}touchstart(r,l,p){this._firstTwoTouches||p.length<2||(this._firstTwoTouches=[p[0].identifier,p[1].identifier],this._start([l[0],l[1]]))}touchmove(r,l,p){const y=this._firstTwoTouches;if(!y)return;r.preventDefault();const[v,b]=y,D=cc(p,l,v),C=cc(p,l,b);if(!D||!C)return;const P=this._aroundCenter?null:D.add(C).div(2);return this._move([D,C],P,r)}touchend(r,l,p){if(!this._firstTwoTouches)return;const[y,v]=this._firstTwoTouches,b=cc(p,l,y),D=cc(p,l,v);b&&D||(this._active&&Bl(),this.reset())}touchcancel(){this.reset()}enable(r){this._enabled=!0,this._aroundCenter=!!r&&"center"===r.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function cc(f,r,l){for(let p=0;p<f.length;p++)if(f[p].identifier===l)return r[p]}function bh(f,r){return Math.log(f/r)/Math.LN2}class Cm extends nu{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(r){this._startDistance=this._distance=r[0].dist(r[1])}_move(r,l){const p=this._distance;if(this._distance=r[0].dist(r[1]),this._active||!(Math.abs(bh(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:bh(this._distance,p),pinchAround:l}}}function qf(f,r){return 180*f.angleWith(r)/Math.PI}class v_ extends nu{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(r){this._startVector=this._vector=r[0].sub(r[1]),this._minDiameter=r[0].dist(r[1])}_move(r,l){const p=this._vector;if(this._vector=r[0].sub(r[1]),p&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:qf(this._vector,p),pinchAround:l}}_isBelowThreshold(r){this._minDiameter=Math.min(this._minDiameter,r.mag());const l=25/(Math.PI*this._minDiameter)*360,p=this._startVector;if(!p)return!1;const y=qf(r,p);return Math.abs(y)<l}}function ml(f){return Math.abs(f.y)>Math.abs(f.x)}class od extends nu{constructor(r){super(),this._map=r}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(r){this._lastPoints=r,ml(r[0].sub(r[1]))&&(this._valid=!1)}_move(r,l,p){const y=this._lastPoints;if(!y)return;const v=r[0].sub(y[0]),b=r[1].sub(y[1]);return this._map._cooperativeGestures&&!u.eJ()&&p.touches.length<3||(this._valid=this.gestureBeginsVertically(v,b,p.timeStamp),!this._valid)?void 0:(this._lastPoints=r,this._active=!0,{pitchDelta:(v.y+b.y)/2*-.5})}gestureBeginsVertically(r,l,p){if(void 0!==this._valid)return this._valid;const y=r.mag()>=2,v=l.mag()>=2;if(!y&&!v)return;if(!y||!v)return null==this._firstMove&&(this._firstMove=p),p-this._firstMove<100&&void 0;const b=r.y>0==l.y>0;return ml(r)&&ml(l)&&b}}const x_={panStep:100,bearingStep:15,pitchStep:10};class Mv{constructor(){const r=x_;this._panStep=r.panStep,this._bearingStep=r.bearingStep,this._pitchStep=r.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(r){if(r.altKey||r.ctrlKey||r.metaKey)return;let l=0,p=0,y=0,v=0,b=0;switch(r.keyCode){case 61:case 107:case 171:case 187:l=1;break;case 189:case 109:case 173:l=-1;break;case 37:r.shiftKey?p=-1:(r.preventDefault(),v=-1);break;case 39:r.shiftKey?p=1:(r.preventDefault(),v=1);break;case 38:r.shiftKey?y=1:(r.preventDefault(),b=-1);break;case 40:r.shiftKey?y=-1:(r.preventDefault(),b=1);break;default:return}return this._rotationDisabled&&(p=0,y=0),{cameraAnimation:D=>{const C=D.getZoom();D.easeTo({duration:300,easeId:"keyboardHandler",easing:Wf,zoom:l?Math.round(C)+l*(r.shiftKey?2:1):C,bearing:D.getBearing()+p*this._bearingStep,pitch:D.getPitch()+y*this._pitchStep,offset:[-v*this._panStep,-b*this._panStep],center:D.getCenter()},{originalEvent:r})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Wf(f){return f*(2-f)}const Pv=4.000244140625;class Ov{constructor(r,l){this._map=r,this._el=r.getCanvasContainer(),this._handler=l,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,u.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(r){this._defaultZoomRate=r}setWheelZoomRate(r){this._wheelZoomRate=r}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(r){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!r&&"center"===r.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(r){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(r.ctrlKey||r.metaKey||this.isZooming()||u.eJ()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let l=r.deltaMode===WheelEvent.DOM_DELTA_LINE?40*r.deltaY:r.deltaY;const p=u.q.now(),y=p-(this._lastWheelEventTime||0);this._lastWheelEventTime=p,0!==l&&l%Pv==0?this._type="wheel":0!==l&&Math.abs(l)<4?this._type="trackpad":y>400?(this._type=null,this._lastValue=l,this._timeout=window.setTimeout(this._onTimeout,40,r)):this._type||(this._type=Math.abs(y*l)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,l+=this._lastValue)),r.shiftKey&&l&&(l/=4),this._type&&(this._lastWheelEvent=r,this._delta-=l,this._active||this._start(r)),r.preventDefault()}_onTimeout(r){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(r)}_start(r){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const l=da(this._el,r);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:l,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const r=this._map.transform;"wheel"===this._type&&r.projection.wrap&&(r._center.lng>=180||r._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const l=()=>r._terrainEnabled()&&this._aroundCoord?r.computeZoomRelativeTo(this._aroundCoord):r.zoom;if(0!==this._delta){const P="wheel"===this._type&&Math.abs(this._delta)>Pv?this._wheelZoomRate:this._defaultZoomRate;let O=2/(1+Math.exp(-Math.abs(this._delta*P)));this._delta<0&&0!==O&&(O=1/O);const N=l(),F=Math.pow(2,N),B="number"==typeof this._targetZoom?r.zoomScale(this._targetZoom):F;this._targetZoom=Math.min(r.maxZoom,Math.max(r.minZoom,r.scaleZoom(B*O))),"wheel"===this._type&&(this._startZoom=N,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const p="number"==typeof this._targetZoom?this._targetZoom:l(),y=this._startZoom,v=this._easing;let b,D=!1;if("wheel"===this._type&&y&&v){const P=Math.min((u.q.now()-this._lastWheelEventTime)/200,1),O=v(P);b=u.ai(y,p,O),P<1?this._frameId||(this._frameId=!0):D=!0}else b=p,D=!0;this._active=!0,D&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let C=b-l();return C*this._lastDelta<0&&(C=0),{noInertia:!0,needsRenderFrame:!D,zoomDelta:C,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(r){let l=u.eK;if(this._prevEase){const p=this._prevEase,y=(u.q.now()-p.start)/p.duration,v=p.easing(y+.01)-p.easing(y),b=.27/Math.sqrt(v*v+1e-4)*.01,D=Math.sqrt(.0729-b*b);l=u.eI(b,D,.25,1)}return this._prevEase={start:u.q.now(),duration:r,easing:l},l}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=fn("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Wi{constructor(r,l){this._clickZoom=r,this._tapZoom=l}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Fv{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(r,l){return r.preventDefault(),{cameraAnimation:p=>{p.easeTo({duration:300,zoom:p.getZoom()+(r.shiftKey?-1:1),around:p.unproject(l)},{originalEvent:r})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Im{constructor(){this._tap=new lc({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(r,l,p){this._swipePoint||(this._tapTime&&r.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?p.length>0&&(this._swipePoint=l[0],this._swipeTouch=p[0].identifier):this._tap.touchstart(r,l,p))}touchmove(r,l,p){if(this._tapTime){if(this._swipePoint){if(p[0].identifier!==this._swipeTouch)return;const y=l[0],v=y.y-this._swipePoint.y;return this._swipePoint=y,r.preventDefault(),this._active=!0,{zoomDelta:v/128}}}else this._tap.touchmove(r,l,p)}touchend(r,l,p){this._tapTime?this._swipePoint&&0===p.length&&this.reset():this._tap.touchend(r,l,p)&&(this._tapTime=r.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class iu{constructor(r,l,p){this._el=r,this._mousePan=l,this._touchPan=p}enable(r){this._inertiaOptions=r||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class kv{constructor(r,l,p){this._pitchWithRotate=r.pitchWithRotate,this._mouseRotate=l,this._mousePitch=p}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class gl{constructor(r,l,p,y){this._el=r,this._touchZoom=l,this._touchRotate=p,this._tapDragZoom=y,this._rotationDisabled=!1,this._enabled=!0}enable(r){this._touchZoom.enable(r),this._rotationDisabled||this._touchRotate.enable(r),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const ru=f=>f.zoom||f.drag||f.pitch||f.rotate;class sd extends u.A{}class Am{constructor(){this.constants=[1,1,.01],this.radius=0}setup(r,l){const p=u.at([],l,r);this.radius=u.ae(p[2]<0?u.eM([],p,this.constants):[p[0],p[1],0])}projectRay(r){u.eM(r,r,this.constants),u.au(r,r),u.eN(r,r,this.constants);const l=u.c1([],r,this.radius);if(l[2]>0){const p=u.c1([],[0,0,1],u.bG(l,[0,0,1])),y=u.c1([],u.au([],[l[0],l[1],0]),this.radius),v=u.d5([],l,u.c1([],u.at([],u.d5([],y,p),l),2));l[0]=v[0],l[1]=v[1]}return l}}function $s(f){return f.panDelta&&f.panDelta.mag()||f.zoomDelta||f.bearingDelta||f.pitchDelta}class wh{constructor(r,l){this._map=r,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new yh(r),this._bearingSnap=l.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Am,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(l),u.aV(["handleEvent","handleWindowEvent"],this);const p=this._el;this._listeners=[[p,"touchstart",{passive:!0}],[p,"touchmove",{passive:!1}],[p,"touchend",void 0],[p,"touchcancel",void 0],[p,"mousedown",void 0],[p,"mousemove",void 0],[p,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[p,"mouseover",void 0],[p,"mouseout",void 0],[p,"dblclick",void 0],[p,"click",void 0],[p,"keydown",{capture:!1}],[p,"keyup",void 0],[p,"wheel",{passive:!1}],[p,"contextmenu",void 0],[window,"blur",void 0]];for(const[y,v,b]of this._listeners){const D=y===document?this.handleWindowEvent:this.handleEvent;y.addEventListener(v,D,b)}}destroy(){for(const[r,l,p]of this._listeners){const y=r===document?this.handleWindowEvent:this.handleEvent;r.removeEventListener(l,y,p)}}_addDefaultHandlers(r){const l=this._map,p=l.getCanvasContainer();this._add("mapEvent",new wm(l,r));const y=l.boxZoom=new pl(l,r);this._add("boxZoom",y);const v=new Tm,b=new Fv;l.doubleClickZoom=new Wi(b,v),this._add("tapZoom",v),this._add("clickZoom",b);const D=new Im;this._add("tapDragZoom",D);const C=l.touchPitch=new od(l);this._add("touchPitch",C);const P=new xa(r),O=new Sm(r);l.dragRotate=new kv(r,P,O),this._add("mouseRotate",P,["mousePitch"]),this._add("mousePitch",O,["mouseRotate"]);const N=new rd(r),F=new xh(l,r);l.dragPan=new iu(p,N,F),this._add("mousePan",N),this._add("touchPan",F,["touchZoom","touchRotate"]);const B=new v_,H=new Cm;l.touchZoomRotate=new gl(p,H,B,D),this._add("touchRotate",B,["touchPan","touchZoom"]),this._add("touchZoom",H,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Hr(l));const U=l.scrollZoom=new Ov(l,this);this._add("scrollZoom",U,["mousePan"]);const q=l.keyboard=new Mv;this._add("keyboard",q);for(const G of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])r.interactive&&r[G]&&l[G].enable(r[G])}_add(r,l,p){this._handlers.push({handlerName:r,handler:l,allowed:p}),this._handlersById[r]=l}stop(r){if(!this._updatingCamera){for(const{handler:l}of this._handlers)l.reset();this._inertia.clear(),this._fireEvents({},{},r),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:r}of this._handlers)if(r.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!ru(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(r,l,p){for(const y in r)if(y!==p&&(!l||l.indexOf(y)<0))return!0;return!1}handleWindowEvent(r){this.handleEvent(r,`${r.type}Window`)}_getMapTouches(r){const l=[];for(const p of r)this._el.contains(p.target)&&l.push(p);return l}handleEvent(r,l){this._updatingCamera=!0;const p="renderFrame"===r.type,y=p?void 0:r,v={needsRenderFrame:!1},b={},D={},C=r.touches?this._getMapTouches(r.touches):void 0,P=C?Ia(this._el,C):p?void 0:da(this._el,r);for(const{handlerName:F,handler:B,allowed:H}of this._handlers){if(!B.isEnabled())continue;let U;this._blockedByActive(D,H,F)?B.reset():B[l||r.type]&&(U=B[l||r.type](r,P,C),this.mergeHandlerResult(v,b,U,F,y),U&&U.needsRenderFrame&&this._triggerRenderFrame()),(U||B.isActive())&&(D[F]=B)}const O={};for(const F in this._previousActiveHandlers)D[F]||(O[F]=y);this._previousActiveHandlers=D,(Object.keys(O).length||$s(v))&&(this._changes.push([v,b,O]),this._triggerRenderFrame()),(Object.keys(D).length||$s(v))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:N}=v;N&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],N(this._map))}mergeHandlerResult(r,l,p,y,v){if(!p)return;u.h(r,p);const b={handlerName:y,originalEvent:p.originalEvent||v};void 0!==p.zoomDelta&&(l.zoom=b),void 0!==p.panDelta&&(l.drag=b),void 0!==p.pitchDelta&&(l.pitch=b),void 0!==p.bearingDelta&&(l.rotate=b)}_applyChanges(){const r={},l={},p={};for(const[y,v,b]of this._changes)y.panDelta&&(r.panDelta=(r.panDelta||new u.P(0,0))._add(y.panDelta)),y.zoomDelta&&(r.zoomDelta=(r.zoomDelta||0)+y.zoomDelta),y.bearingDelta&&(r.bearingDelta=(r.bearingDelta||0)+y.bearingDelta),y.pitchDelta&&(r.pitchDelta=(r.pitchDelta||0)+y.pitchDelta),void 0!==y.around&&(r.around=y.around),void 0!==y.aroundCoord&&(r.aroundCoord=y.aroundCoord),void 0!==y.pinchAround&&(r.pinchAround=y.pinchAround),y.noInertia&&(r.noInertia=y.noInertia),u.h(l,v),u.h(p,b);this._updateMapTransform(r,l,p),this._changes=[]}_updateMapTransform(r,l,p){const y=this._map,v=y.transform,b=Y=>[Y.x,Y.y,Y.z];if((Y=>{const ee=this._eventsInProgress.drag;return ee&&!this._handlersById[ee.handlerName].isActive()})()&&!$s(r)){const Y=v.zoom;v.cameraElevationReference="sea",null!=this._originalZoom&&v._orthographicProjectionAtLowPitch&&"globe"!==v.projection.name&&0===v.pitch?(v.cameraElevationReference="ground",v.zoom=this._originalZoom):(v.recenterOnTerrain(),v.cameraElevationReference="ground"),Y!==v.zoom&&this._map._update(!0)}if(v._isCameraConstrained&&y._stop(!0),!$s(r))return void this._fireEvents(l,p,!0);let{panDelta:D,zoomDelta:C,bearingDelta:P,pitchDelta:O,around:N,aroundCoord:F,pinchAround:B}=r;v._isCameraConstrained&&(C>0&&(C=0),v._isCameraConstrained=!1),void 0!==B&&(N=B),(C||(Y=>l[Y]&&!this._eventsInProgress[Y])("drag"))&&N&&(this._dragOrigin=b(v.pointCoordinate3D(N)),this._originalZoom=v.zoom,this._trackingEllipsoid.setup(v._camera.position,this._dragOrigin)),v.cameraElevationReference="sea",y._stop(!0),N=N||y.transform.centerPoint,P&&(v.bearing+=P),O&&(v.pitch+=O),v._updateCameraState();const H=[0,0,0];if(D)if("mercator"===v.projection.name){const Y=this._trackingEllipsoid.projectRay(v.screenPointToMercatorRay(N).dir),ee=this._trackingEllipsoid.projectRay(v.screenPointToMercatorRay(N.sub(D)).dir);H[0]=ee[0]-Y[0],H[1]=ee[1]-Y[1]}else{const Y=v.pointCoordinate(N);if("globe"===v.projection.name){D=D.rotate(-v.angle);const ee=v._pixelsPerMercatorPixel/v.worldSize;H[0]=-D.x*u.eL(u.aY(Y.y))*ee,H[1]=-D.y*u.eL(v.center.lat)*ee}else{const ee=v.pointCoordinate(N.sub(D));Y&&ee&&(H[0]=ee.x-Y.x,H[1]=ee.y-Y.y)}}const U=v.zoom,q=[0,0,0];if(C){const Y=b(F||v.pointCoordinate3D(N)),ee={dir:u.au([],u.at([],Y,v._camera.position))};if(ee.dir[2]<0){const ne=v.zoomDeltaToMovement(Y,C);u.c1(q,ee.dir,ne)}}const G=u.d5(H,H,q);v._translateCameraConstrained(G),C&&Math.abs(v.zoom-U)>1e-4&&v.recenterOnTerrain(),v.cameraElevationReference="ground",this._map._update(),r.noInertia||this._inertia.record(r),this._fireEvents(l,p,!0)}_fireEvents(r,l,p){const y=ru(this._eventsInProgress),v=ru(r),b={};for(const O in r){const{originalEvent:N}=r[O];this._eventsInProgress[O]||(b[`${O}start`]=N),this._eventsInProgress[O]=r[O]}!y&&v&&this._fireEvent("movestart",v.originalEvent);for(const O in b)this._fireEvent(O,b[O]);v&&this._fireEvent("move",v.originalEvent);for(const O in r){const{originalEvent:N}=r[O];this._fireEvent(O,N)}const D={};let C;for(const O in this._eventsInProgress){const{handlerName:N,originalEvent:F}=this._eventsInProgress[O];this._handlersById[N].isActive()||(delete this._eventsInProgress[O],C=l[N]||F,D[`${O}end`]=C)}for(const O in D)this._fireEvent(O,D[O]);const P=ru(this._eventsInProgress);if(p&&(y||v)&&!P){this._updatingCamera=!0;const O=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),N=F=>0!==F&&-this._bearingSnap<F&&F<this._bearingSnap;O?(N(O.bearing||this._map.getBearing())&&(O.bearing=0),this._map.easeTo(O,{originalEvent:C})):(this._map.fire(new u.A("moveend",{originalEvent:C})),N(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(r,l){this._map.fire(new u.A(r,l?{originalEvent:l}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(r=>{this._frameId=void 0,this.handleEvent(new sd("renderFrame",{timeStamp:r})),this._applyChanges()})}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const vr="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class lo extends u.E{constructor(r,l){super(),this._moving=!1,this._zooming=!1,this.transform=r,this._bearingSnap=l.bearingSnap,this._respectPrefersReducedMotion=!1!==l.respectPrefersReducedMotion,u.aV(["_renderFrameCallback"],this)}getCenter(){return new u.ci(this.transform.center.lng,this.transform.center.lat)}setCenter(r,l){return this.jumpTo({center:r},l)}panBy(r,l,p){return r=u.P.convert(r).mult(-1),this.panTo(this.transform.center,u.h({offset:r},l),p)}panTo(r,l,p){return this.easeTo(u.h({center:r},l),p)}getZoom(){return this.transform.zoom}setZoom(r,l){return this.jumpTo({zoom:r},l),this}zoomTo(r,l,p){return this.easeTo(u.h({zoom:r},l),p)}zoomIn(r,l){return this.zoomTo(this.getZoom()+1,r,l),this}zoomOut(r,l){return this.zoomTo(this.getZoom()-1,r,l),this}getBearing(){return this.transform.bearing}setBearing(r,l){return this.jumpTo({bearing:r},l),this}getPadding(){return this.transform.padding}setPadding(r,l){return this.jumpTo({padding:r},l),this}rotateTo(r,l,p){return this.easeTo(u.h({bearing:r},l),p)}resetNorth(r,l){return this.rotateTo(0,u.h({duration:1e3},r),l),this}resetNorthPitch(r,l){return this.easeTo(u.h({bearing:0,pitch:0,duration:1e3},r),l),this}snapToNorth(r,l){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(r,l):this}getPitch(){return this.transform.pitch}setPitch(r,l){return this.jumpTo({pitch:r},l),this}cameraForBounds(r,l){r=u.aG.convert(r);const p=l&&l.bearing||0,y=l&&l.pitch||0,v=r.getNorthWest(),b=r.getSouthEast();return this._cameraForBounds(this.transform,v,b,p,y,l)}_extendPadding(r){const l={top:0,right:0,bottom:0,left:0};return null==r?u.h({},l,this.transform.padding):"number"==typeof r?{top:r,bottom:r,right:r,left:r}:u.h({},l,r)}_extendCameraOptions(r){return(r=u.h({offset:[0,0],maxZoom:this.transform.maxZoom},r)).padding=this._extendPadding(r.padding),r}_minimumAABBFrustumDistance(r,l){const p=l.max[0]-l.min[0],y=l.max[1]-l.min[1];return p/y>r.aspect?p/(2*Math.tan(.5*r.fovX)*r.aspect):y/(2*Math.tan(.5*r.fovY)*r.aspect)}_cameraForBoundsOnGlobe(r,l,p,y,v,b){const D=r.clone(),C=this._extendCameraOptions(b);D.bearing=y,D.pitch=v;const P=u.ci.convert(l),O=u.ci.convert(p),N=.5*(P.lat+O.lat),F=.5*(P.lng+O.lng),B=u.eO(N,F),H=u.au([],B),U=u.au([],u.bF([],H,[0,1,0])),q=u.bF([],U,H),G=[U[0],U[1],U[2],0,q[0],q[1],q[2],0,H[0],H[1],H[2],0,0,0,0,1],Y=[B,u.eO(P.lat,P.lng),u.eO(O.lat,P.lng),u.eO(O.lat,O.lng),u.eO(P.lat,O.lng),u.eO(N,P.lng),u.eO(N,O.lng),u.eO(P.lat,F),u.eO(O.lat,F)];let ee=u.d6.fromPoints(Y.map(Re=>[u.bG(U,Re),u.bG(q,Re),u.bG(H,Re)]));const ne=u.ad([],ee.center,G);0===u.eP(ne)&&u.eQ(ne,0,0,1),u.au(ne,ne),u.c1(ne,ne,u.aB),D.center=u.eR(ne);const le=D.getWorldToCameraMatrix(),de=u.bi(new Float64Array(16),le);ee=u.d6.applyTransform(ee,u.az([],le,G));const pe=this._extendAABB(ee,D,C,y);if(!pe)return void u.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ee=pe,u.ad(ne,ne,le);const ae=.5*(ee.max[2]-ee.min[2]),ce=this._minimumAABBFrustumDistance(D,ee),ue=u.c1([],[0,0,1],ae),Me=u.d5(ue,ne,ue),ye=ce+(0===D.pitch?0:u.bD(ne,Me)),je=D.globeCenterInViewSpace,Fe=u.at([],ne,[je[0],je[1],je[2]]);u.au(Fe,Fe),u.c1(Fe,Fe,ye);const Ge=u.d5([],ne,Fe);u.ad(Ge,Ge,de);const rt=u.eB/u.aB,De=u.ae(Ge),_e=u.cb(Math.max(De*rt-u.eB,Number.EPSILON),0),Ne=Math.min(D.zoomFromMercatorZAdjusted(_e),C.maxZoom);return Ne>.5*(u.cX+u.cI)?(D.setProjection({name:"mercator"}),D.zoom=Ne,this._cameraForBounds(D,l,p,y,v,b)):{center:D.center,zoom:Ne,bearing:y,pitch:v}}_extendAABB(r,l,p,y){const v=.5*((p.padding.left||0)+(p.padding.right||0)),b=.5*((p.padding.top||0)+(p.padding.bottom||0)),D=b,C=v,P=v,O=b,N=l.width-(C+P),F=l.height-(D+O),B=u.at([],r.max,r.min),H=Math.min(N/B[0],F/B[1]),U=Math.min(l.scaleZoom(l.scale*H),p.maxZoom);if(isNaN(U))return null;const q=l.scale/l.zoomScale(U),G=new u.d6([r.min[0]-C*q,r.min[1]-O*q,r.min[2]],[r.max[0]+P*q,r.max[1]+D*q,r.max[2]]),Y=("number"==typeof p.offset.x&&"number"==typeof p.offset.y?new u.P(p.offset.x,p.offset.y):u.P.convert(p.offset)).rotate(-u.al(y));return G.center[0]-=Y.x*q,G.center[1]+=Y.y*q,G}queryTerrainElevation(r,l){const p=this.transform.elevation;return p?(l=u.h({},{exaggerated:!0},l),p.getAtPoint(u.ac.fromLngLat(r),null,l.exaggerated)):null}_cameraForBounds(r,l,p,y,v,b){if("globe"===r.projection.name)return this._cameraForBoundsOnGlobe(r,l,p,y,v,b);const D=r.clone(),C=this._extendCameraOptions(b);D.bearing=y,D.pitch=v;const P=u.ci.convert(l),O=u.ci.convert(p),N=new u.ci(P.lng,O.lat),F=new u.ci(O.lng,P.lat),B=D.project(P),H=D.project(O),U=this.queryTerrainElevation(P),q=this.queryTerrainElevation(O),G=this.queryTerrainElevation(N),Y=this.queryTerrainElevation(F),ee=[[B.x,B.y,Math.min(U||0,q||0,G||0,Y||0)],[H.x,H.y,Math.max(U||0,q||0,G||0,Y||0)]];let ne=u.d6.fromPoints(ee);const le=D.getWorldToCameraMatrix(),de=u.bi(new Float64Array(16),le);ne=u.d6.applyTransform(ne,le);const pe=this._extendAABB(ne,D,C,y);if(!pe)return void u.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ne=pe;const ae=.5*u.at([],ne.max,ne.min)[2],ce=this._minimumAABBFrustumDistance(D,ne),ue=[0,0,1,0];u.aA(ue,ue,le),u.eS(ue,ue);const Me=u.c1([],ue,ce+ae),ye=u.d5([],ne.center,Me);u.ad(ne.center,ne.center,de),u.ad(ye,ye,de);const je=D.unproject(new u.P(ne.center[0],ne.center[1])),Fe=u.eT(D.projection,je),Ge=Math.pow(2,Fe),rt=Math.min(D._zoomFromMercatorZ(ye[2]*D.pixelsPerMeter*Ge/D.worldSize),C.maxZoom);return D.mercatorFromTransition&&rt<.5*(u.cX+u.cI)?(D.setProjection({name:"globe"}),D.zoom=rt,this._cameraForBounds(D,l,p,y,v,b)):{center:je,zoom:rt,bearing:y,pitch:v}}fitBounds(r,l,p){const y=this.cameraForBounds(r,l);return this._fitInternal(y,l,p)}fitScreenCoordinates(r,l,p,y,v){const b=u.P.convert(r),D=u.P.convert(l),C=new u.P(Math.min(b.x,D.x),Math.min(b.y,D.y)),P=new u.P(Math.max(b.x,D.x),Math.max(b.y,D.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(b,D))return this;const O=this.transform.pointLocation3D(C),N=this.transform.pointLocation3D(P),F=this.transform.pointLocation3D(new u.P(C.x,P.y)),B=this.transform.pointLocation3D(new u.P(P.x,C.y)),H=[Math.min(O.lng,N.lng,F.lng,B.lng),Math.min(O.lat,N.lat,F.lat,B.lat)],U=[Math.max(O.lng,N.lng,F.lng,B.lng),Math.max(O.lat,N.lat,F.lat,B.lat)],q=y&&y.pitch?y.pitch:this.getPitch(),G=this._cameraForBounds(this.transform,H,U,p,q,y);return this._fitInternal(G,y,v)}_fitInternal(r,l,p){return r?(l=u.h(r,l)).linear?this.easeTo(l,p):this.flyTo(l,p):this}jumpTo(r,l){this.stop();const p=r.preloadOnly?this.transform.clone():this.transform;let y=!1,v=!1,b=!1;"zoom"in r&&p.zoom!==+r.zoom&&(y=!0,p.zoom=+r.zoom),void 0!==r.center&&(p.center=u.ci.convert(r.center)),"bearing"in r&&p.bearing!==+r.bearing&&(v=!0,p.bearing=+r.bearing),"pitch"in r&&p.pitch!==+r.pitch&&(b=!0,p.pitch=+r.pitch);const D="number"==typeof r.padding?this._extendPadding(r.padding):r.padding;if(null!=r.padding&&!p.isPaddingEqual(D))if(!1===r.retainPadding){const C=p.clone();C.padding=D,p.setLocationAtPoint(p.center,C.centerPoint)}else p.padding=D;return r.preloadOnly?(this._preloadTiles(p),this):(this.fire(new u.A("movestart",l)).fire(new u.A("move",l)),y&&this.fire(new u.A("zoomstart",l)).fire(new u.A("zoom",l)).fire(new u.A("zoomend",l)),v&&this.fire(new u.A("rotatestart",l)).fire(new u.A("rotate",l)).fire(new u.A("rotateend",l)),b&&this.fire(new u.A("pitchstart",l)).fire(new u.A("pitch",l)).fire(new u.A("pitchend",l)),this.fire(new u.A("moveend",l)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||u.w(vr),this.transform.getFreeCameraOptions()}setFreeCameraOptions(r,l){const p=this.transform;if(!p.projection.supportsFreeCamera)return u.w(vr),this;this.stop();const y=p.zoom,v=p.pitch,b=p.bearing;p.setFreeCameraOptions(r);const D=y!==p.zoom,C=v!==p.pitch,P=b!==p.bearing;return this.fire(new u.A("movestart",l)).fire(new u.A("move",l)),D&&this.fire(new u.A("zoomstart",l)).fire(new u.A("zoom",l)).fire(new u.A("zoomend",l)),P&&this.fire(new u.A("rotatestart",l)).fire(new u.A("rotate",l)).fire(new u.A("rotateend",l)),C&&this.fire(new u.A("pitchstart",l)).fire(new u.A("pitch",l)).fire(new u.A("pitchend",l)),this.fire(new u.A("moveend",l)),this}easeTo(r,l){this._stop(!1,r.easeId),(!1===(r=u.h({offset:[0,0],duration:500,easing:u.eK},r)).animate||this._prefersReducedMotion(r))&&(r.duration=0);const p=this.transform,y=this.getZoom(),v=this.getBearing(),b=this.getPitch(),D=this.getPadding(),C="zoom"in r?+r.zoom:y,P="bearing"in r?this._normalizeBearing(r.bearing,v):v,O="pitch"in r?+r.pitch:b,N=this._extendPadding(r.padding),F=u.P.convert(r.offset);let B,H,U;if("globe"===p.projection.name){const ue=u.ac.fromLngLat(p.center),Me=F.rotate(-p.angle);ue.x+=Me.x/p.worldSize,ue.y+=Me.y/p.worldSize;const ye=ue.toLngLat(),je=u.ci.convert(r.center||ye);this._normalizeCenter(je),B=p.centerPoint.add(Me),H=new u.P(ue.x,ue.y).mult(p.worldSize),U=new u.P(u.aD(je.lng),u.aH(je.lat)).mult(p.worldSize).sub(H)}else{B=p.centerPoint.add(F);const ue=p.pointLocation(B),Me=u.ci.convert(r.center||ue);this._normalizeCenter(Me),H=p.project(ue),U=p.project(Me).sub(H)}const q=p.zoomScale(C-y);let G,Y;r.around&&(G=u.ci.convert(r.around),Y=p.locationPoint(G));const ee=this._zooming||C!==y,ne=this._rotating||v!==P,le=this._pitching||O!==b,de=!p.isPaddingEqual(N),pe=!1===r.retainPadding?p.clone():p,ae=ue=>Me=>{if(ee&&(ue.zoom=u.ai(y,C,Me)),ne&&(ue.bearing=u.ai(v,P,Me)),le&&(ue.pitch=u.ai(b,O,Me)),de&&(pe.interpolatePadding(D,N,Me),B=pe.centerPoint.add(F)),G)ue.setLocationAtPoint(G,Y);else{const ye=ue.zoomScale(ue.zoom-y),je=C>y?Math.min(2,q):Math.max(.5,q),Fe=Math.pow(je,1-Me),Ge=ue.unproject(H.add(U.mult(Me*Fe)).mult(ye));ue.setLocationAtPoint(ue.renderWorldCopies?Ge.wrap():Ge,B)}return r.preloadOnly||this._fireMoveEvents(l),ue};if(r.preloadOnly){const ue=this._emulate(ae,r.duration,p);return this._preloadTiles(ue),this}const ce={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=ee,this._rotating=ne,this._pitching=le,this._padding=de,this._easeId=r.easeId,this._prepareEase(l,r.noMoveStart,ce),this._ease(ae(p),ue=>{"sea"===p.cameraElevationReference&&p.recenterOnTerrain(),this._afterEase(l,ue)},r),this}_prepareEase(r,l,p={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),l||p.moving||this.fire(new u.A("movestart",r)),this._zooming&&!p.zooming&&this.fire(new u.A("zoomstart",r)),this._rotating&&!p.rotating&&this.fire(new u.A("rotatestart",r)),this._pitching&&!p.pitching&&this.fire(new u.A("pitchstart",r))}_fireMoveEvents(r){this.fire(new u.A("move",r)),this._zooming&&this.fire(new u.A("zoom",r)),this._rotating&&this.fire(new u.A("rotate",r)),this._pitching&&this.fire(new u.A("pitch",r))}_afterEase(r,l){if(this._easeId&&l&&this._easeId===l)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const p=this._zooming,y=this._rotating,v=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,p&&this.fire(new u.A("zoomend",r)),y&&this.fire(new u.A("rotateend",r)),v&&this.fire(new u.A("pitchend",r)),this.fire(new u.A("moveend",r))}flyTo(r,l){if(this._prefersReducedMotion(r)){const Re=u.aF(r,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Re,l)}this.stop(),r=u.h({offset:[0,0],speed:1.2,curve:1.42,easing:u.eK},r);const p=this.transform,y=this.getZoom(),v=this.getBearing(),b=this.getPitch(),D=this.getPadding(),C="zoom"in r?u.ay(+r.zoom,p.minZoom,p.maxZoom):y,P="bearing"in r?this._normalizeBearing(r.bearing,v):v,O="pitch"in r?+r.pitch:b,N=this._extendPadding(r.padding),F=p.zoomScale(C-y),B=u.P.convert(r.offset);let H=p.centerPoint.add(B);const U=p.pointLocation(H),q=u.ci.convert(r.center||U);this._normalizeCenter(q);const G=p.project(U),Y=p.project(q).sub(G);let ee=r.curve;const ne=Math.max(p.width,p.height),le=ne/F,de=Y.mag();if("minZoom"in r){const Re=u.ay(Math.min(r.minZoom,y,C),p.minZoom,p.maxZoom),We=ne/p.zoomScale(Re-y);ee=Math.sqrt(We/de*2)}const pe=ee*ee;function ae(Re){const We=(le*le-ne*ne+(Re?-1:1)*pe*pe*de*de)/(2*(Re?le:ne)*pe*de);return Math.log(Math.sqrt(We*We+1)-We)}function ce(Re){return(Math.exp(Re)-Math.exp(-Re))/2}function ue(Re){return(Math.exp(Re)+Math.exp(-Re))/2}const Me=ae(0);let ye=function(Re){return ue(Me)/ue(Me+ee*Re)},je=function(Re){return ne*((ue(Me)*(ce(We=Me+ee*Re)/ue(We))-ce(Me))/pe)/de;var We},Fe=(ae(1)-Me)/ee;if(Math.abs(de)<1e-6||!isFinite(Fe)){if(Math.abs(ne-le)<1e-6)return this.easeTo(r,l);const Re=le<ne?-1:1;Fe=Math.abs(Math.log(le/ne))/ee,je=function(){return 0},ye=function(We){return Math.exp(Re*ee*We)}}r.duration="duration"in r?+r.duration:1e3*Fe/("screenSpeed"in r?+r.screenSpeed/ee:+r.speed),r.maxDuration&&r.duration>r.maxDuration&&(r.duration=0);const Ge=v!==P,rt=O!==b,De=!p.isPaddingEqual(N),_e=!1===r.retainPadding?p.clone():p,Ne=Re=>We=>{const Ze=We*Fe,Ye=1/ye(Ze);Re.zoom=1===We?C:y+Re.scaleZoom(Ye),Ge&&(Re.bearing=u.ai(v,P,We)),rt&&(Re.pitch=u.ai(b,O,We)),De&&(_e.interpolatePadding(D,N,We),H=_e.centerPoint.add(B));const ct=1===We?q:Re.unproject(G.add(Y.mult(je(Ze))).mult(Ye));return Re.setLocationAtPoint(Re.renderWorldCopies?ct.wrap():ct,H),Re._updateCameraOnTerrain(),r.preloadOnly||this._fireMoveEvents(l),Re};if(r.preloadOnly){const Re=this._emulate(Ne,r.duration,p);return this._preloadTiles(Re),this}return this._zooming=!0,this._rotating=Ge,this._pitching=rt,this._padding=De,this._prepareEase(l,!1),this._ease(Ne(p),()=>this._afterEase(l),r),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(r){}_cancelRenderFrame(r){}_stop(r,l){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const p=this._onEaseEnd;this._onEaseEnd=void 0,p.call(this,l)}if(!r){const p=this.handlers;p&&p.stop(!1)}return this}_ease(r,l,p){!1===p.animate||0===p.duration?(r(1),l()):(this._easeStart=u.q.now(),this._easeOptions=p,this._onEaseFrame=r,this._onEaseEnd=l,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const r=Math.min((u.q.now()-this._easeStart)/this._easeOptions.duration,1),l=this._onEaseFrame;l&&l(this._easeOptions.easing(r)),r<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(r,l){r=u.bQ(r,-180,180);const p=Math.abs(r-l);return Math.abs(r-360-l)<p&&(r-=360),Math.abs(r+360-l)<p&&(r+=360),r}_normalizeCenter(r){const l=this.transform;if(l.maxBounds||"globe"!==l.projection.name&&!l.renderWorldCopies)return;const p=r.lng-l.center.lng;r.lng+=p>180?-360:p<-180?360:0}_prefersReducedMotion(r){return this._respectPrefersReducedMotion&&u.q.prefersReducedMotion&&!(r&&r.essential)}_emulate(r,l,p){const y=Math.ceil(15*l/1e3),v=[],b=r(p.clone());for(let D=0;D<=y;D++){const C=b(D/y);v.push(C.clone())}return v}_preloadTiles(r,l){}}class ad{constructor(r={}){this.options=r,u.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(r){const l=this.options&&this.options.compact,p=r._getUIString("AttributionControl.ToggleAttribution");this._map=r,this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=fn("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",p);const y=fn("span","mapboxgl-ctrl-icon",this._compactButton);return y.setAttribute("aria-hidden","true"),y.setAttribute("title",p),this._innerContainer=fn("div","mapboxgl-ctrl-attrib-inner",this._container),l&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===l&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let r=this._editLink;r||(r=this._editLink=this._container.querySelector(".mapbox-improve-map"));const l=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||u.e.ACCESS_TOKEN}];if(r){const p=l.reduce((y,v,b)=>(v.value&&(y+=`${v.key}=${v.value}${b<l.length-1?"&":""}`),y),"?");r.href=`${u.e.FEEDBACK_URL}/${p}#${id(this._map,!0)}`,r.rel="noopener nofollow"}}_updateData(r){!r||"metadata"!==r.sourceDataType&&"visibility"!==r.sourceDataType&&"style"!==r.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let r=[];if(this._map.style.stylesheet){const y=this._map.style.stylesheet;this.styleOwner=y.owner,this.styleId=y.id}const l=this._map.style._mergedSourceCaches;for(const y in l){const v=l[y];if(v.used){const b=v.getSource();b.attribution&&r.indexOf(b.attribution)<0&&r.push(b.attribution)}}r.sort((y,v)=>y.length-v.length),r=r.filter((y,v)=>{for(let b=v+1;b<r.length;b++)if(r[b].indexOf(y)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?r=[...this.options.customAttribution,...r]:r.unshift(this.options.customAttribution));const p=r.join(" | ");p!==this._attribHTML&&(this._attribHTML=p,r.length?(this._innerContainer.innerHTML=p,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class uc{constructor(){u.aV(["_updateLogo","_updateCompact"],this)}onAdd(r){this._map=r,this._container=fn("div","mapboxgl-ctrl");const l=fn("a","mapboxgl-ctrl-logo");return l.target="_blank",l.rel="noopener nofollow",l.href="https://www.mapbox.com/",l.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),l.setAttribute("rel","noopener nofollow"),this._container.appendChild(l),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(r){r&&"metadata"!==r.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const r=this._map.style._sourceCaches;if(0===Object.entries(r).length)return!0;for(const l in r){const p=r[l].getSource();if(p.hasOwnProperty("mapbox_logo")&&!p.mapbox_logo)return!1}return!0}_updateCompact(){const r=this._container.children;if(r.length){const l=r[0];this._map.getCanvasContainer().offsetWidth<250?l.classList.add("mapboxgl-compact"):l.classList.remove("mapboxgl-compact")}}}class Eh{constructor(){u.aV(["_onIndoorUpdate"],this)}onAdd(r){return this._map=r,this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("indoorupdate",l=>this._onIndoorUpdate({selectedFloorId:l.selectedFloorId,floors:l.floors})),this._container}_createButton(r,l){const p=fn("button",r,this._container);return p.type="button",p.addEventListener("click",l),p}_setButtonTitle(r,l){this._map&&(r.setAttribute("aria-label",l),r.innerHTML=`<strong>${l}</strong>`,r.firstElementChild&&r.firstElementChild.setAttribute("title",l))}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("indoorupdate",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(r){if(!r||!r.floors)return void(this._container.style.display="none");const l=this._model;this._model=r,this._container.style.display="inline-block";const p=r.floors.sort((y,v)=>y.levelOrder-v.levelOrder);l?(Array.from(this._container.children).forEach(y=>y.remove()),this.addCurrentFloors(p)):this.addCurrentFloors(p)}addCurrentFloors(r){for(const l of r){const p=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(l.id),Array.from(this._container.children).forEach(y=>{y.classList.remove("mapboxgl-ctrl-level-button-selected")}),p.classList.add("mapboxgl-ctrl-level-button-selected")});this._setButtonTitle(p,l.shortName),this._model&&l.id===this._model.selectedFloorId&&(this._map._selectIndoorFloor(l.id),p.classList.add("mapboxgl-ctrl-level-button-selected")),this._container.append(p)}}}class Mm{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(r){const l=++this._id;return this._queue.push({callback:r,id:l,cancelled:!1}),l}remove(r){const l=this._currentlyRunning,p=l?this._queue.concat(l):this._queue;for(const y of p)if(y.id===r)return void(y.cancelled=!0)}run(r=0){const l=this._currentlyRunning=this._queue;this._queue=[];for(const p of l)if(!p.cancelled&&(p.callback(r),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class dc{constructor(r){this.jumpTo(r)}getValue(r){if(r<=this._startTime)return this._start;if(r>=this._endTime)return this._end;const l=u.dx((r-this._startTime)/(this._endTime-this._startTime));return this._start*(1-l)+this._end*l}isEasing(r){return r>=this._startTime&&r<=this._endTime}jumpTo(r){this._startTime=-1/0,this._endTime=-1/0,this._start=r,this._end=r}easeTo(r,l,p){this._start=this.getValue(l),this._end=r,this._startTime=l,this._endTime=l+p}}const Pm={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class b_ extends u.A{constructor(r,l,p,y){const{point:v,lngLat:b,originalEvent:D,target:C}=r;super(r.type,{point:v,lngLat:b,originalEvent:D,target:C}),this.preventDefault=()=>{r.preventDefault()},this.id=l,this.interaction=p,this.feature=y}}class Zf{constructor(r){this.map=r,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(r,l){if(this.typeById.has(r))throw new Error(`Interaction id "${r}" already exists.`);const p=l.filter;let y=l.type;p&&this.filters.set(r,u.b3(p)),"mouseover"===y&&(y="mouseenter"),"mouseout"===y&&(y="mouseleave");const v=this.interactionsByType.get(y)||new Map;"mouseenter"===y||"mouseleave"===y?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(r,l)):0===v.size&&this.map.on(y,this.handleType),0===v.size&&this.interactionsByType.set(y,v),v.set(r,l),this.typeById.set(r,y)}get(r){const l=this.typeById.get(r);if(!l)return;const p=this.interactionsByType.get(l);return p?p.get(r):void 0}remove(r){const l=this.typeById.get(r);if(!l)return;this.typeById.delete(r),this.filters.delete(r);const p=this.interactionsByType.get(l);p&&(p.delete(r),"mouseenter"===l||"mouseleave"===l?(this.delegatedInteractions.delete(r),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===p.size&&this.map.off(l,this.handleType))}queryTargets(r,l){const p=[];for(const[y,v]of l)v.target&&p.push({targetId:y,target:v.target,filter:this.filters.get(y)});return this.map.style.queryRenderedTargets(r,p,this.map.transform)}handleMove(r){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const l=this.queryTargets(r.point,Array.from(this.delegatedInteractions).reverse());l.length&&(r.type="mouseenter",this.handleType(r,l));const p=new Map;for(const[y,{feature:v}]of this.prevHoveredFeatures)this.hoveredFeatures.has(y)||p.set(v.id,v);p.size&&(r.type="mouseleave",this.handleType(r,Array.from(p.values())))}handleOut(r){const l=Array.from(this.hoveredFeatures.values()).map(({feature:p})=>p);l.length&&(r.type="mouseleave",this.handleType(r,l)),this.hoveredFeatures.clear()}handleType(r,l){const p="mouseenter"===r.type;if(p&&!this.interactionsByType.has(r.type))return void u.w("mouseenter interaction required for mouseleave to work.");const y=Array.from(this.interactionsByType.get(r.type)).reverse(),v=!!l;l=l||this.queryTargets(r.point,y);let b=!1;const D=new Set;for(const C of l){for(const[P,O]of y){if(!O.target)continue;const N=C.variants?C.variants[P]:null;if(N){for(const F of N){if(gf(F,C,D,P))continue;const B=new u.dr(C,F),H=Ud(F,C,P);v&&(B.state=this.map.getFeatureState(B));const U=p?this.prevHoveredFeatures.get(H):null,q=new b_(r,P,O,B),G=U?U.stop:O.handler(q);if(p&&this.hoveredFeatures.set(H,{feature:C,stop:G}),!1!==G){b=!0;break}}if(b)break}}if(b)break}if(!b)for(const[C,P]of y){const{handler:O,target:N}=P;if(!N&&!1!==O(new b_(r,C,P,null)))break}}}function Xf(f,r){if(Array.isArray(f)&&Array.isArray(r)){const l=new Set(f),p=new Set(r);return l.size===p.size&&f.every(y=>p.has(y))}return u.bv(f,r)}const ld={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},ou={showCompass:!0,showZoom:!0,visualizePitch:!1};class _l{constructor(r,l,p=!1){this._clickTolerance=10,this.element=l,this.mouseRotate=new xa({clickTolerance:r.dragRotate._mouseRotate._clickTolerance}),this.map=r,p&&(this.mousePitch=new Sm({clickTolerance:r.dragRotate._mousePitch._clickTolerance})),u.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),l.addEventListener("mousedown",this.mousedown),l.addEventListener("touchstart",this.touchstart,{passive:!1}),l.addEventListener("touchmove",this.touchmove),l.addEventListener("touchend",this.touchend),l.addEventListener("touchcancel",this.reset)}down(r,l){this.mouseRotate.mousedown(r,l),this.mousePitch&&this.mousePitch.mousedown(r,l),ys()}move(r,l){const p=this.map,y=this.mouseRotate.mousemoveWindow(r,l),v=y&&y.bearingDelta;if(v&&p.setBearing(p.getBearing()+v),this.mousePitch){const b=this.mousePitch.mousemoveWindow(r,l),D=b&&b.pitchDelta;D&&p.setPitch(p.getPitch()+D)}}off(){const r=this.element;r.removeEventListener("mousedown",this.mousedown),r.removeEventListener("touchstart",this.touchstart),r.removeEventListener("touchmove",this.touchmove),r.removeEventListener("touchend",this.touchend),r.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Ws(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(r){this.down(u.h({},r,{ctrlKey:!0,preventDefault:()=>r.preventDefault()}),da(this.element,r)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(r){this.move(r,da(this.element,r))}mouseup(r){this.mouseRotate.mouseupWindow(r),this.mousePitch&&this.mousePitch.mouseupWindow(r),this.offTemp()}touchstart(r){1!==r.targetTouches.length?this.reset():(this._startPos=this._lastPos=Ia(this.element,r.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>r.preventDefault()},this._startPos))}touchmove(r){1!==r.targetTouches.length?this.reset():(this._lastPos=Ia(this.element,r.targetTouches)[0],this.move({preventDefault:()=>r.preventDefault()},this._lastPos))}touchend(r){0===r.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function hs(f,r,l){if(f=new u.ci(f.lng,f.lat),r){const p=new u.ci(f.lng-360,f.lat),y=new u.ci(f.lng+360,f.lat),v=360*Math.ceil(Math.abs(f.lng-l.center.lng)/360),b=l.locationPoint3D(f).distSqr(r),D=r.x<0||r.y<0||r.x>l.width||r.y>l.height;l.locationPoint3D(p).distSqr(r)<b&&(D||Math.abs(p.lng-l.center.lng)<v)?f=p:l.locationPoint3D(y).distSqr(r)<b&&(D||Math.abs(y.lng-l.center.lng)<v)&&(f=y)}for(;Math.abs(f.lng-l.center.lng)>180;){const p=l.locationPoint3D(f);if(p.x>=0&&p.y>=0&&p.x<=l.width&&p.y<=l.height)break;f.lng>l.center.lng?f.lng-=360:f.lng+=360}return f}const co={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},qo={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Cs extends u.E{constructor(r,l){super(),(r instanceof HTMLElement||l)&&(r=u.h({element:r},l)),u.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:p="center",color:y="#3FB1CE",scale:v=1,draggable:b=!1,clickTolerance:D=0,rotation:C=qo.rotation,rotationAlignment:P=qo.rotationAlignment,pitchAlignment:O=qo.pitchAlignment,occludedOpacity:N=qo.occludedOpacity,altitude:F=qo.altitude}=r||{};this._anchor=p,this._color=y,this._scale=v,this._draggable=b,this._clickTolerance=D,this._rotation=C,this._rotationAlignment=P,this._pitchAlignment=O,this._occludedOpacity=N,this._altitude=F,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),r&&r.element?(this._element=r.element,this._offset=u.P.convert(r&&r.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=u.P.convert(r&&r.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",U=>{U.preventDefault()}),this._element.addEventListener("mousedown",U=>{U.preventDefault()});const B=this._element.classList;for(const U in co)B.remove(`mapboxgl-marker-anchor-${U}`);B.add(`mapboxgl-marker-anchor-${this._anchor}`);const H=r&&r.className?r.className.trim().split(/\s+/):[];B.add(...H),this._popup=null}_createDefaultMarker(){const r=fn("div"),l=es("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},r);if(0===this._altitude){const p=es("radialGradient",{id:"shadowGradient"},es("defs",{},l));es("stop",{offset:"10%","stop-opacity":.4},p),es("stop",{offset:"100%","stop-opacity":.05},p),es("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},l)}return es("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},l),es("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},l),es("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},l),r}addTo(r){return r===this._map||(this.remove(),this._map=r,r.getCanvasContainer().appendChild(this._element),r.on("move",this._updateMoving),r.on("moveend",this._update),r.on("remove",this._clearFadeTimer),r._addMarker(this),this.setDraggable(this._draggable),this._update(),r.on("click",this._onMapClick)),this}remove(){const r=this._map;return r&&(r.off("click",this._onMapClick),r.off("move",this._updateMoving),r.off("moveend",this._update),r.off("mousedown",this._addDragHandler),r.off("touchstart",this._addDragHandler),r.off("mouseup",this._onUp),r.off("touchend",this._onUp),r.off("mousemove",this._onMove),r.off("touchmove",this._onMove),r.off("remove",this._clearFadeTimer),r._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(r){return this._lngLat=u.ci.convert(r),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(r){return r===this._altitude||(this._defaultMarker&&(0===this._altitude&&0!==r||0!==this._altitude&&0===r)&&(this._element=this._createDefaultMarker()),this._altitude=r||qo.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(r){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),r){if(!("offset"in r.options)){const y=Math.sqrt(Math.pow(13.5,2)/2);r.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[y,-1*(24.6+y)],"bottom-right":[-y,-1*(24.6+y)],left:[13.5,-24.6],right:[-13.5,-24.6]}:this._offset}this._popup=r,r._marker=this,r._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(r){const l=r.code,p=r.charCode||r.keyCode;"Space"!==l&&"Enter"!==l&&32!==p&&13!==p||this.togglePopup()}_onMapClick(r){const l=r.originalEvent.target,p=this._element;this._popup&&(l===p||p.contains(l))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const r=this._popup;return r?(r.isOpen()?(r.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(r.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const r=this._map,l=this._pos;if(!r||!l)return!1;const p=r.unproject(l,this._altitude),y=r.getFreeCameraOptions();if(!y.position)return!1;const v=y.position.toLngLat();return v.distanceTo(p)<.9*v.distanceTo(this._lngLat)}_evaluateOpacity(){const r=this._map;if(!r)return;const l=this._pos;if(!l||l.x<0||l.x>r.transform.width||l.y<0||l.y>r.transform.height)return void this._clearFadeTimer();const p=r.unproject(l,this._altitude);let y;r._showingGlobe()&&u.eW(r.transform,this._lngLat)?y=0:(y=1-r._queryFogOpacity(p),r.transform._terrainEnabled()&&r.getTerrain()&&this._behindTerrain()&&(y*=this._occludedOpacity)),this._element.style.opacity=`${y}`,this._element.style.pointerEvents=y>0?"auto":"none",this._popup&&this._popup._setOpacity(y),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const r=this._pos;if(!r||!this._map)return;const l=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${r.x}px,${r.y}px)\n            ${co[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${l.x}px,${l.y}px)\n        `}_calculateXYTransform(){const r=this._pos,l=this._map,p=this.getPitchAlignment();if(!l||!r||"map"!==p)return"";if(!l._showingGlobe()){const C=l.getPitch();return C?`rotateX(${C}deg)`:""}const y=u.cU(u.eX(l.transform,this._lngLat)),v=r.sub(u.eY(l.transform)),b=Math.abs(v.x)+Math.abs(v.y);if(0===b)return"";const D=y/b;return`rotateX(${-v.y*D}deg) rotateY(${v.x*D}deg)`}_calculateZTransform(){const r=this._pos,l=this._map;if(!l||!r)return"";let p=0;const y=this.getRotationAlignment();if("map"===y)if(l._showingGlobe()){const v=l.project(new u.ci(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),b=l.project(new u.ci(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(v);p=u.cU(Math.atan2(b.y,b.x))-90}else p=-l.getBearing();else if("horizon"===y){const v=u.af(4,6,l.getZoom()),b=u.eY(l.transform);b.y+=v*l.transform.height;const D=r.sub(b),C=u.cU(Math.atan2(D.y,D.x));p=(C>90?C-270:C+90)*(1-v)}return p+=this._rotation,p?`rotateZ(${p}deg)`:""}_update(r){cancelAnimationFrame(this._updateFrameId);const l=this._map;l&&(l.transform.renderWorldCopies&&(this._lngLat=hs(this._lngLat,this._pos,l.transform)),this._pos=l.project(this._lngLat,this._altitude),!0===r?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),l._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(l._showingGlobe()||l.getTerrain()||l.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(r){return this._offset=u.P.convert(r),this._update(),this}addClassName(r){return this._element.classList.add(r),this}removeClassName(r){return this._element.classList.remove(r),this}toggleClassName(r){return this._element.classList.toggle(r)}_onMove(r){const l=this._map;if(!l)return;const p=this._pointerdownPos,y=this._positionDelta;if(p&&y){if(!this._isDragging){const v=this._clickTolerance||l._clickTolerance;if(r.point.dist(p)<v)return;this._isDragging=!0}this._pos=r.point.sub(y),this._lngLat=l.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new u.A("dragstart"))),this.fire(new u.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const r=this._map;r&&(r.off("mousemove",this._onMove),r.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new u.A("dragend")),this._state="inactive"}_addDragHandler(r){const l=this._map,p=this._pos;l&&p&&this._element.contains(r.originalEvent.target)&&(r.preventDefault(),this._positionDelta=r.point.sub(p),this._pointerdownPos=r.point,this._state="pending",l.on("mousemove",this._onMove),l.on("touchmove",this._onMove),l.once("mouseup",this._onUp),l.once("touchend",this._onUp))}setDraggable(r){this._draggable=!!r;const l=this._map;return l&&(r?(l.on("mousedown",this._addDragHandler),l.on("touchstart",this._addDragHandler)):(l.off("mousedown",this._addDragHandler),l.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(r){return this._rotation=r||qo.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(r){return this._rotationAlignment=r||qo.rotationAlignment,this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(r){return this._pitchAlignment=r||qo.pitchAlignment,this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(r){return this._occludedOpacity=r||qo.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const w_={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Th={maxWidth:100,unit:"metric"},Lv={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},fs={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},E_=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Zi(f=new u.P(0,0),r="bottom"){if("number"==typeof f){const l=Math.round(Math.sqrt(.5*Math.pow(f,2)));switch(r){case"top":return new u.P(0,f);case"top-left":return new u.P(l,l);case"top-right":return new u.P(-l,l);case"bottom":return new u.P(0,-f);case"bottom-left":return new u.P(l,-l);case"bottom-right":return new u.P(-l,-l);case"left":return new u.P(f,0);case"right":return new u.P(-f,0)}return new u.P(0,0)}return f instanceof u.P||Array.isArray(f)?u.P.convert(f):u.P.convert(f[r]||[0,0])}return{version:tr,supported:Nl.supported,setRTLTextPlugin:u.f0,getRTLTextPluginStatus:u.e$,Map:class extends lo{constructor(f){Ca.mark(ji.create);const r=f;if(null!=(f=u.h({},ld,f)).minZoom&&null!=f.maxZoom&&f.minZoom>f.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=f.minPitch&&null!=f.maxPitch&&f.minPitch>f.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=f.minPitch&&f.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=f.maxPitch&&f.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(f.antialias&&u.eU(window)&&(f.antialias=!1,u.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Yp(f.minZoom,f.maxZoom,f.minPitch,f.maxPitch,f.renderWorldCopies,null,null),f),this._repaint=!!f.repaint,this._interactive=f.interactive,this._minTileCacheSize=f.minTileCacheSize,this._maxTileCacheSize=f.maxTileCacheSize,this._failIfMajorPerformanceCaveat=f.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=f.preserveDrawingBuffer,this._antialias=f.antialias,this._trackResize=f.trackResize,this._bearingSnap=f.bearingSnap,this._refreshExpiredTiles=f.refreshExpiredTiles,this._fadeDuration=f.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=f.crossSourceCollisions,this._collectResourceTiming=f.collectResourceTiming,this._language=this._parseLanguage(f.language),this._worldview=f.worldview,this._renderTaskQueue=new Mm,this._domRenderTaskQueue=new Mm,this._controls=[],this._markers=[],this._popups=[],this._mapId=u.a$(),this._locale=u.h({},Pm,f.locale),this._clickTolerance=f.clickTolerance,this._cooperativeGestures=f.cooperativeGestures,this._performanceMetricsCollection=f.performanceMetricsCollection,this._tessellationStep=f.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=f.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new dc(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=f.scaleFactor,this._requestManager=new mr(f.transformRequest,f.accessToken,f.testMode),this._silenceAuthErrors=!!f.testMode,this._contextCreateOptions=f.contextCreateOptions?Object.assign({},f.contextCreateOptions):{},"string"==typeof f.container){const l=document.getElementById(f.container);if(!l)throw new Error(`Container '${f.container.toString()}' not found.`);this._container=l}else{if(!(f.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=f.container}if(this._container.childNodes.length>0&&u.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),f.maxBounds&&this.setMaxBounds(f.maxBounds),this._spriteFormat=f.spriteFormat,u.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new ko),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new wh(this,f),this._localFontFamily=f.localFontFamily,this._localIdeographFontFamily=f.localIdeographFontFamily,(f.style||!f.testMode)&&this.setStyle(f.style||u.e.DEFAULT_STYLE,{config:f.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),f.projection&&this.setProjection(f.projection),this.indoor=new Jg(this),f.hash&&(this._hash=new nd("string"==typeof f.hash&&f.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==r.center&&null==r.zoom||(this.transform._unmodified=!1),this.jumpTo({center:f.center,zoom:f.zoom,bearing:f.bearing,pitch:f.pitch});const l=f.bounds;l&&(this.resize(),this.fitBounds(l,u.h({},f.fitBoundsOptions,{duration:0})))}this.resize(),f.attributionControl&&this.addControl(new ad({customAttribution:f.customAttribution})),this._logoControl=new uc,this.addControl(this._logoControl,f.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",l=>{this._update("style"===l.dataType),this.fire(new u.A(`${l.dataType}data`,l))}),this.on("dataloading",l=>{this.fire(new u.A(`${l.dataType}dataloading`,l))}),this._interactions=new Zf(this)}_getMapId(){return this._mapId}addControl(f,r){if(void 0===r&&(r=f.getDefaultPosition?f.getDefaultPosition():"top-right"),!f||!f.onAdd)return this.fire(new u.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const l=f.onAdd(this);this._controls.push(f);const p=this._controlPositions[r];return-1!==r.indexOf("bottom")?p.insertBefore(l,p.firstChild):p.appendChild(l),this}removeControl(f){if(!f||!f.onRemove)return this.fire(new u.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const r=this._controls.indexOf(f);return r>-1&&this._controls.splice(r,1),f.onRemove(this),this}hasControl(f){return this._controls.indexOf(f)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(f){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const r=!this._moving;return r&&this.fire(new u.A("movestart",f)).fire(new u.A("move",f)),this.fire(new u.A("resize",f)),r&&this.fire(new u.A("moveend",f)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(f){return this.transform.setMaxBounds(u.aG.convert(f)),this._update()}setMinZoom(f){if((f=f??-2)>=-2&&f<=this.transform.maxZoom)return this.transform.minZoom=f,this._update(),this.getZoom()<f?this.setZoom(f):this.fire(new u.A("zoomstart")).fire(new u.A("zoom")).fire(new u.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(f){if((f=f??22)>=this.transform.minZoom)return this.transform.maxZoom=f,this._update(),this.getZoom()>f?this.setZoom(f):this.fire(new u.A("zoomstart")).fire(new u.A("zoom")).fire(new u.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(f){if((f=f??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(f>=0&&f<=this.transform.maxPitch)return this.transform.minPitch=f,this._update(),this.getPitch()<f?this.setPitch(f):this.fire(new u.A("pitchstart")).fire(new u.A("pitch")).fire(new u.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(f){if((f=f??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(f>=this.transform.minPitch)return this.transform.maxPitch=f,this._update(),this.getPitch()>f?this.setPitch(f):this.fire(new u.A("pitchstart")).fire(new u.A("pitch")).fire(new u.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(f){return this._scaleFactor=f,this.painter.scaleFactor=f,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(r=>"symbol"===r.type),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(f){return this.transform.renderWorldCopies=f,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(f){return"auto"===f?navigator.language:Array.isArray(f)?0===f.length?void 0:f.map(r=>"auto"===r?navigator.language:r):f}setLanguage(f){const r=this._parseLanguage(f);if(!this.style||r===this._language)return this;this._language=r,this.style.reloadSources();for(const l of this._controls)l._setLanguage&&l._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(f){return this.style&&f!==this._worldview?(this._worldview=f,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(f){return this._lazyInitEmptyStyle(),f?"string"==typeof f&&(f={name:f}):f=null,this._useExplicitProjection=!!f,this._prioritizeAndUpdateProjection(f,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const f=this.transform,r=f.projection.name;let l;"globe"===r&&f.zoom>=u.cI?(f.setMercatorFromTransition(),l=!0):"mercator"===r&&f.zoom<u.cI&&(f.setProjection({name:"globe"}),l=!0),l&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(f,r){return this._updateProjection(f||r||{name:"mercator"})}_updateProjection(f){let r;return r="globe"===f.name&&this.transform.zoom>=u.cI?this.transform.setMercatorFromTransition():this.transform.setProjection(f),this.style.applyProjectionUpdate(),r&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(f,r){return this.transform.locationPoint3D(u.ci.convert(f),r)}unproject(f,r){return this.transform.pointLocation3D(u.P.convert(f),r)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(f,r,l){const p=y=>{let v=[];if(Array.isArray(r)){const b=r.filter(D=>this.getLayer(D));v=b.length?this.queryRenderedFeatures(y,{layers:b}):[]}else v=this.queryRenderedFeatures(y,{target:r});return v};if("mouseenter"===f||"mouseover"===f){let y=!1;return{listener:l,targets:r,delegates:{mousemove:b=>{const D=p(b.point);D.length?y||(y=!0,l.call(this,new Pi(f,this,b.originalEvent,{features:D}))):y=!1},mouseout:()=>{y=!1}}}}if("mouseleave"===f||"mouseout"===f){let y=!1;return{listener:l,targets:r,delegates:{mousemove:D=>{p(D.point).length?y=!0:y&&(y=!1,l.call(this,new Pi(f,this,D.originalEvent)))},mouseout:D=>{y&&(y=!1,l.call(this,new Pi(f,this,D.originalEvent)))}}}}{const y=v=>{const b=p(v.point);b.length&&(v.features=b,l.call(this,v),delete v.features)};return{listener:l,targets:r,delegates:{[f]:y}}}}on(f,r,l){if("function"==typeof r||void 0===l)return super.on(f,r);if("string"==typeof r&&(r=[r]),!this._areTargetsValid(r))return this;const p=this._createDelegatedListener(f,r,l);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[f]=this._delegatedListeners[f]||[],this._delegatedListeners[f].push(p);for(const y in p.delegates)this.on(y,p.delegates[y]);return this}once(f,r,l){if("function"==typeof r||void 0===l)return super.once(f,r);if("string"==typeof r&&(r=[r]),!this._areTargetsValid(r))return this;const p=this._createDelegatedListener(f,r,l);for(const y in p.delegates)this.once(y,p.delegates[y]);return this}off(f,r,l){if("function"==typeof r||void 0===l)return super.off(f,r);if("string"==typeof r&&(r=[r]),!this._areTargetsValid(r))return this;const p=this._delegatedListeners?this._delegatedListeners[f]:void 0;return p&&(y=>{for(let v=0;v<y.length;v++){const b=y[v];if(b.listener===l&&Xf(b.targets,r)){for(const D in b.delegates)this.off(D,b.delegates[D]);return y.splice(v,1),this}}})(p),this}queryRenderedFeatures(f,r){if(!this.style)return[];if(void 0===f||f instanceof u.P||Array.isArray(f)||void 0!==r||(r=f,f=void 0),f=f||[[0,0],[this.transform.width,this.transform.height]],!r){const v=this.style.queryRenderedFeatures(f,void 0,this.transform),b=this.style.queryRenderedFeatureset(f,void 0,this.transform);return v.concat(b)}let l=!0;if(r.target&&(l=this._isTargetValid(r.target),l&&!r.layers))return this.style.queryRenderedFeatureset(f,r,this.transform);let p=!0;if(r.layers&&Array.isArray(r.layers)){for(const v of r.layers)if(!this._isValidId(v)){p=!1;break}if(p&&!r.target)return this.style.queryRenderedFeatures(f,r,this.transform)}let y=[];return p&&(y=y.concat(this.style.queryRenderedFeatures(f,r,this.transform))),l&&(y=y.concat(this.style.queryRenderedFeatureset(f,r,this.transform))),y}querySourceFeatures(f,r){return!f||"string"==typeof f&&!this._isValidId(f)?[]:this.style.querySourceFeatures(f,r)}isPointOnSurface(f){const{name:r}=this.transform.projection;return"globe"!==r&&"mercator"!==r&&u.w(`${r} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(u.P.convert(f))}addInteraction(f,r){return this._interactions.add(f,r),this}removeInteraction(f){return this._interactions.remove(f),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(f){return this._cooperativeGestures=f,this}setStyle(f,r){return r=u.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},r),this.style&&f&&!1!==r.diff&&r.localFontFamily===this._localFontFamily&&r.localIdeographFontFamily===this._localIdeographFontFamily&&!r.config?(this.style._diffStyle(f,(l,p)=>{if(l){const y="string"==typeof l?l:l instanceof Error?l.message:l.error;u.w(`Unable to perform style diff: ${y}. Rebuilding the style from scratch.`),this._updateStyle(f,r)}else p&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=r.localIdeographFontFamily,this._localFontFamily=r.localFontFamily,this._updateStyle(f,r))}_getUIString(f){const r=this._locale[f];if(null==r)throw new Error(`Missing UI string '${f}'`);return r}_updateStyle(f,r){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),f){const l=u.h({},r);r&&r.config&&(l.initialConfig=r.config,delete l.config),this.style=new js(this,l).load(f),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new js(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(u.w("There is no style added to the map."),!1)}_isValidId(f){return null==f?(this.fire(new u.z(new Error("IDs can't be empty."))),!1):!u.dk(f)||(this.fire(new u.z(new Error(`IDs can't contain special symbols: "${f}".`))),!1)}_isTargetValid(f){return"featuresetId"in f?this._isValidId("importId"in f?f.importId:f.featuresetId):"layerId"in f&&this._isValidId(f.layerId)}_areTargetsValid(f){if(Array.isArray(f)){for(const r of f)if(!this._isValidId(r))return!1;return!0}return this._isTargetValid(f)}addSource(f,r){return this._isValidId(f)?(this._lazyInitEmptyStyle(),this.style.addSource(f,r),this._update(!0)):this}isSourceLoaded(f){return!!this._isValidId(f)&&!!this.style&&this.style._isSourceCacheLoaded(f)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(f,r,l){this._lazyInitEmptyStyle(),this.style.addSourceType(f,r,l)}removeSource(f){return this._isValidId(f)?(this.style.removeSource(f),this._updateTerrain(),this._update(!0)):this}getSource(f){return this._isValidId(f)?this.style.getOwnSource(f):null}addImage(f,r,{pixelRatio:l=1,sdf:p=!1,stretchX:y,stretchY:v,content:b}={}){this._lazyInitEmptyStyle();const D=u.I.from(f);if(r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap){const{width:C,height:P,data:O}=u.q.getImageData(r);this.style.addImage(D,{data:new u.r({width:C,height:P},O),pixelRatio:l,stretchX:y,stretchY:v,content:b,sdf:p,version:0,usvg:!1})}else if(void 0===r.width||void 0===r.height)this.fire(new u.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:C,height:P}=r,O=r;this.style.addImage(D,{data:new u.r({width:C,height:P},new Uint8Array(O.data)),pixelRatio:l,stretchX:y,stretchY:v,content:b,sdf:p,usvg:!1,version:0,userImage:O}),O.onAdd&&O.onAdd(this,f)}}updateImage(f,r){this._lazyInitEmptyStyle();const l=u.I.from(f),p=this.style.getImage(l);if(!p)return void this.fire(new u.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const y=r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap?u.q.getImageData(r):r,{width:v,height:b,data:D}=y;if(void 0===v||void 0===b)return void this.fire(new u.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(v!==(p.usvg?p.icon.usvg_tree.width:p.data.width)||b!==(p.usvg?p.icon.usvg_tree.height:p.data.height))return void this.fire(new u.z(new Error(`The width and height of the updated image (${v}, ${b})\n                must be that same as the previous version of the image\n                (${p.data.width}, ${p.data.height})`)));const C=!(r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap);let P=!1;p.usvg?(p.data=new u.r({width:v,height:b},new Uint8Array(D)),p.usvg=!1,p.icon=void 0,P=!0):p.data.replace(D,C),this.style.updateImage(l,p,P)}hasImage(f){return f?!!this.style&&!!this.style.getImage(u.I.from(f)):(this.fire(new u.z(new Error("Missing required image id"))),!1)}removeImage(f){this.style.removeImage(u.I.from(f))}loadImage(f,r){u.o(this._requestManager.transformRequest(f,u.R.Image),(l,p)=>{r(l,p instanceof HTMLImageElement?u.q.getImageData(p):p)})}listImages(){return this.style.listImages().map(f=>f.name)}addModel(f,r){this._lazyInitEmptyStyle(),this.style.addModel(f,r)}hasModel(f){return f?this.style.hasModel(f):(this.fire(new u.z(new Error("Missing required model id"))),!1)}removeModel(f){this.style.removeModel(f)}listModels(){return this.style.listModels()}addLayer(f,r){return this._isValidId(f.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(f,r),this._update(!0)):this}getSlot(f){const r=this.getLayer(f);return r&&r.slot||null}setSlot(f,r){return this.style.setSlot(f,r),this.style.mergeLayers(),this._update(!0)}addImport(f,r){return this.style.addImport(f,r).catch(l=>this.fire(new u.z(new Error("Failed to add import",l)))),this}updateImport(f,r){return"string"!=typeof r&&r.id!==f?(this.removeImport(f),this.addImport(r)):(this.style.updateImport(f,r),this._update(!0))}removeImport(f){return this.style.removeImport(f),this}moveImport(f,r){return this.style.moveImport(f,r),this._update(!0)}moveLayer(f,r){return this._isValidId(f)?(this.style.moveLayer(f,r),this._update(!0)):this}removeLayer(f){return this._isValidId(f)?(this.style.removeLayer(f),this._update(!0)):this}getLayer(f){if(!this._isValidId(f))return null;const r=this.style.getOwnLayer(f);return r?"custom"===r.type?r.implementation:r.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(f,r,l){return this._isValidId(f)?(this.style.setLayerZoomRange(f,r,l),this._update(!0)):this}setFilter(f,r,l={}){return this._isValidId(f)?(this.style.setFilter(f,r,l),this._update(!0)):this}getFilter(f){return this._isValidId(f)?this.style.getFilter(f):null}setPaintProperty(f,r,l,p={}){return this._isValidId(f)?(this.style.setPaintProperty(f,r,l,p),this._update(!0)):this}getPaintProperty(f,r){return this._isValidId(f)?this.style.getPaintProperty(f,r):null}setLayoutProperty(f,r,l,p={}){return this._isValidId(f)?(this.style.setLayoutProperty(f,r,l,p),this._update(!0)):this}getLayoutProperty(f,r){return this._isValidId(f)?this.style.getLayoutProperty(f,r):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(f){return this.style.setGlyphsUrl(f),this._update(!0)}getSchema(f){return this.style.getSchema(f)}setSchema(f,r){return this.style.setSchema(f,r),this._update(!0)}getConfig(f){return this.style.getConfig(f)}setConfig(f,r){return this.style.setConfig(f,r),this._update(!0)}getConfigProperty(f,r){return this.style.getConfigProperty(f,r)}setConfigProperty(f,r,l){return this.style.setConfigProperty(f,r,l),this._update(!0)}getFeaturesetDescriptors(f){return this.style.getFeaturesetDescriptors(f)}setLights(f){if(this._lazyInitEmptyStyle(),f&&1===f.length&&"flat"===f[0].type){const r=f[0];r.properties?this.style.setFlatLight(r.properties,r.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(f),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const f=this.style.getLights()||[];return 0===f.length&&f.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),f}setLight(f,r={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:f}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(f){return this._lazyInitEmptyStyle(),!f&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(f),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(f){return this._lazyInitEmptyStyle(),this.style.setFog(f),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(f){return this._lazyInitEmptyStyle(),this.style.setSnow(f),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(f){return this._lazyInitEmptyStyle(),this.style.setRain(f),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(f){return this._lazyInitEmptyStyle(),this.style.setColorTheme(f),this._update(!0)}setImportColorTheme(f,r){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(f,r),this._update(!0)}setCamera(f){return this.style.setCamera(f),this._triggerCameraUpdate(f)}_triggerCameraUpdate(f){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===f["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(f){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(u.ci.convert(f),this.transform):0}setFeatureState(f,r){return f.source&&!this._isValidId(f.source)?this:(this.style.setFeatureState(f,r),this._update())}removeFeatureState(f,r){return f.source&&!this._isValidId(f.source)?this:(this.style.removeFeatureState(f,r),this._update())}getFeatureState(f){return f.source&&!this._isValidId(f.source)?null:this.style.getFeatureState(f)}_selectIndoorFloor(f){this.indoor.selectFloor(f)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new Eh),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const f=this._container.getBoundingClientRect().width||400,r=this._container.getBoundingClientRect().height||300;let l,p,y,v=this._container;for(;v&&(!p||!y);){const b=window.getComputedStyle(v).transform;b&&"none"!==b&&(l=b.match(/matrix.*\((.+)\)/)[1].split(", "),l[0]&&"0"!==l[0]&&"1"!==l[0]&&(p=l[0]),l[3]&&"0"!==l[3]&&"1"!==l[3]&&(y=l[3])),v=v.parentElement}this._containerWidth=p?Math.abs(f/p):f,this._containerHeight=y?Math.abs(r/y):r}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&u.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const f=this._container;f.classList.add("mapboxgl-map"),(this._missingCSSCanary=fn("div","mapboxgl-canary",f)).style.visibility="hidden",this._detectMissingCSS();const r=this._canvasContainer=fn("div","mapboxgl-canvas-container",f);this._canvas=fn("canvas","mapboxgl-canvas",r),this._interactive&&(r.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const l=this._controlContainer=fn("div","mapboxgl-control-container",f),p=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(y=>{p[y]=fn("div",`mapboxgl-ctrl-${y}`,l)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(f,r){const l=u.q.devicePixelRatio||1;this._canvas.width=l*Math.ceil(f),this._canvas.height=l*Math.ceil(r),this._canvas.style.width=`${f}px`,this._canvas.style.height=`${r}px`}_addMarker(f){this._markers.push(f)}_removeMarker(f){const r=this._markers.indexOf(f);-1!==r&&this._markers.splice(r,1)}_addPopup(f){this._popups.push(f)}_removePopup(f){const r=this._popups.indexOf(f);-1!==r&&this._popups.splice(r,1)}_setupPainter(){const f=u.h({},Nl.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),r=this._canvas.getContext("webgl2",f);r?(Ma(r,!0),this.painter=new sc(r,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",l=>{"source"===l.dataType&&this.painter.setTileLoadedFlag(!0)}),u.l.testSupport(r)):this.fire(new u.z(new Error("Failed to initialize WebGL")))}_contextLost(f){f.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new u.A("webglcontextlost",{originalEvent:f}))}_contextRestored(f){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new u.A("webglcontextrestored",{originalEvent:f}))}_onMapScroll(f){if(f.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(f){return this.style?(this._styleDirty=this._styleDirty||f,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(f){return this._update(),this._renderTaskQueue.add(f)}_cancelRenderFrame(f){this._renderTaskQueue.remove(f)}_requestDomTask(f){!this.loaded()||this.loaded()&&!this.isMoving()?f():this._domRenderTaskQueue.add(f)}_render(f){let r;this.fire(new u.A("renderstart")),++this._frameId;const l=this.painter.context.extTimerQuery,p=u.q.now(),y=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(r=y.createQuery(),y.beginQuery(l.TIME_ELAPSED_EXT,r)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(f),this._domRenderTaskQueue.run(f),this._removed)return;this._updateProjectionTransition();const v=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const P=this.transform.zoom,O=this.transform.pitch,N=u.q.now(),F=new u.aa(P,{now:N,fadeDuration:v,pitch:O,transition:this.style.transition,worldview:this._worldview});this.style.update(F)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let b=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),b=this._updateAverageElevation(p),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):b=this._updateAverageElevation(p);const D=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,v,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),D&&(this._placementDirty=D.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:v,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new u.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Ca.mark(ji.load),this.fire(new u.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),r){const P=u.q.now()-p;y.endQuery(l.TIME_ELAPSED_EXT),setTimeout(()=>{const O=y.getQueryParameter(r,y.QUERY_RESULT)/1e6;y.deleteQuery(r),this.fire(new u.A("gpu-timing-frame",{cpuTime:P,gpuTime:O}))},50)}if(this.listens("gpu-timing-layer")){const P=this.painter.collectGpuTimers();setTimeout(()=>{const O=this.painter.queryGpuTimers(P);this.fire(new u.A("gpu-timing-layer",{layerTimes:O}))},50)}if(this.listens("gpu-timing-deferred-render")){const P=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const O=this.painter.queryGpuTimeDeferredRender(P);this.fire(new u.A("gpu-timing-deferred-render",{gpuTime:O}))},50)}const C=this._sourcesDirty||this._styleDirty||this._placementDirty||b;if(C||this._repaint)this.triggerRepaint();else{const P=this.idle();if(P&&(b=this._updateAverageElevation(p,!0)),b)this.triggerRepaint();else if(this._triggerFrame(!1),P&&(this.fire(new u.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const O=this._calculateSpeedIndex();this.fire(new u.A("speedindexcompleted",{speedIndex:O})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||C||(this._fullyLoaded=!0,Ca.mark(ji.fullLoad),this._performanceMetricsCollection&&vi(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(f){for(const r of this._markers)f&&!this.getRenderWorldCopies()&&(r._lngLat=r._lngLat.wrap()),r._update();for(const r of this._popups)!f||this.getRenderWorldCopies()||r._trackPointer||(r._lngLat=r._lngLat.wrap()),r._update()}_updateAverageElevation(f,r=!1){const l=y=>(this.transform.averageElevation=y,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&l(0);const p=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(p||(r||f-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(f)){const y=this.transform.averageElevation;let v=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(v)?v=0:this._averageElevationLastSampledAt=f;const b=Math.abs(y-v);if(b>1){if(this._isInitialLoad||p)return this._averageElevation.jumpTo(v),l(v);this._averageElevation.easeTo(v,f,300)}else if(b>1e-4)return this._averageElevation.jumpTo(v),l(v)}return!!this._averageElevation.isEasing(f)&&l(this._averageElevation.getValue(f))}_authenticate(){lr(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,f=>{if(f&&(f.message===go||401===f.status)){const r=this.painter.context.gl;Ma(r,!1),this._logoControl instanceof uc&&this._logoControl._updateLogo(),r&&r.clear(r.DEPTH_BUFFER_BIT|r.COLOR_BUFFER_BIT|r.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new u.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),ff(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Mi(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const f=this._isDragging();this.painter.updateTerrain(this.style,f)}_calculateSpeedIndex(){const f=this.painter.canvasCopy(),r=this.painter.getCanvasCopiesAndTimestamps();r.timeStamps.push(performance.now());const l=this.painter.context.gl,p=l.createFramebuffer();function y(v){l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,v,0);const b=new Uint8Array(l.drawingBufferWidth*l.drawingBufferHeight*4);return l.readPixels(0,0,l.drawingBufferWidth,l.drawingBufferHeight,l.RGBA,l.UNSIGNED_BYTE,b),b}return l.bindFramebuffer(l.FRAMEBUFFER,p),this._canvasPixelComparison(y(f),r.canvasCopies.map(y),r.timeStamps)}_canvasPixelComparison(f,r,l){let p=l[1]-l[0];const y=f.length/4;for(let v=0;v<r.length;v++){const b=r[v];let D=0;for(let C=0;C<b.length;C+=4)b[C]===f[C]&&b[C+1]===f[C+1]&&b[C+2]===f[C+2]&&b[C+3]===f[C+3]&&(D+=1);p+=(l[v+2]-l[v+1])*(1-D/y)}return p}remove(){this._hash&&this._hash.remove();for(const r of this._controls)r.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const f=this.painter.context.gl.getExtension("WEBGL_lose_context");f&&f.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Ls.delete(this.painter.context.gl),nr.remove(),Cu.remove(),this._removed=!0,this.fire(new u.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(f){this._renderNextFrame=this._renderNextFrame||f,this.style&&!this._frame&&(this._frame=u.q.frame(r=>{const l=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,l&&this._render(r)}))}_preloadTiles(f){const r=this.style?this.style.getSourceCaches():[];return u.bt(r,(l,p)=>l._preloadTiles(f,p),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(f){this._trackResize&&this.resize({originalEvent:f})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(f){this._showTileBoundaries!==f&&(this._showTileBoundaries=f,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(f){this._showParseStatus!==f&&(this._showParseStatus=f,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(f){this._showTerrainWireframe!==f&&(this._showTerrainWireframe=f,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(f){this._showLayers2DWireframe!==f&&(this._showLayers2DWireframe=f,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(f){this._showLayers3DWireframe!==f&&(this._showLayers3DWireframe=f,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(f){this._speedIndexTiming!==f&&(this._speedIndexTiming=f,this._update())}get showPadding(){return!!this._showPadding}set showPadding(f){this._showPadding!==f&&(this._showPadding=f,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(f){this._showCollisionBoxes!==f&&(this._showCollisionBoxes=f,this._tp.refreshUI(),f?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(f){this._showOverdrawInspector!==f&&(this._showOverdrawInspector=f,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(f){this._repaint!==f&&(this._repaint=f,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(f){this._vertices=f,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(f){this._showTileAABBs!==f&&(this._showTileAABBs=f,this._tp.refreshUI(),f&&this._update())}_setCacheLimits(f,r){u.eV(f,r)}get version(){return tr}},NavigationControl:class{constructor(f={}){this.options=u.h({},ou,f),this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",r=>r.preventDefault()),this.options.showZoom&&(u.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",r=>{this._map&&this._map.zoomIn({},{originalEvent:r})}),fn("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",r=>{this._map&&this._map.zoomOut({},{originalEvent:r})}),fn("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(u.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",r=>{const l=this._map;l&&(this.options.visualizePitch?l.resetNorthPitch({},{originalEvent:r}):l.resetNorth({},{originalEvent:r}))}),this._compassIcon=fn("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const f=this._map;if(!f)return;const r=f.getZoom(),l=r===f.getMaxZoom(),p=r===f.getMinZoom();this._zoomInButton.disabled=l,this._zoomOutButton.disabled=p,this._zoomInButton.setAttribute("aria-disabled",l.toString()),this._zoomOutButton.setAttribute("aria-disabled",p.toString())}_rotateCompassArrow(){const f=this._map;if(!f)return;const r=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(f.transform.pitch*(Math.PI/180)),.5)}) rotateX(${f.transform.pitch}deg) rotateZ(${f.transform.angle*(180/Math.PI)}deg)`:`rotate(${f.transform.angle*(180/Math.PI)}deg)`;f._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=r)})}onAdd(f){return this._map=f,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),f.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&f.on("pitch",this._rotateCompassArrow),f.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new _l(f,this._compass,this.options.visualizePitch)),this._container}onRemove(){const f=this._map;f&&(this._container.remove(),this.options.showZoom&&f.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&f.off("pitch",this._rotateCompassArrow),f.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(f,r){const l=fn("button",f,this._container);return l.type="button",l.addEventListener("click",r),l}_setButtonTitle(f,r){if(!this._map)return;const l=this._map._getUIString(`NavigationControl.${r}`);f.setAttribute("aria-label",l),f.firstElementChild&&f.firstElementChild.setAttribute("title",l)}},GeolocateControl:class extends u.E{constructor(f={}){super();const r=navigator.geolocation;this.options=u.h({geolocation:r},w_,f),u.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=td(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(f){return this._map=f,this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(f){const r=(l=!!this.options.geolocation)=>{this._supportsGeolocation=l,f(l)};void 0!==this._supportsGeolocation?f(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then(l=>r("denied"!==l.state)).catch(()=>r()):r()}_isOutOfMapMaxBounds(f){const r=this._map.getMaxBounds(),l=f.coords;return!!r&&(l.longitude<r.getWest()||l.longitude>r.getEast()||l.latitude<r.getSouth()||l.latitude>r.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(f){if(this._map){if(this._isOutOfMapMaxBounds(f))return this._setErrorState(),this.fire(new u.A("outofmaxbounds",f)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=f,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(f),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(f),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new u.A("geolocate",f)),this._finish()}}_updateCamera(f){const r=new u.ci(f.coords.longitude,f.coords.latitude),l=f.coords.accuracy,p=this._map.getBearing(),y=u.h({bearing:p},this.options.fitBoundsOptions);this._map.fitBounds(r.toBounds(l),y,{geolocateSource:!0})}_updateMarker(f){if(f){const r=new u.ci(f.coords.longitude,f.coords.latitude);this._accuracyCircleMarker.setLngLat(r).addTo(this._map),this._userLocationDotMarker.setLngLat(r).addTo(this._map),this._accuracy=f.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const f=this._map.transform,r=u.cb(1,f._center.lat)*f.worldSize,l=Math.ceil(2*this._accuracy*r);this._circleElement.style.width=`${l}px`,this._circleElement.style.height=`${l}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(f){if(this._map){if(this.options.trackUserLocation)if(1===f.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const r=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===f.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new u.A("error",f)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(f){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",r=>r.preventDefault()),this._geolocateButton=fn("button","mapboxgl-ctrl-geolocate",this._container),fn("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===f){u.w("Geolocation support is not available so the GeolocateControl will be disabled.");const r=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r)}else{const r=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=fn("div","mapboxgl-user-location"),this._dotElement.appendChild(fn("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(fn("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Cs({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=fn("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Cs({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",r=>{r.geolocateSource||"ACTIVE_LOCK"!==this._watchState||r.originalEvent&&"resize"===r.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new u.A("trackuserlocationend")))})}}_onDeviceOrientation(f){this._userLocationDotMarker&&(f.webkitCompassHeading?this._heading=f.webkitCompassHeading:!0===f.absolute&&(this._heading=-1*f.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return u.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new u.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new u.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new u.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let f;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(f={maximumAge:6e5,timeout:0},this._noTimeout=!0):(f=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,f),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const f=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(r=>{"granted"===r&&f()}).catch(console.error):f()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:ad,ScaleControl:class{constructor(f={}){this.options=u.h({},Th,f),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),u.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const f=this.options.maxWidth||100,r=this._map,l=r._containerHeight/2,p=r._containerWidth/2-f/2,y=r.unproject([p,l]),v=r.unproject([p+f,l]),b=y.distanceTo(v);if("imperial"===this.options.unit){const D=3.2808*b;D>5280?this._setScale(f,D/5280,"mile"):this._setScale(f,D,"foot")}else"nautical"===this.options.unit?this._setScale(f,b/1852,"nautical-mile"):b>=1e3?this._setScale(f,b/1e3,"kilometer"):this._setScale(f,b,"meter")}_setScale(f,r,l){this._map._requestDomTask(()=>{const p=function(v){const b=Math.pow(10,`${Math.floor(v)}`.length-1);let D=v/b;return D=D>=10?10:D>=5?5:D>=3?3:D>=2?2:D>=1?1:function(C){const P=Math.pow(10,Math.ceil(-Math.log(C)/Math.LN10));return Math.round(C*P)/P}(D),b*D}(r),y=p/r;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==l?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:l}).format(p):`${p}&nbsp;${Lv[l]}`,this._container.style.width=f*y+"px"})}onAdd(f){return this._map=f,this._language=f.getLanguage(),this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-scale",f.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(f){this._language=f,this._update()}setUnit(f){this.options.unit=f,this._update()}},FullscreenControl:class{constructor(f={}){this._fullscreen=!1,f&&f.container&&(f.container instanceof HTMLElement?this._container=f.container:u.w("Full screen control 'container' must be a DOM element.")),u.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(f){return this._map=f,this._container||(this._container=this._map.getContainer()),this._controlContainer=fn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",u.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const f=this._fullscreenButton=fn("button","mapboxgl-ctrl-fullscreen",this._controlContainer);fn("span","mapboxgl-ctrl-icon",f).setAttribute("aria-hidden","true"),f.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const f=this._getTitle();this._fullscreenButton.setAttribute("aria-label",f),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",f)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:Eh,Popup:class extends u.E{constructor(f){super(),this.options=u.h(Object.create(fs),f),this._altitude=this.options.altitude,u.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(f&&f.className?f.className.trim().split(/\s+/):[])}addTo(f){return this._map&&this.remove(),this._map=f,this.options.closeOnClick&&f.on("preclick",this._onClose),this.options.closeOnMove&&f.on("move",this._onClose),f.on("remove",this.remove),this._update(),f._addPopup(this),this._focusFirstElement(),this._trackPointer?(f.on("mousemove",this._onMouseEvent),f.on("mouseup",this._onMouseEvent),f._canvasContainer.classList.add("mapboxgl-track-pointer")):f.on("move",this._update),this.fire(new u.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const f=this._map;return f&&(f.off("move",this._update),f.off("move",this._onClose),f.off("preclick",this._onClose),f.off("click",this._onClose),f.off("remove",this.remove),f.off("mousemove",this._onMouseEvent),f.off("mouseup",this._onMouseEvent),f.off("drag",this._onMouseEvent),f._canvasContainer&&f._canvasContainer.classList.remove("mapboxgl-track-pointer"),f._removePopup(this),this._map=void 0),this.fire(new u.A("close")),this}getLngLat(){return this._lngLat}setLngLat(f){this._lngLat=u.ci.convert(f),this._pos=null,this._trackPointer=!1,this._update();const r=this._map;return r&&(r.on("move",this._update),r.off("mousemove",this._onMouseEvent),r._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(f){return this._altitude=f,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const f=this._map;return f&&(f.off("move",this._update),f.on("mousemove",this._onMouseEvent),f.on("drag",this._onMouseEvent),f._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(f){return this.setDOMContent(document.createTextNode(f))}setHTML(f){const r=document.createDocumentFragment(),l=document.createElement("body");let p;for(l.innerHTML=f;p=l.firstChild,p;)r.appendChild(p);return this.setDOMContent(r)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(f){return this.options.maxWidth=f,this._update(),this}setDOMContent(f){let r=this._content;if(r)for(;r.hasChildNodes();)r.firstChild&&r.removeChild(r.firstChild);else r=this._content=fn("div","mapboxgl-popup-content",this._container||void 0);if(r.appendChild(f),this.options.closeButton){const l=this._closeButton=fn("button","mapboxgl-popup-close-button",r);l.type="button",l.setAttribute("aria-label","Close popup"),l.innerHTML='<span aria-hidden="true">&#215;</span>',l.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(f){return this._classList.add(f),this._updateClassList(),this}removeClassName(f){return this._classList.delete(f),this._updateClassList(),this}setOffset(f){return this.options.offset=f,this._update(),this}toggleClassName(f){let r;return this._classList.delete(f)?r=!1:(this._classList.add(f),r=!0),this._updateClassList(),r}_onMouseEvent(f){this._update(f.point)}_getAnchor(f){if(this.options.anchor)return this.options.anchor;const r=this._map,l=this._container,p=this._pos;if(!r||!l||!p)return"bottom";const y=l.offsetWidth,v=l.offsetHeight,b=p.x<y/2,D=p.x>r.transform.width-y/2;if(p.y+f<v)return b?"top-left":D?"top-right":"top";if(p.y>r.transform.height-v){if(b)return"bottom-left";if(D)return"bottom-right"}return b?"left":D?"right":"bottom"}_updateClassList(){const f=this._container;if(!f)return;const r=[...this._classList];r.push("mapboxgl-popup"),this._anchor&&r.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&r.push("mapboxgl-popup-track-pointer"),f.className=r.join(" ")}_update(f){const r=this._map,l=this._content;if(!r||!this._lngLat&&!this._trackPointer||!l)return;let p=this._container;if(p||(p=this._container=fn("div","mapboxgl-popup",r.getContainer()),this._tip=fn("div","mapboxgl-popup-tip",p),p.appendChild(l)),this.options.maxWidth&&p.style.maxWidth!==this.options.maxWidth&&(p.style.maxWidth=this.options.maxWidth),r.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=hs(this._lngLat,this._pos,r.transform)),!this._trackPointer||f){const y=this._pos=this._trackPointer&&f instanceof u.P?f:r.project(this._lngLat,this._altitude),v=Zi(this.options.offset),b=this._anchor=this._getAnchor(v.y),D=Zi(this.options.offset,b),C=y.add(D).round();r._requestDomTask(()=>{this._container&&b&&(this._container.style.transform=`${co[b]} translate(${C.x}px,${C.y}px)`)})}if(!this._marker&&r._showingGlobe()){const y=u.eW(r.transform,this._lngLat)?0:1;this._setOpacity(y)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const f=this._container.querySelector(E_);f&&f.focus()}_onClose(){this.remove()}_setOpacity(f){this._container&&(this._container.style.opacity=`${f}`),this._content&&(this._content.style.pointerEvents=f?"auto":"none")}},Marker:Cs,Style:js,LngLat:u.ci,LngLatBounds:u.aG,Point:u.P,MercatorCoordinate:u.ac,FreeCameraOptions:Yd,Evented:u.E,config:u.e,prewarm:u.e_,clearPrewarmedResources:u.eZ,get accessToken(){return u.e.ACCESS_TOKEN},set accessToken(f){u.e.ACCESS_TOKEN=f},get baseApiUrl(){return u.e.API_URL},set baseApiUrl(f){u.e.API_URL=f},get workerCount(){return u.f7.workerCount},set workerCount(f){u.f7.workerCount=f},get maxParallelImageRequests(){return u.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(f){u.e.MAX_PARALLEL_IMAGE_REQUESTS=f},clearStorage(f){u.f6(f)},get workerUrl(){return u.f5.workerUrl},set workerUrl(f){u.f5.workerUrl=f},get workerClass(){return u.f5.workerClass},set workerClass(f){u.f5.workerClass=f},get workerParams(){return u.f5.workerParams},set workerParams(f){u.f5.workerParams=f},get dracoUrl(){return u.f4()},set dracoUrl(f){u.f3(f)},get meshoptUrl(){return u.f2()},set meshoptUrl(f){u.f1(f)},setNow:u.q.setNow,restoreNow:u.q.restoreNow}}),er}()}},pv=>{pv(pv.s=165)}]);
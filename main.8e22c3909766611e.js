(self.webpackChunkchruch_project=self.webpackChunkchruch_project||[]).push([[792],{129:(ev,Jh,ef)=>{"use strict";function Yi(t){return"function"==typeof t}function Fg(t){const i=t(a=>{Error.call(a),a.stack=(new Error).stack});return i.prototype=Object.create(Error.prototype),i.prototype.constructor=i,i}const tv=Fg(t=>function(i){t(this),this.message=i?`${i.length} errors occurred during unsubscription:\n${i.map((a,h)=>`${h+1}) ${a.toString()}`).join("\n  ")}`:"",this.name="UnsubscriptionError",this.errors=i});function u(t,n){if(t){const i=t.indexOf(n);0<=i&&t.splice(i,1)}}class Ki{constructor(n){this.initialTeardown=n,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let n;if(!this.closed){this.closed=!0;const{_parentage:i}=this;if(i)if(this._parentage=null,Array.isArray(i))for(const y of i)y.remove(this);else i.remove(this);const{initialTeardown:a}=this;if(Yi(a))try{a()}catch(y){n=y instanceof tv?y.errors:[y]}const{_finalizers:h}=this;if(h){this._finalizers=null;for(const y of h)try{Id(y)}catch(E){n=n??[],E instanceof tv?n=[...n,...E.errors]:n.push(E)}}if(n)throw new tv(n)}}add(n){var i;if(n&&n!==this)if(this.closed)Id(n);else{if(n instanceof Ki){if(n.closed||n._hasParent(this))return;n._addParent(this)}(this._finalizers=null!==(i=this._finalizers)&&void 0!==i?i:[]).push(n)}}_hasParent(n){const{_parentage:i}=this;return i===n||Array.isArray(i)&&i.includes(n)}_addParent(n){const{_parentage:i}=this;this._parentage=Array.isArray(i)?(i.push(n),i):i?[i,n]:n}_removeParent(n){const{_parentage:i}=this;i===n?this._parentage=null:Array.isArray(i)&&u(i,n)}remove(n){const{_finalizers:i}=this;i&&u(i,n),n instanceof Ki&&n._removeParent(this)}}Ki.EMPTY=(()=>{const t=new Ki;return t.closed=!0,t})();const Ni=Ki.EMPTY;function xa(t){return t instanceof Ki||t&&"closed"in t&&Yi(t.remove)&&Yi(t.add)&&Yi(t.unsubscribe)}function Id(t){Yi(t)?t():t.unsubscribe()}const Cs={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},As={setTimeout(t,n,...i){const{delegate:a}=As;return a?.setTimeout?a.setTimeout(t,n,...i):setTimeout(t,n,...i)},clearTimeout(t){const{delegate:n}=As;return(n?.clearTimeout||clearTimeout)(t)},delegate:void 0};function Dl(t){As.setTimeout(()=>{const{onUnhandledError:n}=Cs;if(!n)throw t;n(t)})}function fn(){}const Zo=eo("C",void 0,void 0);function eo(t,n,i){return{kind:t,value:n,error:i}}let fs=null;function Vs(t){if(Cs.useDeprecatedSynchronousErrorHandling){const n=!fs;if(n&&(fs={errorThrown:!1,error:null}),t(),n){const{errorThrown:i,error:a}=fs;if(fs=null,i)throw a}}else t()}class Cl extends Ki{constructor(n){super(),this.isStopped=!1,n?(this.destination=n,xa(n)&&n.add(this)):this.destination=hr}static create(n,i,a){return new jn(n,i,a)}next(n){this.isStopped?dr(function zo(t){return eo("N",t,void 0)}(n),this):this._next(n)}error(n){this.isStopped?dr(function Bi(t){return eo("E",void 0,t)}(n),this):(this.isStopped=!0,this._error(n))}complete(){this.isStopped?dr(Zo,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(n){this.destination.next(n)}_error(n){try{this.destination.error(n)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}}const ra=Function.prototype.bind;function ba(t,n){return ra.call(t,n)}class tf{constructor(n){this.partialObserver=n}next(n){const{partialObserver:i}=this;if(i.next)try{i.next(n)}catch(a){za(a)}}error(n){const{partialObserver:i}=this;if(i.error)try{i.error(n)}catch(a){za(a)}else za(n)}complete(){const{partialObserver:n}=this;if(n.complete)try{n.complete()}catch(i){za(i)}}}class jn extends Cl{constructor(n,i,a){let h;if(super(),Yi(n)||!n)h={next:n??void 0,error:i??void 0,complete:a??void 0};else{let y;this&&Cs.useDeprecatedNextContext?(y=Object.create(n),y.unsubscribe=()=>this.unsubscribe(),h={next:n.next&&ba(n.next,y),error:n.error&&ba(n.error,y),complete:n.complete&&ba(n.complete,y)}):h=n}this.destination=new tf(h)}}function za(t){Cs.useDeprecatedSynchronousErrorHandling?function Il(t){Cs.useDeprecatedSynchronousErrorHandling&&fs&&(fs.errorThrown=!0,fs.error=t)}(t):Dl(t)}function dr(t,n){const{onStoppedNotification:i}=Cs;i&&As.setTimeout(()=>i(t,n))}const hr={closed:!0,next:fn,error:function uo(t){throw t},complete:fn},Oi="function"==typeof Symbol&&Symbol.observable||"@@observable";function to(t){return t}let qi=(()=>{class t{constructor(i){i&&(this._subscribe=i)}lift(i){const a=new t;return a.source=this,a.operator=i,a}subscribe(i,a,h){const y=function xu(t){return t&&t instanceof Cl||function No(t){return t&&Yi(t.next)&&Yi(t.error)&&Yi(t.complete)}(t)&&xa(t)}(i)?i:new jn(i,a,h);return Vs(()=>{const{operator:E,source:D}=this;y.add(E?E.call(y,D):D?this._subscribe(y):this._trySubscribe(y))}),y}_trySubscribe(i){try{return this._subscribe(i)}catch(a){i.error(a)}}forEach(i,a){return new(a=Li(a))((h,y)=>{const E=new jn({next:D=>{try{i(D)}catch(O){y(O),E.unsubscribe()}},error:y,complete:h});this.subscribe(E)})}_subscribe(i){var a;return null===(a=this.source)||void 0===a?void 0:a.subscribe(i)}[Oi](){return this}pipe(...i){return function wa(t){return 0===t.length?to:1===t.length?t[0]:function(i){return t.reduce((a,h)=>h(a),i)}}(i)(this)}toPromise(i){return new(i=Li(i))((a,h)=>{let y;this.subscribe(E=>y=E,E=>h(E),()=>a(y))})}}return t.create=n=>new t(n),t})();function Li(t){var n;return null!==(n=t??Cs.Promise)&&void 0!==n?n:Promise}const rf=Fg(t=>function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});let Vi=(()=>{class t extends qi{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(i){const a=new Ai(this,this);return a.operator=i,a}_throwIfClosed(){if(this.closed)throw new rf}next(i){Vs(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(const a of this.currentObservers)a.next(i)}})}error(i){Vs(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=i;const{observers:a}=this;for(;a.length;)a.shift().error(i)}})}complete(){Vs(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;const{observers:i}=this;for(;i.length;)i.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var i;return(null===(i=this.observers)||void 0===i?void 0:i.length)>0}_trySubscribe(i){return this._throwIfClosed(),super._trySubscribe(i)}_subscribe(i){return this._throwIfClosed(),this._checkFinalizedStatuses(i),this._innerSubscribe(i)}_innerSubscribe(i){const{hasError:a,isStopped:h,observers:y}=this;return a||h?Ni:(this.currentObservers=null,y.push(i),new Ki(()=>{this.currentObservers=null,u(y,i)}))}_checkFinalizedStatuses(i){const{hasError:a,thrownError:h,isStopped:y}=this;a?i.error(h):y&&i.complete()}asObservable(){const i=new qi;return i.source=this,i}}return t.create=(n,i)=>new Ai(n,i),t})();class Ai extends Vi{constructor(n,i){super(),this.destination=n,this.source=i}next(n){var i,a;null===(a=null===(i=this.destination)||void 0===i?void 0:i.next)||void 0===a||a.call(i,n)}error(n){var i,a;null===(a=null===(i=this.destination)||void 0===i?void 0:i.error)||void 0===a||a.call(i,n)}complete(){var n,i;null===(i=null===(n=this.destination)||void 0===n?void 0:n.complete)||void 0===i||i.call(n)}_subscribe(n){var i,a;return null!==(a=null===(i=this.source)||void 0===i?void 0:i.subscribe(n))&&void 0!==a?a:Ni}}function yi(t){return n=>{if(function ir(t){return Yi(t?.lift)}(n))return n.lift(function(i){try{return t(i,this)}catch(a){this.error(a)}});throw new TypeError("Unable to lift unknown Observable type")}}function er(t,n,i,a,h){return new rr(t,n,i,a,h)}class rr extends Cl{constructor(n,i,a,h,y,E){super(n),this.onFinalize=y,this.shouldUnsubscribe=E,this._next=i?function(D){try{i(D)}catch(O){n.error(O)}}:super._next,this._error=h?function(D){try{h(D)}catch(O){n.error(O)}finally{this.unsubscribe()}}:super._error,this._complete=a?function(){try{a()}catch(D){n.error(D)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var n;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){const{closed:i}=this;super.unsubscribe(),!i&&(null===(n=this.onFinalize)||void 0===n||n.call(this))}}}function js(t,n){return yi((i,a)=>{let h=0;i.subscribe(er(a,y=>{a.next(t.call(n,y,h++))}))})}function Gr(t){return this instanceof Gr?(this.v=t,this):new Gr(t)}function Ha(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,n=t[Symbol.asyncIterator];return n?n.call(t):(t=function Ko(t){var n="function"==typeof Symbol&&Symbol.iterator,i=n&&t[n],a=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&a>=t.length&&(t=void 0),{value:t&&t[a++],done:!t}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")}(t),i={},a("next"),a("throw"),a("return"),i[Symbol.asyncIterator]=function(){return this},i);function a(y){i[y]=t[y]&&function(E){return new Promise(function(D,O){!function h(y,E,D,O){Promise.resolve(O).then(function(N){y({value:N,done:D})},E)}(D,O,(E=t[y](E)).done,E.value)})}}}"function"==typeof SuppressedError&&SuppressedError;const Pn=t=>t&&"number"==typeof t.length&&"function"!=typeof t;function Pe(t){return Yi(t?.then)}function Z(t){return Yi(t[Oi])}function X(t){return Symbol.asyncIterator&&Yi(t?.[Symbol.asyncIterator])}function oe(t){return new TypeError(`You provided ${null!==t&&"object"==typeof t?"an invalid object":`'${t}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}const se=function ge(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}();function be(t){return Yi(t?.[se])}function ke(t){return function ja(t,n,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var h,a=i.apply(t,n||[]),y=[];return h=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),D("next"),D("throw"),D("return",function E(ve){return function(Oe){return Promise.resolve(Oe).then(ve,J)}}),h[Symbol.asyncIterator]=function(){return this},h;function D(ve,Oe){a[ve]&&(h[ve]=function(He){return new Promise(function(mt,Mt){y.push([ve,He,mt,Mt])>1||O(ve,He)})},Oe&&(h[ve]=Oe(h[ve])))}function O(ve,Oe){try{!function N(ve){ve.value instanceof Gr?Promise.resolve(ve.value.v).then($,J):we(y[0][2],ve)}(a[ve](Oe))}catch(He){we(y[0][3],He)}}function $(ve){O("next",ve)}function J(ve){O("throw",ve)}function we(ve,Oe){ve(Oe),y.shift(),y.length&&O(y[0][0],y[0][1])}}(this,arguments,function*(){const i=t.getReader();try{for(;;){const{value:a,done:h}=yield Gr(i.read());if(h)return yield Gr(void 0);yield yield Gr(a)}}finally{i.releaseLock()}})}function Te(t){return Yi(t?.getReader)}function Ae(t){if(t instanceof qi)return t;if(null!=t){if(Z(t))return function st(t){return new qi(n=>{const i=t[Oi]();if(Yi(i.subscribe))return i.subscribe(n);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}(t);if(Pn(t))return function qe(t){return new qi(n=>{for(let i=0;i<t.length&&!n.closed;i++)n.next(t[i]);n.complete()})}(t);if(Pe(t))return function kt(t){return new qi(n=>{t.then(i=>{n.closed||(n.next(i),n.complete())},i=>n.error(i)).then(null,Dl)})}(t);if(X(t))return Wt(t);if(be(t))return function Gt(t){return new qi(n=>{for(const i of t)if(n.next(i),n.closed)return;n.complete()})}(t);if(Te(t))return function bn(t){return Wt(ke(t))}(t)}throw oe(t)}function Wt(t){return new qi(n=>{(function pn(t,n){var i,a,h,y;return function Ta(t,n,i,a){return new(i||(i=Promise))(function(y,E){function D($){try{N(a.next($))}catch(J){E(J)}}function O($){try{N(a.throw($))}catch(J){E(J)}}function N($){$.done?y($.value):function h(y){return y instanceof i?y:new i(function(E){E(y)})}($.value).then(D,O)}N((a=a.apply(t,n||[])).next())})}(this,void 0,void 0,function*(){try{for(i=Ha(t);!(a=yield i.next()).done;)if(n.next(a.value),n.closed)return}catch(E){h={error:E}}finally{try{a&&!a.done&&(y=i.return)&&(yield y.call(i))}finally{if(h)throw h.error}}n.complete()})})(t,n).catch(i=>n.error(i))})}function cn(t,n,i,a=0,h=!1){const y=n.schedule(function(){i(),h?t.add(this.schedule(null,a)):this.unsubscribe()},a);if(t.add(y),!h)return y}function yn(t,n,i=1/0){return Yi(n)?yn((a,h)=>js((y,E)=>n(a,y,h,E))(Ae(t(a,h))),i):("number"==typeof n&&(i=n),yi((a,h)=>function pi(t,n,i,a,h,y,E,D){const O=[];let N=0,$=0,J=!1;const we=()=>{J&&!O.length&&!N&&n.complete()},ve=He=>N<a?Oe(He):O.push(He),Oe=He=>{y&&n.next(He),N++;let mt=!1;Ae(i(He,$++)).subscribe(er(n,Mt=>{h?.(Mt),y?ve(Mt):n.next(Mt)},()=>{mt=!0},void 0,()=>{if(mt)try{for(N--;O.length&&N<a;){const Mt=O.shift();E?cn(n,E,()=>Oe(Mt)):Oe(Mt)}we()}catch(Mt){n.error(Mt)}}))};return t.subscribe(er(n,ve,()=>{J=!0,we()})),()=>{D?.()}}(a,h,t,i)))}function Qi(t=1/0){return yn(to,t)}const wr=new qi(t=>t.complete());function Bn(t){return t&&Yi(t.schedule)}function ji(t){return t[t.length-1]}function Si(t){return Bn(ji(t))?t.pop():void 0}function Bo(t,n=0){return yi((i,a)=>{i.subscribe(er(a,h=>cn(a,t,()=>a.next(h),n),()=>cn(a,t,()=>a.complete(),n),h=>cn(a,t,()=>a.error(h),n)))})}function ho(t,n=0){return yi((i,a)=>{a.add(t.schedule(()=>i.subscribe(a),n))})}function Su(t,n){if(!t)throw new Error("Iterable cannot be null");return new qi(i=>{cn(i,n,()=>{const a=t[Symbol.asyncIterator]();cn(i,n,()=>{a.next().then(h=>{h.done?i.complete():i.next(h.value)})},0,!0)})})}function Ol(t,n){return n?function lf(t,n){if(null!=t){if(Z(t))return function Od(t,n){return Ae(t).pipe(ho(n),Bo(n))}(t,n);if(Pn(t))return function Rl(t,n){return new qi(i=>{let a=0;return n.schedule(function(){a===t.length?i.complete():(i.next(t[a++]),i.closed||this.schedule())})})}(t,n);if(Pe(t))return function no(t,n){return Ae(t).pipe(ho(n),Bo(n))}(t,n);if(X(t))return Su(t,n);if(be(t))return function af(t,n){return new qi(i=>{let a;return cn(i,n,()=>{a=t[se](),cn(i,n,()=>{let h,y;try{({value:h,done:y}=a.next())}catch(E){return void i.error(E)}y?i.complete():i.next(h)},0,!0)}),()=>Yi(a?.return)&&a.return()})}(t,n);if(Te(t))return function Ld(t,n){return Su(ke(t),n)}(t,n)}throw oe(t)}(t,n):Ae(t)}function $a(...t){const n=Si(t),i=function $r(t,n){return"number"==typeof ji(t)?t.pop():n}(t,1/0),a=t;return a.length?1===a.length?Ae(a[0]):Qi(i)(Ol(a,n)):wr}class Du extends Vi{constructor(n){super(),this._value=n}get value(){return this.getValue()}_subscribe(n){const i=super._subscribe(n);return!i.closed&&n.next(this._value),i}getValue(){const{hasError:n,thrownError:i,_value:a}=this;if(n)throw i;return this._throwIfClosed(),a}next(n){super.next(this._value=n)}}function gc(...t){return Ol(t,Si(t))}function Us(t={}){const{connector:n=(()=>new Vi),resetOnError:i=!0,resetOnComplete:a=!0,resetOnRefCountZero:h=!0}=t;return y=>{let E,D,O,N=0,$=!1,J=!1;const we=()=>{D?.unsubscribe(),D=void 0},ve=()=>{we(),E=O=void 0,$=J=!1},Oe=()=>{const He=E;ve(),He?.unsubscribe()};return yi((He,mt)=>{N++,!J&&!$&&we();const Mt=O=O??n();mt.add(()=>{N--,0===N&&!J&&!$&&(D=Qo(Oe,h))}),Mt.subscribe(mt),!E&&N>0&&(E=new jn({next:dt=>Mt.next(dt),error:dt=>{J=!0,we(),D=Qo(ve,i,dt),Mt.error(dt)},complete:()=>{$=!0,we(),D=Qo(ve,a),Mt.complete()}}),Ae(He).subscribe(E))})(y)}}function Qo(t,n,...i){if(!0===n)return void t();if(!1===n)return;const a=new jn({next:()=>{a.unsubscribe(),t()}});return Ae(n(...i)).subscribe(a)}function Sa(t,n=to){return t=t??oa,yi((i,a)=>{let h,y=!0;i.subscribe(er(a,E=>{const D=n(E);(y||!t(h,D))&&(y=!1,h=D,a.next(E))}))})}function oa(t,n){return t===n}function Di(t){for(let n in t)if(t[n]===Di)return n;throw Error("Could not find renamed property on target object.")}function Ll(t,n){for(const i in n)n.hasOwnProperty(i)&&!t.hasOwnProperty(i)&&(t[i]=n[i])}function sr(t){if("string"==typeof t)return t;if(Array.isArray(t))return"["+t.map(sr).join(", ")+"]";if(null==t)return""+t;if(t.overriddenName)return`${t.overriddenName}`;if(t.name)return`${t.name}`;const n=t.toString();if(null==n)return""+n;const i=n.indexOf("\n");return-1===i?n:n.substring(0,i)}function _c(t,n){return null==t||""===t?null===n?"":n:null==n||""===n?t:t+" "+n}const yc=Di({__forward_ref__:Di});function kl(t){return t.__forward_ref__=kl,t.toString=function(){return sr(this())},t}function Fn(t){return function kd(t){return"function"==typeof t&&t.hasOwnProperty(yc)&&t.__forward_ref__===kl}(t)?t():t}function Do(t){return t&&!!t.\u0275providers}class Pt extends Error{constructor(n,i){super(function Fd(t,n){return`NG0${Math.abs(t)}${n?": "+n:""}`}(n,i)),this.code=n}}function $n(t){return"string"==typeof t?t:null==t?"":String(t)}function vc(t,n){throw new Pt(-201,!1)}function qr(t,n){null==t&&function _n(t,n,i,a){throw new Error(`ASSERTION ERROR: ${t}`+(null==a?"":` [Expected=> ${i} ${a} ${n} <=Actual]`))}(n,t,null,"!=")}function Qt(t){return{token:t.token,providedIn:t.providedIn||null,factory:t.factory,value:void 0}}function Or(t){return{providers:t.providers||[],imports:t.imports||[]}}function Pu(t){return Ru(t,Ft)||Ru(t,Lu)}function Ru(t,n){return t.hasOwnProperty(n)?t[n]:null}function Vd(t){return t&&(t.hasOwnProperty(uf)||t.hasOwnProperty(Ec))?t[uf]:null}const Ft=Di({\u0275prov:Di}),uf=Di({\u0275inj:Di}),Lu=Di({ngInjectableDef:Di}),Ec=Di({ngInjectorDef:Di});var Un=function(t){return t[t.Default=0]="Default",t[t.Host=1]="Host",t[t.Self=2]="Self",t[t.SkipSelf=4]="SkipSelf",t[t.Optional=8]="Optional",t}(Un||{});let jd;function Et(t){const n=jd;return jd=t,n}function Hn(t,n,i){const a=Pu(t);return a&&"root"==a.providedIn?void 0===a.value?a.value=a.factory():a.value:i&Un.Optional?null:void 0!==n?n:void vc(sr(t))}const mi=globalThis;class Jt{constructor(n,i){this._desc=n,this.ngMetadataName="InjectionToken",this.\u0275prov=void 0,"number"==typeof i?this.__NG_ELEMENT_ID__=i:void 0!==i&&(this.\u0275prov=Qt({token:this,providedIn:i.providedIn||"root",factory:i.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}}const Wr={},aa="__NG_DI_FLAG__",po="ngTempTokenPath",an=/\n/gm,Os="__source";let Bt;function Gs(t){const n=Bt;return Bt=t,n}function Nt(t,n=Un.Default){if(void 0===Bt)throw new Pt(-203,!1);return null===Bt?Hn(t,void 0,n):Bt.get(t,n&Un.Optional?null:void 0,n)}function gt(t,n=Un.Default){return(function Tc(){return jd}()||Nt)(Fn(t),n)}function di(t,n=Un.Default){return gt(t,Ud(n))}function Ud(t){return typeof t>"u"||"number"==typeof t?t:0|(t.optional&&8)|(t.host&&1)|(t.self&&2)|(t.skipSelf&&4)}function gs(t){const n=[];for(let i=0;i<t.length;i++){const a=Fn(t[i]);if(Array.isArray(a)){if(0===a.length)throw new Pt(900,!1);let h,y=Un.Default;for(let E=0;E<a.length;E++){const D=a[E],O=Hd(D);"number"==typeof O?-1===O?h=D.token:y|=O:h=D}n.push(gt(h,y))}else n.push(gt(a))}return n}function Hd(t){return t[aa]}function mo(t){return{toString:t}.toString()}var Yr=function(t){return t[t.OnPush=0]="OnPush",t[t.Default=1]="Default",t}(Yr||{}),Vo=function(t){return t[t.Emulated=0]="Emulated",t[t.None=2]="None",t[t.ShadowDom=3]="ShadowDom",t}(Vo||{});const Da={},Hi=[],la=Di({\u0275cmp:Di}),Nl=Di({\u0275dir:Di}),qa=Di({\u0275pipe:Di}),Mc=Di({\u0275mod:Di}),Ia=Di({\u0275fac:Di}),Bl=Di({__NG_ELEMENT_ID__:Di}),ff=Di({__NG_ENV_ID__:Di});function Wa(t,n,i){let a=t.length;for(;;){const h=t.indexOf(n,i);if(-1===h)return h;if(0===h||t.charCodeAt(h-1)<=32){const y=n.length;if(h+y===a||t.charCodeAt(h+y)<=32)return h}i=h+1}}function Bp(t,n,i){let a=0;for(;a<i.length;){const h=i[a];if("number"==typeof h){if(0!==h)break;a++;const y=i[a++],E=i[a++],D=i[a++];t.setAttribute(n,E,D,y)}else{const y=h,E=i[++a];Vg(y)?t.setProperty(n,y,E):t.setAttribute(n,y,E),a++}}return a}function Vp(t){return 3===t||4===t||6===t}function Vg(t){return 64===t.charCodeAt(0)}function ku(t,n){if(null!==n&&0!==n.length)if(null===t||0===t.length)t=n.slice();else{let i=-1;for(let a=0;a<n.length;a++){const h=n[a];"number"==typeof h?i=h:0===i||jp(t,i,h,null,-1===i||2===i?n[++a]:null)}}return t}function jp(t,n,i,a,h){let y=0,E=t.length;if(-1===n)E=-1;else for(;y<t.length;){const D=t[y++];if("number"==typeof D){if(D===n){E=-1;break}if(D>n){E=y-1;break}}}for(;y<t.length;){const D=t[y];if("number"==typeof D)break;if(D===i){if(null===a)return void(null!==h&&(t[y+1]=h));if(a===t[y+1])return void(t[y+2]=h)}y++,null!==a&&y++,null!==h&&y++}-1!==E&&(t.splice(E,0,n),y=E+1),t.splice(y++,0,i),null!==a&&t.splice(y++,0,a),null!==h&&t.splice(y++,0,h)}const pf="ng-template";function Vl(t,n,i){let a=0,h=!0;for(;a<t.length;){let y=t[a++];if("string"==typeof y&&h){const E=t[a++];if(i&&"class"===y&&-1!==Wa(E.toLowerCase(),n,0))return!0}else{if(1===y){for(;a<t.length&&"string"==typeof(y=t[a++]);)if(y.toLowerCase()===n)return!0;return!1}"number"==typeof y&&(h=!1)}}return!1}function Up(t){return 4===t.type&&t.value!==pf}function jg(t,n,i){return n===(4!==t.type||i?t.value:pf)}function mf(t,n,i){let a=4;const h=t.attrs||[],y=function Fu(t){for(let n=0;n<t.length;n++)if(Vp(t[n]))return n;return t.length}(h);let E=!1;for(let D=0;D<n.length;D++){const O=n[D];if("number"!=typeof O){if(!E)if(4&a){if(a=2|1&a,""!==O&&!jg(t,O,i)||""===O&&1===n.length){if(go(a))return!1;E=!0}}else{const N=8&a?O:n[++D];if(8&a&&null!==t.attrs){if(!Vl(t.attrs,N,i)){if(go(a))return!1;E=!0}continue}const J=Gd(8&a?"class":O,h,Up(t),i);if(-1===J){if(go(a))return!1;E=!0;continue}if(""!==N){let we;we=J>y?"":h[J+1].toLowerCase();const ve=8&a?we:null;if(ve&&-1!==Wa(ve,N,0)||2&a&&N!==we){if(go(a))return!1;E=!0}}}}else{if(!E&&!go(a)&&!go(O))return!1;if(E&&go(O))continue;E=!1,a=O|1&a}}return go(a)||E}function go(t){return 0==(1&t)}function Gd(t,n,i,a){if(null===n)return-1;let h=0;if(a||!i){let y=!1;for(;h<n.length;){const E=n[h];if(E===t)return h;if(3===E||6===E)y=!0;else{if(1===E||2===E){let D=n[++h];for(;"string"==typeof D;)D=n[++h];continue}if(4===E)break;if(0===E){h+=4;continue}}h+=y?1:2}return-1}return function zu(t,n){let i=t.indexOf(4);if(i>-1)for(i++;i<t.length;){const a=t[i];if("number"==typeof a)return-1;if(a===n)return i;i++}return-1}(n,t)}function Ls(t,n,i=!1){for(let a=0;a<n.length;a++)if(mf(t,n[a],i))return!0;return!1}function $d(t,n){return t?":not("+n.trim()+")":n}function ks(t){let n=t[0],i=1,a=2,h="",y=!1;for(;i<t.length;){let E=t[i];if("string"==typeof E)if(2&a){const D=t[++i];h+="["+E+(D.length>0?'="'+D+'"':"")+"]"}else 8&a?h+="."+E:4&a&&(h+=" "+E);else""!==h&&!go(E)&&(n+=$d(y,h),h=""),a=E,y=y||!go(a);i++}return""!==h&&(n+=$d(y,h)),n}function jl(t){return mo(()=>{const n=vf(t),i={...n,decls:t.decls,vars:t.vars,template:t.template,consts:t.consts||null,ngContentSelectors:t.ngContentSelectors,onPush:t.changeDetection===Yr.OnPush,directiveDefs:null,pipeDefs:null,dependencies:n.standalone&&t.dependencies||null,getStandaloneInjector:null,signals:t.signals??!1,data:t.data||{},encapsulation:t.encapsulation||Vo.Emulated,styles:t.styles||Hi,_:null,schemas:t.schemas||null,tView:null,id:""};$p(i);const a=t.dependencies;return i.directiveDefs=Ii(a,!1),i.pipeDefs=Ii(a,!0),i.id=function av(t){let n=0;const i=[t.selectors,t.ngContentSelectors,t.hostVars,t.hostAttrs,t.consts,t.vars,t.decls,t.encapsulation,t.standalone,t.signals,t.exportAs,JSON.stringify(t.inputs),JSON.stringify(t.outputs),Object.getOwnPropertyNames(t.type.prototype),!!t.contentQueries,!!t.viewQuery].join("|");for(const h of i)n=Math.imul(31,n)+h.charCodeAt(0)<<0;return n+=2147483648,"c"+n}(i),i})}function yf(t){return Qn(t)||tn(t)}function qd(t){return null!==t}function Ir(t){return mo(()=>({type:t.type,bootstrap:t.bootstrap||Hi,declarations:t.declarations||Hi,imports:t.imports||Hi,exports:t.exports||Hi,transitiveCompileScopes:null,schemas:t.schemas||null,id:t.id||null}))}function Wd(t,n){if(null==t)return Da;const i={};for(const a in t)if(t.hasOwnProperty(a)){let h=t[a],y=h;Array.isArray(h)&&(y=h[1],h=h[0]),i[h]=a,n&&(n[h]=y)}return i}function Kr(t){return mo(()=>{const n=vf(t);return $p(n),n})}function Qn(t){return t[la]||null}function tn(t){return t[Nl]||null}function Jo(t){return t[qa]||null}function vf(t){const n={};return{type:t.type,providersResolver:null,factory:null,hostBindings:t.hostBindings||null,hostVars:t.hostVars||0,hostAttrs:t.hostAttrs||null,contentQueries:t.contentQueries||null,declaredInputs:n,inputTransforms:null,inputConfig:t.inputs||Da,exportAs:t.exportAs||null,standalone:!0===t.standalone,signals:!0===t.signals,selectors:t.selectors||Hi,viewQuery:t.viewQuery||null,features:t.features||null,setInput:null,findHostDirectiveDefs:null,hostDirectives:null,inputs:Wd(t.inputs,n),outputs:Wd(t.outputs)}}function $p(t){t.features?.forEach(n=>n(t))}function Ii(t,n){if(!t)return null;const i=n?Jo:yf;return()=>("function"==typeof t?t():t).map(a=>i(a)).filter(qd)}const Lr=0,Yt=1,Jn=2,Cr=3,_s=4,Zd=5,Io=6,Ul=7,Ar=8,Ca=9,qs=10,On=11,Hl=12,Xd=13,ca=14,kr=15,Rc=16,Oc=17,es=18,Gl=19,Yd=20,Aa=21,Ws=22,Za=23,Nu=24,vi=25,$l=1,qp=2,Zs=7,Lc=9,io=11;function Co(t){return Array.isArray(t)&&"object"==typeof t[$l]}function Ao(t){return Array.isArray(t)&&!0===t[$l]}function Xa(t){return 0!=(4&t.flags)}function ql(t){return t.componentOffset>-1}function Ya(t){return 1==(1&t.flags)}function ts(t){return!!t.template}function Bu(t){return 0!=(512&t[Jn])}function Ka(t,n){return t.hasOwnProperty(Ia)?t[Ia]:null}let yo=null,eh=!1;function is(t){const n=yo;return yo=t,n}const Ja={version:0,dirty:!1,producerNode:void 0,producerLastReadVersion:void 0,producerIndexOfThis:void 0,nextProducerIndex:0,liveConsumerNode:void 0,liveConsumerIndexOfThis:void 0,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{}};function el(t){if(!Fc(t)||t.dirty){if(!t.producerMustRecompute(t)&&!th(t))return void(t.dirty=!1);t.producerRecomputeValue(t),t.dirty=!1}}function Jp(t){t.dirty=!0,function tl(t){if(void 0===t.liveConsumerNode)return;const n=eh;eh=!0;try{for(const i of t.liveConsumerNode)i.dirty||Jp(i)}finally{eh=n}}(t),t.consumerMarkedDirty?.(t)}function Ef(t){return t&&(t.nextProducerIndex=0),is(t)}function Uu(t,n){if(is(n),t&&void 0!==t.producerNode&&void 0!==t.producerIndexOfThis&&void 0!==t.producerLastReadVersion){if(Fc(t))for(let i=t.nextProducerIndex;i<t.producerNode.length;i++)Ma(t.producerNode[i],t.producerIndexOfThis[i]);for(;t.producerNode.length>t.nextProducerIndex;)t.producerNode.pop(),t.producerLastReadVersion.pop(),t.producerIndexOfThis.pop()}}function th(t){zc(t);for(let n=0;n<t.producerNode.length;n++){const i=t.producerNode[n],a=t.producerLastReadVersion[n];if(a!==i.version||(el(i),a!==i.version))return!0}return!1}function em(t){if(zc(t),Fc(t))for(let n=0;n<t.producerNode.length;n++)Ma(t.producerNode[n],t.producerIndexOfThis[n]);t.producerNode.length=t.producerLastReadVersion.length=t.producerIndexOfThis.length=0,t.liveConsumerNode&&(t.liveConsumerNode.length=t.liveConsumerIndexOfThis.length=0)}function Ma(t,n){if(function tm(t){t.liveConsumerNode??=[],t.liveConsumerIndexOfThis??=[]}(t),zc(t),1===t.liveConsumerNode.length)for(let a=0;a<t.producerNode.length;a++)Ma(t.producerNode[a],t.producerIndexOfThis[a]);const i=t.liveConsumerNode.length-1;if(t.liveConsumerNode[n]=t.liveConsumerNode[i],t.liveConsumerIndexOfThis[n]=t.liveConsumerIndexOfThis[i],t.liveConsumerNode.length--,t.liveConsumerIndexOfThis.length--,n<t.liveConsumerNode.length){const a=t.liveConsumerIndexOfThis[n],h=t.liveConsumerNode[n];zc(h),h.producerIndexOfThis[a]=n}}function Fc(t){return t.consumerIsAlwaysLive||(t?.liveConsumerNode?.length??0)>0}function zc(t){t.producerNode??=[],t.producerIndexOfThis??=[],t.producerLastReadVersion??=[]}let Df=null;const Cf=()=>{},pv=(()=>({...Ja,consumerIsAlwaysLive:!0,consumerAllowSignalWrites:!1,consumerMarkedDirty:t=>{t.schedule(t.ref)},hasRun:!1,cleanupFn:Cf}))();class Af{constructor(n,i,a){this.previousValue=n,this.currentValue=i,this.firstChange=a}isFirstChange(){return this.firstChange}}function nm(t){return t.type.prototype.ngOnChanges&&(t.setInput=mv),Mf}function Mf(){const t=rs(this),n=t?.current;if(n){const i=t.previous;if(i===Da)t.previous=n;else for(let a in n)i[a]=n[a];t.current=null,this.ngOnChanges(n)}}function mv(t,n,i,a){const h=this.declaredInputs[i],y=rs(t)||function im(t,n){return t[e_]=n}(t,{previous:Da,current:null}),E=y.current||(y.current={}),D=y.previous,O=D[h];E[h]=new Af(O&&O.currentValue,n,D===Da),t[a]=n}const e_="__ngSimpleChanges__";function rs(t){return t[e_]||null}const ua=function(t,n,i){};function ar(t){for(;Array.isArray(t);)t=t[Lr];return t}function Tn(t,n){return ar(n[t.index])}function sh(t,n){return t.data[n]}function ys(t,n){const i=n[t];return Co(i)?i:i[Lr]}function xo(t,n){return null==n?null:t[n]}function it(t){t[Oc]=0}function _t(t){1024&t[Jn]||(t[Jn]|=1024,Wi(t,1))}function Uc(t){1024&t[Jn]&&(t[Jn]&=-1025,Wi(t,-1))}function Wi(t,n){let i=t[Cr];if(null===i)return;i[Zd]+=n;let a=i;for(i=i[Cr];null!==i&&(1===n&&1===a[Zd]||-1===n&&0===a[Zd]);)i[Zd]+=n,a=i,i=i[Cr]}const Sn={lFrame:$c(null),bindingsEnabled:!0,skipHydrationRootTNode:null};function da(){return Sn.bindingsEnabled}function It(){return Sn.lFrame.lView}function xi(){return Sn.lFrame.tView}function Mo(){let t=bo();for(;null!==t&&64===t.type;)t=t.parent;return t}function bo(){return Sn.lFrame.currentTNode}function vs(t,n){const i=Sn.lFrame;i.currentTNode=t,i.isParent=n}function bi(){return Sn.lFrame.isParent}function Yl(){return Sn.lFrame.bindingIndex++}function Kl(t,n){const i=Sn.lFrame;i.bindingIndex=i.bindingRootIndex=t,Xu(n)}function Xu(t){Sn.lFrame.currentDirectiveIndex=t}function Gc(){return Sn.lFrame.currentQueryIndex}function Ra(t){Sn.lFrame.currentQueryIndex=t}function lm(t){const n=t[Yt];return 2===n.type?n.declTNode:1===n.type?t[Io]:null}function ha(t,n,i){if(i&Un.SkipSelf){let h=n,y=t;for(;!(h=h.parent,null!==h||i&Un.Host||(h=lm(y),null===h||(y=y[ca],10&h.type))););if(null===h)return!1;n=h,t=y}const a=Sn.lFrame=uh();return a.currentTNode=n,a.lView=t,!0}function ch(t){const n=uh(),i=t[Yt];Sn.lFrame=n,n.currentTNode=i.firstChild,n.lView=t,n.tView=i,n.contextLView=t,n.bindingIndex=i.bindingStartIndex,n.inI18n=!1}function uh(){const t=Sn.lFrame,n=null===t?null:t.child;return null===n?$c(t):n}function $c(t){const n={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:t,child:null,inI18n:!1};return null!==t&&(t.child=n),n}function qc(){const t=Sn.lFrame;return Sn.lFrame=t.parent,t.currentTNode=null,t.lView=null,t}const Mi=qc;function Ql(){const t=qc();t.isParent=!0,t.tView=null,t.selectedIndex=-1,t.contextLView=null,t.elementDepthCount=0,t.currentDirectiveIndex=-1,t.currentNamespace=null,t.bindingRootIndex=-1,t.bindingIndex=-1,t.currentQueryIndex=0}function Br(){return Sn.lFrame.selectedIndex}function rl(t){Sn.lFrame.selectedIndex=t}function fr(){const t=Sn.lFrame;return sh(t.tView,t.selectedIndex)}let Wc=!0;function Ku(){return Wc}function fa(t){Wc=t}function hh(t,n){for(let i=n.directiveStart,a=n.directiveEnd;i<a;i++){const y=t.data[i].type.prototype,{ngAfterContentInit:E,ngAfterContentChecked:D,ngAfterViewInit:O,ngAfterViewChecked:N,ngOnDestroy:$}=y;E&&(t.contentHooks??=[]).push(-i,E),D&&((t.contentHooks??=[]).push(i,D),(t.contentCheckHooks??=[]).push(i,D)),O&&(t.viewHooks??=[]).push(-i,O),N&&((t.viewHooks??=[]).push(i,N),(t.viewCheckHooks??=[]).push(i,N)),null!=$&&(t.destroyHooks??=[]).push(i,$)}}function Zc(t,n,i){mm(t,n,3,i)}function ec(t,n,i,a){(3&t[Jn])===i&&mm(t,n,i,a)}function fh(t,n){let i=t[Jn];(3&i)===n&&(i&=8191,i+=1,t[Jn]=i)}function mm(t,n,i,a){const y=a??-1,E=n.length-1;let D=0;for(let O=void 0!==a?65535&t[Oc]:0;O<E;O++)if("number"==typeof n[O+1]){if(D=n[O],null!=a&&D>=a)break}else n[O]<0&&(t[Oc]+=65536),(D<y||-1==y)&&(s_(t,i,n,O),t[Oc]=(4294901760&t[Oc])+O+2),O++}function Nf(t,n){ua(4,t,n);const i=is(null);try{n.call(t)}finally{is(i),ua(5,t,n)}}function s_(t,n,i,a){const h=i[a]<0,y=i[a+1],D=t[h?-i[a]:i[a]];h?t[Jn]>>13<t[Oc]>>16&&(3&t[Jn])===n&&(t[Jn]+=8192,Nf(D,y)):Nf(D,y)}const ol=-1;class Qu{constructor(n,i,a){this.factory=n,this.resolving=!1,this.canSeeViewProviders=i,this.injectImpl=a}}function gm(t){return t!==ol}function Xc(t){return 32767&t}function sl(t,n){let i=function bv(t){return t>>16}(t),a=n;for(;i>0;)a=a[ca],i--;return a}let Yc=!0;function Ju(t){const n=Yc;return Yc=t,n}const Ns=255,ph=5;let pr=0;const ro={};function tc(t,n){const i=ym(t,n);if(-1!==i)return i;const a=n[Yt];a.firstCreatePass&&(t.injectorIndex=n.length,mh(a.data,t),mh(n,null),mh(a.blueprint,null));const h=nc(t,n),y=t.injectorIndex;if(gm(h)){const E=Xc(h),D=sl(h,n),O=D[Yt].data;for(let N=0;N<8;N++)n[y+N]=D[E+N]|O[E+N]}return n[y+8]=h,y}function mh(t,n){t.push(0,0,0,0,0,0,0,0,n)}function ym(t,n){return-1===t.injectorIndex||t.parent&&t.parent.injectorIndex===t.injectorIndex||null===n[t.injectorIndex+8]?-1:t.injectorIndex}function nc(t,n){if(t.parent&&-1!==t.parent.injectorIndex)return t.parent.injectorIndex;let i=0,a=null,h=n;for(;null!==h;){if(a=r(h),null===a)return ol;if(i++,h=h[ca],-1!==a.injectorIndex)return a.injectorIndex|i<<16}return ol}function vm(t,n,i){!function ed(t,n,i){let a;"string"==typeof i?a=i.charCodeAt(0)||0:i.hasOwnProperty(Bl)&&(a=i[Bl]),null==a&&(a=i[Bl]=pr++);const h=a&Ns;n.data[t+(h>>ph)]|=1<<h}(t,n,i)}function Vf(t,n,i){if(i&Un.Optional||void 0!==t)return t;vc()}function jf(t,n,i,a){if(i&Un.Optional&&void 0===a&&(a=null),!(i&(Un.Self|Un.Host))){const h=t[Ca],y=Et(void 0);try{return h?h.get(n,a,i&Un.Optional):Hn(n,a,i&Un.Optional)}finally{Et(y)}}return Vf(a,0,i)}function td(t,n,i,a=Un.Default,h){if(null!==t){if(2048&n[Jn]&&!(a&Un.Self)){const E=function f(t,n,i,a,h){let y=t,E=n;for(;null!==y&&null!==E&&2048&E[Jn]&&!(512&E[Jn]);){const D=Kc(y,E,i,a|Un.Self,ro);if(D!==ro)return D;let O=y.parent;if(!O){const N=E[Yd];if(N){const $=N.get(i,ro,a);if($!==ro)return $}O=r(E),E=E[ca]}y=O}return h}(t,n,i,a,ro);if(E!==ro)return E}const y=Kc(t,n,i,a,ro);if(y!==ro)return y}return jf(n,i,a,h)}function Kc(t,n,i,a,h){const y=function Uo(t){if("string"==typeof t)return t.charCodeAt(0)||0;const n=t.hasOwnProperty(Bl)?t[Bl]:void 0;return"number"==typeof n?n>=0?n&Ns:u_:n}(i);if("function"==typeof y){if(!ha(n,t,a))return a&Un.Host?Vf(h,0,a):jf(n,i,a,h);try{let E;if(E=y(a),null!=E||a&Un.Optional)return E;vc()}finally{Mi()}}else if("number"==typeof y){let E=null,D=ym(t,n),O=ol,N=a&Un.Host?n[kr][Io]:null;for((-1===D||a&Un.SkipSelf)&&(O=-1===D?nc(t,n):n[D+8],O!==ol&&c_(a,!1)?(E=n[Yt],D=Xc(O),n=sl(O,n)):D=-1);-1!==D;){const $=n[Yt];if(ws(y,D,$.data)){const J=al(D,n,i,E,a,N);if(J!==ro)return J}O=n[D+8],O!==ol&&c_(a,n[Yt].data[D+8]===N)&&ws(y,D,n)?(E=$,D=Xc(O),n=sl(O,n)):D=-1}}return h}function al(t,n,i,a,h,y){const E=n[Yt],D=E.data[t+8],$=ss(D,E,i,null==a?ql(D)&&Yc:a!=E&&0!=(3&D.type),h&Un.Host&&y===D);return null!==$?oo(n,E,$,D):ro}function ss(t,n,i,a,h){const y=t.providerIndexes,E=n.data,D=1048575&y,O=t.directiveStart,$=y>>20,we=h?D+$:t.directiveEnd;for(let ve=a?D:D+$;ve<we;ve++){const Oe=E[ve];if(ve<O&&i===Oe||ve>=O&&Oe.type===i)return ve}if(h){const ve=E[O];if(ve&&ts(ve)&&ve.type===i)return O}return null}function oo(t,n,i,a){let h=t[i];const y=n.data;if(function a_(t){return t instanceof Qu}(h)){const E=h;E.resolving&&function Rn(t,n){const i=n?`. Dependency path: ${n.join(" > ")} > ${t}`:"";throw new Pt(-200,`Circular dependency in DI detected for ${t}${i}`)}(function ki(t){return"function"==typeof t?t.name||t.toString():"object"==typeof t&&null!=t&&"function"==typeof t.type?t.type.name||t.type.toString():$n(t)}(y[i]));const D=Ju(E.canSeeViewProviders);E.resolving=!0;const N=E.injectImpl?Et(E.injectImpl):null;ha(t,a,Un.Default);try{h=t[i]=E.factory(void 0,y,t,a),n.firstCreatePass&&i>=a.directiveStart&&function pm(t,n,i){const{ngOnChanges:a,ngOnInit:h,ngDoCheck:y}=n.type.prototype;if(a){const E=nm(n);(i.preOrderHooks??=[]).push(t,E),(i.preOrderCheckHooks??=[]).push(t,E)}h&&(i.preOrderHooks??=[]).push(0-t,h),y&&((i.preOrderHooks??=[]).push(t,y),(i.preOrderCheckHooks??=[]).push(t,y))}(i,y[i],n)}finally{null!==N&&Et(N),Ju(D),E.resolving=!1,Mi()}}return h}function ws(t,n,i){return!!(i[n+(t>>ph)]&1<<t)}function c_(t,n){return!(t&Un.Self||t&Un.Host&&n)}class as{constructor(n,i){this._tNode=n,this._lView=i}get(n,i,a){return td(this._tNode,this._lView,n,Ud(a),i)}}function u_(){return new as(Mo(),It())}function r(t){const n=t[Yt],i=n.type;return 2===i?n.declTNode:1===i?t[Io]:null}function ce(t,n){t.forEach(i=>Array.isArray(i)?ce(i,n):n(i))}function ue(t,n,i){n>=t.length?t.push(i):t.splice(n,0,i)}function Me(t,n){return n>=t.length-1?t.pop():t.splice(n,1)[0]}function Se(t,n,i){let a=ze(t,n);return a>=0?t[1|a]=i:(a=~a,function Ge(t,n,i,a){let h=t.length;if(h==n)t.push(i,a);else if(1===h)t.push(a,t[0]),t[0]=i;else{for(h--,t.push(t[h-1],t[h]);h>n;)t[h]=t[h-2],h--;t[n]=i,t[n+1]=a}}(t,a,n,i)),a}function _e(t,n){const i=ze(t,n);if(i>=0)return t[1|i]}function ze(t,n){return function We(t,n,i){let a=0,h=t.length>>i;for(;h!==a;){const y=a+(h-a>>1),E=t[y<<i];if(n===E)return y<<i;E>n?h=y:a=y+1}return~(h<<i)}(t,n,1)}function d_(t){return 128==(128&t.flags)}var cl=function(t){return t[t.Important=1]="Important",t[t.DashCase=2]="DashCase",t}(cl||{});const Oa=new Map;let Jc=0;const Sm="__ngContext__";function Go(t,n){Co(n)?(t[Sm]=n[Gl],function Bx(t){Oa.set(t[Gl],t)}(n)):t[Sm]=n}let Sv;function m_(t,n){return Sv(t,n)}function Dm(t){const n=t[Cr];return Ao(n)?n[Cr]:n}function Dv(t){return Cv(t[Hl])}function Iv(t){return Cv(t[_s])}function Cv(t){for(;null!==t&&!Ao(t);)t=t[_s];return t}function _h(t,n,i,a,h){if(null!=a){let y,E=!1;Ao(a)?y=a:Co(a)&&(E=!0,a=a[Lr]);const D=ar(a);0===t&&null!==i?null==h?Yx(n,i,D):xh(n,i,D,h||null,!0):1===t&&null!==i?xh(n,i,D,h||null,!0):2===t?function rd(t,n,i){const a=Mm(t,n);a&&function Mv(t,n,i,a){t.removeChild(n,i,a)}(t,a,n,i)}(n,D,E):3===t&&n.destroyNode(D),null!=y&&function Rv(t,n,i,a,h){const y=i[Zs];y!==ar(i)&&_h(n,t,a,y,h);for(let D=io;D<i.length;D++){const O=i[D];Om(O[Yt],O,t,n,a,y)}}(n,t,y,i,h)}}function jr(t,n,i){return t.createElement(n,i)}function yh(t,n){const i=t[Lc],a=i.indexOf(n);Uc(n),i.splice(a,1)}function Am(t,n){if(t.length<=io)return;const i=io+n,a=t[i];if(a){const h=a[Rc];null!==h&&h!==t&&yh(h,a),n>0&&(t[i-1][_s]=a[_s]);const y=Me(t,io+n);!function Zx(t,n){Om(t,n,n[On],2,null,null),n[Lr]=null,n[Io]=null}(a[Yt],a);const E=y[es];null!==E&&E.detachView(y[Yt]),a[Cr]=null,a[_s]=null,a[Jn]&=-129}return a}function tu(t,n){if(!(256&n[Jn])){const i=n[On];n[Za]&&em(n[Za]),n[Nu]&&em(n[Nu]),i.destroyNode&&Om(t,n,i,3,null,null),function Ww(t){let n=t[Hl];if(!n)return vh(t[Yt],t);for(;n;){let i=null;if(Co(n))i=n[Hl];else{const a=n[io];a&&(i=a)}if(!i){for(;n&&!n[_s]&&n!==t;)Co(n)&&vh(n[Yt],n),n=n[Cr];null===n&&(n=t),Co(n)&&vh(n[Yt],n),i=n&&n[_s]}n=i}}(n)}}function vh(t,n){if(!(256&n[Jn])){n[Jn]&=-129,n[Jn]|=256,function Kw(t,n){let i;if(null!=t&&null!=(i=t.destroyHooks))for(let a=0;a<i.length;a+=2){const h=n[i[a]];if(!(h instanceof Qu)){const y=i[a+1];if(Array.isArray(y))for(let E=0;E<y.length;E+=2){const D=h[y[E]],O=y[E+1];ua(4,D,O);try{O.call(D)}finally{ua(5,D,O)}}else{ua(4,h,y);try{y.call(h)}finally{ua(5,h,y)}}}}}(t,n),function Yw(t,n){const i=t.cleanup,a=n[Ul];if(null!==i)for(let y=0;y<i.length-1;y+=2)if("string"==typeof i[y]){const E=i[y+3];E>=0?a[E]():a[-E].unsubscribe(),y+=2}else i[y].call(a[i[y+1]]);null!==a&&(n[Ul]=null);const h=n[Aa];if(null!==h){n[Aa]=null;for(let y=0;y<h.length;y++)(0,h[y])()}}(t,n),1===n[Yt].type&&n[On].destroy();const i=n[Rc];if(null!==i&&Ao(n[Cr])){i!==n[Cr]&&yh(i,n);const a=n[es];null!==a&&a.detachView(t)}!function Ev(t){Oa.delete(t[Gl])}(n)}}function Av(t,n,i){return function Xx(t,n,i){let a=n;for(;null!==a&&40&a.type;)a=(n=a).parent;if(null===a)return i[Lr];{const{componentOffset:h}=a;if(h>-1){const{encapsulation:y}=t.data[a.directiveStart+h];if(y===Vo.None||y===Vo.Emulated)return null}return Tn(a,i)}}(t,n.parent,i)}function xh(t,n,i,a,h){t.insertBefore(n,i,a,h)}function Yx(t,n,i){t.appendChild(n,i)}function Kx(t,n,i,a,h){null!==a?xh(t,n,i,a,h):Yx(t,n,i)}function Mm(t,n){return t.parentNode(n)}let __,E_,bh=function Fr(t,n,i){return 40&t.type?Tn(t,i):null};function wh(t,n,i,a){const h=Av(t,a,n),y=n[On],D=function Qx(t,n,i){return bh(t,n,i)}(a.parent||n[Io],a,n);if(null!=h)if(Array.isArray(i))for(let O=0;O<i.length;O++)Kx(y,h,i[O],D,!1);else Kx(y,h,i,D,!1);void 0!==__&&__(y,a,n,i,h)}function nu(t,n){if(null!==n){const i=n.type;if(3&i)return Tn(n,t);if(4&i)return y_(-1,t[n.index]);if(8&i){const a=n.child;if(null!==a)return nu(t,a);{const h=t[n.index];return Ao(h)?y_(-1,h):ar(h)}}if(32&i)return m_(n,t)()||ar(t[n.index]);{const a=Pv(t,n);return null!==a?Array.isArray(a)?a[0]:nu(Dm(t[kr]),a):nu(t,n.next)}}return null}function Pv(t,n){return null!==n?t[kr][Io].projection[n.projection]:null}function y_(t,n){const i=io+t+1;if(i<n.length){const a=n[i],h=a[Yt].firstChild;if(null!==h)return nu(a,h)}return n[Zs]}function Eh(t,n,i,a,h,y,E){for(;null!=i;){const D=a[i.index],O=i.type;if(E&&0===n&&(D&&Go(ar(D),a),i.flags|=2),32!=(32&i.flags))if(8&O)Eh(t,n,i.child,a,h,y,!1),_h(n,t,h,D,y);else if(32&O){const N=m_(i,a);let $;for(;$=N();)_h(n,t,h,$,y);_h(n,t,h,D,y)}else 16&O?x_(t,n,a,i,h,y):_h(n,t,h,D,y);i=E?i.projectionNext:i.next}}function Om(t,n,i,a,h,y){Eh(i,a,t.firstChild,n,h,y,!1)}function x_(t,n,i,a,h,y){const E=i[kr],O=E[Io].projection[a.projection];if(Array.isArray(O))for(let N=0;N<O.length;N++)_h(n,t,h,O[N],y);else{let N=O;const $=E[Cr];d_(a)&&(N.flags|=128),Eh(t,n,N,$,h,y,!0)}}function tb(t,n,i){""===i?t.removeAttribute(n,"class"):t.setAttribute(n,"class",i)}function Ts(t,n,i){const{mergedAttrs:a,classes:h,styles:y}=i;null!==a&&Bp(t,n,a),null!==h&&tb(t,n,h),null!==y&&function Th(t,n,i){t.setAttribute(n,"style",i)}(t,n,y)}class ul{constructor(n){this.changingThisBreaksApplicationSecurity=n}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see https://g.co/ng/security#xss)`}}const oc=new Jt("ENVIRONMENT_INITIALIZER"),$v=new Jt("INJECTOR",-1),qv=new Jt("INJECTOR_DEF_TYPES");class k_{get(n,i=Wr){if(i===Wr){const a=new Error(`NullInjectorError: No provider for ${sr(n)}!`);throw a.name="NullInjectorError",a}return i}}function dE(...t){return{\u0275providers:Wv(0,t),\u0275fromNgModule:!0}}function Wv(t,...n){const i=[],a=new Set;let h;const y=E=>{i.push(E)};return ce(n,E=>{const D=E;jm(D,y,[],a)&&(h||=[],h.push(D))}),void 0!==h&&qf(h,y),i}function qf(t,n){for(let i=0;i<t.length;i++){const{ngModule:a,providers:h}=t[i];Zv(h,y=>{n(y,a)})}}function jm(t,n,i,a){if(!(t=Fn(t)))return!1;let h=null,y=Vd(t);const E=!y&&Qn(t);if(y||E){if(E&&!E.standalone)return!1;h=t}else{const O=t.ngModule;if(y=Vd(O),!y)return!1;h=O}const D=a.has(h);if(E){if(D)return!1;if(a.add(h),E.dependencies){const O="function"==typeof E.dependencies?E.dependencies():E.dependencies;for(const N of O)jm(N,n,i,a)}}else{if(!y)return!1;{if(null!=y.imports&&!D){let N;a.add(h);try{ce(y.imports,$=>{jm($,n,i,a)&&(N||=[],N.push($))})}finally{}void 0!==N&&qf(N,n)}if(!D){const N=Ka(h)||(()=>new h);n({provide:h,useFactory:N,deps:Hi},h),n({provide:qv,useValue:h,multi:!0},h),n({provide:oc,useValue:()=>gt(h),multi:!0},h)}const O=y.providers;if(null!=O&&!D){const N=t;Zv(O,$=>{n($,N)})}}}return h!==t&&void 0!==t.providers}function Zv(t,n){for(let i of t)Do(i)&&(i=i.\u0275providers),Array.isArray(i)?Zv(i,n):n(i)}const fE=Di({provide:String,useValue:Di});function F_(t){return null!==t&&"object"==typeof t&&fE in t}function sc(t){return"function"==typeof t}const Ch=new Jt("Set Injector scope."),Xf={},N_={};let Xv;function ad(){return void 0===Xv&&(Xv=new k_),Xv}class dl{}class Ss extends dl{get destroyed(){return this._destroyed}constructor(n,i,a,h){super(),this.parent=i,this.source=a,this.scopes=h,this.records=new Map,this._ngOnDestroyHooks=new Set,this._onDestroyHooks=[],this._destroyed=!1,Kv(n,E=>this.processProvider(E)),this.records.set($v,Mh(void 0,this)),h.has("environment")&&this.records.set(dl,Mh(void 0,this));const y=this.records.get(Ch);null!=y&&"string"==typeof y.value&&this.scopes.add(y.value),this.injectorDefTypes=new Set(this.get(qv.multi,Hi,Un.Self))}destroy(){this.assertNotDestroyed(),this._destroyed=!0;try{for(const i of this._ngOnDestroyHooks)i.ngOnDestroy();const n=this._onDestroyHooks;this._onDestroyHooks=[];for(const i of n)i()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear()}}onDestroy(n){return this.assertNotDestroyed(),this._onDestroyHooks.push(n),()=>this.removeOnDestroy(n)}runInContext(n){this.assertNotDestroyed();const i=Gs(this),a=Et(void 0);try{return n()}finally{Gs(i),Et(a)}}get(n,i=Wr,a=Un.Default){if(this.assertNotDestroyed(),n.hasOwnProperty(ff))return n[ff](this);a=Ud(a);const y=Gs(this),E=Et(void 0);try{if(!(a&Un.SkipSelf)){let O=this.records.get(n);if(void 0===O){const N=function fb(t){return"function"==typeof t||"object"==typeof t&&t instanceof Jt}(n)&&Pu(n);O=N&&this.injectableDefInScope(N)?Mh(ld(n),Xf):null,this.records.set(n,O)}if(null!=O)return this.hydrate(n,O)}return(a&Un.Self?ad():this.parent).get(n,i=a&Un.Optional&&i===Wr?null:i)}catch(D){if("NullInjectorError"===D.name){if((D[po]=D[po]||[]).unshift(sr(n)),y)throw D;return function Xr(t,n,i,a){const h=t[po];throw n[Os]&&h.unshift(n[Os]),t.message=function Np(t,n,i,a=null){t=t&&"\n"===t.charAt(0)&&"\u0275"==t.charAt(1)?t.slice(2):t;let h=sr(n);if(Array.isArray(n))h=n.map(sr).join(" -> ");else if("object"==typeof n){let y=[];for(let E in n)if(n.hasOwnProperty(E)){let D=n[E];y.push(E+":"+("string"==typeof D?JSON.stringify(D):sr(D)))}h=`{${y.join(", ")}}`}return`${i}${a?"("+a+")":""}[${h}]: ${t.replace(an,"\n  ")}`}("\n"+t.message,h,i,a),t.ngTokenPath=h,t[po]=null,t}(D,n,"R3InjectorError",this.source)}throw D}finally{Et(E),Gs(y)}}resolveInjectorInitializers(){const n=Gs(this),i=Et(void 0);try{const h=this.get(oc.multi,Hi,Un.Self);for(const y of h)y()}finally{Gs(n),Et(i)}}toString(){const n=[],i=this.records;for(const a of i.keys())n.push(sr(a));return`R3Injector[${n.join(", ")}]`}assertNotDestroyed(){if(this._destroyed)throw new Pt(205,!1)}processProvider(n){let i=sc(n=Fn(n))?n:Fn(n&&n.provide);const a=function Yf(t){return F_(t)?Mh(void 0,t.useValue):Mh(function Ah(t,n,i){let a;if(sc(t)){const h=Fn(t);return Ka(h)||ld(h)}if(F_(t))a=()=>Fn(t.useValue);else if(function z_(t){return!(!t||!t.useFactory)}(t))a=()=>t.useFactory(...gs(t.deps||[]));else if(function Wf(t){return!(!t||!t.useExisting)}(t))a=()=>gt(Fn(t.useExisting));else{const h=Fn(t&&(t.useClass||t.provide));if(!function B_(t){return!!t.deps}(t))return Ka(h)||ld(h);a=()=>new h(...gs(t.deps))}return a}(t),Xf)}(n);if(sc(n)||!0!==n.multi)this.records.get(i);else{let h=this.records.get(i);h||(h=Mh(void 0,Xf,!0),h.factory=()=>gs(h.multi),this.records.set(i,h)),i=n,h.multi.push(n)}this.records.set(i,a)}hydrate(n,i){return i.value===Xf&&(i.value=N_,i.value=i.factory()),"object"==typeof i.value&&i.value&&function hb(t){return null!==t&&"object"==typeof t&&"function"==typeof t.ngOnDestroy}(i.value)&&this._ngOnDestroyHooks.add(i.value),i.value}injectableDefInScope(n){if(!n.providedIn)return!1;const i=Fn(n.providedIn);return"string"==typeof i?"any"===i||this.scopes.has(i):this.injectorDefTypes.has(i)}removeOnDestroy(n){const i=this._onDestroyHooks.indexOf(n);-1!==i&&this._onDestroyHooks.splice(i,1)}}function ld(t){const n=Pu(t),i=null!==n?n.factory:Ka(t);if(null!==i)return i;if(t instanceof Jt)throw new Pt(204,!1);if(t instanceof Function)return function Yv(t){const n=t.length;if(n>0)throw function ye(t,n){const i=[];for(let a=0;a<t;a++)i.push(n);return i}(n,"?"),new Pt(204,!1);const i=function Ou(t){return t&&(t[Ft]||t[Lu])||null}(t);return null!==i?()=>i.factory(t):()=>new t}(t);throw new Pt(204,!1)}function Mh(t,n,i=!1){return{factory:t,value:n,multi:i?[]:void 0}}function Kv(t,n){for(const i of t)Array.isArray(i)?Kv(i,n):i&&Do(i)?Kv(i.\u0275providers,n):n(i)}const Ph=new Jt("AppId",{providedIn:"root",factory:()=>pE}),pE="ng",Kf=new Jt("Platform Initializer"),cd=new Jt("Platform ID",{providedIn:"platform",factory:()=>"unknown"}),Um=new Jt("AnimationModuleType"),Qf=new Jt("CSP nonce",{providedIn:"root",factory:()=>function od(){if(void 0!==E_)return E_;if(typeof document<"u")return document;throw new Pt(210,!1)}().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});let n0=(t,n,i)=>null;function Wm(t,n,i=!1){return n0(t,n,i)}class G_{}class $_{}class xb{resolveComponentFactory(n){throw function Lh(t){const n=Error(`No component factory found for ${sr(t)}.`);return n.ngComponent=t,n}(n)}}let np=(()=>{class t{static{this.NULL=new xb}}return t})();function vE(){return ip(Mo(),It())}function ip(t,n){return new ga(Tn(t,n))}let ga=(()=>{class t{constructor(i){this.nativeElement=i}static{this.__NG_ELEMENT_ID__=vE}}return t})();function xE(t){return t instanceof ga?t.nativeElement:t}class rp{}let bE=(()=>{class t{static{this.\u0275prov=Qt({token:t,providedIn:"root",factory:()=>null})}}return t})();class op{constructor(n){this.full=n,this.major=n.split(".")[0],this.minor=n.split(".")[1],this.patch=n.split(".").slice(2).join(".")}}const wE=new op("16.2.12"),W_={};function Db(t,n=null,i=null,a){const h=Ib(t,n,i,a);return h.resolveInjectorInitializers(),h}function Ib(t,n=null,i=null,a,h=new Set){const y=[i||Hi,dE(t)];return a=a||("object"==typeof t?void 0:sr(t)),new Ss(y,n||ad(),a||null,h)}let cs=(()=>{class t{static{this.THROW_IF_NOT_FOUND=Wr}static{this.NULL=new k_}static create(i,a){if(Array.isArray(i))return Db({name:""},a,i,"");{const h=i.name??"";return Db({name:h},i.parent,i.providers,h)}}static{this.\u0275prov=Qt({token:t,providedIn:"any",factory:()=>gt($v)})}static{this.__NG_ELEMENT_ID__=-1}}return t})();function c0(t){return t.ngOriginalError}class hl{constructor(){this._console=console}handleError(n){const i=this._findOriginalError(n);this._console.error("ERROR",n),i&&this._console.error("ORIGINAL ERROR",i)}_findOriginalError(n){let i=n&&c0(n);for(;i&&c0(i);)i=c0(i);return i||null}}function Z_(t){return n=>{setTimeout(t,void 0,n)}}const ea=class Pb extends Vi{constructor(n=!1){super(),this.__isAsync=n}emit(n){super.next(n)}subscribe(n,i,a){let h=n,y=i||(()=>null),E=a;if(n&&"object"==typeof n){const O=n;h=O.next?.bind(O),y=O.error?.bind(O),E=O.complete?.bind(O)}this.__isAsync&&(y=Z_(y),h&&(h=Z_(h)),E&&(E=Z_(E)));const D=super.subscribe({next:h,error:y,complete:E});return n instanceof Ki&&n.add(D),D}};function u0(...t){}class Ei{constructor({enableLongStackTrace:n=!1,shouldCoalesceEventChangeDetection:i=!1,shouldCoalesceRunChangeDetection:a=!1}){if(this.hasPendingMacrotasks=!1,this.hasPendingMicrotasks=!1,this.isStable=!0,this.onUnstable=new ea(!1),this.onMicrotaskEmpty=new ea(!1),this.onStable=new ea(!1),this.onError=new ea(!1),typeof Zone>"u")throw new Pt(908,!1);Zone.assertZonePatched();const h=this;h._nesting=0,h._outer=h._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(h._inner=h._inner.fork(new Zone.TaskTrackingZoneSpec)),n&&Zone.longStackTraceZoneSpec&&(h._inner=h._inner.fork(Zone.longStackTraceZoneSpec)),h.shouldCoalesceEventChangeDetection=!a&&i,h.shouldCoalesceRunChangeDetection=a,h.lastRequestAnimationFrameId=-1,h.nativeRequestAnimationFrame=function Rb(){const t="function"==typeof mi.requestAnimationFrame;let n=mi[t?"requestAnimationFrame":"setTimeout"],i=mi[t?"cancelAnimationFrame":"clearTimeout"];if(typeof Zone<"u"&&n&&i){const a=n[Zone.__symbol__("OriginalDelegate")];a&&(n=a);const h=i[Zone.__symbol__("OriginalDelegate")];h&&(i=h)}return{nativeRequestAnimationFrame:n,nativeCancelAnimationFrame:i}}().nativeRequestAnimationFrame,function Lb(t){const n=()=>{!function Zm(t){t.isCheckStableRunning||-1!==t.lastRequestAnimationFrameId||(t.lastRequestAnimationFrameId=t.nativeRequestAnimationFrame.call(mi,()=>{t.fakeTopEventTask||(t.fakeTopEventTask=Zone.root.scheduleEventTask("fakeTopEventTask",()=>{t.lastRequestAnimationFrameId=-1,h0(t),t.isCheckStableRunning=!0,d0(t),t.isCheckStableRunning=!1},void 0,()=>{},()=>{})),t.fakeTopEventTask.invoke()}),h0(t))}(t)};t._inner=t._inner.fork({name:"angular",properties:{isAngularZone:!0},onInvokeTask:(i,a,h,y,E,D)=>{if(function AE(t){return!(!Array.isArray(t)||1!==t.length)&&!0===t[0].data?.__ignore_ng_zone__}(D))return i.invokeTask(h,y,E,D);try{return kb(t),i.invokeTask(h,y,E,D)}finally{(t.shouldCoalesceEventChangeDetection&&"eventTask"===y.type||t.shouldCoalesceRunChangeDetection)&&n(),Fb(t)}},onInvoke:(i,a,h,y,E,D,O)=>{try{return kb(t),i.invoke(h,y,E,D,O)}finally{t.shouldCoalesceRunChangeDetection&&n(),Fb(t)}},onHasTask:(i,a,h,y)=>{i.hasTask(h,y),a===h&&("microTask"==y.change?(t._hasPendingMicrotasks=y.microTask,h0(t),d0(t)):"macroTask"==y.change&&(t.hasPendingMacrotasks=y.macroTask))},onHandleError:(i,a,h,y)=>(i.handleError(h,y),t.runOutsideAngular(()=>t.onError.emit(y)),!1)})}(h)}static isInAngularZone(){return typeof Zone<"u"&&!0===Zone.current.get("isAngularZone")}static assertInAngularZone(){if(!Ei.isInAngularZone())throw new Pt(909,!1)}static assertNotInAngularZone(){if(Ei.isInAngularZone())throw new Pt(909,!1)}run(n,i,a){return this._inner.run(n,i,a)}runTask(n,i,a,h){const y=this._inner,E=y.scheduleEventTask("NgZoneEvent: "+h,n,Ob,u0,u0);try{return y.runTask(E,i,a)}finally{y.cancelTask(E)}}runGuarded(n,i,a){return this._inner.runGuarded(n,i,a)}runOutsideAngular(n){return this._outer.run(n)}}const Ob={};function d0(t){if(0==t._nesting&&!t.hasPendingMicrotasks&&!t.isStable)try{t._nesting++,t.onMicrotaskEmpty.emit(null)}finally{if(t._nesting--,!t.hasPendingMicrotasks)try{t.runOutsideAngular(()=>t.onStable.emit(null))}finally{t.isStable=!0}}}function h0(t){t.hasPendingMicrotasks=!!(t._hasPendingMicrotasks||(t.shouldCoalesceEventChangeDetection||t.shouldCoalesceRunChangeDetection)&&-1!==t.lastRequestAnimationFrameId)}function kb(t){t._nesting++,t.isStable&&(t.isStable=!1,t.onUnstable.emit(null))}function Fb(t){t._nesting--,d0(t)}class CE{constructor(){this.hasPendingMicrotasks=!1,this.hasPendingMacrotasks=!1,this.isStable=!0,this.onUnstable=new ea,this.onMicrotaskEmpty=new ea,this.onStable=new ea,this.onError=new ea}run(n,i,a){return n.apply(i,a)}runGuarded(n,i,a){return n.apply(i,a)}runOutsideAngular(n){return n()}runTask(n,i,a,h){return n.apply(i,a)}}const zb=new Jt("",{providedIn:"root",factory:Nb});function Nb(){const t=di(Ei);let n=!0;return $a(new qi(h=>{n=t.isStable&&!t.hasPendingMacrotasks&&!t.hasPendingMicrotasks,t.runOutsideAngular(()=>{h.next(n),h.complete()})}),new qi(h=>{let y;t.runOutsideAngular(()=>{y=t.onStable.subscribe(()=>{Ei.assertNotInAngularZone(),queueMicrotask(()=>{!n&&!t.hasPendingMacrotasks&&!t.hasPendingMicrotasks&&(n=!0,h.next(!0))})})});const E=t.onUnstable.subscribe(()=>{Ei.assertInAngularZone(),n&&(n=!1,t.runOutsideAngular(()=>{h.next(!1)}))});return()=>{y.unsubscribe(),E.unsubscribe()}}).pipe(Us()))}let Y_=(()=>{class t{constructor(){this.renderDepth=0,this.handler=null}begin(){this.handler?.validateBegin(),this.renderDepth++}end(){this.renderDepth--,0===this.renderDepth&&this.handler?.execute()}ngOnDestroy(){this.handler?.destroy(),this.handler=null}static{this.\u0275prov=Qt({token:t,providedIn:"root",factory:()=>new t})}}return t})();function fd(t){for(;t;){t[Jn]|=64;const n=Dm(t);if(Bu(t)&&!n)return t;t=n}return null}const jb=new Jt("",{providedIn:"root",factory:()=>!1});let Xm=null;function Ds(t,n){return t[n]??Ym()}function ap(t,n){const i=Ym();i.producerNode?.length&&(t[n]=Xm,i.lView=t,Xm=K_())}const lp={...Ja,consumerIsAlwaysLive:!0,consumerMarkedDirty:t=>{fd(t.lView)},lView:null};function K_(){return Object.create(lp)}function Ym(){return Xm??=K_(),Xm}const oi={};function sn(t,n=Un.Default){const i=It();return null===i?gt(t,n):td(Mo(),i,Fn(t),n)}function cp(t,n,i,a,h,y,E,D,O,N,$){const J=n.blueprint.slice();return J[Lr]=h,J[Jn]=140|a,(null!==N||t&&2048&t[Jn])&&(J[Jn]|=2048),it(J),J[Cr]=J[ca]=t,J[Ar]=i,J[qs]=E||t&&t[qs],J[On]=D||t&&t[On],J[Ca]=O||t&&t[Ca]||null,J[Io]=y,J[Gl]=function Nx(){return Jc++}(),J[Ws]=$,J[Yd]=N,J[kr]=2==n.type?t[kr]:J,J}function kh(t,n,i,a,h){let y=t.data[n];if(null===y)y=function Q_(t,n,i,a,h){const y=bo(),E=bi(),O=t.data[n]=function NE(t,n,i,a,h,y){let E=n?n.injectorIndex:-1,D=0;return function qu(){return null!==Sn.skipHydrationRootTNode}()&&(D|=128),{type:i,index:a,insertBeforeIndex:null,injectorIndex:E,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:D,providerIndexes:0,value:h,attrs:y,mergedAttrs:null,localNames:null,initialInputs:void 0,inputs:null,outputs:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:n,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}(0,E?y:y&&y.parent,i,n,a,h);return null===t.firstChild&&(t.firstChild=O),null!==y&&(E?null==y.child&&null!==O.parent&&(y.child=O):null===y.next&&(y.next=O,O.prev=y)),O}(t,n,i,a,h),function zf(){return Sn.lFrame.inI18n}()&&(y.flags|=32);else if(64&y.type){y.type=i,y.value=a,y.attrs=h;const E=function lh(){const t=Sn.lFrame,n=t.currentTNode;return t.isParent?n:n.parent}();y.injectorIndex=null===E?-1:E.injectorIndex}return vs(y,!0),y}function Km(t,n,i,a){if(0===i)return-1;const h=n.length;for(let y=0;y<i;y++)n.push(a),t.blueprint.push(a),t.data.push(null);return h}function _0(t,n,i,a,h){const y=Ds(n,Za),E=Br(),D=2&a;try{rl(-1),D&&n.length>vi&&function m0(t,n,i,a){if(!a)if(3==(3&n[Jn])){const y=t.preOrderCheckHooks;null!==y&&Zc(n,y,i)}else{const y=t.preOrderHooks;null!==y&&ec(n,y,0,i)}rl(i)}(t,n,vi,!1),ua(D?2:0,h);const N=D?y:null,$=Ef(N);try{null!==N&&(N.dirty=!1),i(a,h)}finally{Uu(N,$)}}finally{D&&null===n[Za]&&ap(n,Za),rl(E),ua(D?3:1,h)}}function J_(t,n,i){if(Xa(n)){const a=is(null);try{const y=n.directiveEnd;for(let E=n.directiveStart;E<y;E++){const D=t.data[E];D.contentQueries&&D.contentQueries(1,i[E],E)}}finally{is(a)}}}function ey(t,n,i){da()&&(function up(t,n,i,a){const h=i.directiveStart,y=i.directiveEnd;ql(i)&&function VE(t,n,i){const a=Tn(n,t),h=fl(i);let E=16;i.signals?E=4096:i.onPush&&(E=64);const D=eg(t,cp(t,h,null,E,a,n,null,t[qs].rendererFactory.createRenderer(a,i),null,null,null));t[n.index]=D}(n,i,t.data[h+i.componentOffset]),t.firstCreatePass||tc(i,n),Go(a,n);const E=i.initialInputs;for(let D=h;D<y;D++){const O=t.data[D],N=oo(n,t,D,i);Go(N,n),null!==E&&jE(0,D-h,N,O,0,E),ts(O)&&(ys(i.index,n)[Ar]=oo(n,t,D,i))}}(t,n,i,Tn(i,n)),64==(64&i.flags)&&au(t,n,i))}function ty(t,n,i=Tn){const a=n.localNames;if(null!==a){let h=n.index+1;for(let y=0;y<a.length;y+=2){const E=a[y+1],D=-1===E?i(n,t):t[E];t[h++]=D}}}function fl(t){const n=t.tView;return null===n||n.incompleteFirstPass?t.tView=ny(1,null,t.template,t.decls,t.vars,t.directiveDefs,t.pipeDefs,t.viewQuery,t.schemas,t.consts,t.id):n}function ny(t,n,i,a,h,y,E,D,O,N,$){const J=vi+a,we=J+h,ve=function y0(t,n){const i=[];for(let a=0;a<n;a++)i.push(a<t?null:oi);return i}(J,we),Oe="function"==typeof N?N():N;return ve[Yt]={type:t,blueprint:ve,template:i,queries:null,viewQuery:D,declTNode:n,data:ve.slice().fill(null,J),bindingStartIndex:J,expandoStartIndex:we,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:"function"==typeof y?y():y,pipeRegistry:"function"==typeof E?E():E,firstChild:null,schemas:O,consts:Oe,incompleteFirstPass:!1,ssrId:$}}let v0=t=>null;function Kb(t,n,i,a){for(let h in t)if(t.hasOwnProperty(h)){i=null===i?{}:i;const y=t[h];null===a?x0(i,n,h,y):a.hasOwnProperty(h)&&x0(i,n,a[h],y)}return i}function x0(t,n,i,a){t.hasOwnProperty(i)?t[i].push(n,a):t[i]=[n,a]}function ry(t,n,i,a){if(da()){const h=null===a?null:{"":-1},y=function t1(t,n){const i=t.directiveRegistry;let a=null,h=null;if(i)for(let y=0;y<i.length;y++){const E=i[y];if(Ls(n,E.selectors,!1))if(a||(a=[]),ts(E))if(null!==E.findHostDirectiveDefs){const D=[];h=h||new Map,E.findHostDirectiveDefs(E,D,h),a.unshift(...D,E),dp(t,n,D.length)}else a.unshift(E),dp(t,n,0);else h=h||new Map,E.findHostDirectiveDefs?.(E,a,h),a.push(E)}return null===a?null:[a,h]}(t,i);let E,D;null===y?E=D=null:[E,D]=y,null!==E&&w0(t,n,i,E,h,D),h&&function n1(t,n,i){if(n){const a=t.localNames=[];for(let h=0;h<n.length;h+=2){const y=i[n[h+1]];if(null==y)throw new Pt(-301,!1);a.push(n[h],y)}}}(i,a,h)}i.mergedAttrs=ku(i.mergedAttrs,i.attrs)}function w0(t,n,i,a,h,y){for(let N=0;N<a.length;N++)vm(tc(i,n),t,a[N].type);!function sy(t,n,i){t.flags|=1,t.directiveStart=n,t.directiveEnd=n+i,t.providerIndexes=n}(i,t.data.length,a.length);for(let N=0;N<a.length;N++){const $=a[N];$.providersResolver&&$.providersResolver($)}let E=!1,D=!1,O=Km(t,n,a.length,null);for(let N=0;N<a.length;N++){const $=a[N];i.mergedAttrs=ku(i.mergedAttrs,$.hostAttrs),BE(t,i,n,O,$),oy(O,$,h),null!==$.contentQueries&&(i.flags|=4),(null!==$.hostBindings||null!==$.hostAttrs||0!==$.hostVars)&&(i.flags|=64);const J=$.type.prototype;!E&&(J.ngOnChanges||J.ngOnInit||J.ngDoCheck)&&((t.preOrderHooks??=[]).push(i.index),E=!0),!D&&(J.ngOnChanges||J.ngDoCheck)&&((t.preOrderCheckHooks??=[]).push(i.index),D=!0),O++}!function Qb(t,n,i){const h=n.directiveEnd,y=t.data,E=n.attrs,D=[];let O=null,N=null;for(let $=n.directiveStart;$<h;$++){const J=y[$],we=i?i.get(J):null,Oe=we?we.outputs:null;O=Kb(J.inputs,$,O,we?we.inputs:null),N=Kb(J.outputs,$,N,Oe);const He=null===O||null===E||Up(n)?null:UE(O,$,E);D.push(He)}null!==O&&(O.hasOwnProperty("class")&&(n.flags|=8),O.hasOwnProperty("style")&&(n.flags|=16)),n.initialInputs=D,n.inputs=O,n.outputs=N}(t,i,y)}function au(t,n,i){const a=i.directiveStart,h=i.directiveEnd,y=i.index,E=function Zu(){return Sn.lFrame.currentDirectiveIndex}();try{rl(y);for(let D=a;D<h;D++){const O=t.data[D],N=n[D];Xu(D),(null!==O.hostBindings||0!==O.hostVars||null!==O.hostAttrs)&&e1(O,N)}}finally{rl(-1),Xu(E)}}function e1(t,n){null!==t.hostBindings&&t.hostBindings(1,n)}function dp(t,n,i){n.componentOffset=i,(t.components??=[]).push(n.index)}function oy(t,n,i){if(i){if(n.exportAs)for(let a=0;a<n.exportAs.length;a++)i[n.exportAs[a]]=t;ts(n)&&(i[""]=t)}}function BE(t,n,i,a,h){t.data[a]=h;const y=h.factory||(h.factory=Ka(h.type)),E=new Qu(y,ts(h),sn);t.blueprint[a]=E,i[a]=E,function pl(t,n,i,a,h){const y=h.hostBindings;if(y){let E=t.hostBindingOpCodes;null===E&&(E=t.hostBindingOpCodes=[]);const D=~n.index;(function E0(t){let n=t.length;for(;n>0;){const i=t[--n];if("number"==typeof i&&i<0)return i}return 0})(E)!=D&&E.push(D),E.push(i,a,y)}}(t,n,a,Km(t,i,h.hostVars,oi),h)}function cc(t,n,i,a,h,y){const E=Tn(t,n);!function pd(t,n,i,a,h,y,E){if(null==y)t.removeAttribute(n,h,i);else{const D=null==E?$n(y):E(y,a||"",h);t.setAttribute(n,h,D,i)}}(n[On],E,y,t.value,i,a,h)}function jE(t,n,i,a,h,y){const E=y[n];if(null!==E)for(let D=0;D<E.length;)ay(a,i,E[D++],E[D++],E[D++])}function ay(t,n,i,a,h){const y=is(null);try{const E=t.inputTransforms;null!==E&&E.hasOwnProperty(a)&&(h=E[a].call(n,h)),null!==t.setInput?t.setInput(n,h,i,a):n[a]=h}finally{is(y)}}function UE(t,n,i){let a=null,h=0;for(;h<i.length;){const y=i[h];if(0!==y)if(5!==y){if("number"==typeof y)break;if(t.hasOwnProperty(y)){null===a&&(a=[]);const E=t[y];for(let D=0;D<E.length;D+=2)if(E[D]===n){a.push(y,E[D+1],i[h+1]);break}}h+=2}else h+=2;else h+=4}return a}function T0(t,n,i,a){return[t,!0,!1,n,null,0,a,i,null,null,null]}function Jm(t,n){const i=t.contentQueries;if(null!==i)for(let a=0;a<i.length;a+=2){const y=i[a+1];if(-1!==y){const E=t.data[y];Ra(i[a]),E.contentQueries(2,n[y],y)}}}function eg(t,n){return t[Hl]?t[Xd][_s]=n:t[Hl]=n,t[Xd]=n,n}function ly(t,n,i){Ra(0);const a=is(null);try{n(t,i)}finally{is(a)}}function I0(t,n,i,a,h){for(let y=0;y<i.length;){const E=i[y++],D=i[y++];ay(t.data[E],n[E],a,D,h)}}function tg(t,n){const i=ys(n,t),a=i[Yt];!function md(t,n){for(let i=n.length;i<t.blueprint.length;i++)n.push(t.blueprint[i])}(a,i);const h=i[Lr];null!==h&&null===i[Ws]&&(i[Ws]=Wm(h,i[Ca])),uy(a,i,i[Ar])}function uy(t,n,i){ch(n);try{const a=t.viewQuery;null!==a&&ly(1,a,i);const h=t.template;null!==h&&_0(t,n,h,1,i),t.firstCreatePass&&(t.firstCreatePass=!1),t.staticContentQueries&&Jm(t,n),t.staticViewQueries&&ly(2,t.viewQuery,i);const y=t.components;null!==y&&function C0(t,n){for(let i=0;i<n.length;i++)tg(t,n[i])}(n,y)}catch(a){throw t.firstCreatePass&&(t.incompleteFirstPass=!0,t.firstCreatePass=!1),a}finally{n[Jn]&=-5,Ql()}}let ng=(()=>{class t{constructor(){this.all=new Set,this.queue=new Map}create(i,a,h){const y=typeof Zone>"u"?null:Zone.current,E=function Vt(t,n,i){const a=Object.create(pv);i&&(a.consumerAllowSignalWrites=!0),a.fn=t,a.schedule=n;const h=E=>{a.cleanupFn=E};return a.ref={notify:()=>Jp(a),run:()=>{if(a.dirty=!1,a.hasRun&&!th(a))return;a.hasRun=!0;const E=Ef(a);try{a.cleanupFn(),a.cleanupFn=Cf,a.fn(h)}finally{Uu(a,E)}},cleanup:()=>a.cleanupFn()},a.ref}(i,N=>{this.all.has(N)&&this.queue.set(N,y)},h);let D;this.all.add(E),E.notify();const O=()=>{E.cleanup(),D?.(),this.all.delete(E),this.queue.delete(E)};return D=a?.onDestroy(O),{destroy:O}}flush(){if(0!==this.queue.size)for(const[i,a]of this.queue)this.queue.delete(i),a?a.run(()=>i.run()):i.run()}get isQueueEmpty(){return 0===this.queue.size}static{this.\u0275prov=Qt({token:t,providedIn:"root",factory:()=>new t})}}return t})();function dy(t,n,i){let a=i?t.styles:null,h=i?t.classes:null,y=0;if(null!==n)for(let E=0;E<n.length;E++){const D=n[E];"number"==typeof D?y=D:1==y?h=_c(h,D):2==y&&(a=_c(a,D+": "+n[++E]+";"))}i?t.styles=a:t.stylesWithoutHost=a,i?t.classes=h:t.classesWithoutHost=h}function hp(t,n,i,a,h=!1){for(;null!==i;){const y=n[i.index];null!==y&&a.push(ar(y)),Ao(y)&&fp(y,a);const E=i.type;if(8&E)hp(t,n,i.child,a);else if(32&E){const D=m_(i,n);let O;for(;O=D();)a.push(O)}else if(16&E){const D=Pv(n,i);if(Array.isArray(D))a.push(...D);else{const O=Dm(n[kr]);hp(O[Yt],O,D,a,!0)}}i=h?i.projectionNext:i.next}return a}function fp(t,n){for(let i=io;i<t.length;i++){const a=t[i],h=a[Yt].firstChild;null!==h&&hp(a[Yt],a,h,n)}t[Zs]!==t[Lr]&&n.push(t[Zs])}function ig(t,n,i,a=!0){const h=n[qs],y=h.rendererFactory,E=h.afterRenderEventManager;y.begin?.(),E?.begin();try{o1(t,n,t.template,i)}catch(O){throw a&&function cy(t,n){const i=t[Ca],a=i?i.get(hl,null):null;a&&a.handleError(n)}(n,O),O}finally{y.end?.(),h.effectManager?.flush(),E?.end()}}function o1(t,n,i,a){const h=n[Jn];if(256!=(256&h)){n[qs].effectManager?.flush(),ch(n);try{it(n),function Ff(t){return Sn.lFrame.bindingIndex=t}(t.bindingStartIndex),null!==i&&_0(t,n,i,2,a);const E=3==(3&h);if(E){const N=t.preOrderCheckHooks;null!==N&&Zc(n,N,null)}else{const N=t.preOrderHooks;null!==N&&ec(n,N,0,null),fh(n,0)}if(function rg(t){for(let n=Dv(t);null!==n;n=Iv(n)){if(!n[qp])continue;const i=n[Lc];for(let a=0;a<i.length;a++){_t(i[a])}}}(n),pp(n,2),null!==t.contentQueries&&Jm(t,n),E){const N=t.contentCheckHooks;null!==N&&Zc(n,N)}else{const N=t.contentHooks;null!==N&&ec(n,N,1),fh(n,1)}!function Wb(t,n){const i=t.hostBindingOpCodes;if(null===i)return;const a=Ds(n,Nu);try{for(let h=0;h<i.length;h++){const y=i[h];if(y<0)rl(~y);else{const E=y,D=i[++h],O=i[++h];Kl(D,E),a.dirty=!1;const N=Ef(a);try{O(2,n[E])}finally{Uu(a,N)}}}}finally{null===n[Nu]&&ap(n,Nu),rl(-1)}}(t,n);const D=t.components;null!==D&&sg(n,D,0);const O=t.viewQuery;if(null!==O&&ly(2,O,a),E){const N=t.viewCheckHooks;null!==N&&Zc(n,N)}else{const N=t.viewHooks;null!==N&&ec(n,N,2),fh(n,2)}!0===t.firstUpdatePass&&(t.firstUpdatePass=!1),n[Jn]&=-73,Uc(n)}finally{Ql()}}}function pp(t,n){for(let i=Dv(t);null!==i;i=Iv(i))for(let a=io;a<i.length;a++)mp(i[a],n)}function og(t,n,i){mp(ys(n,t),i)}function mp(t,n){if(!function Xl(t){return 128==(128&t[Jn])}(t))return;const i=t[Yt],a=t[Jn];if(80&a&&0===n||1024&a||2===n)o1(i,t,i.template,t[Ar]);else if(t[Zd]>0){pp(t,1);const h=i.components;null!==h&&sg(t,h,1)}}function sg(t,n,i){for(let a=0;a<n.length;a++)og(t,n[a],i)}class ag{get rootNodes(){const n=this._lView,i=n[Yt];return hp(i,n,i.firstChild,[])}constructor(n,i){this._lView=n,this._cdRefInjectingView=i,this._appRef=null,this._attachedToViewContainer=!1}get context(){return this._lView[Ar]}set context(n){this._lView[Ar]=n}get destroyed(){return 256==(256&this._lView[Jn])}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){const n=this._lView[Cr];if(Ao(n)){const i=n[8],a=i?i.indexOf(this):-1;a>-1&&(Am(n,a),Me(i,a))}this._attachedToViewContainer=!1}tu(this._lView[Yt],this._lView)}onDestroy(n){!function De(t,n){if(256==(256&t[Jn]))throw new Pt(911,!1);null===t[Aa]&&(t[Aa]=[]),t[Aa].push(n)}(this._lView,n)}markForCheck(){fd(this._cdRefInjectingView||this._lView)}detach(){this._lView[Jn]&=-129}reattach(){this._lView[Jn]|=128}detectChanges(){ig(this._lView[Yt],this._lView,this.context)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new Pt(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null,function qw(t,n){Om(t,n,n[On],2,null,null)}(this._lView[Yt],this._lView)}attachToAppRef(n){if(this._attachedToViewContainer)throw new Pt(902,!1);this._appRef=n}}class HE extends ag{constructor(n){super(n),this._view=n}detectChanges(){const n=this._view;ig(n[Yt],n,n[Ar],!1)}checkNoChanges(){}get context(){return null}}class zh extends np{constructor(n){super(),this.ngModule=n}resolveComponentFactory(n){const i=Qn(n);return new gp(i,this.ngModule)}}function lg(t){const n=[];for(let i in t)t.hasOwnProperty(i)&&n.push({propName:t[i],templateName:i});return n}class s1{constructor(n,i){this.injector=n,this.parentInjector=i}get(n,i,a){a=Ud(a);const h=this.injector.get(n,W_,a);return h!==W_||i===W_?h:this.parentInjector.get(n,i,a)}}class gp extends $_{get inputs(){const n=this.componentDef,i=n.inputTransforms,a=lg(n.inputs);if(null!==i)for(const h of a)i.hasOwnProperty(h.propName)&&(h.transform=i[h.propName]);return a}get outputs(){return lg(this.componentDef.outputs)}constructor(n,i){super(),this.componentDef=n,this.ngModule=i,this.componentType=n.type,this.selector=function gf(t){return t.map(ks).join(",")}(n.selectors),this.ngContentSelectors=n.ngContentSelectors?n.ngContentSelectors:[],this.isBoundToModule=!!i}create(n,i,a,h){let y=(h=h||this.ngModule)instanceof dl?h:h?.injector;y&&null!==this.componentDef.getStandaloneInjector&&(y=this.componentDef.getStandaloneInjector(y)||y);const E=y?new s1(n,y):n,D=E.get(rp,null);if(null===D)throw new Pt(407,!1);const J={rendererFactory:D,sanitizer:E.get(bE,null),effectManager:E.get(ng,null),afterRenderEventManager:E.get(Y_,null)},we=D.createRenderer(null,this.componentDef),ve=this.componentDef.selectors[0][0]||"div",Oe=a?function Qm(t,n,i,a){const y=a.get(jb,!1)||i===Vo.ShadowDom,E=t.selectRootElement(n,y);return function su(t){v0(t)}(E),E}(we,a,this.componentDef.encapsulation,E):jr(we,ve,function GE(t){const n=t.toLowerCase();return"svg"===n?"svg":"math"===n?"math":null}(ve)),Mt=this.componentDef.signals?4608:this.componentDef.onPush?576:528;let dt=null;null!==Oe&&(dt=Wm(Oe,E,!0));const rn=ny(0,null,null,1,0,null,null,null,null,null,null),gn=cp(null,rn,null,Mt,null,null,J,we,E,null,dt);let _i,Ur;ch(gn);try{const Hr=this.componentDef;let na,Tl=null;Hr.findHostDirectiveDefs?(na=[],Tl=new Map,Hr.findHostDirectiveDefs(Hr,na,Tl),na.push(Hr)):na=[Hr];const vu=function a1(t,n){const i=t[Yt],a=vi;return t[a]=n,kh(i,a,2,"#host",null)}(gn,Oe),Vw=function qE(t,n,i,a,h,y,E){const D=h[Yt];!function l1(t,n,i,a){for(const h of t)n.mergedAttrs=ku(n.mergedAttrs,h.hostAttrs);null!==n.mergedAttrs&&(dy(n,n.mergedAttrs,!0),null!==i&&Ts(a,i,n))}(a,t,n,E);let O=null;null!==n&&(O=Wm(n,h[Ca]));const N=y.rendererFactory.createRenderer(n,i);let $=16;i.signals?$=4096:i.onPush&&($=64);const J=cp(h,fl(i),null,$,h[t.index],t,y,N,null,null,O);return D.firstCreatePass&&dp(D,t,a.length-1),eg(h,J),h[t.index]=J}(vu,Oe,Hr,na,gn,J,we);Ur=sh(rn,vi),Oe&&function c1(t,n,i,a){if(a)Bp(t,i,["ng-version",wE.full]);else{const{attrs:h,classes:y}=function ht(t){const n=[],i=[];let a=1,h=2;for(;a<t.length;){let y=t[a];if("string"==typeof y)2===h?""!==y&&n.push(y,t[++a]):8===h&&i.push(y);else{if(!go(h))break;h=y}a++}return{attrs:n,classes:i}}(n.selectors[0]);h&&Bp(t,i,h),y&&y.length>0&&tb(t,i,y.join(" "))}}(we,Hr,Oe,a),void 0!==i&&function ZE(t,n,i){const a=t.projection=[];for(let h=0;h<n.length;h++){const y=i[h];a.push(null!=y?Array.from(y):null)}}(Ur,this.ngContentSelectors,i),_i=function WE(t,n,i,a,h,y){const E=Mo(),D=h[Yt],O=Tn(E,h);w0(D,h,E,i,null,a);for(let $=0;$<i.length;$++)Go(oo(h,D,E.directiveStart+$,E),h);au(D,h,E),O&&Go(O,h);const N=oo(h,D,E.directiveStart+E.componentOffset,E);if(t[Ar]=h[Ar]=N,null!==y)for(const $ of y)$(N,n);return J_(D,E,t),N}(Vw,Hr,na,Tl,gn,[XE]),uy(rn,gn,null)}finally{Ql()}return new $E(this.componentType,_i,ip(Ur,gn),gn,Ur)}}class $E extends G_{constructor(n,i,a,h,y){super(),this.location=a,this._rootLView=h,this._tNode=y,this.previousInputValues=null,this.instance=i,this.hostView=this.changeDetectorRef=new HE(h),this.componentType=n}setInput(n,i){const a=this._tNode.inputs;let h;if(null!==a&&(h=a[n])){if(this.previousInputValues??=new Map,this.previousInputValues.has(n)&&Object.is(this.previousInputValues.get(n),i))return;const y=this._rootLView;I0(y[Yt],y,h,n,i),this.previousInputValues.set(n,i),fd(ys(this._tNode.index,y))}}get injector(){return new as(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(n){this.hostView.onDestroy(n)}}function XE(){const t=Mo();hh(It()[Yt],t)}function cu(t){let n=function cg(t){return Object.getPrototypeOf(t.prototype).constructor}(t.type),i=!0;const a=[t];for(;n;){let h;if(ts(t))h=n.\u0275cmp||n.\u0275dir;else{if(n.\u0275cmp)throw new Pt(903,!1);h=n.\u0275dir}if(h){if(i){a.push(h);const E=t;E.inputs=Nh(t.inputs),E.inputTransforms=Nh(t.inputTransforms),E.declaredInputs=Nh(t.declaredInputs),E.outputs=Nh(t.outputs);const D=h.hostBindings;D&&M0(t,D);const O=h.viewQuery,N=h.contentQueries;if(O&&fy(t,O),N&&YE(t,N),Ll(t.inputs,h.inputs),Ll(t.declaredInputs,h.declaredInputs),Ll(t.outputs,h.outputs),null!==h.inputTransforms&&(null===E.inputTransforms&&(E.inputTransforms={}),Ll(E.inputTransforms,h.inputTransforms)),ts(h)&&h.data.animation){const $=t.data;$.animation=($.animation||[]).concat(h.data.animation)}}const y=h.features;if(y)for(let E=0;E<y.length;E++){const D=y[E];D&&D.ngInherit&&D(t),D===cu&&(i=!1)}}n=Object.getPrototypeOf(n)}!function hy(t){let n=0,i=null;for(let a=t.length-1;a>=0;a--){const h=t[a];h.hostVars=n+=h.hostVars,h.hostAttrs=ku(h.hostAttrs,i=ku(i,h.hostAttrs))}}(a)}function Nh(t){return t===Da?{}:t===Hi?[]:t}function fy(t,n){const i=t.viewQuery;t.viewQuery=i?(a,h)=>{n(a,h),i(a,h)}:n}function YE(t,n){const i=t.contentQueries;t.contentQueries=i?(a,h,y)=>{n(a,h,y),i(a,h,y)}:n}function M0(t,n){const i=t.hostBindings;t.hostBindings=i?(a,h)=>{n(a,h),i(a,h)}:n}function ds(t,n,i){return!Object.is(t[n],i)&&(t[n]=i,!0)}function fg(t,n,i,a){const h=It();return ds(h,Yl(),n)&&(xi(),cc(fr(),h,t,n,i,a)),fg}function W0(t,n,i,a,h,y,E,D){const O=It(),N=xi(),$=t+vi,J=N.firstCreatePass?function sT(t,n,i,a,h,y,E,D,O){const N=n.consts,$=kh(n,t,4,E||null,xo(N,D));ry(n,i,$,xo(N,O)),hh(n,$);const J=$.tView=ny(2,$,a,h,y,n.directiveRegistry,n.pipeRegistry,null,n.schemas,N,null);return null!==n.queries&&(n.queries.template(n,$),J.queries=n.queries.embeddedTView($)),$}($,N,O,n,i,a,h,y,E):N.data[$];vs(J,!1);const we=y1(N,O,J,t);Ku()&&wh(N,O,we,J),Go(we,O),eg(O,O[$]=T0(we,O,we,J)),Ya(J)&&ey(N,O,J),null!=E&&ty(O,J,D)}let y1=function $h(t,n,i,a){return fa(!0),n[On].createComment("")};function Py(t,n,i,a,h){const E=h?"class":"style";I0(t,i,n.inputs[E],E,a)}function qh(t,n,i,a){const h=It(),y=xi(),E=vi+t,D=h[On],O=y.firstCreatePass?function x1(t,n,i,a,h,y){const E=n.consts,O=kh(n,t,2,a,xo(E,h));return ry(n,i,O,xo(E,y)),null!==O.attrs&&dy(O,O.attrs,!1),null!==O.mergedAttrs&&dy(O,O.mergedAttrs,!0),null!==n.queries&&n.queries.elementStart(n,O),O}(E,y,h,n,i,a):y.data[E],N=Y0(y,h,O,D,n,t);h[E]=N;const $=Ya(O);return vs(O,!0),Ts(D,N,O),32!=(32&O.flags)&&Ku()&&wh(y,h,N,O),0===function rm(){return Sn.lFrame.elementDepthCount}()&&Go(N,h),function Lf(){Sn.lFrame.elementDepthCount++}(),$&&(ey(y,h,O),J_(y,O,h)),null!==a&&ty(h,O),qh}function Wh(){let t=Mo();bi()?function En(){Sn.lFrame.isParent=!1}():(t=t.parent,vs(t,!1));const n=t;(function om(t){return Sn.skipHydrationRootTNode===t})(n)&&function r_(){Sn.skipHydrationRootTNode=null}(),function $u(){Sn.lFrame.elementDepthCount--}();const i=xi();return i.firstCreatePass&&(hh(i,t),Xa(t)&&i.queries.elementEnd(t)),null!=n.classesWithoutHost&&function yv(t){return 0!=(8&t.flags)}(n)&&Py(i,n,It(),n.classesWithoutHost,!0),null!=n.stylesWithoutHost&&function vv(t){return 0!=(16&t.flags)}(n)&&Py(i,n,It(),n.stylesWithoutHost,!1),Wh}function Zh(t,n,i,a){return qh(t,n,i,a),Wh(),Zh}let Y0=(t,n,i,a,h,y)=>(fa(!0),jr(a,h,function dh(){return Sn.lFrame.currentNamespace}()));function Ly(t){return!!t&&"function"==typeof t.then}function Q0(t){return!!t&&"function"==typeof t.subscribe}function yg(t,n){return t<<17|n<<2}function fu(t){return t>>17&32767}function ky(t){return 2|t}function bd(t){return(131068&t)>>2}function tx(t,n){return-131069&t|n<<2}function Fy(t){return 1|t}function nx(t,n,i,a,h){const y=t[i+1],E=null===n;let D=a?fu(y):bd(y),O=!1;for(;0!==D&&(!1===O||E);){const $=t[D+1];mT(t[D],n)&&(O=!0,t[D+1]=a?Fy($):ky($)),D=a?fu($):bd($)}O&&(t[i+1]=a?ky(y):Fy(y))}function mT(t,n){return null===t||null==n||(Array.isArray(t)?t[1]:t)===n||!(!Array.isArray(t)||"string"!=typeof n)&&ze(t,n)>=0}function By(t,n){return function ka(t,n,i,a){const h=It(),y=xi(),E=function Xs(t){const n=Sn.lFrame,i=n.bindingIndex;return n.bindingIndex=n.bindingIndex+t,i}(2);y.firstUpdatePass&&function Vy(t,n,i,a){const h=t.data;if(null===h[i+1]){const y=h[Br()],E=function ax(t,n){return n>=t.expandoStartIndex}(t,i);(function T(t,n){return 0!=(t.flags&(n?8:16))})(y,a)&&null===n&&!E&&(n=!1),n=function lx(t,n,i,a){const h=function Yu(t){const n=Sn.lFrame.currentDirectiveIndex;return-1===n?null:t[n]}(t);let y=a?n.residualClasses:n.residualStyles;if(null===h)0===(a?n.classBindings:n.styleBindings)&&(i=s(i=jy(null,t,n,i,a),n.attrs,a),y=null);else{const E=n.directiveStylingLast;if(-1===E||t[E]!==h)if(i=jy(h,t,n,i,a),null===y){let O=function B1(t,n,i){const a=i?n.classBindings:n.styleBindings;if(0!==bd(a))return t[fu(a)]}(t,n,a);void 0!==O&&Array.isArray(O)&&(O=jy(null,t,n,O[1],a),O=s(O,n.attrs,a),function wg(t,n,i,a){t[fu(i?n.classBindings:n.styleBindings)]=a}(t,n,a,O))}else y=function cx(t,n,i){let a;const h=n.directiveEnd;for(let y=1+n.directiveStylingLast;y<h;y++)a=s(a,t[y].hostAttrs,i);return s(a,n.attrs,i)}(t,n,a)}return void 0!==y&&(a?n.residualClasses=y:n.residualStyles=y),i}(h,y,n,a),function xg(t,n,i,a,h,y){let E=y?n.classBindings:n.styleBindings,D=fu(E),O=bd(E);t[a]=i;let $,N=!1;if(Array.isArray(i)?($=i[1],(null===$||ze(i,$)>0)&&(N=!0)):$=i,h)if(0!==O){const we=fu(t[D+1]);t[a+1]=yg(we,D),0!==we&&(t[we+1]=tx(t[we+1],a)),t[D+1]=function k1(t,n){return 131071&t|n<<17}(t[D+1],a)}else t[a+1]=yg(D,0),0!==D&&(t[D+1]=tx(t[D+1],a)),D=a;else t[a+1]=yg(O,0),0===D?D=a:t[O+1]=tx(t[O+1],a),O=a;N&&(t[a+1]=ky(t[a+1])),nx(t,$,a,!0),nx(t,$,a,!1),function bg(t,n,i,a,h){const y=h?t.residualClasses:t.residualStyles;null!=y&&"string"==typeof n&&ze(y,n)>=0&&(i[a+1]=Fy(i[a+1]))}(n,$,t,a,y),E=yg(D,O),y?n.classBindings=E:n.styleBindings=E}(h,y,n,i,E,a)}}(y,t,E,a),n!==oi&&ds(h,E,n)&&function m(t,n,i,a,h,y,E,D){if(!(3&n.type))return;const O=t.data,N=O[D+1],$=function pT(t){return 1==(1&t)}(N)?g(O,n,i,h,bd(N),E):void 0;x($)||(x(y)||function fT(t){return 2==(2&t)}(N)&&(y=g(O,null,i,h,D,E)),function eb(t,n,i,a,h){if(n)h?t.addClass(i,a):t.removeClass(i,a);else{let y=-1===a.indexOf("-")?void 0:cl.DashCase;null==h?t.removeStyle(i,a,y):("string"==typeof h&&h.endsWith("!important")&&(h=h.slice(0,-10),y|=cl.Important),t.setStyle(i,a,h,y))}}(a,E,function zs(t,n){return ar(n[t])}(Br(),i),h,y))}(y,y.data[Br()],h,h[On],t,h[E+1]=function w(t,n){return null==t||""===t||("string"==typeof n?t+=n:"object"==typeof t&&(t=sr(function sd(t){return t instanceof ul?t.changingThisBreaksApplicationSecurity:t}(t)))),t}(n,i),a,E)}(t,n,null,!0),By}function jy(t,n,i,a,h){let y=null;const E=i.directiveEnd;let D=i.directiveStylingLast;for(-1===D?D=i.directiveStart:D++;D<E&&(y=n[D],a=s(a,y.hostAttrs,h),y!==t);)D++;return null!==t&&(i.directiveStylingLast=D),a}function s(t,n,i){const a=i?1:2;let h=-1;if(null!==n)for(let y=0;y<n.length;y++){const E=n[y];"number"==typeof E?h=E:h===a&&(Array.isArray(t)||(t=void 0===t?[]:["",t]),Se(t,E,!!i||n[++y]))}return void 0===t?null:t}function g(t,n,i,a,h,y){const E=null===n;let D;for(;h>0;){const O=t[h],N=Array.isArray(O),$=N?O[1]:O,J=null===$;let we=i[h+1];we===oi&&(we=J?Hi:void 0);let ve=J?_e(we,a):$===a?we:void 0;if(N&&!x(ve)&&(ve=_e(O,a)),x(ve)&&(D=ve,E))return D;const Oe=t[h+1];h=E?fu(Oe):bd(Oe)}if(null!==n){let O=y?n.residualClasses:n.residualStyles;null!=O&&(D=_e(O,a))}return D}function x(t){return void 0!==t}let A=(t,n,i,a,h)=>(fa(!0),function Im(t,n){return t.createText(n)}(n[On],a));function vn(t,n,i){const a=It();return ds(a,Yl(),n)&&function us(t,n,i,a,h,y,E,D){const O=Tn(n,i);let $,N=n.inputs;!D&&null!=N&&($=N[a])?(I0(t,i,$,a,h),ql(n)&&function b0(t,n){const i=ys(n,t);16&i[Jn]||(i[Jn]|=64)}(i,n.index)):3&n.type&&(a=function Fh(t){return"class"===t?"className":"for"===t?"htmlFor":"formaction"===t?"formAction":"innerHtml"===t?"innerHTML":"readonly"===t?"readOnly":"tabindex"===t?"tabIndex":t}(a),h=null!=E?E(h,n.value||"",a):h,y.setProperty(O,a,h))}(xi(),fr(),a,t,n,a[On],i,!0),vn}const en="en-US";let hi=en;class Eg{}class q2{}class IT extends Eg{constructor(n,i,a){super(),this._parent=i,this._bootstrapComponents=[],this.destroyCbs=[],this.componentFactoryResolver=new zh(this);const h=function Fs(t,n){const i=t[Mc]||null;if(!i&&!0===n)throw new Error(`Type ${sr(t)} does not have '\u0275mod' property.`);return i}(n);this._bootstrapComponents=function ru(t){return t instanceof Function?t():t}(h.bootstrap),this._r3Injector=Ib(n,i,[{provide:Eg,useValue:this},{provide:np,useValue:this.componentFactoryResolver},...a],sr(n),new Set(["environment"])),this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(n)}get injector(){return this._r3Injector}destroy(){const n=this._r3Injector;!n.destroyed&&n.destroy(),this.destroyCbs.forEach(i=>i()),this.destroyCbs=null}onDestroy(n){this.destroyCbs.push(n)}}class CT extends q2{constructor(n){super(),this.moduleType=n}create(n){return new IT(this.moduleType,n,[])}}function EP(){return this._results[Symbol.iterator]()}class px{get changes(){return this._changes||(this._changes=new ea)}constructor(n=!1){this._emitDistinctChangesOnly=n,this.dirty=!0,this._results=[],this._changesDetected=!1,this._changes=null,this.length=0,this.first=void 0,this.last=void 0;const i=px.prototype;i[Symbol.iterator]||(i[Symbol.iterator]=EP)}get(n){return this._results[n]}map(n){return this._results.map(n)}filter(n){return this._results.filter(n)}find(n){return this._results.find(n)}reduce(n,i){return this._results.reduce(n,i)}forEach(n){this._results.forEach(n)}some(n){return this._results.some(n)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(n,i){const a=this;a.dirty=!1;const h=function ae(t){return t.flat(Number.POSITIVE_INFINITY)}(n);(this._changesDetected=!function pe(t,n,i){if(t.length!==n.length)return!1;for(let a=0;a<t.length;a++){let h=t[a],y=n[a];if(i&&(h=i(h),y=i(y)),y!==h)return!1}return!0}(a._results,h,i))&&(a._results=h,a.length=h.length,a.last=h[this.length-1],a.first=h[0])}notifyOnChanges(){this._changes&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.emit(this)}setDirty(){this.dirty=!0}destroy(){this.changes.complete(),this.changes.unsubscribe()}}function SP(t,n,i,a=!0){const h=n[Yt];if(function Zw(t,n,i,a){const h=io+a,y=i.length;a>0&&(i[h-1][_s]=n),a<y-io?(n[_s]=i[h],ue(i,io+a,n)):(i.push(n),n[_s]=null),n[Cr]=i;const E=n[Rc];null!==E&&i!==E&&function Xw(t,n){const i=t[Lc];n[kr]!==n[Cr][Cr][kr]&&(t[qp]=!0),null===i?t[Lc]=[n]:i.push(n)}(E,n);const D=n[es];null!==D&&D.insertView(t),n[Jn]|=128}(h,n,t,i),a){const y=y_(i,t),E=n[On],D=Mm(E,t[Zs]);null!==D&&function Cm(t,n,i,a,h,y){a[Lr]=h,a[Io]=n,Om(t,a,i,1,h,y)}(h,t[Io],E,n,D,y)}}let wd=(()=>{class t{static{this.__NG_ELEMENT_ID__=CP}}return t})();const DP=wd,IP=class extends DP{constructor(n,i,a){super(),this._declarationLView=n,this._declarationTContainer=i,this.elementRef=a}get ssrId(){return this._declarationTContainer.tView?.ssrId||null}createEmbeddedView(n,i){return this.createEmbeddedViewImpl(n,i)}createEmbeddedViewImpl(n,i,a){const h=function TP(t,n,i,a){const h=n.tView,D=cp(t,h,i,4096&t[Jn]?4096:16,null,n,null,null,null,a?.injector??null,a?.hydrationInfo??null);D[Rc]=t[n.index];const N=t[es];return null!==N&&(D[es]=N.createEmbeddedView(h)),uy(h,D,i),D}(this._declarationLView,this._declarationTContainer,n,{injector:i,hydrationInfo:a});return new ag(h)}};function CP(){return $1(Mo(),It())}function $1(t,n){return 4&t.type?new IP(n,t,ip(t,n)):null}let mu=(()=>{class t{static{this.__NG_ELEMENT_ID__=LP}}return t})();function LP(){return xI(Mo(),It())}const kP=mu,yI=class extends kP{constructor(n,i,a){super(),this._lContainer=n,this._hostTNode=i,this._hostLView=a}get element(){return ip(this._hostTNode,this._hostLView)}get injector(){return new as(this._hostTNode,this._hostLView)}get parentInjector(){const n=nc(this._hostTNode,this._hostLView);if(gm(n)){const i=sl(n,this._hostLView),a=Xc(n);return new as(i[Yt].data[a+8],i)}return new as(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(n){const i=vI(this._lContainer);return null!==i&&i[n]||null}get length(){return this._lContainer.length-io}createEmbeddedView(n,i,a){let h,y;"number"==typeof a?h=a:null!=a&&(h=a.index,y=a.injector);const D=n.createEmbeddedViewImpl(i||{},y,null);return this.insertImpl(D,h,false),D}createComponent(n,i,a,h,y){const E=n&&!function de(t){return"function"==typeof t}(n);let D;if(E)D=i;else{const He=i||{};D=He.index,a=He.injector,h=He.projectableNodes,y=He.environmentInjector||He.ngModuleRef}const O=E?n:new gp(Qn(n)),N=a||this.parentInjector;if(!y&&null==O.ngModule){const mt=(E?N:this.parentInjector).get(dl,null);mt&&(y=mt)}Qn(O.componentType??{});const ve=O.create(N,h,null,y);return this.insertImpl(ve.hostView,D,false),ve}insert(n,i){return this.insertImpl(n,i,!1)}insertImpl(n,i,a){const h=n._lView;if(function jc(t){return Ao(t[Cr])}(h)){const O=this.indexOf(n);if(-1!==O)this.detach(O);else{const N=h[Cr],$=new yI(N,N[Io],N[Cr]);$.detach($.indexOf(n))}}const E=this._adjustIndex(i),D=this._lContainer;return SP(D,h,E,!a),n.attachToViewContainerRef(),ue(MT(D),E,n),n}move(n,i){return this.insert(n,i)}indexOf(n){const i=vI(this._lContainer);return null!==i?i.indexOf(n):-1}remove(n){const i=this._adjustIndex(n,-1),a=Am(this._lContainer,i);a&&(Me(MT(this._lContainer),i),tu(a[Yt],a))}detach(n){const i=this._adjustIndex(n,-1),a=Am(this._lContainer,i);return a&&null!=Me(MT(this._lContainer),i)?new ag(a):null}_adjustIndex(n,i=0){return n??this.length+i}};function vI(t){return t[8]}function MT(t){return t[8]||(t[8]=[])}function xI(t,n){let i;const a=n[t.index];return Ao(a)?i=a:(i=T0(a,n,null,t),n[t.index]=i,eg(n,i)),bI(i,n,t,a),new yI(i,t,n)}let bI=function wI(t,n,i,a){if(t[Zs])return;let h;h=8&i.type?ar(a):function FP(t,n){const i=t[On],a=i.createComment(""),h=Tn(n,t);return xh(i,Mm(i,h),a,function Pm(t,n){return t.nextSibling(n)}(i,h),!1),a}(n,i),t[Zs]=h};class PT{constructor(n){this.queryList=n,this.matches=null}clone(){return new PT(this.queryList)}setDirty(){this.queryList.setDirty()}}class RT{constructor(n=[]){this.queries=n}createEmbeddedView(n){const i=n.queries;if(null!==i){const a=null!==n.contentQueries?n.contentQueries[0]:i.length,h=[];for(let y=0;y<a;y++){const E=i.getByIndex(y);h.push(this.queries[E.indexInDeclarationView].clone())}return new RT(h)}return null}insertView(n){this.dirtyQueriesWithMatches(n)}detachView(n){this.dirtyQueriesWithMatches(n)}dirtyQueriesWithMatches(n){for(let i=0;i<this.queries.length;i++)null!==MI(n,i).matches&&this.queries[i].setDirty()}}class EI{constructor(n,i,a=null){this.predicate=n,this.flags=i,this.read=a}}class OT{constructor(n=[]){this.queries=n}elementStart(n,i){for(let a=0;a<this.queries.length;a++)this.queries[a].elementStart(n,i)}elementEnd(n){for(let i=0;i<this.queries.length;i++)this.queries[i].elementEnd(n)}embeddedTView(n){let i=null;for(let a=0;a<this.length;a++){const h=null!==i?i.length:0,y=this.getByIndex(a).embeddedTView(n,h);y&&(y.indexInDeclarationView=a,null!==i?i.push(y):i=[y])}return null!==i?new OT(i):null}template(n,i){for(let a=0;a<this.queries.length;a++)this.queries[a].template(n,i)}getByIndex(n){return this.queries[n]}get length(){return this.queries.length}track(n){this.queries.push(n)}}class LT{constructor(n,i=-1){this.metadata=n,this.matches=null,this.indexInDeclarationView=-1,this.crossesNgTemplate=!1,this._appliesToNextNode=!0,this._declarationNodeIndex=i}elementStart(n,i){this.isApplyingToNode(i)&&this.matchTNode(n,i)}elementEnd(n){this._declarationNodeIndex===n.index&&(this._appliesToNextNode=!1)}template(n,i){this.elementStart(n,i)}embeddedTView(n,i){return this.isApplyingToNode(n)?(this.crossesNgTemplate=!0,this.addMatch(-n.index,i),new LT(this.metadata)):null}isApplyingToNode(n){if(this._appliesToNextNode&&1!=(1&this.metadata.flags)){const i=this._declarationNodeIndex;let a=n.parent;for(;null!==a&&8&a.type&&a.index!==i;)a=a.parent;return i===(null!==a?a.index:-1)}return this._appliesToNextNode}matchTNode(n,i){const a=this.metadata.predicate;if(Array.isArray(a))for(let h=0;h<a.length;h++){const y=a[h];this.matchTNodeWithReadOption(n,i,BP(i,y)),this.matchTNodeWithReadOption(n,i,ss(i,n,y,!1,!1))}else a===wd?4&i.type&&this.matchTNodeWithReadOption(n,i,-1):this.matchTNodeWithReadOption(n,i,ss(i,n,a,!1,!1))}matchTNodeWithReadOption(n,i,a){if(null!==a){const h=this.metadata.read;if(null!==h)if(h===ga||h===mu||h===wd&&4&i.type)this.addMatch(i.index,-2);else{const y=ss(i,n,h,!1,!1);null!==y&&this.addMatch(i.index,y)}else this.addMatch(i.index,a)}}addMatch(n,i){null===this.matches?this.matches=[n,i]:this.matches.push(n,i)}}function BP(t,n){const i=t.localNames;if(null!==i)for(let a=0;a<i.length;a+=2)if(i[a]===n)return i[a+1];return null}function jP(t,n,i,a){return-1===i?function VP(t,n){return 11&t.type?ip(t,n):4&t.type?$1(t,n):null}(n,t):-2===i?function UP(t,n,i){return i===ga?ip(n,t):i===wd?$1(n,t):i===mu?xI(n,t):void 0}(t,n,a):oo(t,t[Yt],i,n)}function TI(t,n,i,a){const h=n[es].queries[a];if(null===h.matches){const y=t.data,E=i.matches,D=[];for(let O=0;O<E.length;O+=2){const N=E[O];D.push(N<0?null:jP(n,y[N],E[O+1],i.metadata.read))}h.matches=D}return h.matches}function kT(t,n,i,a){const h=t.queries.getByIndex(i),y=h.matches;if(null!==y){const E=TI(t,n,h,i);for(let D=0;D<y.length;D+=2){const O=y[D];if(O>0)a.push(E[D/2]);else{const N=y[D+1],$=n[-O];for(let J=io;J<$.length;J++){const we=$[J];we[Rc]===we[Cr]&&kT(we[Yt],we,N,a)}if(null!==$[Lc]){const J=$[Lc];for(let we=0;we<J.length;we++){const ve=J[we];kT(ve[Yt],ve,N,a)}}}}}return a}function SI(t){const n=It(),i=xi(),a=Gc();Ra(a+1);const h=MI(i,a);if(t.dirty&&function t_(t){return 4==(4&t[Jn])}(n)===(2==(2&h.metadata.flags))){if(null===h.matches)t.reset([]);else{const y=h.crossesNgTemplate?kT(i,n,a,[]):TI(i,n,h,a);t.reset(y,xE),t.notifyOnChanges()}return!0}return!1}function DI(t,n,i){const a=xi();a.firstCreatePass&&(function AI(t,n,i){null===t.queries&&(t.queries=new OT),t.queries.track(new LT(n,i))}(a,new EI(t,n,i),-1),2==(2&n)&&(a.staticViewQueries=!0)),function CI(t,n,i){const a=new px(4==(4&i));(function Yb(t,n,i,a){const h=function S0(t){return t[Ul]||(t[Ul]=[])}(n);h.push(i),t.firstCreatePass&&function r1(t){return t.cleanup||(t.cleanup=[])}(t).push(a,h.length-1)})(t,n,a,a.destroy),null===n[es]&&(n[es]=new RT),n[es].queries.push(new PT(a))}(a,It(),n)}function MI(t,n){return t.queries.getByIndex(n)}const fR=new Jt("Application Initializer");let VT=(()=>{class t{constructor(){this.initialized=!1,this.done=!1,this.donePromise=new Promise((i,a)=>{this.resolve=i,this.reject=a}),this.appInits=di(fR,{optional:!0})??[]}runInitializers(){if(this.initialized)return;const i=[];for(const h of this.appInits){const y=h();if(Ly(y))i.push(y);else if(Q0(y)){const E=new Promise((D,O)=>{y.subscribe({complete:D,error:O})});i.push(E)}}const a=()=>{this.done=!0,this.resolve()};Promise.all(i).then(()=>{a()}).catch(h=>{this.reject(h)}),0===i.length&&a(),this.initialized=!0}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();const Ed=new Jt("LocaleId",{providedIn:"root",factory:()=>di(Ed,Un.Optional|Un.SkipSelf)||function mR(){return typeof $localize<"u"&&$localize.locale||en}()});let yR=(()=>{class t{constructor(){this.taskId=0,this.pendingTasks=new Set,this.hasPendingTasks=new Du(!1)}add(){this.hasPendingTasks.next(!0);const i=this.taskId++;return this.pendingTasks.add(i),i}remove(i){this.pendingTasks.delete(i),0===this.pendingTasks.size&&this.hasPendingTasks.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks.next(!1)}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();const KI=new Jt(""),X1=new Jt("");let $T,HT=(()=>{class t{constructor(i,a,h){this._ngZone=i,this.registry=a,this._pendingCount=0,this._isZoneStable=!0,this._didWork=!1,this._callbacks=[],this.taskTrackingZone=null,$T||(function jR(t){$T=t}(h),h.addToWindow(a)),this._watchAngularEvents(),i.run(()=>{this.taskTrackingZone=typeof Zone>"u"?null:Zone.current.get("TaskTrackingZone")})}_watchAngularEvents(){this._ngZone.onUnstable.subscribe({next:()=>{this._didWork=!0,this._isZoneStable=!1}}),this._ngZone.runOutsideAngular(()=>{this._ngZone.onStable.subscribe({next:()=>{Ei.assertNotInAngularZone(),queueMicrotask(()=>{this._isZoneStable=!0,this._runCallbacksIfReady()})}})})}increasePendingRequestCount(){return this._pendingCount+=1,this._didWork=!0,this._pendingCount}decreasePendingRequestCount(){if(this._pendingCount-=1,this._pendingCount<0)throw new Error("pending async requests below zero");return this._runCallbacksIfReady(),this._pendingCount}isStable(){return this._isZoneStable&&0===this._pendingCount&&!this._ngZone.hasPendingMacrotasks}_runCallbacksIfReady(){if(this.isStable())queueMicrotask(()=>{for(;0!==this._callbacks.length;){let i=this._callbacks.pop();clearTimeout(i.timeoutId),i.doneCb(this._didWork)}this._didWork=!1});else{let i=this.getPendingTasks();this._callbacks=this._callbacks.filter(a=>!a.updateCb||!a.updateCb(i)||(clearTimeout(a.timeoutId),!1)),this._didWork=!0}}getPendingTasks(){return this.taskTrackingZone?this.taskTrackingZone.macroTasks.map(i=>({source:i.source,creationLocation:i.creationLocation,data:i.data})):[]}addCallback(i,a,h){let y=-1;a&&a>0&&(y=setTimeout(()=>{this._callbacks=this._callbacks.filter(E=>E.timeoutId!==y),i(this._didWork,this.getPendingTasks())},a)),this._callbacks.push({doneCb:i,timeoutId:y,updateCb:h})}whenStable(i,a,h){if(h&&!this.taskTrackingZone)throw new Error('Task tracking zone is required when passing an update callback to whenStable(). Is "zone.js/plugins/task-tracking" loaded?');this.addCallback(i,a,h),this._runCallbacksIfReady()}getPendingRequestCount(){return this._pendingCount}registerApplication(i){this.registry.registerApplication(i,this)}unregisterApplication(i){this.registry.unregisterApplication(i)}findProviders(i,a,h){return[]}static{this.\u0275fac=function(a){return new(a||t)(gt(Ei),gt(GT),gt(X1))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})(),GT=(()=>{class t{constructor(){this._applications=new Map}registerApplication(i,a){this._applications.set(i,a)}unregisterApplication(i){this._applications.delete(i)}unregisterAllApplications(){this._applications.clear()}getTestability(i){return this._applications.get(i)||null}getAllTestabilities(){return Array.from(this._applications.values())}getAllRootElements(){return Array.from(this._applications.keys())}findTestabilityInTree(i,a=!0){return $T?.findTestabilityInTree(this,i,a)??null}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"platform"})}}return t})(),Sp=null;const QI=new Jt("AllowMultipleToken"),qT=new Jt("PlatformDestroyListeners"),JI=new Jt("appBootstrapListener");function nC(t,n,i=[]){const a=`Platform: ${n}`,h=new Jt(a);return(y=[])=>{let E=WT();if(!E||E.injector.get(QI,!1)){const D=[...i,...y,{provide:h,useValue:!0}];t?t(D):function GR(t){if(Sp&&!Sp.get(QI,!1))throw new Pt(400,!1);(function eC(){!function nh(t){Df=t}(()=>{throw new Pt(600,!1)})})(),Sp=t;const n=t.get(rC);(function tC(t){t.get(Kf,null)?.forEach(i=>i())})(t)}(function iC(t=[],n){return cs.create({name:n,providers:[{provide:Ch,useValue:"platform"},{provide:qT,useValue:new Set([()=>Sp=null])},...t]})}(D,a))}return function qR(t){const n=WT();if(!n)throw new Pt(401,!1);return n}()}}function WT(){return Sp?.get(rC)??null}let rC=(()=>{class t{constructor(i){this._injector=i,this._modules=[],this._destroyListeners=[],this._destroyed=!1}bootstrapModuleFactory(i,a){const h=function WR(t="zone.js",n){return"noop"===t?new CE:"zone.js"===t?new Ei(n):t}(a?.ngZone,function oC(t){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:t?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:t?.runCoalescing??!1}}({eventCoalescing:a?.ngZoneEventCoalescing,runCoalescing:a?.ngZoneRunCoalescing}));return h.run(()=>{const y=function Z2(t,n,i){return new IT(t,n,i)}(i.moduleType,this.injector,function uC(t){return[{provide:Ei,useFactory:t},{provide:oc,multi:!0,useFactory:()=>{const n=di(XR,{optional:!0});return()=>n.initialize()}},{provide:cC,useFactory:ZR},{provide:zb,useFactory:Nb}]}(()=>h)),E=y.injector.get(hl,null);return h.runOutsideAngular(()=>{const D=h.onError.subscribe({next:O=>{E.handleError(O)}});y.onDestroy(()=>{Y1(this._modules,y),D.unsubscribe()})}),function sC(t,n,i){try{const a=i();return Ly(a)?a.catch(h=>{throw n.runOutsideAngular(()=>t.handleError(h)),h}):a}catch(a){throw n.runOutsideAngular(()=>t.handleError(a)),a}}(E,h,()=>{const D=y.injector.get(VT);return D.runInitializers(),D.donePromise.then(()=>(function gi(t){qr(t,"Expected localeId to be defined"),"string"==typeof t&&(hi=t.toLowerCase().replace(/_/g,"-"))}(y.injector.get(Ed,en)||en),this._moduleDoBootstrap(y),y))})})}bootstrapModule(i,a=[]){const h=aC({},a);return function UR(t,n,i){const a=new CT(i);return Promise.resolve(a)}(0,0,i).then(y=>this.bootstrapModuleFactory(y,h))}_moduleDoBootstrap(i){const a=i.injector.get(Tg);if(i._bootstrapComponents.length>0)i._bootstrapComponents.forEach(h=>a.bootstrap(h));else{if(!i.instance.ngDoBootstrap)throw new Pt(-403,!1);i.instance.ngDoBootstrap(a)}this._modules.push(i)}onDestroy(i){this._destroyListeners.push(i)}get injector(){return this._injector}destroy(){if(this._destroyed)throw new Pt(404,!1);this._modules.slice().forEach(a=>a.destroy()),this._destroyListeners.forEach(a=>a());const i=this._injector.get(qT,null);i&&(i.forEach(a=>a()),i.clear()),this._destroyed=!0}get destroyed(){return this._destroyed}static{this.\u0275fac=function(a){return new(a||t)(gt(cs))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"platform"})}}return t})();function aC(t,n){return Array.isArray(n)?n.reduce(aC,t):{...t,...n}}let Tg=(()=>{class t{constructor(){this._bootstrapListeners=[],this._runningTick=!1,this._destroyed=!1,this._destroyListeners=[],this._views=[],this.internalErrorHandler=di(cC),this.zoneIsStable=di(zb),this.componentTypes=[],this.components=[],this.isStable=di(yR).hasPendingTasks.pipe(function Hs(t,n){return yi((i,a)=>{let h=null,y=0,E=!1;const D=()=>E&&!h&&a.complete();i.subscribe(er(a,O=>{h?.unsubscribe();let N=0;const $=y++;Ae(t(O,$)).subscribe(h=er(a,J=>a.next(n?n(O,J,$,N++):J),()=>{h=null,D()}))},()=>{E=!0,D()}))})}(i=>i?gc(!1):this.zoneIsStable),Sa(),Us()),this._injector=di(dl)}get destroyed(){return this._destroyed}get injector(){return this._injector}bootstrap(i,a){const h=i instanceof $_;if(!this._injector.get(VT).done)throw!h&&function Pc(t){const n=Qn(t)||tn(t)||Jo(t);return null!==n&&n.standalone}(i),new Pt(405,!1);let E;E=h?i:this._injector.get(np).resolveComponentFactory(i),this.componentTypes.push(E.componentType);const D=function HR(t){return t.isBoundToModule}(E)?void 0:this._injector.get(Eg),N=E.create(cs.NULL,[],a||E.selector,D),$=N.location.nativeElement,J=N.injector.get(KI,null);return J?.registerApplication($),N.onDestroy(()=>{this.detachView(N.hostView),Y1(this.components,N),J?.unregisterApplication($)}),this._loadComponent(N),N}tick(){if(this._runningTick)throw new Pt(101,!1);try{this._runningTick=!0;for(let i of this._views)i.detectChanges()}catch(i){this.internalErrorHandler(i)}finally{this._runningTick=!1}}attachView(i){const a=i;this._views.push(a),a.attachToAppRef(this)}detachView(i){const a=i;Y1(this._views,a),a.detachFromAppRef()}_loadComponent(i){this.attachView(i.hostView),this.tick(),this.components.push(i);const a=this._injector.get(JI,[]);a.push(...this._bootstrapListeners),a.forEach(h=>h(i))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(i=>i()),this._views.slice().forEach(i=>i.destroy())}finally{this._destroyed=!0,this._views=[],this._bootstrapListeners=[],this._destroyListeners=[]}}onDestroy(i){return this._destroyListeners.push(i),()=>Y1(this._destroyListeners,i)}destroy(){if(this._destroyed)throw new Pt(406,!1);const i=this._injector;i.destroy&&!i.destroyed&&i.destroy()}get viewCount(){return this._views.length}warnIfDestroyed(){}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();function Y1(t,n){const i=t.indexOf(n);i>-1&&t.splice(i,1)}const cC=new Jt("",{providedIn:"root",factory:()=>di(hl).handleError.bind(void 0)});function ZR(){const t=di(Ei),n=di(hl);return i=>t.runOutsideAngular(()=>n.handleError(i))}let XR=(()=>{class t{constructor(){this.zone=di(Ei),this.applicationRef=di(Tg)}initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.zone.run(()=>{this.applicationRef.tick()})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();const dO=nC(null,"core",[]);let hO=(()=>{class t{constructor(i){}static{this.\u0275fac=function(a){return new(a||t)(gt(Tg))}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({})}}return t})(),JT=null;function Gy(){return JT}class SO{}const br=new Jt("DocumentToken");let AC=(()=>{class t{historyGo(i){throw new Error("Not implemented")}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:function(){return di(DO)},providedIn:"platform"})}}return t})(),DO=(()=>{class t extends AC{constructor(){super(),this._doc=di(br),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return Gy().getBaseHref(this._doc)}onPopState(i){const a=Gy().getGlobalEventTarget(this._doc,"window");return a.addEventListener("popstate",i,!1),()=>a.removeEventListener("popstate",i)}onHashChange(i){const a=Gy().getGlobalEventTarget(this._doc,"window");return a.addEventListener("hashchange",i,!1),()=>a.removeEventListener("hashchange",i)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(i){this._location.pathname=i}pushState(i,a,h){this._history.pushState(i,a,h)}replaceState(i,a,h){this._history.replaceState(i,a,h)}forward(){this._history.forward()}back(){this._history.back()}historyGo(i=0){this._history.go(i)}getState(){return this._history.state}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:function(){return new t},providedIn:"platform"})}}return t})();function MC(t,n){if(0==t.length)return n;if(0==n.length)return t;let i=0;return t.endsWith("/")&&i++,n.startsWith("/")&&i++,2==i?t+n.substring(1):1==i?t+n:t+"/"+n}function PC(t){const n=t.match(/#|\?|$/),i=n&&n.index||t.length;return t.slice(0,i-("/"===t[i-1]?1:0))+t.slice(i)}function Dg(t){return t&&"?"!==t[0]?"?"+t:t}let eS=(()=>{class t{historyGo(i){throw new Error("Not implemented")}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:function(){return di(CO)},providedIn:"root"})}}return t})();const IO=new Jt("appBaseHref");let CO=(()=>{class t extends eS{constructor(i,a){super(),this._platformLocation=i,this._removeListenerFns=[],this._baseHref=a??this._platformLocation.getBaseHrefFromDOM()??di(br).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(i){this._removeListenerFns.push(this._platformLocation.onPopState(i),this._platformLocation.onHashChange(i))}getBaseHref(){return this._baseHref}prepareExternalUrl(i){return MC(this._baseHref,i)}path(i=!1){const a=this._platformLocation.pathname+Dg(this._platformLocation.search),h=this._platformLocation.hash;return h&&i?`${a}${h}`:a}pushState(i,a,h,y){const E=this.prepareExternalUrl(h+Dg(y));this._platformLocation.pushState(i,a,E)}replaceState(i,a,h,y){const E=this.prepareExternalUrl(h+Dg(y));this._platformLocation.replaceState(i,a,E)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(i=0){this._platformLocation.historyGo?.(i)}static{this.\u0275fac=function(a){return new(a||t)(gt(AC),gt(IO,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),tS=(()=>{class t{constructor(i){this._subject=new ea,this._urlChangeListeners=[],this._urlChangeSubscription=null,this._locationStrategy=i;const a=this._locationStrategy.getBaseHref();this._basePath=function PO(t){if(new RegExp("^(https?:)?//").test(t)){const[,i]=t.split(/\/\/[^\/]+/);return i}return t}(PC(RC(a))),this._locationStrategy.onPopState(h=>{this._subject.emit({url:this.path(!0),pop:!0,state:h.state,type:h.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(i=!1){return this.normalize(this._locationStrategy.path(i))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(i,a=""){return this.path()==this.normalize(i+Dg(a))}normalize(i){return t.stripTrailingSlash(function MO(t,n){if(!t||!n.startsWith(t))return n;const i=n.substring(t.length);return""===i||["/",";","?","#"].includes(i[0])?i:n}(this._basePath,RC(i)))}prepareExternalUrl(i){return i&&"/"!==i[0]&&(i="/"+i),this._locationStrategy.prepareExternalUrl(i)}go(i,a="",h=null){this._locationStrategy.pushState(h,"",i,a),this._notifyUrlChangeListeners(this.prepareExternalUrl(i+Dg(a)),h)}replaceState(i,a="",h=null){this._locationStrategy.replaceState(h,"",i,a),this._notifyUrlChangeListeners(this.prepareExternalUrl(i+Dg(a)),h)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(i=0){this._locationStrategy.historyGo?.(i)}onUrlChange(i){return this._urlChangeListeners.push(i),this._urlChangeSubscription||(this._urlChangeSubscription=this.subscribe(a=>{this._notifyUrlChangeListeners(a.url,a.state)})),()=>{const a=this._urlChangeListeners.indexOf(i);this._urlChangeListeners.splice(a,1),0===this._urlChangeListeners.length&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(i="",a){this._urlChangeListeners.forEach(h=>h(i,a))}subscribe(i,a,h){return this._subject.subscribe({next:i,error:a,complete:h})}static{this.normalizeQueryParams=Dg}static{this.joinWithSlash=MC}static{this.stripTrailingSlash=PC}static{this.\u0275fac=function(a){return new(a||t)(gt(eS))}}static{this.\u0275prov=Qt({token:t,factory:function(){return function AO(){return new tS(gt(eS))}()},providedIn:"root"})}}return t})();function RC(t){return t.replace(/\/index.html$/,"")}let qL=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({})}}return t})();const WC="browser";function ZC(t){return"server"===t}class bk extends SO{constructor(){super(...arguments),this.supportsDOMEvents=!0}}class yS extends bk{static makeCurrent(){!function TO(t){JT||(JT=t)}(new yS)}onAndCancel(n,i,a){return n.addEventListener(i,a),()=>{n.removeEventListener(i,a)}}dispatchEvent(n,i){n.dispatchEvent(i)}remove(n){n.parentNode&&n.parentNode.removeChild(n)}createElement(n,i){return(i=i||this.getDefaultDocument()).createElement(n)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(n){return n.nodeType===Node.ELEMENT_NODE}isShadowRoot(n){return n instanceof DocumentFragment}getGlobalEventTarget(n,i){return"window"===i?window:"document"===i?n:"body"===i?n.body:null}getBaseHref(n){const i=function wk(){return bx=bx||document.querySelector("base"),bx?bx.getAttribute("href"):null}();return null==i?null:function Ek(t){fw=fw||document.createElement("a"),fw.setAttribute("href",t);const n=fw.pathname;return"/"===n.charAt(0)?n:`/${n}`}(i)}resetBaseElement(){bx=null}getUserAgent(){return window.navigator.userAgent}getCookie(n){return function mL(t,n){n=encodeURIComponent(n);for(const i of t.split(";")){const a=i.indexOf("="),[h,y]=-1==a?[i,""]:[i.slice(0,a),i.slice(a+1)];if(h.trim()===n)return decodeURIComponent(y)}return null}(document.cookie,n)}}let fw,bx=null,Sk=(()=>{class t{build(){return new XMLHttpRequest}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();const vS=new Jt("EventManagerPlugins");let JC=(()=>{class t{constructor(i,a){this._zone=a,this._eventNameToPlugin=new Map,i.forEach(h=>{h.manager=this}),this._plugins=i.slice().reverse()}addEventListener(i,a,h){return this._findPluginFor(a).addEventListener(i,a,h)}getZone(){return this._zone}_findPluginFor(i){let a=this._eventNameToPlugin.get(i);if(a)return a;if(a=this._plugins.find(y=>y.supports(i)),!a)throw new Pt(5101,!1);return this._eventNameToPlugin.set(i,a),a}static{this.\u0275fac=function(a){return new(a||t)(gt(vS),gt(Ei))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();class eA{constructor(n){this._doc=n}}const xS="ng-app-id";let tA=(()=>{class t{constructor(i,a,h,y={}){this.doc=i,this.appId=a,this.nonce=h,this.platformId=y,this.styleRef=new Map,this.hostNodes=new Set,this.styleNodesInDOM=this.collectServerRenderedStyles(),this.platformIsServer=ZC(y),this.resetHostNodes()}addStyles(i){for(const a of i)1===this.changeUsageCount(a,1)&&this.onStyleAdded(a)}removeStyles(i){for(const a of i)this.changeUsageCount(a,-1)<=0&&this.onStyleRemoved(a)}ngOnDestroy(){const i=this.styleNodesInDOM;i&&(i.forEach(a=>a.remove()),i.clear());for(const a of this.getAllStyles())this.onStyleRemoved(a);this.resetHostNodes()}addHost(i){this.hostNodes.add(i);for(const a of this.getAllStyles())this.addStyleToHost(i,a)}removeHost(i){this.hostNodes.delete(i)}getAllStyles(){return this.styleRef.keys()}onStyleAdded(i){for(const a of this.hostNodes)this.addStyleToHost(a,i)}onStyleRemoved(i){const a=this.styleRef;a.get(i)?.elements?.forEach(h=>h.remove()),a.delete(i)}collectServerRenderedStyles(){const i=this.doc.head?.querySelectorAll(`style[${xS}="${this.appId}"]`);if(i?.length){const a=new Map;return i.forEach(h=>{null!=h.textContent&&a.set(h.textContent,h)}),a}return null}changeUsageCount(i,a){const h=this.styleRef;if(h.has(i)){const y=h.get(i);return y.usage+=a,y.usage}return h.set(i,{usage:a,elements:[]}),a}getStyleElement(i,a){const h=this.styleNodesInDOM,y=h?.get(a);if(y?.parentNode===i)return h.delete(a),y.removeAttribute(xS),y;{const E=this.doc.createElement("style");return this.nonce&&E.setAttribute("nonce",this.nonce),E.textContent=a,this.platformIsServer&&E.setAttribute(xS,this.appId),E}}addStyleToHost(i,a){const h=this.getStyleElement(i,a);i.appendChild(h);const y=this.styleRef,E=y.get(a)?.elements;E?E.push(h):y.set(a,{elements:[h],usage:1})}resetHostNodes(){const i=this.hostNodes;i.clear(),i.add(this.doc.head)}static{this.\u0275fac=function(a){return new(a||t)(gt(br),gt(Ph),gt(Qf,8),gt(cd))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();const bS={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/MathML/"},wS=/%COMP%/g,Ak=new Jt("RemoveStylesOnCompDestroy",{providedIn:"root",factory:()=>!1});function iA(t,n){return n.map(i=>i.replace(wS,t))}let ES=(()=>{class t{constructor(i,a,h,y,E,D,O,N=null){this.eventManager=i,this.sharedStylesHost=a,this.appId=h,this.removeStylesOnCompDestroy=y,this.doc=E,this.platformId=D,this.ngZone=O,this.nonce=N,this.rendererByCompId=new Map,this.platformIsServer=ZC(D),this.defaultRenderer=new TS(i,E,O,this.platformIsServer)}createRenderer(i,a){if(!i||!a)return this.defaultRenderer;this.platformIsServer&&a.encapsulation===Vo.ShadowDom&&(a={...a,encapsulation:Vo.Emulated});const h=this.getOrCreateRenderer(i,a);return h instanceof oA?h.applyToHost(i):h instanceof SS&&h.applyStyles(),h}getOrCreateRenderer(i,a){const h=this.rendererByCompId;let y=h.get(a.id);if(!y){const E=this.doc,D=this.ngZone,O=this.eventManager,N=this.sharedStylesHost,$=this.removeStylesOnCompDestroy,J=this.platformIsServer;switch(a.encapsulation){case Vo.Emulated:y=new oA(O,N,a,this.appId,$,E,D,J);break;case Vo.ShadowDom:return new Ok(O,N,i,a,E,D,this.nonce,J);default:y=new SS(O,N,a,$,E,D,J)}h.set(a.id,y)}return y}ngOnDestroy(){this.rendererByCompId.clear()}static{this.\u0275fac=function(a){return new(a||t)(gt(JC),gt(tA),gt(Ph),gt(Ak),gt(br),gt(cd),gt(Ei),gt(Qf))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();class TS{constructor(n,i,a,h){this.eventManager=n,this.doc=i,this.ngZone=a,this.platformIsServer=h,this.data=Object.create(null),this.destroyNode=null}destroy(){}createElement(n,i){return i?this.doc.createElementNS(bS[i]||i,n):this.doc.createElement(n)}createComment(n){return this.doc.createComment(n)}createText(n){return this.doc.createTextNode(n)}appendChild(n,i){(rA(n)?n.content:n).appendChild(i)}insertBefore(n,i,a){n&&(rA(n)?n.content:n).insertBefore(i,a)}removeChild(n,i){n&&n.removeChild(i)}selectRootElement(n,i){let a="string"==typeof n?this.doc.querySelector(n):n;if(!a)throw new Pt(-5104,!1);return i||(a.textContent=""),a}parentNode(n){return n.parentNode}nextSibling(n){return n.nextSibling}setAttribute(n,i,a,h){if(h){i=h+":"+i;const y=bS[h];y?n.setAttributeNS(y,i,a):n.setAttribute(i,a)}else n.setAttribute(i,a)}removeAttribute(n,i,a){if(a){const h=bS[a];h?n.removeAttributeNS(h,i):n.removeAttribute(`${a}:${i}`)}else n.removeAttribute(i)}addClass(n,i){n.classList.add(i)}removeClass(n,i){n.classList.remove(i)}setStyle(n,i,a,h){h&(cl.DashCase|cl.Important)?n.style.setProperty(i,a,h&cl.Important?"important":""):n.style[i]=a}removeStyle(n,i,a){a&cl.DashCase?n.style.removeProperty(i):n.style[i]=""}setProperty(n,i,a){n[i]=a}setValue(n,i){n.nodeValue=i}listen(n,i,a){if("string"==typeof n&&!(n=Gy().getGlobalEventTarget(this.doc,n)))throw new Error(`Unsupported event target ${n} for event ${i}`);return this.eventManager.addEventListener(n,i,this.decoratePreventDefault(a))}decoratePreventDefault(n){return i=>{if("__ngUnwrap__"===i)return n;!1===(this.platformIsServer?this.ngZone.runGuarded(()=>n(i)):n(i))&&i.preventDefault()}}}function rA(t){return"TEMPLATE"===t.tagName&&void 0!==t.content}class Ok extends TS{constructor(n,i,a,h,y,E,D,O){super(n,y,E,O),this.sharedStylesHost=i,this.hostEl=a,this.shadowRoot=a.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);const N=iA(h.id,h.styles);for(const $ of N){const J=document.createElement("style");D&&J.setAttribute("nonce",D),J.textContent=$,this.shadowRoot.appendChild(J)}}nodeOrShadowRoot(n){return n===this.hostEl?this.shadowRoot:n}appendChild(n,i){return super.appendChild(this.nodeOrShadowRoot(n),i)}insertBefore(n,i,a){return super.insertBefore(this.nodeOrShadowRoot(n),i,a)}removeChild(n,i){return super.removeChild(this.nodeOrShadowRoot(n),i)}parentNode(n){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(n)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}}class SS extends TS{constructor(n,i,a,h,y,E,D,O){super(n,y,E,D),this.sharedStylesHost=i,this.removeStylesOnCompDestroy=h,this.styles=O?iA(O,a.styles):a.styles}applyStyles(){this.sharedStylesHost.addStyles(this.styles)}destroy(){this.removeStylesOnCompDestroy&&this.sharedStylesHost.removeStyles(this.styles)}}class oA extends SS{constructor(n,i,a,h,y,E,D,O){const N=h+"-"+a.id;super(n,i,a,y,E,D,O,N),this.contentAttr=function Mk(t){return"_ngcontent-%COMP%".replace(wS,t)}(N),this.hostAttr=function Pk(t){return"_nghost-%COMP%".replace(wS,t)}(N)}applyToHost(n){this.applyStyles(),this.setAttribute(n,this.hostAttr,"")}createElement(n,i){const a=super.createElement(n,i);return super.setAttribute(a,this.contentAttr,""),a}}let Lk=(()=>{class t extends eA{constructor(i){super(i)}supports(i){return!0}addEventListener(i,a,h){return i.addEventListener(a,h,!1),()=>this.removeEventListener(i,a,h)}removeEventListener(i,a,h){return i.removeEventListener(a,h)}static{this.\u0275fac=function(a){return new(a||t)(gt(br))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();const sA=["alt","control","meta","shift"],kk={"\b":"Backspace","\t":"Tab","\x7f":"Delete","\x1b":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},Fk={alt:t=>t.altKey,control:t=>t.ctrlKey,meta:t=>t.metaKey,shift:t=>t.shiftKey};let zk=(()=>{class t extends eA{constructor(i){super(i)}supports(i){return null!=t.parseEventName(i)}addEventListener(i,a,h){const y=t.parseEventName(a),E=t.eventCallback(y.fullKey,h,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>Gy().onAndCancel(i,y.domEventName,E))}static parseEventName(i){const a=i.toLowerCase().split("."),h=a.shift();if(0===a.length||"keydown"!==h&&"keyup"!==h)return null;const y=t._normalizeKey(a.pop());let E="",D=a.indexOf("code");if(D>-1&&(a.splice(D,1),E="code."),sA.forEach(N=>{const $=a.indexOf(N);$>-1&&(a.splice($,1),E+=N+".")}),E+=y,0!=a.length||0===y.length)return null;const O={};return O.domEventName=h,O.fullKey=E,O}static matchEventFullKeyCode(i,a){let h=kk[i.key]||i.key,y="";return a.indexOf("code.")>-1&&(h=i.code,y="code."),!(null==h||!h)&&(h=h.toLowerCase()," "===h?h="space":"."===h&&(h="dot"),sA.forEach(E=>{E!==h&&(0,Fk[E])(i)&&(y+=E+".")}),y+=h,y===a)}static eventCallback(i,a,h){return y=>{t.matchEventFullKeyCode(y,i)&&h.runGuarded(()=>a(y))}}static _normalizeKey(i){return"esc"===i?"escape":i}static{this.\u0275fac=function(a){return new(a||t)(gt(br))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();const jk=nC(dO,"browser",[{provide:cd,useValue:WC},{provide:Kf,useValue:function Nk(){yS.makeCurrent()},multi:!0},{provide:br,useFactory:function Vk(){return function Lv(t){E_=t}(document),document},deps:[]}]),Uk=new Jt(""),cA=[{provide:X1,useClass:class Tk{addToWindow(n){mi.getAngularTestability=(a,h=!0)=>{const y=n.findTestabilityInTree(a,h);if(null==y)throw new Pt(5103,!1);return y},mi.getAllAngularTestabilities=()=>n.getAllTestabilities(),mi.getAllAngularRootElements=()=>n.getAllRootElements(),mi.frameworkStabilizers||(mi.frameworkStabilizers=[]),mi.frameworkStabilizers.push(a=>{const h=mi.getAllAngularTestabilities();let y=h.length,E=!1;const D=function(O){E=E||O,y--,0==y&&a(E)};h.forEach(O=>{O.whenStable(D)})})}findTestabilityInTree(n,i,a){return null==i?null:n.getTestability(i)??(a?Gy().isShadowRoot(i)?this.findTestabilityInTree(n,i.host,!0):this.findTestabilityInTree(n,i.parentElement,!0):null)}},deps:[]},{provide:KI,useClass:HT,deps:[Ei,GT,X1]},{provide:HT,useClass:HT,deps:[Ei,GT,X1]}],uA=[{provide:Ch,useValue:"root"},{provide:hl,useFactory:function Bk(){return new hl},deps:[]},{provide:vS,useClass:Lk,multi:!0,deps:[br,Ei,cd]},{provide:vS,useClass:zk,multi:!0,deps:[br]},ES,tA,JC,{provide:rp,useExisting:ES},{provide:class QL{},useClass:Sk,deps:[]},[]];let dA=(()=>{class t{constructor(i){}static withServerTransition(i){return{ngModule:t,providers:[{provide:Ph,useValue:i.appId}]}}static{this.\u0275fac=function(a){return new(a||t)(gt(Uk,12))}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({providers:[...uA,...cA],imports:[qL,hO]})}}return t})();typeof window<"u"&&window;class mA{}class Xk{}const Kh="*";function yA(t,n=null){return{type:2,steps:t,options:n}}function qy(t){return{type:6,styles:t,offset:null}}class wx{constructor(n=0,i=0){this._onDoneFns=[],this._onStartFns=[],this._onDestroyFns=[],this._originalOnDoneFns=[],this._originalOnStartFns=[],this._started=!1,this._destroyed=!1,this._finished=!1,this._position=0,this.parentPlayer=null,this.totalTime=n+i}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(n=>n()),this._onDoneFns=[])}onStart(n){this._originalOnStartFns.push(n),this._onStartFns.push(n)}onDone(n){this._originalOnDoneFns.push(n),this._onDoneFns.push(n)}onDestroy(n){this._onDestroyFns.push(n)}hasStarted(){return this._started}init(){}play(){this.hasStarted()||(this._onStart(),this.triggerMicrotask()),this._started=!0}triggerMicrotask(){queueMicrotask(()=>this._onFinish())}_onStart(){this._onStartFns.forEach(n=>n()),this._onStartFns=[]}pause(){}restart(){}finish(){this._onFinish()}destroy(){this._destroyed||(this._destroyed=!0,this.hasStarted()||this._onStart(),this.finish(),this._onDestroyFns.forEach(n=>n()),this._onDestroyFns=[])}reset(){this._started=!1,this._finished=!1,this._onStartFns=this._originalOnStartFns,this._onDoneFns=this._originalOnDoneFns}setPosition(n){this._position=this.totalTime?n*this.totalTime:1}getPosition(){return this.totalTime?this._position/this.totalTime:1}triggerCallback(n){const i="start"==n?this._onStartFns:this._onDoneFns;i.forEach(a=>a()),i.length=0}}class EA{constructor(n){this._onDoneFns=[],this._onStartFns=[],this._finished=!1,this._started=!1,this._destroyed=!1,this._onDestroyFns=[],this.parentPlayer=null,this.totalTime=0,this.players=n;let i=0,a=0,h=0;const y=this.players.length;0==y?queueMicrotask(()=>this._onFinish()):this.players.forEach(E=>{E.onDone(()=>{++i==y&&this._onFinish()}),E.onDestroy(()=>{++a==y&&this._onDestroy()}),E.onStart(()=>{++h==y&&this._onStart()})}),this.totalTime=this.players.reduce((E,D)=>Math.max(E,D.totalTime),0)}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(n=>n()),this._onDoneFns=[])}init(){this.players.forEach(n=>n.init())}onStart(n){this._onStartFns.push(n)}_onStart(){this.hasStarted()||(this._started=!0,this._onStartFns.forEach(n=>n()),this._onStartFns=[])}onDone(n){this._onDoneFns.push(n)}onDestroy(n){this._onDestroyFns.push(n)}hasStarted(){return this._started}play(){this.parentPlayer||this.init(),this._onStart(),this.players.forEach(n=>n.play())}pause(){this.players.forEach(n=>n.pause())}restart(){this.players.forEach(n=>n.restart())}finish(){this._onFinish(),this.players.forEach(n=>n.finish())}destroy(){this._onDestroy()}_onDestroy(){this._destroyed||(this._destroyed=!0,this._onFinish(),this.players.forEach(n=>n.destroy()),this._onDestroyFns.forEach(n=>n()),this._onDestroyFns=[])}reset(){this.players.forEach(n=>n.reset()),this._destroyed=!1,this._finished=!1,this._started=!1}setPosition(n){const i=n*this.totalTime;this.players.forEach(a=>{const h=a.totalTime?Math.min(1,i/a.totalTime):1;a.setPosition(h)})}getPosition(){const n=this.players.reduce((i,a)=>null===i||a.totalTime>i.totalTime?a:i,null);return null!=n?n.getPosition():0}beforeDestroy(){this.players.forEach(n=>{n.beforeDestroy&&n.beforeDestroy()})}triggerCallback(n){const i="start"==n?this._onStartFns:this._onDoneFns;i.forEach(a=>a()),i.length=0}}function TA(t){return new Pt(3e3,!1)}function Ip(t){switch(t.length){case 0:return new wx;case 1:return t[0];default:return new EA(t)}}function SA(t,n,i=new Map,a=new Map){const h=[],y=[];let E=-1,D=null;if(n.forEach(O=>{const N=O.get("offset"),$=N==E,J=$&&D||new Map;O.forEach((we,ve)=>{let Oe=ve,He=we;if("offset"!==ve)switch(Oe=t.normalizePropertyName(Oe,h),He){case"!":He=i.get(ve);break;case Kh:He=a.get(ve);break;default:He=t.normalizeStyleValue(ve,Oe,He,h)}J.set(Oe,He)}),$||y.push(J),D=J,E=N}),h.length)throw function vF(t){return new Pt(3502,!1)}();return y}function CS(t,n,i,a){switch(n){case"start":t.onStart(()=>a(i&&AS(i,"start",t)));break;case"done":t.onDone(()=>a(i&&AS(i,"done",t)));break;case"destroy":t.onDestroy(()=>a(i&&AS(i,"destroy",t)))}}function AS(t,n,i){const y=MS(t.element,t.triggerName,t.fromState,t.toState,n||t.phaseName,i.totalTime??t.totalTime,!!i.disabled),E=t._data;return null!=E&&(y._data=E),y}function MS(t,n,i,a,h="",y=0,E){return{element:t,triggerName:n,fromState:i,toState:a,phaseName:h,totalTime:y,disabled:!!E}}function wl(t,n,i){let a=t.get(n);return a||t.set(n,a=i),a}function DA(t){const n=t.indexOf(":");return[t.substring(1,n),t.slice(n+1)]}const PF=(()=>typeof document>"u"?null:document.documentElement)();function PS(t){const n=t.parentNode||t.host||null;return n===PF?null:n}let Ig=null,IA=!1;function CA(t,n){for(;n;){if(n===t)return!0;n=PS(n)}return!1}function AA(t,n,i){if(i)return Array.from(t.querySelectorAll(n));const a=t.querySelector(n);return a?[a]:[]}let MA=(()=>{class t{validateStyleProperty(i){return function OF(t){Ig||(Ig=function LF(){return typeof document<"u"?document.body:null}()||{},IA=!!Ig.style&&"WebkitAppearance"in Ig.style);let n=!0;return Ig.style&&!function RF(t){return"ebkit"==t.substring(1,6)}(t)&&(n=t in Ig.style,!n&&IA&&(n="Webkit"+t.charAt(0).toUpperCase()+t.slice(1)in Ig.style)),n}(i)}matchesElement(i,a){return!1}containsElement(i,a){return CA(i,a)}getParentElement(i){return PS(i)}query(i,a,h){return AA(i,a,h)}computeStyle(i,a,h){return h||""}animate(i,a,h,y,E,D=[],O){return new wx(h,y)}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})(),RS=(()=>{class t{static{this.NOOP=new MA}}return t})();const kF=1e3,OS="ng-enter",pw="ng-leave",mw="ng-trigger",gw=".ng-trigger",RA="ng-animating",LS=".ng-animating";function Qh(t){if("number"==typeof t)return t;const n=t.match(/^(-?[\.\d]+)(m?s)/);return!n||n.length<2?0:kS(parseFloat(n[1]),n[2])}function kS(t,n){return"s"===n?t*kF:t}function _w(t,n,i){return t.hasOwnProperty("duration")?t:function zF(t,n,i){let h,y=0,E="";if("string"==typeof t){const D=t.match(/^(-?[\.\d]+)(m?s)(?:\s+(-?[\.\d]+)(m?s))?(?:\s+([-a-z]+(?:\(.+?\))?))?$/i);if(null===D)return n.push(TA()),{duration:0,delay:0,easing:""};h=kS(parseFloat(D[1]),D[2]);const O=D[3];null!=O&&(y=kS(parseFloat(O),D[4]));const N=D[5];N&&(E=N)}else h=t;if(!i){let D=!1,O=n.length;h<0&&(n.push(function Kk(){return new Pt(3100,!1)}()),D=!0),y<0&&(n.push(function Qk(){return new Pt(3101,!1)}()),D=!0),D&&n.splice(O,0,TA())}return{duration:h,delay:y,easing:E}}(t,n,i)}function Ex(t,n={}){return Object.keys(t).forEach(i=>{n[i]=t[i]}),n}function OA(t){const n=new Map;return Object.keys(t).forEach(i=>{n.set(i,t[i])}),n}function Cp(t,n=new Map,i){if(i)for(let[a,h]of i)n.set(a,h);for(let[a,h]of t)n.set(a,h);return n}function Td(t,n,i){n.forEach((a,h)=>{const y=zS(h);i&&!i.has(h)&&i.set(h,t.style[y]),t.style[y]=a})}function Cg(t,n){n.forEach((i,a)=>{const h=zS(a);t.style[h]=""})}function Tx(t){return Array.isArray(t)?1==t.length?t[0]:yA(t):t}const FS=new RegExp("{{\\s*(.+?)\\s*}}","g");function kA(t){let n=[];if("string"==typeof t){let i;for(;i=FS.exec(t);)n.push(i[1]);FS.lastIndex=0}return n}function Sx(t,n,i){const a=t.toString(),h=a.replace(FS,(y,E)=>{let D=n[E];return null==D&&(i.push(function eF(t){return new Pt(3003,!1)}()),D=""),D.toString()});return h==a?t:h}function yw(t){const n=[];let i=t.next();for(;!i.done;)n.push(i.value),i=t.next();return n}const VF=/-+([a-z0-9])/g;function zS(t){return t.replace(VF,(...n)=>n[1].toUpperCase())}function El(t,n,i){switch(n.type){case 7:return t.visitTrigger(n,i);case 0:return t.visitState(n,i);case 1:return t.visitTransition(n,i);case 2:return t.visitSequence(n,i);case 3:return t.visitGroup(n,i);case 4:return t.visitAnimate(n,i);case 5:return t.visitKeyframes(n,i);case 6:return t.visitStyle(n,i);case 8:return t.visitReference(n,i);case 9:return t.visitAnimateChild(n,i);case 10:return t.visitAnimateRef(n,i);case 11:return t.visitQuery(n,i);case 12:return t.visitStagger(n,i);default:throw function tF(t){return new Pt(3004,!1)}()}}function FA(t,n){return window.getComputedStyle(t)[n]}const vw="*";function HF(t,n){const i=[];return"string"==typeof t?t.split(/\s*,\s*/).forEach(a=>function GF(t,n,i){if(":"==t[0]){const O=function $F(t,n){switch(t){case":enter":return"void => *";case":leave":return"* => void";case":increment":return(i,a)=>parseFloat(a)>parseFloat(i);case":decrement":return(i,a)=>parseFloat(a)<parseFloat(i);default:return n.push(function mF(t){return new Pt(3016,!1)}()),"* => *"}}(t,i);if("function"==typeof O)return void n.push(O);t=O}const a=t.match(/^(\*|[-\w]+)\s*(<?[=-]>)\s*(\*|[-\w]+)$/);if(null==a||a.length<4)return i.push(function pF(t){return new Pt(3015,!1)}()),n;const h=a[1],y=a[2],E=a[3];n.push(zA(h,E));"<"==y[0]&&!(h==vw&&E==vw)&&n.push(zA(E,h))}(a,i,n)):i.push(t),i}const xw=new Set(["true","1"]),bw=new Set(["false","0"]);function zA(t,n){const i=xw.has(t)||bw.has(t),a=xw.has(n)||bw.has(n);return(h,y)=>{let E=t==vw||t==h,D=n==vw||n==y;return!E&&i&&"boolean"==typeof h&&(E=h?xw.has(t):bw.has(t)),!D&&a&&"boolean"==typeof y&&(D=y?xw.has(n):bw.has(n)),E&&D}}const qF=new RegExp("s*:selfs*,?","g");function NS(t,n,i,a){return new WF(t).build(n,i,a)}class WF{constructor(n){this._driver=n}build(n,i,a){const h=new YF(i);return this._resetContextStyleTimingState(h),El(this,Tx(n),h)}_resetContextStyleTimingState(n){n.currentQuerySelector="",n.collectedStyles=new Map,n.collectedStyles.set("",new Map),n.currentTime=0}visitTrigger(n,i){let a=i.queryCount=0,h=i.depCount=0;const y=[],E=[];return"@"==n.name.charAt(0)&&i.errors.push(function iF(){return new Pt(3006,!1)}()),n.definitions.forEach(D=>{if(this._resetContextStyleTimingState(i),0==D.type){const O=D,N=O.name;N.toString().split(/\s*,\s*/).forEach($=>{O.name=$,y.push(this.visitState(O,i))}),O.name=N}else if(1==D.type){const O=this.visitTransition(D,i);a+=O.queryCount,h+=O.depCount,E.push(O)}else i.errors.push(function rF(){return new Pt(3007,!1)}())}),{type:7,name:n.name,states:y,transitions:E,queryCount:a,depCount:h,options:null}}visitState(n,i){const a=this.visitStyle(n.styles,i),h=n.options&&n.options.params||null;if(a.containsDynamicStyles){const y=new Set,E=h||{};a.styles.forEach(D=>{D instanceof Map&&D.forEach(O=>{kA(O).forEach(N=>{E.hasOwnProperty(N)||y.add(N)})})}),y.size&&(yw(y.values()),i.errors.push(function oF(t,n){return new Pt(3008,!1)}()))}return{type:0,name:n.name,style:a,options:h?{params:h}:null}}visitTransition(n,i){i.queryCount=0,i.depCount=0;const a=El(this,Tx(n.animation),i);return{type:1,matchers:HF(n.expr,i.errors),animation:a,queryCount:i.queryCount,depCount:i.depCount,options:Ag(n.options)}}visitSequence(n,i){return{type:2,steps:n.steps.map(a=>El(this,a,i)),options:Ag(n.options)}}visitGroup(n,i){const a=i.currentTime;let h=0;const y=n.steps.map(E=>{i.currentTime=a;const D=El(this,E,i);return h=Math.max(h,i.currentTime),D});return i.currentTime=h,{type:3,steps:y,options:Ag(n.options)}}visitAnimate(n,i){const a=function QF(t,n){if(t.hasOwnProperty("duration"))return t;if("number"==typeof t)return BS(_w(t,n).duration,0,"");const i=t;if(i.split(/\s+/).some(y=>"{"==y.charAt(0)&&"{"==y.charAt(1))){const y=BS(0,0,"");return y.dynamic=!0,y.strValue=i,y}const h=_w(i,n);return BS(h.duration,h.delay,h.easing)}(n.timings,i.errors);i.currentAnimateTimings=a;let h,y=n.styles?n.styles:qy({});if(5==y.type)h=this.visitKeyframes(y,i);else{let E=n.styles,D=!1;if(!E){D=!0;const N={};a.easing&&(N.easing=a.easing),E=qy(N)}i.currentTime+=a.duration+a.delay;const O=this.visitStyle(E,i);O.isEmptyStep=D,h=O}return i.currentAnimateTimings=null,{type:4,timings:a,style:h,options:null}}visitStyle(n,i){const a=this._makeStyleAst(n,i);return this._validateStyleAst(a,i),a}_makeStyleAst(n,i){const a=[],h=Array.isArray(n.styles)?n.styles:[n.styles];for(let D of h)"string"==typeof D?D===Kh?a.push(D):i.errors.push(new Pt(3002,!1)):a.push(OA(D));let y=!1,E=null;return a.forEach(D=>{if(D instanceof Map&&(D.has("easing")&&(E=D.get("easing"),D.delete("easing")),!y))for(let O of D.values())if(O.toString().indexOf("{{")>=0){y=!0;break}}),{type:6,styles:a,easing:E,offset:n.offset,containsDynamicStyles:y,options:null}}_validateStyleAst(n,i){const a=i.currentAnimateTimings;let h=i.currentTime,y=i.currentTime;a&&y>0&&(y-=a.duration+a.delay),n.styles.forEach(E=>{"string"!=typeof E&&E.forEach((D,O)=>{const N=i.collectedStyles.get(i.currentQuerySelector),$=N.get(O);let J=!0;$&&(y!=h&&y>=$.startTime&&h<=$.endTime&&(i.errors.push(function aF(t,n,i,a,h){return new Pt(3010,!1)}()),J=!1),y=$.startTime),J&&N.set(O,{startTime:y,endTime:h}),i.options&&function BF(t,n,i){const a=n.params||{},h=kA(t);h.length&&h.forEach(y=>{a.hasOwnProperty(y)||i.push(function Jk(t){return new Pt(3001,!1)}())})}(D,i.options,i.errors)})})}visitKeyframes(n,i){const a={type:5,styles:[],options:null};if(!i.currentAnimateTimings)return i.errors.push(function lF(){return new Pt(3011,!1)}()),a;let y=0;const E=[];let D=!1,O=!1,N=0;const $=n.steps.map(Mt=>{const dt=this._makeStyleAst(Mt,i);let rn=null!=dt.offset?dt.offset:function KF(t){if("string"==typeof t)return null;let n=null;if(Array.isArray(t))t.forEach(i=>{if(i instanceof Map&&i.has("offset")){const a=i;n=parseFloat(a.get("offset")),a.delete("offset")}});else if(t instanceof Map&&t.has("offset")){const i=t;n=parseFloat(i.get("offset")),i.delete("offset")}return n}(dt.styles),gn=0;return null!=rn&&(y++,gn=dt.offset=rn),O=O||gn<0||gn>1,D=D||gn<N,N=gn,E.push(gn),dt});O&&i.errors.push(function cF(){return new Pt(3012,!1)}()),D&&i.errors.push(function uF(){return new Pt(3200,!1)}());const J=n.steps.length;let we=0;y>0&&y<J?i.errors.push(function dF(){return new Pt(3202,!1)}()):0==y&&(we=1/(J-1));const ve=J-1,Oe=i.currentTime,He=i.currentAnimateTimings,mt=He.duration;return $.forEach((Mt,dt)=>{const rn=we>0?dt==ve?1:we*dt:E[dt],gn=rn*mt;i.currentTime=Oe+He.delay+gn,He.duration=gn,this._validateStyleAst(Mt,i),Mt.offset=rn,a.styles.push(Mt)}),a}visitReference(n,i){return{type:8,animation:El(this,Tx(n.animation),i),options:Ag(n.options)}}visitAnimateChild(n,i){return i.depCount++,{type:9,options:Ag(n.options)}}visitAnimateRef(n,i){return{type:10,animation:this.visitReference(n.animation,i),options:Ag(n.options)}}visitQuery(n,i){const a=i.currentQuerySelector,h=n.options||{};i.queryCount++,i.currentQuery=n;const[y,E]=function ZF(t){const n=!!t.split(/\s*,\s*/).find(i=>":self"==i);return n&&(t=t.replace(qF,"")),t=t.replace(/@\*/g,gw).replace(/@\w+/g,i=>gw+"-"+i.slice(1)).replace(/:animating/g,LS),[t,n]}(n.selector);i.currentQuerySelector=a.length?a+" "+y:y,wl(i.collectedStyles,i.currentQuerySelector,new Map);const D=El(this,Tx(n.animation),i);return i.currentQuery=null,i.currentQuerySelector=a,{type:11,selector:y,limit:h.limit||0,optional:!!h.optional,includeSelf:E,animation:D,originalSelector:n.selector,options:Ag(n.options)}}visitStagger(n,i){i.currentQuery||i.errors.push(function hF(){return new Pt(3013,!1)}());const a="full"===n.timings?{duration:0,delay:0,easing:"full"}:_w(n.timings,i.errors,!0);return{type:12,animation:El(this,Tx(n.animation),i),timings:a,options:null}}}class YF{constructor(n){this.errors=n,this.queryCount=0,this.depCount=0,this.currentTransition=null,this.currentQuery=null,this.currentQuerySelector=null,this.currentAnimateTimings=null,this.currentTime=0,this.collectedStyles=new Map,this.options=null,this.unsupportedCSSPropertiesFound=new Set}}function Ag(t){return t?(t=Ex(t)).params&&(t.params=function XF(t){return t?Ex(t):null}(t.params)):t={},t}function BS(t,n,i){return{duration:t,delay:n,easing:i}}function VS(t,n,i,a,h,y,E=null,D=!1){return{type:1,element:t,keyframes:n,preStyleProps:i,postStyleProps:a,duration:h,delay:y,totalTime:h+y,easing:E,subTimeline:D}}class ww{constructor(){this._map=new Map}get(n){return this._map.get(n)||[]}append(n,i){let a=this._map.get(n);a||this._map.set(n,a=[]),a.push(...i)}has(n){return this._map.has(n)}clear(){this._map.clear()}}const tz=new RegExp(":enter","g"),iz=new RegExp(":leave","g");function jS(t,n,i,a,h,y=new Map,E=new Map,D,O,N=[]){return(new rz).buildKeyframes(t,n,i,a,h,y,E,D,O,N)}class rz{buildKeyframes(n,i,a,h,y,E,D,O,N,$=[]){N=N||new ww;const J=new US(n,i,N,h,y,$,[]);J.options=O;const we=O.delay?Qh(O.delay):0;J.currentTimeline.delayNextStep(we),J.currentTimeline.setStyles([E],null,J.errors,O),El(this,a,J);const ve=J.timelines.filter(Oe=>Oe.containsAnimation());if(ve.length&&D.size){let Oe;for(let He=ve.length-1;He>=0;He--){const mt=ve[He];if(mt.element===i){Oe=mt;break}}Oe&&!Oe.allowOnlyTimelineStyles()&&Oe.setStyles([D],null,J.errors,O)}return ve.length?ve.map(Oe=>Oe.buildKeyframes()):[VS(i,[],[],[],0,we,"",!1)]}visitTrigger(n,i){}visitState(n,i){}visitTransition(n,i){}visitAnimateChild(n,i){const a=i.subInstructions.get(i.element);if(a){const h=i.createSubContext(n.options),y=i.currentTimeline.currentTime,E=this._visitSubInstructions(a,h,h.options);y!=E&&i.transformIntoNewTimeline(E)}i.previousNode=n}visitAnimateRef(n,i){const a=i.createSubContext(n.options);a.transformIntoNewTimeline(),this._applyAnimationRefDelays([n.options,n.animation.options],i,a),this.visitReference(n.animation,a),i.transformIntoNewTimeline(a.currentTimeline.currentTime),i.previousNode=n}_applyAnimationRefDelays(n,i,a){for(const h of n){const y=h?.delay;if(y){const E="number"==typeof y?y:Qh(Sx(y,h?.params??{},i.errors));a.delayNextStep(E)}}}_visitSubInstructions(n,i,a){let y=i.currentTimeline.currentTime;const E=null!=a.duration?Qh(a.duration):null,D=null!=a.delay?Qh(a.delay):null;return 0!==E&&n.forEach(O=>{const N=i.appendInstructionToTimeline(O,E,D);y=Math.max(y,N.duration+N.delay)}),y}visitReference(n,i){i.updateOptions(n.options,!0),El(this,n.animation,i),i.previousNode=n}visitSequence(n,i){const a=i.subContextCount;let h=i;const y=n.options;if(y&&(y.params||y.delay)&&(h=i.createSubContext(y),h.transformIntoNewTimeline(),null!=y.delay)){6==h.previousNode.type&&(h.currentTimeline.snapshotCurrentStyles(),h.previousNode=Ew);const E=Qh(y.delay);h.delayNextStep(E)}n.steps.length&&(n.steps.forEach(E=>El(this,E,h)),h.currentTimeline.applyStylesToKeyframe(),h.subContextCount>a&&h.transformIntoNewTimeline()),i.previousNode=n}visitGroup(n,i){const a=[];let h=i.currentTimeline.currentTime;const y=n.options&&n.options.delay?Qh(n.options.delay):0;n.steps.forEach(E=>{const D=i.createSubContext(n.options);y&&D.delayNextStep(y),El(this,E,D),h=Math.max(h,D.currentTimeline.currentTime),a.push(D.currentTimeline)}),a.forEach(E=>i.currentTimeline.mergeTimelineCollectedStyles(E)),i.transformIntoNewTimeline(h),i.previousNode=n}_visitTiming(n,i){if(n.dynamic){const a=n.strValue;return _w(i.params?Sx(a,i.params,i.errors):a,i.errors)}return{duration:n.duration,delay:n.delay,easing:n.easing}}visitAnimate(n,i){const a=i.currentAnimateTimings=this._visitTiming(n.timings,i),h=i.currentTimeline;a.delay&&(i.incrementTime(a.delay),h.snapshotCurrentStyles());const y=n.style;5==y.type?this.visitKeyframes(y,i):(i.incrementTime(a.duration),this.visitStyle(y,i),h.applyStylesToKeyframe()),i.currentAnimateTimings=null,i.previousNode=n}visitStyle(n,i){const a=i.currentTimeline,h=i.currentAnimateTimings;!h&&a.hasCurrentStyleProperties()&&a.forwardFrame();const y=h&&h.easing||n.easing;n.isEmptyStep?a.applyEmptyStep(y):a.setStyles(n.styles,y,i.errors,i.options),i.previousNode=n}visitKeyframes(n,i){const a=i.currentAnimateTimings,h=i.currentTimeline.duration,y=a.duration,D=i.createSubContext().currentTimeline;D.easing=a.easing,n.styles.forEach(O=>{D.forwardTime((O.offset||0)*y),D.setStyles(O.styles,O.easing,i.errors,i.options),D.applyStylesToKeyframe()}),i.currentTimeline.mergeTimelineCollectedStyles(D),i.transformIntoNewTimeline(h+y),i.previousNode=n}visitQuery(n,i){const a=i.currentTimeline.currentTime,h=n.options||{},y=h.delay?Qh(h.delay):0;y&&(6===i.previousNode.type||0==a&&i.currentTimeline.hasCurrentStyleProperties())&&(i.currentTimeline.snapshotCurrentStyles(),i.previousNode=Ew);let E=a;const D=i.invokeQuery(n.selector,n.originalSelector,n.limit,n.includeSelf,!!h.optional,i.errors);i.currentQueryTotal=D.length;let O=null;D.forEach((N,$)=>{i.currentQueryIndex=$;const J=i.createSubContext(n.options,N);y&&J.delayNextStep(y),N===i.element&&(O=J.currentTimeline),El(this,n.animation,J),J.currentTimeline.applyStylesToKeyframe(),E=Math.max(E,J.currentTimeline.currentTime)}),i.currentQueryIndex=0,i.currentQueryTotal=0,i.transformIntoNewTimeline(E),O&&(i.currentTimeline.mergeTimelineCollectedStyles(O),i.currentTimeline.snapshotCurrentStyles()),i.previousNode=n}visitStagger(n,i){const a=i.parentContext,h=i.currentTimeline,y=n.timings,E=Math.abs(y.duration),D=E*(i.currentQueryTotal-1);let O=E*i.currentQueryIndex;switch(y.duration<0?"reverse":y.easing){case"reverse":O=D-O;break;case"full":O=a.currentStaggerTime}const $=i.currentTimeline;O&&$.delayNextStep(O);const J=$.currentTime;El(this,n.animation,i),i.previousNode=n,a.currentStaggerTime=h.currentTime-J+(h.startTime-a.currentTimeline.startTime)}}const Ew={};class US{constructor(n,i,a,h,y,E,D,O){this._driver=n,this.element=i,this.subInstructions=a,this._enterClassName=h,this._leaveClassName=y,this.errors=E,this.timelines=D,this.parentContext=null,this.currentAnimateTimings=null,this.previousNode=Ew,this.subContextCount=0,this.options={},this.currentQueryIndex=0,this.currentQueryTotal=0,this.currentStaggerTime=0,this.currentTimeline=O||new Tw(this._driver,i,0),D.push(this.currentTimeline)}get params(){return this.options.params}updateOptions(n,i){if(!n)return;const a=n;let h=this.options;null!=a.duration&&(h.duration=Qh(a.duration)),null!=a.delay&&(h.delay=Qh(a.delay));const y=a.params;if(y){let E=h.params;E||(E=this.options.params={}),Object.keys(y).forEach(D=>{(!i||!E.hasOwnProperty(D))&&(E[D]=Sx(y[D],E,this.errors))})}}_copyOptions(){const n={};if(this.options){const i=this.options.params;if(i){const a=n.params={};Object.keys(i).forEach(h=>{a[h]=i[h]})}}return n}createSubContext(n=null,i,a){const h=i||this.element,y=new US(this._driver,h,this.subInstructions,this._enterClassName,this._leaveClassName,this.errors,this.timelines,this.currentTimeline.fork(h,a||0));return y.previousNode=this.previousNode,y.currentAnimateTimings=this.currentAnimateTimings,y.options=this._copyOptions(),y.updateOptions(n),y.currentQueryIndex=this.currentQueryIndex,y.currentQueryTotal=this.currentQueryTotal,y.parentContext=this,this.subContextCount++,y}transformIntoNewTimeline(n){return this.previousNode=Ew,this.currentTimeline=this.currentTimeline.fork(this.element,n),this.timelines.push(this.currentTimeline),this.currentTimeline}appendInstructionToTimeline(n,i,a){const h={duration:i??n.duration,delay:this.currentTimeline.currentTime+(a??0)+n.delay,easing:""},y=new oz(this._driver,n.element,n.keyframes,n.preStyleProps,n.postStyleProps,h,n.stretchStartingKeyframe);return this.timelines.push(y),h}incrementTime(n){this.currentTimeline.forwardTime(this.currentTimeline.duration+n)}delayNextStep(n){n>0&&this.currentTimeline.delayNextStep(n)}invokeQuery(n,i,a,h,y,E){let D=[];if(h&&D.push(this.element),n.length>0){n=(n=n.replace(tz,"."+this._enterClassName)).replace(iz,"."+this._leaveClassName);let N=this._driver.query(this.element,n,1!=a);0!==a&&(N=a<0?N.slice(N.length+a,N.length):N.slice(0,a)),D.push(...N)}return!y&&0==D.length&&E.push(function fF(t){return new Pt(3014,!1)}()),D}}class Tw{constructor(n,i,a,h){this._driver=n,this.element=i,this.startTime=a,this._elementTimelineStylesLookup=h,this.duration=0,this.easing=null,this._previousKeyframe=new Map,this._currentKeyframe=new Map,this._keyframes=new Map,this._styleSummary=new Map,this._localTimelineStyles=new Map,this._pendingStyles=new Map,this._backFill=new Map,this._currentEmptyStepKeyframe=null,this._elementTimelineStylesLookup||(this._elementTimelineStylesLookup=new Map),this._globalTimelineStyles=this._elementTimelineStylesLookup.get(i),this._globalTimelineStyles||(this._globalTimelineStyles=this._localTimelineStyles,this._elementTimelineStylesLookup.set(i,this._localTimelineStyles)),this._loadKeyframe()}containsAnimation(){switch(this._keyframes.size){case 0:return!1;case 1:return this.hasCurrentStyleProperties();default:return!0}}hasCurrentStyleProperties(){return this._currentKeyframe.size>0}get currentTime(){return this.startTime+this.duration}delayNextStep(n){const i=1===this._keyframes.size&&this._pendingStyles.size;this.duration||i?(this.forwardTime(this.currentTime+n),i&&this.snapshotCurrentStyles()):this.startTime+=n}fork(n,i){return this.applyStylesToKeyframe(),new Tw(this._driver,n,i||this.currentTime,this._elementTimelineStylesLookup)}_loadKeyframe(){this._currentKeyframe&&(this._previousKeyframe=this._currentKeyframe),this._currentKeyframe=this._keyframes.get(this.duration),this._currentKeyframe||(this._currentKeyframe=new Map,this._keyframes.set(this.duration,this._currentKeyframe))}forwardFrame(){this.duration+=1,this._loadKeyframe()}forwardTime(n){this.applyStylesToKeyframe(),this.duration=n,this._loadKeyframe()}_updateStyle(n,i){this._localTimelineStyles.set(n,i),this._globalTimelineStyles.set(n,i),this._styleSummary.set(n,{time:this.currentTime,value:i})}allowOnlyTimelineStyles(){return this._currentEmptyStepKeyframe!==this._currentKeyframe}applyEmptyStep(n){n&&this._previousKeyframe.set("easing",n);for(let[i,a]of this._globalTimelineStyles)this._backFill.set(i,a||Kh),this._currentKeyframe.set(i,Kh);this._currentEmptyStepKeyframe=this._currentKeyframe}setStyles(n,i,a,h){i&&this._previousKeyframe.set("easing",i);const y=h&&h.params||{},E=function sz(t,n){const i=new Map;let a;return t.forEach(h=>{if("*"===h){a=a||n.keys();for(let y of a)i.set(y,Kh)}else Cp(h,i)}),i}(n,this._globalTimelineStyles);for(let[D,O]of E){const N=Sx(O,y,a);this._pendingStyles.set(D,N),this._localTimelineStyles.has(D)||this._backFill.set(D,this._globalTimelineStyles.get(D)??Kh),this._updateStyle(D,N)}}applyStylesToKeyframe(){0!=this._pendingStyles.size&&(this._pendingStyles.forEach((n,i)=>{this._currentKeyframe.set(i,n)}),this._pendingStyles.clear(),this._localTimelineStyles.forEach((n,i)=>{this._currentKeyframe.has(i)||this._currentKeyframe.set(i,n)}))}snapshotCurrentStyles(){for(let[n,i]of this._localTimelineStyles)this._pendingStyles.set(n,i),this._updateStyle(n,i)}getFinalKeyframe(){return this._keyframes.get(this.duration)}get properties(){const n=[];for(let i in this._currentKeyframe)n.push(i);return n}mergeTimelineCollectedStyles(n){n._styleSummary.forEach((i,a)=>{const h=this._styleSummary.get(a);(!h||i.time>h.time)&&this._updateStyle(a,i.value)})}buildKeyframes(){this.applyStylesToKeyframe();const n=new Set,i=new Set,a=1===this._keyframes.size&&0===this.duration;let h=[];this._keyframes.forEach((D,O)=>{const N=Cp(D,new Map,this._backFill);N.forEach(($,J)=>{"!"===$?n.add(J):$===Kh&&i.add(J)}),a||N.set("offset",O/this.duration),h.push(N)});const y=n.size?yw(n.values()):[],E=i.size?yw(i.values()):[];if(a){const D=h[0],O=new Map(D);D.set("offset",0),O.set("offset",1),h=[D,O]}return VS(this.element,h,y,E,this.duration,this.startTime,this.easing,!1)}}class oz extends Tw{constructor(n,i,a,h,y,E,D=!1){super(n,i,E.delay),this.keyframes=a,this.preStyleProps=h,this.postStyleProps=y,this._stretchStartingKeyframe=D,this.timings={duration:E.duration,delay:E.delay,easing:E.easing}}containsAnimation(){return this.keyframes.length>1}buildKeyframes(){let n=this.keyframes,{delay:i,duration:a,easing:h}=this.timings;if(this._stretchStartingKeyframe&&i){const y=[],E=a+i,D=i/E,O=Cp(n[0]);O.set("offset",0),y.push(O);const N=Cp(n[0]);N.set("offset",VA(D)),y.push(N);const $=n.length-1;for(let J=1;J<=$;J++){let we=Cp(n[J]);const ve=we.get("offset");we.set("offset",VA((i+ve*a)/E)),y.push(we)}a=E,i=0,h="",n=y}return VS(this.element,n,this.preStyleProps,this.postStyleProps,a,i,h,!0)}}function VA(t,n=3){const i=Math.pow(10,n-1);return Math.round(t*i)/i}class HS{}const az=new Set(["width","height","minWidth","minHeight","maxWidth","maxHeight","left","top","bottom","right","fontSize","outlineWidth","outlineOffset","paddingTop","paddingLeft","paddingBottom","paddingRight","marginTop","marginLeft","marginBottom","marginRight","borderRadius","borderWidth","borderTopWidth","borderLeftWidth","borderRightWidth","borderBottomWidth","textIndent","perspective"]);class lz extends HS{normalizePropertyName(n,i){return zS(n)}normalizeStyleValue(n,i,a,h){let y="";const E=a.toString().trim();if(az.has(i)&&0!==a&&"0"!==a)if("number"==typeof a)y="px";else{const D=a.match(/^[+-]?[\d\.]+([a-z]*)$/);D&&0==D[1].length&&h.push(function nF(t,n){return new Pt(3005,!1)}())}return E+y}}function jA(t,n,i,a,h,y,E,D,O,N,$,J,we){return{type:0,element:t,triggerName:n,isRemovalTransition:h,fromState:i,fromStyles:y,toState:a,toStyles:E,timelines:D,queriedElements:O,preStyleProps:N,postStyleProps:$,totalTime:J,errors:we}}const GS={};class UA{constructor(n,i,a){this._triggerName=n,this.ast=i,this._stateStyles=a}match(n,i,a,h){return function cz(t,n,i,a,h){return t.some(y=>y(n,i,a,h))}(this.ast.matchers,n,i,a,h)}buildStyles(n,i,a){let h=this._stateStyles.get("*");return void 0!==n&&(h=this._stateStyles.get(n?.toString())||h),h?h.buildStyles(i,a):new Map}build(n,i,a,h,y,E,D,O,N,$){const J=[],we=this.ast.options&&this.ast.options.params||GS,Oe=this.buildStyles(a,D&&D.params||GS,J),He=O&&O.params||GS,mt=this.buildStyles(h,He,J),Mt=new Set,dt=new Map,rn=new Map,gn="void"===h,_i={params:uz(He,we),delay:this.ast.options?.delay},Ur=$?[]:jS(n,i,this.ast.animation,y,E,Oe,mt,_i,N,J);let Hr=0;if(Ur.forEach(Tl=>{Hr=Math.max(Tl.duration+Tl.delay,Hr)}),J.length)return jA(i,this._triggerName,a,h,gn,Oe,mt,[],[],dt,rn,Hr,J);Ur.forEach(Tl=>{const vu=Tl.element,Vw=wl(dt,vu,new Set);Tl.preStyleProps.forEach(Lg=>Vw.add(Lg));const Ox=wl(rn,vu,new Set);Tl.postStyleProps.forEach(Lg=>Ox.add(Lg)),vu!==i&&Mt.add(vu)});const na=yw(Mt.values());return jA(i,this._triggerName,a,h,gn,Oe,mt,Ur,na,dt,rn,Hr)}}function uz(t,n){const i=Ex(n);for(const a in t)t.hasOwnProperty(a)&&null!=t[a]&&(i[a]=t[a]);return i}class dz{constructor(n,i,a){this.styles=n,this.defaultParams=i,this.normalizer=a}buildStyles(n,i){const a=new Map,h=Ex(this.defaultParams);return Object.keys(n).forEach(y=>{const E=n[y];null!==E&&(h[y]=E)}),this.styles.styles.forEach(y=>{"string"!=typeof y&&y.forEach((E,D)=>{E&&(E=Sx(E,h,i));const O=this.normalizer.normalizePropertyName(D,i);E=this.normalizer.normalizeStyleValue(D,O,E,i),a.set(D,E)})}),a}}class fz{constructor(n,i,a){this.name=n,this.ast=i,this._normalizer=a,this.transitionFactories=[],this.states=new Map,i.states.forEach(h=>{this.states.set(h.name,new dz(h.style,h.options&&h.options.params||{},a))}),HA(this.states,"true","1"),HA(this.states,"false","0"),i.transitions.forEach(h=>{this.transitionFactories.push(new UA(n,h,this.states))}),this.fallbackTransition=function pz(t,n,i){return new UA(t,{type:1,animation:{type:2,steps:[],options:null},matchers:[(E,D)=>!0],options:null,queryCount:0,depCount:0},n)}(n,this.states)}get containsQueries(){return this.ast.queryCount>0}matchTransition(n,i,a,h){return this.transitionFactories.find(E=>E.match(n,i,a,h))||null}matchStyles(n,i,a){return this.fallbackTransition.buildStyles(n,i,a)}}function HA(t,n,i){t.has(n)?t.has(i)||t.set(i,t.get(n)):t.has(i)&&t.set(n,t.get(i))}const mz=new ww;class gz{constructor(n,i,a){this.bodyNode=n,this._driver=i,this._normalizer=a,this._animations=new Map,this._playersById=new Map,this.players=[]}register(n,i){const a=[],y=NS(this._driver,i,a,[]);if(a.length)throw function xF(t){return new Pt(3503,!1)}();this._animations.set(n,y)}_buildPlayer(n,i,a){const h=n.element,y=SA(this._normalizer,n.keyframes,i,a);return this._driver.animate(h,y,n.duration,n.delay,n.easing,[],!0)}create(n,i,a={}){const h=[],y=this._animations.get(n);let E;const D=new Map;if(y?(E=jS(this._driver,i,y,OS,pw,new Map,new Map,a,mz,h),E.forEach($=>{const J=wl(D,$.element,new Map);$.postStyleProps.forEach(we=>J.set(we,null))})):(h.push(function bF(){return new Pt(3300,!1)}()),E=[]),h.length)throw function wF(t){return new Pt(3504,!1)}();D.forEach(($,J)=>{$.forEach((we,ve)=>{$.set(ve,this._driver.computeStyle(J,ve,Kh))})});const N=Ip(E.map($=>{const J=D.get($.element);return this._buildPlayer($,new Map,J)}));return this._playersById.set(n,N),N.onDestroy(()=>this.destroy(n)),this.players.push(N),N}destroy(n){const i=this._getPlayer(n);i.destroy(),this._playersById.delete(n);const a=this.players.indexOf(i);a>=0&&this.players.splice(a,1)}_getPlayer(n){const i=this._playersById.get(n);if(!i)throw function EF(t){return new Pt(3301,!1)}();return i}listen(n,i,a,h){const y=MS(i,"","","");return CS(this._getPlayer(n),a,y,h),()=>{}}command(n,i,a,h){if("register"==a)return void this.register(n,h[0]);if("create"==a)return void this.create(n,i,h[0]||{});const y=this._getPlayer(n);switch(a){case"play":y.play();break;case"pause":y.pause();break;case"reset":y.reset();break;case"restart":y.restart();break;case"finish":y.finish();break;case"init":y.init();break;case"setPosition":y.setPosition(parseFloat(h[0]));break;case"destroy":this.destroy(n)}}}const GA="ng-animate-queued",$S="ng-animate-disabled",bz=[],$A={namespaceId:"",setForRemoval:!1,setForMove:!1,hasAnimation:!1,removedBeforeQueried:!1},wz={namespaceId:"",setForMove:!1,setForRemoval:!1,hasAnimation:!1,removedBeforeQueried:!0},yu="__ng_removed";class qS{get params(){return this.options.params}constructor(n,i=""){this.namespaceId=i;const a=n&&n.hasOwnProperty("value");if(this.value=function Dz(t){return t??null}(a?n.value:n),a){const y=Ex(n);delete y.value,this.options=y}else this.options={};this.options.params||(this.options.params={})}absorbOptions(n){const i=n.params;if(i){const a=this.options.params;Object.keys(i).forEach(h=>{null==a[h]&&(a[h]=i[h])})}}}const Dx="void",WS=new qS(Dx);class Ez{constructor(n,i,a){this.id=n,this.hostElement=i,this._engine=a,this.players=[],this._triggers=new Map,this._queue=[],this._elementListeners=new Map,this._hostClassName="ng-tns-"+n,fc(i,this._hostClassName)}listen(n,i,a,h){if(!this._triggers.has(i))throw function TF(t,n){return new Pt(3302,!1)}();if(null==a||0==a.length)throw function SF(t){return new Pt(3303,!1)}();if(!function Iz(t){return"start"==t||"done"==t}(a))throw function DF(t,n){return new Pt(3400,!1)}();const y=wl(this._elementListeners,n,[]),E={name:i,phase:a,callback:h};y.push(E);const D=wl(this._engine.statesByElement,n,new Map);return D.has(i)||(fc(n,mw),fc(n,mw+"-"+i),D.set(i,WS)),()=>{this._engine.afterFlush(()=>{const O=y.indexOf(E);O>=0&&y.splice(O,1),this._triggers.has(i)||D.delete(i)})}}register(n,i){return!this._triggers.has(n)&&(this._triggers.set(n,i),!0)}_getTrigger(n){const i=this._triggers.get(n);if(!i)throw function IF(t){return new Pt(3401,!1)}();return i}trigger(n,i,a,h=!0){const y=this._getTrigger(i),E=new ZS(this.id,i,n);let D=this._engine.statesByElement.get(n);D||(fc(n,mw),fc(n,mw+"-"+i),this._engine.statesByElement.set(n,D=new Map));let O=D.get(i);const N=new qS(a,this.id);if(!(a&&a.hasOwnProperty("value"))&&O&&N.absorbOptions(O.options),D.set(i,N),O||(O=WS),N.value!==Dx&&O.value===N.value){if(!function Mz(t,n){const i=Object.keys(t),a=Object.keys(n);if(i.length!=a.length)return!1;for(let h=0;h<i.length;h++){const y=i[h];if(!n.hasOwnProperty(y)||t[y]!==n[y])return!1}return!0}(O.params,N.params)){const He=[],mt=y.matchStyles(O.value,O.params,He),Mt=y.matchStyles(N.value,N.params,He);He.length?this._engine.reportError(He):this._engine.afterFlush(()=>{Cg(n,mt),Td(n,Mt)})}return}const we=wl(this._engine.playersByElement,n,[]);we.forEach(He=>{He.namespaceId==this.id&&He.triggerName==i&&He.queued&&He.destroy()});let ve=y.matchTransition(O.value,N.value,n,N.params),Oe=!1;if(!ve){if(!h)return;ve=y.fallbackTransition,Oe=!0}return this._engine.totalQueuedPlayers++,this._queue.push({element:n,triggerName:i,transition:ve,fromState:O,toState:N,player:E,isFallbackTransition:Oe}),Oe||(fc(n,GA),E.onStart(()=>{Wy(n,GA)})),E.onDone(()=>{let He=this.players.indexOf(E);He>=0&&this.players.splice(He,1);const mt=this._engine.playersByElement.get(n);if(mt){let Mt=mt.indexOf(E);Mt>=0&&mt.splice(Mt,1)}}),this.players.push(E),we.push(E),E}deregister(n){this._triggers.delete(n),this._engine.statesByElement.forEach(i=>i.delete(n)),this._elementListeners.forEach((i,a)=>{this._elementListeners.set(a,i.filter(h=>h.name!=n))})}clearElementCache(n){this._engine.statesByElement.delete(n),this._elementListeners.delete(n);const i=this._engine.playersByElement.get(n);i&&(i.forEach(a=>a.destroy()),this._engine.playersByElement.delete(n))}_signalRemovalForInnerTriggers(n,i){const a=this._engine.driver.query(n,gw,!0);a.forEach(h=>{if(h[yu])return;const y=this._engine.fetchNamespacesByElement(h);y.size?y.forEach(E=>E.triggerLeaveAnimation(h,i,!1,!0)):this.clearElementCache(h)}),this._engine.afterFlushAnimationsDone(()=>a.forEach(h=>this.clearElementCache(h)))}triggerLeaveAnimation(n,i,a,h){const y=this._engine.statesByElement.get(n),E=new Map;if(y){const D=[];if(y.forEach((O,N)=>{if(E.set(N,O.value),this._triggers.has(N)){const $=this.trigger(n,N,Dx,h);$&&D.push($)}}),D.length)return this._engine.markElementAsRemoved(this.id,n,!0,i,E),a&&Ip(D).onDone(()=>this._engine.processLeaveNode(n)),!0}return!1}prepareLeaveAnimationListeners(n){const i=this._elementListeners.get(n),a=this._engine.statesByElement.get(n);if(i&&a){const h=new Set;i.forEach(y=>{const E=y.name;if(h.has(E))return;h.add(E);const O=this._triggers.get(E).fallbackTransition,N=a.get(E)||WS,$=new qS(Dx),J=new ZS(this.id,E,n);this._engine.totalQueuedPlayers++,this._queue.push({element:n,triggerName:E,transition:O,fromState:N,toState:$,player:J,isFallbackTransition:!0})})}}removeNode(n,i){const a=this._engine;if(n.childElementCount&&this._signalRemovalForInnerTriggers(n,i),this.triggerLeaveAnimation(n,i,!0))return;let h=!1;if(a.totalAnimations){const y=a.players.length?a.playersByQueriedElement.get(n):[];if(y&&y.length)h=!0;else{let E=n;for(;E=E.parentNode;)if(a.statesByElement.get(E)){h=!0;break}}}if(this.prepareLeaveAnimationListeners(n),h)a.markElementAsRemoved(this.id,n,!1,i);else{const y=n[yu];(!y||y===$A)&&(a.afterFlush(()=>this.clearElementCache(n)),a.destroyInnerAnimations(n),a._onRemovalComplete(n,i))}}insertNode(n,i){fc(n,this._hostClassName)}drainQueuedTransitions(n){const i=[];return this._queue.forEach(a=>{const h=a.player;if(h.destroyed)return;const y=a.element,E=this._elementListeners.get(y);E&&E.forEach(D=>{if(D.name==a.triggerName){const O=MS(y,a.triggerName,a.fromState.value,a.toState.value);O._data=n,CS(a.player,D.phase,O,D.callback)}}),h.markedForDestroy?this._engine.afterFlush(()=>{h.destroy()}):i.push(a)}),this._queue=[],i.sort((a,h)=>{const y=a.transition.ast.depCount,E=h.transition.ast.depCount;return 0==y||0==E?y-E:this._engine.driver.containsElement(a.element,h.element)?1:-1})}destroy(n){this.players.forEach(i=>i.destroy()),this._signalRemovalForInnerTriggers(this.hostElement,n)}}class Tz{_onRemovalComplete(n,i){this.onRemovalComplete(n,i)}constructor(n,i,a){this.bodyNode=n,this.driver=i,this._normalizer=a,this.players=[],this.newHostElements=new Map,this.playersByElement=new Map,this.playersByQueriedElement=new Map,this.statesByElement=new Map,this.disabledNodes=new Set,this.totalAnimations=0,this.totalQueuedPlayers=0,this._namespaceLookup={},this._namespaceList=[],this._flushFns=[],this._whenQuietFns=[],this.namespacesByHostElement=new Map,this.collectedEnterElements=[],this.collectedLeaveElements=[],this.onRemovalComplete=(h,y)=>{}}get queuedPlayers(){const n=[];return this._namespaceList.forEach(i=>{i.players.forEach(a=>{a.queued&&n.push(a)})}),n}createNamespace(n,i){const a=new Ez(n,i,this);return this.bodyNode&&this.driver.containsElement(this.bodyNode,i)?this._balanceNamespaceList(a,i):(this.newHostElements.set(i,a),this.collectEnterElement(i)),this._namespaceLookup[n]=a}_balanceNamespaceList(n,i){const a=this._namespaceList,h=this.namespacesByHostElement;if(a.length-1>=0){let E=!1,D=this.driver.getParentElement(i);for(;D;){const O=h.get(D);if(O){const N=a.indexOf(O);a.splice(N+1,0,n),E=!0;break}D=this.driver.getParentElement(D)}E||a.unshift(n)}else a.push(n);return h.set(i,n),n}register(n,i){let a=this._namespaceLookup[n];return a||(a=this.createNamespace(n,i)),a}registerTrigger(n,i,a){let h=this._namespaceLookup[n];h&&h.register(i,a)&&this.totalAnimations++}destroy(n,i){n&&(this.afterFlush(()=>{}),this.afterFlushAnimationsDone(()=>{const a=this._fetchNamespace(n);this.namespacesByHostElement.delete(a.hostElement);const h=this._namespaceList.indexOf(a);h>=0&&this._namespaceList.splice(h,1),a.destroy(i),delete this._namespaceLookup[n]}))}_fetchNamespace(n){return this._namespaceLookup[n]}fetchNamespacesByElement(n){const i=new Set,a=this.statesByElement.get(n);if(a)for(let h of a.values())if(h.namespaceId){const y=this._fetchNamespace(h.namespaceId);y&&i.add(y)}return i}trigger(n,i,a,h){if(Sw(i)){const y=this._fetchNamespace(n);if(y)return y.trigger(i,a,h),!0}return!1}insertNode(n,i,a,h){if(!Sw(i))return;const y=i[yu];if(y&&y.setForRemoval){y.setForRemoval=!1,y.setForMove=!0;const E=this.collectedLeaveElements.indexOf(i);E>=0&&this.collectedLeaveElements.splice(E,1)}if(n){const E=this._fetchNamespace(n);E&&E.insertNode(i,a)}h&&this.collectEnterElement(i)}collectEnterElement(n){this.collectedEnterElements.push(n)}markElementAsDisabled(n,i){i?this.disabledNodes.has(n)||(this.disabledNodes.add(n),fc(n,$S)):this.disabledNodes.has(n)&&(this.disabledNodes.delete(n),Wy(n,$S))}removeNode(n,i,a){if(Sw(i)){const h=n?this._fetchNamespace(n):null;h?h.removeNode(i,a):this.markElementAsRemoved(n,i,!1,a);const y=this.namespacesByHostElement.get(i);y&&y.id!==n&&y.removeNode(i,a)}else this._onRemovalComplete(i,a)}markElementAsRemoved(n,i,a,h,y){this.collectedLeaveElements.push(i),i[yu]={namespaceId:n,setForRemoval:h,hasAnimation:a,removedBeforeQueried:!1,previousTriggersValues:y}}listen(n,i,a,h,y){return Sw(i)?this._fetchNamespace(n).listen(i,a,h,y):()=>{}}_buildInstruction(n,i,a,h,y){return n.transition.build(this.driver,n.element,n.fromState.value,n.toState.value,a,h,n.fromState.options,n.toState.options,i,y)}destroyInnerAnimations(n){let i=this.driver.query(n,gw,!0);i.forEach(a=>this.destroyActiveAnimationsForElement(a)),0!=this.playersByQueriedElement.size&&(i=this.driver.query(n,LS,!0),i.forEach(a=>this.finishActiveQueriedAnimationOnElement(a)))}destroyActiveAnimationsForElement(n){const i=this.playersByElement.get(n);i&&i.forEach(a=>{a.queued?a.markedForDestroy=!0:a.destroy()})}finishActiveQueriedAnimationOnElement(n){const i=this.playersByQueriedElement.get(n);i&&i.forEach(a=>a.finish())}whenRenderingDone(){return new Promise(n=>{if(this.players.length)return Ip(this.players).onDone(()=>n());n()})}processLeaveNode(n){const i=n[yu];if(i&&i.setForRemoval){if(n[yu]=$A,i.namespaceId){this.destroyInnerAnimations(n);const a=this._fetchNamespace(i.namespaceId);a&&a.clearElementCache(n)}this._onRemovalComplete(n,i.setForRemoval)}n.classList?.contains($S)&&this.markElementAsDisabled(n,!1),this.driver.query(n,".ng-animate-disabled",!0).forEach(a=>{this.markElementAsDisabled(a,!1)})}flush(n=-1){let i=[];if(this.newHostElements.size&&(this.newHostElements.forEach((a,h)=>this._balanceNamespaceList(a,h)),this.newHostElements.clear()),this.totalAnimations&&this.collectedEnterElements.length)for(let a=0;a<this.collectedEnterElements.length;a++)fc(this.collectedEnterElements[a],"ng-star-inserted");if(this._namespaceList.length&&(this.totalQueuedPlayers||this.collectedLeaveElements.length)){const a=[];try{i=this._flushAnimations(a,n)}finally{for(let h=0;h<a.length;h++)a[h]()}}else for(let a=0;a<this.collectedLeaveElements.length;a++)this.processLeaveNode(this.collectedLeaveElements[a]);if(this.totalQueuedPlayers=0,this.collectedEnterElements.length=0,this.collectedLeaveElements.length=0,this._flushFns.forEach(a=>a()),this._flushFns=[],this._whenQuietFns.length){const a=this._whenQuietFns;this._whenQuietFns=[],i.length?Ip(i).onDone(()=>{a.forEach(h=>h())}):a.forEach(h=>h())}}reportError(n){throw function CF(t){return new Pt(3402,!1)}()}_flushAnimations(n,i){const a=new ww,h=[],y=new Map,E=[],D=new Map,O=new Map,N=new Map,$=new Set;this.disabledNodes.forEach(xn=>{$.add(xn);const Nn=this.driver.query(xn,".ng-animate-queued",!0);for(let Xn=0;Xn<Nn.length;Xn++)$.add(Nn[Xn])});const J=this.bodyNode,we=Array.from(this.statesByElement.keys()),ve=ZA(we,this.collectedEnterElements),Oe=new Map;let He=0;ve.forEach((xn,Nn)=>{const Xn=OS+He++;Oe.set(Nn,Xn),xn.forEach(nr=>fc(nr,Xn))});const mt=[],Mt=new Set,dt=new Set;for(let xn=0;xn<this.collectedLeaveElements.length;xn++){const Nn=this.collectedLeaveElements[xn],Xn=Nn[yu];Xn&&Xn.setForRemoval&&(mt.push(Nn),Mt.add(Nn),Xn.hasAnimation?this.driver.query(Nn,".ng-star-inserted",!0).forEach(nr=>Mt.add(nr)):dt.add(Nn))}const rn=new Map,gn=ZA(we,Array.from(Mt));gn.forEach((xn,Nn)=>{const Xn=pw+He++;rn.set(Nn,Xn),xn.forEach(nr=>fc(nr,Xn))}),n.push(()=>{ve.forEach((xn,Nn)=>{const Xn=Oe.get(Nn);xn.forEach(nr=>Wy(nr,Xn))}),gn.forEach((xn,Nn)=>{const Xn=rn.get(Nn);xn.forEach(nr=>Wy(nr,Xn))}),mt.forEach(xn=>{this.processLeaveNode(xn)})});const _i=[],Ur=[];for(let xn=this._namespaceList.length-1;xn>=0;xn--)this._namespaceList[xn].drainQueuedTransitions(i).forEach(Xn=>{const nr=Xn.player,Is=Xn.element;if(_i.push(nr),this.collectedEnterElements.length){const ia=Is[yu];if(ia&&ia.setForMove){if(ia.previousTriggersValues&&ia.previousTriggersValues.has(Xn.triggerName)){const kg=ia.previousTriggersValues.get(Xn.triggerName),pc=this.statesByElement.get(Xn.element);if(pc&&pc.has(Xn.triggerName)){const jw=pc.get(Xn.triggerName);jw.value=kg,pc.set(Xn.triggerName,jw)}}return void nr.destroy()}}const Dd=!J||!this.driver.containsElement(J,Is),Sl=rn.get(Is),Pp=Oe.get(Is),co=this._buildInstruction(Xn,a,Pp,Sl,Dd);if(co.errors&&co.errors.length)return void Ur.push(co);if(Dd)return nr.onStart(()=>Cg(Is,co.fromStyles)),nr.onDestroy(()=>Td(Is,co.toStyles)),void h.push(nr);if(Xn.isFallbackTransition)return nr.onStart(()=>Cg(Is,co.fromStyles)),nr.onDestroy(()=>Td(Is,co.toStyles)),void h.push(nr);const l2=[];co.timelines.forEach(ia=>{ia.stretchStartingKeyframe=!0,this.disabledNodes.has(ia.element)||l2.push(ia)}),co.timelines=l2,a.append(Is,co.timelines),E.push({instruction:co,player:nr,element:Is}),co.queriedElements.forEach(ia=>wl(D,ia,[]).push(nr)),co.preStyleProps.forEach((ia,kg)=>{if(ia.size){let pc=O.get(kg);pc||O.set(kg,pc=new Set),ia.forEach((jw,ED)=>pc.add(ED))}}),co.postStyleProps.forEach((ia,kg)=>{let pc=N.get(kg);pc||N.set(kg,pc=new Set),ia.forEach((jw,ED)=>pc.add(ED))})});if(Ur.length){const xn=[];Ur.forEach(Nn=>{xn.push(function AF(t,n){return new Pt(3505,!1)}())}),_i.forEach(Nn=>Nn.destroy()),this.reportError(xn)}const Hr=new Map,na=new Map;E.forEach(xn=>{const Nn=xn.element;a.has(Nn)&&(na.set(Nn,Nn),this._beforeAnimationBuild(xn.player.namespaceId,xn.instruction,Hr))}),h.forEach(xn=>{const Nn=xn.element;this._getPreviousPlayers(Nn,!1,xn.namespaceId,xn.triggerName,null).forEach(nr=>{wl(Hr,Nn,[]).push(nr),nr.destroy()})});const Tl=mt.filter(xn=>YA(xn,O,N)),vu=new Map;WA(vu,this.driver,dt,N,Kh).forEach(xn=>{YA(xn,O,N)&&Tl.push(xn)});const Ox=new Map;ve.forEach((xn,Nn)=>{WA(Ox,this.driver,new Set(xn),O,"!")}),Tl.forEach(xn=>{const Nn=vu.get(xn),Xn=Ox.get(xn);vu.set(xn,new Map([...Nn?.entries()??[],...Xn?.entries()??[]]))});const Lg=[],s2=[],a2={};E.forEach(xn=>{const{element:Nn,player:Xn,instruction:nr}=xn;if(a.has(Nn)){if($.has(Nn))return Xn.onDestroy(()=>Td(Nn,nr.toStyles)),Xn.disabled=!0,Xn.overrideTotalTime(nr.totalTime),void h.push(Xn);let Is=a2;if(na.size>1){let Sl=Nn;const Pp=[];for(;Sl=Sl.parentNode;){const co=na.get(Sl);if(co){Is=co;break}Pp.push(Sl)}Pp.forEach(co=>na.set(co,Is))}const Dd=this._buildAnimation(Xn.namespaceId,nr,Hr,y,Ox,vu);if(Xn.setRealPlayer(Dd),Is===a2)Lg.push(Xn);else{const Sl=this.playersByElement.get(Is);Sl&&Sl.length&&(Xn.parentPlayer=Ip(Sl)),h.push(Xn)}}else Cg(Nn,nr.fromStyles),Xn.onDestroy(()=>Td(Nn,nr.toStyles)),s2.push(Xn),$.has(Nn)&&h.push(Xn)}),s2.forEach(xn=>{const Nn=y.get(xn.element);if(Nn&&Nn.length){const Xn=Ip(Nn);xn.setRealPlayer(Xn)}}),h.forEach(xn=>{xn.parentPlayer?xn.syncPlayerEvents(xn.parentPlayer):xn.destroy()});for(let xn=0;xn<mt.length;xn++){const Nn=mt[xn],Xn=Nn[yu];if(Wy(Nn,pw),Xn&&Xn.hasAnimation)continue;let nr=[];if(D.size){let Dd=D.get(Nn);Dd&&Dd.length&&nr.push(...Dd);let Sl=this.driver.query(Nn,LS,!0);for(let Pp=0;Pp<Sl.length;Pp++){let co=D.get(Sl[Pp]);co&&co.length&&nr.push(...co)}}const Is=nr.filter(Dd=>!Dd.destroyed);Is.length?Cz(this,Nn,Is):this.processLeaveNode(Nn)}return mt.length=0,Lg.forEach(xn=>{this.players.push(xn),xn.onDone(()=>{xn.destroy();const Nn=this.players.indexOf(xn);this.players.splice(Nn,1)}),xn.play()}),Lg}afterFlush(n){this._flushFns.push(n)}afterFlushAnimationsDone(n){this._whenQuietFns.push(n)}_getPreviousPlayers(n,i,a,h,y){let E=[];if(i){const D=this.playersByQueriedElement.get(n);D&&(E=D)}else{const D=this.playersByElement.get(n);if(D){const O=!y||y==Dx;D.forEach(N=>{N.queued||!O&&N.triggerName!=h||E.push(N)})}}return(a||h)&&(E=E.filter(D=>!(a&&a!=D.namespaceId||h&&h!=D.triggerName))),E}_beforeAnimationBuild(n,i,a){const y=i.element,E=i.isRemovalTransition?void 0:n,D=i.isRemovalTransition?void 0:i.triggerName;for(const O of i.timelines){const N=O.element,$=N!==y,J=wl(a,N,[]);this._getPreviousPlayers(N,$,E,D,i.toState).forEach(ve=>{const Oe=ve.getRealPlayer();Oe.beforeDestroy&&Oe.beforeDestroy(),ve.destroy(),J.push(ve)})}Cg(y,i.fromStyles)}_buildAnimation(n,i,a,h,y,E){const D=i.triggerName,O=i.element,N=[],$=new Set,J=new Set,we=i.timelines.map(Oe=>{const He=Oe.element;$.add(He);const mt=He[yu];if(mt&&mt.removedBeforeQueried)return new wx(Oe.duration,Oe.delay);const Mt=He!==O,dt=function Az(t){const n=[];return XA(t,n),n}((a.get(He)||bz).map(Hr=>Hr.getRealPlayer())).filter(Hr=>!!Hr.element&&Hr.element===He),rn=y.get(He),gn=E.get(He),_i=SA(this._normalizer,Oe.keyframes,rn,gn),Ur=this._buildPlayer(Oe,_i,dt);if(Oe.subTimeline&&h&&J.add(He),Mt){const Hr=new ZS(n,D,He);Hr.setRealPlayer(Ur),N.push(Hr)}return Ur});N.forEach(Oe=>{wl(this.playersByQueriedElement,Oe.element,[]).push(Oe),Oe.onDone(()=>function Sz(t,n,i){let a=t.get(n);if(a){if(a.length){const h=a.indexOf(i);a.splice(h,1)}0==a.length&&t.delete(n)}return a}(this.playersByQueriedElement,Oe.element,Oe))}),$.forEach(Oe=>fc(Oe,RA));const ve=Ip(we);return ve.onDestroy(()=>{$.forEach(Oe=>Wy(Oe,RA)),Td(O,i.toStyles)}),J.forEach(Oe=>{wl(h,Oe,[]).push(ve)}),ve}_buildPlayer(n,i,a){return i.length>0?this.driver.animate(n.element,i,n.duration,n.delay,n.easing,a):new wx(n.duration,n.delay)}}class ZS{constructor(n,i,a){this.namespaceId=n,this.triggerName=i,this.element=a,this._player=new wx,this._containsRealPlayer=!1,this._queuedCallbacks=new Map,this.destroyed=!1,this.parentPlayer=null,this.markedForDestroy=!1,this.disabled=!1,this.queued=!0,this.totalTime=0}setRealPlayer(n){this._containsRealPlayer||(this._player=n,this._queuedCallbacks.forEach((i,a)=>{i.forEach(h=>CS(n,a,void 0,h))}),this._queuedCallbacks.clear(),this._containsRealPlayer=!0,this.overrideTotalTime(n.totalTime),this.queued=!1)}getRealPlayer(){return this._player}overrideTotalTime(n){this.totalTime=n}syncPlayerEvents(n){const i=this._player;i.triggerCallback&&n.onStart(()=>i.triggerCallback("start")),n.onDone(()=>this.finish()),n.onDestroy(()=>this.destroy())}_queueEvent(n,i){wl(this._queuedCallbacks,n,[]).push(i)}onDone(n){this.queued&&this._queueEvent("done",n),this._player.onDone(n)}onStart(n){this.queued&&this._queueEvent("start",n),this._player.onStart(n)}onDestroy(n){this.queued&&this._queueEvent("destroy",n),this._player.onDestroy(n)}init(){this._player.init()}hasStarted(){return!this.queued&&this._player.hasStarted()}play(){!this.queued&&this._player.play()}pause(){!this.queued&&this._player.pause()}restart(){!this.queued&&this._player.restart()}finish(){this._player.finish()}destroy(){this.destroyed=!0,this._player.destroy()}reset(){!this.queued&&this._player.reset()}setPosition(n){this.queued||this._player.setPosition(n)}getPosition(){return this.queued?0:this._player.getPosition()}triggerCallback(n){const i=this._player;i.triggerCallback&&i.triggerCallback(n)}}function Sw(t){return t&&1===t.nodeType}function qA(t,n){const i=t.style.display;return t.style.display=n??"none",i}function WA(t,n,i,a,h){const y=[];i.forEach(O=>y.push(qA(O)));const E=[];a.forEach((O,N)=>{const $=new Map;O.forEach(J=>{const we=n.computeStyle(N,J,h);$.set(J,we),(!we||0==we.length)&&(N[yu]=wz,E.push(N))}),t.set(N,$)});let D=0;return i.forEach(O=>qA(O,y[D++])),E}function ZA(t,n){const i=new Map;if(t.forEach(D=>i.set(D,[])),0==n.length)return i;const h=new Set(n),y=new Map;function E(D){if(!D)return 1;let O=y.get(D);if(O)return O;const N=D.parentNode;return O=i.has(N)?N:h.has(N)?1:E(N),y.set(D,O),O}return n.forEach(D=>{const O=E(D);1!==O&&i.get(O).push(D)}),i}function fc(t,n){t.classList?.add(n)}function Wy(t,n){t.classList?.remove(n)}function Cz(t,n,i){Ip(i).onDone(()=>t.processLeaveNode(n))}function XA(t,n){for(let i=0;i<t.length;i++){const a=t[i];a instanceof EA?XA(a.players,n):n.push(a)}}function YA(t,n,i){const a=i.get(t);if(!a)return!1;let h=n.get(t);return h?a.forEach(y=>h.add(y)):n.set(t,a),i.delete(t),!0}class Dw{constructor(n,i,a){this.bodyNode=n,this._driver=i,this._normalizer=a,this._triggerCache={},this.onRemovalComplete=(h,y)=>{},this._transitionEngine=new Tz(n,i,a),this._timelineEngine=new gz(n,i,a),this._transitionEngine.onRemovalComplete=(h,y)=>this.onRemovalComplete(h,y)}registerTrigger(n,i,a,h,y){const E=n+"-"+h;let D=this._triggerCache[E];if(!D){const O=[],$=NS(this._driver,y,O,[]);if(O.length)throw function yF(t,n){return new Pt(3404,!1)}();D=function hz(t,n,i){return new fz(t,n,i)}(h,$,this._normalizer),this._triggerCache[E]=D}this._transitionEngine.registerTrigger(i,h,D)}register(n,i){this._transitionEngine.register(n,i)}destroy(n,i){this._transitionEngine.destroy(n,i)}onInsert(n,i,a,h){this._transitionEngine.insertNode(n,i,a,h)}onRemove(n,i,a){this._transitionEngine.removeNode(n,i,a)}disableAnimations(n,i){this._transitionEngine.markElementAsDisabled(n,i)}process(n,i,a,h){if("@"==a.charAt(0)){const[y,E]=DA(a);this._timelineEngine.command(y,i,E,h)}else this._transitionEngine.trigger(n,i,a,h)}listen(n,i,a,h,y){if("@"==a.charAt(0)){const[E,D]=DA(a);return this._timelineEngine.listen(E,i,D,y)}return this._transitionEngine.listen(n,i,a,h,y)}flush(n=-1){this._transitionEngine.flush(n)}get players(){return[...this._transitionEngine.players,...this._timelineEngine.players]}whenRenderingDone(){return this._transitionEngine.whenRenderingDone()}afterFlushAnimationsDone(n){this._transitionEngine.afterFlushAnimationsDone(n)}}let Rz=(()=>{class t{static{this.initialStylesByElement=new WeakMap}constructor(i,a,h){this._element=i,this._startStyles=a,this._endStyles=h,this._state=0;let y=t.initialStylesByElement.get(i);y||t.initialStylesByElement.set(i,y=new Map),this._initialStyles=y}start(){this._state<1&&(this._startStyles&&Td(this._element,this._startStyles,this._initialStyles),this._state=1)}finish(){this.start(),this._state<2&&(Td(this._element,this._initialStyles),this._endStyles&&(Td(this._element,this._endStyles),this._endStyles=null),this._state=1)}destroy(){this.finish(),this._state<3&&(t.initialStylesByElement.delete(this._element),this._startStyles&&(Cg(this._element,this._startStyles),this._endStyles=null),this._endStyles&&(Cg(this._element,this._endStyles),this._endStyles=null),Td(this._element,this._initialStyles),this._state=3)}}return t})();function XS(t){let n=null;return t.forEach((i,a)=>{(function Oz(t){return"display"===t||"position"===t})(a)&&(n=n||new Map,n.set(a,i))}),n}class KA{constructor(n,i,a,h){this.element=n,this.keyframes=i,this.options=a,this._specialStyles=h,this._onDoneFns=[],this._onStartFns=[],this._onDestroyFns=[],this._initialized=!1,this._finished=!1,this._started=!1,this._destroyed=!1,this._originalOnDoneFns=[],this._originalOnStartFns=[],this.time=0,this.parentPlayer=null,this.currentSnapshot=new Map,this._duration=a.duration,this._delay=a.delay||0,this.time=this._duration+this._delay}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(n=>n()),this._onDoneFns=[])}init(){this._buildPlayer(),this._preparePlayerBeforeStart()}_buildPlayer(){if(this._initialized)return;this._initialized=!0;const n=this.keyframes;this.domPlayer=this._triggerWebAnimation(this.element,n,this.options),this._finalKeyframe=n.length?n[n.length-1]:new Map;const i=()=>this._onFinish();this.domPlayer.addEventListener("finish",i),this.onDestroy(()=>{this.domPlayer.removeEventListener("finish",i)})}_preparePlayerBeforeStart(){this._delay?this._resetDomPlayerState():this.domPlayer.pause()}_convertKeyframesToObject(n){const i=[];return n.forEach(a=>{i.push(Object.fromEntries(a))}),i}_triggerWebAnimation(n,i,a){return n.animate(this._convertKeyframesToObject(i),a)}onStart(n){this._originalOnStartFns.push(n),this._onStartFns.push(n)}onDone(n){this._originalOnDoneFns.push(n),this._onDoneFns.push(n)}onDestroy(n){this._onDestroyFns.push(n)}play(){this._buildPlayer(),this.hasStarted()||(this._onStartFns.forEach(n=>n()),this._onStartFns=[],this._started=!0,this._specialStyles&&this._specialStyles.start()),this.domPlayer.play()}pause(){this.init(),this.domPlayer.pause()}finish(){this.init(),this._specialStyles&&this._specialStyles.finish(),this._onFinish(),this.domPlayer.finish()}reset(){this._resetDomPlayerState(),this._destroyed=!1,this._finished=!1,this._started=!1,this._onStartFns=this._originalOnStartFns,this._onDoneFns=this._originalOnDoneFns}_resetDomPlayerState(){this.domPlayer&&this.domPlayer.cancel()}restart(){this.reset(),this.play()}hasStarted(){return this._started}destroy(){this._destroyed||(this._destroyed=!0,this._resetDomPlayerState(),this._onFinish(),this._specialStyles&&this._specialStyles.destroy(),this._onDestroyFns.forEach(n=>n()),this._onDestroyFns=[])}setPosition(n){void 0===this.domPlayer&&this.init(),this.domPlayer.currentTime=n*this.time}getPosition(){return+(this.domPlayer.currentTime??0)/this.time}get totalTime(){return this._delay+this._duration}beforeDestroy(){const n=new Map;this.hasStarted()&&this._finalKeyframe.forEach((a,h)=>{"offset"!==h&&n.set(h,this._finished?a:FA(this.element,h))}),this.currentSnapshot=n}triggerCallback(n){const i="start"===n?this._onStartFns:this._onDoneFns;i.forEach(a=>a()),i.length=0}}class Lz{validateStyleProperty(n){return!0}validateAnimatableStyleProperty(n){return!0}matchesElement(n,i){return!1}containsElement(n,i){return CA(n,i)}getParentElement(n){return PS(n)}query(n,i,a){return AA(n,i,a)}computeStyle(n,i,a){return window.getComputedStyle(n)[i]}animate(n,i,a,h,y,E=[]){const O={duration:a,delay:h,fill:0==h?"both":"forwards"};y&&(O.easing=y);const N=new Map,$=E.filter(ve=>ve instanceof KA);(function jF(t,n){return 0===t||0===n})(a,h)&&$.forEach(ve=>{ve.currentSnapshot.forEach((Oe,He)=>N.set(He,Oe))});let J=function NF(t){return t.length?t[0]instanceof Map?t:t.map(n=>OA(n)):[]}(i).map(ve=>Cp(ve));J=function UF(t,n,i){if(i.size&&n.length){let a=n[0],h=[];if(i.forEach((y,E)=>{a.has(E)||h.push(E),a.set(E,y)}),h.length)for(let y=1;y<n.length;y++){let E=n[y];h.forEach(D=>E.set(D,FA(t,D)))}}return n}(n,J,N);const we=function Pz(t,n){let i=null,a=null;return Array.isArray(n)&&n.length?(i=XS(n[0]),n.length>1&&(a=XS(n[n.length-1]))):n instanceof Map&&(i=XS(n)),i||a?new Rz(t,i,a):null}(n,J);return new KA(n,J,O,we)}}let kz=(()=>{class t extends mA{constructor(i,a){super(),this._nextAnimationId=0,this._renderer=i.createRenderer(a.body,{id:"0",encapsulation:Vo.None,styles:[],data:{animation:[]}})}build(i){const a=this._nextAnimationId.toString();this._nextAnimationId++;const h=Array.isArray(i)?yA(i):i;return QA(this._renderer,null,a,"register",[h]),new Fz(a,this._renderer)}static{this.\u0275fac=function(a){return new(a||t)(gt(rp),gt(br))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();class Fz extends Xk{constructor(n,i){super(),this._id=n,this._renderer=i}create(n,i){return new zz(this._id,n,i||{},this._renderer)}}class zz{constructor(n,i,a,h){this.id=n,this.element=i,this._renderer=h,this.parentPlayer=null,this._started=!1,this.totalTime=0,this._command("create",a)}_listen(n,i){return this._renderer.listen(this.element,`@@${this.id}:${n}`,i)}_command(n,...i){return QA(this._renderer,this.element,this.id,n,i)}onDone(n){this._listen("done",n)}onStart(n){this._listen("start",n)}onDestroy(n){this._listen("destroy",n)}init(){this._command("init")}hasStarted(){return this._started}play(){this._command("play"),this._started=!0}pause(){this._command("pause")}restart(){this._command("restart")}finish(){this._command("finish")}destroy(){this._command("destroy")}reset(){this._command("reset"),this._started=!1}setPosition(n){this._command("setPosition",n)}getPosition(){return this._renderer.engine.players[+this.id]?.getPosition()??0}}function QA(t,n,i,a,h){return t.setProperty(n,`@@${i}:${a}`,h)}const JA="@.disabled";let Nz=(()=>{class t{constructor(i,a,h){this.delegate=i,this.engine=a,this._zone=h,this._currentId=0,this._microtaskId=1,this._animationCallbacksBuffer=[],this._rendererCache=new Map,this._cdRecurDepth=0,a.onRemovalComplete=(y,E)=>{const D=E?.parentNode(y);D&&E.removeChild(D,y)}}createRenderer(i,a){const y=this.delegate.createRenderer(i,a);if(!(i&&a&&a.data&&a.data.animation)){let $=this._rendererCache.get(y);return $||($=new eM("",y,this.engine,()=>this._rendererCache.delete(y)),this._rendererCache.set(y,$)),$}const E=a.id,D=a.id+"-"+this._currentId;this._currentId++,this.engine.register(D,i);const O=$=>{Array.isArray($)?$.forEach(O):this.engine.registerTrigger(E,D,i,$.name,$)};return a.data.animation.forEach(O),new Bz(this,D,y,this.engine)}begin(){this._cdRecurDepth++,this.delegate.begin&&this.delegate.begin()}_scheduleCountTask(){queueMicrotask(()=>{this._microtaskId++})}scheduleListenerCallback(i,a,h){i>=0&&i<this._microtaskId?this._zone.run(()=>a(h)):(0==this._animationCallbacksBuffer.length&&queueMicrotask(()=>{this._zone.run(()=>{this._animationCallbacksBuffer.forEach(y=>{const[E,D]=y;E(D)}),this._animationCallbacksBuffer=[]})}),this._animationCallbacksBuffer.push([a,h]))}end(){this._cdRecurDepth--,0==this._cdRecurDepth&&this._zone.runOutsideAngular(()=>{this._scheduleCountTask(),this.engine.flush(this._microtaskId)}),this.delegate.end&&this.delegate.end()}whenRenderingDone(){return this.engine.whenRenderingDone()}static{this.\u0275fac=function(a){return new(a||t)(gt(rp),gt(Dw),gt(Ei))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();class eM{constructor(n,i,a,h){this.namespaceId=n,this.delegate=i,this.engine=a,this._onDestroy=h}get data(){return this.delegate.data}destroyNode(n){this.delegate.destroyNode?.(n)}destroy(){this.engine.destroy(this.namespaceId,this.delegate),this.engine.afterFlushAnimationsDone(()=>{queueMicrotask(()=>{this.delegate.destroy()})}),this._onDestroy?.()}createElement(n,i){return this.delegate.createElement(n,i)}createComment(n){return this.delegate.createComment(n)}createText(n){return this.delegate.createText(n)}appendChild(n,i){this.delegate.appendChild(n,i),this.engine.onInsert(this.namespaceId,i,n,!1)}insertBefore(n,i,a,h=!0){this.delegate.insertBefore(n,i,a),this.engine.onInsert(this.namespaceId,i,n,h)}removeChild(n,i,a){this.engine.onRemove(this.namespaceId,i,this.delegate)}selectRootElement(n,i){return this.delegate.selectRootElement(n,i)}parentNode(n){return this.delegate.parentNode(n)}nextSibling(n){return this.delegate.nextSibling(n)}setAttribute(n,i,a,h){this.delegate.setAttribute(n,i,a,h)}removeAttribute(n,i,a){this.delegate.removeAttribute(n,i,a)}addClass(n,i){this.delegate.addClass(n,i)}removeClass(n,i){this.delegate.removeClass(n,i)}setStyle(n,i,a,h){this.delegate.setStyle(n,i,a,h)}removeStyle(n,i,a){this.delegate.removeStyle(n,i,a)}setProperty(n,i,a){"@"==i.charAt(0)&&i==JA?this.disableAnimations(n,!!a):this.delegate.setProperty(n,i,a)}setValue(n,i){this.delegate.setValue(n,i)}listen(n,i,a){return this.delegate.listen(n,i,a)}disableAnimations(n,i){this.engine.disableAnimations(n,i)}}class Bz extends eM{constructor(n,i,a,h,y){super(i,a,h,y),this.factory=n,this.namespaceId=i}setProperty(n,i,a){"@"==i.charAt(0)?"."==i.charAt(1)&&i==JA?this.disableAnimations(n,a=void 0===a||!!a):this.engine.process(this.namespaceId,n,i.slice(1),a):this.delegate.setProperty(n,i,a)}listen(n,i,a){if("@"==i.charAt(0)){const h=function Vz(t){switch(t){case"body":return document.body;case"document":return document;case"window":return window;default:return t}}(n);let y=i.slice(1),E="";return"@"!=y.charAt(0)&&([y,E]=function jz(t){const n=t.indexOf(".");return[t.substring(0,n),t.slice(n+1)]}(y)),this.engine.listen(this.namespaceId,h,y,E,D=>{this.factory.scheduleListenerCallback(D._data||-1,a,D)})}return this.delegate.listen(n,i,a)}}const tM=[{provide:mA,useClass:kz},{provide:HS,useFactory:function Hz(){return new lz}},{provide:Dw,useClass:(()=>{class t extends Dw{constructor(i,a,h,y){super(i.body,a,h)}ngOnDestroy(){this.flush()}static{this.\u0275fac=function(a){return new(a||t)(gt(br),gt(RS),gt(HS),gt(Tg))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})()},{provide:rp,useFactory:function Gz(t,n,i){return new Nz(t,n,i)},deps:[ES,Dw,Ei]}],YS=[{provide:RS,useFactory:()=>new Lz},{provide:Um,useValue:"BrowserAnimations"},...tM],nM=[{provide:RS,useClass:MA},{provide:Um,useValue:"NoopAnimations"},...tM];let $z=(()=>{class t{static withConfig(i){return{ngModule:t,providers:i.disableAnimations?nM:YS}}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({providers:YS,imports:[dA]})}}return t})();function iM(t,n=0){return function qz(t){return!isNaN(parseFloat(t))&&!isNaN(Number(t))}(t)?Number(t):n}function Cw(t){return Array.isArray(t)?t:[t]}function Wo(t){return null==t?"":"string"==typeof t?t:`${t}px`}function Zy(t){return t instanceof ga?t.nativeElement:t}const{isArray:Wz}=Array;function rM(t){return js(n=>function Zz(t,n){return Wz(n)?t(...n):t(n)}(t,n))}const Xz=["addListener","removeListener"],Yz=["addEventListener","removeEventListener"],Kz=["on","off"];function KS(t,n,i,a){if(Yi(i)&&(a=i,i=void 0),a)return KS(t,n,i).pipe(rM(a));const[h,y]=function eN(t){return Yi(t.addEventListener)&&Yi(t.removeEventListener)}(t)?Yz.map(E=>D=>t[E](n,D,i)):function Qz(t){return Yi(t.addListener)&&Yi(t.removeListener)}(t)?Xz.map(oM(t,n)):function Jz(t){return Yi(t.on)&&Yi(t.off)}(t)?Kz.map(oM(t,n)):[];if(!h&&Pn(t))return yn(E=>KS(E,n,i))(Ae(t));if(!h)throw new TypeError("Invalid event target");return new qi(E=>{const D=(...O)=>E.next(1<O.length?O:O[0]);return h(D),()=>y(D)})}function oM(t,n){return i=>a=>t[i](n,a)}class tN extends Ki{constructor(n,i){super()}schedule(n,i=0){return this}}const Aw={setInterval(t,n,...i){const{delegate:a}=Aw;return a?.setInterval?a.setInterval(t,n,...i):setInterval(t,n,...i)},clearInterval(t){const{delegate:n}=Aw;return(n?.clearInterval||clearInterval)(t)},delegate:void 0};class QS extends tN{constructor(n,i){super(n,i),this.scheduler=n,this.work=i,this.pending=!1}schedule(n,i=0){var a;if(this.closed)return this;this.state=n;const h=this.id,y=this.scheduler;return null!=h&&(this.id=this.recycleAsyncId(y,h,i)),this.pending=!0,this.delay=i,this.id=null!==(a=this.id)&&void 0!==a?a:this.requestAsyncId(y,this.id,i),this}requestAsyncId(n,i,a=0){return Aw.setInterval(n.flush.bind(n,this),a)}recycleAsyncId(n,i,a=0){if(null!=a&&this.delay===a&&!1===this.pending)return i;null!=i&&Aw.clearInterval(i)}execute(n,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;const a=this._execute(n,i);if(a)return a;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(n,i){let h,a=!1;try{this.work(n)}catch(y){a=!0,h=y||new Error("Scheduled action threw falsy error")}if(a)return this.unsubscribe(),h}unsubscribe(){if(!this.closed){const{id:n,scheduler:i}=this,{actions:a}=i;this.work=this.state=this.scheduler=null,this.pending=!1,u(a,this),null!=n&&(this.id=this.recycleAsyncId(i,n,null)),this.delay=null,super.unsubscribe()}}}const Ix={schedule(t){let n=requestAnimationFrame,i=cancelAnimationFrame;const{delegate:a}=Ix;a&&(n=a.requestAnimationFrame,i=a.cancelAnimationFrame);const h=n(y=>{i=void 0,t(y)});return new Ki(()=>i?.(h))},requestAnimationFrame(...t){const{delegate:n}=Ix;return(n?.requestAnimationFrame||requestAnimationFrame)(...t)},cancelAnimationFrame(...t){const{delegate:n}=Ix;return(n?.cancelAnimationFrame||cancelAnimationFrame)(...t)},delegate:void 0},sM={now:()=>(sM.delegate||Date).now(),delegate:void 0};class Cx{constructor(n,i=Cx.now){this.schedulerActionCtor=n,this.now=i}schedule(n,i=0,a){return new this.schedulerActionCtor(this,n).schedule(a,i)}}Cx.now=sM.now;class JS extends Cx{constructor(n,i=Cx.now){super(n,i),this.actions=[],this._active=!1}flush(n){const{actions:i}=this;if(this._active)return void i.push(n);let a;this._active=!0;do{if(a=n.execute(n.state,n.delay))break}while(n=i.shift());if(this._active=!1,a){for(;n=i.shift();)n.unsubscribe();throw a}}}new class iN extends JS{flush(n){let i;this._active=!0,n?i=n.id:(i=this._scheduled,this._scheduled=void 0);const{actions:a}=this;let h;n=n||a.shift();do{if(h=n.execute(n.state,n.delay))break}while((n=a[0])&&n.id===i&&a.shift());if(this._active=!1,h){for(;(n=a[0])&&n.id===i&&a.shift();)n.unsubscribe();throw h}}}(class nN extends QS{constructor(n,i){super(n,i),this.scheduler=n,this.work=i}requestAsyncId(n,i,a=0){return null!==a&&a>0?super.requestAsyncId(n,i,a):(n.actions.push(this),n._scheduled||(n._scheduled=Ix.requestAnimationFrame(()=>n.flush(void 0))))}recycleAsyncId(n,i,a=0){var h;if(null!=a?a>0:this.delay>0)return super.recycleAsyncId(n,i,a);const{actions:y}=n;null!=i&&i===n._scheduled&&(null===(h=y[y.length-1])||void 0===h?void 0:h.id)!==i&&(Ix.cancelAnimationFrame(i),n._scheduled=void 0)}});let eD,oN=1;const Mw={};function aM(t){return t in Mw&&(delete Mw[t],!0)}const sN={setImmediate(t){const n=oN++;return Mw[n]=!0,eD||(eD=Promise.resolve()),eD.then(()=>aM(n)&&t()),n},clearImmediate(t){aM(t)}},{setImmediate:aN,clearImmediate:lN}=sN,Pw={setImmediate(...t){const{delegate:n}=Pw;return(n?.setImmediate||aN)(...t)},clearImmediate(t){const{delegate:n}=Pw;return(n?.clearImmediate||lN)(t)},delegate:void 0},tD=(new class uN extends JS{flush(n){this._active=!0;const i=this._scheduled;this._scheduled=void 0;const{actions:a}=this;let h;n=n||a.shift();do{if(h=n.execute(n.state,n.delay))break}while((n=a[0])&&n.id===i&&a.shift());if(this._active=!1,h){for(;(n=a[0])&&n.id===i&&a.shift();)n.unsubscribe();throw h}}}(class cN extends QS{constructor(n,i){super(n,i),this.scheduler=n,this.work=i}requestAsyncId(n,i,a=0){return null!==a&&a>0?super.requestAsyncId(n,i,a):(n.actions.push(this),n._scheduled||(n._scheduled=Pw.setImmediate(n.flush.bind(n,void 0))))}recycleAsyncId(n,i,a=0){var h;if(null!=a?a>0:this.delay>0)return super.recycleAsyncId(n,i,a);const{actions:y}=n;null!=i&&(null===(h=y[y.length-1])||void 0===h?void 0:h.id)!==i&&(Pw.clearImmediate(i),n._scheduled===i&&(n._scheduled=void 0))}}),new JS(QS)),hN=tD;function lM(t,n=tD){return function fN(t){return yi((n,i)=>{let a=!1,h=null,y=null,E=!1;const D=()=>{if(y?.unsubscribe(),y=null,a){a=!1;const N=h;h=null,i.next(N)}E&&i.complete()},O=()=>{y=null,E&&i.complete()};n.subscribe(er(i,N=>{a=!0,h=N,y||Ae(t(N)).subscribe(y=er(i,D,O))},()=>{E=!0,(!a||!y||y.closed)&&i.complete()}))})}(()=>function mN(t=0,n,i=hN){let a=-1;return null!=n&&(Bn(n)?i=n:a=n),new qi(h=>{let y=function pN(t){return t instanceof Date&&!isNaN(t)}(t)?+t-i.now():t;y<0&&(y=0);let E=0;return i.schedule(function(){h.closed||(h.next(E++),0<=a?this.schedule(void 0,a):h.complete())},y)})}(t,n))}function Ap(t,n){return yi((i,a)=>{let h=0;i.subscribe(er(a,y=>t.call(n,y,h++)&&a.next(y)))})}let nD;try{nD=typeof Intl<"u"&&Intl.v8BreakIterator}catch{nD=!1}let Ax,Mg,iD,Sd=(()=>{class t{constructor(i){this._platformId=i,this.isBrowser=this._platformId?function YL(t){return t===WC}(this._platformId):"object"==typeof document&&!!document,this.EDGE=this.isBrowser&&/(edge)/i.test(navigator.userAgent),this.TRIDENT=this.isBrowser&&/(msie|trident)/i.test(navigator.userAgent),this.BLINK=this.isBrowser&&!(!window.chrome&&!nD)&&typeof CSS<"u"&&!this.EDGE&&!this.TRIDENT,this.WEBKIT=this.isBrowser&&/AppleWebKit/i.test(navigator.userAgent)&&!this.BLINK&&!this.EDGE&&!this.TRIDENT,this.IOS=this.isBrowser&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!("MSStream"in window),this.FIREFOX=this.isBrowser&&/(firefox|minefield)/i.test(navigator.userAgent),this.ANDROID=this.isBrowser&&/android/i.test(navigator.userAgent)&&!this.TRIDENT,this.SAFARI=this.isBrowser&&/safari/i.test(navigator.userAgent)&&this.WEBKIT}static{this.\u0275fac=function(a){return new(a||t)(gt(cd))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();function Rw(t){return function gN(){if(null==Ax&&typeof window<"u")try{window.addEventListener("test",null,Object.defineProperty({},"passive",{get:()=>Ax=!0}))}finally{Ax=Ax||!1}return Ax}()?t:!!t.capture}function _N(){if(null==Mg){if("object"!=typeof document||!document||"function"!=typeof Element||!Element)return Mg=!1,Mg;if("scrollBehavior"in document.documentElement.style)Mg=!0;else{const t=Element.prototype.scrollTo;Mg=!!t&&!/\{\s*\[native code\]\s*\}/.test(t.toString())}}return Mg}function rD(){let t=typeof document<"u"&&document?document.activeElement:null;for(;t&&t.shadowRoot;){const n=t.shadowRoot.activeElement;if(n===t)break;t=n}return t}function Mp(t){return t.composedPath?t.composedPath()[0]:t.target}function oD(){return typeof __karma__<"u"&&!!__karma__||typeof jasmine<"u"&&!!jasmine||typeof jest<"u"&&!!jest||typeof Mocha<"u"&&!!Mocha}const xN=new Jt("cdk-dir-doc",{providedIn:"root",factory:function bN(){return di(br)}}),wN=/^(ar|ckb|dv|he|iw|fa|nqo|ps|sd|ug|ur|yi|.*[-_](Adlm|Arab|Hebr|Nkoo|Rohg|Thaa))(?!.*[-_](Latn|Cyrl)($|-|_))($|-|_)/i;let sD=(()=>{class t{constructor(i){this.value="ltr",this.change=new ea,i&&(this.value=function EN(t){const n=t?.toLowerCase()||"";return"auto"===n&&typeof navigator<"u"&&navigator?.language?wN.test(navigator.language)?"rtl":"ltr":"rtl"===n?"rtl":"ltr"}((i.body?i.body.dir:null)||(i.documentElement?i.documentElement.dir:null)||"ltr"))}ngOnDestroy(){this.change.complete()}static{this.\u0275fac=function(a){return new(a||t)(gt(xN,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),Mx=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({})}}return t})(),SN=(()=>{class t{constructor(i,a,h){this._ngZone=i,this._platform=a,this._scrolled=new Vi,this._globalSubscription=null,this._scrolledCount=0,this.scrollContainers=new Map,this._document=h}register(i){this.scrollContainers.has(i)||this.scrollContainers.set(i,i.elementScrolled().subscribe(()=>this._scrolled.next(i)))}deregister(i){const a=this.scrollContainers.get(i);a&&(a.unsubscribe(),this.scrollContainers.delete(i))}scrolled(i=20){return this._platform.isBrowser?new qi(a=>{this._globalSubscription||this._addGlobalListener();const h=i>0?this._scrolled.pipe(lM(i)).subscribe(a):this._scrolled.subscribe(a);return this._scrolledCount++,()=>{h.unsubscribe(),this._scrolledCount--,this._scrolledCount||this._removeGlobalListener()}}):gc()}ngOnDestroy(){this._removeGlobalListener(),this.scrollContainers.forEach((i,a)=>this.deregister(a)),this._scrolled.complete()}ancestorScrolled(i,a){const h=this.getAncestorScrollContainers(i);return this.scrolled(a).pipe(Ap(y=>!y||h.indexOf(y)>-1))}getAncestorScrollContainers(i){const a=[];return this.scrollContainers.forEach((h,y)=>{this._scrollableContainsElement(y,i)&&a.push(y)}),a}_getWindow(){return this._document.defaultView||window}_scrollableContainsElement(i,a){let h=Zy(a),y=i.getElementRef().nativeElement;do{if(h==y)return!0}while(h=h.parentElement);return!1}_addGlobalListener(){this._globalSubscription=this._ngZone.runOutsideAngular(()=>KS(this._getWindow().document,"scroll").subscribe(()=>this._scrolled.next()))}_removeGlobalListener(){this._globalSubscription&&(this._globalSubscription.unsubscribe(),this._globalSubscription=null)}static{this.\u0275fac=function(a){return new(a||t)(gt(Ei),gt(Sd),gt(br,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),uM=(()=>{class t{constructor(i,a,h){this._platform=i,this._change=new Vi,this._changeListener=y=>{this._change.next(y)},this._document=h,a.runOutsideAngular(()=>{if(i.isBrowser){const y=this._getWindow();y.addEventListener("resize",this._changeListener),y.addEventListener("orientationchange",this._changeListener)}this.change().subscribe(()=>this._viewportSize=null)})}ngOnDestroy(){if(this._platform.isBrowser){const i=this._getWindow();i.removeEventListener("resize",this._changeListener),i.removeEventListener("orientationchange",this._changeListener)}this._change.complete()}getViewportSize(){this._viewportSize||this._updateViewportSize();const i={width:this._viewportSize.width,height:this._viewportSize.height};return this._platform.isBrowser||(this._viewportSize=null),i}getViewportRect(){const i=this.getViewportScrollPosition(),{width:a,height:h}=this.getViewportSize();return{top:i.top,left:i.left,bottom:i.top+h,right:i.left+a,height:h,width:a}}getViewportScrollPosition(){if(!this._platform.isBrowser)return{top:0,left:0};const i=this._document,a=this._getWindow(),h=i.documentElement,y=h.getBoundingClientRect();return{top:-y.top||i.body.scrollTop||a.scrollY||h.scrollTop||0,left:-y.left||i.body.scrollLeft||a.scrollX||h.scrollLeft||0}}change(i=20){return i>0?this._change.pipe(lM(i)):this._change}_getWindow(){return this._document.defaultView||window}_updateViewportSize(){const i=this._getWindow();this._viewportSize=this._platform.isBrowser?{width:i.innerWidth,height:i.innerHeight}:{width:0,height:0}}static{this.\u0275fac=function(a){return new(a||t)(gt(Sd),gt(Ei),gt(br,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),dM=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({})}}return t})(),hM=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({imports:[Mx,dM,Mx,dM]})}}return t})();function Yy(t){return t<=0?()=>wr:yi((n,i)=>{let a=0;n.subscribe(er(i,h=>{++a<=t&&(i.next(h),t<=a&&i.complete())}))})}function aD(t){return yi((n,i)=>{Ae(t).subscribe(er(i,()=>i.complete(),fn)),!i.closed&&n.subscribe(i)})}class lD{attach(n){return this._attachedHost=n,n.attach(this)}detach(){let n=this._attachedHost;null!=n&&(this._attachedHost=null,n.detach())}get isAttached(){return null!=this._attachedHost}setAttachedHost(n){this._attachedHost=n}}class cD extends lD{constructor(n,i,a,h,y){super(),this.component=n,this.viewContainerRef=i,this.injector=a,this.componentFactoryResolver=h,this.projectableNodes=y}}class fM extends lD{constructor(n,i,a,h){super(),this.templateRef=n,this.viewContainerRef=i,this.context=a,this.injector=h}get origin(){return this.templateRef.elementRef}attach(n,i=this.context){return this.context=i,super.attach(n)}detach(){return this.context=void 0,super.detach()}}class IN extends lD{constructor(n){super(),this.element=n instanceof ga?n.nativeElement:n}}class uD{constructor(){this._isDisposed=!1,this.attachDomPortal=null}hasAttached(){return!!this._attachedPortal}attach(n){return n instanceof cD?(this._attachedPortal=n,this.attachComponentPortal(n)):n instanceof fM?(this._attachedPortal=n,this.attachTemplatePortal(n)):this.attachDomPortal&&n instanceof IN?(this._attachedPortal=n,this.attachDomPortal(n)):void 0}detach(){this._attachedPortal&&(this._attachedPortal.setAttachedHost(null),this._attachedPortal=null),this._invokeDisposeFn()}dispose(){this.hasAttached()&&this.detach(),this._invokeDisposeFn(),this._isDisposed=!0}setDisposeFn(n){this._disposeFn=n}_invokeDisposeFn(){this._disposeFn&&(this._disposeFn(),this._disposeFn=null)}}class CN extends uD{constructor(n,i,a,h,y){super(),this.outletElement=n,this._componentFactoryResolver=i,this._appRef=a,this._defaultInjector=h,this.attachDomPortal=E=>{const D=E.element,O=this._document.createComment("dom-portal");D.parentNode.insertBefore(O,D),this.outletElement.appendChild(D),this._attachedPortal=E,super.setDisposeFn(()=>{O.parentNode&&O.parentNode.replaceChild(D,O)})},this._document=y}attachComponentPortal(n){const a=(n.componentFactoryResolver||this._componentFactoryResolver).resolveComponentFactory(n.component);let h;return n.viewContainerRef?(h=n.viewContainerRef.createComponent(a,n.viewContainerRef.length,n.injector||n.viewContainerRef.injector,n.projectableNodes||void 0),this.setDisposeFn(()=>h.destroy())):(h=a.create(n.injector||this._defaultInjector||cs.NULL),this._appRef.attachView(h.hostView),this.setDisposeFn(()=>{this._appRef.viewCount>0&&this._appRef.detachView(h.hostView),h.destroy()})),this.outletElement.appendChild(this._getComponentRootNode(h)),this._attachedPortal=n,h}attachTemplatePortal(n){let i=n.viewContainerRef,a=i.createEmbeddedView(n.templateRef,n.context,{injector:n.injector});return a.rootNodes.forEach(h=>this.outletElement.appendChild(h)),a.detectChanges(),this.setDisposeFn(()=>{let h=i.indexOf(a);-1!==h&&i.remove(h)}),this._attachedPortal=n,a}dispose(){super.dispose(),this.outletElement.remove()}_getComponentRootNode(n){return n.hostView.rootNodes[0]}}let dD=(()=>{class t extends uD{constructor(i,a,h){super(),this._componentFactoryResolver=i,this._viewContainerRef=a,this._isInitialized=!1,this.attached=new ea,this.attachDomPortal=y=>{const E=y.element,D=this._document.createComment("dom-portal");y.setAttachedHost(this),E.parentNode.insertBefore(D,E),this._getRootNode().appendChild(E),this._attachedPortal=y,super.setDisposeFn(()=>{D.parentNode&&D.parentNode.replaceChild(E,D)})},this._document=h}get portal(){return this._attachedPortal}set portal(i){this.hasAttached()&&!i&&!this._isInitialized||(this.hasAttached()&&super.detach(),i&&super.attach(i),this._attachedPortal=i||null)}get attachedRef(){return this._attachedRef}ngOnInit(){this._isInitialized=!0}ngOnDestroy(){super.dispose(),this._attachedRef=this._attachedPortal=null}attachComponentPortal(i){i.setAttachedHost(this);const a=null!=i.viewContainerRef?i.viewContainerRef:this._viewContainerRef,y=(i.componentFactoryResolver||this._componentFactoryResolver).resolveComponentFactory(i.component),E=a.createComponent(y,a.length,i.injector||a.injector,i.projectableNodes||void 0);return a!==this._viewContainerRef&&this._getRootNode().appendChild(E.hostView.rootNodes[0]),super.setDisposeFn(()=>E.destroy()),this._attachedPortal=i,this._attachedRef=E,this.attached.emit(E),E}attachTemplatePortal(i){i.setAttachedHost(this);const a=this._viewContainerRef.createEmbeddedView(i.templateRef,i.context,{injector:i.injector});return super.setDisposeFn(()=>this._viewContainerRef.clear()),this._attachedPortal=i,this._attachedRef=a,this.attached.emit(a),a}_getRootNode(){const i=this._viewContainerRef.element.nativeElement;return i.nodeType===i.ELEMENT_NODE?i:i.parentNode}static{this.\u0275fac=function(a){return new(a||t)(sn(np),sn(mu),sn(br))}}static{this.\u0275dir=Kr({type:t,selectors:[["","cdkPortalOutlet",""]],inputs:{portal:["cdkPortalOutlet","portal"]},outputs:{attached:"attached"},exportAs:["cdkPortalOutlet"],features:[cu]})}}return t})(),Lw=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({})}}return t})();const pM=_N();class AN{constructor(n,i){this._viewportRuler=n,this._previousHTMLStyles={top:"",left:""},this._isEnabled=!1,this._document=i}attach(){}enable(){if(this._canBeEnabled()){const n=this._document.documentElement;this._previousScrollPosition=this._viewportRuler.getViewportScrollPosition(),this._previousHTMLStyles.left=n.style.left||"",this._previousHTMLStyles.top=n.style.top||"",n.style.left=Wo(-this._previousScrollPosition.left),n.style.top=Wo(-this._previousScrollPosition.top),n.classList.add("cdk-global-scrollblock"),this._isEnabled=!0}}disable(){if(this._isEnabled){const n=this._document.documentElement,a=n.style,h=this._document.body.style,y=a.scrollBehavior||"",E=h.scrollBehavior||"";this._isEnabled=!1,a.left=this._previousHTMLStyles.left,a.top=this._previousHTMLStyles.top,n.classList.remove("cdk-global-scrollblock"),pM&&(a.scrollBehavior=h.scrollBehavior="auto"),window.scroll(this._previousScrollPosition.left,this._previousScrollPosition.top),pM&&(a.scrollBehavior=y,h.scrollBehavior=E)}}_canBeEnabled(){if(this._document.documentElement.classList.contains("cdk-global-scrollblock")||this._isEnabled)return!1;const i=this._document.body,a=this._viewportRuler.getViewportSize();return i.scrollHeight>a.height||i.scrollWidth>a.width}}class MN{constructor(n,i,a,h){this._scrollDispatcher=n,this._ngZone=i,this._viewportRuler=a,this._config=h,this._scrollSubscription=null,this._detach=()=>{this.disable(),this._overlayRef.hasAttached()&&this._ngZone.run(()=>this._overlayRef.detach())}}attach(n){this._overlayRef=n}enable(){if(this._scrollSubscription)return;const n=this._scrollDispatcher.scrolled(0).pipe(Ap(i=>!i||!this._overlayRef.overlayElement.contains(i.getElementRef().nativeElement)));this._config&&this._config.threshold&&this._config.threshold>1?(this._initialScrollPosition=this._viewportRuler.getViewportScrollPosition().top,this._scrollSubscription=n.subscribe(()=>{const i=this._viewportRuler.getViewportScrollPosition().top;Math.abs(i-this._initialScrollPosition)>this._config.threshold?this._detach():this._overlayRef.updatePosition()})):this._scrollSubscription=n.subscribe(this._detach)}disable(){this._scrollSubscription&&(this._scrollSubscription.unsubscribe(),this._scrollSubscription=null)}detach(){this.disable(),this._overlayRef=null}}class mM{enable(){}disable(){}attach(){}}function hD(t,n){return n.some(i=>t.bottom<i.top||t.top>i.bottom||t.right<i.left||t.left>i.right)}function gM(t,n){return n.some(i=>t.top<i.top||t.bottom>i.bottom||t.left<i.left||t.right>i.right)}class PN{constructor(n,i,a,h){this._scrollDispatcher=n,this._viewportRuler=i,this._ngZone=a,this._config=h,this._scrollSubscription=null}attach(n){this._overlayRef=n}enable(){this._scrollSubscription||(this._scrollSubscription=this._scrollDispatcher.scrolled(this._config?this._config.scrollThrottle:0).subscribe(()=>{if(this._overlayRef.updatePosition(),this._config&&this._config.autoClose){const i=this._overlayRef.overlayElement.getBoundingClientRect(),{width:a,height:h}=this._viewportRuler.getViewportSize();hD(i,[{width:a,height:h,bottom:h,right:a,top:0,left:0}])&&(this.disable(),this._ngZone.run(()=>this._overlayRef.detach()))}}))}disable(){this._scrollSubscription&&(this._scrollSubscription.unsubscribe(),this._scrollSubscription=null)}detach(){this.disable(),this._overlayRef=null}}let RN=(()=>{class t{constructor(i,a,h,y){this._scrollDispatcher=i,this._viewportRuler=a,this._ngZone=h,this.noop=()=>new mM,this.close=E=>new MN(this._scrollDispatcher,this._ngZone,this._viewportRuler,E),this.block=()=>new AN(this._viewportRuler,this._document),this.reposition=E=>new PN(this._scrollDispatcher,this._viewportRuler,this._ngZone,E),this._document=y}static{this.\u0275fac=function(a){return new(a||t)(gt(SN),gt(uM),gt(Ei),gt(br))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();class _M{constructor(n){if(this.scrollStrategy=new mM,this.panelClass="",this.hasBackdrop=!1,this.backdropClass="cdk-overlay-dark-backdrop",this.disposeOnNavigation=!1,n){const i=Object.keys(n);for(const a of i)void 0!==n[a]&&(this[a]=n[a])}}}class ON{constructor(n,i){this.connectionPair=n,this.scrollableViewProperties=i}}let yM=(()=>{class t{constructor(i){this._attachedOverlays=[],this._document=i}ngOnDestroy(){this.detach()}add(i){this.remove(i),this._attachedOverlays.push(i)}remove(i){const a=this._attachedOverlays.indexOf(i);a>-1&&this._attachedOverlays.splice(a,1),0===this._attachedOverlays.length&&this.detach()}static{this.\u0275fac=function(a){return new(a||t)(gt(br))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),LN=(()=>{class t extends yM{constructor(i,a){super(i),this._ngZone=a,this._keydownListener=h=>{const y=this._attachedOverlays;for(let E=y.length-1;E>-1;E--)if(y[E]._keydownEvents.observers.length>0){const D=y[E]._keydownEvents;this._ngZone?this._ngZone.run(()=>D.next(h)):D.next(h);break}}}add(i){super.add(i),this._isAttached||(this._ngZone?this._ngZone.runOutsideAngular(()=>this._document.body.addEventListener("keydown",this._keydownListener)):this._document.body.addEventListener("keydown",this._keydownListener),this._isAttached=!0)}detach(){this._isAttached&&(this._document.body.removeEventListener("keydown",this._keydownListener),this._isAttached=!1)}static{this.\u0275fac=function(a){return new(a||t)(gt(br),gt(Ei,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),kN=(()=>{class t extends yM{constructor(i,a,h){super(i),this._platform=a,this._ngZone=h,this._cursorStyleIsSet=!1,this._pointerDownListener=y=>{this._pointerDownEventTarget=Mp(y)},this._clickListener=y=>{const E=Mp(y),D="click"===y.type&&this._pointerDownEventTarget?this._pointerDownEventTarget:E;this._pointerDownEventTarget=null;const O=this._attachedOverlays.slice();for(let N=O.length-1;N>-1;N--){const $=O[N];if($._outsidePointerEvents.observers.length<1||!$.hasAttached())continue;if($.overlayElement.contains(E)||$.overlayElement.contains(D))break;const J=$._outsidePointerEvents;this._ngZone?this._ngZone.run(()=>J.next(y)):J.next(y)}}}add(i){if(super.add(i),!this._isAttached){const a=this._document.body;this._ngZone?this._ngZone.runOutsideAngular(()=>this._addEventListeners(a)):this._addEventListeners(a),this._platform.IOS&&!this._cursorStyleIsSet&&(this._cursorOriginalValue=a.style.cursor,a.style.cursor="pointer",this._cursorStyleIsSet=!0),this._isAttached=!0}}detach(){if(this._isAttached){const i=this._document.body;i.removeEventListener("pointerdown",this._pointerDownListener,!0),i.removeEventListener("click",this._clickListener,!0),i.removeEventListener("auxclick",this._clickListener,!0),i.removeEventListener("contextmenu",this._clickListener,!0),this._platform.IOS&&this._cursorStyleIsSet&&(i.style.cursor=this._cursorOriginalValue,this._cursorStyleIsSet=!1),this._isAttached=!1}}_addEventListeners(i){i.addEventListener("pointerdown",this._pointerDownListener,!0),i.addEventListener("click",this._clickListener,!0),i.addEventListener("auxclick",this._clickListener,!0),i.addEventListener("contextmenu",this._clickListener,!0)}static{this.\u0275fac=function(a){return new(a||t)(gt(br),gt(Sd),gt(Ei,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),kw=(()=>{class t{constructor(i,a){this._platform=a,this._document=i}ngOnDestroy(){this._containerElement?.remove()}getContainerElement(){return this._containerElement||this._createContainer(),this._containerElement}_createContainer(){const i="cdk-overlay-container";if(this._platform.isBrowser||oD()){const h=this._document.querySelectorAll(`.${i}[platform="server"], .${i}[platform="test"]`);for(let y=0;y<h.length;y++)h[y].remove()}const a=this._document.createElement("div");a.classList.add(i),oD()?a.setAttribute("platform","test"):this._platform.isBrowser||a.setAttribute("platform","server"),this._document.body.appendChild(a),this._containerElement=a}static{this.\u0275fac=function(a){return new(a||t)(gt(br),gt(Sd))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();class Px{constructor(n,i,a,h,y,E,D,O,N,$=!1){this._portalOutlet=n,this._host=i,this._pane=a,this._config=h,this._ngZone=y,this._keyboardDispatcher=E,this._document=D,this._location=O,this._outsideClickDispatcher=N,this._animationsDisabled=$,this._backdropElement=null,this._backdropClick=new Vi,this._attachments=new Vi,this._detachments=new Vi,this._locationChanges=Ki.EMPTY,this._backdropClickHandler=J=>this._backdropClick.next(J),this._backdropTransitionendHandler=J=>{this._disposeBackdrop(J.target)},this._keydownEvents=new Vi,this._outsidePointerEvents=new Vi,h.scrollStrategy&&(this._scrollStrategy=h.scrollStrategy,this._scrollStrategy.attach(this)),this._positionStrategy=h.positionStrategy}get overlayElement(){return this._pane}get backdropElement(){return this._backdropElement}get hostElement(){return this._host}attach(n){!this._host.parentElement&&this._previousHostParent&&this._previousHostParent.appendChild(this._host);const i=this._portalOutlet.attach(n);return this._positionStrategy&&this._positionStrategy.attach(this),this._updateStackingOrder(),this._updateElementSize(),this._updateElementDirection(),this._scrollStrategy&&this._scrollStrategy.enable(),this._ngZone.onStable.pipe(Yy(1)).subscribe(()=>{this.hasAttached()&&this.updatePosition()}),this._togglePointerEvents(!0),this._config.hasBackdrop&&this._attachBackdrop(),this._config.panelClass&&this._toggleClasses(this._pane,this._config.panelClass,!0),this._attachments.next(),this._keyboardDispatcher.add(this),this._config.disposeOnNavigation&&(this._locationChanges=this._location.subscribe(()=>this.dispose())),this._outsideClickDispatcher.add(this),"function"==typeof i?.onDestroy&&i.onDestroy(()=>{this.hasAttached()&&this._ngZone.runOutsideAngular(()=>Promise.resolve().then(()=>this.detach()))}),i}detach(){if(!this.hasAttached())return;this.detachBackdrop(),this._togglePointerEvents(!1),this._positionStrategy&&this._positionStrategy.detach&&this._positionStrategy.detach(),this._scrollStrategy&&this._scrollStrategy.disable();const n=this._portalOutlet.detach();return this._detachments.next(),this._keyboardDispatcher.remove(this),this._detachContentWhenStable(),this._locationChanges.unsubscribe(),this._outsideClickDispatcher.remove(this),n}dispose(){const n=this.hasAttached();this._positionStrategy&&this._positionStrategy.dispose(),this._disposeScrollStrategy(),this._disposeBackdrop(this._backdropElement),this._locationChanges.unsubscribe(),this._keyboardDispatcher.remove(this),this._portalOutlet.dispose(),this._attachments.complete(),this._backdropClick.complete(),this._keydownEvents.complete(),this._outsidePointerEvents.complete(),this._outsideClickDispatcher.remove(this),this._host?.remove(),this._previousHostParent=this._pane=this._host=null,n&&this._detachments.next(),this._detachments.complete()}hasAttached(){return this._portalOutlet.hasAttached()}backdropClick(){return this._backdropClick}attachments(){return this._attachments}detachments(){return this._detachments}keydownEvents(){return this._keydownEvents}outsidePointerEvents(){return this._outsidePointerEvents}getConfig(){return this._config}updatePosition(){this._positionStrategy&&this._positionStrategy.apply()}updatePositionStrategy(n){n!==this._positionStrategy&&(this._positionStrategy&&this._positionStrategy.dispose(),this._positionStrategy=n,this.hasAttached()&&(n.attach(this),this.updatePosition()))}updateSize(n){this._config={...this._config,...n},this._updateElementSize()}setDirection(n){this._config={...this._config,direction:n},this._updateElementDirection()}addPanelClass(n){this._pane&&this._toggleClasses(this._pane,n,!0)}removePanelClass(n){this._pane&&this._toggleClasses(this._pane,n,!1)}getDirection(){const n=this._config.direction;return n?"string"==typeof n?n:n.value:"ltr"}updateScrollStrategy(n){n!==this._scrollStrategy&&(this._disposeScrollStrategy(),this._scrollStrategy=n,this.hasAttached()&&(n.attach(this),n.enable()))}_updateElementDirection(){this._host.setAttribute("dir",this.getDirection())}_updateElementSize(){if(!this._pane)return;const n=this._pane.style;n.width=Wo(this._config.width),n.height=Wo(this._config.height),n.minWidth=Wo(this._config.minWidth),n.minHeight=Wo(this._config.minHeight),n.maxWidth=Wo(this._config.maxWidth),n.maxHeight=Wo(this._config.maxHeight)}_togglePointerEvents(n){this._pane.style.pointerEvents=n?"":"none"}_attachBackdrop(){const n="cdk-overlay-backdrop-showing";this._backdropElement=this._document.createElement("div"),this._backdropElement.classList.add("cdk-overlay-backdrop"),this._animationsDisabled&&this._backdropElement.classList.add("cdk-overlay-backdrop-noop-animation"),this._config.backdropClass&&this._toggleClasses(this._backdropElement,this._config.backdropClass,!0),this._host.parentElement.insertBefore(this._backdropElement,this._host),this._backdropElement.addEventListener("click",this._backdropClickHandler),!this._animationsDisabled&&typeof requestAnimationFrame<"u"?this._ngZone.runOutsideAngular(()=>{requestAnimationFrame(()=>{this._backdropElement&&this._backdropElement.classList.add(n)})}):this._backdropElement.classList.add(n)}_updateStackingOrder(){this._host.nextSibling&&this._host.parentNode.appendChild(this._host)}detachBackdrop(){const n=this._backdropElement;if(n){if(this._animationsDisabled)return void this._disposeBackdrop(n);n.classList.remove("cdk-overlay-backdrop-showing"),this._ngZone.runOutsideAngular(()=>{n.addEventListener("transitionend",this._backdropTransitionendHandler)}),n.style.pointerEvents="none",this._backdropTimeout=this._ngZone.runOutsideAngular(()=>setTimeout(()=>{this._disposeBackdrop(n)},500))}}_toggleClasses(n,i,a){const h=Cw(i||[]).filter(y=>!!y);h.length&&(a?n.classList.add(...h):n.classList.remove(...h))}_detachContentWhenStable(){this._ngZone.runOutsideAngular(()=>{const n=this._ngZone.onStable.pipe(aD($a(this._attachments,this._detachments))).subscribe(()=>{(!this._pane||!this._host||0===this._pane.children.length)&&(this._pane&&this._config.panelClass&&this._toggleClasses(this._pane,this._config.panelClass,!1),this._host&&this._host.parentElement&&(this._previousHostParent=this._host.parentElement,this._host.remove()),n.unsubscribe())})})}_disposeScrollStrategy(){const n=this._scrollStrategy;n&&(n.disable(),n.detach&&n.detach())}_disposeBackdrop(n){n&&(n.removeEventListener("click",this._backdropClickHandler),n.removeEventListener("transitionend",this._backdropTransitionendHandler),n.remove(),this._backdropElement===n&&(this._backdropElement=null)),this._backdropTimeout&&(clearTimeout(this._backdropTimeout),this._backdropTimeout=void 0)}}const vM="cdk-overlay-connected-position-bounding-box",FN=/([A-Za-z%]+)$/;class zN{get positions(){return this._preferredPositions}constructor(n,i,a,h,y){this._viewportRuler=i,this._document=a,this._platform=h,this._overlayContainer=y,this._lastBoundingBoxSize={width:0,height:0},this._isPushed=!1,this._canPush=!0,this._growAfterOpen=!1,this._hasFlexibleDimensions=!0,this._positionLocked=!1,this._viewportMargin=0,this._scrollables=[],this._preferredPositions=[],this._positionChanges=new Vi,this._resizeSubscription=Ki.EMPTY,this._offsetX=0,this._offsetY=0,this._appliedPanelClasses=[],this.positionChanges=this._positionChanges,this.setOrigin(n)}attach(n){this._validatePositions(),n.hostElement.classList.add(vM),this._overlayRef=n,this._boundingBox=n.hostElement,this._pane=n.overlayElement,this._isDisposed=!1,this._isInitialRender=!0,this._lastPosition=null,this._resizeSubscription.unsubscribe(),this._resizeSubscription=this._viewportRuler.change().subscribe(()=>{this._isInitialRender=!0,this.apply()})}apply(){if(this._isDisposed||!this._platform.isBrowser)return;if(!this._isInitialRender&&this._positionLocked&&this._lastPosition)return void this.reapplyLastPosition();this._clearPanelClasses(),this._resetOverlayElementStyles(),this._resetBoundingBoxStyles(),this._viewportRect=this._getNarrowedViewportRect(),this._originRect=this._getOriginRect(),this._overlayRect=this._pane.getBoundingClientRect(),this._containerRect=this._overlayContainer.getContainerElement().getBoundingClientRect();const n=this._originRect,i=this._overlayRect,a=this._viewportRect,h=this._containerRect,y=[];let E;for(let D of this._preferredPositions){let O=this._getOriginPoint(n,h,D),N=this._getOverlayPoint(O,i,D),$=this._getOverlayFit(N,i,a,D);if($.isCompletelyWithinViewport)return this._isPushed=!1,void this._applyPosition(D,O);this._canFitWithFlexibleDimensions($,N,a)?y.push({position:D,origin:O,overlayRect:i,boundingBoxRect:this._calculateBoundingBoxRect(O,D)}):(!E||E.overlayFit.visibleArea<$.visibleArea)&&(E={overlayFit:$,overlayPoint:N,originPoint:O,position:D,overlayRect:i})}if(y.length){let D=null,O=-1;for(const N of y){const $=N.boundingBoxRect.width*N.boundingBoxRect.height*(N.position.weight||1);$>O&&(O=$,D=N)}return this._isPushed=!1,void this._applyPosition(D.position,D.origin)}if(this._canPush)return this._isPushed=!0,void this._applyPosition(E.position,E.originPoint);this._applyPosition(E.position,E.originPoint)}detach(){this._clearPanelClasses(),this._lastPosition=null,this._previousPushAmount=null,this._resizeSubscription.unsubscribe()}dispose(){this._isDisposed||(this._boundingBox&&Pg(this._boundingBox.style,{top:"",left:"",right:"",bottom:"",height:"",width:"",alignItems:"",justifyContent:""}),this._pane&&this._resetOverlayElementStyles(),this._overlayRef&&this._overlayRef.hostElement.classList.remove(vM),this.detach(),this._positionChanges.complete(),this._overlayRef=this._boundingBox=null,this._isDisposed=!0)}reapplyLastPosition(){if(this._isDisposed||!this._platform.isBrowser)return;const n=this._lastPosition;if(n){this._originRect=this._getOriginRect(),this._overlayRect=this._pane.getBoundingClientRect(),this._viewportRect=this._getNarrowedViewportRect(),this._containerRect=this._overlayContainer.getContainerElement().getBoundingClientRect();const i=this._getOriginPoint(this._originRect,this._containerRect,n);this._applyPosition(n,i)}else this.apply()}withScrollableContainers(n){return this._scrollables=n,this}withPositions(n){return this._preferredPositions=n,-1===n.indexOf(this._lastPosition)&&(this._lastPosition=null),this._validatePositions(),this}withViewportMargin(n){return this._viewportMargin=n,this}withFlexibleDimensions(n=!0){return this._hasFlexibleDimensions=n,this}withGrowAfterOpen(n=!0){return this._growAfterOpen=n,this}withPush(n=!0){return this._canPush=n,this}withLockedPosition(n=!0){return this._positionLocked=n,this}setOrigin(n){return this._origin=n,this}withDefaultOffsetX(n){return this._offsetX=n,this}withDefaultOffsetY(n){return this._offsetY=n,this}withTransformOriginOn(n){return this._transformOriginSelector=n,this}_getOriginPoint(n,i,a){let h,y;if("center"==a.originX)h=n.left+n.width/2;else{const E=this._isRtl()?n.right:n.left,D=this._isRtl()?n.left:n.right;h="start"==a.originX?E:D}return i.left<0&&(h-=i.left),y="center"==a.originY?n.top+n.height/2:"top"==a.originY?n.top:n.bottom,i.top<0&&(y-=i.top),{x:h,y}}_getOverlayPoint(n,i,a){let h,y;return h="center"==a.overlayX?-i.width/2:"start"===a.overlayX?this._isRtl()?-i.width:0:this._isRtl()?0:-i.width,y="center"==a.overlayY?-i.height/2:"top"==a.overlayY?0:-i.height,{x:n.x+h,y:n.y+y}}_getOverlayFit(n,i,a,h){const y=bM(i);let{x:E,y:D}=n,O=this._getOffset(h,"x"),N=this._getOffset(h,"y");O&&(E+=O),N&&(D+=N);let we=0-D,ve=D+y.height-a.height,Oe=this._subtractOverflows(y.width,0-E,E+y.width-a.width),He=this._subtractOverflows(y.height,we,ve),mt=Oe*He;return{visibleArea:mt,isCompletelyWithinViewport:y.width*y.height===mt,fitsInViewportVertically:He===y.height,fitsInViewportHorizontally:Oe==y.width}}_canFitWithFlexibleDimensions(n,i,a){if(this._hasFlexibleDimensions){const h=a.bottom-i.y,y=a.right-i.x,E=xM(this._overlayRef.getConfig().minHeight),D=xM(this._overlayRef.getConfig().minWidth);return(n.fitsInViewportVertically||null!=E&&E<=h)&&(n.fitsInViewportHorizontally||null!=D&&D<=y)}return!1}_pushOverlayOnScreen(n,i,a){if(this._previousPushAmount&&this._positionLocked)return{x:n.x+this._previousPushAmount.x,y:n.y+this._previousPushAmount.y};const h=bM(i),y=this._viewportRect,E=Math.max(n.x+h.width-y.width,0),D=Math.max(n.y+h.height-y.height,0),O=Math.max(y.top-a.top-n.y,0),N=Math.max(y.left-a.left-n.x,0);let $=0,J=0;return $=h.width<=y.width?N||-E:n.x<this._viewportMargin?y.left-a.left-n.x:0,J=h.height<=y.height?O||-D:n.y<this._viewportMargin?y.top-a.top-n.y:0,this._previousPushAmount={x:$,y:J},{x:n.x+$,y:n.y+J}}_applyPosition(n,i){if(this._setTransformOrigin(n),this._setOverlayElementStyles(i,n),this._setBoundingBoxStyles(i,n),n.panelClass&&this._addPanelClasses(n.panelClass),this._lastPosition=n,this._positionChanges.observers.length){const a=this._getScrollVisibility(),h=new ON(n,a);this._positionChanges.next(h)}this._isInitialRender=!1}_setTransformOrigin(n){if(!this._transformOriginSelector)return;const i=this._boundingBox.querySelectorAll(this._transformOriginSelector);let a,h=n.overlayY;a="center"===n.overlayX?"center":this._isRtl()?"start"===n.overlayX?"right":"left":"start"===n.overlayX?"left":"right";for(let y=0;y<i.length;y++)i[y].style.transformOrigin=`${a} ${h}`}_calculateBoundingBoxRect(n,i){const a=this._viewportRect,h=this._isRtl();let y,E,D,$,J,we;if("top"===i.overlayY)E=n.y,y=a.height-E+this._viewportMargin;else if("bottom"===i.overlayY)D=a.height-n.y+2*this._viewportMargin,y=a.height-D+this._viewportMargin;else{const ve=Math.min(a.bottom-n.y+a.top,n.y),Oe=this._lastBoundingBoxSize.height;y=2*ve,E=n.y-ve,y>Oe&&!this._isInitialRender&&!this._growAfterOpen&&(E=n.y-Oe/2)}if("end"===i.overlayX&&!h||"start"===i.overlayX&&h)we=a.width-n.x+this._viewportMargin,$=n.x-this._viewportMargin;else if("start"===i.overlayX&&!h||"end"===i.overlayX&&h)J=n.x,$=a.right-n.x;else{const ve=Math.min(a.right-n.x+a.left,n.x),Oe=this._lastBoundingBoxSize.width;$=2*ve,J=n.x-ve,$>Oe&&!this._isInitialRender&&!this._growAfterOpen&&(J=n.x-Oe/2)}return{top:E,left:J,bottom:D,right:we,width:$,height:y}}_setBoundingBoxStyles(n,i){const a=this._calculateBoundingBoxRect(n,i);!this._isInitialRender&&!this._growAfterOpen&&(a.height=Math.min(a.height,this._lastBoundingBoxSize.height),a.width=Math.min(a.width,this._lastBoundingBoxSize.width));const h={};if(this._hasExactPosition())h.top=h.left="0",h.bottom=h.right=h.maxHeight=h.maxWidth="",h.width=h.height="100%";else{const y=this._overlayRef.getConfig().maxHeight,E=this._overlayRef.getConfig().maxWidth;h.height=Wo(a.height),h.top=Wo(a.top),h.bottom=Wo(a.bottom),h.width=Wo(a.width),h.left=Wo(a.left),h.right=Wo(a.right),h.alignItems="center"===i.overlayX?"center":"end"===i.overlayX?"flex-end":"flex-start",h.justifyContent="center"===i.overlayY?"center":"bottom"===i.overlayY?"flex-end":"flex-start",y&&(h.maxHeight=Wo(y)),E&&(h.maxWidth=Wo(E))}this._lastBoundingBoxSize=a,Pg(this._boundingBox.style,h)}_resetBoundingBoxStyles(){Pg(this._boundingBox.style,{top:"0",left:"0",right:"0",bottom:"0",height:"",width:"",alignItems:"",justifyContent:""})}_resetOverlayElementStyles(){Pg(this._pane.style,{top:"",left:"",bottom:"",right:"",position:"",transform:""})}_setOverlayElementStyles(n,i){const a={},h=this._hasExactPosition(),y=this._hasFlexibleDimensions,E=this._overlayRef.getConfig();if(h){const $=this._viewportRuler.getViewportScrollPosition();Pg(a,this._getExactOverlayY(i,n,$)),Pg(a,this._getExactOverlayX(i,n,$))}else a.position="static";let D="",O=this._getOffset(i,"x"),N=this._getOffset(i,"y");O&&(D+=`translateX(${O}px) `),N&&(D+=`translateY(${N}px)`),a.transform=D.trim(),E.maxHeight&&(h?a.maxHeight=Wo(E.maxHeight):y&&(a.maxHeight="")),E.maxWidth&&(h?a.maxWidth=Wo(E.maxWidth):y&&(a.maxWidth="")),Pg(this._pane.style,a)}_getExactOverlayY(n,i,a){let h={top:"",bottom:""},y=this._getOverlayPoint(i,this._overlayRect,n);return this._isPushed&&(y=this._pushOverlayOnScreen(y,this._overlayRect,a)),"bottom"===n.overlayY?h.bottom=this._document.documentElement.clientHeight-(y.y+this._overlayRect.height)+"px":h.top=Wo(y.y),h}_getExactOverlayX(n,i,a){let E,h={left:"",right:""},y=this._getOverlayPoint(i,this._overlayRect,n);return this._isPushed&&(y=this._pushOverlayOnScreen(y,this._overlayRect,a)),E=this._isRtl()?"end"===n.overlayX?"left":"right":"end"===n.overlayX?"right":"left","right"===E?h.right=this._document.documentElement.clientWidth-(y.x+this._overlayRect.width)+"px":h.left=Wo(y.x),h}_getScrollVisibility(){const n=this._getOriginRect(),i=this._pane.getBoundingClientRect(),a=this._scrollables.map(h=>h.getElementRef().nativeElement.getBoundingClientRect());return{isOriginClipped:gM(n,a),isOriginOutsideView:hD(n,a),isOverlayClipped:gM(i,a),isOverlayOutsideView:hD(i,a)}}_subtractOverflows(n,...i){return i.reduce((a,h)=>a-Math.max(h,0),n)}_getNarrowedViewportRect(){const n=this._document.documentElement.clientWidth,i=this._document.documentElement.clientHeight,a=this._viewportRuler.getViewportScrollPosition();return{top:a.top+this._viewportMargin,left:a.left+this._viewportMargin,right:a.left+n-this._viewportMargin,bottom:a.top+i-this._viewportMargin,width:n-2*this._viewportMargin,height:i-2*this._viewportMargin}}_isRtl(){return"rtl"===this._overlayRef.getDirection()}_hasExactPosition(){return!this._hasFlexibleDimensions||this._isPushed}_getOffset(n,i){return"x"===i?null==n.offsetX?this._offsetX:n.offsetX:null==n.offsetY?this._offsetY:n.offsetY}_validatePositions(){}_addPanelClasses(n){this._pane&&Cw(n).forEach(i=>{""!==i&&-1===this._appliedPanelClasses.indexOf(i)&&(this._appliedPanelClasses.push(i),this._pane.classList.add(i))})}_clearPanelClasses(){this._pane&&(this._appliedPanelClasses.forEach(n=>{this._pane.classList.remove(n)}),this._appliedPanelClasses=[])}_getOriginRect(){const n=this._origin;if(n instanceof ga)return n.nativeElement.getBoundingClientRect();if(n instanceof Element)return n.getBoundingClientRect();const i=n.width||0,a=n.height||0;return{top:n.y,bottom:n.y+a,left:n.x,right:n.x+i,height:a,width:i}}}function Pg(t,n){for(let i in n)n.hasOwnProperty(i)&&(t[i]=n[i]);return t}function xM(t){if("number"!=typeof t&&null!=t){const[n,i]=t.split(FN);return i&&"px"!==i?null:parseFloat(n)}return t||null}function bM(t){return{top:Math.floor(t.top),right:Math.floor(t.right),bottom:Math.floor(t.bottom),left:Math.floor(t.left),width:Math.floor(t.width),height:Math.floor(t.height)}}const wM="cdk-global-overlay-wrapper";class NN{constructor(){this._cssPosition="static",this._topOffset="",this._bottomOffset="",this._alignItems="",this._xPosition="",this._xOffset="",this._width="",this._height="",this._isDisposed=!1}attach(n){const i=n.getConfig();this._overlayRef=n,this._width&&!i.width&&n.updateSize({width:this._width}),this._height&&!i.height&&n.updateSize({height:this._height}),n.hostElement.classList.add(wM),this._isDisposed=!1}top(n=""){return this._bottomOffset="",this._topOffset=n,this._alignItems="flex-start",this}left(n=""){return this._xOffset=n,this._xPosition="left",this}bottom(n=""){return this._topOffset="",this._bottomOffset=n,this._alignItems="flex-end",this}right(n=""){return this._xOffset=n,this._xPosition="right",this}start(n=""){return this._xOffset=n,this._xPosition="start",this}end(n=""){return this._xOffset=n,this._xPosition="end",this}width(n=""){return this._overlayRef?this._overlayRef.updateSize({width:n}):this._width=n,this}height(n=""){return this._overlayRef?this._overlayRef.updateSize({height:n}):this._height=n,this}centerHorizontally(n=""){return this.left(n),this._xPosition="center",this}centerVertically(n=""){return this.top(n),this._alignItems="center",this}apply(){if(!this._overlayRef||!this._overlayRef.hasAttached())return;const n=this._overlayRef.overlayElement.style,i=this._overlayRef.hostElement.style,a=this._overlayRef.getConfig(),{width:h,height:y,maxWidth:E,maxHeight:D}=a,O=!("100%"!==h&&"100vw"!==h||E&&"100%"!==E&&"100vw"!==E),N=!("100%"!==y&&"100vh"!==y||D&&"100%"!==D&&"100vh"!==D),$=this._xPosition,J=this._xOffset,we="rtl"===this._overlayRef.getConfig().direction;let ve="",Oe="",He="";O?He="flex-start":"center"===$?(He="center",we?Oe=J:ve=J):we?"left"===$||"end"===$?(He="flex-end",ve=J):("right"===$||"start"===$)&&(He="flex-start",Oe=J):"left"===$||"start"===$?(He="flex-start",ve=J):("right"===$||"end"===$)&&(He="flex-end",Oe=J),n.position=this._cssPosition,n.marginLeft=O?"0":ve,n.marginTop=N?"0":this._topOffset,n.marginBottom=this._bottomOffset,n.marginRight=O?"0":Oe,i.justifyContent=He,i.alignItems=N?"flex-start":this._alignItems}dispose(){if(this._isDisposed||!this._overlayRef)return;const n=this._overlayRef.overlayElement.style,i=this._overlayRef.hostElement,a=i.style;i.classList.remove(wM),a.justifyContent=a.alignItems=n.marginTop=n.marginBottom=n.marginLeft=n.marginRight=n.position="",this._overlayRef=null,this._isDisposed=!0}}let BN=(()=>{class t{constructor(i,a,h,y){this._viewportRuler=i,this._document=a,this._platform=h,this._overlayContainer=y}global(){return new NN}flexibleConnectedTo(i){return new zN(i,this._viewportRuler,this._document,this._platform,this._overlayContainer)}static{this.\u0275fac=function(a){return new(a||t)(gt(uM),gt(br),gt(Sd),gt(kw))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),VN=0,Ky=(()=>{class t{constructor(i,a,h,y,E,D,O,N,$,J,we,ve){this.scrollStrategies=i,this._overlayContainer=a,this._componentFactoryResolver=h,this._positionBuilder=y,this._keyboardDispatcher=E,this._injector=D,this._ngZone=O,this._document=N,this._directionality=$,this._location=J,this._outsideClickDispatcher=we,this._animationsModuleType=ve}create(i){const a=this._createHostElement(),h=this._createPaneElement(a),y=this._createPortalOutlet(h),E=new _M(i);return E.direction=E.direction||this._directionality.value,new Px(y,a,h,E,this._ngZone,this._keyboardDispatcher,this._document,this._location,this._outsideClickDispatcher,"NoopAnimations"===this._animationsModuleType)}position(){return this._positionBuilder}_createPaneElement(i){const a=this._document.createElement("div");return a.id="cdk-overlay-"+VN++,a.classList.add("cdk-overlay-pane"),i.appendChild(a),a}_createHostElement(){const i=this._document.createElement("div");return this._overlayContainer.getContainerElement().appendChild(i),i}_createPortalOutlet(i){return this._appRef||(this._appRef=this._injector.get(Tg)),new CN(i,this._componentFactoryResolver,this._appRef,this._injector,this._document)}static{this.\u0275fac=function(a){return new(a||t)(gt(RN),gt(kw),gt(np),gt(BN),gt(LN),gt(cs),gt(Ei),gt(br),gt(sD),gt(tS),gt(kN),gt(Um,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();const HN={provide:new Jt("cdk-connected-overlay-scroll-strategy"),deps:[Ky],useFactory:function UN(t){return()=>t.scrollStrategies.reposition()}};let EM=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({providers:[Ky,HN],imports:[Mx,Lw,hM,hM]})}}return t})();function fD(t,...n){return n.length?n.some(i=>t[i]):t.altKey||t.shiftKey||t.ctrlKey||t.metaKey}function DM(t){return Ap((n,i)=>t<=i)}let cB=(()=>{class t{create(i){return typeof MutationObserver>"u"?null:new MutationObserver(i)}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),uB=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({providers:[cB]})}}return t})();const{isArray:dB}=Array,{getPrototypeOf:hB,prototype:fB,keys:pB}=Object;function yB(...t){const n=Si(t),i=function Ui(t){return Yi(ji(t))?t.pop():void 0}(t),{args:a,keys:h}=function mB(t){if(1===t.length){const n=t[0];if(dB(n))return{args:n,keys:null};if(function gB(t){return t&&"object"==typeof t&&hB(t)===fB}(n)){const i=pB(n);return{args:i.map(a=>n[a]),keys:i}}}return{args:t,keys:null}}(t);if(0===a.length)return Ol([],n);const y=new qi(function vB(t,n,i=to){return a=>{IM(n,()=>{const{length:h}=t,y=new Array(h);let E=h,D=h;for(let O=0;O<h;O++)IM(n,()=>{const N=Ol(t[O],n);let $=!1;N.subscribe(er(a,J=>{y[O]=J,$||($=!0,D--),D||a.next(i(y.slice()))},()=>{--E||a.complete()}))},a)},a)}}(a,n,h?E=>function _B(t,n){return t.reduce((i,a,h)=>(i[a]=n[h],i),{})}(h,E):to));return i?y.pipe(rM(i)):y}function IM(t,n,i){t?cn(i,t,n):n()}function pD(...t){return function xB(){return Qi(1)}()(Ol(t,Si(t)))}function mD(...t){const n=Si(t);return yi((i,a)=>{(n?pD(t,i,n):pD(t,i)).subscribe(a)})}const CM=new Set;let Rg,bB=(()=>{class t{constructor(i,a){this._platform=i,this._nonce=a,this._matchMedia=this._platform.isBrowser&&window.matchMedia?window.matchMedia.bind(window):EB}matchMedia(i){return(this._platform.WEBKIT||this._platform.BLINK)&&function wB(t,n){if(!CM.has(t))try{Rg||(Rg=document.createElement("style"),n&&(Rg.nonce=n),Rg.setAttribute("type","text/css"),document.head.appendChild(Rg)),Rg.sheet&&(Rg.sheet.insertRule(`@media ${t} {body{ }}`,0),CM.add(t))}catch(i){console.error(i)}}(i,this._nonce),this._matchMedia(i)}static{this.\u0275fac=function(a){return new(a||t)(gt(Sd),gt(Qf,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();function EB(t){return{matches:"all"===t||""===t,media:t,addListener:()=>{},removeListener:()=>{}}}let TB=(()=>{class t{constructor(i,a){this._mediaMatcher=i,this._zone=a,this._queries=new Map,this._destroySubject=new Vi}ngOnDestroy(){this._destroySubject.next(),this._destroySubject.complete()}isMatched(i){return AM(Cw(i)).some(h=>this._registerQuery(h).mql.matches)}observe(i){let y=yB(AM(Cw(i)).map(E=>this._registerQuery(E).observable));return y=pD(y.pipe(Yy(1)),y.pipe(DM(1),function SM(t,n=tD){return yi((i,a)=>{let h=null,y=null,E=null;const D=()=>{if(h){h.unsubscribe(),h=null;const N=y;y=null,a.next(N)}};function O(){const N=E+t,$=n.now();if($<N)return h=this.schedule(void 0,N-$),void a.add(h);D()}i.subscribe(er(a,N=>{y=N,E=n.now(),h||(h=n.schedule(O,t),a.add(h))},()=>{D(),a.complete()},void 0,()=>{y=h=null}))})}(0))),y.pipe(js(E=>{const D={matches:!1,breakpoints:{}};return E.forEach(({matches:O,query:N})=>{D.matches=D.matches||O,D.breakpoints[N]=O}),D}))}_registerQuery(i){if(this._queries.has(i))return this._queries.get(i);const a=this._mediaMatcher.matchMedia(i),y={observable:new qi(E=>{const D=O=>this._zone.run(()=>E.next(O));return a.addListener(D),()=>{a.removeListener(D)}}).pipe(mD(a),js(({matches:E})=>({query:i,matches:E})),aD(this._destroySubject)),mql:a};return this._queries.set(i,y),y}static{this.\u0275fac=function(a){return new(a||t)(gt(bB),gt(Ei))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();function AM(t){return t.map(n=>n.split(",")).reduce((n,i)=>n.concat(i)).map(n=>n.trim())}let Fw=(()=>{class t{constructor(i){this._platform=i}isDisabled(i){return i.hasAttribute("disabled")}isVisible(i){return function AB(t){return!!(t.offsetWidth||t.offsetHeight||"function"==typeof t.getClientRects&&t.getClientRects().length)}(i)&&"visible"===getComputedStyle(i).visibility}isTabbable(i){if(!this._platform.isBrowser)return!1;const a=function CB(t){try{return t.frameElement}catch{return null}}(function zB(t){return t.ownerDocument&&t.ownerDocument.defaultView||window}(i));if(a&&(-1===OM(a)||!this.isVisible(a)))return!1;let h=i.nodeName.toLowerCase(),y=OM(i);return i.hasAttribute("contenteditable")?-1!==y:!("iframe"===h||"object"===h||this._platform.WEBKIT&&this._platform.IOS&&!function kB(t){let n=t.nodeName.toLowerCase(),i="input"===n&&t.type;return"text"===i||"password"===i||"select"===n||"textarea"===n}(i))&&("audio"===h?!!i.hasAttribute("controls")&&-1!==y:"video"===h?-1!==y&&(null!==y||this._platform.FIREFOX||i.hasAttribute("controls")):i.tabIndex>=0)}isFocusable(i,a){return function FB(t){return!function PB(t){return function OB(t){return"input"==t.nodeName.toLowerCase()}(t)&&"hidden"==t.type}(t)&&(function MB(t){let n=t.nodeName.toLowerCase();return"input"===n||"select"===n||"button"===n||"textarea"===n}(t)||function RB(t){return function LB(t){return"a"==t.nodeName.toLowerCase()}(t)&&t.hasAttribute("href")}(t)||t.hasAttribute("contenteditable")||RM(t))}(i)&&!this.isDisabled(i)&&(a?.ignoreVisibility||this.isVisible(i))}static{this.\u0275fac=function(a){return new(a||t)(gt(Sd))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();function RM(t){if(!t.hasAttribute("tabindex")||void 0===t.tabIndex)return!1;let n=t.getAttribute("tabindex");return!(!n||isNaN(parseInt(n,10)))}function OM(t){if(!RM(t))return null;const n=parseInt(t.getAttribute("tabindex")||"",10);return isNaN(n)?-1:n}class LM{get enabled(){return this._enabled}set enabled(n){this._enabled=n,this._startAnchor&&this._endAnchor&&(this._toggleAnchorTabIndex(n,this._startAnchor),this._toggleAnchorTabIndex(n,this._endAnchor))}constructor(n,i,a,h,y=!1){this._element=n,this._checker=i,this._ngZone=a,this._document=h,this._hasAttached=!1,this.startAnchorListener=()=>this.focusLastTabbableElement(),this.endAnchorListener=()=>this.focusFirstTabbableElement(),this._enabled=!0,y||this.attachAnchors()}destroy(){const n=this._startAnchor,i=this._endAnchor;n&&(n.removeEventListener("focus",this.startAnchorListener),n.remove()),i&&(i.removeEventListener("focus",this.endAnchorListener),i.remove()),this._startAnchor=this._endAnchor=null,this._hasAttached=!1}attachAnchors(){return!!this._hasAttached||(this._ngZone.runOutsideAngular(()=>{this._startAnchor||(this._startAnchor=this._createAnchor(),this._startAnchor.addEventListener("focus",this.startAnchorListener)),this._endAnchor||(this._endAnchor=this._createAnchor(),this._endAnchor.addEventListener("focus",this.endAnchorListener))}),this._element.parentNode&&(this._element.parentNode.insertBefore(this._startAnchor,this._element),this._element.parentNode.insertBefore(this._endAnchor,this._element.nextSibling),this._hasAttached=!0),this._hasAttached)}focusInitialElementWhenReady(n){return new Promise(i=>{this._executeOnStable(()=>i(this.focusInitialElement(n)))})}focusFirstTabbableElementWhenReady(n){return new Promise(i=>{this._executeOnStable(()=>i(this.focusFirstTabbableElement(n)))})}focusLastTabbableElementWhenReady(n){return new Promise(i=>{this._executeOnStable(()=>i(this.focusLastTabbableElement(n)))})}_getRegionBoundary(n){const i=this._element.querySelectorAll(`[cdk-focus-region-${n}], [cdkFocusRegion${n}], [cdk-focus-${n}]`);return"start"==n?i.length?i[0]:this._getFirstTabbableElement(this._element):i.length?i[i.length-1]:this._getLastTabbableElement(this._element)}focusInitialElement(n){const i=this._element.querySelector("[cdk-focus-initial], [cdkFocusInitial]");if(i){if(!this._checker.isFocusable(i)){const a=this._getFirstTabbableElement(i);return a?.focus(n),!!a}return i.focus(n),!0}return this.focusFirstTabbableElement(n)}focusFirstTabbableElement(n){const i=this._getRegionBoundary("start");return i&&i.focus(n),!!i}focusLastTabbableElement(n){const i=this._getRegionBoundary("end");return i&&i.focus(n),!!i}hasAttached(){return this._hasAttached}_getFirstTabbableElement(n){if(this._checker.isFocusable(n)&&this._checker.isTabbable(n))return n;const i=n.children;for(let a=0;a<i.length;a++){const h=i[a].nodeType===this._document.ELEMENT_NODE?this._getFirstTabbableElement(i[a]):null;if(h)return h}return null}_getLastTabbableElement(n){if(this._checker.isFocusable(n)&&this._checker.isTabbable(n))return n;const i=n.children;for(let a=i.length-1;a>=0;a--){const h=i[a].nodeType===this._document.ELEMENT_NODE?this._getLastTabbableElement(i[a]):null;if(h)return h}return null}_createAnchor(){const n=this._document.createElement("div");return this._toggleAnchorTabIndex(this._enabled,n),n.classList.add("cdk-visually-hidden"),n.classList.add("cdk-focus-trap-anchor"),n.setAttribute("aria-hidden","true"),n}_toggleAnchorTabIndex(n,i){n?i.setAttribute("tabindex","0"):i.removeAttribute("tabindex")}toggleAnchors(n){this._startAnchor&&this._endAnchor&&(this._toggleAnchorTabIndex(n,this._startAnchor),this._toggleAnchorTabIndex(n,this._endAnchor))}_executeOnStable(n){this._ngZone.isStable?n():this._ngZone.onStable.pipe(Yy(1)).subscribe(n)}}let gD=(()=>{class t{constructor(i,a,h){this._checker=i,this._ngZone=a,this._document=h}create(i,a=!1){return new LM(i,this._checker,this._ngZone,this._document,a)}static{this.\u0275fac=function(a){return new(a||t)(gt(Fw),gt(Ei),gt(br))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();function kM(t){return 0===t.buttons||0===t.detail}function FM(t){const n=t.touches&&t.touches[0]||t.changedTouches&&t.changedTouches[0];return!(!n||-1!==n.identifier||null!=n.radiusX&&1!==n.radiusX||null!=n.radiusY&&1!==n.radiusY)}const NB=new Jt("cdk-input-modality-detector-options"),BB={ignoreKeys:[18,17,224,91,16]},Qy=Rw({passive:!0,capture:!0});let VB=(()=>{class t{get mostRecentModality(){return this._modality.value}constructor(i,a,h,y){this._platform=i,this._mostRecentTarget=null,this._modality=new Du(null),this._lastTouchMs=0,this._onKeydown=E=>{this._options?.ignoreKeys?.some(D=>D===E.keyCode)||(this._modality.next("keyboard"),this._mostRecentTarget=Mp(E))},this._onMousedown=E=>{Date.now()-this._lastTouchMs<650||(this._modality.next(kM(E)?"keyboard":"mouse"),this._mostRecentTarget=Mp(E))},this._onTouchstart=E=>{FM(E)?this._modality.next("keyboard"):(this._lastTouchMs=Date.now(),this._modality.next("touch"),this._mostRecentTarget=Mp(E))},this._options={...BB,...y},this.modalityDetected=this._modality.pipe(DM(1)),this.modalityChanged=this.modalityDetected.pipe(Sa()),i.isBrowser&&a.runOutsideAngular(()=>{h.addEventListener("keydown",this._onKeydown,Qy),h.addEventListener("mousedown",this._onMousedown,Qy),h.addEventListener("touchstart",this._onTouchstart,Qy)})}ngOnDestroy(){this._modality.complete(),this._platform.isBrowser&&(document.removeEventListener("keydown",this._onKeydown,Qy),document.removeEventListener("mousedown",this._onMousedown,Qy),document.removeEventListener("touchstart",this._onTouchstart,Qy))}static{this.\u0275fac=function(a){return new(a||t)(gt(Sd),gt(Ei),gt(br),gt(NB,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();const UB=new Jt("cdk-focus-monitor-default-options"),zw=Rw({passive:!0,capture:!0});let _D=(()=>{class t{constructor(i,a,h,y,E){this._ngZone=i,this._platform=a,this._inputModalityDetector=h,this._origin=null,this._windowFocused=!1,this._originFromTouchInteraction=!1,this._elementInfo=new Map,this._monitoredElementCount=0,this._rootNodeFocusListenerCount=new Map,this._windowFocusListener=()=>{this._windowFocused=!0,this._windowFocusTimeoutId=window.setTimeout(()=>this._windowFocused=!1)},this._stopInputModalityDetector=new Vi,this._rootNodeFocusAndBlurListener=D=>{for(let N=Mp(D);N;N=N.parentElement)"focus"===D.type?this._onFocus(D,N):this._onBlur(D,N)},this._document=y,this._detectionMode=E?.detectionMode||0}monitor(i,a=!1){const h=Zy(i);if(!this._platform.isBrowser||1!==h.nodeType)return gc();const y=function vN(t){if(function yN(){if(null==iD){const t=typeof document<"u"?document.head:null;iD=!(!t||!t.createShadowRoot&&!t.attachShadow)}return iD}()){const n=t.getRootNode?t.getRootNode():null;if(typeof ShadowRoot<"u"&&ShadowRoot&&n instanceof ShadowRoot)return n}return null}(h)||this._getDocument(),E=this._elementInfo.get(h);if(E)return a&&(E.checkChildren=!0),E.subject;const D={checkChildren:a,subject:new Vi,rootNode:y};return this._elementInfo.set(h,D),this._registerGlobalListeners(D),D.subject}stopMonitoring(i){const a=Zy(i),h=this._elementInfo.get(a);h&&(h.subject.complete(),this._setClasses(a),this._elementInfo.delete(a),this._removeGlobalListeners(h))}focusVia(i,a,h){const y=Zy(i);y===this._getDocument().activeElement?this._getClosestElementsInfo(y).forEach(([D,O])=>this._originChanged(D,a,O)):(this._setOrigin(a),"function"==typeof y.focus&&y.focus(h))}ngOnDestroy(){this._elementInfo.forEach((i,a)=>this.stopMonitoring(a))}_getDocument(){return this._document||document}_getWindow(){return this._getDocument().defaultView||window}_getFocusOrigin(i){return this._origin?this._originFromTouchInteraction?this._shouldBeAttributedToTouch(i)?"touch":"program":this._origin:this._windowFocused&&this._lastFocusOrigin?this._lastFocusOrigin:i&&this._isLastInteractionFromInputLabel(i)?"mouse":"program"}_shouldBeAttributedToTouch(i){return 1===this._detectionMode||!!i?.contains(this._inputModalityDetector._mostRecentTarget)}_setClasses(i,a){i.classList.toggle("cdk-focused",!!a),i.classList.toggle("cdk-touch-focused","touch"===a),i.classList.toggle("cdk-keyboard-focused","keyboard"===a),i.classList.toggle("cdk-mouse-focused","mouse"===a),i.classList.toggle("cdk-program-focused","program"===a)}_setOrigin(i,a=!1){this._ngZone.runOutsideAngular(()=>{this._origin=i,this._originFromTouchInteraction="touch"===i&&a,0===this._detectionMode&&(clearTimeout(this._originTimeoutId),this._originTimeoutId=setTimeout(()=>this._origin=null,this._originFromTouchInteraction?650:1))})}_onFocus(i,a){const h=this._elementInfo.get(a),y=Mp(i);!h||!h.checkChildren&&a!==y||this._originChanged(a,this._getFocusOrigin(y),h)}_onBlur(i,a){const h=this._elementInfo.get(a);!h||h.checkChildren&&i.relatedTarget instanceof Node&&a.contains(i.relatedTarget)||(this._setClasses(a),this._emitOrigin(h,null))}_emitOrigin(i,a){i.subject.observers.length&&this._ngZone.run(()=>i.subject.next(a))}_registerGlobalListeners(i){if(!this._platform.isBrowser)return;const a=i.rootNode,h=this._rootNodeFocusListenerCount.get(a)||0;h||this._ngZone.runOutsideAngular(()=>{a.addEventListener("focus",this._rootNodeFocusAndBlurListener,zw),a.addEventListener("blur",this._rootNodeFocusAndBlurListener,zw)}),this._rootNodeFocusListenerCount.set(a,h+1),1==++this._monitoredElementCount&&(this._ngZone.runOutsideAngular(()=>{this._getWindow().addEventListener("focus",this._windowFocusListener)}),this._inputModalityDetector.modalityDetected.pipe(aD(this._stopInputModalityDetector)).subscribe(y=>{this._setOrigin(y,!0)}))}_removeGlobalListeners(i){const a=i.rootNode;if(this._rootNodeFocusListenerCount.has(a)){const h=this._rootNodeFocusListenerCount.get(a);h>1?this._rootNodeFocusListenerCount.set(a,h-1):(a.removeEventListener("focus",this._rootNodeFocusAndBlurListener,zw),a.removeEventListener("blur",this._rootNodeFocusAndBlurListener,zw),this._rootNodeFocusListenerCount.delete(a))}--this._monitoredElementCount||(this._getWindow().removeEventListener("focus",this._windowFocusListener),this._stopInputModalityDetector.next(),clearTimeout(this._windowFocusTimeoutId),clearTimeout(this._originTimeoutId))}_originChanged(i,a,h){this._setClasses(i,a),this._emitOrigin(h,a),this._lastFocusOrigin=a}_getClosestElementsInfo(i){const a=[];return this._elementInfo.forEach((h,y)=>{(y===i||h.checkChildren&&y.contains(i))&&a.push([y,h])}),a}_isLastInteractionFromInputLabel(i){const{_mostRecentTarget:a,mostRecentModality:h}=this._inputModalityDetector;if("mouse"!==h||!a||a===i||"INPUT"!==i.nodeName&&"TEXTAREA"!==i.nodeName||i.disabled)return!1;const y=i.labels;if(y)for(let E=0;E<y.length;E++)if(y[E].contains(a))return!0;return!1}static{this.\u0275fac=function(a){return new(a||t)(gt(Ei),gt(Sd),gt(VB),gt(br,8),gt(UB,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();const NM="cdk-high-contrast-black-on-white",BM="cdk-high-contrast-white-on-black",yD="cdk-high-contrast-active";let VM=(()=>{class t{constructor(i,a){this._platform=i,this._document=a,this._breakpointSubscription=di(TB).observe("(forced-colors: active)").subscribe(()=>{this._hasCheckedHighContrastMode&&(this._hasCheckedHighContrastMode=!1,this._applyBodyHighContrastModeCssClasses())})}getHighContrastMode(){if(!this._platform.isBrowser)return 0;const i=this._document.createElement("div");i.style.backgroundColor="rgb(1,2,3)",i.style.position="absolute",this._document.body.appendChild(i);const a=this._document.defaultView||window,h=a&&a.getComputedStyle?a.getComputedStyle(i):null,y=(h&&h.backgroundColor||"").replace(/ /g,"");switch(i.remove(),y){case"rgb(0,0,0)":case"rgb(45,50,54)":case"rgb(32,32,32)":return 2;case"rgb(255,255,255)":case"rgb(255,250,239)":return 1}return 0}ngOnDestroy(){this._breakpointSubscription.unsubscribe()}_applyBodyHighContrastModeCssClasses(){if(!this._hasCheckedHighContrastMode&&this._platform.isBrowser&&this._document.body){const i=this._document.body.classList;i.remove(yD,NM,BM),this._hasCheckedHighContrastMode=!0;const a=this.getHighContrastMode();1===a?i.add(yD,NM):2===a&&i.add(yD,BM)}}static{this.\u0275fac=function(a){return new(a||t)(gt(Sd),gt(br))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})(),HB=(()=>{class t{constructor(i){i._applyBodyHighContrastModeCssClasses()}static{this.\u0275fac=function(a){return new(a||t)(gt(VM))}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({imports:[uB]})}}return t})();function jM(t){return new qi(n=>{Ae(t()).subscribe(n)})}function GB(t,n){}class Nw{constructor(){this.role="dialog",this.panelClass="",this.hasBackdrop=!0,this.backdropClass="",this.disableClose=!1,this.width="",this.height="",this.data=null,this.ariaDescribedBy=null,this.ariaLabelledBy=null,this.ariaLabel=null,this.ariaModal=!0,this.autoFocus="first-tabbable",this.restoreFocus=!0,this.closeOnNavigation=!0,this.closeOnDestroy=!0,this.closeOnOverlayDetachments=!0}}let UM=(()=>{class t extends uD{constructor(i,a,h,y,E,D,O,N){super(),this._elementRef=i,this._focusTrapFactory=a,this._config=y,this._interactivityChecker=E,this._ngZone=D,this._overlayRef=O,this._focusMonitor=N,this._elementFocusedBeforeDialogWasOpened=null,this._closeInteractionType=null,this._ariaLabelledByQueue=[],this.attachDomPortal=$=>{this._portalOutlet.hasAttached();const J=this._portalOutlet.attachDomPortal($);return this._contentAttached(),J},this._document=h,this._config.ariaLabelledBy&&this._ariaLabelledByQueue.push(this._config.ariaLabelledBy)}_contentAttached(){this._initializeFocusTrap(),this._handleBackdropClicks(),this._captureInitialFocus()}_captureInitialFocus(){this._trapFocus()}ngOnDestroy(){this._restoreFocus()}attachComponentPortal(i){this._portalOutlet.hasAttached();const a=this._portalOutlet.attachComponentPortal(i);return this._contentAttached(),a}attachTemplatePortal(i){this._portalOutlet.hasAttached();const a=this._portalOutlet.attachTemplatePortal(i);return this._contentAttached(),a}_recaptureFocus(){this._containsFocus()||this._trapFocus()}_forceFocus(i,a){this._interactivityChecker.isFocusable(i)||(i.tabIndex=-1,this._ngZone.runOutsideAngular(()=>{const h=()=>{i.removeEventListener("blur",h),i.removeEventListener("mousedown",h),i.removeAttribute("tabindex")};i.addEventListener("blur",h),i.addEventListener("mousedown",h)})),i.focus(a)}_focusByCssSelector(i,a){let h=this._elementRef.nativeElement.querySelector(i);h&&this._forceFocus(h,a)}_trapFocus(){const i=this._elementRef.nativeElement;switch(this._config.autoFocus){case!1:case"dialog":this._containsFocus()||i.focus();break;case!0:case"first-tabbable":this._focusTrap.focusInitialElementWhenReady().then(a=>{a||this._focusDialogContainer()});break;case"first-heading":this._focusByCssSelector('h1, h2, h3, h4, h5, h6, [role="heading"]');break;default:this._focusByCssSelector(this._config.autoFocus)}}_restoreFocus(){const i=this._config.restoreFocus;let a=null;if("string"==typeof i?a=this._document.querySelector(i):"boolean"==typeof i?a=i?this._elementFocusedBeforeDialogWasOpened:null:i&&(a=i),this._config.restoreFocus&&a&&"function"==typeof a.focus){const h=rD(),y=this._elementRef.nativeElement;(!h||h===this._document.body||h===y||y.contains(h))&&(this._focusMonitor?(this._focusMonitor.focusVia(a,this._closeInteractionType),this._closeInteractionType=null):a.focus())}this._focusTrap&&this._focusTrap.destroy()}_focusDialogContainer(){this._elementRef.nativeElement.focus&&this._elementRef.nativeElement.focus()}_containsFocus(){const i=this._elementRef.nativeElement,a=rD();return i===a||i.contains(a)}_initializeFocusTrap(){this._focusTrap=this._focusTrapFactory.create(this._elementRef.nativeElement),this._document&&(this._elementFocusedBeforeDialogWasOpened=rD())}_handleBackdropClicks(){this._overlayRef.backdropClick().subscribe(()=>{this._config.disableClose&&this._recaptureFocus()})}static{this.\u0275fac=function(a){return new(a||t)(sn(ga),sn(gD),sn(br,8),sn(Nw),sn(Fw),sn(Ei),sn(Px),sn(_D))}}static{this.\u0275cmp=jl({type:t,selectors:[["cdk-dialog-container"]],viewQuery:function(a,h){if(1&a&&DI(dD,7),2&a){let y;SI(y=function II(){return function GP(t,n){return t[es].queries[n].queryList}(It(),Gc())}())&&(h._portalOutlet=y.first)}},hostAttrs:["tabindex","-1",1,"cdk-dialog-container"],hostVars:6,hostBindings:function(a,h){2&a&&fg("id",h._config.id||null)("role",h._config.role)("aria-modal",h._config.ariaModal)("aria-labelledby",h._config.ariaLabel?null:h._ariaLabelledByQueue[0])("aria-label",h._config.ariaLabel)("aria-describedby",h._config.ariaDescribedBy||null)},features:[cu],decls:1,vars:0,consts:[["cdkPortalOutlet",""]],template:function(a,h){1&a&&W0(0,GB,0,0,"ng-template",0)},dependencies:[dD],styles:[".cdk-dialog-container{display:block;width:100%;height:100%;min-height:inherit;max-height:inherit}"],encapsulation:2})}}return t})();class vD{constructor(n,i){this.overlayRef=n,this.config=i,this.closed=new Vi,this.disableClose=i.disableClose,this.backdropClick=n.backdropClick(),this.keydownEvents=n.keydownEvents(),this.outsidePointerEvents=n.outsidePointerEvents(),this.id=i.id,this.keydownEvents.subscribe(a=>{27===a.keyCode&&!this.disableClose&&!fD(a)&&(a.preventDefault(),this.close(void 0,{focusOrigin:"keyboard"}))}),this.backdropClick.subscribe(()=>{this.disableClose||this.close(void 0,{focusOrigin:"mouse"})}),this._detachSubscription=n.detachments().subscribe(()=>{!1!==i.closeOnOverlayDetachments&&this.close()})}close(n,i){if(this.containerInstance){const a=this.closed;this.containerInstance._closeInteractionType=i?.focusOrigin||"program",this._detachSubscription.unsubscribe(),this.overlayRef.dispose(),a.next(n),a.complete(),this.componentInstance=this.containerInstance=null}}updatePosition(){return this.overlayRef.updatePosition(),this}updateSize(n="",i=""){return this.overlayRef.updateSize({width:n,height:i}),this}addPanelClass(n){return this.overlayRef.addPanelClass(n),this}removePanelClass(n){return this.overlayRef.removePanelClass(n),this}}const HM=new Jt("DialogScrollStrategy"),$B=new Jt("DialogData"),qB=new Jt("DefaultDialogConfig"),ZB={provide:HM,deps:[Ky],useFactory:function WB(t){return()=>t.scrollStrategies.block()}};let XB=0,GM=(()=>{class t{get openDialogs(){return this._parentDialog?this._parentDialog.openDialogs:this._openDialogsAtThisLevel}get afterOpened(){return this._parentDialog?this._parentDialog.afterOpened:this._afterOpenedAtThisLevel}constructor(i,a,h,y,E,D){this._overlay=i,this._injector=a,this._defaultOptions=h,this._parentDialog=y,this._overlayContainer=E,this._openDialogsAtThisLevel=[],this._afterAllClosedAtThisLevel=new Vi,this._afterOpenedAtThisLevel=new Vi,this._ariaHiddenElements=new Map,this.afterAllClosed=jM(()=>this.openDialogs.length?this._getAfterAllClosed():this._getAfterAllClosed().pipe(mD(void 0))),this._scrollStrategy=D}open(i,a){(a={...this._defaultOptions||new Nw,...a}).id=a.id||"cdk-dialog-"+XB++,a.id&&this.getDialogById(a.id);const y=this._getOverlayConfig(a),E=this._overlay.create(y),D=new vD(E,a),O=this._attachContainer(E,D,a);return D.containerInstance=O,this._attachDialogContent(i,D,O,a),this.openDialogs.length||this._hideNonDialogContentFromAssistiveTechnology(),this.openDialogs.push(D),D.closed.subscribe(()=>this._removeOpenDialog(D,!0)),this.afterOpened.next(D),D}closeAll(){xD(this.openDialogs,i=>i.close())}getDialogById(i){return this.openDialogs.find(a=>a.id===i)}ngOnDestroy(){xD(this._openDialogsAtThisLevel,i=>{!1===i.config.closeOnDestroy&&this._removeOpenDialog(i,!1)}),xD(this._openDialogsAtThisLevel,i=>i.close()),this._afterAllClosedAtThisLevel.complete(),this._afterOpenedAtThisLevel.complete(),this._openDialogsAtThisLevel=[]}_getOverlayConfig(i){const a=new _M({positionStrategy:i.positionStrategy||this._overlay.position().global().centerHorizontally().centerVertically(),scrollStrategy:i.scrollStrategy||this._scrollStrategy(),panelClass:i.panelClass,hasBackdrop:i.hasBackdrop,direction:i.direction,minWidth:i.minWidth,minHeight:i.minHeight,maxWidth:i.maxWidth,maxHeight:i.maxHeight,width:i.width,height:i.height,disposeOnNavigation:i.closeOnNavigation});return i.backdropClass&&(a.backdropClass=i.backdropClass),a}_attachContainer(i,a,h){const y=h.injector||h.viewContainerRef?.injector,E=[{provide:Nw,useValue:h},{provide:vD,useValue:a},{provide:Px,useValue:i}];let D;h.container?"function"==typeof h.container?D=h.container:(D=h.container.type,E.push(...h.container.providers(h))):D=UM;const O=new cD(D,h.viewContainerRef,cs.create({parent:y||this._injector,providers:E}),h.componentFactoryResolver);return i.attach(O).instance}_attachDialogContent(i,a,h,y){if(i instanceof wd){const E=this._createInjector(y,a,h,void 0);let D={$implicit:y.data,dialogRef:a};y.templateContext&&(D={...D,..."function"==typeof y.templateContext?y.templateContext():y.templateContext}),h.attachTemplatePortal(new fM(i,null,D,E))}else{const E=this._createInjector(y,a,h,this._injector),D=h.attachComponentPortal(new cD(i,y.viewContainerRef,E,y.componentFactoryResolver));a.componentRef=D,a.componentInstance=D.instance}}_createInjector(i,a,h,y){const E=i.injector||i.viewContainerRef?.injector,D=[{provide:$B,useValue:i.data},{provide:vD,useValue:a}];return i.providers&&("function"==typeof i.providers?D.push(...i.providers(a,i,h)):D.push(...i.providers)),i.direction&&(!E||!E.get(sD,null,{optional:!0}))&&D.push({provide:sD,useValue:{value:i.direction,change:gc()}}),cs.create({parent:E||y,providers:D})}_removeOpenDialog(i,a){const h=this.openDialogs.indexOf(i);h>-1&&(this.openDialogs.splice(h,1),this.openDialogs.length||(this._ariaHiddenElements.forEach((y,E)=>{y?E.setAttribute("aria-hidden",y):E.removeAttribute("aria-hidden")}),this._ariaHiddenElements.clear(),a&&this._getAfterAllClosed().next()))}_hideNonDialogContentFromAssistiveTechnology(){const i=this._overlayContainer.getContainerElement();if(i.parentElement){const a=i.parentElement.children;for(let h=a.length-1;h>-1;h--){const y=a[h];y!==i&&"SCRIPT"!==y.nodeName&&"STYLE"!==y.nodeName&&!y.hasAttribute("aria-live")&&(this._ariaHiddenElements.set(y,y.getAttribute("aria-hidden")),y.setAttribute("aria-hidden","true"))}}}_getAfterAllClosed(){const i=this._parentDialog;return i?i._getAfterAllClosed():this._afterAllClosedAtThisLevel}static{this.\u0275fac=function(a){return new(a||t)(gt(Ky),gt(cs),gt(qB,8),gt(t,12),gt(kw),gt(HM))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})();function xD(t,n){let i=t.length;for(;i--;)n(t[i])}let YB=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({providers:[GM,ZB],imports:[EM,Lw,HB,Lw]})}}return t})();const QB=new Jt("mat-sanity-checks",{providedIn:"root",factory:function KB(){return!0}});let Jy=(()=>{class t{constructor(i,a,h){this._sanityChecks=a,this._document=h,this._hasDoneGlobalChecks=!1,i._applyBodyHighContrastModeCssClasses(),this._hasDoneGlobalChecks||(this._hasDoneGlobalChecks=!0)}_checkIsEnabled(i){return!oD()&&("boolean"==typeof this._sanityChecks?this._sanityChecks:!!this._sanityChecks[i])}static{this.\u0275fac=function(a){return new(a||t)(gt(VM),gt(QB,8),gt(br))}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({imports:[Mx,Mx]})}}return t})();const WM=Rw({passive:!0,capture:!0});class t3{constructor(){this._events=new Map,this._delegateEventHandler=n=>{const i=Mp(n);i&&this._events.get(n.type)?.forEach((a,h)=>{(h===i||h.contains(i))&&a.forEach(y=>y.handleEvent(n))})}}addHandler(n,i,a,h){const y=this._events.get(i);if(y){const E=y.get(a);E?E.add(h):y.set(a,new Set([h]))}else this._events.set(i,new Map([[a,new Set([h])]])),n.runOutsideAngular(()=>{document.addEventListener(i,this._delegateEventHandler,WM)})}removeHandler(n,i,a){const h=this._events.get(n);if(!h)return;const y=h.get(i);y&&(y.delete(a),0===y.size&&h.delete(i),0===h.size&&(this._events.delete(n),document.removeEventListener(n,this._delegateEventHandler,WM)))}}class bD{static{this._eventManager=new t3}constructor(n,i,a,h){this._target=n,this._ngZone=i,this._platform=h,this._isPointerDown=!1,this._activeRipples=new Map,this._pointerUpEventsRegistered=!1,h.isBrowser&&(this._containerElement=Zy(a))}fadeInRipple(n,i,a={}){const h=this._containerRect=this._containerRect||this._containerElement.getBoundingClientRect(),y={...ZM,...a.animation},E=a.radius||function r3(t,n,i){const a=Math.max(Math.abs(t-i.left),Math.abs(t-i.right)),h=Math.max(Math.abs(n-i.top),Math.abs(n-i.bottom));return Math.sqrt(a*a+h*h)}(n,i,h),D=n-h.left,O=i-h.top,N=y.enterDuration,$=document.createElement("div");$.classList.add("mat-ripple-element"),$.style.left=D-E+"px",$.style.top=O-E+"px",$.style.height=2*E+"px",$.style.width=2*E+"px",null!=a.color&&($.style.backgroundColor=a.color),$.style.transitionDuration=`${N}ms`,this._containerElement.appendChild($);const J=window.getComputedStyle($),ve=J.transitionDuration,Oe="none"===J.transitionProperty||"0s"===ve||"0s, 0s"===ve||0===h.width&&0===h.height,He=new e3(this,$,a,Oe);$.style.transform="scale3d(1, 1, 1)",He.state=0,a.persistent||(this._mostRecentTransientRipple=He);return!Oe&&(N||y.exitDuration)&&this._ngZone.runOutsideAngular(()=>{const Mt=()=>this._finishRippleTransition(He),dt=()=>this._destroyRipple(He);$.addEventListener("transitionend",Mt),$.addEventListener("transitioncancel",dt)}),this._activeRipples.set(He,null),(Oe||!N)&&this._finishRippleTransition(He),He}fadeOutRipple(n){if(2===n.state||3===n.state)return;const i=n.element,a={...ZM,...n.config.animation};i.style.transitionDuration=`${a.exitDuration}ms`,i.style.opacity="0",n.state=2,(n._animationForciblyDisabledThroughCss||!a.exitDuration)&&this._finishRippleTransition(n)}fadeOutAll(){this._getActiveRipples().forEach(n=>n.fadeOut())}fadeOutAllNonPersistent(){this._getActiveRipples().forEach(n=>{n.config.persistent||n.fadeOut()})}setupTriggerEvents(n){const i=Zy(n);!this._platform.isBrowser||!i||i===this._triggerElement||(this._removeTriggerEvents(),this._triggerElement=i,YM.forEach(a=>{bD._eventManager.addHandler(this._ngZone,a,i,this)}))}handleEvent(n){"mousedown"===n.type?this._onMousedown(n):"touchstart"===n.type?this._onTouchStart(n):this._onPointerUp(),this._pointerUpEventsRegistered||(this._ngZone.runOutsideAngular(()=>{KM.forEach(i=>{this._triggerElement.addEventListener(i,this,XM)})}),this._pointerUpEventsRegistered=!0)}_finishRippleTransition(n){0===n.state?this._startFadeOutTransition(n):2===n.state&&this._destroyRipple(n)}_startFadeOutTransition(n){const i=n===this._mostRecentTransientRipple,{persistent:a}=n.config;n.state=1,!a&&(!i||!this._isPointerDown)&&n.fadeOut()}_destroyRipple(n){const i=this._activeRipples.get(n)??null;this._activeRipples.delete(n),this._activeRipples.size||(this._containerRect=null),n===this._mostRecentTransientRipple&&(this._mostRecentTransientRipple=null),n.state=3,null!==i&&(n.element.removeEventListener("transitionend",i.onTransitionEnd),n.element.removeEventListener("transitioncancel",i.onTransitionCancel)),n.element.remove()}_onMousedown(n){const i=kM(n),a=this._lastTouchStartEvent&&Date.now()<this._lastTouchStartEvent+800;!this._target.rippleDisabled&&!i&&!a&&(this._isPointerDown=!0,this.fadeInRipple(n.clientX,n.clientY,this._target.rippleConfig))}_onTouchStart(n){if(!this._target.rippleDisabled&&!FM(n)){this._lastTouchStartEvent=Date.now(),this._isPointerDown=!0;const i=n.changedTouches;if(i)for(let a=0;a<i.length;a++)this.fadeInRipple(i[a].clientX,i[a].clientY,this._target.rippleConfig)}}_onPointerUp(){this._isPointerDown&&(this._isPointerDown=!1,this._getActiveRipples().forEach(n=>{!n.config.persistent&&(1===n.state||n.config.terminateOnPointerUp&&0===n.state)&&n.fadeOut()}))}_getActiveRipples(){return Array.from(this._activeRipples.keys())}_removeTriggerEvents(){const n=this._triggerElement;n&&(YM.forEach(i=>bD._eventManager.removeHandler(i,n,this)),this._pointerUpEventsRegistered&&KM.forEach(i=>n.removeEventListener(i,this,XM)))}}let o3=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({imports:[Jy,Jy]})}}return t})();function s3(t,n){}class Bw{constructor(){this.role="dialog",this.panelClass="",this.hasBackdrop=!0,this.backdropClass="",this.disableClose=!1,this.width="",this.height="",this.maxWidth="80vw",this.data=null,this.ariaDescribedBy=null,this.ariaLabelledBy=null,this.ariaLabel=null,this.ariaModal=!0,this.autoFocus="first-tabbable",this.restoreFocus=!0,this.delayFocusTrap=!0,this.closeOnNavigation=!0}}const wD="mdc-dialog--open",QM="mdc-dialog--opening",JM="mdc-dialog--closing";let c3=(()=>{class t extends UM{constructor(i,a,h,y,E,D,O,N){super(i,a,h,y,E,D,O,N),this._animationStateChanged=new ea}_captureInitialFocus(){this._config.delayFocusTrap||this._trapFocus()}_openAnimationDone(i){this._config.delayFocusTrap&&this._trapFocus(),this._animationStateChanged.next({state:"opened",totalTime:i})}static{this.\u0275fac=function(a){return new(a||t)(sn(ga),sn(gD),sn(br,8),sn(Bw),sn(Fw),sn(Ei),sn(Px),sn(_D))}}static{this.\u0275cmp=jl({type:t,selectors:[["ng-component"]],features:[cu],decls:0,vars:0,template:function(a,h){},encapsulation:2})}}return t})();const e2="--mat-dialog-transition-duration";function t2(t){return null==t?null:"number"==typeof t?t:t.endsWith("ms")?iM(t.substring(0,t.length-2)):t.endsWith("s")?1e3*iM(t.substring(0,t.length-1)):"0"===t?0:null}let u3=(()=>{class t extends c3{constructor(i,a,h,y,E,D,O,N,$){super(i,a,h,y,E,D,O,$),this._animationMode=N,this._animationsEnabled="NoopAnimations"!==this._animationMode,this._hostElement=this._elementRef.nativeElement,this._enterAnimationDuration=this._animationsEnabled?t2(this._config.enterAnimationDuration)??150:0,this._exitAnimationDuration=this._animationsEnabled?t2(this._config.exitAnimationDuration)??75:0,this._animationTimer=null,this._finishDialogOpen=()=>{this._clearAnimationClasses(),this._openAnimationDone(this._enterAnimationDuration)},this._finishDialogClose=()=>{this._clearAnimationClasses(),this._animationStateChanged.emit({state:"closed",totalTime:this._exitAnimationDuration})}}_contentAttached(){super._contentAttached(),this._startOpenAnimation()}ngOnDestroy(){super.ngOnDestroy(),null!==this._animationTimer&&clearTimeout(this._animationTimer)}_startOpenAnimation(){this._animationStateChanged.emit({state:"opening",totalTime:this._enterAnimationDuration}),this._animationsEnabled?(this._hostElement.style.setProperty(e2,`${this._enterAnimationDuration}ms`),this._requestAnimationFrame(()=>this._hostElement.classList.add(QM,wD)),this._waitForAnimationToComplete(this._enterAnimationDuration,this._finishDialogOpen)):(this._hostElement.classList.add(wD),Promise.resolve().then(()=>this._finishDialogOpen()))}_startExitAnimation(){this._animationStateChanged.emit({state:"closing",totalTime:this._exitAnimationDuration}),this._hostElement.classList.remove(wD),this._animationsEnabled?(this._hostElement.style.setProperty(e2,`${this._exitAnimationDuration}ms`),this._requestAnimationFrame(()=>this._hostElement.classList.add(JM)),this._waitForAnimationToComplete(this._exitAnimationDuration,this._finishDialogClose)):Promise.resolve().then(()=>this._finishDialogClose())}_clearAnimationClasses(){this._hostElement.classList.remove(QM,JM)}_waitForAnimationToComplete(i,a){null!==this._animationTimer&&clearTimeout(this._animationTimer),this._animationTimer=setTimeout(a,i)}_requestAnimationFrame(i){this._ngZone.runOutsideAngular(()=>{"function"==typeof requestAnimationFrame?requestAnimationFrame(i):i()})}static{this.\u0275fac=function(a){return new(a||t)(sn(ga),sn(gD),sn(br,8),sn(Bw),sn(Fw),sn(Ei),sn(Px),sn(Um,8),sn(_D))}}static{this.\u0275cmp=jl({type:t,selectors:[["mat-dialog-container"]],hostAttrs:["tabindex","-1",1,"mat-mdc-dialog-container","mdc-dialog"],hostVars:8,hostBindings:function(a,h){2&a&&(vn("id",h._config.id),fg("aria-modal",h._config.ariaModal)("role",h._config.role)("aria-labelledby",h._config.ariaLabel?null:h._ariaLabelledByQueue[0])("aria-label",h._config.ariaLabel)("aria-describedby",h._config.ariaDescribedBy||null),By("_mat-animation-noopable",!h._animationsEnabled))},features:[cu],decls:3,vars:0,consts:[[1,"mdc-dialog__container"],[1,"mat-mdc-dialog-surface","mdc-dialog__surface"],["cdkPortalOutlet",""]],template:function(a,h){1&a&&(qh(0,"div",0)(1,"div",1),W0(2,s3,0,0,"ng-template",2),Wh()())},dependencies:[dD],styles:['.mdc-elevation-overlay{position:absolute;border-radius:inherit;pointer-events:none;opacity:var(--mdc-elevation-overlay-opacity, 0);transition:opacity 280ms cubic-bezier(0.4, 0, 0.2, 1)}.mdc-dialog,.mdc-dialog__scrim{position:fixed;top:0;left:0;align-items:center;justify-content:center;box-sizing:border-box;width:100%;height:100%}.mdc-dialog{display:none;z-index:var(--mdc-dialog-z-index, 7)}.mdc-dialog .mdc-dialog__content{padding:20px 24px 20px 24px}.mdc-dialog .mdc-dialog__surface{min-width:280px}@media(max-width: 592px){.mdc-dialog .mdc-dialog__surface{max-width:calc(100vw - 32px)}}@media(min-width: 592px){.mdc-dialog .mdc-dialog__surface{max-width:560px}}.mdc-dialog .mdc-dialog__surface{max-height:calc(100% - 32px)}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{max-width:none}@media(max-width: 960px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{max-height:560px;width:560px}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__close{right:-12px}}@media(max-width: 720px)and (max-width: 672px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{width:calc(100vw - 112px)}}@media(max-width: 720px)and (min-width: 672px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{width:560px}}@media(max-width: 720px)and (max-height: 720px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{max-height:calc(100vh - 160px)}}@media(max-width: 720px)and (min-height: 720px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{max-height:560px}}@media(max-width: 720px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__close{right:-12px}}@media(max-width: 720px)and (max-height: 400px),(max-width: 600px),(min-width: 720px)and (max-height: 400px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{height:100%;max-height:100vh;max-width:100vw;width:100vw;border-radius:0}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__close{order:-1;left:-12px}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__header{padding:0 16px 9px;justify-content:flex-start}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__title{margin-left:calc(16px - 2 * 12px)}}@media(min-width: 960px){.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface{width:calc(100vw - 400px)}.mdc-dialog.mdc-dialog--fullscreen .mdc-dialog__surface .mdc-dialog__close{right:-12px}}.mdc-dialog.mdc-dialog__scrim--hidden .mdc-dialog__scrim{opacity:0}.mdc-dialog__scrim{opacity:0;z-index:-1}.mdc-dialog__container{display:flex;flex-direction:row;align-items:center;justify-content:space-around;box-sizing:border-box;height:100%;transform:scale(0.8);opacity:0;pointer-events:none}.mdc-dialog__surface{position:relative;display:flex;flex-direction:column;flex-grow:0;flex-shrink:0;box-sizing:border-box;max-width:100%;max-height:100%;pointer-events:auto;overflow-y:auto;outline:0}.mdc-dialog__surface .mdc-elevation-overlay{width:100%;height:100%;top:0;left:0}[dir=rtl] .mdc-dialog__surface,.mdc-dialog__surface[dir=rtl]{text-align:right}@media screen and (forced-colors: active),(-ms-high-contrast: active){.mdc-dialog__surface{outline:2px solid windowText}}.mdc-dialog__surface::before{position:absolute;box-sizing:border-box;width:100%;height:100%;top:0;left:0;border:2px solid rgba(0,0,0,0);border-radius:inherit;content:"";pointer-events:none}@media screen and (forced-colors: active){.mdc-dialog__surface::before{border-color:CanvasText}}@media screen and (-ms-high-contrast: active),screen and (-ms-high-contrast: none){.mdc-dialog__surface::before{content:none}}.mdc-dialog__title{display:block;margin-top:0;position:relative;flex-shrink:0;box-sizing:border-box;margin:0 0 1px;padding:0 24px 9px}.mdc-dialog__title::before{display:inline-block;width:0;height:40px;content:"";vertical-align:0}[dir=rtl] .mdc-dialog__title,.mdc-dialog__title[dir=rtl]{text-align:right}.mdc-dialog--scrollable .mdc-dialog__title{margin-bottom:1px;padding-bottom:15px}.mdc-dialog--fullscreen .mdc-dialog__header{align-items:baseline;border-bottom:1px solid rgba(0,0,0,0);display:inline-flex;justify-content:space-between;padding:0 24px 9px;z-index:1}@media screen and (forced-colors: active){.mdc-dialog--fullscreen .mdc-dialog__header{border-bottom-color:CanvasText}}.mdc-dialog--fullscreen .mdc-dialog__header .mdc-dialog__close{right:-12px}.mdc-dialog--fullscreen .mdc-dialog__title{margin-bottom:0;padding:0;border-bottom:0}.mdc-dialog--fullscreen.mdc-dialog--scrollable .mdc-dialog__title{border-bottom:0;margin-bottom:0}.mdc-dialog--fullscreen .mdc-dialog__close{top:5px}.mdc-dialog--fullscreen.mdc-dialog--scrollable .mdc-dialog__actions{border-top:1px solid rgba(0,0,0,0)}@media screen and (forced-colors: active){.mdc-dialog--fullscreen.mdc-dialog--scrollable .mdc-dialog__actions{border-top-color:CanvasText}}.mdc-dialog--fullscreen--titleless .mdc-dialog__close{margin-top:4px}.mdc-dialog--fullscreen--titleless.mdc-dialog--scrollable .mdc-dialog__close{margin-top:0}.mdc-dialog__content{flex-grow:1;box-sizing:border-box;margin:0;overflow:auto}.mdc-dialog__content>:first-child{margin-top:0}.mdc-dialog__content>:last-child{margin-bottom:0}.mdc-dialog__title+.mdc-dialog__content,.mdc-dialog__header+.mdc-dialog__content{padding-top:0}.mdc-dialog--scrollable .mdc-dialog__title+.mdc-dialog__content{padding-top:8px;padding-bottom:8px}.mdc-dialog__content .mdc-deprecated-list:first-child:last-child{padding:6px 0 0}.mdc-dialog--scrollable .mdc-dialog__content .mdc-deprecated-list:first-child:last-child{padding:0}.mdc-dialog__actions{display:flex;position:relative;flex-shrink:0;flex-wrap:wrap;align-items:center;justify-content:flex-end;box-sizing:border-box;min-height:52px;margin:0;padding:8px;border-top:1px solid rgba(0,0,0,0)}@media screen and (forced-colors: active){.mdc-dialog__actions{border-top-color:CanvasText}}.mdc-dialog--stacked .mdc-dialog__actions{flex-direction:column;align-items:flex-end}.mdc-dialog__button{margin-left:8px;margin-right:0;max-width:100%;text-align:right}[dir=rtl] .mdc-dialog__button,.mdc-dialog__button[dir=rtl]{margin-left:0;margin-right:8px}.mdc-dialog__button:first-child{margin-left:0;margin-right:0}[dir=rtl] .mdc-dialog__button:first-child,.mdc-dialog__button:first-child[dir=rtl]{margin-left:0;margin-right:0}[dir=rtl] .mdc-dialog__button,.mdc-dialog__button[dir=rtl]{text-align:left}.mdc-dialog--stacked .mdc-dialog__button:not(:first-child){margin-top:12px}.mdc-dialog--open,.mdc-dialog--opening,.mdc-dialog--closing{display:flex}.mdc-dialog--opening .mdc-dialog__scrim{transition:opacity 150ms linear}.mdc-dialog--opening .mdc-dialog__container{transition:opacity 75ms linear,transform 150ms 0ms cubic-bezier(0, 0, 0.2, 1)}.mdc-dialog--closing .mdc-dialog__scrim,.mdc-dialog--closing .mdc-dialog__container{transition:opacity 75ms linear}.mdc-dialog--closing .mdc-dialog__container{transform:none}.mdc-dialog--open .mdc-dialog__scrim{opacity:1}.mdc-dialog--open .mdc-dialog__container{transform:none;opacity:1}.mdc-dialog--open.mdc-dialog__surface-scrim--shown .mdc-dialog__surface-scrim{opacity:1}.mdc-dialog--open.mdc-dialog__surface-scrim--hiding .mdc-dialog__surface-scrim{transition:opacity 75ms linear}.mdc-dialog--open.mdc-dialog__surface-scrim--showing .mdc-dialog__surface-scrim{transition:opacity 150ms linear}.mdc-dialog__surface-scrim{display:none;opacity:0;position:absolute;width:100%;height:100%;z-index:1}.mdc-dialog__surface-scrim--shown .mdc-dialog__surface-scrim,.mdc-dialog__surface-scrim--showing .mdc-dialog__surface-scrim,.mdc-dialog__surface-scrim--hiding .mdc-dialog__surface-scrim{display:block}.mdc-dialog-scroll-lock{overflow:hidden}.mdc-dialog--no-content-padding .mdc-dialog__content{padding:0}.mdc-dialog--sheet .mdc-dialog__container .mdc-dialog__close{right:12px;top:9px;position:absolute;z-index:1}.mdc-dialog__scrim--removed{pointer-events:none}.mdc-dialog__scrim--removed .mdc-dialog__scrim,.mdc-dialog__scrim--removed .mdc-dialog__surface-scrim{display:none}.mat-mdc-dialog-content{max-height:65vh}.mat-mdc-dialog-container{position:static;display:block}.mat-mdc-dialog-container,.mat-mdc-dialog-container .mdc-dialog__container,.mat-mdc-dialog-container .mdc-dialog__surface{max-height:inherit;min-height:inherit;min-width:inherit;max-width:inherit}.mat-mdc-dialog-container .mdc-dialog__surface{display:block;width:100%;height:100%}.mat-mdc-dialog-container{--mdc-dialog-container-elevation-shadow:0px 11px 15px -7px rgba(0, 0, 0, 0.2), 0px 24px 38px 3px rgba(0, 0, 0, 0.14), 0px 9px 46px 8px rgba(0, 0, 0, 0.12);--mdc-dialog-container-shadow-color:#000;--mdc-dialog-container-shape:4px;--mdc-dialog-container-elevation: var(--mdc-dialog-container-elevation-shadow);outline:0}.mat-mdc-dialog-container .mdc-dialog__surface{background-color:var(--mdc-dialog-container-color, white)}.mat-mdc-dialog-container .mdc-dialog__surface{box-shadow:var(--mdc-dialog-container-elevation, 0px 11px 15px -7px rgba(0, 0, 0, 0.2), 0px 24px 38px 3px rgba(0, 0, 0, 0.14), 0px 9px 46px 8px rgba(0, 0, 0, 0.12))}.mat-mdc-dialog-container .mdc-dialog__surface{border-radius:var(--mdc-dialog-container-shape, 4px)}.mat-mdc-dialog-container .mdc-dialog__title{font-family:var(--mdc-dialog-subhead-font, Roboto, sans-serif);line-height:var(--mdc-dialog-subhead-line-height, 1.5rem);font-size:var(--mdc-dialog-subhead-size, 1rem);font-weight:var(--mdc-dialog-subhead-weight, 400);letter-spacing:var(--mdc-dialog-subhead-tracking, 0.03125em)}.mat-mdc-dialog-container .mdc-dialog__title{color:var(--mdc-dialog-subhead-color, rgba(0, 0, 0, 0.87))}.mat-mdc-dialog-container .mdc-dialog__content{font-family:var(--mdc-dialog-supporting-text-font, Roboto, sans-serif);line-height:var(--mdc-dialog-supporting-text-line-height, 1.5rem);font-size:var(--mdc-dialog-supporting-text-size, 1rem);font-weight:var(--mdc-dialog-supporting-text-weight, 400);letter-spacing:var(--mdc-dialog-supporting-text-tracking, 0.03125em)}.mat-mdc-dialog-container .mdc-dialog__content{color:var(--mdc-dialog-supporting-text-color, rgba(0, 0, 0, 0.6))}.mat-mdc-dialog-container .mdc-dialog__container{transition-duration:var(--mat-dialog-transition-duration, 0ms)}.mat-mdc-dialog-container._mat-animation-noopable .mdc-dialog__container{transition:none}.mat-mdc-dialog-content{display:block}.mat-mdc-dialog-actions{justify-content:start}.mat-mdc-dialog-actions.mat-mdc-dialog-actions-align-center,.mat-mdc-dialog-actions[align=center]{justify-content:center}.mat-mdc-dialog-actions.mat-mdc-dialog-actions-align-end,.mat-mdc-dialog-actions[align=end]{justify-content:flex-end}.mat-mdc-dialog-actions .mat-button-base+.mat-button-base,.mat-mdc-dialog-actions .mat-mdc-button-base+.mat-mdc-button-base{margin-left:8px}[dir=rtl] .mat-mdc-dialog-actions .mat-button-base+.mat-button-base,[dir=rtl] .mat-mdc-dialog-actions .mat-mdc-button-base+.mat-mdc-button-base{margin-left:0;margin-right:8px}'],encapsulation:2})}}return t})();class d3{constructor(n,i,a){this._ref=n,this._containerInstance=a,this._afterOpened=new Vi,this._beforeClosed=new Vi,this._state=0,this.disableClose=i.disableClose,this.id=n.id,a._animationStateChanged.pipe(Ap(h=>"opened"===h.state),Yy(1)).subscribe(()=>{this._afterOpened.next(),this._afterOpened.complete()}),a._animationStateChanged.pipe(Ap(h=>"closed"===h.state),Yy(1)).subscribe(()=>{clearTimeout(this._closeFallbackTimeout),this._finishDialogClose()}),n.overlayRef.detachments().subscribe(()=>{this._beforeClosed.next(this._result),this._beforeClosed.complete(),this._finishDialogClose()}),$a(this.backdropClick(),this.keydownEvents().pipe(Ap(h=>27===h.keyCode&&!this.disableClose&&!fD(h)))).subscribe(h=>{this.disableClose||(h.preventDefault(),function h3(t,n,i){t._closeInteractionType=n,t.close(i)}(this,"keydown"===h.type?"keyboard":"mouse"))})}close(n){this._result=n,this._containerInstance._animationStateChanged.pipe(Ap(i=>"closing"===i.state),Yy(1)).subscribe(i=>{this._beforeClosed.next(n),this._beforeClosed.complete(),this._ref.overlayRef.detachBackdrop(),this._closeFallbackTimeout=setTimeout(()=>this._finishDialogClose(),i.totalTime+100)}),this._state=1,this._containerInstance._startExitAnimation()}afterOpened(){return this._afterOpened}afterClosed(){return this._ref.closed}beforeClosed(){return this._beforeClosed}backdropClick(){return this._ref.backdropClick}keydownEvents(){return this._ref.keydownEvents}updatePosition(n){let i=this._ref.config.positionStrategy;return n&&(n.left||n.right)?n.left?i.left(n.left):i.right(n.right):i.centerHorizontally(),n&&(n.top||n.bottom)?n.top?i.top(n.top):i.bottom(n.bottom):i.centerVertically(),this._ref.updatePosition(),this}updateSize(n="",i=""){return this._ref.updateSize(n,i),this}addPanelClass(n){return this._ref.addPanelClass(n),this}removePanelClass(n){return this._ref.removePanelClass(n),this}getState(){return this._state}_finishDialogClose(){this._state=2,this._ref.close(this._result,{focusOrigin:this._closeInteractionType}),this.componentInstance=null}}const f3=new Jt("MatMdcDialogData"),p3=new Jt("mat-mdc-dialog-default-options"),n2=new Jt("mat-mdc-dialog-scroll-strategy"),g3={provide:n2,deps:[Ky],useFactory:function m3(t){return()=>t.scrollStrategies.block()}};let _3=0,y3=(()=>{class t{get openDialogs(){return this._parentDialog?this._parentDialog.openDialogs:this._openDialogsAtThisLevel}get afterOpened(){return this._parentDialog?this._parentDialog.afterOpened:this._afterOpenedAtThisLevel}_getAfterAllClosed(){const i=this._parentDialog;return i?i._getAfterAllClosed():this._afterAllClosedAtThisLevel}constructor(i,a,h,y,E,D,O,N,$,J){this._overlay=i,this._defaultOptions=h,this._parentDialog=y,this._dialogRefConstructor=O,this._dialogContainerType=N,this._dialogDataToken=$,this._openDialogsAtThisLevel=[],this._afterAllClosedAtThisLevel=new Vi,this._afterOpenedAtThisLevel=new Vi,this._idPrefix="mat-dialog-",this.dialogConfigClass=Bw,this.afterAllClosed=jM(()=>this.openDialogs.length?this._getAfterAllClosed():this._getAfterAllClosed().pipe(mD(void 0))),this._scrollStrategy=D,this._dialog=a.get(GM)}open(i,a){let h;(a={...this._defaultOptions||new Bw,...a}).id=a.id||`${this._idPrefix}${_3++}`,a.scrollStrategy=a.scrollStrategy||this._scrollStrategy();const y=this._dialog.open(i,{...a,positionStrategy:this._overlay.position().global().centerHorizontally().centerVertically(),disableClose:!0,closeOnDestroy:!1,closeOnOverlayDetachments:!1,container:{type:this._dialogContainerType,providers:()=>[{provide:this.dialogConfigClass,useValue:a},{provide:Nw,useValue:a}]},templateContext:()=>({dialogRef:h}),providers:(E,D,O)=>(h=new this._dialogRefConstructor(E,a,O),h.updatePosition(a?.position),[{provide:this._dialogContainerType,useValue:O},{provide:this._dialogDataToken,useValue:D.data},{provide:this._dialogRefConstructor,useValue:h}])});return h.componentRef=y.componentRef,h.componentInstance=y.componentInstance,this.openDialogs.push(h),this.afterOpened.next(h),h.afterClosed().subscribe(()=>{const E=this.openDialogs.indexOf(h);E>-1&&(this.openDialogs.splice(E,1),this.openDialogs.length||this._getAfterAllClosed().next())}),h}closeAll(){this._closeDialogs(this.openDialogs)}getDialogById(i){return this.openDialogs.find(a=>a.id===i)}ngOnDestroy(){this._closeDialogs(this._openDialogsAtThisLevel),this._afterAllClosedAtThisLevel.complete(),this._afterOpenedAtThisLevel.complete()}_closeDialogs(i){let a=i.length;for(;a--;)i[a].close()}static{this.\u0275fac=function(a){!function g0(){throw new Error("invalid")}()}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})(),v3=(()=>{class t extends y3{constructor(i,a,h,y,E,D,O,N){super(i,a,y,D,O,E,d3,u3,f3,N),this._idPrefix="mat-mdc-dialog-"}static{this.\u0275fac=function(a){return new(a||t)(gt(Ky),gt(cs),gt(tS,8),gt(p3,8),gt(n2),gt(t,12),gt(kw),gt(Um,8))}}static{this.\u0275prov=Qt({token:t,factory:t.\u0275fac})}}return t})(),x3=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({providers:[v3,g3],imports:[YB,EM,Lw,Jy,Jy]})}}return t})(),E3=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t})}static{this.\u0275inj=Or({imports:[Jy,o3,Jy]})}}return t})();function o2(t,n,i,a,h,y,E){try{var D=t[y](E),O=D.value}catch(N){return void i(N)}D.done?n(O):Promise.resolve(O).then(a,h)}function T3(t){return function(){var n=this,i=arguments;return new Promise(function(a,h){var y=t.apply(n,i);function E(O){o2(y,a,h,E,D,"next",O)}function D(O){o2(y,a,h,E,D,"throw",O)}E(void 0)})}}var Og=ef(247);let S3=(()=>{class t{constructor(i){this.ngZone=i,this.churches=[{name:"St. Patrick\u2019s Cathedral",description:"Famous church in New York",coordinates:[-73.975,40.758],personName:"Father John Doe",personPhoto:"assets/person.jpg"},{name:"Westminster Abbey",description:"Historic church in London",coordinates:[-.1273,51.4993],personName:"Bishop Richard Roe",personPhoto:"assets/person1.jpg"},{name:"St. Mary\u2019s Cathedral",description:"Famous church in Tokyo",coordinates:[139.715,35.693],personName:"Archbishop Kenji Tanaka",personPhoto:"assets/person.jpg"},{name:"Notre Dame Cathedral",description:"Iconic Gothic cathedral in Paris",coordinates:[2.3499,48.853],personName:"Father Pierre Dubois",personPhoto:"assets/person1.jpg"},{name:"St. Peter\u2019s Basilica",description:"Major basilica in Vatican City",coordinates:[12.4534,41.9029],personName:"Pope Francis",personPhoto:"assets/person.jpg"},{name:"Sagrada Familia",description:"World-famous church in Barcelona",coordinates:[2.1744,41.4036],personName:"Father Miguel S\xe1nchez",personPhoto:"assets/person1.jpg"},{name:"St. Basil\u2019s Cathedral",description:"Colorful cathedral in Moscow",coordinates:[37.6208,55.7525],personName:"Father Ivan Petrov",personPhoto:"assets/person.jpg"},{name:"Christ the Saviour Cathedral",description:"Largest Orthodox cathedral in Moscow",coordinates:[37.6056,55.7447],personName:"Metropolitan Alexei",personPhoto:"assets/person1.jpg"},{name:"Basilica of Our Lady of Guadalupe",description:"Famous pilgrimage site in Mexico City",coordinates:[-99.1187,19.4843],personName:"Cardinal Juan Carlos",personPhoto:"assets/person.jpg"},{name:"St. Mark\u2019s Basilica",description:"Famous cathedral in Venice",coordinates:[12.3403,45.4342],personName:"Father Lorenzo Rossi",personPhoto:"assets/person1.jpg"}],this.churchMarkers=[],this.animationId=null,this.isFlying=!1,this.bearing=0}ngOnInit(){this.initializeMap()}initializeMap(){var i=this;Og.accessToken="pk.eyJ1Ijoic2Fpa3VtYXJ0dW5ndXR1cmkiLCJhIjoiY21laDkzMGR0MDUycjJrcDZqN2xleXc3biJ9.73urhh9weHk5tslJYZ0vhQ",this.map=new Og.Map({container:"globe-map",style:{version:8,sources:{"osm-tiles":{type:"raster",tiles:["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png","https://b.tile.openstreetmap.org/{z}/{x}/{y}.png","https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"osm-tiles",minzoom:0,maxzoom:19}]},center:[0,20],zoom:1.5,projection:"globe"}),this.map.on("style.load",()=>{this.map.setFog({})}),this.map.on("load",T3(function*(){i.churches.forEach(a=>i.addMarkerWithClick(a,"assets/marker.png")),i.map.on("zoom",()=>{i.map.getZoom()>=5?i.showChurches():i.hideChurches()}),i.map.on("click",a=>{i.map.flyTo({center:[a.lngLat.lng,a.lngLat.lat],zoom:5,essential:!0})}),yield i.startInitialRotation(),i.startChurchSlideshow()}))}startInitialRotation(){return new Promise(i=>{const a=performance.now(),h=y=>{y-a<1e3?(this.bearing-=.5,this.map.easeTo({bearing:this.bearing,duration:50,easing:D=>D}),this.animationId=requestAnimationFrame(h)):(this.animationId&&cancelAnimationFrame(this.animationId),i())};this.ngZone.runOutsideAngular(()=>requestAnimationFrame(h))})}startChurchSlideshow(){let i=0;const a=()=>{if(!this.map)return;this.isFlying=!0;const h=this.churches[i];this.map.flyTo({center:h.coordinates,zoom:5,speed:2,curve:1,essential:!0});const y=new Og.Popup({offset:25,closeOnClick:!1}).setHTML(this.buildPopupCard(h)).setLngLat(h.coordinates).addTo(this.map);setTimeout(()=>{y.remove(),this.isFlying=!1,i=(i+1)%this.churches.length,setTimeout(a,1)},5e3)};a()}buildPopupCard(i){return`\n      <div style="width:220px; padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.2); font-family:sans-serif; background:#fff;">\n        <img src="${i.personPhoto}" alt="${i.personName}" \n             style="width:100%; height:150px; object-fit:cover; border-radius:8px;"/>\n        <h3 style="margin:8px 0 4px; font-size:16px; color:#333;">${i.name}</h3>\n        <p style="margin:0; font-size:13px; color:#555;">${i.description}</p>\n        <p style="margin:6px 0 0; font-size:14px; font-weight:bold; color:#222;">\n          \u{1f464} ${i.personName}\n        </p>\n      </div>\n    `}addMarkerWithClick(i,a){const h=document.createElement("div");h.className="marker",h.style.backgroundImage=`url(${a})`,h.style.width="30px",h.style.height="30px",h.style.backgroundSize="cover",h.style.cursor="pointer";const y=new Og.Popup({offset:25}).setHTML(this.buildPopupCard(i));return new Og.Marker(h).setLngLat(i.coordinates).setPopup(y).addTo(this.map)}addMarkerWithHover(i,a){const h=document.createElement("div");h.className="marker",h.style.backgroundImage=`url(${a})`,h.style.width="30px",h.style.height="30px",h.style.backgroundSize="cover",h.style.cursor="pointer";const y=new Og.Popup({offset:25,closeButton:!1,closeOnClick:!1}).setHTML(this.buildPopupCard(i)),E=new Og.Marker(h).setLngLat(i.coordinates).addTo(this.map);return h.addEventListener("mouseenter",()=>{y.addTo(this.map).setLngLat(i.coordinates)}),h.addEventListener("mouseleave",()=>{y.remove()}),E}showChurches(){0===this.churchMarkers.length&&(this.churchMarkers=this.churches.map(i=>this.addMarkerWithHover(i,"assets/marker.png")))}hideChurches(){this.churchMarkers.forEach(i=>i.remove()),this.churchMarkers=[]}ngOnDestroy(){this.map&&this.map.remove(),this.animationId&&cancelAnimationFrame(this.animationId)}static{this.\u0275fac=function(a){return new(a||t)(sn(Ei))}}static{this.\u0275cmp=jl({type:t,selectors:[["app-globe-view"]],decls:7,vars:0,consts:[[1,"header"],[1,"logo"],[1,"fas","fa-church"],[1,"profile"],[1,"fas","fa-user-circle"],["id","globe-map"]],template:function(a,h){1&a&&(qh(0,"div",0)(1,"div",1),Zh(2,"i",2),function C(t,n=""){const i=It(),a=xi(),h=t+vi,y=a.firstCreatePass?kh(a,h,1,n,null):a.data[h],E=A(a,i,y,n,t);i[h]=E,Ku()&&wh(a,i,E,y),vs(y,!1)}(3," Church "),Wh(),qh(4,"div",3),Zh(5,"i",4),Wh()(),Zh(6,"div",5))},styles:["[_nghost-%COMP%]{display:block;height:100vh;width:100%}.header[_ngcontent-%COMP%]{position:absolute;top:0;left:0;right:0;height:60px;background:transparent;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:10}.logo[_ngcontent-%COMP%]{font-size:40px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px}.logo[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#fff;font-size:22px}.profile[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:30px;color:#fff;cursor:pointer;transition:opacity .3s ease}.profile[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]:hover{opacity:.7}#globe-map[_ngcontent-%COMP%]{position:absolute;inset:0}  .mapboxgl-popup-content{background:transparent!important;box-shadow:none!important;padding:0!important;border-radius:0!important}  .mapboxgl-popup-close-button{display:none!important}"]})}}return t})(),D3=(()=>{class t{constructor(){this.title="chruch-project"}static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275cmp=jl({type:t,selectors:[["app-root"]],decls:1,vars:0,template:function(a,h){1&a&&Zh(0,"app-globe-view")},dependencies:[S3]})}}return t})(),I3=(()=>{class t{static{this.\u0275fac=function(a){return new(a||t)}}static{this.\u0275mod=Ir({type:t,bootstrap:[D3]})}static{this.\u0275inj=Or({imports:[dA,$z,x3,E3]})}}return t})();jk().bootstrapModule(I3).catch(t=>console.error(t))},247:function(ev){ev.exports=function(){"use strict";var Jh,ef,Yi;function Fg(u,Ki){if(Jh)if(ef){var Ni="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+Jh+")(sharedChunk); ("+ef+")(sharedChunk); self.onerror = null;",xa={};Jh(xa),Yi=Ki(xa),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Yi.workerUrl=window.URL.createObjectURL(new Blob([Ni],{type:"text/javascript"})))}else ef=Ki;else Jh=Ki}return Fg(0,function(u){var Ki=1e-6,Ni=typeof Float32Array<"u"?Float32Array:Array;function xa(s,e){var o=e[0],c=e[1],d=e[2],m=e[3],g=o*m-d*c;return g?(s[0]=m*(g=1/g),s[1]=-c*g,s[2]=-d*g,s[3]=o*g,s):null}function Id(){var s=new Ni(9);return Ni!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s}function Cs(s,e){var o=e[0],c=e[1],d=e[2],m=e[3],g=e[4],x=e[5],w=e[6],T=e[7],C=e[8];return s[0]=g*C-x*T,s[1]=d*T-c*C,s[2]=c*x-d*g,s[3]=x*w-m*C,s[4]=o*C-d*w,s[5]=d*m-o*x,s[6]=m*T-g*w,s[7]=c*w-o*T,s[8]=o*g-c*m,s}function As(s,e,o){var c=e[0],d=e[1],m=e[2],g=e[3],x=e[4],w=e[5],T=e[6],C=e[7],A=e[8],M=o[0],k=o[1],F=o[2],V=o[3],j=o[4],W=o[5],Q=o[6],K=o[7],te=o[8];return s[0]=M*c+k*g+F*T,s[1]=M*d+k*x+F*C,s[2]=M*m+k*w+F*A,s[3]=V*c+j*g+W*T,s[4]=V*d+j*x+W*C,s[5]=V*m+j*w+W*A,s[6]=Q*c+K*g+te*T,s[7]=Q*d+K*x+te*C,s[8]=Q*m+K*w+te*A,s}function Dl(){var s=new Ni(16);return Ni!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=0,s[12]=0,s[13]=0,s[14]=0),s[0]=1,s[5]=1,s[10]=1,s[15]=1,s}function fn(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Zo(s,e){var o=e[0],c=e[1],d=e[2],m=e[3],g=e[4],x=e[5],w=e[6],T=e[7],C=e[8],A=e[9],M=e[10],k=e[11],F=e[12],V=e[13],j=e[14],W=e[15],Q=o*x-c*g,K=o*w-d*g,te=o*T-m*g,me=c*w-d*x,he=c*T-m*x,fe=d*T-m*w,xe=C*V-A*F,Ee=C*j-M*F,Ve=C*W-k*F,Ie=A*j-M*V,Ue=A*W-k*V,ot=M*W-k*j,$e=Q*ot-K*Ue+te*Ie+me*Ve-he*Ee+fe*xe;return $e?(s[0]=(x*ot-w*Ue+T*Ie)*($e=1/$e),s[1]=(d*Ue-c*ot-m*Ie)*$e,s[2]=(V*fe-j*he+W*me)*$e,s[3]=(M*he-A*fe-k*me)*$e,s[4]=(w*Ve-g*ot-T*Ee)*$e,s[5]=(o*ot-d*Ve+m*Ee)*$e,s[6]=(j*te-F*fe-W*K)*$e,s[7]=(C*fe-M*te+k*K)*$e,s[8]=(g*Ue-x*Ve+T*xe)*$e,s[9]=(c*Ve-o*Ue-m*xe)*$e,s[10]=(F*he-V*te+W*Q)*$e,s[11]=(A*te-C*he-k*Q)*$e,s[12]=(x*Ee-g*Ie-w*xe)*$e,s[13]=(o*Ie-c*Ee+d*xe)*$e,s[14]=(V*K-F*me-j*Q)*$e,s[15]=(C*me-A*K+M*Q)*$e,s):null}function Bi(s,e,o){var c=e[0],d=e[1],m=e[2],g=e[3],x=e[4],w=e[5],T=e[6],C=e[7],A=e[8],M=e[9],k=e[10],F=e[11],V=e[12],j=e[13],W=e[14],Q=e[15],K=o[0],te=o[1],me=o[2],he=o[3];return s[0]=K*c+te*x+me*A+he*V,s[1]=K*d+te*w+me*M+he*j,s[2]=K*m+te*T+me*k+he*W,s[3]=K*g+te*C+me*F+he*Q,s[4]=(K=o[4])*c+(te=o[5])*x+(me=o[6])*A+(he=o[7])*V,s[5]=K*d+te*w+me*M+he*j,s[6]=K*m+te*T+me*k+he*W,s[7]=K*g+te*C+me*F+he*Q,s[8]=(K=o[8])*c+(te=o[9])*x+(me=o[10])*A+(he=o[11])*V,s[9]=K*d+te*w+me*M+he*j,s[10]=K*m+te*T+me*k+he*W,s[11]=K*g+te*C+me*F+he*Q,s[12]=(K=o[12])*c+(te=o[13])*x+(me=o[14])*A+(he=o[15])*V,s[13]=K*d+te*w+me*M+he*j,s[14]=K*m+te*T+me*k+he*W,s[15]=K*g+te*C+me*F+he*Q,s}function zo(s,e,o){var c,d,m,g,x,w,T,C,A,M,k,F,V=o[0],j=o[1],W=o[2];return e===s?(s[12]=e[0]*V+e[4]*j+e[8]*W+e[12],s[13]=e[1]*V+e[5]*j+e[9]*W+e[13],s[14]=e[2]*V+e[6]*j+e[10]*W+e[14],s[15]=e[3]*V+e[7]*j+e[11]*W+e[15]):(d=e[1],m=e[2],g=e[3],x=e[4],w=e[5],T=e[6],C=e[7],A=e[8],M=e[9],k=e[10],F=e[11],s[0]=c=e[0],s[1]=d,s[2]=m,s[3]=g,s[4]=x,s[5]=w,s[6]=T,s[7]=C,s[8]=A,s[9]=M,s[10]=k,s[11]=F,s[12]=c*V+x*j+A*W+e[12],s[13]=d*V+w*j+M*W+e[13],s[14]=m*V+T*j+k*W+e[14],s[15]=g*V+C*j+F*W+e[15]),s}function eo(s,e,o){var c=o[0],d=o[1],m=o[2];return s[0]=e[0]*c,s[1]=e[1]*c,s[2]=e[2]*c,s[3]=e[3]*c,s[4]=e[4]*d,s[5]=e[5]*d,s[6]=e[6]*d,s[7]=e[7]*d,s[8]=e[8]*m,s[9]=e[9]*m,s[10]=e[10]*m,s[11]=e[11]*m,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function fs(s,e,o){var c=Math.sin(o),d=Math.cos(o),m=e[4],g=e[5],x=e[6],w=e[7],T=e[8],C=e[9],A=e[10],M=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=m*d+T*c,s[5]=g*d+C*c,s[6]=x*d+A*c,s[7]=w*d+M*c,s[8]=T*d-m*c,s[9]=C*d-g*c,s[10]=A*d-x*c,s[11]=M*d-w*c,s}function Vs(s,e,o){var c=Math.sin(o),d=Math.cos(o),m=e[0],g=e[1],x=e[2],w=e[3],T=e[8],C=e[9],A=e[10],M=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=m*d-T*c,s[1]=g*d-C*c,s[2]=x*d-A*c,s[3]=w*d-M*c,s[8]=m*c+T*d,s[9]=g*c+C*d,s[10]=x*c+A*d,s[11]=w*c+M*d,s}function Il(s,e,o){var c=Math.sin(o),d=Math.cos(o),m=e[0],g=e[1],x=e[2],w=e[3],T=e[4],C=e[5],A=e[6],M=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=m*d+T*c,s[1]=g*d+C*c,s[2]=x*d+A*c,s[3]=w*d+M*c,s[4]=T*d-m*c,s[5]=C*d-g*c,s[6]=A*d-x*c,s[7]=M*d-w*c,s}function Cl(s,e){return s[0]=e[0],s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e[1],s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=e[2],s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function ra(s,e,o){var c,d,m,g=o[0],x=o[1],w=o[2],T=Math.hypot(g,x,w);return T<Ki?null:(g*=T=1/T,x*=T,w*=T,c=Math.sin(e),d=Math.cos(e),s[0]=g*g*(m=1-d)+d,s[1]=x*g*m+w*c,s[2]=w*g*m-x*c,s[3]=0,s[4]=g*x*m-w*c,s[5]=x*x*m+d,s[6]=w*x*m+g*c,s[7]=0,s[8]=g*w*m+x*c,s[9]=x*w*m-g*c,s[10]=w*w*m+d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s)}function ba(s,e){var o=e[0],c=e[1],d=e[2],m=e[3],g=o+o,x=c+c,w=d+d,T=o*g,C=c*g,A=c*x,M=d*g,k=d*x,F=d*w,V=m*g,j=m*x,W=m*w;return s[0]=1-A-F,s[1]=C+W,s[2]=M-j,s[3]=0,s[4]=C-W,s[5]=1-T-F,s[6]=k+V,s[7]=0,s[8]=M+j,s[9]=k-V,s[10]=1-T-A,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});var tf=Bi;function jn(){var s=new Ni(3);return Ni!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function za(s){var e=new Ni(3);return e[0]=s[0],e[1]=s[1],e[2]=s[2],e}function uo(s){return Math.hypot(s[0],s[1],s[2])}function dr(s,e,o){var c=new Ni(3);return c[0]=s,c[1]=e,c[2]=o,c}function hr(s,e,o,c){return s[0]=e,s[1]=o,s[2]=c,s}function Oi(s,e,o){return s[0]=e[0]+o[0],s[1]=e[1]+o[1],s[2]=e[2]+o[2],s}function to(s,e,o){return s[0]=e[0]-o[0],s[1]=e[1]-o[1],s[2]=e[2]-o[2],s}function nf(s,e,o){return s[0]=e[0]*o[0],s[1]=e[1]*o[1],s[2]=e[2]*o[2],s}function wa(s,e,o){return s[0]=Math.min(e[0],o[0]),s[1]=Math.min(e[1],o[1]),s[2]=Math.min(e[2],o[2]),s}function qi(s,e,o){return s[0]=Math.max(e[0],o[0]),s[1]=Math.max(e[1],o[1]),s[2]=Math.max(e[2],o[2]),s}function Li(s,e,o){return s[0]=e[0]*o,s[1]=e[1]*o,s[2]=e[2]*o,s}function No(s,e,o,c){return s[0]=e[0]+o[0]*c,s[1]=e[1]+o[1]*c,s[2]=e[2]+o[2]*c,s}function xu(s,e){var o=e[0]-s[0],c=e[1]-s[1],d=e[2]-s[2];return o*o+c*c+d*d}function rf(s){var e=s[0],o=s[1],c=s[2];return e*e+o*o+c*c}function Vi(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function Ai(s,e){var o=e[0],c=e[1],d=e[2],m=o*o+c*c+d*d;return m>0&&(m=1/Math.sqrt(m)),s[0]=e[0]*m,s[1]=e[1]*m,s[2]=e[2]*m,s}function ir(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function yi(s,e,o){var c=e[0],d=e[1],m=e[2],g=o[0],x=o[1],w=o[2];return s[0]=d*w-m*x,s[1]=m*g-c*w,s[2]=c*x-d*g,s}function er(s,e,o,c){var d=e[0],m=e[1],g=e[2];return s[0]=d+c*(o[0]-d),s[1]=m+c*(o[1]-m),s[2]=g+c*(o[2]-g),s}function rr(s,e,o){var c=e[0],d=e[1],m=e[2],g=o[3]*c+o[7]*d+o[11]*m+o[15];return s[0]=(o[0]*c+o[4]*d+o[8]*m+o[12])/(g=g||1),s[1]=(o[1]*c+o[5]*d+o[9]*m+o[13])/g,s[2]=(o[2]*c+o[6]*d+o[10]*m+o[14])/g,s}function js(s,e,o){var c=e[0],d=e[1],m=e[2];return s[0]=c*o[0]+d*o[3]+m*o[6],s[1]=c*o[1]+d*o[4]+m*o[7],s[2]=c*o[2]+d*o[5]+m*o[8],s}function Ea(s,e,o){var c=o[0],d=o[1],m=o[2],g=e[0],x=e[1],w=e[2],T=d*w-m*x,C=m*g-c*w,A=c*x-d*g,M=d*A-m*C,k=m*T-c*A,F=c*C-d*T,V=2*o[3];return C*=V,A*=V,k*=2,F*=2,s[0]=g+(T*=V)+(M*=2),s[1]=x+C+k,s[2]=w+A+F,s}function Cd(s){return s[0]=0,s[1]=0,s[2]=0,s}function ps(s,e){return s[0]===e[0]&&s[1]===e[1]&&s[2]===e[2]}var or=to,Xo=nf,Al=uo;function Ad(){var s=new Ni(4);return Ni!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function Na(s,e,o){return s[0]=e[0]*o,s[1]=e[1]*o,s[2]=e[2]*o,s[3]=e[3]*o,s}function Ms(s,e){var o=e[0],c=e[1],d=e[2],m=e[3],g=o*o+c*c+d*d+m*m;return g>0&&(g=1/Math.sqrt(g)),s[0]=o*g,s[1]=c*g,s[2]=d*g,s[3]=m*g,s}function ms(s,e,o){var c=e[0],d=e[1],m=e[2],g=e[3];return s[0]=o[0]*c+o[4]*d+o[8]*m+o[12]*g,s[1]=o[1]*c+o[5]*d+o[9]*m+o[13]*g,s[2]=o[2]*c+o[6]*d+o[10]*m+o[14]*g,s[3]=o[3]*c+o[7]*d+o[11]*m+o[15]*g,s}function Ba(){var s=new Ni(4);return Ni!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s[3]=1,s}function Ta(s){return s[0]=0,s[1]=0,s[2]=0,s[3]=1,s}function mc(s,e,o){o*=.5;var c=e[0],d=e[1],m=e[2],g=e[3],x=Math.sin(o),w=Math.cos(o);return s[0]=c*w+g*x,s[1]=d*w+m*x,s[2]=m*w-d*x,s[3]=g*w-c*x,s}function Ml(s,e,o){o*=.5;var c=e[0],d=e[1],m=e[2],g=e[3],x=Math.sin(o),w=Math.cos(o);return s[0]=c*w-m*x,s[1]=d*w+g*x,s[2]=m*w+c*x,s[3]=g*w-d*x,s}jn(),Ad();var Yo,Ko,bu,Va=Ms,wu=(Yo=jn(),Ko=dr(1,0,0),bu=dr(0,1,0),function(s,e,o){var c=ir(e,o);return c<-.999999?(yi(Yo,Ko,e),Al(Yo)<1e-6&&yi(Yo,bu,e),Ai(Yo,Yo),function(d,m,g){g*=.5;var x=Math.sin(g);d[0]=x*m[0],d[1]=x*m[1],d[2]=x*m[2],d[3]=Math.cos(g)}(s,Yo,Math.PI),s):c>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(yi(Yo,e,o),s[0]=Yo[0],s[1]=Yo[1],s[2]=Yo[2],s[3]=1+c,Va(s,s))});function So(){var s=new Ni(2);return Ni!=Float32Array&&(s[0]=0,s[1]=0),s}function Gr(s,e){var o=new Ni(2);return o[0]=s,o[1]=e,o}function ja(s,e,o){return s[0]=e[0]+o[0],s[1]=e[1]+o[1],s}function Ua(s,e,o){return s[0]=e[0]-o[0],s[1]=e[1]-o[1],s}function Ha(s,e,o){return s[0]=e[0]*o,s[1]=e[1]*o,s}function Pl(s){return Math.hypot(s[0],s[1])}function Eu(s,e){var o=e[0],c=e[1],d=o*o+c*c;return d>0&&(d=1/Math.sqrt(d)),s[0]=e[0]*d,s[1]=e[1]*d,s}function Ti(s,e){return s[0]*e[0]+s[1]*e[1]}Ba(),Ba(),Id();var Md,Pd,Ps=Ua;function Rd(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}So();var Tu=Rd(function(){if(Pd)return Md;function s(e,o,c,d){this.cx=3*e,this.bx=3*(c-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*o,this.by=3*(d-o)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=o,this.p2x=c,this.p2y=d}return Pd=1,Md=s,s.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,o){if(void 0===o&&(o=1e-6),e<0)return 0;if(e>1)return 1;for(var c=e,d=0;d<8;d++){var m=this.sampleCurveX(c)-e;if(Math.abs(m)<o)return c;var g=this.sampleCurveDerivativeX(c);if(Math.abs(g)<1e-6)break;c-=m/g}var x=0,w=1;for(c=e,d=0;d<20&&(m=this.sampleCurveX(c),!(Math.abs(m-e)<o));d++)e>m?x=c:w=c,c=.5*(w-x)+x;return c},solve:function(e,o){return this.sampleCurveY(this.solveCurveX(e,o))}},Md}());function Je(s,e){this.x=s,this.y=e}function Ga(s,e){if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let o=0;o<s.length;o++)if(!Ga(s[o],e[o]))return!1;return!0}if("object"==typeof s&&null!==s&&null!==e){if("object"!=typeof e||Object.keys(s).length!==Object.keys(e).length)return!1;for(const o in s)if(!Ga(s[o],e[o]))return!1;return!0}return s===e}Je.prototype={clone(){return new Je(this.x,this.y)},add(s){return this.clone()._add(s)},sub(s){return this.clone()._sub(s)},multByPoint(s){return this.clone()._multByPoint(s)},divByPoint(s){return this.clone()._divByPoint(s)},mult(s){return this.clone()._mult(s)},div(s){return this.clone()._div(s)},rotate(s){return this.clone()._rotate(s)},rotateAround(s,e){return this.clone()._rotateAround(s,e)},matMult(s){return this.clone()._matMult(s)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(s){return this.x===s.x&&this.y===s.y},dist(s){return Math.sqrt(this.distSqr(s))},distSqr(s){const e=s.x-this.x,o=s.y-this.y;return e*e+o*o},angle(){return Math.atan2(this.y,this.x)},angleTo(s){return Math.atan2(this.y-s.y,this.x-s.x)},angleWith(s){return this.angleWithSep(s.x,s.y)},angleWithSep(s,e){return Math.atan2(this.x*e-this.y*s,this.x*s+this.y*e)},_matMult(s){const e=s[2]*this.x+s[3]*this.y;return this.x=s[0]*this.x+s[1]*this.y,this.y=e,this},_add(s){return this.x+=s.x,this.y+=s.y,this},_sub(s){return this.x-=s.x,this.y-=s.y,this},_mult(s){return this.x*=s,this.y*=s,this},_div(s){return this.x/=s,this.y/=s,this},_multByPoint(s){return this.x*=s.x,this.y*=s.y,this},_divByPoint(s){return this.x/=s.x,this.y/=s.y,this},_unit(){return this._div(this.mag()),this},_perp(){const s=this.y;return this.y=this.x,this.x=-s,this},_rotate(s){const e=Math.cos(s),o=Math.sin(s),c=o*this.x+e*this.y;return this.x=e*this.x-o*this.y,this.y=c,this},_rotateAround(s,e){const o=Math.cos(s),c=Math.sin(s),d=e.y+c*(this.x-e.x)+o*(this.y-e.y);return this.x=e.x+o*(this.x-e.x)-c*(this.y-e.y),this.y=d,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Je},Je.convert=function(s){if(s instanceof Je)return s;if(Array.isArray(s))return new Je(+s[0],+s[1]);if(void 0!==s.x&&void 0!==s.y)return new Je(+s.x,+s.y);throw new Error("Expected [x, y] or {x, y} point format")};const Op=Math.PI/180,sf=180/Math.PI;function Pn(s){return s*Op}function Pe(s){return s*sf}const Z=[[0,0],[1,0],[1,1],[0,1]];function X(s){if(s<=0)return 0;if(s>=1)return 1;const e=s*s,o=e*s;return 4*(s<.5?o:3*(s-e)+o-.75)}function oe(s,e,o,c){const d=new Tu(s,e,o,c);return function(m){return d.solve(m)}}const ge=oe(.25,.1,.25,1);function se(s,e,o){return Math.min(o,Math.max(e,s))}function be(s,e,o){return(o=se((o-s)/(e-s),0,1))*o*(3-2*o)}function ke(s,e,o){const c=o-e,d=((s-e)%c+c)%c+e;return d===e?o:d}function Te(s,e,o){if(!s.length)return o(null,[]);let c=s.length;const d=new Array(s.length);let m=null;s.forEach((g,x)=>{e(g,(w,T)=>{w&&(m=w),d[x]=T,0==--c&&o(m,d)})})}function Ae(s,...e){for(const o of e)for(const c in o)s[c]=o[c];return s}let st=1;function qe(){return st++}function kt(s){return s<=1?1:Math.pow(2,Math.ceil(Math.log(s)/Math.LN2))}function Gt(s,e){s.forEach(o=>{e[o]&&(e[o]=e[o].bind(e))})}function Wt(s,e,o){const c={};for(const d in s)c[d]=e.call(this,s[d],d,s);return c}function bn(s,e,o){const c={};for(const d in s)e.call(this,s[d],d,s)&&(c[d]=s[d]);return c}function pn(s){return Array.isArray(s)?s.map(pn):"object"==typeof s&&s?Wt(s,pn):s}function cn(s,e){for(let o=0;o<s.length;o++)if(e.indexOf(s[o])>=0)return!0;return!1}const pi={};function yn(s){pi[s]||(typeof console<"u"&&console.warn(s),pi[s]=!0)}function Qi(s,e,o){return(o.y-s.y)*(e.x-s.x)>(e.y-s.y)*(o.x-s.x)}function wr(s){let e=0;for(let o,c,d=0,m=s.length,g=m-1;d<m;g=d++)o=s[d],c=s[g],e+=(c.x-o.x)*(o.y+c.y);return e}function Pr([s,e,o]){const c=Pn(e+90),d=Pn(o);return{x:s*Math.cos(c)*Math.sin(d),y:s*Math.sin(c)*Math.sin(d),z:s*Math.cos(d),azimuthal:e,polar:o}}function li(s){return(typeof self<"u"||void 0!==s)&&typeof WorkerGlobalScope<"u"&&(void 0!==s?s:self)instanceof WorkerGlobalScope}function Bn(s){const e={};if(s.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(o,c,d,m)=>{const g=d||m;return e[c]=!g||g.toLowerCase(),""}),e["max-age"]){const o=parseInt(e["max-age"],10);isNaN(o)?delete e["max-age"]:e["max-age"]=o}return e}let ji=null;function Ui(s,e){return[s[4*e],s[4*e+1],s[4*e+2],s[4*e+3]]}function Si(s,e,o,c){for(;e<o;){const d=e+o>>1;s[d]<c?e=d+1:o=d}return e}function $r(s,e,o,c){for(;e<o;){const d=e+o>>1;s[d]<=c?e=d+1:o=d}return e}function Bo(s){return s>0?1/(1.001-s):1+s}function ho(s){return s>0?1-1/(1.001-s):-s}function Od(s,e,o){return(s-e.min)*(o.max-o.min)/(e.max-e.min)+o.min}const no={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!no.API_URL)return null;try{const s=new URL(no.API_URL);return"api.mapbox.cn"===s.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===s.hostname?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.1.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Rl(s){return no.API_URL_REGEX.test(s)}function af(s){return no.API_SPRITE_REGEX.test(s)}let Su,Ld,lf,Ol,$a,Du;function gc(){return null==Su&&(Su=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),Su}const Us={now:()=>void 0!==Ol?Ol:performance.now(),setNow(s){Ol=s},restoreNow(){Ol=void 0},frame(s){const e=requestAnimationFrame(s);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(s,e=0){const{width:o,height:c}=s;$a||($a=document.createElement("canvas"));const d=$a.getContext("2d",{willReadFrequently:!0});if(!d)throw new Error("failed to create canvas 2d context");return(o>$a.width||c>$a.height)&&($a.width=o,$a.height=c),d.clearRect(-e,-e,o+2*e,c+2*e),d.drawImage(s,0,0,o,c),d.getImageData(-e,-e,o+2*e,c+2*e)},resolveURL:s=>(Ld||(Ld=document.createElement("a")),Ld.href=s,Ld.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==lf&&(lf=window.matchMedia("(prefers-reduced-motion: reduce)")),lf.matches)},hasCanvasFingerprintNoise(){if(void 0!==Du)return Du;if(!gc())return Du=!1,!1;const s=new OffscreenCanvas(85,1),e=s.getContext("2d",{willReadFrequently:!0});let o=0;for(let d=0;d<s.width;++d)e.fillStyle=`rgba(${o++},${o++},${o++}, 255)`,e.fillRect(d,0,1,1);const c=e.getImageData(0,0,s.width,s.height);o=0;for(let d=0;d<c.data.length;++d)if(d%4!=3&&o++!==c.data[d])return Du=!0,!0;return Du=!1,!1}};function Qo(s,e){const o=s.indexOf("?");if(o<0)return`${s}?${new URLSearchParams(e).toString()}`;const c=new URLSearchParams(s.slice(o));for(const d in e)c.set(d,e[d]);return`${s.slice(0,o)}?${c.toString()}`}function Hs(s,e={persistentParams:[]}){const o=s.indexOf("?");if(o<0)return s;const c=new URLSearchParams,d=new URLSearchParams(s.slice(o));for(const g of e.persistentParams){const x=d.get(g);x&&c.set(g,x)}const m=c.toString();return`${s.slice(0,o)}${m.length>0?`?${m}`:""}`}const Sa="mapbox-tiles";let oa=500,Di=50;const Ll=["language","worldview","jobid"];let sr,_c;function yc(){try{return caches}catch{}}function kl(){const s=yc();s&&null==sr&&(sr=s.open(Sa))}let Fn=1/0;const kd={supported:!1,testSupport:function(s){!Cu&&Iu&&(Pt?$n(s):Do=s)}};let Do,Iu,Cu=!1,Pt=!1;const Fd=typeof self<"u"?self:{};function $n(s){const e=s.createTexture();s.bindTexture(s.TEXTURE_2D,e);try{if(s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,Iu),s.isContextLost())return;kd.supported=!0}catch{}s.deleteTexture(e),Cu=!0}Fd.document&&(Iu=Fd.document.createElement("img"),Iu.onload=function(){Do&&$n(Do),Do=null,Pt=!0},Iu.onerror=function(){Cu=!0,Do=null},Iu.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const ki={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(ki);class Rn extends Error{constructor(e,o,c){401===o&&Rl(c)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=o,this.url=c}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Lp=li()?()=>self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href,Au=function(s,e){if(!(/^file:/.test(o=s.url)||/^file:/.test(Lp())&&!/^\w+:/.test(o))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(c,d){const m=new AbortController,g=new Request(c.url,{method:c.method||"GET",body:c.body,credentials:c.credentials,headers:c.headers,referrer:Lp(),referrerPolicy:c.referrerPolicy,signal:m.signal});let x=!1,w=!1;const T=(C=g.url).indexOf("sku=")>0&&Rl(C);var C;"json"===c.type&&g.headers.set("Accept","application/json");const A=(k,F,V)=>{if(w)return;if(k&&"SecurityError"!==k.message&&yn(k.toString()),F&&V)return M(F);const j=Date.now();fetch(g).then(W=>{if(W.ok){const Q=T?W.clone():null;return M(W,Q,j)}return d(new Rn(W.statusText,W.status,c.url))}).catch(W=>{"AbortError"!==W.name&&d(new Error(`${W.message} ${c.url}`))})},M=(k,F,V)=>{("arrayBuffer"===c.type?k.arrayBuffer():"json"===c.type?k.json():k.text()).then(j=>{w||(F&&V&&function(W,Q,K){if(kl(),null==sr)return;const te=Bn(Q.headers.get("Cache-Control")||"");if(te["no-store"])return;const me={status:Q.status,statusText:Q.statusText,headers:new Headers};Q.headers.forEach((xe,Ee)=>me.headers.set(Ee,xe)),te["max-age"]&&me.headers.set("Expires",new Date(K+1e3*te["max-age"]).toUTCString());const he=me.headers.get("Expires");if(!he||new Date(he).getTime()-K<42e4)return;let fe=Hs(W.url,{persistentParams:Ll});if(206===Q.status){const xe=W.headers.get("Range");if(!xe)return;me.status=200,fe=Qo(fe,{range:xe})}!function(xe,Ee){if(void 0===_c)try{new Response(new ReadableStream),_c=!0}catch{_c=!1}_c?Ee(xe.body):xe.blob().then(Ee).catch(Ve=>yn(Ve.message))}(Q,xe=>{const Ee=new Response(200!==(Ve=Q.status)&&404!==Ve&&[101,103,204,205,304].includes(Ve)?null:xe,me);var Ve;kl(),sr?.then(Ie=>Ie.put(fe,Ee)).catch(Ie=>yn(Ie.message))})}(g,F,V),x=!0,d(null,j,k.headers.get("Cache-Control"),k.headers.get("Expires")))}).catch(j=>{w||d(new Error(j.message))})};return T?function(k,F){if(kl(),null==sr)return F(null);sr.then(V=>{let j=Hs(k.url,{persistentParams:Ll});const W=k.headers.get("Range");W&&(j=Qo(j,{range:W})),V.match(j).then(Q=>{const K=function(te){if(!te)return!1;const me=new Date(te.headers.get("Expires")||0),he=Bn(te.headers.get("Cache-Control")||"");return Number(me)>Date.now()&&!he["no-cache"]}(Q);V.delete(j).catch(F),K&&V.put(j,Q.clone()).catch(F),F(null,Q,K)}).catch(F)}).catch(F)}(g,A):A(null,null),{cancel:()=>{w=!0,x||m.abort()}}}(s,e);if(li(self)&&self.worker.actor)return self.worker.actor.send("getResource",s,e,void 0,!0)}var o;return function(c,d){const m=new XMLHttpRequest;m.open(c.method||"GET",c.url,!0),"arrayBuffer"===c.type&&(m.responseType="arraybuffer");for(const g in c.headers)m.setRequestHeader(g,c.headers[g]);return"json"===c.type&&(m.responseType="text",m.setRequestHeader("Accept","application/json")),m.withCredentials="include"===c.credentials,m.onerror=()=>{d(new Error(m.statusText))},m.onload=()=>{if((m.status>=200&&m.status<300||0===m.status)&&null!==m.response){let g=m.response;if("json"===c.type)try{g=JSON.parse(m.response)}catch(x){return d(x)}d(null,g,m.getResponseHeader("Cache-Control"),m.getResponseHeader("Expires"))}else d(new Rn(m.statusText,m.status,c.url))},m.send(c.body),{cancel:()=>m.abort()}}(s,e)},vc=function(s,e){return Au(Ae(s,{type:"arrayBuffer"}),e)};function Rs(s){const e=document.createElement("a");return e.href=s,e.protocol===location.protocol&&e.host===location.host}const cf="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let xc,bc;xc=[],bc=0;const sa=function(s,e){if(kd.supported&&(s.headers||(s.headers={}),s.headers.accept="image/webp,*/*"),bc>=no.MAX_PARALLEL_IMAGE_REQUESTS){const m={requestParameters:s,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return xc.push(m),m}bc++;let o=!1;const c=()=>{if(!o)for(o=!0,bc--;xc.length&&bc<no.MAX_PARALLEL_IMAGE_REQUESTS;){const m=xc.shift(),{requestParameters:g,callback:x,cancelled:w}=m;w||(m.cancel=sa(g,x).cancel)}},d=vc(s,(m,g,x,w)=>{c(),m?e(m):g&&(self.createImageBitmap?function(T,C){const A=new Blob([new Uint8Array(T)],{type:"image/png"});createImageBitmap(A).then(M=>{C(null,M)}).catch(M=>{C(new Error(`Could not load image because of ${M.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(g,(T,C)=>e(T,C,x,w)):function(T,C){const A=new Image;A.onload=()=>{C(null,A),URL.revokeObjectURL(A.src),A.onload=null,requestAnimationFrame(()=>{A.src=cf})},A.onerror=()=>C(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const M=new Blob([new Uint8Array(T)],{type:"image/png"});A.src=T.byteLength?URL.createObjectURL(M):cf}(g,(T,C)=>e(T,C,x,w)))});return{cancel:()=>{d.cancel(),c()}}};var nv,kp,iv,zd={exports:{}},wc={exports:{}},rv={exports:{}},Bd=Rd(function(){if(iv)return zd.exports;iv=1;var s=(nv||(nv=1,wc.exports=function(o,c){var d,m,g,x,w,T,C,A;for(m=o.length-(d=3&o.length),g=c,w=3432918353,T=461845907,A=0;A<m;)C=255&o.charCodeAt(A)|(255&o.charCodeAt(++A))<<8|(255&o.charCodeAt(++A))<<16|(255&o.charCodeAt(++A))<<24,++A,g=27492+(65535&(x=5*(65535&(g=(g^=C=(65535&(C=(C=(65535&C)*w+(((C>>>16)*w&65535)<<16)&4294967295)<<15|C>>>17))*T+(((C>>>16)*T&65535)<<16)&4294967295)<<13|g>>>19))+((5*(g>>>16)&65535)<<16)&4294967295))+((58964+(x>>>16)&65535)<<16);switch(C=0,d){case 3:C^=(255&o.charCodeAt(A+2))<<16;case 2:C^=(255&o.charCodeAt(A+1))<<8;case 1:g^=C=(65535&(C=(C=(65535&(C^=255&o.charCodeAt(A)))*w+(((C>>>16)*w&65535)<<16)&4294967295)<<15|C>>>17))*T+(((C>>>16)*T&65535)<<16)&4294967295}return g^=o.length,g=2246822507*(65535&(g^=g>>>16))+((2246822507*(g>>>16)&65535)<<16)&4294967295,g=3266489909*(65535&(g^=g>>>13))+((3266489909*(g>>>16)&65535)<<16)&4294967295,(g^=g>>>16)>>>0}),wc.exports),e=(kp||(kp=1,rv.exports=function(o,c){for(var d,m=o.length,g=c^m,x=0;m>=4;)d=1540483477*(65535&(d=255&o.charCodeAt(x)|(255&o.charCodeAt(++x))<<8|(255&o.charCodeAt(++x))<<16|(255&o.charCodeAt(++x))<<24))+((1540483477*(d>>>16)&65535)<<16),g=1540483477*(65535&g)+((1540483477*(g>>>16)&65535)<<16)^(d=1540483477*(65535&(d^=d>>>24))+((1540483477*(d>>>16)&65535)<<16)),m-=4,++x;switch(m){case 3:g^=(255&o.charCodeAt(x+2))<<16;case 2:g^=(255&o.charCodeAt(x+1))<<8;case 1:g=1540483477*(65535&(g^=255&o.charCodeAt(x)))+((1540483477*(g>>>16)&65535)<<16)}return g=1540483477*(65535&(g^=g>>>13))+((1540483477*(g>>>16)&65535)<<16),(g^=g>>>15)>>>0}),rv.exports);return zd.exports=s,zd.exports.murmur3=s,zd.exports.murmur2=e,zd.exports}());class qr{constructor(e,...o){Ae(this,o[0]||{}),this.type=e}}class _n extends qr{constructor(e,o={}){super("error",Ae({error:e},o))}}function zg(s,e,o){o[s]&&-1!==o[s].indexOf(e)||(o[s]=o[s]||[],o[s].push(e))}function Ng(s,e,o){if(o&&o[s]){const c=o[s].indexOf(e);-1!==c&&o[s].splice(c,1)}}class Mu{on(e,o){return this._listeners=this._listeners||{},zg(e,o,this._listeners),this}off(e,o){return Ng(e,o,this._listeners),Ng(e,o,this._oneTimeListeners),this}once(e,o){return o?(this._oneTimeListeners=this._oneTimeListeners||{},zg(e,o,this._oneTimeListeners),this):new Promise(c=>{this.once(e,c)})}fire(e,o){const c="string"==typeof e?new qr(e,o):e,d=c.type;if(this.listens(d)){c.target=this;const m=this._listeners&&this._listeners[d]?this._listeners[d].slice():[];for(const w of m)w.call(this,c);const g=this._oneTimeListeners&&this._oneTimeListeners[d]?this._oneTimeListeners[d].slice():[];for(const w of g)Ng(d,w,this._oneTimeListeners),w.call(this,c);const x=this._eventedParent;x&&(Ae(c,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),x.fire(c))}else c instanceof _n&&console.error(c.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,o){return this._eventedParent=e,this._eventedParentData=o,this}}class Qt{constructor(e){"string"==typeof e?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new Qt(e)}static toString(e){return e.iconsetId?`${e.name}\x1f${e.iconsetId}`:e.name}static parse(e){const[o,c]=e.split("\x1f");return new Qt({name:o,iconsetId:c})}static isEqual(e,o){return e.name===o.name&&e.iconsetId===o.iconsetId}toString(){return Qt.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Bg,Or={},Pu=function(){if(Bg)return Or;Bg=1;var s={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(m){return(m=Math.round(m))<0?0:m>255?255:m}function o(m){return e("%"===m[m.length-1]?parseFloat(m)/100*255:parseInt(m))}function c(m){return(g="%"===m[m.length-1]?parseFloat(m)/100:parseFloat(m))<0?0:g>1?1:g;var g}function d(m,g,x){return x<0?x+=1:x>1&&(x-=1),6*x<1?m+(g-m)*x*6:2*x<1?g:3*x<2?m+(g-m)*(2/3-x)*6:m}try{Or.parseCSSColor=function(m){var g,x=m.replace(/ /g,"").toLowerCase();if(x in s)return s[x].slice();if("#"===x[0])return 4===x.length?(g=parseInt(x.substr(1),16))>=0&&g<=4095?[(3840&g)>>4|(3840&g)>>8,240&g|(240&g)>>4,15&g|(15&g)<<4,1]:null:7===x.length&&(g=parseInt(x.substr(1),16))>=0&&g<=16777215?[(16711680&g)>>16,(65280&g)>>8,255&g,1]:null;var w=x.indexOf("("),T=x.indexOf(")");if(-1!==w&&T+1===x.length){var C=x.substr(0,w),A=x.substr(w+1,T-(w+1)).split(","),M=1;switch(C){case"rgba":if(4!==A.length)return null;M=c(A.pop());case"rgb":return 3!==A.length?null:[o(A[0]),o(A[1]),o(A[2]),M];case"hsla":if(4!==A.length)return null;M=c(A.pop());case"hsl":if(3!==A.length)return null;var k=(parseFloat(A[0])%360+360)%360/360,F=c(A[1]),V=c(A[2]),j=V<=.5?V*(F+1):V+F-V*F,W=2*V-j;return[e(255*d(W,j,k+1/3)),e(255*d(W,j,k)),e(255*d(W,j,k-1/3)),M];default:return null}}return null}}catch{}return Or}();class Yn{constructor(e,o,c,d=1){this.r=e,this.g=o,this.b=c,this.a=d}static parse(e){if(!e)return;if(e instanceof Yn)return e;if("string"!=typeof e)return;const o=Pu.parseCSSColor(e);return o?new Yn(o[0]/255,o[1]/255,o[2]/255,o[3]):void 0}toString(){const[e,o,c,d]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*o)},${Math.round(255*c)},${d})`}toNonPremultipliedRenderColor(e){const{r:o,g:c,b:d,a:m}=this;return new Ou(e,o,c,d,m)}toPremultipliedRenderColor(e){const{r:o,g:c,b:d,a:m}=this;return new Vd(e,o*m,c*m,d*m,m)}clone(){return new Yn(this.r,this.g,this.b,this.a)}}class Ru{constructor(e,o,c,d,m,g=!1){if(this.premultiplied=!1,this.premultiplied=g,e){const x=e.image.height,w=x*x;this.premultiplied?(o=0===m?0:o/m*(x-1),c=0===m?0:c/m*(x-1),d=0===m?0:d/m*(x-1)):(o*=x-1,c*=x-1,d*=x-1);const T=Math.floor(o),C=Math.floor(c),A=Math.floor(d),M=Math.ceil(o),k=Math.ceil(c),F=Math.ceil(d),V=o-T,j=c-C,W=d-A,Q=e.image.data,K=4*(T+C*w+A*x),te=4*(T+C*w+F*x),me=4*(T+k*w+A*x),he=4*(T+k*w+F*x),fe=4*(M+C*w+A*x),xe=4*(M+C*w+F*x),Ee=4*(M+k*w+A*x),Ve=4*(M+k*w+F*x);if(K<0||Ve>=Q.length)throw new Error("out of range");this.r=Ft(Ft(Ft(Q[K],Q[te],W),Ft(Q[me],Q[he],W),j),Ft(Ft(Q[fe],Q[xe],W),Ft(Q[Ee],Q[Ve],W),j),V)/255*(this.premultiplied?m:1),this.g=Ft(Ft(Ft(Q[K+1],Q[te+1],W),Ft(Q[me+1],Q[he+1],W),j),Ft(Ft(Q[fe+1],Q[xe+1],W),Ft(Q[Ee+1],Q[Ve+1],W),j),V)/255*(this.premultiplied?m:1),this.b=Ft(Ft(Ft(Q[K+2],Q[te+2],W),Ft(Q[me+2],Q[he+2],W),j),Ft(Ft(Q[fe+2],Q[xe+2],W),Ft(Q[Ee+2],Q[Ve+2],W),j),V)/255*(this.premultiplied?m:1),this.a=m}else this.r=o,this.g=c,this.b=d,this.a=m}toArray(){const{r:e,g:o,b:c,a:d}=this;return[255*e,255*o,255*c,d]}toHslaArray(){let{r:e,g:o,b:c,a:d}=this;if(this.premultiplied){if(0===d)return[0,0,0,0];e/=d,o/=d,c/=d}const m=Math.min(Math.max(e,0),1),g=Math.min(Math.max(o,0),1),x=Math.min(Math.max(c,0),1),w=Math.min(m,g,x),T=Math.max(m,g,x),C=(w+T)/2;if(w===T)return[0,0,100*C,d];const A=T-w,M=C>.5?A/(2-T-w):A/(T+w);let k=0;return T===m?k=(g-x)/A+(g<x?6:0):T===g?k=(x-m)/A+2:T===x&&(k=(m-g)/A+4),k*=60,[Math.min(Math.max(k,0),360),Math.min(Math.max(100*M,0),100),Math.min(Math.max(100*C,0),100),d]}toArray01(){const{r:e,g:o,b:c,a:d}=this;return[e,o,c,d]}toArray01Scaled(e){const{r:o,g:c,b:d}=this;return[o*e,c*e,d*e]}toArray01Linear(){const{r:e,g:o,b:c,a:d}=this;return[Math.pow(e,2.2),Math.pow(o,2.2),Math.pow(c,2.2),d]}}class Ou extends Ru{constructor(e,o,c,d,m){super(e,o,c,d,m,!1)}}class Vd extends Ru{constructor(e,o,c,d,m){super(e,o,c,d,m,!0)}}function Ft(s,e,o){return s*(1-o)+e*o}function uf(s,e,o){return s.map((c,d)=>Ft(c,e[d],o))}Yn.black=new Yn(0,0,0,1),Yn.white=new Yn(1,1,1,1),Yn.transparent=new Yn(0,0,0,0),Yn.red=new Yn(1,0,0,1),Yn.blue=new Yn(0,0,1,1);var Lu=Object.freeze({__proto__:null,array:uf,color:function(s,e,o){return new Yn(Ft(s.r,e.r,o),Ft(s.g,e.g,o),Ft(s.b,e.b,o),Ft(s.a,e.a,o))},number:Ft});function Ec(s,...e){for(const o of e)for(const c in o)s[c]=o[c];return s}class Un extends Error{constructor(e,o){super(o),this.message=o,this.key=e}}class jd{constructor(e,o=[]){this.parent=e,this.bindings={};for(const[c,d]of o)this.bindings[c]=d}concat(e){return new jd(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Tc={kind:"null"},Et={kind:"number"},Hn={kind:"string"},Zn={kind:"boolean"},mi={kind:"color"},Fl={kind:"object"},Kn={kind:"value"},Jt={kind:"collator"},Sc={kind:"formatted"},Dc={kind:"resolvedImage"};function fo(s,e){return{kind:"array",itemType:s,N:e}}function yr(s){if("array"===s.kind){const e=yr(s.itemType);return"number"==typeof s.N?`array<${e}, ${s.N}>`:"value"===s.itemType.kind?"array":`array<${e}>`}return s.kind}const ov=[Tc,Et,Hn,Zn,mi,Sc,Fl,fo(Kn),Dc];function zl(s,e){if("error"===e.kind)return null;if("array"===s.kind){if("array"===e.kind&&(0===e.N&&"value"===e.itemType.kind||!zl(s.itemType,e.itemType))&&("number"!=typeof s.N||s.N===e.N))return null}else{if(s.kind===e.kind)return null;if("value"===s.kind)for(const o of ov)if(!zl(o,e))return null}return`Expected ${yr(s)} but found ${yr(e)} instead.`}function Ic(s,e){return e.some(o=>o.kind===s.kind)}function df(s,e){return e.some(o=>"null"===o?null===s:"array"===o?Array.isArray(s):"object"===o?s&&!Array.isArray(s)&&"object"==typeof s:o===typeof s)}function Fp(s,e){return"array"===s.kind&&"array"===e.kind?s.N===e.N&&Fp(s.itemType,e.itemType):s.kind===e.kind}class hf{constructor(e,o,c){this.sensitivity=e?o?"variant":"case":o?"accent":"base",this.locale=c,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,o){return this.collator.compare(e,o)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class zp{constructor(e,o,c,d,m){this.text=e.normalize?e.normalize():e,this.image=o,this.scale=c,this.fontStack=d,this.textColor=m}}class Wr{constructor(e){this.sections=e}static fromString(e){return new Wr([new zp(e,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(e=>0!==e.text.length||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Wr?e:Wr.fromString(e)}toString(){return 0===this.sections.length?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const o of this.sections){if(o.image){const d=o.image.getPrimary().id.toString();e.push(["image",d]);continue}e.push(o.text);const c={};o.fontStack&&(c["text-font"]=["literal",o.fontStack.split(",")]),o.scale&&(c["font-scale"]=o.scale),o.textColor&&(c["text-color"]=["rgba"].concat(o.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(c)}return e}}class aa{constructor(e,o={}){if(this.id=Qt.from(e),this.options=Object.assign({},o),o.transform){const{a:c,b:d,c:m,d:g,e:x,f:w}=o.transform;this.options.transform=new DOMMatrix([c,d,m,g,x,w])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:o,c,d,e:m,f:g}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:o,c,d,e:m,f:g}})}static parse(e){let o,c,d,m;try{({name:o,iconsetId:c,params:d,transform:m}=JSON.parse(e)||{})}catch{return null}if(!o)return null;const{a:g,b:x,c:w,d:T,e:C,f:A}=m||{};return new aa({name:o,iconsetId:c},{params:d,transform:new DOMMatrix([g,x,w,T,C,A])})}scaleSelf(e,o){return this.options.transform.scaleSelf(e,o),this}}class po{constructor(e,o,c,d,m=!1){this.primaryId=Qt.from(e),this.primaryOptions=o,c&&(this.secondaryId=Qt.from(c)),this.secondaryOptions=d,this.available=m}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new aa(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new aa(this.secondaryId,this.secondaryOptions):null}static from(e){return"string"==typeof e?po.build({name:e}):e}static build(e,o,c,d){return!e||"object"==typeof e&&!("name"in e)?null:new po(e,c,o,d)}}function Cc(s,e,o,c){return"number"==typeof s&&s>=0&&s<=255&&"number"==typeof e&&e>=0&&e<=255&&"number"==typeof o&&o>=0&&o<=255?void 0===c||"number"==typeof c&&c>=0&&c<=1?null:`Invalid rgba value [${[s,e,o,c].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof c?[s,e,o,c]:[s,e,o]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function an(s){if(null===s||"string"==typeof s||"boolean"==typeof s||"number"==typeof s||s instanceof Yn||s instanceof hf||s instanceof Wr||s instanceof po)return!0;if(Array.isArray(s)){for(const e of s)if(!an(e))return!1;return!0}if("object"==typeof s){for(const e in s)if(!an(s[e]))return!1;return!0}return!1}function bt(s){if(null===s)return Tc;if("string"==typeof s)return Hn;if("boolean"==typeof s)return Zn;if("number"==typeof s)return Et;if(s instanceof Yn)return mi;if(s instanceof hf)return Jt;if(s instanceof Wr)return Sc;if(s instanceof po)return Dc;if(Array.isArray(s)){const e=s.length;let o;for(const c of s){const d=bt(c);if(o){if(o===d)continue;o=Kn;break}o=d}return fo(o||Kn,e)}return Fl}function Os(s){const e=typeof s;return null===s?"":"string"===e||"number"===e||"boolean"===e?String(s):s instanceof Wr||s instanceof po||s instanceof Yn?s.toString():JSON.stringify(s)}class Bt{constructor(e,o){this.type=e,this.value=o}static parse(e,o){if(2!==e.length)return o.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!an(e[1]))return o.error("invalid value");const c=e[1];let d=bt(c);const m=o.expectedType;return"array"!==d.kind||0!==d.N||!m||"array"!==m.kind||"number"==typeof m.N&&0!==m.N||(d=m),new Bt(d,c)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Yn?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Wr?this.value.serialize():this.value}}class Er{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const Gs={string:Hn,number:Et,boolean:Zn,object:Fl};class Nt{constructor(e,o){this.type=e,this.args=o}static parse(e,o){if(e.length<2)return o.error("Expected at least one argument.");let c,d=1;const m=e[0];if("array"===m){let x,w;if(e.length>2){const T=e[1];if("string"!=typeof T||!(T in Gs)||"object"===T)return o.error('The item type argument of "array" must be one of string, number, boolean',1);x=Gs[T],d++}else x=Kn;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return o.error('The length argument to "array" must be a positive integer literal',2);w=e[2],d++}c=fo(x,w)}else c=Gs[m];const g=[];for(;d<e.length;d++){const x=o.parse(e[d],d,Kn);if(!x)return null;g.push(x)}return new Nt(c,g)}evaluate(e){for(let o=0;o<this.args.length;o++){const c=this.args[o].evaluate(e);if(!zl(this.type,bt(c)))return c;if(o===this.args.length-1)throw new Er(`The expression ${JSON.stringify(this.args[o].serialize())} evaluated to ${yr(bt(c))} but was expected to be of type ${yr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,o=[e.kind];if("array"===e.kind){const c=e.itemType;if("string"===c.kind||"number"===c.kind||"boolean"===c.kind){o.push(c.kind);const d=e.N;("number"==typeof d||this.args.length>1)&&o.push(d)}}return o.concat(this.args.map(c=>c.serialize()))}}class gt{constructor(e){this.type=Sc,this.sections=e}static parse(e,o){if(e.length<2)return o.error("Expected at least one argument.");const c=e[1];if(!Array.isArray(c)&&"object"==typeof c)return o.error("First argument must be an image or text section.");const d=[];let m=!1;for(let g=1;g<=e.length-1;++g){const x=e[g];if(m&&"object"==typeof x&&!Array.isArray(x)){m=!1;let w=null;if(x["font-scale"]&&(w=o.parseObjectValue(x["font-scale"],g,"font-scale",Et),!w))return null;let T=null;if(x["text-font"]&&(T=o.parseObjectValue(x["text-font"],g,"text-font",fo(Hn)),!T))return null;let C=null;if(x["text-color"]&&(C=o.parseObjectValue(x["text-color"],g,"text-color",mi),!C))return null;const A=d[d.length-1];A.scale=w,A.font=T,A.textColor=C}else{const w=o.parse(e[g],g,Kn);if(!w)return null;const T=w.type.kind;if("string"!==T&&"value"!==T&&"null"!==T&&"resolvedImage"!==T)return o.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");m=!0,d.push({content:w,scale:null,font:null,textColor:null})}}return new gt(d)}evaluate(e){return new Wr(this.sections.map(o=>{const c=o.content.evaluate(e);return Fp(bt(c),Dc)?new zp("",c,null,null,null):new zp(Os(c),null,o.scale?o.scale.evaluate(e):null,o.font?o.font.evaluate(e).join(","):null,o.textColor?o.textColor.evaluate(e):null)}))}eachChild(e){for(const o of this.sections)e(o.content),o.scale&&e(o.scale),o.font&&e(o.font),o.textColor&&e(o.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const o of this.sections){e.push(o.content.serialize());const c={};o.scale&&(c["font-scale"]=o.scale.serialize()),o.font&&(c["text-font"]=o.font.serialize()),o.textColor&&(c["text-color"]=o.textColor.serialize()),e.push(c)}return e}}class Ac{constructor(e,o,c,d){this._imageWarnHistory={},this.type=Dc,this.namePrimary=e,this.nameSecondary=o,c&&(this.paramsPrimary=c.params,this.iconsetIdPrimary=c.iconset?c.iconset.id:void 0),d&&(this.paramsSecondary=d.params,this.iconsetIdSecondary=d.iconset?d.iconset.id:void 0)}static parse(e,o){if(e.length<2)return o.error("Expected two or more arguments.");let c=1;const d=[];function m(){if(c<e.length){const x=o.parse(e[c],c++,Hn);return x?(d.push({image:x,options:{}}),!0):(o.error(d.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function g(){if(c<e.length){const w=e[c];if(null===(x=w)||"object"!=typeof x||Array.isArray(x))return!0;const T=w.params,C=w.iconset,A=o.concat(c);if(!T&&!C)return c++,!0;if(T){if("object"!=typeof T||T.constructor!==Object)return A.error('Image options "params" should be an object'),!1;const M={},k=A.concat(void 0,"params");for(const F in T){if(!F)return k.error("Image parameter name should be non-empty"),!1;const V=k.concat(void 0,F).parse(T[F],void 0,mi,void 0,{typeAnnotation:"coerce"});if(!V)return!1;M[F]=V}d[d.length-1].options.params=M}if(C){if("object"!=typeof C||C.constructor!==Object)return A.error('Image options "iconset" should be an object'),!1;if(!C.id)return A.error('Image options "iconset" should have an "id" property'),!1;d[d.length-1].options.iconset=C}return c++,!0}var x;return!0}for(let x=0;x<2;x++)if(!m()||!g())return;return new Ac(d[0].image,d[1]?d[1].image:void 0,d[0].options,d[1]?d[1].options:void 0)}evaluateParams(e,o){const c={};if(o){for(const d in o)if(o[d])try{c[d]=o[d].evaluate(e)}catch{continue}if(0!==Object.keys(c).length)return{params:c}}}evaluate(e){const o={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},c=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,d=po.build(o,c,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(d&&e.availableImages){const m=d.getPrimary().id;if(d.available=e.availableImages.some(g=>Qt.isEqual(g,m)),d.available){const g=d.getSecondary()?d.getSecondary().id:null;g&&(d.available=e.availableImages.some(x=>Qt.isEqual(x,g)))}}return d}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const o in this.paramsPrimary)this.paramsPrimary[o]&&e(this.paramsPrimary[o]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const o in this.paramsSecondary)this.paramsSecondary[o]&&e(this.paramsSecondary[o])}outputDefined(){return!1}serializeOptions(e,o){const c={};if(o&&(c.iconset={id:o}),e){c.params={};for(const d in e)e[d]&&(c.params[d]=e[d].serialize())}return Object.keys(c).length>0?c:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const o=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);o&&e.push(o)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const o=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);o&&e.push(o)}return e}}function di(s){return s instanceof Number?"number":s instanceof String?"string":s instanceof Boolean?"boolean":Array.isArray(s)?"array":null===s?"null":typeof s}const Ud={"to-boolean":Zn,"to-color":mi,"to-number":Et,"to-string":Hn};class gs{constructor(e,o){this.type=e,this.args=o}static parse(e,o){if(e.length<2)return o.error("Expected at least one argument.");const c=e[0],d=[];let m=Tc;if("to-array"===c){if(!Array.isArray(e[1]))return null;const g=e[1].length;if(o.expectedType){if("array"!==o.expectedType.kind)return o.error(`Expected ${o.expectedType.kind} but found array.`);m=fo(o.expectedType.itemType,g)}else{if(!(g>0&&an(e[1][0])))return null;m=fo(bt(e[1][0]),g)}for(let x=0;x<g;x++){const w=e[1][x];let T;if("array"===di(w))T=o.parse(w,void 0,m.itemType);else{const C=di(w);if(C!==m.itemType.kind)return o.error(`Expected ${m.itemType.kind} but found ${C}.`);T=o.registry.literal.parse(["literal",void 0===w?null:w],o)}if(!T)return null;d.push(T)}}else{if(("to-boolean"===c||"to-string"===c)&&2!==e.length)return o.error("Expected one argument.");m=Ud[c];for(let g=1;g<e.length;g++){const x=o.parse(e[g],g,Kn);if(!x)return null;d.push(x)}}return new gs(m,d)}evaluate(e){if("boolean"===this.type.kind)return!!this.args[0].evaluate(e);if("color"===this.type.kind){let o,c;for(const d of this.args){if(o=d.evaluate(e),c=null,o instanceof Yn)return o;if("string"==typeof o){const m=e.parseColor(o);if(m)return m}else if(Array.isArray(o)&&(c=o.length<3||o.length>4?`Invalid rbga value ${JSON.stringify(o)}: expected an array containing either three or four numeric values.`:Cc(o[0],o[1],o[2],o[3]),!c))return new Yn(o[0]/255,o[1]/255,o[2]/255,o[3])}throw new Er(c||`Could not parse color from value '${"string"==typeof o?o:String(JSON.stringify(o))}'`)}if("number"===this.type.kind){let o=null;for(const c of this.args){if(o=c.evaluate(e),null===o)return 0;const d=Number(o);if(!isNaN(d))return d}throw new Er(`Could not convert ${JSON.stringify(o)} to number.`)}return"formatted"===this.type.kind?Wr.fromString(Os(this.args[0].evaluate(e))):"resolvedImage"===this.type.kind?po.build(Os(this.args[0].evaluate(e))):"array"===this.type.kind?this.args.map(o=>o.evaluate(e)):Os(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if("formatted"===this.type.kind)return new gt([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Ac(this.args[0]).serialize();const e="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild(o=>{e.push(o.serialize())}),e}}const Zr=["Unknown","Point","LineString","Polygon"];class Hd{constructor(e,o){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=o}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Zr[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,o=this.featureDistanceData.scale,{x:c,y:d}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(c*o-e[0])+this.featureDistanceData.bearing[1]*(d*o-e[1])}return 0}parseColor(e){let o=this._parseColorCache[e];return o||(o=this._parseColorCache[e]=Yn.parse(e)),o}getConfig(e){return this.options?this.options.get(e):null}}class Xr{constructor(e,o,c,d,m){this.name=e,this.type=o,this._evaluate=c,this.args=d,this._overloadIndex=m}evaluate(e){if(!this._evaluate){const o=Xr.definitions[this.name];this._evaluate=Array.isArray(o)?o[2]:o.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,o){const c=e[0],d=Xr.definitions[c];if(!d)return o.error(`Unknown expression "${c}". If you wanted a literal array, use ["literal", [...]].`,0);const m=Array.isArray(d)?d[0]:d.type,g=Array.isArray(d)?[[d[1],d[2]]]:d.overloads,x=[];let w=null,T=-1;for(const[C,A]of g){if(Array.isArray(C)&&C.length!==e.length-1)continue;x.push(C),T++,w=new Yd(o.registry,o.path,null,o.scope,void 0,o._scope,o.options);const M=[];let k=!1;for(let F=1;F<e.length;F++){const V=e[F],j=Array.isArray(C)?C[F-1]:C.type,W=w.parse(V,1+M.length,j);if(!W){k=!0;break}M.push(W)}if(!k)if(Array.isArray(C)&&C.length!==M.length)w.error(`Expected ${C.length} arguments, but found ${M.length} instead.`);else{for(let F=0;F<M.length;F++){const V=Array.isArray(C)?C[F]:C.type,j=M[F];w.concat(F+1).checkSubtype(V,j.type)}if(0===w.errors.length)return new Xr(c,m,A,M,T)}}if(1===x.length)o.errors.push(...w.errors);else{const C=(x.length?x:g.map(([M])=>M)).map(Np).join(" | "),A=[];for(let M=1;M<e.length;M++){const k=o.parse(e[M],1+A.length);if(!k)return null;A.push(yr(k.type))}o.error(`Expected arguments of type ${C}, but found (${A.join(", ")}) instead.`)}return null}static register(e,o){Xr.definitions=o;for(const c in o)e[c]=Xr}}function Np(s){return Array.isArray(s)?`(${s.map(yr).join(", ")})`:`(${yr(s.type)}...)`}class mo{constructor(e,o,c){this.type=Jt,this.locale=c,this.caseSensitive=e,this.diacriticSensitive=o}static parse(e,o){if(2!==e.length)return o.error("Expected one argument.");const c=e[1];if("object"!=typeof c||Array.isArray(c))return o.error("Collator options argument must be an object.");const d=void 0===c["case-sensitive"]?o.parse(!1,1,Zn):o.parseObjectValue(c["case-sensitive"],1,"case-sensitive",Zn);if(!d)return null;const m=void 0===c["diacritic-sensitive"]?o.parse(!1,1,Zn):o.parseObjectValue(c["diacritic-sensitive"],1,"diacritic-sensitive",Zn);if(!m)return null;let g=null;return c.locale&&(g=o.parseObjectValue(c.locale,1,"locale",Hn),!g)?null:new mo(d,m,g)}evaluate(e){return new hf(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Yr(s,e,o=0,c=s.length-1,d=Da){for(;c>o;){if(c-o>600){const w=c-o+1,T=e-o+1,C=Math.log(w),A=.5*Math.exp(2*C/3),M=.5*Math.sqrt(C*A*(w-A)/w)*(T-w/2<0?-1:1);Yr(s,e,Math.max(o,Math.floor(e-T*A/w+M)),Math.min(c,Math.floor(e+(w-T)*A/w+M)),d)}const m=s[e];let g=o,x=c;for(Vo(s,o,e),d(s[c],m)>0&&Vo(s,o,c);g<x;){for(Vo(s,g,x),g++,x--;d(s[g],m)<0;)g++;for(;d(s[x],m)>0;)x--}0===d(s[o],m)?Vo(s,o,x):(x++,Vo(s,x,c)),x<=e&&(o=x+1),e<=x&&(c=x-1)}}function Vo(s,e,o){const c=s[e];s[e]=s[o],s[o]=c}function Da(s,e){return s<e?-1:s>e?1:0}function Hi(s){let e=0;for(let o,c,d=0,m=s.length,g=m-1;d<m;g=d++)o=s[d],c=s[g],e+=(c.x-o.x)*(o.y+c.y);return e}function la(s,e){s[0]=Math.min(s[0],e[0]),s[1]=Math.min(s[1],e[1]),s[2]=Math.max(s[2],e[0]),s[3]=Math.max(s[3],e[1])}function Nl(s,e){return!(s[0]<=e[0]||s[2]>=e[2]||s[1]<=e[1]||s[3]>=e[3])}function qa(s,e,o){const c=s[0]-e[0],d=s[1]-e[1],m=s[0]-o[0],g=s[1]-o[1];return c*g-m*d==0&&c*m<=0&&d*g<=0}function Mc(s,e,o=!1){let c=!1;for(let x=0,w=e.length;x<w;x++){const T=e[x];for(let C=0,A=T.length,M=A-1;C<A;M=C++){const k=T[M],F=T[C];if(qa(s,k,F))return o;(m=k)[1]>(d=s)[1]!=(g=F)[1]>d[1]&&d[0]<(g[0]-m[0])*(d[1]-m[1])/(g[1]-m[1])+m[0]&&(c=!c)}}var d,m,g;return c}function Ia(s,e,o,c){const d=c[0]-o[0],m=c[1]-o[1],g=(s[0]-o[0])*m-d*(s[1]-o[1]),x=(e[0]-o[0])*m-d*(e[1]-o[1]);return g>0&&x<0||g<0&&x>0}function Bl(s,e,o,c){return(d=[c[0]-o[0],c[1]-o[1]])[0]*(m=[e[0]-s[0],e[1]-s[1]])[1]-d[1]*m[0]!=0&&!(!Ia(s,e,o,c)||!Ia(o,c,s,e));var d,m}function ff(s){const e=new Je(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),o=new Je(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const c of s[0])e.x>c.x&&(e.x=c.x),e.y>c.y&&(e.y=c.y),o.x<c.x&&(o.x=c.x),o.y<c.y&&(o.y=c.y);return{min:e,max:o}}const Wa=8192;function Bp(s,e){const o=(180+s[0])/360,c=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+s[1]*Math.PI/360)))/360,d=Math.pow(2,e.z);return[Math.round(o*d*Wa),Math.round(c*d*Wa)]}function Vp(s,e){for(let o=0;o<e.length;o++)if(Mc(s,e[o]))return!0;return!1}function Vg(s,e,o){for(const c of o)for(let d=0,m=c.length,g=m-1;d<m;g=d++)if(Bl(s,e,c[g],c[d]))return!0;return!1}function ku(s,e){for(let o=0;o<s.length;++o)if(!Mc(s[o],e))return!1;for(let o=0;o<s.length-1;++o)if(Vg(s[o],s[o+1],e))return!1;return!0}function jp(s,e){for(let o=0;o<e.length;o++)if(ku(s,e[o]))return!0;return!1}function pf(s,e,o){const c=[];for(let d=0;d<s.length;d++){const m=[];for(let g=0;g<s[d].length;g++){const x=Bp(s[d][g],o);la(e,x),m.push(x)}c.push(m)}return c}function Vl(s,e,o){const c=[];for(let d=0;d<s.length;d++){const m=pf(s[d],e,o);c.push(m)}return c}function Up(s,e,o,c){if(s[0]<o[0]||s[0]>o[2]){const d=.5*c;let m=s[0]-o[0]>d?-c:o[0]-s[0]>d?c:0;0===m&&(m=s[0]-o[2]>d?-c:o[2]-s[0]>d?c:0),s[0]+=m}la(e,s)}function jg(s,e,o,c){const d=Math.pow(2,c.z)*Wa,m=[c.x*Wa,c.y*Wa],g=[];if(!s)return g;for(const x of s)for(const w of x){const T=[w.x+m[0],w.y+m[1]];Up(T,e,o,d),g.push(T)}return g}function mf(s,e,o,c){const d=Math.pow(2,c.z)*Wa,m=[c.x*Wa,c.y*Wa],g=[];if(!s)return g;for(const w of s){const T=[];for(const C of w){const A=[C.x+m[0],C.y+m[1]];la(e,A),T.push(A)}g.push(T)}if(e[2]-e[0]<=d/2){(x=e)[0]=x[1]=1/0,x[2]=x[3]=-1/0;for(const w of g)for(const T of w)Up(T,e,o,d)}var x;return g}class go{constructor(e,o){this.type=Zn,this.geojson=e,this.geometries=o}static parse(e,o){if(2!==e.length)return o.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(an(e[1])){const c=e[1];if("FeatureCollection"===c.type)for(let d=0;d<c.features.length;++d){const m=c.features[d].geometry.type;if("Polygon"===m||"MultiPolygon"===m)return new go(c,c.features[d].geometry)}else if("Feature"===c.type){const d=c.geometry.type;if("Polygon"===d||"MultiPolygon"===d)return new go(c,c.geometry)}else if("Polygon"===c.type||"MultiPolygon"===c.type)return new go(c,c)}return o.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryType())return function(o,c){const d=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],g=o.canonicalID();if(!g)return!1;if("Polygon"===c.type){const x=pf(c.coordinates,m,g),w=jg(o.geometry(),d,m,g);if(!Nl(d,m))return!1;for(const T of w)if(!Mc(T,x))return!1}if("MultiPolygon"===c.type){const x=Vl(c.coordinates,m,g),w=jg(o.geometry(),d,m,g);if(!Nl(d,m))return!1;for(const T of w)if(!Vp(T,x))return!1}return!0}(e,this.geometries);if("LineString"===e.geometryType())return function(o,c){const d=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],g=o.canonicalID();if(!g)return!1;if("Polygon"===c.type){const x=pf(c.coordinates,m,g),w=mf(o.geometry(),d,m,g);if(!Nl(d,m))return!1;for(const T of w)if(!ku(T,x))return!1}if("MultiPolygon"===c.type){const x=Vl(c.coordinates,m,g),w=mf(o.geometry(),d,m,g);if(!Nl(d,m))return!1;for(const T of w)if(!jp(T,x))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Gd={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Ls=1/298.257223563,Hp=Ls*(2-Ls),Fu=Math.PI/180;class zu{static fromTile(e,o,c){const d=Math.PI*(1-2*(e+.5)/Math.pow(2,o)),m=Math.atan(.5*(Math.exp(d)-Math.exp(-d)))/Fu;return new zu(m,c)}static get units(){return Gd}constructor(e,o){if(void 0===e)throw new Error("No latitude given.");if(o&&!Gd[o])throw new Error(`Unknown unit ${o}. Use one of: ${Object.keys(Gd).join(", ")}`);const c=6378.137*Fu*(o?Gd[o]:1),d=Math.cos(e*Fu),m=1/(1-Hp*(1-d*d)),g=Math.sqrt(m);this.kx=c*g*d,this.ky=c*g*m*(1-Hp)}distance(e,o){const c=ks(e[0]-o[0])*this.kx,d=(e[1]-o[1])*this.ky;return Math.sqrt(c*c+d*d)}bearing(e,o){const c=ks(o[0]-e[0])*this.kx;return Math.atan2(c,(o[1]-e[1])*this.ky)/Fu}destination(e,o,c){const d=c*Fu;return this.offset(e,Math.sin(d)*o,Math.cos(d)*o)}offset(e,o,c){return[e[0]+o/this.kx,e[1]+c/this.ky]}lineDistance(e){let o=0;for(let c=0;c<e.length-1;c++)o+=this.distance(e[c],e[c+1]);return o}area(e){let o=0;for(let c=0;c<e.length;c++){const d=e[c];for(let m=0,g=d.length,x=g-1;m<g;x=m++)o+=ks(d[m][0]-d[x][0])*(d[m][1]+d[x][1])*(c?-1:1)}return Math.abs(o)/2*this.kx*this.ky}along(e,o){let c=0;if(o<=0)return e[0];for(let d=0;d<e.length-1;d++){const m=e[d],g=e[d+1],x=this.distance(m,g);if(c+=x,c>o)return $d(m,g,(o-(c-x))/x)}return e[e.length-1]}pointToSegmentDistance(e,o,c){let[d,m]=o,g=ks(c[0]-d)*this.kx,x=(c[1]-m)*this.ky;if(0!==g||0!==x){const w=(ks(e[0]-d)*this.kx*g+(e[1]-m)*this.ky*x)/(g*g+x*x);w>1?(d=c[0],m=c[1]):w>0&&(d+=g/this.kx*w,m+=x/this.ky*w)}return g=ks(e[0]-d)*this.kx,x=(e[1]-m)*this.ky,Math.sqrt(g*g+x*x)}pointOnLine(e,o){let c=1/0,d=e[0][0],m=e[0][1],g=0,x=0;for(let w=0;w<e.length-1;w++){let T=e[w][0],C=e[w][1],A=ks(e[w+1][0]-T)*this.kx,M=(e[w+1][1]-C)*this.ky,k=0;0===A&&0===M||(k=(ks(o[0]-T)*this.kx*A+(o[1]-C)*this.ky*M)/(A*A+M*M),k>1?(T=e[w+1][0],C=e[w+1][1]):k>0&&(T+=A/this.kx*k,C+=M/this.ky*k)),A=ks(o[0]-T)*this.kx,M=(o[1]-C)*this.ky;const F=A*A+M*M;F<c&&(c=F,d=T,m=C,g=w,x=k)}return{point:[d,m],index:g,t:Math.max(0,Math.min(1,x))}}lineSlice(e,o,c){let d=this.pointOnLine(c,e),m=this.pointOnLine(c,o);if(d.index>m.index||d.index===m.index&&d.t>m.t){const T=d;d=m,m=T}const g=[d.point],x=d.index+1,w=m.index;!Gp(c[x],g[0])&&x<=w&&g.push(c[x]);for(let T=x+1;T<=w;T++)g.push(c[T]);return Gp(c[w],m.point)||g.push(m.point),g}lineSliceAlong(e,o,c){let d=0;const m=[];for(let g=0;g<c.length-1;g++){const x=c[g],w=c[g+1],T=this.distance(x,w);if(d+=T,d>e&&0===m.length&&m.push($d(x,w,(e-(d-T))/T)),d>=o)return m.push($d(x,w,(o-(d-T))/T)),m;d>e&&m.push(w)}return m}bufferPoint(e,o){const c=o/this.ky,d=o/this.kx;return[e[0]-d,e[1]-c,e[0]+d,e[1]+c]}bufferBBox(e,o){const c=o/this.ky,d=o/this.kx;return[e[0]-d,e[1]-c,e[2]+d,e[3]+c]}insideBBox(e,o){return ks(e[0]-o[0])>=0&&ks(e[0]-o[2])<=0&&e[1]>=o[1]&&e[1]<=o[3]}}function Gp(s,e){return s[0]===e[0]&&s[1]===e[1]}function $d(s,e,o){const c=ks(e[0]-s[0]);return[s[0]+c*o,s[1]+(e[1]-s[1])*o]}function ks(s){for(;s<-180;)s+=360;for(;s>180;)s-=360;return s}class gf{constructor(e=[],o=((c,d)=>c<d?-1:c>d?1:0)){if(this.data=e,this.length=this.data.length,this.compare=o,this.length>0)for(let c=(this.length>>1)-1;c>=0;c--)this._down(c)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(0===this.length)return;const e=this.data[0],o=this.data.pop();return--this.length>0&&(this.data[0]=o,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:o,compare:c}=this,d=o[e];for(;e>0;){const m=e-1>>1,g=o[m];if(c(d,g)>=0)break;o[e]=g,e=m}o[e]=d}_down(e){const{data:o,compare:c}=this,d=this.length>>1,m=o[e];for(;e<d;){let g=1+(e<<1);const x=g+1;if(x<this.length&&c(o[x],o[g])<0&&(g=x),c(o[g],m)>=0)break;o[e]=o[g],e=g}o[e]=m}}var ht=8192;function jl(s,e){return e.dist-s.dist}const _f=100,yf=50;function qd(s){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==s.length)return!1;for(let o=0;o<e.length;o++)if(e[o]!==s[o])return!1;return!0}function Ir(s){return s[1]-s[0]+1}function $s(s,e){const o=s[1]>=s[0]&&s[1]<e;return o||console.warn("Distance Expression: Index is out of range"),o}function Wd(s,e){if(s[0]>s[1])return[null,null];const o=Ir(s);if(e){if(2===o)return[s,null];const c=Math.floor(o/2);return[[s[0],s[0]+c],[s[0]+c,s[1]]]}{if(1===o)return[s,null];const c=Math.floor(o/2)-1;return[[s[0],s[0]+c],[s[0]+c+1,s[1]]]}}function Kr(s,e){const o=[1/0,1/0,-1/0,-1/0];if(!$s(e,s.length))return o;for(let c=e[0];c<=e[1];++c)la(o,s[c]);return o}function _o(s){const e=[1/0,1/0,-1/0,-1/0];for(let o=0;o<s.length;++o)for(let c=0;c<s[o].length;++c)la(e,s[o][c]);return e}function Qn(s,e,o){if(qd(s)||qd(e))return NaN;let c=0,d=0;return s[2]<e[0]&&(c=e[0]-s[2]),s[0]>e[2]&&(c=s[0]-e[2]),s[1]>e[3]&&(d=s[1]-e[3]),s[3]<e[1]&&(d=e[1]-s[3]),o.distance([0,0],[c,d])}function tn(s){return 360*s-180}function Jo(s){return 360/Math.PI*Math.atan(Math.exp((180-360*s)*Math.PI/180))-90}function Pc(s,e){const o=Math.pow(2,e.z),c=(s.y/ht+e.y)/o;return[tn((s.x/ht+e.x)/o),Jo(c)]}function Fs(s,e){const o=[];for(let c=0;c<s.length;++c)o.push(Pc(s[c],e));return o}function vf(s,e,o){const c=o.pointOnLine(e,s).point;return o.distance(s,c)}function $p(s,e,o,c,d){const m=o.slice(c[0],c[1]+1);let g=1/0;for(let x=e[0];x<=e[1];++x)if(0===(g=Math.min(g,vf(s[x],m,d))))return 0;return g}function Ii(s,e,o,c,d){const m=Math.min(d.pointToSegmentDistance(s,o,c),d.pointToSegmentDistance(e,o,c)),g=Math.min(d.pointToSegmentDistance(o,s,e),d.pointToSegmentDistance(c,s,e));return Math.min(m,g)}function sv(s,e,o,c,d){if(!$s(e,s.length)||!$s(c,o.length))return NaN;let m=1/0;for(let g=e[0];g<e[1];++g)for(let x=c[0];x<c[1];++x){if(Bl(s[g],s[g+1],o[x],o[x+1]))return 0;m=Math.min(m,Ii(s[g],s[g+1],o[x],o[x+1],d))}return m}function av(s,e,o,c,d){if(!$s(e,s.length)||!$s(c,o.length))return NaN;let m=1/0;for(let g=e[0];g<=e[1];++g)for(let x=c[0];x<=c[1];++x)if(0===(m=Math.min(m,d.distance(s[g],o[x]))))return m;return m}function Lr(s,e,o){if(Mc(s,e,!0))return 0;let c=1/0;for(const d of e){const m=d.length;if(m<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(d[0]!==d[m-1]&&0===(c=Math.min(c,o.pointToSegmentDistance(s,d[m-1],d[0])))||0===(c=Math.min(c,vf(s,d,o))))return c}return c}function Yt(s,e,o,c){if(!$s(e,s.length))return NaN;for(let m=e[0];m<=e[1];++m)if(Mc(s[m],o,!0))return 0;let d=1/0;for(let m=e[0];m<e[1];++m)for(const g of o)for(let x=0,w=g.length,T=w-1;x<w;T=x++){if(Bl(s[m],s[m+1],g[T],g[x]))return 0;d=Math.min(d,Ii(s[m],s[m+1],g[T],g[x],c))}return d}function Jn(s,e){for(const o of s)for(let c=0;c<=o.length-1;++c)if(Mc(o[c],e,!0))return!0;return!1}function Cr(s,e,o,c=1/0){const d=_o(s),m=_o(e);if(c!==1/0&&Qn(d,m,o)>=c)return c;if(Nl(d,m)){if(Jn(s,e))return 0}else if(Jn(e,s))return 0;let g=c;for(const x of s)for(let w=0,T=x.length,C=T-1;w<T;C=w++)for(const A of e)for(let M=0,k=A.length,F=k-1;M<k;F=M++){if(Bl(x[C],x[w],A[F],A[M]))return 0;g=Math.min(g,Ii(x[C],x[w],A[F],A[M],o))}return g}function _s(s,e,o,c,d,m,g){if(null===m||null===g)return;const x=Qn(Kr(c,m),Kr(d,g),o);x<e&&s.push({dist:x,range1:m,range2:g})}function Zd(s,e,o,c,d=1/0){let m=Math.min(c.distance(s[0],o[0][0]),d);if(0===m)return m;const g=new gf([{dist:0,range1:[0,s.length-1],range2:[0,0]}],jl),x=e?yf:_f,w=_o(o);for(;g.length;){const T=g.pop();if(T.dist>=m)continue;const C=T.range1;if(Ir(C)<=x){if(!$s(C,s.length))return NaN;if(e){const A=Yt(s,C,o,c);if(0===(m=Math.min(m,A)))return m}else for(let A=C[0];A<=C[1];++A){const M=Lr(s[A],o,c);if(0===(m=Math.min(m,M)))return m}}else{const A=Wd(C,e);if(null!==A[0]){const M=Qn(Kr(s,A[0]),w,c);M<m&&g.push({dist:M,range1:A[0],range2:[0,0]})}if(null!==A[1]){const M=Qn(Kr(s,A[1]),w,c);M<m&&g.push({dist:M,range1:A[1],range2:[0,0]})}}}return m}function Io(s,e,o,c,d,m=1/0){let g=Math.min(m,d.distance(s[0],o[0]));if(0===g)return g;const x=new gf([{dist:0,range1:[0,s.length-1],range2:[0,o.length-1]}],jl),w=e?yf:_f,T=c?yf:_f;for(;x.length;){const C=x.pop();if(C.dist>=g)continue;const A=C.range1,M=C.range2;if(Ir(A)<=w&&Ir(M)<=T){if(!$s(A,s.length)||!$s(M,o.length))return NaN;if(e&&c?g=Math.min(g,sv(s,A,o,M,d)):e||c?e&&!c?g=Math.min(g,$p(o,M,s,A,d)):!e&&c&&(g=Math.min(g,$p(s,A,o,M,d))):g=Math.min(g,av(s,A,o,M,d)),0===g)return g}else{const k=Wd(A,e),F=Wd(M,c);_s(x,g,d,s,o,k[0],F[0]),_s(x,g,d,s,o,k[0],F[1]),_s(x,g,d,s,o,k[1],F[0]),_s(x,g,d,s,o,k[1],F[1])}}return g}function Ul(s,e,o,c,d=1/0){let m=d;const g=Kr(s,[0,s.length-1]);for(const x of o)if(!(m!==1/0&&Qn(g,Kr(x,[0,x.length-1]),c)>=m)&&(m=Math.min(m,Io(s,e,x,!0,c,m)),0===m))return m;return m}function Ar(s,e,o,c,d=1/0){let m=d;const g=Kr(s,[0,s.length-1]);for(const x of o){if(m!==1/0&&Qn(g,_o(x),c)>=m)continue;const w=Zd(s,e,x,c,m);if(isNaN(w))return w;if(0===(m=Math.min(m,w)))return m}return m}function Ca(s){return"Point"===s||"MultiPoint"===s||"LineString"===s||"MultiLineString"===s||"Polygon"===s||"MultiPolygon"===s}class qs{constructor(e,o){this.type=Et,this.geojson=e,this.geometries=o}static parse(e,o){if(2!==e.length)return o.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(an(e[1])){const c=e[1];if("FeatureCollection"===c.type){for(let d=0;d<c.features.length;++d)if(Ca(c.features[d].geometry.type))return new qs(c,c.features[d].geometry)}else if("Feature"===c.type){if(Ca(c.geometry.type))return new qs(c,c.geometry)}else if(Ca(c.type))return new qs(c,c)}return o.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const o=e.geometry(),c=e.canonicalID();if(null!=o&&null!=c){if("Point"===e.geometryType())return function(d,m,g){const x=[];for(const T of d)for(const C of T)x.push(Pc(C,m));const w=new zu(x[0][1],"meters");return"Point"===g.type||"MultiPoint"===g.type||"LineString"===g.type?Io(x,!1,"Point"===g.type?[g.coordinates]:g.coordinates,"LineString"===g.type,w):"MultiLineString"===g.type?Ul(x,!1,g.coordinates,w):"Polygon"===g.type||"MultiPolygon"===g.type?Ar(x,!1,"Polygon"===g.type?[g.coordinates]:g.coordinates,w):null}(o,c,this.geometries);if("LineString"===e.geometryType())return function(d,m,g){const x=[];for(const T of d){const C=[];for(const A of T)C.push(Pc(A,m));x.push(C)}const w=new zu(x[0][0][1],"meters");if("Point"===g.type||"MultiPoint"===g.type||"LineString"===g.type)return Ul("Point"===g.type?[g.coordinates]:g.coordinates,"LineString"===g.type,x,w);if("MultiLineString"===g.type){let T=1/0;for(let C=0;C<g.coordinates.length;C++){const A=Ul(g.coordinates[C],!0,x,w,T);if(isNaN(A))return A;if(0===(T=Math.min(T,A)))return T}return T}if("Polygon"===g.type||"MultiPolygon"===g.type){let T=1/0;for(let C=0;C<x.length;C++){const A=Ar(x[C],!0,"Polygon"===g.type?[g.coordinates]:g.coordinates,w,T);if(isNaN(A))return A;if(0===(T=Math.min(T,A)))return T}return T}return null}(o,c,this.geometries);if("Polygon"===e.geometryType())return function(d,m,g){const x=[];for(const T of function(C,A){const M=C.length;if(M<=1)return[C];const k=[];let F,V;for(let j=0;j<M;j++){const W=Hi(C[j]);0!==W&&(C[j].area=Math.abs(W),void 0===V&&(V=W<0),V===W<0?(F&&k.push(F),F=[C[j]]):F.push(C[j]))}return F&&k.push(F),k}(d)){const C=[];for(let A=0;A<T.length;++A)C.push(Fs(T[A],m));x.push(C)}const w=new zu(x[0][0][0][1],"meters");if("Point"===g.type||"MultiPoint"===g.type||"LineString"===g.type)return Ar("Point"===g.type?[g.coordinates]:g.coordinates,"LineString"===g.type,x,w);if("MultiLineString"===g.type){let T=1/0;for(let C=0;C<g.coordinates.length;C++){const A=Ar(g.coordinates[C],!0,x,w,T);if(isNaN(A))return A;if(0===(T=Math.min(T,A)))return T}return T}return"Polygon"===g.type||"MultiPolygon"===g.type?function(T,C,A){let M=1/0;for(const k of T)for(const F of C){const V=Cr(k,F,A,M);if(isNaN(V))return V;if(0===(M=Math.min(M,V)))return M}return M}("Polygon"===g.type?[g.coordinates]:g.coordinates,x,w):null}(o,c,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function On(s){if(s instanceof Xr&&("get"===s.name&&1===s.args.length||"feature-state"===s.name||"has"===s.name&&1===s.args.length||"properties"===s.name||"geometry-type"===s.name||"id"===s.name||/^filter-/.test(s.name))||s instanceof go||s instanceof qs)return!1;if(s instanceof es)return s.featureConstant;let e=!0;return s.eachChild(o=>{e&&!On(o)&&(e=!1)}),e}function Hl(s){if(s instanceof Xr&&"feature-state"===s.name)return!1;let e=!0;return s.eachChild(o=>{e&&!Hl(o)&&(e=!1)}),e}function Xd(s){if(s instanceof es)return new Set([s.key]);let e=new Set;return s.eachChild(o=>{e=new Set([...e,...Xd(o)])}),e}function ca(s,e){if(s instanceof Xr&&e.indexOf(s.name)>=0)return!1;let o=!0;return s.eachChild(c=>{o&&!ca(c,e)&&(o=!1)}),o}function kr(s,e,o){return[s,e,o].filter(Boolean).join("\x1f")}function Rc(s,e){switch(s){case"string":return Os(e);case"number":return+e;case"boolean":return!!e;case"color":return Yn.parse(e);case"formatted":return Wr.fromString(Os(e));case"resolvedImage":return po.build(Os(e))}return e}function Oc(s,e,o,c){return void 0!==c&&(s=c*Math.round(s/c)),void 0!==e&&s<e&&(s=e),void 0!==o&&s>o&&(s=o),s}class es{constructor(e,o,c,d=!1){this.type=e,this.key=o,this.scope=c,this.featureConstant=d}static parse(e,o){let c=o.expectedType;if(null==c&&(c=Kn),e.length<2||e.length>3)return o.error("Invalid number of arguments for 'config' expression.");const d=o.parse(e[1],1);if(!(d instanceof Bt))return o.error("Key name of 'config' expression must be a string literal.");let m,g=!0;const x=Os(d.value);if(e.length>=3){const w=o.parse(e[2],2);if(!(w instanceof Bt))return o.error("Scope of 'config' expression must be a string literal.");m=Os(w.value)}if(o.options){const w=kr(x,m,o._scope),T=o.options.get(w);T&&(g=On(T.value||T.default))}return new es(c,x,m,g)}evaluate(e){const o=kr(this.key,this.scope,e.scope),c=e.getConfig(o);if(!c)return null;const{type:d,value:m,values:g,minValue:x,maxValue:w,stepValue:T}=c,C=c.default.evaluate(e);let A=C;if(m){const M=e.scope;e.scope=(M||"").split("\x1f").slice(1).join("\x1f"),A=m.evaluate(e),e.scope=M}return d&&(A=Rc(d,A)),void 0===A||void 0===x&&void 0===w&&void 0===T||("number"==typeof A?A=Oc(A,x,w,T):Array.isArray(A)&&(A=A.map(M=>"number"==typeof M?Oc(M,x,w,T):M))),void 0!==m&&void 0!==A&&g&&!g.includes(A)&&(A=C,d&&(A=Rc(d,A))),(d&&d!==this.type||void 0!==A&&!Fp(bt(A),this.type))&&(A=Rc(this.type.kind,A)),A}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Gl{constructor(e,o){this.type=o.type,this.name=e,this.boundExpression=o}static parse(e,o){if(2!==e.length||"string"!=typeof e[1])return o.error("'var' expression requires exactly one string literal argument.");const c=e[1];return o.scope.has(c)?new Gl(c,o.scope.get(c)):o.error(`Unknown variable "${c}". Make sure "${c}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Yd{constructor(e,o=[],c,d=new jd,m=[],g,x){this.registry=e,this.path=o,this.key=o.map(w=>"string"==typeof w?`['${w}']`:`[${w}]`).join(""),this.scope=d,this.errors=m,this.expectedType=c,this._scope=g,this.options=x}parse(e,o,c,d,m={}){return o||c?this.concat(o,null,c,d)._parse(e,m):this._parse(e,m)}parseObjectValue(e,o,c,d,m,g={}){return this.concat(o,c,d,m)._parse(e,g)}_parse(e,o){function c(d,m,g){return"assert"===g?new Nt(m,[d]):"coerce"===g?new gs(m,[d]):d}if(null!==e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e||(e=["literal",e]),Array.isArray(e)){if(0===e.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const d="string"==typeof e[0]?this.registry[e[0]]:void 0;if(d){let m=d.parse(e,this);if(!m)return null;if(this.expectedType){const g=this.expectedType,x=m.type;if("string"!==g.kind&&"number"!==g.kind&&"boolean"!==g.kind&&"object"!==g.kind&&"array"!==g.kind||"value"!==x.kind)if("color"!==g.kind&&"formatted"!==g.kind&&"resolvedImage"!==g.kind||"value"!==x.kind&&"string"!==x.kind){if(this.checkSubtype(g,x))return null}else m=c(m,g,o.typeAnnotation||"coerce");else m=c(m,g,o.typeAnnotation||"assert")}if(!(m instanceof Bt)&&"resolvedImage"!==m.type.kind&&Aa(m)){const g=new Hd(this._scope,this.options);try{m=new Bt(m.type,m.evaluate(g))}catch(x){return this.error(x.message),null}}return m}return gs.parse(["to-array",e],this)}return this.error(void 0===e?"'undefined' value invalid. Use null instead.":"object"==typeof e?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,o,c,d){let m="number"==typeof e?this.path.concat(e):this.path;m="string"==typeof o?m.concat(o):m;const g=d?this.scope.concat(d):this.scope;return new Yd(this.registry,m,c||null,g,this.errors,this._scope,this.options)}error(e,...o){const c=`${this.key}${o.map(d=>`[${d}]`).join("")}`;this.errors.push(new Un(c,e))}checkSubtype(e,o){const c=zl(e,o);return c&&this.error(c),c}}function Aa(s){if(s instanceof Gl)return Aa(s.boundExpression);if(s instanceof Xr&&"error"===s.name||s instanceof mo||s instanceof go||s instanceof qs||s instanceof es)return!1;const e=s instanceof gs||s instanceof Nt;let o=!0;return s.eachChild(c=>{o=e?o&&Aa(c):o&&c instanceof Bt}),!!o&&On(s)&&ca(s,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Ws(s,e){const o=s.length-1;let c,d,m=0,g=o,x=0;for(;m<=g;)if(x=Math.floor((m+g)/2),c=s[x],d=s[x+1],c<=e){if(x===o||e<d)return x;m=x+1}else{if(!(c>e))throw new Er("Input is not a number.");g=x-1}return 0}class Za{constructor(e,o,c){this.type=e,this.input=o,this.labels=[],this.outputs=[];for(const[d,m]of c)this.labels.push(d),this.outputs.push(m)}static parse(e,o){if(e.length-1<4)return o.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return o.error("Expected an even number of arguments.");const c=o.parse(e[1],1,Et);if(!c)return null;const d=[];let m=null;o.expectedType&&"value"!==o.expectedType.kind&&(m=o.expectedType);for(let g=1;g<e.length;g+=2){const x=1===g?-1/0:e[g],w=e[g+1],T=g,C=g+1;if("number"!=typeof x)return o.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',T);if(d.length&&d[d.length-1][0]>=x)return o.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',T);const A=o.parse(w,C,m);if(!A)return null;m=m||A.type,d.push([x,A])}return new Za(m,c,d)}evaluate(e){const o=this.labels,c=this.outputs;if(1===o.length)return c[0].evaluate(e);const d=this.input.evaluate(e);if(d<=o[0])return c[0].evaluate(e);const m=o.length;return d>=o[m-1]?c[m-1].evaluate(e):c[Ws(o,d)].evaluate(e)}eachChild(e){e(this.input);for(const o of this.outputs)e(o)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let o=0;o<this.labels.length;o++)o>0&&e.push(this.labels[o]),e.push(this.outputs[o].serialize());return e}}const lv=4/29,$l=6/29,qp=3*$l*$l,Zs=$l*$l*$l,xf=Math.PI/180,Lc=180/Math.PI;function kc(s){return s>Zs?Math.pow(s,1/3):s/qp+lv}function io(s){return s>$l?s*s*s:qp*(s-lv)}function Ug(s){return 255*(s<=.0031308?12.92*s:1.055*Math.pow(s,1/2.4)-.055)}function Co(s){return(s/=255)<=.04045?s/12.92:Math.pow((s+.055)/1.055,2.4)}function Ao(s){const e=Co(s.r),o=Co(s.g),c=Co(s.b),d=kc((.4124564*e+.3575761*o+.1804375*c)/.95047),m=kc((.2126729*e+.7151522*o+.072175*c)/1);return{l:116*m-16,a:500*(d-m),b:200*(m-kc((.0193339*e+.119192*o+.9503041*c)/1.08883)),alpha:s.a}}function Xa(s){let e=(s.l+16)/116,o=isNaN(s.a)?e:e+s.a/500,c=isNaN(s.b)?e:e-s.b/200;return e=1*io(e),o=.95047*io(o),c=1.08883*io(c),new Yn(Ug(3.2404542*o-1.5371385*e-.4985314*c),Ug(-.969266*o+1.8760108*e+.041556*c),Ug(.0556434*o-.2040259*e+1.0572252*c),s.alpha)}function ql(s,e,o){const c=e-s;return s+o*(c>180||c<-180?c-360*Math.round(c/360):c)}const Ya={forward:Ao,reverse:Xa,interpolate:function(s,e,o){return{l:Ft(s.l,e.l,o),a:Ft(s.a,e.a,o),b:Ft(s.b,e.b,o),alpha:Ft(s.alpha,e.alpha,o)}}},ts={forward:function(s){const{l:e,a:o,b:c}=Ao(s),d=Math.atan2(c,o)*Lc;return{h:d<0?d+360:d,c:Math.sqrt(o*o+c*c),l:e,alpha:s.a}},reverse:function(s){const e=s.h*xf,o=s.c;return Xa({l:s.l,a:Math.cos(e)*o,b:Math.sin(e)*o,alpha:s.alpha})},interpolate:function(s,e,o){return{h:ql(s.h,e.h,o),c:Ft(s.c,e.c,o),l:Ft(s.l,e.l,o),alpha:Ft(s.alpha,e.alpha,o)}}};var Bu=Object.freeze({__proto__:null,hcl:ts,lab:Ya});class ns{constructor(e,o,c,d,m){this.type=e,this.operator=o,this.interpolation=c,this.input=d,this.labels=[],this.outputs=[];for(const[g,x]of m)this.labels.push(g),this.outputs.push(x)}static interpolationFactor(e,o,c,d){let m=0;if("exponential"===e.name)m=Wp(o,e.base,c,d);else if("linear"===e.name)m=Wp(o,1,c,d);else if("cubic-bezier"===e.name){const g=e.controlPoints;m=new Tu(g[0],g[1],g[2],g[3]).solve(Wp(o,1,c,d))}return m}static parse(e,o){let[c,d,m,...g]=e;if(!Array.isArray(d)||0===d.length)return o.error("Expected an interpolation type expression.",1);if("linear"===d[0])d={name:"linear"};else if("exponential"===d[0]){const T=d[1];if("number"!=typeof T)return o.error("Exponential interpolation requires a numeric base.",1,1);d={name:"exponential",base:T}}else{if("cubic-bezier"!==d[0])return o.error(`Unknown interpolation type ${String(d[0])}`,1,0);{const T=d.slice(1);if(4!==T.length||T.some(C=>"number"!=typeof C||C<0||C>1))return o.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);d={name:"cubic-bezier",controlPoints:T}}}if(e.length-1<4)return o.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return o.error("Expected an even number of arguments.");if(m=o.parse(m,2,Et),!m)return null;const x=[];let w=null;"interpolate-hcl"===c||"interpolate-lab"===c?w=mi:o.expectedType&&"value"!==o.expectedType.kind&&(w=o.expectedType);for(let T=0;T<g.length;T+=2){const C=g[T],A=g[T+1],M=T+3,k=T+4;if("number"!=typeof C)return o.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',M);if(x.length&&x[x.length-1][0]>=C)return o.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',M);const F=o.parse(A,k,w);if(!F)return null;w=w||F.type,x.push([C,F])}return"number"===w.kind||"color"===w.kind||"array"===w.kind&&"number"===w.itemType.kind&&"number"==typeof w.N?new ns(w,c,d,m,x):o.error(`Type ${yr(w)} is not interpolatable.`)}evaluate(e){const o=this.labels,c=this.outputs;if(1===o.length)return c[0].evaluate(e);const d=this.input.evaluate(e);if(d<=o[0])return c[0].evaluate(e);const m=o.length;if(d>=o[m-1])return c[m-1].evaluate(e);const g=Ws(o,d),x=ns.interpolationFactor(this.interpolation,d,o[g],o[g+1]),w=c[g].evaluate(e),T=c[g+1].evaluate(e);return"interpolate"===this.operator?Lu[this.type.kind.toLowerCase()](w,T,x):"interpolate-hcl"===this.operator?ts.reverse(ts.interpolate(ts.forward(w),ts.forward(T),x)):Ya.reverse(Ya.interpolate(Ya.forward(w),Ya.forward(T),x))}eachChild(e){e(this.input);for(const o of this.outputs)e(o)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const o=[this.operator,e,this.input.serialize()];for(let c=0;c<this.labels.length;c++)o.push(this.labels[c],this.outputs[c].serialize());return o}}function Wp(s,e,o,c){const d=c-o,m=s-o;return 0===d?0:1===e?m/d:(Math.pow(e,m)-1)/(Math.pow(e,d)-1)}class Zp{constructor(e,o){this.type=e,this.args=o}static parse(e,o){if(e.length<2)return o.error("Expectected at least one argument.");let c=null;const d=o.expectedType;d&&"value"!==d.kind&&(c=d);const m=[];for(const x of e.slice(1)){const w=o.parse(x,1+m.length,c,void 0,{typeAnnotation:"omit"});if(!w)return null;c=c||w.type,m.push(w)}const g=d&&m.some(x=>zl(d,x.type));return new Zp(g?Kn:c,m)}evaluate(e){let o,c=null,d=0;for(const m of this.args){if(d++,c=m.evaluate(e),c&&c instanceof po&&!c.available&&(o||(o=c),c=null,d===this.args.length))return o;if(null!==c)break}return c}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(o=>{e.push(o.serialize())}),e}}class Kd{constructor(e,o){this.type=o.type,this.bindings=[].concat(e),this.result=o}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const o of this.bindings)e(o[1]);e(this.result)}static parse(e,o){if(e.length<4)return o.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const c=[];for(let m=1;m<e.length-1;m+=2){const g=e[m];if("string"!=typeof g)return o.error(`Expected string, but found ${typeof g} instead.`,m);if(/[^a-zA-Z0-9_]/.test(g))return o.error("Variable names must contain only alphanumeric characters or '_'.",m);const x=o.parse(e[m+1],m+1);if(!x)return null;c.push([g,x])}const d=o.parse(e[e.length-1],e.length-1,o.expectedType,c);return d?new Kd(c,d):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[o,c]of this.bindings)e.push(o,c.serialize());return e.push(this.result.serialize()),e}}class bf{constructor(e,o,c){this.type=e,this.index=o,this.input=c}static parse(e,o){if(3!==e.length)return o.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const c=o.parse(e[1],1,Et),d=o.parse(e[2],2,fo(o.expectedType||Kn));return c&&d?new bf(d.type.itemType,c,d):null}evaluate(e){const o=this.index.evaluate(e),c=this.input.evaluate(e);if(o<0)throw new Er(`Array index out of bounds: ${o} < 0.`);if(o>=c.length)throw new Er(`Array index out of bounds: ${o} > ${c.length-1}.`);if(o!==Math.floor(o))throw new Er(`Array index must be an integer, but found ${o} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return c[o]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Hg{constructor(e,o,c){this.type=e,this.index=o,this.input=c}static parse(e,o){if(3!==e.length)return o.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const c=o.parse(e[1],1,Et),d=o.parse(e[2],2,fo(o.expectedType||Kn));return c&&d?new Hg(d.type.itemType,c,d):null}evaluate(e){const o=this.index.evaluate(e),c=this.input.evaluate(e);if(o<0)throw new Er(`Array index out of bounds: ${o} < 0.`);if(o>c.length-1)throw new Er(`Array index out of bounds: ${o} > ${c.length-1}.`);if(o===Math.floor(o))return c[o];const d=Math.floor(o),m=Math.ceil(o),g=c[d],x=c[m];if("number"!=typeof g||"number"!=typeof x)throw new Er(`Cannot interpolate between non-number values at index ${o}.`);const w=o-d;return g*(1-w)+x*w}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Gg{constructor(e,o){this.type=Zn,this.needle=e,this.haystack=o}static parse(e,o){if(3!==e.length)return o.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const c=o.parse(e[1],1,Kn),d=o.parse(e[2],2,Kn);return c&&d?Ic(c.type,[Zn,Hn,Et,Tc,Kn])?new Gg(c,d):o.error(`Expected first argument to be of type boolean, string, number or null, but found ${yr(c.type)} instead`):null}evaluate(e){const o=this.needle.evaluate(e),c=this.haystack.evaluate(e);if(null==c)return!1;if(!df(o,["boolean","string","number","null"]))throw new Er(`Expected first argument to be of type boolean, string, number or null, but found ${yr(bt(o))} instead.`);if(!df(c,["string","array"]))throw new Er(`Expected second argument to be of type array or string, but found ${yr(bt(c))} instead.`);return c.indexOf(o)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Xp{constructor(e,o,c){this.type=Et,this.needle=e,this.haystack=o,this.fromIndex=c}static parse(e,o){if(e.length<=2||e.length>=5)return o.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const c=o.parse(e[1],1,Kn),d=o.parse(e[2],2,Kn);if(!c||!d)return null;if(!Ic(c.type,[Zn,Hn,Et,Tc,Kn]))return o.error(`Expected first argument to be of type boolean, string, number or null, but found ${yr(c.type)} instead`);if(4===e.length){const m=o.parse(e[3],3,Et);return m?new Xp(c,d,m):null}return new Xp(c,d)}evaluate(e){const o=this.needle.evaluate(e),c=this.haystack.evaluate(e);if(!df(o,["boolean","string","number","null"]))throw new Er(`Expected first argument to be of type boolean, string, number or null, but found ${yr(bt(o))} instead.`);if(!df(c,["string","array"]))throw new Er(`Expected second argument to be of type array or string, but found ${yr(bt(c))} instead.`);if(this.fromIndex){const d=this.fromIndex.evaluate(e);return c.indexOf(o,d)}return c.indexOf(o)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Yp{constructor(e,o,c,d,m,g){this.inputType=e,this.type=o,this.input=c,this.cases=d,this.outputs=m,this.otherwise=g}static parse(e,o){if(e.length<5)return o.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return o.error("Expected an even number of arguments.");let c,d;o.expectedType&&"value"!==o.expectedType.kind&&(d=o.expectedType);const m={},g=[];for(let T=2;T<e.length-1;T+=2){let C=e[T];const A=e[T+1];Array.isArray(C)||(C=[C]);const M=o.concat(T);if(0===C.length)return M.error("Expected at least one branch label.");for(const F of C){if("number"!=typeof F&&"string"!=typeof F)return M.error("Branch labels must be numbers or strings.");if("number"==typeof F&&Math.abs(F)>Number.MAX_SAFE_INTEGER)return M.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof F&&Math.floor(F)!==F)return M.error("Numeric branch labels must be integer values.");if(c){if(M.checkSubtype(c,bt(F)))return null}else c=bt(F);if(void 0!==m[String(F)])return M.error("Branch labels must be unique.");m[String(F)]=g.length}const k=o.parse(A,T,d);if(!k)return null;d=d||k.type,g.push(k)}const x=o.parse(e[1],1,Kn);if(!x)return null;const w=o.parse(e[e.length-1],e.length-1,d);return w?"value"!==x.type.kind&&o.concat(1).checkSubtype(c,x.type)?null:new Yp(c,d,x,m,g,w):null}evaluate(e){const o=this.input.evaluate(e);return(Fp(bt(o),this.inputType)&&this.outputs[this.cases[o]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],o=Object.keys(this.cases).sort(),c=[],d={};for(const g of o){const x=d[this.cases[g]];void 0===x?(d[this.cases[g]]=c.length,c.push([this.cases[g],[g]])):c[x][1].push(g)}const m=g=>"number"===this.inputType.kind?Number(g):g;for(const[g,x]of c)e.push(1===x.length?m(x[0]):x.map(m)),e.push(this.outputs[g].serialize());return e.push(this.otherwise.serialize()),e}}class Kp{constructor(e,o,c){this.type=e,this.branches=o,this.otherwise=c}static parse(e,o){if(e.length<4)return o.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return o.error("Expected an odd number of arguments.");let c;o.expectedType&&"value"!==o.expectedType.kind&&(c=o.expectedType);const d=[];for(let g=1;g<e.length-1;g+=2){const x=o.parse(e[g],g,Zn);if(!x)return null;const w=o.parse(e[g+1],g+1,c);if(!w)return null;d.push([x,w]),c=c||w.type}const m=o.parse(e[e.length-1],e.length-1,c);return m?new Kp(c,d,m):null}evaluate(e){for(const[o,c]of this.branches)if(o.evaluate(e))return c.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[o,c]of this.branches)e(o),e(c);e(this.otherwise)}outputDefined(){return this.branches.every(([e,o])=>o.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(o=>{e.push(o.serialize())}),e}}class Vu{constructor(e,o,c,d){this.type=e,this.input=o,this.beginIndex=c,this.endIndex=d}static parse(e,o){if(e.length<=2||e.length>=5)return o.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const c=o.parse(e[1],1,Kn),d=o.parse(e[2],2,Et);if(!c||!d)return null;if(!Ic(c.type,[fo(Kn),Hn,Kn]))return o.error(`Expected first argument to be of type array or string, but found ${yr(c.type)} instead`);if(4===e.length){const m=o.parse(e[3],3,Et);return m?new Vu(c.type,c,d,m):null}return new Vu(c.type,c,d)}evaluate(e){const o=this.input.evaluate(e),c=this.beginIndex.evaluate(e);if(!df(o,["string","array"]))throw new Er(`Expected first argument to be of type array or string, but found ${yr(bt(o))} instead.`);if(this.endIndex){const d=this.endIndex.evaluate(e);return o.slice(c,d)}return o.slice(c)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class $g{constructor(e,o){this.type=fo(Hn),this.str=e,this.delimiter=o}static parse(e,o){if(3!==e.length)return o.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const c=o.parse(e[1],1,Hn),d=o.parse(e[2],2,Hn);return c&&d?new $g(c,d):void 0}evaluate(e){const o=this.str.evaluate(e),c=this.delimiter.evaluate(e);return o.split(c)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function qg(s,e){return"=="===s||"!="===s?"boolean"===e.kind||"string"===e.kind||"number"===e.kind||"null"===e.kind||"value"===e.kind:"string"===e.kind||"number"===e.kind||"value"===e.kind}function cv(s,e,o,c){return 0===c.compare(e,o)}function Qd(s,e,o){const c="=="!==s&&"!="!==s;return class c2{constructor(m,g,x){this.type=Zn,this.lhs=m,this.rhs=g,this.collator=x,this.hasUntypedArgument="value"===m.type.kind||"value"===g.type.kind}static parse(m,g){if(3!==m.length&&4!==m.length)return g.error("Expected two or three arguments.");const x=m[0];let w=g.parse(m[1],1,Kn);if(!w)return null;if(!qg(x,w.type))return g.concat(1).error(`"${x}" comparisons are not supported for type '${yr(w.type)}'.`);let T=g.parse(m[2],2,Kn);if(!T)return null;if(!qg(x,T.type))return g.concat(2).error(`"${x}" comparisons are not supported for type '${yr(T.type)}'.`);if(w.type.kind!==T.type.kind&&"value"!==w.type.kind&&"value"!==T.type.kind)return g.error(`Cannot compare types '${yr(w.type)}' and '${yr(T.type)}'.`);c&&("value"===w.type.kind&&"value"!==T.type.kind?w=new Nt(T.type,[w]):"value"!==w.type.kind&&"value"===T.type.kind&&(T=new Nt(w.type,[T])));let C=null;if(4===m.length){if("string"!==w.type.kind&&"string"!==T.type.kind&&"value"!==w.type.kind&&"value"!==T.type.kind)return g.error("Cannot use collator to compare non-string types.");if(C=g.parse(m[3],3,Jt),!C)return null}return new c2(w,T,C)}evaluate(m){const g=this.lhs.evaluate(m),x=this.rhs.evaluate(m);if(c&&this.hasUntypedArgument){const w=bt(g),T=bt(x);if(w.kind!==T.kind||"string"!==w.kind&&"number"!==w.kind)throw new Er(`Expected arguments for "${s}" to be (string, string) or (number, number), but found (${w.kind}, ${T.kind}) instead.`)}if(this.collator&&!c&&this.hasUntypedArgument){const w=bt(g),T=bt(x);if("string"!==w.kind||"string"!==T.kind)return e(m,g,x)}return this.collator?o(m,g,x,this.collator.evaluate(m)):e(m,g,x)}eachChild(m){m(this.lhs),m(this.rhs),this.collator&&m(this.collator)}outputDefined(){return!0}serialize(){const m=[s];return this.eachChild(g=>{m.push(g.serialize())}),m}}}const uv=Qd("==",function(s,e,o){return e===o},cv),dv=Qd("!=",function(s,e,o){return e!==o},function(s,e,o,c){return!cv(0,e,o,c)}),Wg=Qd("<",function(s,e,o){return e<o},function(s,e,o,c){return c.compare(e,o)<0}),Zg=Qd(">",function(s,e,o){return e>o},function(s,e,o,c){return c.compare(e,o)>0}),Lx=Qd("<=",function(s,e,o){return e<=o},function(s,e,o,c){return c.compare(e,o)<=0}),Qp=Qd(">=",function(s,e,o){return e>=o},function(s,e,o,c){return c.compare(e,o)>=0});class Xg{constructor(e,o,c,d,m,g){this.type=Hn,this.number=e,this.locale=o,this.currency=c,this.unit=d,this.minFractionDigits=m,this.maxFractionDigits=g}static parse(e,o){if(3!==e.length)return o.error("Expected two arguments.");const c=o.parse(e[1],1,Et);if(!c)return null;const d=e[2];if("object"!=typeof d||Array.isArray(d))return o.error("NumberFormat options argument must be an object.");let m=null;if(d.locale&&(m=o.parseObjectValue(d.locale,2,"locale",Hn),!m))return null;let g=null;if(d.currency&&(g=o.parseObjectValue(d.currency,2,"currency",Hn),!g))return null;let x=null;if(d.unit&&(x=o.parseObjectValue(d.unit,2,"unit",Hn),!x))return null;let w=null;if(d["min-fraction-digits"]&&(w=o.parseObjectValue(d["min-fraction-digits"],2,"min-fraction-digits",Et),!w))return null;let T=null;return d["max-fraction-digits"]&&(T=o.parseObjectValue(d["max-fraction-digits"],2,"max-fraction-digits",Et),!T)?null:new Xg(c,m,g,x,w,T)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Ka{constructor(e){this.type=Et,this.input=e}static parse(e,o){if(2!==e.length)return o.error(`Expected 1 argument, but found ${e.length-1} instead.`);const c=o.parse(e[1],1);return c?"array"!==c.type.kind&&"string"!==c.type.kind&&"value"!==c.type.kind?o.error(`Expected argument of type string or array, but found ${yr(c.type)} instead.`):new Ka(c):null}evaluate(e){const o=this.input.evaluate(e);if("string"==typeof o||Array.isArray(o))return o.length;throw new Er(`Expected value to be of type string or array, but found ${yr(bt(o))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(o=>{e.push(o.serialize())}),e}}function Qa(s){return function(){s=1831565813+(s|=0)|0;let e=Math.imul(s^s>>>15,1|s);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Jd={"==":uv,"!=":dv,">":Zg,"<":Wg,">=":Qp,"<=":Lx,array:Nt,at:bf,"at-interpolated":Hg,boolean:Nt,case:Kp,coalesce:Zp,collator:mo,format:gt,image:Ac,in:Gg,"index-of":Xp,interpolate:ns,"interpolate-hcl":ns,"interpolate-lab":ns,length:Ka,let:Kd,literal:Bt,match:Yp,number:Nt,"number-format":Xg,object:Nt,slice:Vu,step:Za,string:Nt,"to-boolean":gs,"to-color":gs,"to-number":gs,"to-string":gs,var:Gl,within:go,distance:qs,config:es,split:$g};function Yg(s,[e,o,c,d]){e=e.evaluate(s),o=o.evaluate(s),c=c.evaluate(s);const m=d?d.evaluate(s):1,g=Cc(e,o,c,m);if(g)throw new Er(g);return new Yn(e/255,o/255,c/255,m)}function yo(s,[e,o,c,d]){e=e.evaluate(s),o=o.evaluate(s),c=c.evaluate(s);const m=d?d.evaluate(s):1,g=(C=o,A=c,M=m,"number"==typeof(T=e)&&T>=0&&T<=360?"number"==typeof C&&C>=0&&C<=100&&"number"==typeof A&&A>=0&&A<=100?void 0===M||"number"==typeof M&&M>=0&&M<=1?null:`Invalid hsla value [${[T,C,A,M].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof M?[T,C,A,M]:[T,C,A]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof M?[T,C,A,M]:[T,C,A]).join(", ")}]: 'h' must be between 0 and 360.`);var T,C,A,M;if(g)throw new Er(g);const x=`hsla(${e}, ${o}%, ${c}%, ${m})`,w=Yn.parse(x);if(!w)throw new Er(`Failed to parse HSLA color: ${x}`);return w}function eh(s,e){return s in e}function is(s,e){const o=e[s];return void 0===o?null:o}function Ja(s){return{type:s}}function wf(s){return{result:"success",value:s}}function el(s){return{result:"error",value:s}}function tl(s,e){return!!s&&!!s.parameters&&s.parameters.indexOf(e)>-1}function ju(s){return"data-driven"===s["property-type"]}function Jp(s){return tl(s.expression,"measure-light")}function Ef(s){return tl(s.expression,"zoom")}function Uu(s){return!!s.expression&&s.expression.interpolated}function th(s){return"object"==typeof s&&null!==s&&!Array.isArray(s)}function em(s){return s}function Tf(s,e){const o="color"===e.type,c=s.stops&&"object"==typeof s.stops[0][0],d=c||!(c||void 0!==s.property),m=s.type||(Uu(e)?"exponential":"interval");if(o&&((s=Ec({},s)).stops&&(s.stops=s.stops.map(T=>[T[0],Yn.parse(T[1])])),s.default=Yn.parse(s.default?s.default:e.default)),s.colorSpace&&"rgb"!==s.colorSpace&&!Bu[s.colorSpace])throw new Error(`Unknown color space: ${s.colorSpace}`);let g,x,w;if("exponential"===m)g=tm;else if("interval"===m)g=zc;else if("categorical"===m){g=Fc,x=Object.create(null);for(const T of s.stops)x[T[0]]=T[1];w=typeof s.stops[0][0]}else{if("identity"!==m)throw new Error(`Unknown function type "${m}"`);g=hv}if(c){const T={},C=[];for(let k=0;k<s.stops.length;k++){const F=s.stops[k],V=F[0].zoom;void 0===T[V]&&(T[V]={zoom:V,type:s.type,property:s.property,default:s.default,stops:[]},C.push(V)),T[V].stops.push([F[0].value,F[1]])}const A=[];for(const k of C)A.push([T[k].zoom,Tf(T[k],e)]);const M={name:"linear"};return{kind:"composite",interpolationType:M,interpolationFactor:ns.interpolationFactor.bind(void 0,M),zoomStops:A.map(k=>k[0]),evaluate:({zoom:k},F)=>tm({stops:A,base:s.base},e,k).evaluate(k,F)}}if(d){const T="exponential"===m?{name:"exponential",base:void 0!==s.base?s.base:1}:null;return{kind:"camera",interpolationType:T,interpolationFactor:ns.interpolationFactor.bind(void 0,T),zoomStops:s.stops.map(C=>C[0]),evaluate:({zoom:C})=>g(s,e,C,x,w)}}return{kind:"source",evaluate(T,C){const A=C&&C.properties?C.properties[s.property]:void 0;return void 0===A?Ma(s.default,e.default):g(s,e,A,x,w)}}}function Ma(s,e,o){return void 0!==s?s:void 0!==e?e:void 0!==o?o:void 0}function Fc(s,e,o,c,d){return Ma(typeof o===d?c[o]:void 0,s.default,e.default)}function zc(s,e,o){if("number"!==di(o))return Ma(s.default,e.default);const c=s.stops.length;if(1===c||o<=s.stops[0][0])return s.stops[0][1];if(o>=s.stops[c-1][0])return s.stops[c-1][1];const d=Ws(s.stops.map(m=>m[0]),o);return s.stops[d][1]}function tm(s,e,o){const c=void 0!==s.base?s.base:1;if("number"!==di(o))return Ma(s.default,e.default);const d=s.stops.length;if(1===d||o<=s.stops[0][0])return s.stops[0][1];if(o>=s.stops[d-1][0])return s.stops[d-1][1];const m=Ws(s.stops.map(C=>C[0]),o),g=function(C,A,M,k){const F=k-M,V=C-M;return 0===F?0:1===A?V/F:(Math.pow(A,V)-1)/(Math.pow(A,F)-1)}(o,c,s.stops[m][0],s.stops[m+1][0]),x=s.stops[m][1],w=s.stops[m+1][1];let T=Lu[e.type]||em;if(s.colorSpace&&"rgb"!==s.colorSpace){const C=Bu[s.colorSpace];T=(A,M)=>C.reverse(C.interpolate(C.forward(A),C.forward(M),g))}return"function"==typeof x.evaluate?{evaluate(...C){const A=x.evaluate.apply(void 0,C),M=w.evaluate.apply(void 0,C);if(void 0!==A&&void 0!==M)return T(A,M,g)}}:T(x,w,g)}function hv(s,e,o){return"color"===e.type?o=Yn.parse(o):"formatted"===e.type?o=Wr.fromString(o.toString()):"resolvedImage"===e.type?o=po.build(o.toString()):di(o)===e.type||"enum"===e.type&&e.values[o]||(o=void 0),Ma(o,s.default,e.default)}Xr.register(Jd,{error:[{kind:"error"},[Hn],(s,[e])=>{throw new Er(e.evaluate(s))}],typeof:[Hn,[Kn],(s,[e])=>yr(bt(e.evaluate(s)))],"to-rgba":[fo(Et,4),[mi],(s,[e])=>e.evaluate(s).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[fo(Et,4),[mi],(s,[e])=>e.evaluate(s).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[mi,[Et,Et,Et],Yg],rgba:[mi,[Et,Et,Et,Et],Yg],hsl:[mi,[Et,Et,Et],yo],hsla:[mi,[Et,Et,Et,Et],yo],has:{type:Zn,overloads:[[[Hn],(s,[e])=>eh(e.evaluate(s),s.properties())],[[Hn,Fl],(s,[e,o])=>eh(e.evaluate(s),o.evaluate(s))]]},get:{type:Kn,overloads:[[[Hn],(s,[e])=>is(e.evaluate(s),s.properties())],[[Hn,Fl],(s,[e,o])=>is(e.evaluate(s),o.evaluate(s))]]},"feature-state":[Kn,[Hn],(s,[e])=>is(e.evaluate(s),s.featureState||{})],properties:[Fl,[],s=>s.properties()],"geometry-type":[Hn,[],s=>s.geometryType()],worldview:[Hn,[],s=>s.globals.worldview||""],id:[Kn,[],s=>s.id()],zoom:[Et,[],s=>s.globals.zoom],pitch:[Et,[],s=>s.globals.pitch||0],"distance-from-center":[Et,[],s=>s.distanceFromCenter()],"measure-light":[Et,[Hn],(s,[e])=>s.measureLight(e.evaluate(s))],"heatmap-density":[Et,[],s=>s.globals.heatmapDensity||0],"line-progress":[Et,[],s=>s.globals.lineProgress||0],"raster-value":[Et,[],s=>s.globals.rasterValue||0],"raster-particle-speed":[Et,[],s=>s.globals.rasterParticleSpeed||0],"sky-radial-progress":[Et,[],s=>s.globals.skyRadialProgress||0],accumulated:[Kn,[],s=>void 0===s.globals.accumulated?null:s.globals.accumulated],"+":[Et,Ja(Et),(s,e)=>{let o=0;for(const c of e)o+=c.evaluate(s);return o}],"*":[Et,Ja(Et),(s,e)=>{let o=1;for(const c of e)o*=c.evaluate(s);return o}],"-":{type:Et,overloads:[[[Et,Et],(s,[e,o])=>e.evaluate(s)-o.evaluate(s)],[[Et],(s,[e])=>-e.evaluate(s)]]},"/":[Et,[Et,Et],(s,[e,o])=>e.evaluate(s)/o.evaluate(s)],"%":[Et,[Et,Et],(s,[e,o])=>e.evaluate(s)%o.evaluate(s)],ln2:[Et,[],()=>Math.LN2],pi:[Et,[],()=>Math.PI],e:[Et,[],()=>Math.E],"^":[Et,[Et,Et],(s,[e,o])=>Math.pow(e.evaluate(s),o.evaluate(s))],sqrt:[Et,[Et],(s,[e])=>Math.sqrt(e.evaluate(s))],log10:[Et,[Et],(s,[e])=>Math.log(e.evaluate(s))/Math.LN10],ln:[Et,[Et],(s,[e])=>Math.log(e.evaluate(s))],log2:[Et,[Et],(s,[e])=>Math.log(e.evaluate(s))/Math.LN2],sin:[Et,[Et],(s,[e])=>Math.sin(e.evaluate(s))],cos:[Et,[Et],(s,[e])=>Math.cos(e.evaluate(s))],tan:[Et,[Et],(s,[e])=>Math.tan(e.evaluate(s))],asin:[Et,[Et],(s,[e])=>Math.asin(e.evaluate(s))],acos:[Et,[Et],(s,[e])=>Math.acos(e.evaluate(s))],atan:[Et,[Et],(s,[e])=>Math.atan(e.evaluate(s))],min:[Et,Ja(Et),(s,e)=>Math.min(...e.map(o=>o.evaluate(s)))],max:[Et,Ja(Et),(s,e)=>Math.max(...e.map(o=>o.evaluate(s)))],abs:[Et,[Et],(s,[e])=>Math.abs(e.evaluate(s))],round:[Et,[Et],(s,[e])=>{const o=e.evaluate(s);return o<0?-Math.round(-o):Math.round(o)}],floor:[Et,[Et],(s,[e])=>Math.floor(e.evaluate(s))],ceil:[Et,[Et],(s,[e])=>Math.ceil(e.evaluate(s))],"filter-==":[Zn,[Hn,Kn],(s,[e,o])=>s.properties()[e.value]===o.value],"filter-id-==":[Zn,[Kn],(s,[e])=>s.id()===e.value],"filter-type-==":[Zn,[Hn],(s,[e])=>s.geometryType()===e.value],"filter-<":[Zn,[Hn,Kn],(s,[e,o])=>{const c=s.properties()[e.value],d=o.value;return typeof c==typeof d&&c<d}],"filter-id-<":[Zn,[Kn],(s,[e])=>{const o=s.id(),c=e.value;return typeof o==typeof c&&o<c}],"filter->":[Zn,[Hn,Kn],(s,[e,o])=>{const c=s.properties()[e.value],d=o.value;return typeof c==typeof d&&c>d}],"filter-id->":[Zn,[Kn],(s,[e])=>{const o=s.id(),c=e.value;return typeof o==typeof c&&o>c}],"filter-<=":[Zn,[Hn,Kn],(s,[e,o])=>{const c=s.properties()[e.value],d=o.value;return typeof c==typeof d&&c<=d}],"filter-id-<=":[Zn,[Kn],(s,[e])=>{const o=s.id(),c=e.value;return typeof o==typeof c&&o<=c}],"filter->=":[Zn,[Hn,Kn],(s,[e,o])=>{const c=s.properties()[e.value],d=o.value;return typeof c==typeof d&&c>=d}],"filter-id->=":[Zn,[Kn],(s,[e])=>{const o=s.id(),c=e.value;return typeof o==typeof c&&o>=c}],"filter-has":[Zn,[Kn],(s,[e])=>e.value in s.properties()],"filter-has-id":[Zn,[],s=>null!==s.id()&&void 0!==s.id()],"filter-type-in":[Zn,[fo(Hn)],(s,[e])=>e.value.indexOf(s.geometryType())>=0],"filter-id-in":[Zn,[fo(Kn)],(s,[e])=>e.value.indexOf(s.id())>=0],"filter-in-small":[Zn,[Hn,fo(Kn)],(s,[e,o])=>o.value.indexOf(s.properties()[e.value])>=0],"filter-in-large":[Zn,[Hn,fo(Kn)],(s,[e,o])=>function(c,d,m,g){for(;m<=g;){const x=m+g>>1;if(d[x]===c)return!0;d[x]>c?g=x-1:m=x+1}return!1}(s.properties()[e.value],o.value,0,o.value.length-1)],all:{type:Zn,overloads:[[[Zn,Zn],(s,[e,o])=>e.evaluate(s)&&o.evaluate(s)],[Ja(Zn),(s,e)=>{for(const o of e)if(!o.evaluate(s))return!1;return!0}]]},any:{type:Zn,overloads:[[[Zn,Zn],(s,[e,o])=>e.evaluate(s)||o.evaluate(s)],[Ja(Zn),(s,e)=>{for(const o of e)if(o.evaluate(s))return!0;return!1}]]},"!":[Zn,[Zn],(s,[e])=>!e.evaluate(s)],"is-supported-script":[Zn,[Hn],(s,[e])=>{const o=s.globals&&s.globals.isSupportedScript;return!o||o(e.evaluate(s))}],upcase:[Hn,[Hn],(s,[e])=>e.evaluate(s).toUpperCase()],downcase:[Hn,[Hn],(s,[e])=>e.evaluate(s).toLowerCase()],concat:[Hn,Ja(Kn),(s,e)=>e.map(o=>Os(o.evaluate(s))).join("")],"resolved-locale":[Hn,[Jt],(s,[e])=>e.evaluate(s).resolvedLocale()],random:[Et,[Et,Et,Kn],(s,e)=>{const[o,c,d]=e.map(g=>g.evaluate(s));if(o>c||o===c)return o;let m;if("string"==typeof d)m=function(g){let x=0;if(0===g.length)return x;for(let w=0;w<g.length;w++)x=(x<<5)-x+g.charCodeAt(w),x|=0;return x}(d);else{if("number"!=typeof d)throw new Er(`Invalid seed input: ${d}`);m=d}return o+Qa(m)()*(c-o)}]});class Kg{constructor(e,o,c,d){var m;this.expression=e,this._warningHistory={},this._evaluator=new Hd(c,d),this._defaultValue=o?"color"===(m=o).type&&(th(m.default)||Array.isArray(m.default))?new Yn(0,0,0,0):"color"===m.type?Yn.parse(m.default)||null:void 0===m.default?null:m.default:null,this._enumValues=o&&"enum"===o.type?o.values:null,this.configDependencies=Xd(e)}evaluateWithoutErrorHandling(e,o,c,d,m,g,x,w){return this._evaluator.globals=e,this._evaluator.feature=o,this._evaluator.featureState=c,this._evaluator.canonical=d||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=g,this._evaluator.featureTileCoord=x||null,this._evaluator.featureDistanceData=w||null,this.expression.evaluate(this._evaluator)}evaluate(e,o,c,d,m,g,x,w){this._evaluator.globals=e,this._evaluator.feature=o||null,this._evaluator.featureState=c||null,this._evaluator.canonical=d||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=g||null,this._evaluator.featureTileCoord=x||null,this._evaluator.featureDistanceData=w||null;try{const T=this.expression.evaluate(this._evaluator);if(null==T||"number"==typeof T&&T!=T)return this._defaultValue;if(this._enumValues&&!(T in this._enumValues))throw new Er(`Expected value to be one of ${Object.keys(this._enumValues).map(C=>JSON.stringify(C)).join(", ")}, but found ${JSON.stringify(T)} instead.`);return T}catch(T){return this._warningHistory[T.message]||(this._warningHistory[T.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${T.message}`)),this._defaultValue}}}function Qg(s){return Array.isArray(s)&&s.length>0&&"string"==typeof s[0]&&s[0]in Jd}function Nc(s,e,o,c){const d=new Yd(Jd,[],e?function(g){const x={color:mi,string:Hn,number:Et,enum:Hn,boolean:Zn,formatted:Sc,resolvedImage:Dc};return"array"===g.type?fo(x[g.value]||Kn,g.length):x[g.type]}(e):void 0,void 0,void 0,o,c),m=d.parse(s,void 0,void 0,void 0,e&&"string"===e.type?{typeAnnotation:"coerce"}:void 0);return m?wf(new Kg(m,e,o,c)):el(d.errors)}class Sf{constructor(e,o,c,d){this.kind=e,this._styleExpression=o,this.isLightConstant=c,this.isLineProgressConstant=d,this.isStateDependent="constant"!==e&&!Hl(o.expression),this.configDependencies=Xd(o.expression)}evaluateWithoutErrorHandling(e,o,c,d,m,g){return this._styleExpression.evaluateWithoutErrorHandling(e,o,c,d,m,g)}evaluate(e,o,c,d,m,g){return this._styleExpression.evaluate(e,o,c,d,m,g)}}class Bc{constructor(e,o,c,d,m,g){this.kind=e,this.zoomStops=c,this._styleExpression=o,this.isStateDependent="camera"!==e&&!Hl(o.expression),this.isLightConstant=m,this.isLineProgressConstant=g,this.configDependencies=Xd(o.expression),this.interpolationType=d}evaluateWithoutErrorHandling(e,o,c,d,m,g){return this._styleExpression.evaluateWithoutErrorHandling(e,o,c,d,m,g)}evaluate(e,o,c,d,m,g){return this._styleExpression.evaluate(e,o,c,d,m,g)}interpolationFactor(e,o,c){return this.interpolationType?ns.interpolationFactor(this.interpolationType,e,o,c):0}}function Df(s,e,o,c){if("error"===(s=Nc(s,e,o,c)).result)return s;const d=s.value.expression,m=On(d);if(!m&&!ju(e))return el([new Un("","data expressions not supported")]);const g=ca(d,["zoom","pitch","distance-from-center"]);if(!g&&!Ef(e))return el([new Un("","zoom expressions not supported")]);const x=ca(d,["measure-light"]);if(!x&&!Jp(e))return el([new Un("","measure-light expression not supported")]);const w=ca(d,["line-progress"]);if(!w&&!tl(e.expression,"line-progress"))return el([new Un("","line-progress expression not supported")]);const T=e.expression&&e.expression.relaxZoomRestriction,C=nh(d);return C||g||T?C instanceof Un?el([C]):C instanceof ns&&!Uu(e)?el([new Un("",'"interpolate" expressions cannot be used with this property')]):wf(C?new Bc(m&&w?"camera":"composite",s.value,C.labels,C instanceof ns?C.interpolation:void 0,x,w):new Sf(m&&w?"constant":"source",s.value,x,w)):el([new Un("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class nl{constructor(e,o){this._parameters=e,this._specification=o,Ec(this,Tf(this._parameters,this._specification))}static deserialize(e){return new nl(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function nh(s){let e=null;if(s instanceof Kd)e=nh(s.result);else if(s instanceof Zp){for(const o of s.args)if(e=nh(o),e)break}else(s instanceof Za||s instanceof ns)&&s.input instanceof Xr&&"zoom"===s.input.name&&(e=s);return e instanceof Un||s.eachChild(o=>{const c=nh(o);c instanceof Un?e=c:e&&c&&e!==c&&(e=new Un("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var ih,fv,Wl=Rd(function(){if(fv)return ih;fv=1,ih=e;var s=3;function e(o,c,d){var m=this.cells=[];if(o instanceof ArrayBuffer){this.arrayBuffer=o;var g=new Int32Array(this.arrayBuffer);o=g[0],this.d=(c=g[1])+2*(d=g[2]);for(var x=0;x<this.d*this.d;x++){var w=g[s+x],T=g[s+x+1];m.push(w===T?null:g.subarray(w,T))}var C=g[s+m.length+1];this.keys=g.subarray(g[s+m.length],C),this.bboxes=g.subarray(C),this.insert=this._insertReadonly}else{this.d=c+2*d;for(var A=0;A<this.d*this.d;A++)m.push([]);this.keys=[],this.bboxes=[]}this.n=c,this.extent=o,this.padding=d,this.scale=c/o,this.uid=0;var M=d/c*o;this.min=-M,this.max=o+M}return e.prototype.insert=function(o,c,d,m,g){this._forEachCell(c,d,m,g,this._insertCell,this.uid++),this.keys.push(o),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(m),this.bboxes.push(g)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(o,c,d,m,g,x){this.cells[g].push(x)},e.prototype.query=function(o,c,d,m,g){var x=this.min,w=this.max;if(o<=x&&c<=x&&w<=d&&w<=m&&!g)return Array.prototype.slice.call(this.keys);var T=[];return this._forEachCell(o,c,d,m,this._queryCell,T,{},g),T},e.prototype._queryCell=function(o,c,d,m,g,x,w,T){var C=this.cells[g];if(null!==C)for(var A=this.keys,M=this.bboxes,k=0;k<C.length;k++){var F=C[k];if(void 0===w[F]){var V=4*F;(T?T(M[V+0],M[V+1],M[V+2],M[V+3]):o<=M[V+2]&&c<=M[V+3]&&d>=M[V+0]&&m>=M[V+1])?(w[F]=!0,x.push(A[F])):w[F]=!1}}},e.prototype._forEachCell=function(o,c,d,m,g,x,w,T){for(var C=this._convertToCellCoord(o),A=this._convertToCellCoord(c),M=this._convertToCellCoord(d),k=this._convertToCellCoord(m),F=C;F<=M;F++)for(var V=A;V<=k;V++){var j=this.d*V+F;if((!T||T(this._convertFromCellCoord(F),this._convertFromCellCoord(V),this._convertFromCellCoord(F+1),this._convertFromCellCoord(V+1)))&&g.call(this,o,c,d,m,j,x,w,T))return}},e.prototype._convertFromCellCoord=function(o){return(o-this.padding)/this.scale},e.prototype._convertToCellCoord=function(o){return Math.max(0,Math.min(this.d-1,Math.floor(o*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var o=this.cells,c=s+this.cells.length+1+1,d=0,m=0;m<this.cells.length;m++)d+=this.cells[m].length;var g=new Int32Array(c+d+this.keys.length+this.bboxes.length);g[0]=this.extent,g[1]=this.n,g[2]=this.padding;for(var x=c,w=0;w<o.length;w++){var T=o[w];g[s+w]=x,g.set(T,x),x+=T.length}return g[s+o.length]=x,g.set(this.keys,x),g[s+o.length+1]=x+=this.keys.length,g.set(this.bboxes,x),x+=this.bboxes.length,g.buffer},ih}());const Hu={};function wt(s,e,o={}){Object.defineProperty(s,"_classRegistryKey",{value:e,writable:!1}),Hu[e]={klass:s,omit:o.omit||[]}}wt(Object,"Object"),Wl.serialize=function(s,e){const o=s.toArrayBuffer();return e&&e.add(o),{buffer:o}},Wl.deserialize=function(s){return new Wl(s.buffer)},Object.defineProperty(Wl,"name",{value:"Grid"}),wt(Wl,"Grid"),delete Je.prototype.constructor,typeof DOMMatrix<"u"&&wt(DOMMatrix,"DOMMatrix"),wt(Yn,"Color"),wt(Error,"Error"),wt(Wr,"Formatted"),wt(zp,"FormattedSection"),wt(Rn,"AJAXError"),wt(po,"ResolvedImage"),wt(nl,"StylePropertyFunction"),wt(Kg,"StyleExpression",{omit:["_evaluator"]}),wt(Qt,"ImageId"),wt(aa,"ImageVariant"),wt(Bc,"ZoomDependentExpression"),wt(Sf,"ZoomConstantExpression"),wt(Xr,"CompoundExpression",{omit:["_evaluate"]});for(const s in Jd)Hu[Jd[s]._classRegistryKey]||wt(Jd[s],`Expression${s}`);function If(s){return s&&typeof ArrayBuffer<"u"&&(s instanceof ArrayBuffer||s.constructor&&"ArrayBuffer"===s.constructor.name)}function rh(s){return self.ImageBitmap&&s instanceof ImageBitmap}function il(s,e){if(null==s||"boolean"==typeof s||"number"==typeof s||"string"==typeof s||s instanceof Boolean||s instanceof Number||s instanceof String||s instanceof Date||s instanceof RegExp)return s;if(If(s)||rh(s))return e&&e.add(s),s;if(ArrayBuffer.isView(s))return e&&e.add(s.buffer),s;if(s instanceof ImageData)return e&&e.add(s.data.buffer),s;if(Array.isArray(s)){const o=[];for(const c of s)o.push(il(c,e));return o}if(s instanceof Map){const o={$name:"Map",entries:[]};for(const[c,d]of s.entries())o.entries.push(il(c),il(d,e));return o}if(s instanceof Set){const o={$name:"Set"};let c=0;for(const d of s.values())o[++c]=il(d);return o}if(s instanceof DOMMatrix){const o={$name:"DOMMatrix"},c=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const d of c)o[d]=s[d];return o}if("bigint"==typeof s)return{$name:"BigInt",value:s.toString()};if("object"==typeof s){const o=s.constructor,c=o._classRegistryKey;if(!c)throw new Error(`Can't serialize object of unregistered class "${o.name}".`);const d=o.serialize?o.serialize(s,e):{};if(!o.serialize){for(const m in s)s.hasOwnProperty(m)&&(Hu[c].omit.indexOf(m)>=0||(d[m]=il(s[m],e)));s instanceof Error&&(d.message=s.message)}if(d.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==c&&(d.$name=c),d}throw new Error("can't serialize object of type "+typeof s)}function jo(s){if(null==s||"boolean"==typeof s||"number"==typeof s||"string"==typeof s||s instanceof Boolean||s instanceof Number||s instanceof String||s instanceof Date||s instanceof RegExp||If(s)||rh(s)||ArrayBuffer.isView(s)||s instanceof ImageData)return s;if(Array.isArray(s))return s.map(jo);if("object"==typeof s){const e=s.$name||"Object";if("Map"===e){const d=s.entries||[],m=new Map;for(let g=0;g<d.length;g+=2)m.set(jo(d[g]),jo(d[g+1]));return m}if("Set"===e){const d=new Set;for(const m of Object.keys(s))"$name"!==m&&d.add(jo(s[m]));return d}if("DOMMatrix"===e){let d;return d=s.is2D?[s.a,s.b,s.c,s.d,s.e,s.f]:[s.m11,s.m12,s.m13,s.m14,s.m21,s.m22,s.m23,s.m24,s.m31,s.m32,s.m33,s.m34,s.m41,s.m42,s.m43,s.m44],new DOMMatrix(d)}if("BigInt"===e)return BigInt(s.value);const{klass:o}=Hu[e];if(!o)throw new Error(`Can't deserialize unregistered class "${e}".`);if(o.deserialize)return o.deserialize(s);const c=Object.create(o.prototype);for(const d of Object.keys(s))"$name"!==d&&(c[d]=jo(s[d]));return c}throw new Error("can't deserialize object of type "+typeof s)}const Vt={"Latin-1 Supplement":s=>s>=128&&s<=255,Arabic:s=>s>=1536&&s<=1791,"Arabic Supplement":s=>s>=1872&&s<=1919,"Arabic Extended-A":s=>s>=2208&&s<=2303,"Hangul Jamo":s=>s>=4352&&s<=4607,"Unified Canadian Aboriginal Syllabics":s=>s>=5120&&s<=5759,Khmer:s=>s>=6016&&s<=6143,"Unified Canadian Aboriginal Syllabics Extended":s=>s>=6320&&s<=6399,"General Punctuation":s=>s>=8192&&s<=8303,"Letterlike Symbols":s=>s>=8448&&s<=8527,"Number Forms":s=>s>=8528&&s<=8591,"Miscellaneous Technical":s=>s>=8960&&s<=9215,"Control Pictures":s=>s>=9216&&s<=9279,"Optical Character Recognition":s=>s>=9280&&s<=9311,"Enclosed Alphanumerics":s=>s>=9312&&s<=9471,"Geometric Shapes":s=>s>=9632&&s<=9727,"Miscellaneous Symbols":s=>s>=9728&&s<=9983,"Miscellaneous Symbols and Arrows":s=>s>=11008&&s<=11263,"CJK Radicals Supplement":s=>s>=11904&&s<=12031,"Kangxi Radicals":s=>s>=12032&&s<=12255,"Ideographic Description Characters":s=>s>=12272&&s<=12287,"CJK Symbols and Punctuation":s=>s>=12288&&s<=12351,Hiragana:s=>s>=12352&&s<=12447,Katakana:s=>s>=12448&&s<=12543,Bopomofo:s=>s>=12544&&s<=12591,"Hangul Compatibility Jamo":s=>s>=12592&&s<=12687,Kanbun:s=>s>=12688&&s<=12703,"Bopomofo Extended":s=>s>=12704&&s<=12735,"CJK Strokes":s=>s>=12736&&s<=12783,"Katakana Phonetic Extensions":s=>s>=12784&&s<=12799,"Enclosed CJK Letters and Months":s=>s>=12800&&s<=13055,"CJK Compatibility":s=>s>=13056&&s<=13311,"CJK Unified Ideographs Extension A":s=>s>=13312&&s<=19903,"Yijing Hexagram Symbols":s=>s>=19904&&s<=19967,"CJK Unified Ideographs":s=>s>=19968&&s<=40959,"Yi Syllables":s=>s>=40960&&s<=42127,"Yi Radicals":s=>s>=42128&&s<=42191,"Hangul Jamo Extended-A":s=>s>=43360&&s<=43391,"Hangul Syllables":s=>s>=44032&&s<=55215,"Hangul Jamo Extended-B":s=>s>=55216&&s<=55295,"Private Use Area":s=>s>=57344&&s<=63743,"CJK Compatibility Ideographs":s=>s>=63744&&s<=64255,"Arabic Presentation Forms-A":s=>s>=64336&&s<=65023,"Vertical Forms":s=>s>=65040&&s<=65055,"CJK Compatibility Forms":s=>s>=65072&&s<=65103,"Small Form Variants":s=>s>=65104&&s<=65135,"Arabic Presentation Forms-B":s=>s>=65136&&s<=65279,"Halfwidth and Fullwidth Forms":s=>s>=65280&&s<=65519,Osage:s=>s>=66736&&s<=66815,"CJK Unified Ideographs Extension B":s=>s>=131072&&s<=173791};function Cf(s){for(const e of s)if(Af(e.charCodeAt(0)))return!0;return!1}function pv(s){for(const e of s)if(!kx(e.charCodeAt(0)))return!1;return!0}function kx(s){return!(Vt.Arabic(s)||Vt["Arabic Supplement"](s)||Vt["Arabic Extended-A"](s)||Vt["Arabic Presentation Forms-A"](s)||Vt["Arabic Presentation Forms-B"](s))}function Af(s){return!(746!==s&&747!==s&&(s<4352||!(Vt["Bopomofo Extended"](s)||Vt.Bopomofo(s)||Vt["CJK Compatibility Forms"](s)&&!(s>=65097&&s<=65103)||Vt["CJK Compatibility Ideographs"](s)||Vt["CJK Compatibility"](s)||Vt["CJK Radicals Supplement"](s)||Vt["CJK Strokes"](s)||!(!Vt["CJK Symbols and Punctuation"](s)||s>=12296&&s<=12305||s>=12308&&s<=12319||12336===s)||Vt["CJK Unified Ideographs Extension A"](s)||Vt["CJK Unified Ideographs"](s)||Vt["Enclosed CJK Letters and Months"](s)||Vt["Hangul Compatibility Jamo"](s)||Vt["Hangul Jamo Extended-A"](s)||Vt["Hangul Jamo Extended-B"](s)||Vt["Hangul Jamo"](s)||Vt["Hangul Syllables"](s)||Vt.Hiragana(s)||Vt["Ideographic Description Characters"](s)||Vt.Kanbun(s)||Vt["Kangxi Radicals"](s)||Vt["Katakana Phonetic Extensions"](s)||Vt.Katakana(s)&&12540!==s||!(!Vt["Halfwidth and Fullwidth Forms"](s)||65288===s||65289===s||65293===s||s>=65306&&s<=65310||65339===s||65341===s||65343===s||s>=65371&&s<=65503||65507===s||s>=65512&&s<=65519)||!(!Vt["Small Form Variants"](s)||s>=65112&&s<=65118||s>=65123&&s<=65126)||Vt["Unified Canadian Aboriginal Syllabics"](s)||Vt["Unified Canadian Aboriginal Syllabics Extended"](s)||Vt["Vertical Forms"](s)||Vt["Yijing Hexagram Symbols"](s)||Vt["Yi Syllables"](s)||Vt["Yi Radicals"](s))))}function Vc(s){return!(Af(s)||(e=s,Vt["Latin-1 Supplement"](e)&&(167===e||169===e||174===e||177===e||188===e||189===e||190===e||215===e||247===e)||Vt["General Punctuation"](e)&&(8214===e||8224===e||8225===e||8240===e||8241===e||8251===e||8252===e||8258===e||8263===e||8264===e||8265===e||8273===e)||Vt["Letterlike Symbols"](e)||Vt["Number Forms"](e)||Vt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||9003===e||e>=9085&&e<=9114||e>=9150&&e<=9165||9167===e||e>=9169&&e<=9179||e>=9186&&e<=9215)||Vt["Control Pictures"](e)&&9251!==e||Vt["Optical Character Recognition"](e)||Vt["Enclosed Alphanumerics"](e)||Vt["Geometric Shapes"](e)||Vt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Vt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Vt["CJK Symbols and Punctuation"](e)||Vt.Katakana(e)||Vt["Private Use Area"](e)||Vt["CJK Compatibility Forms"](e)||Vt["Small Form Variants"](e)||Vt["Halfwidth and Fullwidth Forms"](e)||8734===e||8756===e||8757===e||e>=9984&&e<=10087||e>=10102&&e<=10131||65532===e||65533===e));var e}function nm(s){return Vt.Arabic(s)||Vt["Arabic Supplement"](s)||Vt["Arabic Extended-A"](s)||Vt["Arabic Presentation Forms-A"](s)||Vt["Arabic Presentation Forms-B"](s)}function Mf(s){return s>=1424&&s<=2303||Vt["Arabic Presentation Forms-A"](s)||Vt["Arabic Presentation Forms-B"](s)}function mv(s,e){return!(!e&&Mf(s)||s>=2304&&s<=3583||s>=3840&&s<=4255||Vt.Khmer(s))}function e_(s){for(const e of s)if(Mf(e.charCodeAt(0)))return!0;return!1}const rs={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let im=null,vo=rs.unavailable,Zl=null;const ua=function(s){s&&"string"==typeof s&&s.indexOf("NetworkError")>-1&&(vo=rs.error),im&&im(s)};function Pf(){Rf.fire(new qr("pluginStateChange",{pluginStatus:vo,pluginURL:Zl}))}const Rf=new Mu,ar=function(){return vo},Of=function(){if(vo!==rs.deferred||!Zl)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");vo=rs.loading,Pf(),Zl&&vc({url:Zl},s=>{s?ua(s):(vo=rs.loaded,Pf())})},zs={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>vo===rs.loaded||null!=zs.applyArabicShaping,isLoading:()=>vo===rs.loading,setState(s){vo=s.pluginStatus,Zl=s.pluginURL},isParsing:()=>vo===rs.parsing,isParsed:()=>vo===rs.parsed,getPluginURL:()=>Zl};class Tn{constructor(e,o){this.zoom=e,o?(this.now=o.now,this.fadeDuration=o.fadeDuration,this.transition=o.transition,this.pitch=o.pitch,this.brightness=o.brightness,this.worldview=o.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(o,c){for(const d of o)if(!mv(d.charCodeAt(0),c))return!1;return!0}(e,zs.isLoaded())}}class oh{constructor(e,o,c,d){this.property=e,this.value=o,this.expression=function(m,g,x,w){if(th(m))return new nl(m,g);if(Qg(m)||Array.isArray(m)&&m.length>0){const T=Df(m,g,x,w);if("error"===T.result)throw new Error(T.value.map(C=>`${C.key}: ${C.message}`).join(", "));return T.value}{let T=m;return"string"==typeof m&&"color"===g.type&&(T=Yn.parse(m)),{kind:"constant",configDependencies:new Set,evaluate:()=>T}}}(void 0===o?e.specification.default:o,e.specification,c,d)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(e,o,c){return this.property.possiblyEvaluate(this,e,o,c)}}class sh{constructor(e,o,c){this.property=e,this.value=new oh(e,void 0,o,c)}transitioned(e,o){return new ys(this.property,this.value,o,Ae({},e.transition,this.transition),e.now)}untransitioned(){return new ys(this.property,this.value,null,{},0)}}class Pa{constructor(e,o,c){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=o,this._options=c,this.configDependencies=new Set}getValue(e){return pn(this._values[e].value.value)}setValue(e,o){this._values.hasOwnProperty(e)||(this._values[e]=new sh(this._values[e].property,this._scope,this._options)),this._values[e].value=new oh(this._values[e].property,null===o?void 0:pn(o),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,o){o&&(this._options=o);const c=this._properties.properties;if(e)for(const d in e){const m=e[d];if(d.endsWith("-transition")){const g=d.slice(0,-11);c[g]&&this.setTransition(g,m)}else c.hasOwnProperty(d)&&this.setValue(d,m)}}getTransition(e){return pn(this._values[e].transition)}setTransition(e,o){this._values.hasOwnProperty(e)||(this._values[e]=new sh(this._values[e].property)),this._values[e].transition=pn(o)||void 0}serialize(){const e={};for(const o of Object.keys(this._values)){const c=this.getValue(o);void 0!==c&&(e[o]=c);const d=this.getTransition(o);void 0!==d&&(e[`${o}-transition`]=d)}return e}transitioned(e,o){const c=new t_(this._properties);for(const d of Object.keys(this._values))c._values[d]=this._values[d].transitioned(e,o._values[d]);return c}untransitioned(){const e=new t_(this._properties);for(const o of Object.keys(this._values))e._values[o]=this._values[o].untransitioned();return e}}class ys{constructor(e,o,c,d,m){const g=d.delay||0,x=d.duration||0;m=m||0,this.property=e,this.value=o,this.begin=m+g,this.end=this.begin+x,e.specification.transition&&(d.delay||d.duration)&&(this.prior=c)}possiblyEvaluate(e,o,c){const d=e.now||0,m=this.value.possiblyEvaluate(e,o,c),g=this.prior;if(g){if(d>this.end)return this.prior=null,m;if(this.value.isDataDriven())return this.prior=null,m;if(d<this.begin)return g.possiblyEvaluate(e,o,c);{const x=(d-this.begin)/(this.end-this.begin);return this.property.interpolate(g.possiblyEvaluate(e,o,c),m,X(x))}}return m}}class t_{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,o,c){const d=new xo(this._properties);for(const m of Object.keys(this._values))d._values[m]=this._values[m].possiblyEvaluate(e,o,c);return d}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Xl{constructor(e,o,c){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=o,this._options=c,this.configDependencies=new Set}getValue(e){return pn(this._values[e].value)}setValue(e,o){this._values[e]=new oh(this._values[e].property,null===o?void 0:pn(o),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){const e={};for(const o of Object.keys(this._values)){const c=this.getValue(o);void 0!==c&&(e[o]=c)}return e}possiblyEvaluate(e,o,c){const d=new xo(this._properties);for(const m of Object.keys(this._values))d._values[m]=this._values[m].possiblyEvaluate(e,o,c);return d}}class jc{constructor(e,o,c){this.property=e,this.value=o,this.parameters=c}isConstant(){return"constant"===this.value.kind}constantOr(e){return"constant"===this.value.kind?this.value.value:e}evaluate(e,o,c,d){return this.property.evaluate(this.value,this.parameters,e,o,c,d)}}class xo{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class it{constructor(e){this.specification=e}possiblyEvaluate(e,o){return e.expression.evaluate(o)}interpolate(e,o,c){const d=Lu[this.specification.type];return d?d(e,o,c):e}}class _t{constructor(e,o){this.specification=e,this.overrides=o}possiblyEvaluate(e,o,c,d){return new jc(this,"constant"===e.expression.kind||"camera"===e.expression.kind?{kind:"constant",value:e.expression.evaluate(o,null,{},c,d)}:e.expression,o)}interpolate(e,o,c){if("constant"!==e.value.kind||"constant"!==o.value.kind)return e;if(void 0===e.value.value||void 0===o.value.value)return new jc(this,{kind:"constant",value:void 0},e.parameters);const d=Lu[this.specification.type];return d?new jc(this,{kind:"constant",value:d(e.value.value,o.value.value,c)},e.parameters):e}evaluate(e,o,c,d,m,g){return"constant"===e.kind?e.value:e.evaluate(o,c,d,m,g)}}class Uc{constructor(e){this.specification=e}possiblyEvaluate(e,o,c,d){return!!e.expression.evaluate(o,null,{},c,d)}interpolate(){return!1}}class Wi{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const o=new Tn(0,{});for(const c in e){const d=e[c];d.specification.overridable&&this.overridableProperties.push(c);const m=this.defaultPropertyValues[c]=new oh(d,void 0),g=this.defaultTransitionablePropertyValues[c]=new sh(d);this.defaultTransitioningPropertyValues[c]=g.untransitioned(),this.defaultPossiblyEvaluatedValues[c]=m.possiblyEvaluate(o)}}}wt(_t,"DataDrivenProperty"),wt(it,"DataConstantProperty"),wt(Uc,"ColorRampProperty");var De=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"expression"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function n_(s){return s instanceof Number||s instanceof String||s instanceof Boolean?s.valueOf():s}function Sn(s){if(Array.isArray(s))return s.map(Sn);if(s instanceof Object&&!(s instanceof Number||s instanceof String||s instanceof Boolean)){const e={};for(const o in s)e[o]=Sn(s[o]);return e}return n_(s)}function Gu(s){if(!0===s||!1===s)return!0;if(!Array.isArray(s)||0===s.length)return!1;switch(s[0]){case"has":return s.length>=2&&"$id"!==s[1]&&"$type"!==s[1];case"in":return s.length>=3&&("string"!=typeof s[1]||Array.isArray(s[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==s.length||Array.isArray(s[1])||Array.isArray(s[2]);case"any":case"all":for(const e of s.slice(1))if(!Gu(e)&&"boolean"!=typeof e)return!1;return!0;default:return!0}}function ah(s,e="",o=null,c="fill"){if(null==s)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Gu(s)||(s=kf(s));const d=s;let m=!0;try{m=function(C){if(!$u(C))return C;let A=Sn(C);return Lf(A),A=rm(A),A}(d)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(d,null,2)}\n        `)}let g=null,x=null;if("background"!==c&&"sky"!==c&&"slot"!==c){x=De[`filter_${c}`];const C=Nc(m,x,e,o);if("error"===C.result)throw new Error(C.value.map(A=>`${A.key}: ${A.message}`).join(", "));g=(A,M,k)=>C.value.evaluate(A,M,{},k)}let w=null,T=null;if(m!==d){const C=Nc(d,x,e,o);if("error"===C.result)throw new Error(C.value.map(A=>`${A.key}: ${A.message}`).join(", "));w=(A,M,k,F,V)=>C.value.evaluate(A,M,{},k,void 0,void 0,F,V),T=!On(C.value.expression)}return{filter:g,dynamicFilter:w||void 0,needGeometry:om(m),needFeature:!!T}}function rm(s){if(!Array.isArray(s))return s;const e=function(o){if(da.has(o[0]))for(let c=1;c<o.length;c++)if($u(o[c]))return!0;return o}(s);return!0===e?e:e.map(o=>rm(o))}function Lf(s){let e=!1;const o=[];if("case"===s[0]){for(let c=1;c<s.length-1;c+=2)e=e||$u(s[c]),o.push(s[c+1]);o.push(s[s.length-1])}else if("match"===s[0]){e=e||$u(s[1]);for(let c=2;c<s.length-1;c+=2)o.push(s[c+1]);o.push(s[s.length-1])}else if("step"===s[0]){e=e||$u(s[1]);for(let c=1;c<s.length-1;c+=2)o.push(s[c+1])}e&&(s.length=0,s.push("any",...o));for(let c=1;c<s.length;c++)Lf(s[c])}function $u(s){if(!Array.isArray(s))return!1;if("pitch"===(e=s[0])||"distance-from-center"===e)return!0;var e;for(let o=1;o<s.length;o++)if($u(s[o]))return!0;return!1}const da=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function qu(s,e){return s<e?-1:s>e?1:0}function om(s){if(!Array.isArray(s))return!1;if("within"===s[0]||"distance"===s[0])return!0;for(let e=1;e<s.length;e++)if(om(s[e]))return!0;return!1}function kf(s){if(!s)return!0;const e=s[0];return s.length<=1?"any"!==e:"=="===e?sm(s[1],s[2],"=="):"!="===e?It(sm(s[1],s[2],"==")):"<"===e||">"===e||"<="===e||">="===e?sm(s[1],s[2],e):"any"===e?(o=s.slice(1),["any"].concat(o.map(kf))):"all"===e?["all"].concat(s.slice(1).map(kf)):"none"===e?["all"].concat(s.slice(1).map(kf).map(It)):"in"===e?i_(s[1],s.slice(2)):"!in"===e?It(i_(s[1],s.slice(2))):"has"===e?r_(s[1]):"!has"!==e||It(r_(s[1]));var o}function sm(s,e,o){switch(s){case"$type":return[`filter-type-${o}`,e];case"$id":return[`filter-id-${o}`,e];default:return[`filter-${o}`,s,e]}}function i_(s,e){if(0===e.length)return!1;switch(s){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(o=>typeof o!=typeof e[0])?["filter-in-large",s,["literal",e.sort(qu)]]:["filter-in-small",s,["literal",e]]}}function r_(s){switch(s){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",s]}}function It(s){return["!",s]}function Wu(s,e){return e?`${s}\x1f${e}`:s}const o_="-transition",Mo=new Set(["fill","line","background","hillshade","raster"]);class bo extends Mu{constructor(e,o,c,d,m){if(super(),this.id=e.id,this.fqid=Wu(this.id,c),this.type=e.type,this.scope=c,this.lut=d,this.options=m,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,"custom"!==e.type){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&"background"!==e.type&&"sky"!==e.type&&"slot"!==e.type){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const g=Nc(this.filter,De[`filter_${e.type}`]);"error"!==g.result&&(this.configDependencies=new Set([...this.configDependencies,...g.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),o.layout&&(this._unevaluatedLayout=new Xl(o.layout,this.scope,m),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),o.paint){this._transitionablePaint=new Pa(o.paint,this.scope,m);for(const g in e.paint)this.setPaintProperty(g,e.paint[g]);for(const g in e.layout)this.setLayoutProperty(g,e.layout[g]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new xo(o.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Mo.has(this.type)}getLayoutProperty(e){return"visibility"===e?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,o){if("custom"===this.type&&"visibility"===e)return void(this.visibility=o);const c=this._unevaluatedLayout;c._properties.properties[e]&&(c.setValue(e,o),this.configDependencies=new Set([...this.configDependencies,...c.configDependencies]),"visibility"===e&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(o_)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,o){const c=this._transitionablePaint,d=c._properties.properties;if(e.endsWith(o_)){const A=e.slice(0,-11);return d[A]&&c.setTransition(A,o||void 0),!1}if(!d[e])return!1;const m=c._values[e],g=m.value.isDataDriven(),x=m.value;c.setValue(e,o),this.configDependencies=new Set([...this.configDependencies,...c.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);const w=c._values[e].value,T=w.isDataDriven(),C=e.endsWith("pattern")||"line-dasharray"===e;return T||g||C||this._handleOverridablePaintPropertyUpdate(e,x,w)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,o,c){return null}_handleOverridablePaintPropertyUpdate(e,o,c){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||"none"===this.visibility}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,o){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,o)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,o)}serialize(){return bn({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,o)=>!(void 0===e||"layout"===o&&!Object.keys(e).length||"paint"===o&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const o=this.paint.get(e);if(o instanceof jc&&ju(o.property.specification)&&("source"===o.value.kind||"composite"===o.value.kind)&&o.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=ah(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&("shadow"===e.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,o,c,d,m,g,x,w,T){}}const lh={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class vs{constructor(e,o){this._structArray=e,this._pos1=o*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class bi{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,o){return e._trim(),o&&o.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const o=Object.create(this.prototype);return o.arrayBuffer=e.arrayBuffer,o.length=e.length,o.capacity=e.arrayBuffer.byteLength/o.bytesPerElement,o._refreshViews(),o}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const o=this.uint8;this._refreshViews(),o&&this.uint8.set(o)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function En(s,e=1){let o=0,c=0;return{members:s.map(d=>{const m=lh[d.type].BYTES_PER_ELEMENT,g=o=am(o,Math.max(e,m)),x=d.components||1;return c=Math.max(c,m),o+=m*x,{name:d.name,type:d.type,components:x,offset:g}}),size:am(o,Math.max(c,e)),alignment:e}}function am(s,e){return Math.ceil(s/e)*e}class xs extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,o){const c=this.length;return this.resize(c+1),this.emplace(c,e,o)}emplace(e,o,c){const d=2*e;return this.int16[d+0]=o,this.int16[d+1]=c,e}}xs.prototype.bytesPerElement=4,wt(xs,"StructArrayLayout2i4");class Hc extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,o,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,o,c)}emplace(e,o,c,d){const m=3*e;return this.int16[m+0]=o,this.int16[m+1]=c,this.int16[m+2]=d,e}}Hc.prototype.bytesPerElement=6,wt(Hc,"StructArrayLayout3i6");class Qr extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,o,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,e,o,c,d)}emplace(e,o,c,d,m){const g=4*e;return this.int16[g+0]=o,this.int16[g+1]=c,this.int16[g+2]=d,this.int16[g+3]=m,e}}Qr.prototype.bytesPerElement=8,wt(Qr,"StructArrayLayout4i8");class os extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const o=this.length;return this.resize(o+1),this.emplace(o,e)}emplace(e,o){return this.float32[1*e+0]=o,e}}os.prototype.bytesPerElement=4,wt(os,"StructArrayLayout1f4");class Ff extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,o,c)}emplace(e,o,c,d){const m=4*e,g=2*e;return this.int16[m+0]=o,this.int16[m+1]=c,this.float32[g+1]=d,e}}Ff.prototype.bytesPerElement=8,wt(Ff,"StructArrayLayout2i1f8");class Yl extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,o,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,o,c)}emplace(e,o,c,d){const m=4*e;return this.int16[m+0]=o,this.int16[m+1]=c,this.int16[m+2]=d,e}}Yl.prototype.bytesPerElement=8,wt(Yl,"StructArrayLayout3i8");class Xs extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m){const g=this.length;return this.resize(g+1),this.emplace(g,e,o,c,d,m)}emplace(e,o,c,d,m,g){const x=5*e;return this.int16[x+0]=o,this.int16[x+1]=c,this.int16[x+2]=d,this.int16[x+3]=m,this.int16[x+4]=g,e}}Xs.prototype.bytesPerElement=10,wt(Xs,"StructArrayLayout5i10");class zf extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,e,o,c,d,m,g,x)}emplace(e,o,c,d,m,g,x,w){const T=6*e,C=12*e,A=3*e;return this.int16[T+0]=o,this.int16[T+1]=c,this.uint8[C+4]=d,this.uint8[C+5]=m,this.uint8[C+6]=g,this.uint8[C+7]=x,this.float32[A+2]=w,e}}zf.prototype.bytesPerElement=12,wt(zf,"StructArrayLayout2i4ub1f12");class bs extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,o,c)}emplace(e,o,c,d){const m=3*e;return this.float32[m+0]=o,this.float32[m+1]=c,this.float32[m+2]=d,e}}bs.prototype.bytesPerElement=12,wt(bs,"StructArrayLayout3f12");class Kl extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m){const g=this.length;return this.resize(g+1),this.emplace(g,e,o,c,d,m)}emplace(e,o,c,d,m,g){const x=6*e,w=3*e;return this.uint16[x+0]=o,this.uint16[x+1]=c,this.uint16[x+2]=d,this.uint16[x+3]=m,this.float32[w+2]=g,e}}Kl.prototype.bytesPerElement=12,wt(Kl,"StructArrayLayout4ui1f12");class Zu extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,o,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,e,o,c,d)}emplace(e,o,c,d,m){const g=4*e;return this.uint16[g+0]=o,this.uint16[g+1]=c,this.uint16[g+2]=d,this.uint16[g+3]=m,e}}Zu.prototype.bytesPerElement=8,wt(Zu,"StructArrayLayout4ui8");class Xu extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g){const x=this.length;return this.resize(x+1),this.emplace(x,e,o,c,d,m,g)}emplace(e,o,c,d,m,g,x){const w=6*e;return this.int16[w+0]=o,this.int16[w+1]=c,this.int16[w+2]=d,this.int16[w+3]=m,this.int16[w+4]=g,this.int16[w+5]=x,e}}Xu.prototype.bytesPerElement=12,wt(Xu,"StructArrayLayout6i12");class Yu extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x,w,T,C,A,M){const k=this.length;return this.resize(k+1),this.emplace(k,e,o,c,d,m,g,x,w,T,C,A,M)}emplace(e,o,c,d,m,g,x,w,T,C,A,M,k){const F=12*e;return this.int16[F+0]=o,this.int16[F+1]=c,this.int16[F+2]=d,this.int16[F+3]=m,this.uint16[F+4]=g,this.uint16[F+5]=x,this.uint16[F+6]=w,this.uint16[F+7]=T,this.int16[F+8]=C,this.int16[F+9]=A,this.int16[F+10]=M,this.int16[F+11]=k,e}}Yu.prototype.bytesPerElement=24,wt(Yu,"StructArrayLayout4i4ui4i24");class Gc extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g){const x=this.length;return this.resize(x+1),this.emplace(x,e,o,c,d,m,g)}emplace(e,o,c,d,m,g,x){const w=10*e,T=5*e;return this.int16[w+0]=o,this.int16[w+1]=c,this.int16[w+2]=d,this.float32[T+2]=m,this.float32[T+3]=g,this.float32[T+4]=x,e}}Gc.prototype.bytesPerElement=20,wt(Gc,"StructArrayLayout3i3f20");class Ra extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,e,o,c,d)}emplace(e,o,c,d,m){const g=4*e;return this.float32[g+0]=o,this.float32[g+1]=c,this.float32[g+2]=d,this.float32[g+3]=m,e}}Ra.prototype.bytesPerElement=16,wt(Ra,"StructArrayLayout4f16");class lm extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const o=this.length;return this.resize(o+1),this.emplace(o,e)}emplace(e,o){return this.uint32[1*e+0]=o,e}}lm.prototype.bytesPerElement=4,wt(lm,"StructArrayLayout1ul4");class ha extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,o){const c=this.length;return this.resize(c+1),this.emplace(c,e,o)}emplace(e,o,c){const d=2*e;return this.uint16[d+0]=o,this.uint16[d+1]=c,e}}ha.prototype.bytesPerElement=4,wt(ha,"StructArrayLayout2ui4");class ch extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x,w,T,C,A,M,k){const F=this.length;return this.resize(F+1),this.emplace(F,e,o,c,d,m,g,x,w,T,C,A,M,k)}emplace(e,o,c,d,m,g,x,w,T,C,A,M,k,F){const V=20*e,j=10*e;return this.int16[V+0]=o,this.int16[V+1]=c,this.int16[V+2]=d,this.int16[V+3]=m,this.int16[V+4]=g,this.float32[j+3]=x,this.float32[j+4]=w,this.float32[j+5]=T,this.float32[j+6]=C,this.int16[V+14]=A,this.uint32[j+8]=M,this.uint16[V+18]=k,this.uint16[V+19]=F,e}}ch.prototype.bytesPerElement=40,wt(ch,"StructArrayLayout5i4f1i1ul2ui40");class uh extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,e,o,c,d,m,g,x)}emplace(e,o,c,d,m,g,x,w){const T=8*e;return this.int16[T+0]=o,this.int16[T+1]=c,this.int16[T+2]=d,this.int16[T+4]=m,this.int16[T+5]=g,this.int16[T+6]=x,this.int16[T+7]=w,e}}uh.prototype.bytesPerElement=16,wt(uh,"StructArrayLayout3i2i2i16");class $c extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m){const g=this.length;return this.resize(g+1),this.emplace(g,e,o,c,d,m)}emplace(e,o,c,d,m,g){const x=4*e,w=8*e;return this.float32[x+0]=o,this.float32[x+1]=c,this.float32[x+2]=d,this.int16[w+6]=m,this.int16[w+7]=g,e}}$c.prototype.bytesPerElement=16,wt($c,"StructArrayLayout2f1f2i16");class qc extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g){const x=this.length;return this.resize(x+1),this.emplace(x,e,o,c,d,m,g)}emplace(e,o,c,d,m,g,x){const w=20*e,T=5*e;return this.uint8[w+0]=o,this.uint8[w+1]=c,this.float32[T+1]=d,this.float32[T+2]=m,this.float32[T+3]=g,this.float32[T+4]=x,e}}qc.prototype.bytesPerElement=20,wt(qc,"StructArrayLayout2ub4f20");class Mi extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,o,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,o,c)}emplace(e,o,c,d){const m=3*e;return this.uint16[m+0]=o,this.uint16[m+1]=c,this.uint16[m+2]=d,e}}Mi.prototype.bytesPerElement=6,wt(Mi,"StructArrayLayout3ui6");class Ql extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W,Q,K,te,me){const he=this.length;return this.resize(he+1),this.emplace(he,e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W,Q,K,te,me)}emplace(e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W,Q,K,te,me,he){const fe=30*e,xe=15*e,Ee=60*e;return this.int16[fe+0]=o,this.int16[fe+1]=c,this.int16[fe+2]=d,this.float32[xe+2]=m,this.float32[xe+3]=g,this.uint16[fe+8]=x,this.uint16[fe+9]=w,this.uint32[xe+5]=T,this.uint32[xe+6]=C,this.uint32[xe+7]=A,this.uint16[fe+16]=M,this.uint16[fe+17]=k,this.uint16[fe+18]=F,this.float32[xe+10]=V,this.float32[xe+11]=j,this.uint8[Ee+48]=W,this.uint8[Ee+49]=Q,this.uint8[Ee+50]=K,this.uint32[xe+13]=te,this.int16[fe+28]=me,this.uint8[Ee+58]=he,e}}Ql.prototype.bytesPerElement=60,wt(Ql,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class cm extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W,Q,K,te,me,he,fe,xe,Ee,Ve,Ie,Ue,ot,$e,Ke,nt,Ne){const Qe=this.length;return this.resize(Qe+1),this.emplace(Qe,e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W,Q,K,te,me,he,fe,xe,Ee,Ve,Ie,Ue,ot,$e,Ke,nt,Ne)}emplace(e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W,Q,K,te,me,he,fe,xe,Ee,Ve,Ie,Ue,ot,$e,Ke,nt,Ne,Qe){const Ce=20*e,Be=40*e,at=80*e;return this.float32[Ce+0]=o,this.float32[Ce+1]=c,this.int16[Be+4]=d,this.int16[Be+5]=m,this.int16[Be+6]=g,this.int16[Be+7]=x,this.int16[Be+8]=w,this.int16[Be+9]=T,this.int16[Be+10]=C,this.int16[Be+11]=A,this.int16[Be+12]=M,this.uint16[Be+13]=k,this.uint16[Be+14]=F,this.uint16[Be+15]=V,this.uint16[Be+16]=j,this.uint16[Be+17]=W,this.uint16[Be+18]=Q,this.uint16[Be+19]=K,this.uint16[Be+20]=te,this.uint16[Be+21]=me,this.uint16[Be+22]=he,this.uint16[Be+23]=fe,this.uint16[Be+24]=xe,this.uint16[Be+25]=Ee,this.uint16[Be+26]=Ve,this.uint16[Be+27]=Ie,this.uint32[Ce+14]=Ue,this.float32[Ce+15]=ot,this.float32[Ce+16]=$e,this.float32[Ce+17]=Ke,this.float32[Ce+18]=nt,this.uint8[at+76]=Ne,this.uint16[Be+39]=Qe,e}}cm.prototype.bytesPerElement=80,wt(cm,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class um extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g){const x=this.length;return this.resize(x+1),this.emplace(x,e,o,c,d,m,g)}emplace(e,o,c,d,m,g,x){const w=6*e;return this.float32[w+0]=o,this.float32[w+1]=c,this.float32[w+2]=d,this.float32[w+3]=m,this.float32[w+4]=g,this.float32[w+5]=x,e}}um.prototype.bytesPerElement=24,wt(um,"StructArrayLayout6f24");class Br extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m){const g=this.length;return this.resize(g+1),this.emplace(g,e,o,c,d,m)}emplace(e,o,c,d,m,g){const x=5*e;return this.float32[x+0]=o,this.float32[x+1]=c,this.float32[x+2]=d,this.float32[x+3]=m,this.float32[x+4]=g,e}}Br.prototype.bytesPerElement=20,wt(Br,"StructArrayLayout5f20");class rl extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,e,o,c,d,m,g,x)}emplace(e,o,c,d,m,g,x,w){const T=7*e;return this.float32[T+0]=o,this.float32[T+1]=c,this.float32[T+2]=d,this.float32[T+3]=m,this.float32[T+4]=g,this.float32[T+5]=x,this.float32[T+6]=w,e}}rl.prototype.bytesPerElement=28,wt(rl,"StructArrayLayout7f28");class fr extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x,w,T,C,A){const M=this.length;return this.resize(M+1),this.emplace(M,e,o,c,d,m,g,x,w,T,C,A)}emplace(e,o,c,d,m,g,x,w,T,C,A,M){const k=11*e;return this.float32[k+0]=o,this.float32[k+1]=c,this.float32[k+2]=d,this.float32[k+3]=m,this.float32[k+4]=g,this.float32[k+5]=x,this.float32[k+6]=w,this.float32[k+7]=T,this.float32[k+8]=C,this.float32[k+9]=A,this.float32[k+10]=M,e}}fr.prototype.bytesPerElement=44,wt(fr,"StructArrayLayout11f44");class dm extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x,w,T){const C=this.length;return this.resize(C+1),this.emplace(C,e,o,c,d,m,g,x,w,T)}emplace(e,o,c,d,m,g,x,w,T,C){const A=9*e;return this.float32[A+0]=o,this.float32[A+1]=c,this.float32[A+2]=d,this.float32[A+3]=m,this.float32[A+4]=g,this.float32[A+5]=x,this.float32[A+6]=w,this.float32[A+7]=T,this.float32[A+8]=C,e}}dm.prototype.bytesPerElement=36,wt(dm,"StructArrayLayout9f36");class Jl extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o){const c=this.length;return this.resize(c+1),this.emplace(c,e,o)}emplace(e,o,c){const d=2*e;return this.float32[d+0]=o,this.float32[d+1]=c,e}}Jl.prototype.bytesPerElement=8,wt(Jl,"StructArrayLayout2f8");class hm extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,o,c,d){const m=this.length;return this.resize(m+1),this.emplace(m,e,o,c,d)}emplace(e,o,c,d,m){const g=6*e;return this.uint32[3*e+0]=o,this.uint16[g+2]=c,this.uint16[g+3]=d,this.uint16[g+4]=m,e}}hm.prototype.bytesPerElement=12,wt(hm,"StructArrayLayout1ul3ui12");class fm extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const o=this.length;return this.resize(o+1),this.emplace(o,e)}emplace(e,o){return this.uint16[1*e+0]=o,e}}fm.prototype.bytesPerElement=2,wt(fm,"StructArrayLayout1ui2");class dh extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j){const W=this.length;return this.resize(W+1),this.emplace(W,e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j)}emplace(e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W){const Q=16*e;return this.float32[Q+0]=o,this.float32[Q+1]=c,this.float32[Q+2]=d,this.float32[Q+3]=m,this.float32[Q+4]=g,this.float32[Q+5]=x,this.float32[Q+6]=w,this.float32[Q+7]=T,this.float32[Q+8]=C,this.float32[Q+9]=A,this.float32[Q+10]=M,this.float32[Q+11]=k,this.float32[Q+12]=F,this.float32[Q+13]=V,this.float32[Q+14]=j,this.float32[Q+15]=W,e}}dh.prototype.bytesPerElement=64,wt(dh,"StructArrayLayout16f64");class Wc extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,o,c,d,m,g,x){const w=this.length;return this.resize(w+1),this.emplace(w,e,o,c,d,m,g,x)}emplace(e,o,c,d,m,g,x,w){const T=10*e,C=5*e;return this.uint16[T+0]=o,this.uint16[T+1]=c,this.uint16[T+2]=d,this.uint16[T+3]=m,this.float32[C+2]=g,this.float32[C+3]=x,this.float32[C+4]=w,e}}Wc.prototype.bytesPerElement=20,wt(Wc,"StructArrayLayout4ui3f20");class Ku extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const o=this.length;return this.resize(o+1),this.emplace(o,e)}emplace(e,o){return this.int16[1*e+0]=o,e}}Ku.prototype.bytesPerElement=2,wt(Ku,"StructArrayLayout1i2");class fa extends bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const o=this.length;return this.resize(o+1),this.emplace(o,e)}emplace(e,o){return this.uint8[1*e+0]=o,e}}fa.prototype.bytesPerElement=1,wt(fa,"StructArrayLayout1ub1");class pm extends vs{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}pm.prototype.size=40;class hh extends ch{get(e){return new pm(this,e)}}wt(hh,"CollisionBoxArray");class Zc extends vs{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Zc.prototype.size=60;class ec extends Ql{get(e){return new Zc(this,e)}}wt(ec,"PlacedSymbolArray");class fh extends vs{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}fh.prototype.size=80;class mm extends cm{get(e){return new fh(this,e)}}wt(mm,"SymbolInstanceArray");class Nf extends os{getoffsetX(e){return this.float32[1*e+0]}}wt(Nf,"GlyphOffsetArray");class s_ extends xs{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}wt(s_,"SymbolLineVertexArray");class ol extends vs{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}ol.prototype.size=12;class Qu extends hm{get(e){return new ol(this,e)}}wt(Qu,"FeatureIndexArray");class a_ extends ha{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}wt(a_,"FillExtrusionCentroidArray");class gv extends vs{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}gv.prototype.size=6;class Bf extends Hc{get(e){return new gv(this,e)}}wt(Bf,"FillExtrusionWallArray");const _v=En([{name:"a_pos",components:2,type:"Int16"}],4),yv=En([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),vv=En([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Gi{constructor(e=[]){this.segments=e}_prepareSegment(e,o,c,d){let m=this.segments[this.segments.length-1];return e>Gi.MAX_VERTEX_ARRAY_LENGTH&&yn(`Max vertices per segment is ${Gi.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!m||m.vertexLength+e>Gi.MAX_VERTEX_ARRAY_LENGTH||m.sortKey!==d)&&(m={vertexOffset:o,primitiveOffset:c,vertexLength:0,primitiveLength:0},void 0!==d&&(m.sortKey=d),this.segments.push(m)),m}prepareSegment(e,o,c,d){return this._prepareSegment(e,o.length,c.length,d)}get(){return this.segments}destroy(){for(const e of this.segments)for(const o in e.vaos)e.vaos[o].destroy()}static simpleSegment(e,o,c,d){return new Gi([{vertexOffset:e,primitiveOffset:o,vertexLength:c,primitiveLength:d,vaos:{},sortKey:0}])}}function xv(s,e){return 256*(s=se(Math.floor(s),0,255))+se(Math.floor(e),0,255)}Gi.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,wt(Gi,"SegmentVector");const gm=En([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Xc=En([{name:"a_pattern_b",components:4,type:"Uint16"}]),bv=En([{name:"a_dash",components:4,type:"Uint16"}]);class sl{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,o,c,d){this.ids.push(Yc(e)),this.positions.push(o,c,d)}eachPosition(e,o){const c=Yc(e);let d=0,m=this.ids.length-1;for(;d<m;){const g=d+m>>1;this.ids[g]>=c?m=g:d=g+1}for(;this.ids[d]===c;)o(this.positions[3*d],this.positions[3*d+1],this.positions[3*d+2]),d++}static serialize(e,o){const c=new Float64Array(e.ids),d=new Uint32Array(e.positions);return Ju(c,d,0,c.length-1),o&&(o.add(c.buffer),o.add(d.buffer)),{ids:c,positions:d}}static deserialize(e){const o=new sl;let c;o.ids=e.ids,o.positions=e.positions;for(const d of o.ids)d!==c&&o.uniqueIds.push(d),c=d;return o.indexed=!0,o}}function Yc(s){const e=+s;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Bd(String(s))}function Ju(s,e,o,c){for(;o<c;){const d=s[o+c>>1];let m=o-1,g=c+1;for(;;){do{m++}while(s[m]<d);do{g--}while(s[g]>d);if(m>=g)break;_m(s,m,g),_m(e,3*m,3*g),_m(e,3*m+1,3*g+1),_m(e,3*m+2,3*g+2)}g-o<c-g?(Ju(s,e,o,g),o=g+1):(Ju(s,e,g+1,c),c=g)}}function _m(s,e,o){const c=s[e];s[e]=s[o],s[o]=c}wt(sl,"FeaturePositionMap");class Ns{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,o){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,o),this.initialized=!0),!!this.location}set(e,o,c){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class ph extends Ns{constructor(e){super(e),this.current=0}set(e,o,c){this.fetchUniformLocation(e,o)&&this.current!==c&&(this.current=c,this.gl.uniform1i(this.location,c))}}class pr extends Ns{constructor(e){super(e),this.current=0}set(e,o,c){this.fetchUniformLocation(e,o)&&this.current!==c&&(this.current=c,this.gl.uniform1f(this.location,c))}}class ro extends Ns{constructor(e){super(e),this.current=[0,0]}set(e,o,c){this.fetchUniformLocation(e,o)&&(c[0]===this.current[0]&&c[1]===this.current[1]||(this.current=c,this.gl.uniform2f(this.location,c[0],c[1])))}}class ed extends Ns{constructor(e){super(e),this.current=[0,0,0]}set(e,o,c){this.fetchUniformLocation(e,o)&&(c[0]===this.current[0]&&c[1]===this.current[1]&&c[2]===this.current[2]||(this.current=c,this.gl.uniform3f(this.location,c[0],c[1],c[2])))}}class tc extends Ns{constructor(e){super(e),this.current=[0,0,0,0]}set(e,o,c){this.fetchUniformLocation(e,o)&&(c[0]===this.current[0]&&c[1]===this.current[1]&&c[2]===this.current[2]&&c[3]===this.current[3]||(this.current=c,this.gl.uniform4f(this.location,c[0],c[1],c[2],c[3])))}}class mh extends Ns{constructor(e){super(e),this.current=Yn.transparent.toPremultipliedRenderColor(null)}set(e,o,c){this.fetchUniformLocation(e,o)&&(c.r===this.current.r&&c.g===this.current.g&&c.b===this.current.b&&c.a===this.current.a||(this.current=c,this.gl.uniform4f(this.location,c.r,c.g,c.b,c.a)))}}const ym=new Float32Array(16);class nc extends Ns{constructor(e){super(e),this.current=ym}set(e,o,c){if(this.fetchUniformLocation(e,o)){if(c[12]!==this.current[12]||c[0]!==this.current[0])return this.current=c,void this.gl.uniformMatrix4fv(this.location,!1,c);for(let d=1;d<16;d++)if(c[d]!==this.current[d]){this.current=c,this.gl.uniformMatrix4fv(this.location,!1,c);break}}}}const vm=new Float32Array(9),l_=new Float32Array(4);class Vf extends Ns{constructor(e){super(e),this.current=l_}set(e,o,c){if(this.fetchUniformLocation(e,o))for(let d=0;d<4;d++)if(c[d]!==this.current[d]){this.current=c,this.gl.uniformMatrix2fv(this.location,!1,c);break}}}function jf(s){return[xv(255*s.r,255*s.g),xv(255*s.b,255*s.a)]}class td{constructor(e,o,c,d){this.value=e,this.uniformNames=o.map(m=>`u_${m}`),this.type=c,this.context=d}setUniform(e,o,c,d,m){const g=d.constantOr(this.value);o.set(e,m,g instanceof Yn?g.toPremultipliedRenderColor(this.lutExpression&&"none"===this.lutExpression.value?null:this.context.lut):g)}getBinding(e,o){return"color"===this.type?new mh(e):new pr(e)}}class Kc{constructor(e,o){this.uniformNames=o.map(c=>`u_${c}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,o){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=o?o.tl.concat(o.br):this.pattern}setUniform(e,o,c,d,m){let g=null;"u_pattern"!==m&&"u_dash"!==m||(g=this.pattern),"u_pattern_b"===m&&(g=this.patternTransition),"u_pixel_ratio"===m&&(g=this.pixelRatio),g&&o.set(e,m,g)}getBinding(e,o){return"u_pattern"===o||"u_pattern_b"===o||"u_dash"===o?new tc(e):new pr(e)}}class al{constructor(e,o,c,d){this.expression=e,this.type=c,this.maxValue=0,this.paintVertexAttributes=o.map(m=>({name:`a_${m}`,type:"Float32",components:"color"===c?2:1,offset:0})),this.paintVertexArray=new d}populatePaintArray(e,o,c,d,m,g,x,w){const T=this.paintVertexArray.length,C="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Tn(0,{brightness:g,worldview:w}),o,{},m,d,x):"constant"===this.expression.kind&&this.expression.value,A=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Tn(0,{brightness:g,worldview:w}),o,{},m,d,x):this.lutExpression.value);this.paintVertexArray.resize(e),this._setPaintValue(T,e,C,A?null:this.context.lut)}updatePaintArray(e,o,c,d,m,g,x,w){const T="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:x,worldview:w},c,d,void 0,m):"constant"===this.expression.kind&&this.expression.value,C=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Tn(0,{brightness:x,worldview:w}),c,d,void 0,m):this.lutExpression.value);this._setPaintValue(e,o,T,C?null:this.context.lut)}_setPaintValue(e,o,c,d){if("color"===this.type){const m=jf(c.toPremultipliedRenderColor(d));for(let g=e;g<o;g++)this.paintVertexArray.emplace(g,m[0],m[1])}else{for(let m=e;m<o;m++)this.paintVertexArray.emplace(m,c);this.maxValue=Math.max(this.maxValue,Math.abs(c))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ss{constructor(e,o,c,d,m,g){this.expression=e,this.uniformNames=o.map(x=>`u_${x}_t`),this.type=c,this.useIntegerZoom=d,this.context=m,this.maxValue=0,this.paintVertexAttributes=o.map(x=>({name:`a_${x}`,type:"Float32",components:"color"===c?4:2,offset:0})),this.paintVertexArray=new g}populatePaintArray(e,o,c,d,m,g,x,w){const T=this.expression.evaluate(new Tn(this.context.zoom,{brightness:g,worldview:w}),o,{},m,d,x),C=this.expression.evaluate(new Tn(this.context.zoom+1,{brightness:g,worldview:w}),o,{},m,d,x),A=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Tn(0,{brightness:g,worldview:w}),o,{},m,d,x):this.lutExpression.value),M=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(M,e,T,C,A?null:this.context.lut)}updatePaintArray(e,o,c,d,m,g,x,w){const T=this.expression.evaluate({zoom:this.context.zoom,brightness:x,worldview:w},c,d,void 0,m),C=this.expression.evaluate({zoom:this.context.zoom+1,brightness:x,worldview:w},c,d,void 0,m),A=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Tn(0,{brightness:x,worldview:w}),c,d,void 0,m):this.lutExpression.value);this._setPaintValue(e,o,T,C,A?null:this.context.lut)}_setPaintValue(e,o,c,d,m){if("color"===this.type){const g=jf(c.toPremultipliedRenderColor(m)),x=jf(c.toPremultipliedRenderColor(m));for(let w=e;w<o;w++)this.paintVertexArray.emplace(w,g[0],g[1],x[0],x[1])}else{for(let g=e;g<o;g++)this.paintVertexArray.emplace(g,c,d);this.maxValue=Math.max(this.maxValue,Math.abs(c),Math.abs(d))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,o,c,d,m){const g=this.useIntegerZoom?Math.floor(c.zoom):c.zoom,x=se(this.expression.interpolationFactor(g,this.context.zoom,this.context.zoom+1),0,1);o.set(e,m,x)}getBinding(e,o){return new pr(e)}}class oo{constructor(e,o,c,d,m){this.expression=e,this.layerId=m,this.paintVertexAttributes=("array"===c?bv:gm).members;for(let g=0;g<o.length;++g);this.paintVertexArray=new d,this.paintTransitionVertexArray=new Zu}populatePaintArray(e,o,c,d){const m=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(m,e,o.patterns&&o.patterns[this.layerId],c)}updatePaintArray(e,o,c,d,m,g,x){this._setPaintValues(e,o,c.patterns&&c.patterns[this.layerId],g)}_setPaintValues(e,o,c,d){if(!d||!c)return;const m=d[c[0]],g=d[c[1]];if(m){if(m){const{tl:x,br:w,pixelRatio:T}=m;for(let C=e;C<o;C++)this.paintVertexArray.emplace(C,x[0],x[1],w[0],w[1],T)}if(g){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:x,br:w}=g;for(let T=e;T<o;T++)this.paintTransitionVertexArray.emplace(T,x[0],x[1],w[0],w[1])}}}upload(e){const o=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,o)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Xc.members,o))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Uo{constructor(e,o,c=(()=>!0)){this.binders={},this._buffers=[],this.context=o;const d=[];for(const m in e.paint._values){const g=e.paint.get(m);if(m.endsWith("-use-theme")||!c(m)||!(g instanceof jc&&ju(g.property.specification)))continue;const x=gh(m,e.type),w=g.value,T=g.property.specification.type,C=!!g.property.useIntegerZoom,A="line-dasharray"===m||m.endsWith("pattern"),M=e.paint.get(`${m}-use-theme`),k="line-dasharray"===m&&"constant"!==e.layout.get("line-cap").value.kind||M&&"constant"!==M.value.kind;if("constant"!==w.kind||k)if("source"===w.kind||k||A){const F=u_(m,T,"source");this.binders[m]=A?new oo(w,x,T,F,e.id):new al(w,x,T,F),d.push(`/a_${m}`)}else{const F=u_(m,T,"composite");this.binders[m]=new ss(w,x,T,C,o,F),d.push(`/z_${m}`)}else this.binders[m]=A?new Kc(w.value,x):new td(w.value,x,T,o),d.push(`/u_${m}`);M&&(this.binders[m].lutExpression=M.value)}this.cacheKey=d.sort().join("")}getMaxValue(e){const o=this.binders[e];return o instanceof al||o instanceof ss?o.maxValue:0}populatePaintArrays(e,o,c,d,m,g,x,w){for(const T in this.binders){const C=this.binders[T];C.context=this.context,(C instanceof al||C instanceof ss||C instanceof oo)&&C.populatePaintArray(e,o,c,d,m,g,x,w)}}setConstantPatternPositions(e,o){for(const c in this.binders){const d=this.binders[c];d instanceof Kc&&d.setConstantPatternPositions(e,o)}}getPatternTransitionVertexBuffer(e){const o=this.binders[e];return o instanceof oo?o.paintTransitionVertexBuffer:null}updatePaintArrays(e,o,c,d,m,g,x,w,T,C){let A=!1;const M=Object.keys(e),k=0!==M.length&&!w,F=k?M:o.uniqueIds;this.context.lut=m.lut;for(const V in this.binders){const j=this.binders[V];if(j.context=this.context,(j instanceof al||j instanceof ss||j instanceof oo)&&j.expression&&j.expression.kind&&"constant"!==j.expression.kind&&(!0===j.expression.isStateDependent||!1===j.expression.isLightConstant)){const W=m.paint.get(V);j.expression=W.value;for(const Q of F){const K=e[Q.toString()];o.eachPosition(Q,(te,me,he)=>{const fe=d.feature(te);j.updatePaintArray(me,he,fe,K,g,x,T,C)})}if(!k)for(const Q of c.uniqueIds){const K=e[Q.toString()];c.eachPosition(Q,(te,me,he)=>{const fe=d.feature(te);j.updatePaintArray(me,he,fe,K,g,x,T,C)})}A=!0}}return A}defines(){const e=[];for(const o in this.binders){const c=this.binders[o];(c instanceof td||c instanceof Kc)&&e.push(...c.uniformNames.map(d=>`#define HAS_UNIFORM_${d}`))}return e}getBinderAttributes(){const e=[];for(const o in this.binders){const c=this.binders[o];if(c instanceof al||c instanceof ss||c instanceof oo)for(let d=0;d<c.paintVertexAttributes.length;d++)e.push(c.paintVertexAttributes[d].name);if(c instanceof oo)for(let d=0;d<Xc.members.length;d++)e.push(Xc.members[d].name)}return e}getBinderUniforms(){const e=[];for(const o in this.binders){const c=this.binders[o];if(c instanceof td||c instanceof Kc||c instanceof ss)for(const d of c.uniformNames)e.push(d)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const o=[];for(const c in this.binders){const d=this.binders[c];if(d instanceof td||d instanceof Kc||d instanceof ss)for(const m of d.uniformNames)o.push({name:m,property:c,binding:d.getBinding(e,m)})}return o}setUniforms(e,o,c,d,m){for(const{name:g,property:x,binding:w}of c)this.binders[x].setUniform(e,w,m,d.get(x),g)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const o=this.binders[e];(o instanceof al||o instanceof ss||o instanceof oo)&&o.paintVertexBuffer&&this._buffers.push(o.paintVertexBuffer),o instanceof oo&&o.paintTransitionVertexBuffer&&this._buffers.push(o.paintTransitionVertexBuffer)}}upload(e){for(const o in this.binders){const c=this.binders[o];(c instanceof al||c instanceof ss||c instanceof oo)&&c.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const o=this.binders[e];(o instanceof al||o instanceof ss||o instanceof oo)&&o.destroy()}}}class ws{constructor(e,o,c=(()=>!0)){this.programConfigurations={};for(const d of e)this.programConfigurations[d.id]=new Uo(d,o,c);this.needsUpload=!1,this._featureMap=new sl,this._featureMapWithoutIds=new sl,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,o,c,d,m,g,x,w,T){for(const C in this.programConfigurations)this.programConfigurations[C].populatePaintArrays(e,o,d,m,g,x,w,T);void 0!==o.id?this._featureMap.add(o.id,c,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,c,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,o,c,d,m,g,x,w){for(const T of c)this.needsUpload=this.programConfigurations[T.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,o,T,d,m,g,x||0,w)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const o in this.programConfigurations)this.programConfigurations[o].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const c_={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function gh(s,e){return c_[s]||[s.replace(`${e}-`,"").replace(/-/g,"_")]}const wv={"line-pattern":{source:Kl,composite:Kl},"fill-pattern":{source:Kl,composite:Kl},"fill-extrusion-pattern":{source:Kl,composite:Kl},"line-dasharray":{source:Zu,composite:Zu}},as={color:{source:Jl,composite:Ra},number:{source:os,composite:Jl}};function u_(s,e,o){const c=wv[s];return c&&c[o]||as[e][o]}wt(td,"ConstantBinder"),wt(Kc,"PatternConstantBinder"),wt(al,"SourceExpressionBinder"),wt(oo,"PatternCompositeBinder"),wt(ss,"CompositeExpressionBinder"),wt(Uo,"ProgramConfiguration",{omit:["_buffers"]}),wt(ws,"ProgramConfigurationSet");const Po=ht/Math.PI/2,Uf=5,f=6,r=16383,l=64,p=[l,32,16],_=-Po,v=Po;function b(s,e,o,c=Po){return o=Pn(o),[s*Math.sin(o)*c,-e*c,s*Math.cos(o)*c]}function S(s,e,o){return b(Math.cos(Pn(s)),Math.sin(Pn(s)),e,o)}const I=6371008.8,P=2*Math.PI*I;class R{constructor(e,o){if(isNaN(e)||isNaN(o))throw new Error(`Invalid LngLat object: (${e}, ${o})`);if(this.lng=+e,this.lat=+o,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new R(ke(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const o=Math.PI/180,c=this.lat*o,d=e.lat*o,m=Math.sin(c)*Math.sin(d)+Math.cos(c)*Math.cos(d)*Math.cos((e.lng-this.lng)*o);return I*Math.acos(Math.min(m,1))}toBounds(e=0){const o=360*e/40075017,c=o/Math.cos(Math.PI/180*this.lat);return new z({lng:this.lng-c,lat:this.lat-o},{lng:this.lng+c,lat:this.lat+o})}toEcef(e){return S(this.lat,this.lng,Po+e*Po/I)}static convert(e){if(e instanceof R)return e;if(Array.isArray(e)&&(2===e.length||3===e.length))return new R(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&"object"==typeof e&&null!==e)return new R(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class z{constructor(e,o){if(e)if(o)this.setSouthWest(e).setNorthEast(o);else if(4===e.length){const c=e;this.setSouthWest([c[0],c[1]]).setNorthEast([c[2],c[3]])}else{const c=e;this.setSouthWest(c[0]).setNorthEast(c[1])}}setNorthEast(e){return this._ne=e instanceof R?new R(e.lng,e.lat):R.convert(e),this}setSouthWest(e){return this._sw=e instanceof R?new R(e.lng,e.lat):R.convert(e),this}extend(e){const o=this._sw,c=this._ne;let d,m;if(e instanceof R)d=e,m=e;else{if(!(e instanceof z))return Array.isArray(e)?4===e.length||e.every(Array.isArray)?this.extend(z.convert(e)):this.extend(R.convert(e)):"object"==typeof e&&null!==e&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(R.convert(e)):this;if(d=e._sw,m=e._ne,!d||!m)return this}return o||c?(o.lng=Math.min(d.lng,o.lng),o.lat=Math.min(d.lat,o.lat),c.lng=Math.max(m.lng,c.lng),c.lat=Math.max(m.lat,c.lat)):(this._sw=new R(d.lng,d.lat),this._ne=new R(m.lng,m.lat)),this}getCenter(){return new R((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new R(this.getWest(),this.getNorth())}getSouthEast(){return new R(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:o,lat:c}=R.convert(e);let d=this._sw.lng<=o&&o<=this._ne.lng;return this._sw.lng>this._ne.lng&&(d=this._sw.lng>=o&&o>=this._ne.lng),this._sw.lat<=c&&c<=this._ne.lat&&d}static convert(e){if(e)return e instanceof z?e:new z(e)}}const L=0,B=25.5;function H(s){return P*Math.cos(s*Math.PI/180)}function U(s){return(180+s)/360}function q(s){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+s*Math.PI/360)))/360}function G(s,e){return s/H(e)}function Y(s){return 360*s-180}function ee(s){return 360/Math.PI*Math.atan(Math.exp((180-360*s)*Math.PI/180))-90}function ne(s,e){return s*H(ee(e))}const le=85.051129;function de(s){return Math.cos(Pn(se(s,-le,le)))}function pe(s,e){const o=se(e,L,B),c=Math.pow(2,o);return de(s)*P/(512*c)}function ae(s){return 1/Math.cos(s*Math.PI/180)}function ce(s,e=0){const o=Math.exp(Math.PI*(1-(s.y+e/ht)/(1<<s.z)*2));return 80150034*o/(o*o+1)/ht/(1<<s.z)}class ue{constructor(e,o,c=0){this.x=+e,this.y=+o,this.z=+c}static fromLngLat(e,o=0){const c=R.convert(e);return new ue(U(c.lng),q(c.lat),G(o,c.lat))}toLngLat(){return new R(Y(this.x),ee(this.y))}toAltitude(){return ne(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/P*ae(ee(this.y))}}function Me(s,e,o,c,d,m,g,x,w){const T=(e+c)/2,C=(o+d)/2,A=new Je(T,C);x(A),function(M,k,F,V,j,W){const Q=F-j,K=V-W;return Math.abs((V-k)*Q-(F-M)*K)/Math.hypot(Q,K)}(A.x,A.y,m.x,m.y,g.x,g.y)>=w?(Me(s,e,o,T,C,m,A,x,w),Me(s,T,C,c,d,A,g,x,w)):s.push(g)}function ye(s,e,o){let c=s[0],d=c.x,m=c.y;e(c);const g=[c];for(let x=1;x<s.length;x++){const w=s[x],{x:T,y:C}=w;e(w),Me(g,d,m,T,C,c,w,e,o),d=T,m=C,c=w}return g}function je(s,e,o,c){if(c(e,o)){const d=e.add(o)._mult(.5);je(s,e,d,c),je(s,d,o,c)}else s.push(o)}function Le(s,e){let o=s[0];const c=[o];for(let d=1;d<s.length;d++){const m=s[d];je(c,o,m,e),o=m}return c}const Ge=Math.pow(2,14)-1,rt=-Ge-1;function Se(s,e){const o=Math.round(s.x*e),c=Math.round(s.y*e);return s.x=se(o,rt,Ge),s.y=se(c,rt,Ge),(o<s.x||o>s.x+1||c<s.y||c>s.y+1)&&yn("Geometry exceeds allowed extent, reduce your vector tile buffer size"),s}function _e(s,e,o){const c=s.loadGeometry(),d=s.extent,m=ht/d;if(e&&o&&o.projection.isReprojectedInTileSpace){const g=1<<e.z,{scale:x,x:w,y:T,projection:C}=o,A=M=>{const k=Y((e.x+M.x/d)/g),F=ee((e.y+M.y/d)/g),V=C.project(k,F);M.x=(V.x*x-w)*d,M.y=(V.y*x-T)*d};for(let M=0;M<c.length;M++)if(1!==s.type)c[M]=ye(c[M],A,1);else{const k=[];for(const F of c[M])F.x<0||F.x>=d||F.y<0||F.y>=d||(A(F),k.push(F));c[M]=k}}for(const g of c)for(const x of g)Se(x,m);return c}function ze(s,e){return{type:s.type,id:s.id,properties:s.properties,geometry:e?_e(s):[]}}class Re{constructor(e,o,c,d,m){this.properties={},this.extent=c,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=d,this._values=m,e.readFields(We,this,o)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const o=e.readVarint()+e.pos,c=[];let d,m=1,g=0,x=0,w=0;for(;e.pos<o;){if(g<=0){const T=e.readVarint();m=7&T,g=T>>3}if(g--,1===m||2===m)x+=e.readSVarint(),w+=e.readSVarint(),1===m&&(d&&c.push(d),d=[]),d&&d.push(new Je(x,w));else{if(7!==m)throw new Error(`unknown command ${m}`);d&&d.push(d[0].clone())}}return d&&c.push(d),c}bbox(){const e=this._pbf;e.pos=this._geometry;const o=e.readVarint()+e.pos;let c=1,d=0,m=0,g=0,x=1/0,w=-1/0,T=1/0,C=-1/0;for(;e.pos<o;){if(d<=0){const A=e.readVarint();c=7&A,d=A>>3}if(d--,1===c||2===c)m+=e.readSVarint(),g+=e.readSVarint(),m<x&&(x=m),m>w&&(w=m),g<T&&(T=g),g>C&&(C=g);else if(7!==c)throw new Error(`unknown command ${c}`)}return[x,T,w,C]}toGeoJSON(e,o,c){const d=this.extent*Math.pow(2,c),m=this.extent*e,g=this.extent*o,x=this.loadGeometry();function w(M){return[360*(M.x+m)/d-180,360/Math.PI*Math.atan(Math.exp((1-2*(M.y+g)/d)*Math.PI))-90]}function T(M){return M.map(w)}let C;if(1===this.type){const M=[];for(const F of x)M.push(F[0]);const k=T(M);C=1===M.length?{type:"Point",coordinates:k[0]}:{type:"MultiPoint",coordinates:k}}else if(2===this.type){const M=x.map(T);C=1===M.length?{type:"LineString",coordinates:M[0]}:{type:"MultiLineString",coordinates:M}}else{if(3!==this.type)throw new Error("unknown feature type");{const M=function(F){const V=F.length;if(V<=1)return[F];const j=[];let W,Q;for(let K=0;K<V;K++){const te=Ze(F[K]);0!==te&&(void 0===Q&&(Q=te<0),Q===te<0?(W&&j.push(W),W=[F[K]]):W&&W.push(F[K]))}return W&&j.push(W),j}(x),k=[];for(const F of M)k.push(F.map(T));C=1===k.length?{type:"Polygon",coordinates:k[0]}:{type:"MultiPolygon",coordinates:k}}}const A={type:"Feature",geometry:C,properties:this.properties};return null!=this.id&&(A.id=this.id),A}}function We(s,e,o){1===s?e.id=o.readVarint():2===s?function(c,d){const m=c.readVarint()+c.pos;for(;c.pos<m;){const g=d._keys[c.readVarint()],x=d._values[c.readVarint()];d.properties[g]=x}}(o,e):3===s?e.type=o.readVarint():4===s&&(e._geometry=o.pos)}function Ze(s){let e=0;for(let o,c,d=0,m=s.length,g=m-1;d<m;g=d++)o=s[d],c=s[g],e+=(c.x-o.x)*(o.y+c.y);return e}Re.types=["Unknown","Point","LineString","Polygon"];class Ye{constructor(e,o){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(ct,this,o),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const o=this._pbf.readVarint()+this._pbf.pos;return new Re(this._pbf,o,this.extent,this._keys,this._values)}}function ct(s,e,o){15===s?e.version=o.readVarint():1===s?e.name=o.readString():5===s?e.extent=o.readVarint():2===s?e._features.push(o.pos):3===s?e._keys.push(o.readString()):4===s&&e._values.push(function(c){let d=null;const m=c.readVarint()+c.pos;for(;c.pos<m;){const g=c.readVarint()>>3;d=1===g?c.readString():2===g?c.readFloat():3===g?c.readDouble():4===g?c.readVarint64():5===g?c.readVarint():6===g?c.readSVarint():7===g?c.readBoolean():null}if(null==d)throw new Error("unknown feature value");return d}(o))}class Ct{constructor(e,o){this.layers=e.readFields(Lt,{},o)}}function Lt(s,e,o){if(3===s){const c=new Ye(o,o.readVarint()+o.pos);c.length&&(e[c.name]=c)}}const vt="3d_elevation_id";class At{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry(e,o){return this._valid&&e(o(this._geometry)),this}require(e,o,c){return this.get(e,!0,o,c)}optional(e,o,c){return this.get(e,!1,o,c)}success(){return this._valid}get(e,o,c,d){const m=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&void 0!==m&&!Number.isNaN(m)?c(d?d(m):m):o&&(this._valid=!1),this}}class qt{constructor(e,o){this.featureFunc=e,this.vertexFunc=o}parseFeature(e,o,c){return this.featureFunc(e,o,c)}parseVertex(e,o,c){return this.vertexFunc(e,o,c)}}const Kt=new qt((s,e,o)=>s.reset(e).require(vt,c=>{o.id=c}).optional("fixed_height_relative",c=>{o.constantHeight=c},Dn.decodeRelativeHeight).geometry(c=>{o.bounds=c},ff).success(),(s,e,o)=>s.reset(e).require(vt,c=>{o.id=c}).require("elevation_idx",c=>{o.idx=c}).require("extent",c=>{o.extent=c}).require("height_relative",c=>{o.height=c},Dn.decodeRelativeHeight).geometry(c=>{o.position=c},Dn.getPoint).success()),mn=new qt((s,e,o)=>s.reset(e).require(vt,c=>{o.id=c}).optional("fixed_height",c=>{o.constantHeight=c},Dn.decodeMetricHeight).geometry(c=>{o.bounds=c},ff).success(),(s,e,o)=>s.reset(e).require(vt,c=>{o.id=c}).require("elevation_idx",c=>{o.idx=c}).require("extent",c=>{o.extent=c}).require("height",c=>{o.height=c},Dn.decodeMetricHeight).geometry(c=>{o.position=c},Dn.getPoint).success());class Dn{static getPoint(e){return Gr(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){const o=[],c=[],d=e.length,m=new At;for(let x=0;x<d;x++){const w=e.feature(x),T=w.properties.version,C=(g=T)?"1.0.1"===g?mn:void 0:Kt;if(void 0===C){yn(`Unknown elevation feature version number ${T||"(unknown)"}`);continue}const A=w.properties.hasOwnProperty("type")?w.properties.type:void 0;if(A)if("Point"===Re.types[w.type]&&"curve_point"===A){const M={};C.parseVertex(m,w,M)&&o.push(M)}else if("Polygon"===Re.types[w.type]&&"curve_meta"===A){const M={};C.parseFeature(m,w,M)&&c.push(M)}}var g;return{vertices:o,features:c}}}class Zt{constructor(e,o){this.pos=e,this.dir=o}intersectsPlane(e,o,c){const d=Ti(o,this.dir);if(Math.abs(d)<1e-6)return!1;const m=((e[0]-this.pos[0])*o[0]+(e[1]-this.pos[1])*o[1])/d;return c[0]=this.pos[0]+this.dir[0]*m,c[1]=this.pos[1]+this.dir[1]*m,!0}}class An{constructor(e,o){this.pos=e,this.dir=o}intersectsPlane(e,o,c){const d=ir(o,this.dir);if(Math.abs(d)<1e-6)return!1;const m=((e[0]-this.pos[0])*o[0]+(e[1]-this.pos[1])*o[1]+(e[2]-this.pos[2])*o[2])/d;return c[0]=this.pos[0]+this.dir[0]*m,c[1]=this.pos[1]+this.dir[1]*m,c[2]=this.pos[2]+this.dir[2]*m,!0}closestPointOnSphere(e,o,c){if(V=(k=this.pos)[0],j=k[1],W=k[2],Q=(F=e)[0],K=F[1],te=F[2],Math.abs(V-Q)<=Ki*Math.max(1,Math.abs(V),Math.abs(Q))&&Math.abs(j-K)<=Ki*Math.max(1,Math.abs(j),Math.abs(K))&&Math.abs(W-te)<=Ki*Math.max(1,Math.abs(W),Math.abs(te))||0===o)return c[0]=c[1]=c[2]=0,!1;var k,F,V,j,W,Q,K,te;const[d,m,g]=this.dir,x=this.pos[0]-e[0],w=this.pos[1]-e[1],T=this.pos[2]-e[2],C=d*d+m*m+g*g,A=2*(x*d+w*m+T*g),M=A*A-4*C*(x*x+w*w+T*T-o*o);if(M<0){const k=Math.max(-A/2,0),F=x+d*k,V=w+m*k,j=T+g*k,W=Math.hypot(F,V,j);return c[0]=F*o/W,c[1]=V*o/W,c[2]=j*o/W,!1}{const k=(-A-Math.sqrt(M))/(2*C);if(k<0){const F=Math.hypot(x,w,T);return c[0]=x*o/F,c[1]=w*o/F,c[2]=T*o/F,!1}return c[0]=x+d*k,c[1]=w+m*k,c[2]=T+g*k,!0}}}class Ln{constructor(e,o,c,d,m){this.TL=e,this.TR=o,this.BR=c,this.BL=d,this.horizon=m}static fromInvProjectionMatrix(e,o,c){const d=[-1,1,1],m=[1,1,1],g=[1,-1,1],x=[-1,-1,1],w=rr(d,d,e),T=rr(m,m,e),C=rr(g,g,e),A=rr(x,x,e);return new Ln(w,T,C,A,o/c)}}function ei(s,e,o){let c=1/0,d=-1/0;const m=[];for(const g of s){or(m,g,e);const x=ir(m,o);c=Math.min(c,x),d=Math.max(d,x)}return[c,d]}function un(s,e){let o=!0;for(let c=0;c<s.planes.length;c++){const d=s.planes[c];let m=0;for(let g=0;g<e.length;g++)m+=ir(d,e[g])+d[3]>=0;if(0===m)return 0;m!==e.length&&(o=!1)}return o?2:1}function kn(s,e){for(const o of s.projections){const c=ei(e,s.points[0],o.axis);if(o.projection[1]<c[0]||o.projection[0]>c[1])return 0}return 1}function zn(s,e){let o=0;const c=[0,0,0,0];for(let g=0;g<s.length;g++)c[0]=s[g][0],c[1]=s[g][1],c[2]=s[g][2],c[3]=1,(d=c)[0]*(m=e)[0]+d[1]*m[1]+d[2]*m[2]+d[3]*m[3]>=0&&o++;var d,m;return o}class In{constructor(e,o){this.points=e||new Array(8).fill([0,0,0]),this.planes=o||new Array(6).fill([0,0,0,0]),this.bounds=on.fromPoints(this.points),this.projections=[],this.frustumEdges=[or([],this.points[2],this.points[3]),or([],this.points[0],this.points[3]),or([],this.points[4],this.points[0]),or([],this.points[5],this.points[1]),or([],this.points[6],this.points[2]),or([],this.points[7],this.points[3])];for(const c of this.frustumEdges){const d=[0,-c[2],c[1]],m=[c[2],0,-c[0]];this.projections.push({axis:d,projection:ei(this.points,this.points[0],d)}),this.projections.push({axis:m,projection:ei(this.points,this.points[0],m)})}}static fromInvProjectionMatrix(e,o,c,d){const m=Math.pow(2,c),g=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(T=>{const C=ms([],T,e),A=1/C[3]/o*m;return(M=C)[0]=(k=C)[0]*(F=[A,A,d?1/C[3]:A,A])[0],M[1]=k[1]*F[1],M[2]=k[2]*F[2],M[3]=k[3]*F[3],M;var M,k,F}),x=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(T=>{const C=Ai([],yi([],or([],g[T[0]],g[T[1]]),or([],g[T[2]],g[T[1]]))),A=-ir(C,g[T[1]]);return C.concat(A)}),w=[];for(let T=0;T<g.length;T++)w.push([g[T][0],g[T][1],g[T][2]]);return new In(w,x)}intersectsPrecise(e,o,c){for(let d=0;d<o.length;d++)if(!zn(e,o[d]))return 0;for(let d=0;d<this.planes.length;d++)if(!zn(e,this.planes[d]))return 0;for(const d of c)for(const m of this.frustumEdges){const g=yi([],d,m),x=uo(g);if(0===x)continue;Li(g,g,1/x);const w=ei(this.points,this.points[0],g),T=ei(e,this.points[0],g);if(w[0]>T[1]||T[0]>w[1])return 0}return 1}containsPoint(e){for(const o of this.planes){const c=o[3];if(ir([o[0],o[1],o[2]],e)+c<0)return!1}return!0}}class on{static fromPoints(e){const o=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(const d of e)wa(o,o,d),qi(c,c,d);return new on(o,c)}static fromTileIdAndHeight(e,o,c){const d=1<<e.canonical.z,m=e.canonical.x,g=e.canonical.y;return new on([m/d,g/d,o],[(m+1)/d,(g+1)/d,c])}static applyTransform(e,o){const c=e.getCorners();for(let d=0;d<c.length;++d)rr(c[d],c[d],o);return on.fromPoints(c)}static applyTransformFast(e,o){const c=[o[12],o[13],o[14]],d=[...c];for(let m=0;m<3;m++)for(let g=0;g<3;g++){const x=o[4*g+m],w=x*e.min[g],T=x*e.max[g];c[m]+=Math.min(w,T),d[m]+=Math.max(w,T)}return new on(c,d)}static projectAabbCorners(e,o){const c=e.getCorners();for(let d=0;d<c.length;++d)rr(c[d],c[d],o);return c}constructor(e,o){this.min=e,this.max=o,this.center=Li([],Oi([],this.min,this.max),.5)}quadrant(e){const o=[e%2==0,e<2],c=za(this.min),d=za(this.max);for(let m=0;m<o.length;m++)c[m]=o[m]?this.min[m]:this.center[m],d[m]=o[m]?this.center[m]:this.max[m];return d[2]=this.max[2],new on(c,d)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,o=this.max;return[[e[0],e[1],e[2]],[o[0],e[1],e[2]],[o[0],o[1],e[2]],[e[0],o[1],e[2]],[e[0],e[1],o[2]],[o[0],e[1],o[2]],[o[0],o[1],o[2]],[e[0],o[1],o[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?un(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?un(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,o){return o||this.intersects(e)?kn(e,this.getCorners()):0}intersectsPreciseFlat(e,o){return o||this.intersectsFlat(e)?kn(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let o=0;o<3;++o)if(this.min[o]>e.max[o]||e.min[o]>this.max[o])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let o=0;o<3;o++)this.min[o]=Math.min(this.min[o],e.min[o]),this.max[o]=Math.max(this.max[o],e.max[o])}encapsulatePoint(e){for(let o=0;o<3;o++)this.min[o]=Math.min(this.min[o],e[o]),this.max[o]=Math.max(this.max[o],e[o])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}wt(on,"Aabb");class ti{constructor(e,o){this.feature=e,this.metersToTile=o,this.index=0}get(){const e=this.feature.vertices[this.index],o=this.feature.vertexProps[this.index].dir,c=o[1],d=-o[0],m=(e.extent+1)*this.metersToTile;return[new Je(Math.trunc(e.position[0]+c*m),Math.trunc(e.position[1]+d*m)),new Je(Math.trunc(e.position[0]-c*m),Math.trunc(e.position[1]-d*m))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Gn{constructor(e,o,c,d,m,g){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:c,max:c},this.safeArea=o,this.constantHeight=c,null==this.constantHeight&&(null!=this.constantHeight||0!==d.length)){this.vertices=d,this.edges=m,this.edges=this.edges.filter(x=>{return x.a<this.vertices.length&&x.b<this.vertices.length&&!((w=this.vertices[x.a].position)[0]===(T=this.vertices[x.b].position)[0]&&w[1]===T[1]);var w,T}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const x of this.vertices)this.vertexProps.push({dir:Gr(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,x.height),this.heightRange.max=Math.max(this.heightRange.max,x.height);for(const x of this.edges){const w=this.vertices[x.a].position,T=this.vertices[x.b].position,C=Ua(So(),T,w),A=Pl(C),M=Ha(So(),C,1/A);this.edgeProps.push({vec:C,dir:M,len:A});const k=this.vertexProps[x.a].dir,F=this.vertexProps[x.b].dir;ja(k,k,M),ja(F,F,M)}for(const x of this.vertexProps)0===x.dir[0]&&0===x.dir[1]||Eu(x.dir,x.dir);this.tessellate(g)}}pointElevation(e){if(null!=this.constantHeight)return this.constantHeight;const o=this.getClosestEdge(e);if(null==o)return 0;const[c,d]=o;return Ft(this.vertices[this.edges[c].a].height,this.vertices[this.edges[c].b].height,d)}computeSlopeNormal(e,o){const c=this.getClosestEdge(e);if(!c)return dr(0,0,1);const d=c[0],m=this.edges[d],g=this.edgeProps[d].vec,x=dr(g[0],g[1],(this.vertices[m.b].height-this.vertices[m.a].height)*o),w=dr(x[1],-x[0],0);yi(w,w,x);const T=uo(w);return T>0?Li(w,w,1/T):dr(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(0===this.edges.length)return;let o=0,c=Number.POSITIVE_INFINITY,d=0;const m=Gr(e.x,e.y);for(let g=0;g<this.edges.length;g++){const x=this.edges[g],w=this.edgeProps[g].dir,T=new Zt(m,this.edgeProps[g].dir),C=this.vertices[x.a].position,A=this.vertices[x.b].position,M=So(),k=So(),F=T.intersectsPlane(C,this.vertexProps[x.a].dir,M),V=T.intersectsPlane(A,this.vertexProps[x.b].dir,k);if(!F||!V)continue;const j=Ua(So(),k,M),W=Ua(So(),m,M),Q=Ti(j,j),K=Q>0?Ti(W,j)/Q:0,te=se(K,0,1),me=Math.abs((K-te)*this.edgeProps[g].len),he=Ua(So(),m,C),fe=me+Math.abs(Ti(he,Gr(w[1],-w[0])));fe<c&&(o=g,c=fe,d=te)}return[o,d]}tessellate(e){for(let o=this.edges.length-1;o>=0;--o){const c=this.edges[o].a,d=this.edges[o].b,{position:m,height:g,extent:x}=this.vertices[c],{position:w,height:T,extent:C}=this.vertices[d],A=this.vertexProps[c].dir,M=this.vertexProps[d].dir,k=dr(m[0]/e,m[1]/e,g),F=dr(w[0]/e,w[1]/e,T),V=dr(A[1],-A[0],0);Li(V,V,x);const j=dr(M[1],-M[0],0);if(Li(j,j,C),this.distSqLines(dr(k[0]+.5*V[0],k[1]+.5*V[1],k[2]+.5*V[2]),dr(F[0]-.5*j[0],F[1]-.5*j[1],F[2]-.5*j[2]),dr(k[0]-.5*V[0],k[1]-.5*V[1],k[2]-.5*V[2]),dr(F[0]+.5*j[0],F[1]+.5*j[1],F[2]+.5*j[2]))<=.0025000000000000005)continue;const W=this.vertices.length,Q=ja(So(),m,w);this.vertices.push({position:Ha(Q,Q,.5),height:.5*(g+T),extent:.5*(x+C)});const K=ja(So(),A,M);this.vertexProps.push({dir:Eu(K,K)}),this.edges.splice(o,1),this.edgeProps.splice(o,1),this.edges.push({a:c,b:W}),this.edges.push({a:W,b:d});const te=Ua(So(),this.vertices[W].position,m),me=Pl(te),he={vec:te,dir:Ha(So(),te,1/me),len:me};this.edgeProps.push(he),this.edgeProps.push(he)}}distSqLines(e,o,c,d){const m=to(jn(),o,e),g=to(jn(),d,c),x=to(jn(),e,c),w=ir(m,m),T=ir(m,g),C=ir(m,x),A=ir(g,g),M=ir(g,x),k=w*A-T*T;if(0===k){const j=ir(x,g)/ir(g,g);return xu(er(jn(),c,d,j),e)}const F=(T*M-C*A)/k,V=(w*M-T*C)/k;return xu(er(jn(),e,o,F),er(jn(),c,d,V))}}class Fi{static parseFrom(e,o){const c=Dn.parse(e);if(!c)return[];let{vertices:d,features:m}=c;const g=1/ce(o);m.sort((C,A)=>C.id-A.id),d.sort((C,A)=>C.id-A.id||C.idx-A.idx),d=d.filter((C,A,M)=>A===M.findIndex(k=>k.id===C.id&&k.idx===C.idx));const x=new Array;let w=0;const T=d.length;for(const C of m){if(C.constantHeight){x.push(new Gn(C.id,C.bounds,C.constantHeight));continue}for(;w!==T&&d[w].id<C.id;)w++;if(w===T||d[w].id!==C.id)continue;const A=new Array,M=new Array,k=w;for(;w!==T&&d[w].id===C.id;){const F=d[w];if(A.push({position:F.position,height:F.height,extent:F.extent}),w!==k&&d[w-1].idx===F.idx-1){const V=w-k;M.push({a:V-1,b:V})}w++}x.push(new Gn(C.id,C.bounds,void 0,A,M,g))}return x}static getElevationFeature(e,o){if(!o)return;const c=+e.properties[vt];return Number.isNaN(c)?void 0:o.find(d=>d.id===c)}}class Mn{constructor(e,o){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(o)||(this.zScale=Math.pow(2,o.z-e.z),this.xOffset=(e.x*this.zScale-o.x)*ht,this.yOffset=(e.y*this.zScale-o.y)*ht)}constantElevation(e,o){if(null!=e.constantHeight)return this.computeBiasedHeight(e.constantHeight,o)}pointElevation(e,o,c){return this.constantElevation(o,c)??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(o.pointElevation(e),c))}computeBiasedHeight(e,o){return o<=0?e:e+o*be(0,o,e>=0?e:Math.abs(.5*e))}}wt(Gn,"ElevationFeature");class qn{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new xs,this.indexArray=new Mi,this.segments=new Gi,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,"none"!==this.elevationMode&&(this.elevatedLayoutVertexArray=new os),this.worldview=e.worldview}updateFootprints(e,o){}populate(e,o,c,d){const m=this.layers[0],g=[];let x=null;"circle"===m.type&&(x=m.layout.get("circle-sort-key"));for(const{feature:T,id:C,index:A,sourceLayerIndex:M}of e){const k=this.layers[0]._featureFilter.needGeometry,F=ze(T,k);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),F,c))continue;const V=x?x.evaluate(F,{},c):void 0,j={id:C,properties:T.properties,type:T.type,sourceLayerIndex:M,index:A,geometry:k?F.geometry:_e(T,c,d),patterns:{},sortKey:V};g.push(j)}x&&g.sort((T,C)=>T.sortKey-C.sortKey);let w=null;"globe"===d.projection.name&&(this.globeExtVertexArray=new Xu,w=d.projection);for(const T of g){const{geometry:C,index:A,sourceLayerIndex:M}=T,k=e[A].feature;this.addFeature(T,C,A,o.availableImages,c,w,o.brightness,o.elevationFeatures),o.featureIndex.insert(k,C,A,M,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,o,c,d,m,g,x){this.programConfigurations.updatePaintArrays(e,o,m,c,d,g,x,this.worldview)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,_v.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,vv.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,yv.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,o,c,d,m,g,x,w){let T;"none"!==this.elevationMode&&(T=Fi.getElevationFeature(e,w));for(const C of o)for(const A of C){const M=A.x,k=A.y;if(M<0||M>=ht||k<0||k>=ht)continue;if(g){const j=g.projectTilePoint(M,k,m),W=g.upVector(m,M,k);this.addGlobeExtVertex(j,W),this.addGlobeExtVertex(j,W),this.addGlobeExtVertex(j,W),this.addGlobeExtVertex(j,W)}const F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),V=F.vertexLength;if(this.addCircleVertex(M,k,-1,-1),this.addCircleVertex(M,k,1,-1),this.addCircleVertex(M,k,1,1),this.addCircleVertex(M,k,-1,1),"none"!==this.elevationMode){const j=T?T.pointElevation(new Je(M,k)):0;this.hasElevation=this.hasElevation||0!==j;for(let W=0;W<4;W++)this.elevatedLayoutVertexArray.emplaceBack(j)}this.indexArray.emplaceBack(V,V+1,V+2),this.indexArray.emplaceBack(V,V+2,V+3),F.vertexLength+=4,F.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,c,{},d,m,x,void 0,this.worldview)}addCircleVertex(e,o,c,d){this.layoutVertexArray.emplaceBack(2*e+(c+1)/2,2*o+(d+1)/2)}addGlobeExtVertex(e,o){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,16384*o[0],16384*o[1],16384*o[2])}}function ci(s,e){for(let o=0;o<s.length;o++)if(wo(e,s[o]))return!0;for(let o=0;o<e.length;o++)if(wo(s,e[o]))return!0;return!!Vr(s,e)}function mr(s,e,o){return!!wo(s,e)||!!so(e,s,o)}function lr(s,e){if(1===s.length)return Ks(e,s[0]);for(let o=0;o<e.length;o++){const c=e[o];for(let d=0;d<c.length;d++)if(wo(s,c[d]))return!0}for(let o=0;o<s.length;o++)if(Ks(e,s[o]))return!0;for(let o=0;o<e.length;o++)if(Vr(s,e[o]))return!0;return!1}function tr(s,e,o){if(s.length>1){if(Vr(s,e))return!0;for(let c=0;c<e.length;c++)if(so(e[c],s,o))return!0}for(let c=0;c<s.length;c++)if(so(s[c],e,o))return!0;return!1}function Vr(s,e){if(0===s.length||0===e.length)return!1;for(let o=0;o<s.length-1;o++){const c=s[o],d=s[o+1];for(let m=0;m<e.length-1;m++)if(pa(c,d,e[m],e[m+1]))return!0}return!1}function pa(s,e,o,c){return Qi(s,o,c)!==Qi(e,o,c)&&Qi(s,e,o)!==Qi(s,e,c)}function Ro(s,e,o){return(s.x-o.x)*(e.y-o.y)-(s.y-o.y)*(e.x-o.x)}function Bs(s,e,o,c){const d=Ro(s,e,c),m=Ro(s,e,o);if(Math.sign(d)===Math.sign(m))return;const g=Ro(o,c,s),x=g+m-d;return Math.sign(g)!==Math.sign(x)?[g/(g-x),m/(m-d)]:void 0}function so(s,e,o){const c=o*o;if(1===e.length)return s.distSqr(e[0])<c;for(let d=1;d<e.length;d++)if(Ys(s,e[d-1],e[d])<c)return!0;return!1}function Ys(s,e,o){const c=e.distSqr(o);if(0===c)return s.distSqr(e);const d=((s.x-e.x)*(o.x-e.x)+(s.y-e.y)*(o.y-e.y))/c;return s.distSqr(d<0?e:d>1?o:o.sub(e)._mult(d)._add(e))}function Ks(s,e){let o,c,d,m=!1;for(let g=0;g<s.length;g++){o=s[g];for(let x=0,w=o.length-1;x<o.length;w=x++)c=o[x],d=o[w],c.y>e.y!=d.y>e.y&&e.x<(d.x-c.x)*(e.y-c.y)/(d.y-c.y)+c.x&&(m=!m)}return m}function wo(s,e){let o=!1;for(let c=0,d=s.length-1;c<s.length;d=c++){const m=s[c],g=s[d];m.y>e.y!=g.y>e.y&&e.x<(g.x-m.x)*(e.y-m.y)/(g.y-m.y)+m.x&&(o=!o)}return o}function Zi(s,e,o,c,d){for(const g of s)if(e<=g.x&&o<=g.y&&c>=g.x&&d>=g.y)return!0;const m=[new Je(e,o),new Je(e,d),new Je(c,d),new Je(c,o)];if(s.length>2)for(const g of m)if(wo(s,g))return!0;for(let g=0;g<s.length-1;g++)if(Ji(s[g],s[g+1],m))return!0;return!1}function Ji(s,e,o){const c=o[0],d=o[2];if(s.x<c.x&&e.x<c.x||s.x>d.x&&e.x>d.x||s.y<c.y&&e.y<c.y||s.y>d.y&&e.y>d.y)return!1;const m=Qi(s,e,o[0]);return m!==Qi(s,e,o[1])||m!==Qi(s,e,o[2])||m!==Qi(s,e,o[3])}function wi(s,e,o,c,d,m){let g=e.y-s.y,x=s.x-e.x;if(m=m||0){const w=g*g+x*x;if(0===w)return!0;const T=Math.sqrt(w);g/=T,x/=T}return!((o.x-s.x)*g+(o.y-s.y)*x-m<0||(c.x-s.x)*g+(c.y-s.y)*x-m<0||(d.x-s.x)*g+(d.y-s.y)*x-m<0)}function vr(s,e,o,c,d,m,g){return!(wi(s,e,c,d,m,g)||wi(e,o,c,d,m,g)||wi(o,s,c,d,m,g)||wi(c,d,s,e,o,g)||wi(d,m,s,e,o,g)||wi(m,c,s,e,o,g))}function ao(s,e,o){const c=e.paint.get(s).value;return"constant"===c.kind?c.value:o.programConfigurations.get(e.id).getMaxValue(s)}function cr(s){return Math.sqrt(s[0]*s[0]+s[1]*s[1])}function Qs(s,e,o,c,d){if(!e[0]&&!e[1])return s;const m=Je.convert(e)._mult(d);"viewport"===o&&m._rotate(-c);const g=[];for(let x=0;x<s.length;x++)g.push(s[x].sub(m));return g}function nd(s,e,o,c){const d=Je.convert(s)._mult(c);return"viewport"===e&&d._rotate(-o),d}let Qc,id;function ll(s,e,o){var c=2*Math.PI*6378137/256/Math.pow(2,o);return[s*c-2*Math.PI*6378137/2,e*c-2*Math.PI*6378137/2]}wt(qn,"CircleBucket",{omit:["layers"]});class Ho{constructor(e,o,c){this.z=e,this.x=o,this.y=c,this.key=Es(0,e,e,o,c)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const o=this.z-e.z;return 0===e.z||e.z<this.z&&e.x===this.x>>o&&e.y===this.y>>o}url(e,o){const c=(g=this.y,x=this.z,w=ll(256*(m=this.x),256*(g=Math.pow(2,x)-g-1),x),T=ll(256*(m+1),256*(g+1),x),w[0]+","+w[1]+","+T[0]+","+T[1]),d=function(m,g,x){let w,T="";for(let C=m;C>0;C--)w=1<<C-1,T+=(g&w?1:0)+(x&w?2:0);return T}(this.z,this.x,this.y);var m,g,x,w,T;return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===o?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",d).replace("{bbox-epsg-3857}",c)}toString(){return`${this.z}/${this.x}/${this.y}`}}class ma{constructor(e,o){this.wrap=e,this.canonical=o,this.key=Es(e,o.z,o.z,o.x,o.y)}}class Tr{constructor(e,o,c,d,m){this.overscaledZ=e,this.wrap=o,this.canonical=new Ho(c,+d,+m),this.key=0===o&&e===c?this.canonical.key:Es(o,e,c,d,m)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const o=this.canonical.z-e;return e>this.canonical.z?new Tr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Tr(e,this.wrap,e,this.canonical.x>>o,this.canonical.y>>o)}calculateScaledKey(e,o=!0){if(this.overscaledZ===e&&o)return this.key;if(e>this.canonical.z)return Es(this.wrap*+o,e,this.canonical.z,this.canonical.x,this.canonical.y);{const c=this.canonical.z-e;return Es(this.wrap*+o,e,e,this.canonical.x>>c,this.canonical.y>>c)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const o=this.canonical.z-e.canonical.z;return 0===e.overscaledZ||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>o&&e.canonical.y===this.canonical.y>>o}children(e){if(this.overscaledZ>=e)return[new Tr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const o=this.canonical.z+1,c=2*this.canonical.x,d=2*this.canonical.y;return[new Tr(o,this.wrap,o,c,d),new Tr(o,this.wrap,o,c+1,d),new Tr(o,this.wrap,o,c,d+1),new Tr(o,this.wrap,o,c+1,d+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Tr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Tr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new ma(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Es(s,e,o,c,d){const m=1<<Math.min(o,22);let g=m*(d%m)+c%m;return s&&o<22&&(g+=m*m*((s<0?-2*s-1:2*s)%(1<<2*(22-o)))),16*(32*g+o)+(e-o)}const Js=[s=>{let e=s.canonical.x-1,o=s.wrap;return e<0&&(e=(1<<s.canonical.z)-1,o--),new Tr(s.overscaledZ,o,s.canonical.z,e,s.canonical.y)},s=>{let e=s.canonical.x+1,o=s.wrap;return e===1<<s.canonical.z&&(e=0,o++),new Tr(s.overscaledZ,o,s.canonical.z,e,s.canonical.y)},s=>new Tr(s.overscaledZ,s.wrap,s.canonical.z,s.canonical.x,(0===s.canonical.y?1<<s.canonical.z:s.canonical.y)-1),s=>new Tr(s.overscaledZ,s.wrap,s.canonical.z,s.canonical.x,s.canonical.y===(1<<s.canonical.z)-1?0:s.canonical.y+1)];wt(Ho,"CanonicalTileID"),wt(Tr,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Fx=En([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:xm}=Fx,d_=En([{name:"a_pos_3",components:3,type:"Int16"}]);var bm=En([{name:"a_pos",type:"Int16",components:2}]);function cl(s){return s*Po/I}const Uw=[new on([_,_,_],[v,v,v]),new on([_,_,_],[0,0,v]),new on([0,_,_],[v,0,v]),new on([_,0,_],[0,v,v]),new on([0,0,_],[v,v,v])];function zx(s,e,o,c=!0){const d=Li([],s._camera.position,s.worldSize),m=[e,o,1,1];ms(m,m,s.pixelMatrixInverse),Na(m,m,1/m[3]);const g=Ai([],or([],m,d)),x=s.globeMatrix,w=[x[12],x[13],x[14]],T=or([],w,d),C=uo(T),A=Ai([],T),M=s.worldSize/(2*Math.PI),k=ir(A,g),F=Math.asin(M/C);if(F<Math.acos(k)){if(!c)return null;const Ve=[],Ie=[];Li(Ve,g,C/k),Ai(Ie,or(Ie,Ve,T)),Ai(g,Oi(g,T,Li(g,Ie,Math.tan(F)*C)))}const V=[];new An(d,g).closestPointOnSphere(w,M,V);const j=Ai([],Ui(x,0)),W=Ai([],Ui(x,1)),Q=Ai([],Ui(x,2)),K=ir(j,V),te=ir(W,V),me=ir(Q,V),he=Pe(Math.asin(-te/M));let fe=Pe(Math.atan2(K,me));fe=s.center.lng+function(Ve,Ie){const Ue=(Ie-Ve+180)%360-180;return Ue<-180?Ue+360:Ue}(s.center.lng,fe);const xe=U(fe),Ee=se(q(he),0,1);return new ue(xe,Ee)}class Hw{constructor(e,o,c){this.a=or([],e,c),this.b=or([],o,c),this.center=c;const d=Ai([],this.a),m=Ai([],this.b);this.angle=Math.acos(ir(d,m))}}function h_(s,e){if(0===s.angle)return null;let o;return o=0===s.a[e]?1/s.angle*.5*Math.PI:1/s.angle*Math.atan(s.b[e]/s.a[e]/Math.sin(s.angle)-1/Math.tan(s.angle)),o<0||o>1?null:function(c,d,m,g){const x=Math.sin(m);return c*(Math.sin((1-g)*m)/x)+d*(Math.sin(g*m)/x)}(s.a[e],s.b[e],s.angle,se(o,0,1))+s.center[e]}function Oa(s){if(s.z<=1)return Uw[s.z+2*s.y+s.x];const e=Ev(wm(s));return on.fromPoints(e)}function Jc(s,e,o){return Li(s,s,1-o),No(s,s,e,o)}function Nx(s,e,o){for(const c of s)rr(c,c,e),Li(c,c,o)}function Bx(s,e,o,c){const d=e/s.worldSize,m=s.globeMatrix;if(o.z<=1){const Ee=Oa(o).getCorners();return Nx(Ee,m,d),on.fromPoints(Ee)}const g=wm(o,c),x=Ev(g,Po+cl(s._tileCoverLift));Nx(x,m,d);const w=Number.MAX_VALUE,T=[-w,-w,-w],C=[w,w,w];if(g.contains(s.center)){for(const Ie of x)wa(C,C,Ie),qi(T,T,Ie);T[2]=0;const Ee=s.point,Ve=[Ee.x*d,Ee.y*d,0];return wa(C,C,Ve),qi(T,T,Ve),new on(C,T)}if(s._tileCoverLift>0){for(const Ee of x)wa(C,C,Ee),qi(T,T,Ee);return new on(C,T)}const A=[m[12]*d,m[13]*d,m[14]*d],M=g.getCenter(),k=se(s.center.lat,-le,le),F=se(M.lat,-le,le),V=U(s.center.lng),j=q(k);let W=V-U(M.lng);const Q=j-q(F);W>.5?W-=1:W<-.5&&(W+=1);let K=0;Math.abs(W)>Math.abs(Q)?K=W>=0?1:3:(K=Q>=0?0:2,No(A,A,[m[4]*d,m[5]*d,m[6]*d],-Math.sin(Pn(Q>=0?g.getSouth():g.getNorth()))*Po));const te=x[K],me=x[(K+1)%4],he=new Hw(te,me,A),fe=[h_(he,0)||te[0],h_(he,1)||te[1],h_(he,2)||te[2]],xe=eu(s.zoom);if(xe>0){const Ee=function({x:Ie,y:Ue,z:ot},$e,Ke,nt,Ne){const Qe=1/(1<<ot);let Ce=Ie*Qe,Be=Ce+Qe,at=Ue*Qe,et=at+Qe,Ot=0;const Tt=(Ce+Be)/2-nt;return Tt>.5?Ot=-1:Tt<-.5&&(Ot=1),Ce=((Ce+Ot)*$e-(nt*=$e))*Ke+nt,Be=((Be+Ot)*$e-nt)*Ke+nt,at=(at*$e-(Ne*=$e))*Ke+Ne,et=(et*$e-Ne)*Ke+Ne,[[Ce,et,0],[Be,et,0],[Be,at,0],[Ce,at,0]]}(o,e,s._pixelsPerMercatorPixel,V,j);for(let Ie=0;Ie<x.length;Ie++)Jc(x[Ie],Ee[Ie],xe);const Ve=Oi([],Ee[K],Ee[(K+1)%4]);Li(Ve,Ve,.5),Jc(fe,Ve,xe)}for(const Ee of x)wa(C,C,Ee),qi(T,T,Ee);return C[2]=Math.min(te[2],me[2]),wa(C,C,fe),qi(T,T,fe),new on(C,T)}function wm({x:s,y:e,z:o},c=!1){const d=1/(1<<o),m=new R(Y(s*d),e===(1<<o)-1&&c?-90:ee((e+1)*d)),g=new R(Y((s+1)*d),0===e&&c?90:ee(e*d));return new z(m,g)}function Ev(s,e=Po){const o=Pn(s.getNorth()),c=Pn(s.getSouth()),d=Math.cos(o),m=Math.cos(c),g=Math.sin(o),x=Math.sin(c),w=s.getWest(),T=s.getEast();return[b(m,x,w,e),b(m,x,T,e),b(d,g,T,e),b(d,g,w,e)]}function Em(s,e,o,c){const d=1<<o.z,m=(s/ht+o.x)/d;return S(ee((e/ht+o.y)/d),Y(m),c)}function ls({min:s,max:e}){return r/Math.max(e[0]-s[0],e[1]-s[1],e[2]-s[2])}const f_=new Float64Array(16);function Tm(s){const e=ls(s),o=Cl(f_,[e,e,e]);return zo(o,o,Vi([],s.min))}function Sm(s){const e=(c=s.min,(o=f_)[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=1,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=c[0],o[13]=c[1],o[14]=c[2],o[15]=1,o);var o,c;const d=1/ls(s);return eo(e,e,[d,d,d])}function Go(s){const e=ht/(2*Math.PI);return s/(2*Math.PI)/e}function Hf(s,e){return ht/(512*Math.pow(2,s))*ls(Oa(e))}function Tv(s,e,o,c,d){const m=Go(o),g=[s,e,-o/(2*Math.PI)],x=fn(new Float64Array(16));return zo(x,x,g),eo(x,x,[m,m,m]),fs(x,x,Pn(-d)),Vs(x,x,Pn(-c)),x}function eu(s){return be(Uf,f,s)}function Vx(s,e){const o=S(e.lat,e.lng);return g=(d=to([],function(F){const V=S(F._center.lat,F._center.lng);let j=yi([],dr(0,1,0),V);const W=ra([],-F.angle,V);j=rr(j,j,W),ra(W,-F._pitch,j);const Q=Ai([],V);return Li(Q,Q,cl(F.cameraToCenterDistance/F.pixelsPerMeter)),rr(Q,Q,W),Oi([],V,Q)}(s),o))[0],x=d[1],w=d[2],T=(m=o)[0],C=m[1],A=m[2],k=(M=Math.sqrt(g*g+x*x+w*w)*Math.sqrt(T*T+C*C+A*A))&&ir(d,m)/M,Math.acos(Math.min(Math.max(k,-1),1));var d,m,g,x,w,T,C,A,M,k}function p_(s,e){return Vx(s,e)>Math.PI/2*1.01}const jx=Pn(85),Ux=Math.cos(jx),Gw=Math.sin(jx),Hx=Dl(),Gx=s=>{const e=[];return"map"===s.paint.get("circle-pitch-alignment")&&e.push("PITCH_WITH_MAP"),"map"===s.paint.get("circle-pitch-scale")&&e.push("SCALE_WITH_MAP"),e};function $x(s,e,o,c,d,m,g,x,w){if(m&&s.queryGeometry.isAboveHorizon)return!1;m&&(w*=s.pixelToTileUnitsFactor);const T=s.tileID.canonical,C=o.projection.upVectorScale(T,o.center.lat,o.worldSize).metersToTile;for(const A of e)for(const M of A){const k=M.add(x),F=d&&o.elevation?o.elevation.exaggeration()*d.getElevationAt(k.x,k.y,!0):0,V=o.projection.projectTilePoint(k.x,k.y,T);if(F>0){const K=o.projection.upVector(T,k.x,k.y);V.x+=K[0]*C*F,V.y+=K[1]*C*F,V.z+=K[2]*C*F}const j=m?k:Sv(V.x,V.y,V.z,c),W=m?s.tilespaceRays.map(K=>Dm(K,F)):s.queryGeometry.screenGeometry,Q=ms([],[V.x,V.y,V.z,1],c);if(!g&&m?w*=Q[3]/o.cameraToCenterDistance:g&&!m&&(w*=o.cameraToCenterDistance/Q[3]),m){const K=ee((M.y/ht+T.y)/(1<<T.z));w/=o.projection.pixelsPerMeter(K,1)/G(1,K)}if(mr(W,j,w))return!0}return!1}function Sv(s,e,o,c){const d=ms([],[s,e,o,1],c);return new Je(d[0]/d[3],d[1]/d[3])}const m_=dr(0,0,0),$w=dr(0,0,1);function Dm(s,e){const o=jn();return m_[2]=e,s.intersectsPlane(m_,$w,o),new Je(o[0],o[1])}class qx extends qn{}let Wx,Dv,Iv,Cv;function _h(s,{width:e,height:o},c,d){if(d){if(d instanceof Uint8ClampedArray)d=new Uint8Array(d.buffer);else if(d.length!==e*o*c)throw new RangeError("mismatched image size")}else d=new Uint8Array(e*o*c);return s.width=e,s.height=o,s.data=d,s}function Im(s,e,o){const{width:c,height:d}=e;c===s.width&&d===s.height||(g_(s,e,{x:0,y:0},{x:0,y:0},{width:Math.min(s.width,c),height:Math.min(s.height,d)},o,null),s.width=c,s.height=d,s.data=e.data)}function g_(s,e,o,c,d,m,g,x){if(0===d.width||0===d.height)return e;if(d.width>s.width||d.height>s.height||o.x>s.width-d.width||o.y>s.height-d.height)throw new RangeError("out of range source coordinates for image copy");if(d.width>e.width||d.height>e.height||c.x>e.width-d.width||c.y>e.height-d.height)throw new RangeError("out of range destination coordinates for image copy");const w=s.data,T=e.data,C=4===m&&x;for(let A=0;A<d.height;A++){const M=((o.y+A)*s.width+o.x)*m,k=((c.y+A)*e.width+c.x)*m;if(C)for(let F=0;F<d.width;F++){const V=M+F*m+3,j=k+F*m;T[j+0]=255,T[j+1]=255,T[j+2]=255,T[j+3]=w[V]}else if(g)for(let F=0;F<d.width;F++){const V=M+F*m,j=k+F*m,W=new Yn(w[V+0]/255,w[V+1]/255,w[V+2]/255,w[V+3]).toNonPremultipliedRenderColor(g).toArray();T[j+0]=W[0],T[j+1]=W[1],T[j+2]=W[2],T[j+3]=W[3]}else for(let F=0;F<d.width*m;F++)T[k+F]=w[M+F]}return e}wt(qx,"HeatmapBucket",{omit:["layers"]});class ic{constructor(e,o){_h(this,e,1,o)}resize(e){Im(this,new ic(e),1)}clone(){return new ic({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,o,c,d,m){g_(e,o,c,d,m,1,null)}}class jr{constructor(e,o){_h(this,e,4,o)}resize(e){Im(this,new jr(e),4)}replace(e,o){o?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new jr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,o,c,d,m,g,x){g_(e,o,c,d,m,4,g,x)}}class Zx{constructor(e,o){this.width=e.width,this.height=e.height,this.data=o instanceof Uint8Array?new Float32Array(o.buffer):o}}function Cm(s){const e={},o=s.resolution||256,c=s.clips?s.clips.length:1,d=s.image||new jr({width:o,height:c}),m=(g,x,w)=>{e[s.evaluationKey]=w;const T=s.expression.evaluate(e),C=T?T.toNonPremultipliedRenderColor(null):null;C&&(d.data[g+x+0]=Math.floor(255*C.r),d.data[g+x+1]=Math.floor(255*C.g),d.data[g+x+2]=Math.floor(255*C.b),d.data[g+x+3]=Math.floor(255*C.a))};if(s.clips)for(let g=0,x=0;g<c;++g,x+=4*o)for(let w=0,T=0;w<o;w++,T+=4){const C=w/(o-1),{start:A,end:M}=s.clips[g];m(x,T,A*(1-C)+M*C)}else for(let g=0,x=0;g<o;g++,x+=4)m(0,x,g/(o-1));return d}wt(ic,"AlphaImage"),wt(jr,"RGBAImage");const qw=En([{name:"a_pos",components:2,type:"Int16"}],4),Ww=En([{name:"a_road_z_offset",components:1,type:"Float32"}],4),Zw=En([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),Xw=En([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function yh(s,e,o=2){const c=e&&e.length,d=c?e[0]*o:s.length;let m=Am(s,0,d,o,!0);const g=[];if(!m||m.next===m.prev)return g;let x,w,T;if(c&&(m=function(C,A,M,k){const F=[];for(let V=0,j=A.length;V<j;V++){const W=Am(C,A[V]*k,V<j-1?A[V+1]*k:C.length,k,!1);W===W.next&&(W.steiner=!0),F.push(TD(W))}F.sort(xh);for(let V=0;V<F.length;V++)M=Yx(F[V],M);return M}(s,e,m,o)),s.length>80*o){x=s[0],w=s[1];let C=x,A=w;for(let M=o;M<d;M+=o){const k=s[M],F=s[M+1];k<x&&(x=k),F<w&&(w=F),k>C&&(C=k),F>A&&(A=F)}T=Math.max(C-x,A-w),T=0!==T?32767/T:0}return vh(m,g,o,x,w,T,0),g}function Am(s,e,o,c,d){let m;if(d===function(g,x,w,T){let C=0;for(let A=x,M=w-T;A<w;A+=T)C+=(g[M]-g[A])*(g[A+1]+g[M+1]),M=A;return C}(s,e,o,c)>0)for(let g=e;g<o;g+=c)m=y_(g/c|0,s[g],s[g+1],m);else for(let g=o-c;g>=e;g-=c)m=y_(g/c|0,s[g],s[g+1],m);return m&&bh(m,m.next)&&(rd(m),m=m.next),m}function tu(s,e){if(!s)return s;e||(e=s);let o,c=s;do{if(o=!1,c.steiner||!bh(c,c.next)&&0!==Fr(c.prev,c,c.next))c=c.next;else{if(rd(c),c=e=c.prev,c===c.next)break;o=!0}}while(o||c!==e);return e}function vh(s,e,o,c,d,m,g){if(!s)return;!g&&m&&function(w,T,C,A){let M=w;do{0===M.z&&(M.z=Mv(M.x,M.y,T,C,A)),M.prevZ=M.prev,M.nextZ=M.next,M=M.next}while(M!==w);M.prevZ.nextZ=null,M.prevZ=null,function(k){let F,V=1;do{let j,W=k;k=null;let Q=null;for(F=0;W;){F++;let K=W,te=0;for(let he=0;he<V&&(te++,K=K.nextZ,K);he++);let me=V;for(;te>0||me>0&&K;)0!==te&&(0===me||!K||W.z<=K.z)?(j=W,W=W.nextZ,te--):(j=K,K=K.nextZ,me--),Q?Q.nextZ=j:k=j,j.prevZ=Q,Q=j;W=K}Q.nextZ=null,V*=2}while(F>1)}(M)}(s,c,d,m);let x=s;for(;s.prev!==s.next;){const w=s.prev,T=s.next;if(m?Kw(s,c,d,m):Yw(s))e.push(w.i,s.i,T.i),rd(s),s=T.next,x=T.next;else if((s=T)===x){g?1===g?vh(s=Av(tu(s),e),e,o,c,d,m,2):2===g&&Xx(s,e,o,c,d,m):vh(tu(s),e,o,c,d,m,1);break}}}function Yw(s){const e=s.prev,o=s,c=s.next;if(Fr(e,o,c)>=0)return!1;const d=e.x,m=o.x,g=c.x,x=e.y,w=o.y,T=c.y,C=Math.min(d,m,g),A=Math.min(x,w,T),M=Math.max(d,m,g),k=Math.max(x,w,T);let F=c.next;for(;F!==e;){if(F.x>=C&&F.x<=M&&F.y>=A&&F.y<=k&&Pm(d,x,m,w,g,T,F.x,F.y)&&Fr(F.prev,F,F.next)>=0)return!1;F=F.next}return!0}function Kw(s,e,o,c){const d=s.prev,m=s,g=s.next;if(Fr(d,m,g)>=0)return!1;const x=d.x,w=m.x,T=g.x,C=d.y,A=m.y,M=g.y,k=Math.min(x,w,T),F=Math.min(C,A,M),V=Math.max(x,w,T),j=Math.max(C,A,M),W=Mv(k,F,e,o,c),Q=Mv(V,j,e,o,c);let K=s.prevZ,te=s.nextZ;for(;K&&K.z>=W&&te&&te.z<=Q;){if(K.x>=k&&K.x<=V&&K.y>=F&&K.y<=j&&K!==d&&K!==g&&Pm(x,C,w,A,T,M,K.x,K.y)&&Fr(K.prev,K,K.next)>=0||(K=K.prevZ,te.x>=k&&te.x<=V&&te.y>=F&&te.y<=j&&te!==d&&te!==g&&Pm(x,C,w,A,T,M,te.x,te.y)&&Fr(te.prev,te,te.next)>=0))return!1;te=te.nextZ}for(;K&&K.z>=W;){if(K.x>=k&&K.x<=V&&K.y>=F&&K.y<=j&&K!==d&&K!==g&&Pm(x,C,w,A,T,M,K.x,K.y)&&Fr(K.prev,K,K.next)>=0)return!1;K=K.prevZ}for(;te&&te.z<=Q;){if(te.x>=k&&te.x<=V&&te.y>=F&&te.y<=j&&te!==d&&te!==g&&Pm(x,C,w,A,T,M,te.x,te.y)&&Fr(te.prev,te,te.next)>=0)return!1;te=te.nextZ}return!0}function Av(s,e){let o=s;do{const c=o.prev,d=o.next.next;!bh(c,d)&&__(c,o,o.next,d)&&nu(c,d)&&nu(d,c)&&(e.push(c.i,o.i,d.i),rd(o),rd(o.next),o=s=d),o=o.next}while(o!==s);return tu(o)}function Xx(s,e,o,c,d,m){let g=s;do{let x=g.next.next;for(;x!==g.prev;){if(g.i!==x.i&&Qx(g,x)){let w=Pv(g,x);return g=tu(g,g.next),w=tu(w,w.next),vh(g,e,o,c,d,m,0),void vh(w,e,o,c,d,m,0)}x=x.next}g=g.next}while(g!==s)}function xh(s,e){let o=s.x-e.x;return 0===o&&(o=s.y-e.y,0===o)&&(o=(s.next.y-s.y)/(s.next.x-s.x)-(e.next.y-e.y)/(e.next.x-e.x)),o}function Yx(s,e){const o=function(d,m){let g=m;const x=d.x,w=d.y;let T,C=-1/0;if(bh(d,g))return g;do{if(bh(d,g.next))return g.next;if(w<=g.y&&w>=g.next.y&&g.next.y!==g.y){const V=g.x+(w-g.y)*(g.next.x-g.x)/(g.next.y-g.y);if(V<=x&&V>C&&(C=V,T=g.x<g.next.x?g:g.next,V===x))return T}g=g.next}while(g!==m);if(!T)return null;const A=T,M=T.x,k=T.y;let F=1/0;g=T;do{if(x>=g.x&&g.x>=M&&x!==g.x&&Mm(w<k?x:C,w,M,k,w<k?C:x,w,g.x,g.y)){const V=Math.abs(w-g.y)/(x-g.x);nu(g,d)&&(V<F||V===F&&(g.x>T.x||g.x===T.x&&Kx(T,g)))&&(T=g,F=V)}g=g.next}while(g!==A);return T}(s,e);if(!o)return e;const c=Pv(o,s);return tu(c,c.next),tu(o,o.next)}function Kx(s,e){return Fr(s.prev,s,e.prev)<0&&Fr(e.next,s,s.next)<0}function Mv(s,e,o,c,d){return(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=(s-o)*d|0)|s<<8))|s<<4))|s<<2))|s<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-c)*d|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function TD(s){let e=s,o=s;do{(e.x<o.x||e.x===o.x&&e.y<o.y)&&(o=e),e=e.next}while(e!==s);return o}function Mm(s,e,o,c,d,m,g,x){return(d-g)*(e-x)>=(s-g)*(m-x)&&(s-g)*(c-x)>=(o-g)*(e-x)&&(o-g)*(m-x)>=(d-g)*(c-x)}function Pm(s,e,o,c,d,m,g,x){return!(s===g&&e===x)&&Mm(s,e,o,c,d,m,g,x)}function Qx(s,e){return s.next.i!==e.i&&s.prev.i!==e.i&&!function(o,c){let d=o;do{if(d.i!==o.i&&d.next.i!==o.i&&d.i!==c.i&&d.next.i!==c.i&&__(d,d.next,o,c))return!0;d=d.next}while(d!==o);return!1}(s,e)&&(nu(s,e)&&nu(e,s)&&function(o,c){let d=o,m=!1;const g=(o.x+c.x)/2,x=(o.y+c.y)/2;do{d.y>x!=d.next.y>x&&d.next.y!==d.y&&g<(d.next.x-d.x)*(x-d.y)/(d.next.y-d.y)+d.x&&(m=!m),d=d.next}while(d!==o);return m}(s,e)&&(Fr(s.prev,s,e.prev)||Fr(s,e.prev,e))||bh(s,e)&&Fr(s.prev,s,s.next)>0&&Fr(e.prev,e,e.next)>0)}function Fr(s,e,o){return(e.y-s.y)*(o.x-e.x)-(e.x-s.x)*(o.y-e.y)}function bh(s,e){return s.x===e.x&&s.y===e.y}function __(s,e,o,c){const d=wh(Fr(s,e,o)),m=wh(Fr(s,e,c)),g=wh(Fr(o,c,s)),x=wh(Fr(o,c,e));return d!==m&&g!==x||!(0!==d||!Rm(s,o,e))||!(0!==m||!Rm(s,c,e))||!(0!==g||!Rm(o,s,c))||!(0!==x||!Rm(o,e,c))}function Rm(s,e,o){return e.x<=Math.max(s.x,o.x)&&e.x>=Math.min(s.x,o.x)&&e.y<=Math.max(s.y,o.y)&&e.y>=Math.min(s.y,o.y)}function wh(s){return s>0?1:s<0?-1:0}function nu(s,e){return Fr(s.prev,s,s.next)<0?Fr(s,e,s.next)>=0&&Fr(s,s.prev,e)>=0:Fr(s,e,s.prev)<0||Fr(s,s.next,e)<0}function Pv(s,e){const o=v_(s.i,s.x,s.y),c=v_(e.i,e.x,e.y),d=s.next,m=e.prev;return s.next=e,e.prev=s,o.next=d,d.prev=o,c.next=o,o.prev=c,m.next=c,c.prev=m,c}function y_(s,e,o,c){const d=v_(s,e,o);return c?(d.next=c.next,d.prev=c,c.next.prev=d,c.next=d):(d.prev=d,d.next=d),d}function rd(s){s.next.prev=s.prev,s.prev.next=s.next,s.prevZ&&(s.prevZ.nextZ=s.nextZ),s.nextZ&&(s.nextZ.prevZ=s.prevZ)}function v_(s,e,o){return{i:s,x:e,y:o,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Eh(s,e){const o=s.length;if(o<=1)return[s];const c=[];let d,m;for(let g=0;g<o;g++){const x=wr(s[g]);0!==x&&(s[g].area=Math.abs(x),void 0===m&&(m=x<0),m===x<0?(d&&c.push(d),d=[s[g]]):d.push(s[g]))}if(d&&c.push(d),e>1)for(let g=0;g<c.length;g++)c[g].length<=e||(Yr(c[g],e,1,c[g].length-1,Om),c[g]=c[g].slice(0,e));return c}function Om(s,e){return e.area-s.area}function Jx(s,e,o=1){if(!s)return null;const c="string"==typeof s?po.from(s).getPrimary():s.getPrimary(),d="string"==typeof s?null:s.getSecondary();for(const m of[c,d]){if(!m)continue;const g=m.id.toString();e.has(g)||e.set(g,[]),m.scaleSelf(o),e.get(g).push(m)}return{primary:c.toString(),secondary:d?d.toString():null}}function x_(s,e,o,c){const d=c.patternDependencies;let m=!1;for(const g of e){const x=g.paint.get(`${s}-pattern`);x.isConstant()||(m=!0),Jx(x.constantOr(null),d,o)&&(m=!0)}return m}function Rv(s,e,o,c,d,m){const g=m.patternDependencies;for(const x of e){const w=x.paint.get(`${s}-pattern`).value;if("constant"!==w.kind){let T=w.evaluate({zoom:c},o,{},m.availableImages);T=T&&T.name?T.name:T;const C=Jx(T,g,d);if(!C)continue;const{primary:A,secondary:M}=C;A&&(o.patterns[x.id]=[A,M].filter(Boolean))}}return o}class eb{constructor(){this.polygons=new Map}add(e,...o){this.polygons.has(e)?this.polygons.get(e).push(...o):this.polygons.set(e,o)}merge(e){for(const[o,c]of e.polygons)this.add(o,...c)}}class Th{constructor(){this.portals=[]}static evaluate(e){if(0===e.length)return new Th;let o=[];for(const T of e)o.push(...T.portals);if(0===o.length)return new Th;const c=(T,C)=>T<=0&&C<=0||T>=ht&&C>=ht;for(const T of o){const C=T.va,A=T.vb;(c(C.x,A.x)||c(C.y,A.y))&&(T.type="border")}const d=o.filter(T=>"unevaluated"!==T.type),m=o.filter(T=>"unevaluated"===T.type);if(0===m.length)return new Th;m.sort((T,C)=>T.hash===C.hash?T.isTunnel===C.isTunnel?0:T.isTunnel?-1:1:T.hash<C.hash?1:-1),o=d.concat(m);let g=d.length,x=g,w=g;do{if(x++,x===o.length||o[g].hash!==o[x].hash){if(x-g==2){w<g&&(o[w]=o[g],o[g]=null);const T=o[w],C=o[x-1];T.type=T.isTunnel!==C.isTunnel?"tunnel":"polygon",T.connection={a:T.connection.a,b:C.connection.a},w++}g=x}}while(g!==o.length);return o.splice(w),o.sort((T,C)=>T.hash<C.hash?1:-1),{portals:o}}}wt(Th,"ElevationPortalGraph"),wt(eb,"ElevationPolygons");class tb{constructor(e,o,c){this.outPositions=e,this.outNormals=o,this.outIndices=c,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,o,c){let d=e[2];null!=c&&(d*=c);const m=this.getVec3Bits(e)<<96n|this.getVec3Bits(o),g=this.vertexLookup.get(m);if(null!=g)return g;const x=this.outPositions.length;this.vertexLookup.set(m,x);const w=Math.trunc(16384*o[0]),T=Math.trunc(16384*o[1]),C=Math.trunc(16384*o[2]);return this.outPositions.emplaceBack(e[0],e[1],d),this.outNormals.emplaceBack(w,T,C),x}addTriangle(e,o,c){this.outIndices.emplaceBack(e,o,c)}addTriangles(e,o,c){if(0===e.length)return;const d=1===c.length,m=jn(),g=jn();for(let x=0;x<e.length;x+=3){const w=o[e[x+0]],T=o[e[x+1]],C=o[e[x+2]],A=d?c[0]:c[e[x+1]],M=d?c[0]:c[e[x+2]];hr(m,w.x,w.y,d?c[0]:c[e[x+0]]);const k=this.addVertex(m,g);hr(m,T.x,T.y,A);const F=this.addVertex(m,g);hr(m,C.x,C.y,M);const V=this.addVertex(m,g);this.outIndices.emplaceBack(k,F,V)}}addQuad(e,o,c,d,m,g){const x=this.addVertex(e,m,g),w=this.addVertex(o,m,g),T=this.addVertex(c,m,g),C=this.addVertex(d,m,g);this.addTriangle(x,w,T),this.addTriangle(T,C,x)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class Ts{constructor(e,o,c,d){this.unevaluatedPortals=new Th,this.portalPolygons=new eb,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Ff,this.vertexNormals=new Yl,this.indexArray=new Mi,this.tileToMeters=ce(e),this.bridgeProgramConfigurations=new ws(o,{zoom:c,lut:d},m=>"fill-tunnel-structure-color"!==m),this.tunnelProgramConfigurations=new ws(o,{zoom:c,lut:d},m=>"fill-bridge-guard-rail-color"!==m)}addVertices(e,o){const c=this.unevalVertices.length;for(let d=0;d<e.length;d++)this.unevalVertices.push(e[d]),this.unevalHeights.push(o[d]);return c}addTriangles(e,o,c){const d=c?this.unevalTunnelTriangles:this.unevalTriangles;for(const m of e)d.push(m+o)}addRenderableRing(e,o,c,d,m,g){const x=[new Je(m.min.x,m.min.y),new Je(m.max.x,m.min.y),new Je(m.max.x,m.max.y),new Je(m.min.x,m.max.y)];for(let w=0;w<c-1;w++){const T=o+w,C=T+1,A=this.unevalVertices[T],M=this.unevalVertices[C];if(!(A.x>=m.min.x&&A.x<=m.max.x&&A.y>=m.min.y&&A.y<=m.max.y||M.x>=m.min.x&&M.x<=m.max.x&&M.y>=m.min.y&&M.y<=m.max.y||Ji(A,M,x))||this.isOnBorder(A.x,M.x)||this.isOnBorder(A.y,M.y))continue;const k=Ts.computeEdgeHash(this.unevalVertices[T],this.unevalVertices[C]);let F,V=this.vertexHashLookup.get(Ts.computePosHash(A));null!=V?F=V.next:(V=this.vertexHashLookup.get(Ts.computePosHash(M)),F=null!=V?V.prev:k),this.unevalEdges.push({polygonIdx:e,a:T,b:C,hash:k,portalHash:F,isTunnel:d,type:"unevaluated",featureInfo:g})}}addPortalCandidates(e,o,c,d,m){if(0===o.length)return;this.portalPolygons.add(e,{geometry:o,zLevel:m});const g=o[0];this.vertexHashLookup.clear();let x=Ts.computeEdgeHash(g[g.length-2],g[g.length-1]);for(let w=0;w<g.length-1;w++){const T=g[w+0],C=g[w+1],A=Gr(C.x-T.x,C.y-T.y),M=Pl(A);if(0===M)continue;let k="unevaluated";const F=d.pointElevation(T),V=d.pointElevation(C);Math.abs(F)<.01&&Math.abs(V)<.01?k="entrance":(this.isOnBorder(T.x,C.x)||this.isOnBorder(T.y,C.y))&&(k="border");const j=Ts.computeEdgeHash(T,C);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:T,vb:C,vab:A,length:M,hash:j,isTunnel:c,type:k});const W=Ts.computePosHash(T);this.vertexHashLookup.set(W,{prev:x,next:j}),x=j}}construct(e){if(0===this.unevalVertices.length)return;const o=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),c=M=>{M.primitiveLength=this.indexArray.length-M.primitiveOffset},d=new tb(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const m=o(),g=o(),x=o(),w=(M,k)=>{M.sort((V,j)=>V.type===k&&j.type!==k?-1:V.type!==k&&j.type===k?1:0);const F=M.findIndex(V=>V.type!==k);return F>=0?F:M.length};let T=0;this.unevalEdges.length>0&&(T=w(this.unevalEdges,"none"),this.constructBridgeStructures(d,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:T},this.tileToMeters)),c(x);const C=o(),A=o();if(this.unevalEdges.length>0){const M=this.unevalEdges.splice(T),k=w(M,"tunnel")+T;this.unevalEdges.push(...M),this.constructTunnelStructures(d,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:T},{min:T,max:k})}c(C),d.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),c(A),d.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),c(g),d.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),c(m),this.maskSegments=Gi.simpleSegment(0,A.primitiveOffset,0,A.primitiveLength),this.depthSegments=Gi.simpleSegment(0,g.primitiveOffset,0,g.primitiveLength),this.renderableBridgeSegments=Gi.simpleSegment(0,x.primitiveOffset,0,x.primitiveLength),this.renderableTunnelSegments=Gi.simpleSegment(0,C.primitiveOffset,0,C.primitiveLength),this.shadowCasterSegments=Gi.simpleSegment(0,m.primitiveOffset,0,m.primitiveLength)}update(e,o,c,d,m,g,x,w){this.bridgeProgramConfigurations.updatePaintArrays(e,o,m,c,d,g,x,w),this.tunnelProgramConfigurations.updatePaintArrays(e,o,m,c,d,g,x,w)}upload(e){this.vertexBuffer||0===this.vertexPositions.length||0===this.vertexNormals.length||0===this.indexArray.length||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,Zw.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,Xw.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,o,c,d,m){const g=(x,w)=>{for(let T=0;T<w.length-1;T++){const C=w[T].featureIndex,A=w[T+1].vertexStart,M=e.feature(C);x.populatePaintArrays(A,M,C,{},c,o,d,void 0,m)}};g(this.bridgeProgramConfigurations,this.bridgeFeatureSections),g(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,o,c,d,m){const g=new Map;for(let x=d;x<m;x++){const w=c[x],T=w.a,C=w.b,A=Ts.computePosHash(e[T]),M=Ts.computePosHash(e[C]);let k=g.get(A);k||(k={},g.set(A,k));let F=g.get(M);F||(F={},g.set(M,F)),o[T]<=0&&o[C]<=0||(k.to=C,F.from=T)}return g}isTerminalVertex(e,o){const c=Ts.computePosHash(this.unevalVertices[e]),d=o.get(c);return!d||!d.from||!d.to}constructBridgeStructures(e,o,c,d,m,g){e.clearVertexLookup();const x=this.computeVertexConnections(o,c,d,m.min,m.max),w=1/g,T=.5*w,C=(Ke,nt)=>hr(Ke,o[nt].x,o[nt].y,c[nt]*w),A=jn(),M=jn(),k=jn(),F=jn(),V=jn(),j=(Ke,nt)=>{const Ne=x.get(Ts.computePosHash(o[nt])),Qe=Ne.from,Ce=Ne.to;if(!Qe||!Ce)return;C(A,Qe),C(M,nt),C(k,Ce),Cd(F),ps(A,M)||(or(V,M,A),Ai(F,V)),ps(k,M)||(or(V,k,M),Oi(F,F,Ai(V,V)));const Be=Al(F);return Be>0?Li(Ke,F,1/Be):void 0};let W=Number.POSITIVE_INFINITY;this.sortSubarray(d,m.min,m.max,(Ke,nt)=>Ke.featureInfo.featureIndex-nt.featureInfo.featureIndex);const Q=jn(),K=jn(),te=jn(),me=jn(),he=jn(),fe=jn(),xe=jn(),Ee=jn(),Ve=jn(),Ie=[jn(),jn(),jn(),jn()],Ue=[jn(),jn(),jn(),jn()],ot=[{coord:new Je(0,0),height:0},{coord:new Je(0,0),height:0}],$e=(Ke,nt)=>Ke>nt;for(let Ke=m.min;Ke<m.max;Ke++){const nt=d[Ke];if(!nt.featureInfo.guardRailEnabled||!this.prepareEdgePoints(ot,o,c,nt,$e))continue;const[Ne,Qe]=ot;if(hr(Q,Ne.coord.x,Ne.coord.y,w*Ne.height),hr(K,Qe.coord.x,Qe.coord.y,w*Qe.height),ps(Q,K))continue;or(te,K,Q),Ai(te,te);const Ce=j(Ee,nt.a)||te,Be=j(Ve,nt.b)||te;hr(me,Ce[1],-Ce[0],0),Ai(me,me),hr(he,Be[1],-Be[0],0),Ai(he,he),yi(Ee,me,Ce),Ai(fe,Ee),yi(Ee,he,Be),Ai(xe,Ee),Oi(Ie[0],Q,Li(Ee,or(Ee,me,fe),T)),Oi(Ie[1],Q,Li(Ee,Oi(Ee,me,fe),T)),Oi(Ie[2],Q,Li(Ee,fe,T)),Ie[3]=Q,Oi(Ue[0],K,Li(Ee,or(Ee,he,xe),T)),Oi(Ue[1],K,Li(Ee,Oi(Ee,he,xe),T)),Oi(Ue[2],K,Li(Ee,xe,T)),Ue[3]=K,W=this.addFeatureSection(nt.featureInfo.featureIndex,W,this.bridgeFeatureSections,e);const at=e.addVertex(Ie[0],me,g),et=e.addVertex(Ie[1],me,g),Ot=e.addVertex(Ue[0],he,g),Tt=e.addVertex(Ue[1],he,g);e.addTriangle(at,et,Ot),e.addTriangle(et,Tt,Ot);const Xe=e.addVertex(Ie[1],fe,g),tt=e.addVertex(Ie[2],fe,g),Dt=e.addVertex(Ue[1],xe,g),yt=e.addVertex(Ue[2],xe,g);e.addTriangle(Xe,tt,Dt),e.addTriangle(tt,yt,Dt),Vi(me,me),Vi(he,he);const ft=e.addVertex(Ie[2],me,g),xt=e.addVertex(Ie[3],me,g),zt=e.addVertex(Ue[2],he,g),$t=e.addVertex(Ue[3],he,g);e.addTriangle(ft,xt,zt),e.addTriangle(xt,$t,zt);const nn=this.isTerminalVertex(nt.a,x),Xt=this.isTerminalVertex(nt.b,x);Ne.height<.01&&nn&&e.addQuad(Ie[3],Ie[2],Ie[1],Ie[0],Vi(Ce,Ce),g),Qe.height<.01&&Xt&&e.addQuad(Ue[0],Ue[1],Ue[2],Ue[3],Be,g)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,o,c,d,m,g){e.clearVertexLookup();let x=Number.POSITIVE_INFINITY;const w=(W,Q)=>W.featureInfo.featureIndex-Q.featureInfo.featureIndex;this.sortSubarray(d,m.min,m.max,w),this.sortSubarray(d,g.min,g.max,w);const T=W=>Ai(W,W),C=[{coord:new Je(0,0),height:0},{coord:new Je(0,0),height:0}],A=(W,Q)=>W<Q,M=jn(),k=jn(),F=jn(),V=jn(),j=jn();for(let W=m.min;W<m.max;W++){if(!this.prepareEdgePoints(C,o,c,d[W],A))continue;const[Q,K]=C,te=T(hr(j,-(K.coord.y-Q.coord.y),K.coord.x-Q.coord.x,0));x=this.addFeatureSection(d[W].featureInfo.featureIndex,x,this.tunnelFeatureSections,e),e.addQuad(hr(M,Q.coord.x,Q.coord.y,Q.height),hr(k,K.coord.x,K.coord.y,K.height),hr(F,K.coord.x,K.coord.y,d[W].isTunnel?-.1:0),hr(V,Q.coord.x,Q.coord.y,d[W].isTunnel?-.1:0),te)}for(let W=g.min;W<g.max;W++){const Q=d[W];Q.isTunnel&&([Q.a,Q.b]=[Q.b,Q.a]);const K=o[Q.a],te=o[Q.b],me=T(hr(j,-(te.y-K.y),te.x-K.x,0));x=this.addFeatureSection(Q.featureInfo.featureIndex,x,this.tunnelFeatureSections,e),e.addQuad(hr(M,te.x,te.y,0),hr(k,K.x,K.y,0),hr(F,K.x,K.y,c[Q.a]+4),hr(V,te.x,te.y,c[Q.b]+4),me),e.addQuad(hr(M,K.x,K.y,0),hr(k,te.x,te.y,0),hr(F,te.x,te.y,c[Q.b]+4),hr(V,K.x,K.y,c[Q.a]+4),me)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,o,c,d){e.coord.x=o,e.coord.y=c,e.height=d}prepareEdgePoints(e,o,c,d,m){let g=o[d.a].x,x=o[d.a].y,w=o[d.b].x,T=o[d.b].y,C=c[d.a],A=c[d.b];const M=m(C,0),k=m(A,0);if(M&&k)return this.setElevatedPoint(e[0],g,x,C),this.setElevatedPoint(e[1],w,T,A),!0;if(!M&&!k)return!1;if(M){if(!k){const F=A/(A-C);w=Ft(w,g,F),T=Ft(T,x,F),A=Ft(A,C,F)}}else{const F=C/(C-A);g=Ft(g,w,F),x=Ft(x,T,F),C=Ft(C,A,F)}return this.setElevatedPoint(e[0],g,x,C),this.setElevatedPoint(e[1],w,T,A),!0}prepareEdges(e,o){if(0===o.length)return;o.sort((x,w)=>x.hash===w.hash?w.polygonIdx-x.polygonIdx:w.hash>x.hash?1:-1);let c=0,d=0,m=0,g=o[c].polygonIdx;do{d++,(d===o.length||o[c].hash!==o[d].hash)&&((d-c==1||o[d-1].polygonIdx!==g)&&(m<c&&(o[m]=o[c],o[c]=null),o[m].type="none",m++),c=d,c!==o.length&&(g=o[c].polygonIdx))}while(c!==o.length);if(o.splice(m),0!==o.length&&0!==e.length){o.sort((T,C)=>T.portalHash<C.portalHash?1:-1);let x=0,w=0;for(;x!==o.length&&w!==e.length;){const T=o[x],C=e[w];T.portalHash>C.hash?x++:C.hash>T.portalHash?w++:(T.type=C.type,x++)}}}isOnBorder(e,o){return e<=0&&o<=0||e>=ht&&o>=ht}addFeatureSection(e,o,c,d){return e!==o&&(o=e,c.push({featureIndex:e,vertexStart:d.getVertexCount()}),d.clearVertexLookup()),o}sortSubarray(e,o,c,d){const m=e.slice(o,c);m.sort(d),e.splice(o,m.length,...m)}static computeEdgeHash(e,o){return(e.y===o.y&&e.x>o.x||e.y>o.y)&&([e,o]=[o,e]),BigInt(Ts.computePosHash(e))<<32n|BigInt(Ts.computePosHash(o))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var Lm,b_={exports:{}},Sh=(Lm||(Lm=1,function(o){function c(ie,re){return ie>re?1:ie<re?-1:0}var d=function(ie,re){void 0===ie&&(ie=c),void 0===re&&(re=!1),this._compare=ie,this._root=null,this._size=0,this._noDuplicates=!!re},m={size:{configurable:!0}};function g(ie,re,Fe,lt,ut){var pt=ut-lt;if(pt>0){var St=lt+Math.floor(pt/2),Ut={key:re[St],data:Fe[St],parent:ie};return Ut.left=g(Ut,re,Fe,lt,St),Ut.right=g(Ut,re,Fe,St+1,ut),Ut}return null}function x(ie,re,Fe,lt,ut){if(!(Fe>=lt)){for(var pt=ie[Fe+lt>>1],St=Fe-1,Ut=lt+1;;){do{St++}while(ut(ie[St],pt)<0);do{Ut--}while(ut(ie[Ut],pt)>0);if(St>=Ut)break;var wn=ie[St];ie[St]=ie[Ut],ie[Ut]=wn,wn=re[St],re[St]=re[Ut],re[Ut]=wn}x(ie,re,Fe,Ut,ut),x(ie,re,Ut+1,lt,ut)}}d.prototype.rotateLeft=function(ie){var re=ie.right;re&&(ie.right=re.left,re.left&&(re.left.parent=ie),re.parent=ie.parent),ie.parent?ie===ie.parent.left?ie.parent.left=re:ie.parent.right=re:this._root=re,re&&(re.left=ie),ie.parent=re},d.prototype.rotateRight=function(ie){var re=ie.left;re&&(ie.left=re.right,re.right&&(re.right.parent=ie),re.parent=ie.parent),ie.parent?ie===ie.parent.left?ie.parent.left=re:ie.parent.right=re:this._root=re,re&&(re.right=ie),ie.parent=re},d.prototype._splay=function(ie){for(;ie.parent;){var re=ie.parent;re.parent?re.left===ie&&re.parent.left===re?(this.rotateRight(re.parent),this.rotateRight(re)):re.right===ie&&re.parent.right===re?(this.rotateLeft(re.parent),this.rotateLeft(re)):re.left===ie&&re.parent.right===re?(this.rotateRight(re),this.rotateLeft(re)):(this.rotateLeft(re),this.rotateRight(re)):re.left===ie?this.rotateRight(re):this.rotateLeft(re)}},d.prototype.splay=function(ie){for(var re,Fe,lt,ut,pt;ie.parent;)(Fe=(re=ie.parent).parent)&&Fe.parent?((lt=Fe.parent).left===Fe?lt.left=ie:lt.right=ie,ie.parent=lt):(ie.parent=null,this._root=ie),ut=ie.left,pt=ie.right,ie===re.left?(Fe&&(Fe.left===re?(re.right?(Fe.left=re.right,Fe.left.parent=Fe):Fe.left=null,re.right=Fe,Fe.parent=re):(ut?(Fe.right=ut,ut.parent=Fe):Fe.right=null,ie.left=Fe,Fe.parent=ie)),pt?(re.left=pt,pt.parent=re):re.left=null,ie.right=re,re.parent=ie):(Fe&&(Fe.right===re?(re.left?(Fe.right=re.left,Fe.right.parent=Fe):Fe.right=null,re.left=Fe,Fe.parent=re):(pt?(Fe.left=pt,pt.parent=Fe):Fe.left=null,ie.right=Fe,Fe.parent=ie)),ut?(re.right=ut,ut.parent=re):re.right=null,ie.left=re,re.parent=ie)},d.prototype.replace=function(ie,re){ie.parent?ie===ie.parent.left?ie.parent.left=re:ie.parent.right=re:this._root=re,re&&(re.parent=ie.parent)},d.prototype.minNode=function(ie){if(void 0===ie&&(ie=this._root),ie)for(;ie.left;)ie=ie.left;return ie},d.prototype.maxNode=function(ie){if(void 0===ie&&(ie=this._root),ie)for(;ie.right;)ie=ie.right;return ie},d.prototype.insert=function(ie,re){var Fe=this._root,lt=null,ut=this._compare;if(this._noDuplicates)for(;Fe;){if(lt=Fe,0===ut(Fe.key,ie))return;Fe=ut(Fe.key,ie)<0?Fe.right:Fe.left}else for(;Fe;)lt=Fe,Fe=ut(Fe.key,ie)<0?Fe.right:Fe.left;return Fe={key:ie,data:re,left:null,right:null,parent:lt},lt?ut(lt.key,Fe.key)<0?lt.right=Fe:lt.left=Fe:this._root=Fe,this.splay(Fe),this._size++,Fe},d.prototype.find=function(ie){for(var re=this._root,Fe=this._compare;re;){var lt=Fe(re.key,ie);if(lt<0)re=re.right;else{if(!(lt>0))return re;re=re.left}}return null},d.prototype.contains=function(ie){for(var re=this._root,Fe=this._compare;re;){var lt=Fe(ie,re.key);if(0===lt)return!0;re=lt<0?re.left:re.right}return!1},d.prototype.remove=function(ie){var re=this.find(ie);if(!re)return!1;if(this.splay(re),re.left)if(re.right){var Fe=this.minNode(re.right);Fe.parent!==re&&(this.replace(Fe,Fe.right),Fe.right=re.right,Fe.right.parent=Fe),this.replace(re,Fe),Fe.left=re.left,Fe.left.parent=Fe}else this.replace(re,re.left);else this.replace(re,re.right);return this._size--,!0},d.prototype.removeNode=function(ie){if(!ie)return!1;if(this.splay(ie),ie.left)if(ie.right){var re=this.minNode(ie.right);re.parent!==ie&&(this.replace(re,re.right),re.right=ie.right,re.right.parent=re),this.replace(ie,re),re.left=ie.left,re.left.parent=re}else this.replace(ie,ie.left);else this.replace(ie,ie.right);return this._size--,!0},d.prototype.erase=function(ie){var re=this.find(ie);if(re){this.splay(re);var Fe=re.left,lt=re.right,ut=null;Fe&&(Fe.parent=null,ut=this.maxNode(Fe),this.splay(ut),this._root=ut),lt&&(Fe?ut.right=lt:this._root=lt,lt.parent=ut),this._size--}},d.prototype.pop=function(){var ie=this._root,re=null;if(ie){for(;ie.left;)ie=ie.left;re={key:ie.key,data:ie.data},this.remove(ie.key)}return re},d.prototype.next=function(ie){var re=ie;if(re)if(re.right)for(re=re.right;re&&re.left;)re=re.left;else for(re=ie.parent;re&&re.right===ie;)ie=re,re=re.parent;return re},d.prototype.prev=function(ie){var re=ie;if(re)if(re.left)for(re=re.left;re&&re.right;)re=re.right;else for(re=ie.parent;re&&re.left===ie;)ie=re,re=re.parent;return re},d.prototype.forEach=function(ie){for(var re=this._root,Fe=[],lt=!1,ut=0;!lt;)re?(Fe.push(re),re=re.left):Fe.length>0?(ie(re=Fe.pop(),ut++),re=re.right):lt=!0;return this},d.prototype.range=function(ie,re,Fe,lt){for(var ut=[],pt=this._compare,St=this._root;0!==ut.length||St;)if(St)ut.push(St),St=St.left;else{if(pt((St=ut.pop()).key,re)>0)break;if(pt(St.key,ie)>=0&&Fe.call(lt,St))return this;St=St.right}return this},d.prototype.keys=function(){for(var ie=this._root,re=[],Fe=[],lt=!1;!lt;)ie?(re.push(ie),ie=ie.left):re.length>0?(ie=re.pop(),Fe.push(ie.key),ie=ie.right):lt=!0;return Fe},d.prototype.values=function(){for(var ie=this._root,re=[],Fe=[],lt=!1;!lt;)ie?(re.push(ie),ie=ie.left):re.length>0?(ie=re.pop(),Fe.push(ie.data),ie=ie.right):lt=!0;return Fe},d.prototype.at=function(ie){for(var re=this._root,Fe=[],lt=!1,ut=0;!lt;)if(re)Fe.push(re),re=re.left;else if(Fe.length>0){if(re=Fe.pop(),ut===ie)return re;ut++,re=re.right}else lt=!0;return null},d.prototype.load=function(ie,re,Fe){if(void 0===ie&&(ie=[]),void 0===re&&(re=[]),void 0===Fe&&(Fe=!1),0!==this._size)throw new Error("bulk-load: tree is not empty");var lt=ie.length;return Fe&&x(ie,re,0,lt-1,this._compare),this._root=g(null,ie,re,0,lt),this._size=lt,this},d.prototype.min=function(){var ie=this.minNode(this._root);return ie?ie.key:null},d.prototype.max=function(){var ie=this.maxNode(this._root);return ie?ie.key:null},d.prototype.isEmpty=function(){return null===this._root},m.size.get=function(){return this._size},d.createTree=function(ie,re,Fe,lt,ut){return new d(Fe,ut).load(ie,re,lt)},Object.defineProperties(d.prototype,m);var w=0,T=1,C=2,A=3,M=0,k=1,F=2,V=3;function j(ie,re,Fe){null===re?(ie.inOut=!1,ie.otherInOut=!0):(ie.isSubject===re.isSubject?(ie.inOut=!re.inOut,ie.otherInOut=re.otherInOut):(ie.inOut=!re.otherInOut,ie.otherInOut=re.isVertical()?!re.inOut:re.inOut),re&&(ie.prevInResult=!W(re,Fe)||re.isVertical()?re.prevInResult:re));var lt=W(ie,Fe);ie.resultTransition=lt?function(ut,pt){var St,Ut=!ut.inOut,wn=!ut.otherInOut;switch(pt){case M:St=Ut&&wn;break;case k:St=Ut||wn;break;case V:St=Ut^wn;break;case F:St=ut.isSubject?Ut&&!wn:wn&&!Ut}return St?1:-1}(ie,Fe):0}function W(ie,re){switch(ie.type){case w:switch(re){case M:return!ie.otherInOut;case k:return ie.otherInOut;case F:return ie.isSubject&&ie.otherInOut||!ie.isSubject&&!ie.otherInOut;case V:return!0}break;case C:return re===M||re===k;case A:return re===F;case T:return!1}return!1}var Q=function(ie,re,Fe,lt,ut){this.left=re,this.point=ie,this.otherEvent=Fe,this.isSubject=lt,this.type=ut||w,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},K={inResult:{configurable:!0}};function te(ie,re){return ie[0]===re[0]&&ie[1]===re[1]}Q.prototype.isBelow=function(ie){var re=this.point,Fe=this.otherEvent.point;return this.left?(re[0]-ie[0])*(Fe[1]-ie[1])-(Fe[0]-ie[0])*(re[1]-ie[1])>0:(Fe[0]-ie[0])*(re[1]-ie[1])-(re[0]-ie[0])*(Fe[1]-ie[1])>0},Q.prototype.isAbove=function(ie){return!this.isBelow(ie)},Q.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},K.inResult.get=function(){return 0!==this.resultTransition},Q.prototype.clone=function(){var ie=new Q(this.point,this.left,this.otherEvent,this.isSubject,this.type);return ie.contourId=this.contourId,ie.resultTransition=this.resultTransition,ie.prevInResult=this.prevInResult,ie.isExteriorRing=this.isExteriorRing,ie.inOut=this.inOut,ie.otherInOut=this.otherInOut,ie},Object.defineProperties(Q.prototype,K);var me=11102230246251565e-32,he=134217729,fe=(3+8*me)*me;function xe(ie,re,Fe,lt,ut){var pt,St,Ut,wn,Ht=re[0],hn=lt[0],si=0,$i=0;hn>Ht==hn>-Ht?(pt=Ht,Ht=re[++si]):(pt=hn,hn=lt[++$i]);var en=0;if(si<ie&&$i<Fe)for(hn>Ht==hn>-Ht?(Ut=pt-((St=Ht+pt)-Ht),Ht=re[++si]):(Ut=pt-((St=hn+pt)-hn),hn=lt[++$i]),pt=St,0!==Ut&&(ut[en++]=Ut);si<ie&&$i<Fe;)hn>Ht==hn>-Ht?(Ut=pt-((St=pt+Ht)-(wn=St-pt))+(Ht-wn),Ht=re[++si]):(Ut=pt-((St=pt+hn)-(wn=St-pt))+(hn-wn),hn=lt[++$i]),pt=St,0!==Ut&&(ut[en++]=Ut);for(;si<ie;)Ut=pt-((St=pt+Ht)-(wn=St-pt))+(Ht-wn),Ht=re[++si],pt=St,0!==Ut&&(ut[en++]=Ut);for(;$i<Fe;)Ut=pt-((St=pt+hn)-(wn=St-pt))+(hn-wn),hn=lt[++$i],pt=St,0!==Ut&&(ut[en++]=Ut);return 0===pt&&0!==en||(ut[en++]=pt),en}function Ee(ie){return new Float64Array(ie)}var Ve=33306690738754716e-32,Ie=22204460492503146e-32,Ue=11093356479670487e-47,ot=Ee(4),$e=Ee(8),Ke=Ee(12),nt=Ee(16),Ne=Ee(4);function Qe(ie,re,Fe){var lt=function(ut,pt,St,Ut,wn,Ht){var hn=(pt-Ht)*(St-wn),si=(ut-wn)*(Ut-Ht),$i=hn-si;if(0===hn||0===si||hn>0!=si>0)return $i;var en=Math.abs(hn+si);return Math.abs($i)>=Ve*en?$i:-function(Pi,ai,Vn,Wn,Ri,hi,gi){var ii,ln,ri,zi,jt,Cn,Ci,Xi,fi,Mr,ui,Dr,Lo,lo,Jr,hs,uc,ur,xr=Pi-Ri,Eo=Vn-Ri,$o=ai-hi,ko=Wn-hi;ot[0]=(Jr=(Xi=xr-(Ci=(Cn=he*xr)-(Cn-xr)))*(Mr=ko-(fi=(Cn=he*ko)-(Cn-ko)))-((lo=xr*ko)-Ci*fi-Xi*fi-Ci*Mr))-((ui=Jr-(uc=(Xi=$o-(Ci=(Cn=he*$o)-(Cn-$o)))*(Mr=Eo-(fi=(Cn=he*Eo)-(Cn-Eo)))-((hs=$o*Eo)-Ci*fi-Xi*fi-Ci*Mr)))+(jt=Jr-ui))+(jt-uc),ot[1]=(Lo=lo-((Dr=lo+ui)-(jt=Dr-lo))+(ui-jt))-((ui=Lo-hs)+(jt=Lo-ui))+(jt-hs),ot[2]=Dr-((ur=Dr+ui)-(jt=ur-Dr))+(ui-jt),ot[3]=ur;var pu=function(UD,U1){for(var xT=U1[0],H1=1;H1<4;H1++)xT+=U1[H1];return xT}(0,ot),Tp=Ie*gi;if(pu>=Tp||-pu>=Tp||(ii=Pi-(xr+(jt=Pi-xr))+(jt-Ri),ri=Vn-(Eo+(jt=Vn-Eo))+(jt-Ri),ln=ai-($o+(jt=ai-$o))+(jt-hi),zi=Wn-(ko+(jt=Wn-ko))+(jt-hi),0===ii&&0===ln&&0===ri&&0===zi)||(Tp=Ue*gi+fe*Math.abs(pu),(pu+=xr*zi+ko*ii-($o*ri+Eo*ln))>=Tp||-pu>=Tp))return pu;Ne[0]=(Jr=(Xi=ii-(Ci=(Cn=he*ii)-(Cn-ii)))*(Mr=ko-(fi=(Cn=he*ko)-(Cn-ko)))-((lo=ii*ko)-Ci*fi-Xi*fi-Ci*Mr))-((ui=Jr-(uc=(Xi=ln-(Ci=(Cn=he*ln)-(Cn-ln)))*(Mr=Eo-(fi=(Cn=he*Eo)-(Cn-Eo)))-((hs=ln*Eo)-Ci*fi-Xi*fi-Ci*Mr)))+(jt=Jr-ui))+(jt-uc),Ne[1]=(Lo=lo-((Dr=lo+ui)-(jt=Dr-lo))+(ui-jt))-((ui=Lo-hs)+(jt=Lo-ui))+(jt-hs),Ne[2]=Dr-((ur=Dr+ui)-(jt=ur-Dr))+(ui-jt),Ne[3]=ur;var V1=xe(4,ot,4,Ne,$e);Ne[0]=(Jr=(Xi=xr-(Ci=(Cn=he*xr)-(Cn-xr)))*(Mr=zi-(fi=(Cn=he*zi)-(Cn-zi)))-((lo=xr*zi)-Ci*fi-Xi*fi-Ci*Mr))-((ui=Jr-(uc=(Xi=$o-(Ci=(Cn=he*$o)-(Cn-$o)))*(Mr=ri-(fi=(Cn=he*ri)-(Cn-ri)))-((hs=$o*ri)-Ci*fi-Xi*fi-Ci*Mr)))+(jt=Jr-ui))+(jt-uc),Ne[1]=(Lo=lo-((Dr=lo+ui)-(jt=Dr-lo))+(ui-jt))-((ui=Lo-hs)+(jt=Lo-ui))+(jt-hs),Ne[2]=Dr-((ur=Dr+ui)-(jt=ur-Dr))+(ui-jt),Ne[3]=ur;var vT=xe(V1,$e,4,Ne,Ke);Ne[0]=(Jr=(Xi=ii-(Ci=(Cn=he*ii)-(Cn-ii)))*(Mr=zi-(fi=(Cn=he*zi)-(Cn-zi)))-((lo=ii*zi)-Ci*fi-Xi*fi-Ci*Mr))-((ui=Jr-(uc=(Xi=ln-(Ci=(Cn=he*ln)-(Cn-ln)))*(Mr=ri-(fi=(Cn=he*ri)-(Cn-ri)))-((hs=ln*ri)-Ci*fi-Xi*fi-Ci*Mr)))+(jt=Jr-ui))+(jt-uc),Ne[1]=(Lo=lo-((Dr=lo+ui)-(jt=Dr-lo))+(ui-jt))-((ui=Lo-hs)+(jt=Lo-ui))+(jt-hs),Ne[2]=Dr-((ur=Dr+ui)-(jt=ur-Dr))+(ui-jt),Ne[3]=ur;var j1=xe(vT,Ke,4,Ne,nt);return nt[j1-1]}(ut,pt,St,Ut,wn,Ht,en)}(ie[0],ie[1],re[0],re[1],Fe[0],Fe[1]);return lt>0?-1:lt<0?1:0}function Ce(ie,re){var ut,pt,Fe=ie.point,lt=re.point;return Fe[0]>lt[0]?1:Fe[0]<lt[0]?-1:Fe[1]!==lt[1]?Fe[1]>lt[1]?1:-1:(ut=ie).left!==(pt=re).left?ut.left?1:-1:0!==Qe(Fe,ut.otherEvent.point,pt.otherEvent.point)?ut.isBelow(pt.otherEvent.point)?-1:1:!ut.isSubject&&pt.isSubject?1:-1}function Be(ie,re,Fe){var lt=new Q(re,!1,ie,ie.isSubject),ut=new Q(re,!0,ie.otherEvent,ie.isSubject);return te(ie.point,ie.otherEvent.point)&&console.warn("what is that, a collapsed segment?",ie),lt.contourId=ut.contourId=ie.contourId,Ce(ut,ie.otherEvent)>0&&(ie.otherEvent.left=!0,ut.left=!1),ie.otherEvent.otherEvent=ut,ie.otherEvent=lt,Fe.push(ut),Fe.push(lt),Fe}function at(ie,re){return ie[0]*re[1]-ie[1]*re[0]}function et(ie,re){return ie[0]*re[0]+ie[1]*re[1]}function Ot(ie,re,Fe){var lt=function(wn,Ht,hn,si,$i){var en=[Ht[0]-wn[0],Ht[1]-wn[1]],Pi=[si[0]-hn[0],si[1]-hn[1]];function ai(Cn,Ci,Xi){return[Cn[0]+Ci*Xi[0],Cn[1]+Ci*Xi[1]]}var Vn=[hn[0]-wn[0],hn[1]-wn[1]],Wn=at(en,Pi),Ri=Wn*Wn,hi=et(en,en);if(Ri>0){var gi=at(Vn,Pi)/Wn;if(gi<0||gi>1)return null;var ii=at(Vn,en)/Wn;return ii<0||ii>1?null:0===gi||1===gi?[ai(wn,gi,en)]:0===ii||1===ii?[ai(hn,ii,Pi)]:[ai(wn,gi,en)]}if((Ri=(Wn=at(Vn,en))*Wn)>0)return null;var ln=et(en,Vn)/hi,ri=ln+et(en,Pi)/hi,zi=Math.min(ln,ri),jt=Math.max(ln,ri);return zi<=1&&jt>=0?1===zi?[ai(wn,zi>0?zi:0,en)]:0===jt?[ai(wn,jt<1?jt:1,en)]:[ai(wn,zi>0?zi:0,en),ai(wn,jt<1?jt:1,en)]:null}(ie.point,ie.otherEvent.point,re.point,re.otherEvent.point),ut=lt?lt.length:0;if(0===ut||1===ut&&(te(ie.point,re.point)||te(ie.otherEvent.point,re.otherEvent.point))||2===ut&&ie.isSubject===re.isSubject)return 0;if(1===ut)return te(ie.point,lt[0])||te(ie.otherEvent.point,lt[0])||Be(ie,lt[0],Fe),te(re.point,lt[0])||te(re.otherEvent.point,lt[0])||Be(re,lt[0],Fe),1;var pt=[],St=!1,Ut=!1;return te(ie.point,re.point)?St=!0:1===Ce(ie,re)?pt.push(re,ie):pt.push(ie,re),te(ie.otherEvent.point,re.otherEvent.point)?Ut=!0:1===Ce(ie.otherEvent,re.otherEvent)?pt.push(re.otherEvent,ie.otherEvent):pt.push(ie.otherEvent,re.otherEvent),St&&Ut||St?(re.type=T,ie.type=re.inOut===ie.inOut?C:A,St&&!Ut&&Be(pt[1].otherEvent,pt[0].point,Fe),2):Ut?(Be(pt[0],pt[1].point,Fe),3):pt[0]!==pt[3].otherEvent?(Be(pt[0],pt[1].point,Fe),Be(pt[1],pt[2].point,Fe),3):(Be(pt[0],pt[1].point,Fe),Be(pt[3].otherEvent,pt[2].point,Fe),3)}function Tt(ie,re){if(ie===re)return 0;if(0!==Qe(ie.point,ie.otherEvent.point,re.point)||0!==Qe(ie.point,ie.otherEvent.point,re.otherEvent.point))return te(ie.point,re.point)?ie.isBelow(re.otherEvent.point)?-1:1:ie.point[0]===re.point[0]?ie.point[1]<re.point[1]?-1:1:1===Ce(ie,re)?re.isAbove(ie.point)?-1:1:ie.isBelow(re.point)?-1:1;if(ie.isSubject!==re.isSubject)return ie.isSubject?-1:1;var Fe=ie.point,lt=re.point;return Fe[0]===lt[0]&&Fe[1]===lt[1]?(Fe=ie.otherEvent.point)[0]===(lt=re.otherEvent.point)[0]&&Fe[1]===lt[1]?0:ie.contourId>re.contourId?1:-1:1===Ce(ie,re)?1:-1}var Xe=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function tt(ie,re,Fe,lt){var ut,pt=ie+1,St=re[ie].point,Ut=re.length;for(pt<Ut&&(ut=re[pt].point);pt<Ut&&ut[0]===St[0]&&ut[1]===St[1];){if(!Fe[pt])return pt;++pt<Ut&&(ut=re[pt].point)}for(pt=ie-1;Fe[pt]&&pt>lt;)pt--;return pt}Xe.prototype.isExterior=function(){return null==this.holeOf};var Dt=ft,yt=ft;function ft(ie,re){if(!(this instanceof ft))return new ft(ie,re);if(this.data=ie||[],this.length=this.data.length,this.compare=re||xt,this.length>0)for(var Fe=(this.length>>1)-1;Fe>=0;Fe--)this._down(Fe)}function xt(ie,re){return ie<re?-1:ie>re?1:0}ft.prototype={push:function(ie){this.data.push(ie),this.length++,this._up(this.length-1)},pop:function(){if(0!==this.length){var ie=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),ie}},peek:function(){return this.data[0]},_up:function(ie){for(var re=this.data,Fe=this.compare,lt=re[ie];ie>0;){var ut=ie-1>>1,pt=re[ut];if(Fe(lt,pt)>=0)break;re[ie]=pt,ie=ut}re[ie]=lt},_down:function(ie){for(var re=this.data,Fe=this.compare,lt=this.length>>1,ut=re[ie];ie<lt;){var pt=1+(ie<<1),St=pt+1,Ut=re[pt];if(St<this.length&&Fe(re[St],Ut)<0&&(pt=St,Ut=re[St]),Fe(Ut,ut)>=0)break;re[ie]=Ut,ie=pt}re[ie]=ut}},Dt.default=yt;var zt=Math.max,$t=Math.min,nn=0;function Xt(ie,re,Fe,lt,ut,pt){var St,Ut,wn,Ht,hn,si;for(St=0,Ut=ie.length-1;St<Ut;St++)if(Ht=ie[St+1],hn=new Q(wn=ie[St],!1,void 0,re),si=new Q(Ht,!1,hn,re),hn.otherEvent=si,wn[0]!==Ht[0]||wn[1]!==Ht[1]){hn.contourId=si.contourId=Fe,pt||(hn.isExteriorRing=!1,si.isExteriorRing=!1),Ce(hn,si)>0?si.left=!0:hn.left=!0;var $i=wn[0],en=wn[1];ut[0]=$t(ut[0],$i),ut[1]=$t(ut[1],en),ut[2]=zt(ut[2],$i),ut[3]=zt(ut[3],en),lt.push(hn),lt.push(si)}}var vn=[];function dn(ie,re,Fe){"number"==typeof ie[0][0][0]&&(ie=[ie]),"number"==typeof re[0][0][0]&&(re=[re]);var en,Pi,ai,Vn,lt=(ai=Fe,Vn=null,(en=ie).length*(Pi=re).length==0&&(ai===M?Vn=vn:ai===F?Vn=en:ai!==k&&ai!==V||(Vn=0===en.length?Pi:en)),Vn);if(lt)return lt===vn?null:lt;var ut=[1/0,1/0,-1/0,-1/0],pt=[1/0,1/0,-1/0,-1/0],St=function(en,Pi,ai,Vn,Wn){var Ri,hi,gi,ii,ln,ri,zi=new Dt(null,Ce);for(gi=0,ii=en.length;gi<ii;gi++)for(ln=0,ri=(Ri=en[gi]).length;ln<ri;ln++)(hi=0===ln)&&nn++,Xt(Ri[ln],!0,nn,zi,ai,hi);for(gi=0,ii=Pi.length;gi<ii;gi++)for(ln=0,ri=(Ri=Pi[gi]).length;ln<ri;ln++)hi=0===ln,Wn===F&&(hi=!1),hi&&nn++,Xt(Ri[ln],!1,nn,zi,Vn,hi);return zi}(ie,re,ut,pt,Fe);if(lt=function(en,Pi,ai,Vn,Wn){var Ri=null;return(ai[0]>Vn[2]||Vn[0]>ai[2]||ai[1]>Vn[3]||Vn[1]>ai[3])&&(Wn===M?Ri=vn:Wn===F?Ri=en:Wn!==k&&Wn!==V||(Ri=en.concat(Pi))),Ri}(ie,re,ut,pt,Fe))return lt===vn?null:lt;for(var Ut=function(en){var Pi,ai,Vn=function(gi){var ii,ln,ri,zi,jt=[];for(ln=0,ri=gi.length;ln<ri;ln++)((ii=gi[ln]).left&&ii.inResult||!ii.left&&ii.otherEvent.inResult)&&jt.push(ii);for(var Cn=!1;!Cn;)for(Cn=!0,ln=0,ri=jt.length;ln<ri;ln++)ln+1<ri&&1===Ce(jt[ln],jt[ln+1])&&(zi=jt[ln],jt[ln]=jt[ln+1],jt[ln+1]=zi,Cn=!1);for(ln=0,ri=jt.length;ln<ri;ln++)(ii=jt[ln]).otherPos=ln;for(ln=0,ri=jt.length;ln<ri;ln++)(ii=jt[ln]).left||(zi=ii.otherPos,ii.otherPos=ii.otherEvent.otherPos,ii.otherEvent.otherPos=zi);return jt}(en),Wn={},Ri=[],hi=function(){if(!Wn[Pi]){var gi=Ri.length,ii=function(jt,Cn,Ci){var Xi=new Xe;if(null!=jt.prevInResult){var fi=jt.prevInResult,Mr=fi.outputContourId;if(fi.resultTransition>0){var ui=Cn[Mr];if(null!=ui.holeOf){var Dr=ui.holeOf;Cn[Dr].holeIds.push(Ci),Xi.holeOf=Dr,Xi.depth=Cn[Mr].depth}else Cn[Mr].holeIds.push(Ci),Xi.holeOf=Mr,Xi.depth=Cn[Mr].depth+1}else Xi.holeOf=null,Xi.depth=Cn[Mr].depth}else Xi.holeOf=null,Xi.depth=0;return Xi}(Vn[Pi],Ri,gi),ln=function(jt){Wn[jt]=!0,jt<Vn.length&&Vn[jt]&&(Vn[jt].outputContourId=gi)},ri=Pi,zi=Pi;for(ii.points.push(Vn[Pi].point);ln(ri),ln(ri=Vn[ri].otherPos),ii.points.push(Vn[ri].point),!((ri=tt(ri,Vn,Wn,zi))==zi||ri>=Vn.length)&&Vn[ri];);Ri.push(ii)}};for(Pi=0,ai=Vn.length;Pi<ai;Pi++)hi();return Ri}(function(en,Pi,ai,Vn,Wn,Ri){for(var hi,gi,ii,ln=new d(Tt),ri=[],zi=Math.min(Vn[2],Wn[2]);0!==en.length;){var jt=en.pop();if(ri.push(jt),Ri===M&&jt.point[0]>zi||Ri===F&&jt.point[0]>Vn[2])break;if(jt.left){gi=hi=ln.insert(jt),hi=hi!==(ii=ln.minNode())?ln.prev(hi):null,gi=ln.next(gi);var Cn=hi?hi.key:null;if(j(jt,Cn,Ri),gi&&2===Ot(jt,gi.key,en)&&(j(jt,Cn,Ri),j(gi.key,jt,Ri)),hi&&2===Ot(hi.key,jt,en)){var Ci=hi;j(Cn,(Ci=Ci!==ii?ln.prev(Ci):null)?Ci.key:null,Ri),j(jt,Cn,Ri)}}else gi=hi=ln.find(jt=jt.otherEvent),hi&&gi&&(hi=hi!==ii?ln.prev(hi):null,gi=ln.next(gi),ln.remove(jt),gi&&hi&&Ot(hi.key,gi.key,en))}return ri}(St,0,0,ut,pt,Fe)),wn=[],Ht=0;Ht<Ut.length;Ht++){var hn=Ut[Ht];if(hn.isExterior()){for(var si=[hn.points],$i=0;$i<hn.holeIds.length;$i++)si.push(Ut[hn.holeIds[$i]].points);wn.push(si)}}return wn}var ni={UNION:k,DIFFERENCE:F,INTERSECTION:M,XOR:V};o.diff=function(ie,re){return dn(ie,re,F)},o.intersection=function(ie,re){return dn(ie,re,M)},o.operations=ni,o.union=function(ie,re){return dn(ie,re,k)},o.xor=function(ie,re){return dn(ie,re,V)},Object.defineProperty(o,"__esModule",{value:!0})}(b_.exports)),b_.exports);function w_(s,e,o,c){const d=[],m=0===c?(g,x,w,T,C,A)=>{g.push(new Je(A,w+(A-x)/(T-x)*(C-w)))}:(g,x,w,T,C,A)=>{g.push(new Je(x+(A-w)/(C-w)*(T-x),A))};for(const g of s){const x=[];for(const w of g){if(w.length<=2)continue;const T=[];for(let M=0;M<w.length-1;M++){const k=w[M].x,F=w[M].y,V=w[M+1].x,j=w[M+1].y,W=0===c?k:F,Q=0===c?V:j;W<e?Q>e&&m(T,k,F,V,j,e):W>o?Q<o&&m(T,k,F,V,j,o):T.push(w[M]),Q<e&&W>=e&&m(T,k,F,V,j,e),Q>o&&W<=o&&m(T,k,F,V,j,o)}let C=w[w.length-1];const A=0===c?C.x:C.y;A>=e&&A<=o&&T.push(C),T.length&&(C=T[T.length-1],T[0].x===C.x&&T[0].y===C.y||T.push(T[0]),x.push(T))}x.length&&d.push(x)}return d}function Qw(s,e){const o=Ov(s),c=Ov([e]),d=Sh.intersection(o,c);return null==d?[]:E_(d)}function SD(s,e){let c=Ov(s,65536);for(;e.valid();e.next()){const[d,m]=e.get(),g=65536*d.x,x=65536*d.y,w=65536*m.x,T=65536*m.y,C=w-g,A=T-x,M=Math.hypot(C,A),k=Math.trunc(A/M*3),F=-Math.trunc(C/M*3);c=Sh.diff(c,[[[g,x],[w,T],[w+k,T+F],[g+k,x+F],[g,x]]])}return E_(c,1/65536)}function Ov(s,e=1){return[s.map(o=>o.map(c=>[c.x*e,c.y*e]))]}function E_(s,e=1){return s.map(o=>o.map((c,d)=>{const m=c.map(g=>new Je(g[0]*e,g[1]*e).round());return d>0&&m.reverse(),m}))}class Lv{constructor(e,o){this.layoutVertexArray=new xs,this.indexArray=new Mi,this.lineIndexArray=new ha,this.triangleSegments=new Gi,this.lineSegments=new Gi,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,o&&(this.elevatedLayoutVertexArray=new os)}update(e,o,c,d,m,g,x,w){this.programConfigurations.updatePaintArrays(e,o,m,c,d,g,x,w)}isEmpty(){return 0===this.layoutVertexArray.length}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,qw.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Ww.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,o,c,d,m,g,x){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,c,d,m,g,void 0,x)}}class od{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new Lv(e,!1),this.elevationBufferData=new Lv(e,!0),this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,o){}populate(e,o,c,d){this.hasPattern=x_("fill",this.layers,this.pixelRatio,o);const m=this.layers[0].layout.get("fill-sort-key"),g=[];for(const{feature:x,id:w,index:T,sourceLayerIndex:C}of e){const A=this.layers[0]._featureFilter.needGeometry,M=ze(x,A);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),M,c))continue;const k=m?m.evaluate(M,{},c,o.availableImages):void 0,F={id:w,properties:x.properties,type:x.type,sourceLayerIndex:C,index:T,geometry:A?M.geometry:_e(x,c,d),patterns:{},sortKey:k};g.push(F)}m&&g.sort((x,w)=>x.sortKey-w.sortKey);for(const x of g){const{geometry:w,index:T,sourceLayerIndex:C}=x;if(this.hasPattern){const A=Rv("fill",this.layers,x,this.zoom,this.pixelRatio,o);this.patternFeatures.push(A)}else this.addFeature(x,w,T,c,{},o.availableImages,o.brightness,o.elevationFeatures);o.featureIndex.insert(e[T].feature,w,T,C,this.index)}}update(e,o,c,d,m,g,x){this.bufferData.update(e,o,c,d,m,g,x,this.worldview),this.elevationBufferData.update(e,o,c,d,m,g,x,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,o,c,d,m,g,x,this.worldview)}addFeatures(e,o,c,d,m,g){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,o,c,d,g,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,o,c,d,m,g=[],x,w){const T=Eh(o,500);"none"!==this.elevationMode?this.addElevatedRoadFeature(e,T,d,c,w):this.addGeometry(T,this.bufferData),this.bufferData.populatePaintArrays(e,c,m,g,d,x,this.worldview),this.elevationBufferData.populatePaintArrays(e,c,m,g,d,x,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,o,c,d,m){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(o,c,d,m,this.worldview))}addElevatedRoadFeature(e,o,c,d,m){const g=new Array,x=Fi.getElevationFeature(e,m);if(!x)return void this.addGeometry(o,this.bufferData);{const T=this.clipPolygonsToTile(o,1);T.length>0&&g.push({polygons:T,elevationFeature:x,elevationTileID:c})}const w={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},c),featureIndex:d};for(const T of g)if(T.elevationFeature){if("hd-road-base"===this.elevationMode){this.elevatedStructures||(this.elevatedStructures=new Ts(T.elevationTileID,this.layers,this.zoom,this.lut));const A=T.elevationFeature.isTunnel();let M=0;e.properties.hasOwnProperty("level")&&(M=+e.properties.level);for(const k of T.polygons)this.elevatedStructures.addPortalCandidates(T.elevationFeature.id,k,A,T.elevationFeature,M)}null==T.elevationFeature.constantHeight&&(T.polygons=this.prepareElevatedPolygons(T.polygons,T.elevationFeature,T.elevationTileID));const C=new Mn(c,T.elevationTileID);this.addElevatedGeometry(T.polygons,C,T.elevationFeature,"hd-road-base"===this.elevationMode?0:.05,d,w)}}addElevatedGeometry(e,o,c,d,m,g){const x={elevation:c,elevationSampler:o,bias:d,index:m,featureInfo:g},[w,T]=this.addGeometry(e,this.elevationBufferData,x);null==this.elevationBufferData.heightRange?this.elevationBufferData.heightRange={min:w,max:T}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,w),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,T))}addGeometry(e,o,c){let d=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,g=null;c&&(g=c.elevationSampler.constantElevation(c.elevation,c.bias),null!=g&&(d=g,m=g));const x=(w,T,C)=>{if(null!=c)if(T.push(w),null!=g)o.elevatedLayoutVertexArray.emplaceBack(g),C.push(g);else{const A=c.elevationSampler.pointElevation(w,c.elevation,c.bias);o.elevatedLayoutVertexArray.emplaceBack(A),C.push(A),d=Math.min(d,A),m=Math.max(m,A)}};for(const w of e){let T=0;for(const K of w)T+=K.length;const C=o.triangleSegments.prepareSegment(T,o.layoutVertexArray,o.indexArray),A=C.vertexLength,M=[],k=[],F=[],V=[],j=[],W=o.layoutVertexArray.length;for(const K of w){if(0===K.length)continue;K!==w[0]&&k.push(M.length/2);const te=o.lineSegments.prepareSegment(K.length,o.layoutVertexArray,o.lineIndexArray),me=te.vertexLength;c&&j.push(o.layoutVertexArray.length-W),x(K[0],F,V),o.layoutVertexArray.emplaceBack(K[0].x,K[0].y),o.lineIndexArray.emplaceBack(me+K.length-1,me),M.push(K[0].x),M.push(K[0].y);for(let he=1;he<K.length;he++)x(K[he],F,V),o.layoutVertexArray.emplaceBack(K[he].x,K[he].y),o.lineIndexArray.emplaceBack(me+he-1,me+he),M.push(K[he].x),M.push(K[he].y);te.vertexLength+=K.length,te.primitiveLength+=K.length}const Q=yh(M,k);for(let K=0;K<Q.length;K+=3)o.indexArray.emplaceBack(A+Q[K],A+Q[K+1],A+Q[K+2]);if(Q.length>0&&c&&"hd-road-base"===this.elevationMode){const K=c.elevation.isTunnel(),te=c.elevation.safeArea,me=this.elevatedStructures.addVertices(F,V);this.elevatedStructures.addTriangles(Q,me,K);const he=j.length;if(he>0){for(let fe=0;fe<he-1;fe++)this.elevatedStructures.addRenderableRing(c.index,j[fe]+me,j[fe+1]-j[fe],K,te,c.featureInfo);this.elevatedStructures.addRenderableRing(c.index,j[he-1]+me,F.length-j[he-1],K,te,c.featureInfo)}}C.vertexLength+=T,C.primitiveLength+=Q.length/3}return[d,m]}prepareElevatedPolygons(e,o,c){const d=1/ce(c),m=[];for(const g of e){const x=SD(g,new ti(o,d));m.push(...x)}return m}clipPolygonsToTile(e,o){const c=-o,d=-o,m=ht+o,g=ht+o;let x=0;const w=[],T=[];for(;x<e.length;x++){const M=e[x],k=ff(M);(k.min.x>=c&&k.max.x<=m&&k.min.y>=d&&k.max.y<=g?w:T).push(M)}if(w.length===e.length)return e;const C=[new Je(c,d),new Je(m,d),new Je(m,g),new Je(c,g),new Je(c,d)],A=w;for(const M of T)A.push(...Qw(M,C));return A}}let km,T_,kv,Fv;wt(od,"FillBucket",{omit:["layers","patternFeatures"]}),wt(Lv,"FillBufferData"),wt(Ts,"ElevatedStructures");class Fm{constructor(e,o,c,d){if(this.triangleCount=o.length/3,this.min=new Je(0,0),this.max=new Je(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===e.length)return;const[m,g]=[e[0].clone(),e[0].clone()];for(let A=1;A<e.length;++A){const M=e[A];m.x=Math.min(m.x,M.x),m.y=Math.min(m.y,M.y),g.x=Math.max(g.x,M.x),g.y=Math.max(g.y,M.y)}if(d){const A=Math.ceil(Math.max(g.x-m.x,g.y-m.y)/d);c=Math.max(c,A)}if(0===c)return;this.min=m,this.max=g;const x=this.max.sub(this.min);x.x=Math.max(x.x,1),x.y=Math.max(x.y,1);const w=Math.max(x.x,x.y)/c;this.cellsX=Math.max(1,Math.ceil(x.x/w)),this.cellsY=Math.max(1,Math.ceil(x.y/w)),this.xScale=1/w,this.yScale=1/w;const T=[];for(let A=0;A<this.triangleCount;A++){const M=e[o[3*A+0]].sub(this.min),k=e[o[3*A+1]].sub(this.min),F=e[o[3*A+2]].sub(this.min),V=ul(Math.floor(Math.min(M.x,k.x,F.x)),this.xScale,this.cellsX),j=ul(Math.floor(Math.max(M.x,k.x,F.x)),this.xScale,this.cellsX),W=ul(Math.floor(Math.min(M.y,k.y,F.y)),this.yScale,this.cellsY),Q=ul(Math.floor(Math.max(M.y,k.y,F.y)),this.yScale,this.cellsY),K=new Je(0,0),te=new Je(0,0),me=new Je(0,0),he=new Je(0,0);for(let fe=W;fe<=Q;++fe){K.y=te.y=fe*w,me.y=he.y=(fe+1)*w;for(let xe=V;xe<=j;++xe)K.x=me.x=xe*w,te.x=he.x=(xe+1)*w,(vr(M,k,F,K,te,he)||vr(M,k,F,K,he,me))&&T.push({cellIdx:fe*this.cellsX+xe,triIdx:A})}}if(0===T.length)return;T.sort((A,M)=>A.cellIdx-M.cellIdx||A.triIdx-M.triIdx);let C=0;for(;C<T.length;){const A=T[C].cellIdx,M={start:this.payload.length,len:0};for(;C<T.length&&T[C].cellIdx===A;)++M.len,this.payload.push(T[C++].triIdx);this.cells[A]=M}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,o){if(0===this.triangleCount||0===this.cells.length||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const c=ul(e.x-this.min.x,this.xScale,this.cellsX),d=ul(e.y-this.min.y,this.yScale,this.cellsY),m=this.cells[d*this.cellsX+c];if(m){this._lazyInitLookup();for(let g=0;g<m.len;g++){const x=this.payload[m.start+g],w=Math.floor(x/8),T=1<<x%8;if(!(this.lookup[w]&T)&&(this.lookup[w]|=T,o.push(x),o.length===this.triangleCount))return}}}query(e,o,c){if(0===this.triangleCount||0===this.cells.length||e.x>this.max.x||this.min.x>o.x||e.y>this.max.y||this.min.y>o.y)return;this._lazyInitLookup();const d=ul(e.x-this.min.x,this.xScale,this.cellsX),m=ul(o.x-this.min.x,this.xScale,this.cellsX),g=ul(e.y-this.min.y,this.yScale,this.cellsY),x=ul(o.y-this.min.y,this.yScale,this.cellsY);for(let w=g;w<=x;w++)for(let T=d;T<=m;T++){const C=this.cells[w*this.cellsX+T];if(C)for(let A=0;A<C.len;A++){const M=this.payload[C.start+A],k=Math.floor(M/8),F=1<<M%8;if(!(this.lookup[k]&F)&&(this.lookup[k]|=F,c.push(M),c.length===this.triangleCount))return}}}}function ul(s,e,o){return Math.max(0,Math.min(o-1,Math.floor(s*e)))}wt(Fm,"TriangleGridIndex");class nb{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,o){for(const c of this.footprints)o.push({footprint:c,id:e})}populate(e,o,c,d){const m=[];for(const{feature:g,id:x,index:w,sourceLayerIndex:T}of e){const C=this.layers[0]._featureFilter.needGeometry,A=ze(g,C);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),A,c))continue;const M={id:x,properties:g.properties,type:g.type,sourceLayerIndex:T,index:w,geometry:C?A.geometry:_e(g,c,d),patterns:{}};m.push(M)}for(const g of m){const{geometry:x,index:w,sourceLayerIndex:T}=g;this.addFeature(g,x,w,c,{},o.availableImages,o.brightness),o.featureIndex.insert(e[w].feature,x,w,T,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(e){}update(e,o,c,d,m,g,x){}destroy(){}addFeature(e,o,c,d,m,g=[],x){for(const w of Eh(o,2)){const T=[],C=[],A=[],M=new Je(1/0,1/0),k=new Je(-1/0,-1/0);for(const j of w)if(0!==j.length){j!==w[0]&&A.push(C.length/2);for(let W=0;W<j.length;W++)C.push(j[W].x),C.push(j[W].y),T.push(j[W]),M.x=Math.min(M.x,j[W].x),M.y=Math.min(M.y,j[W].y),k.x=Math.max(k.x,j[W].x),k.y=Math.max(k.y,j[W].y)}const F=yh(C,A),V=new Fm(T,F,8,256);this.footprints.push({vertices:T,indices:F,grid:V,min:M,max:k})}}}wt(nb,"ClipBucket",{omit:["layers"]});const Jw=En([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),eE=En([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),tE=En([{name:"a_centroid_pos",components:2,type:"Uint16"}]),nE=En([{name:"a_join_normal_inside",components:3,type:"Int16"}]),sd=En([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),zm=En([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:iE}=Jw,S_=Number.MAX_SAFE_INTEGER,rE=S_-1;function oE(s,e,o,c){return s.order<e||s.order===S_||!(s.clipMask&o)||(d=c,0!==(m=s.clipScope).length&&void 0===m.find(g=>g===d));var d,m}function zv(s,e){return s.x-e.x||s.y-e.y}function sE(s,e){return 0===zv(s.min,e.min)&&0===zv(s.max,e.max)}function D_(s,e){return!(s.min.x>e.max.x||s.max.x<e.min.x||s.min.y>e.max.y||s.max.y<e.min.y)}function I_(s,e){if(s.length!==e.length)return!1;for(let o=0;o<s.length;o++)if(s[o].sourceId!==e[o].sourceId||!sE(s[o],e[o])||s[o].order!==e[o].order||s[o].clipMask!==e[o].clipMask||!Ga(s[o].clipScope,e[o].clipScope))return!1;return!0}function ib(s,e,o){const c=1/ht,d=1/(1<<o.canonical.z),m=(e.x*c+o.canonical.x)*d+o.wrap,g=(e.y*c+o.canonical.y)*d;return{min:new Je((s.x*c+o.canonical.x)*d+o.wrap,(s.y*c+o.canonical.y)*d),max:new Je(m,g)}}function aE(s,e,o){const c=1<<o.canonical.z,d=((e.x-o.wrap)*c-o.canonical.x)*ht,m=(e.y*c-o.canonical.y)*ht;return{min:new Je(((s.x-o.wrap)*c-o.canonical.x)*ht,(s.y*c-o.canonical.y)*ht),max:new Je(d,m)}}function Nv(s,e,o,c,d,m,g){const x=s.indices,w=s.vertices,T=[];for(let C=c;C<c+d;C+=3){const A=e[o[C+0]+m],M=e[o[C+1]+m],k=e[o[C+2]+m],F=Math.min(A.x,M.x,k.x),V=Math.max(A.x,M.x,k.x),j=Math.min(A.y,M.y,k.y),W=Math.max(A.y,M.y,k.y);T.length=0,s.grid.query(new Je(F,j),new Je(V,W),T);for(let Q=0;Q<T.length;Q++){const K=T[Q];if(vr(w[x[3*K+0]],w[x[3*K+1]],w[x[3*K+2]],A,M,k,g))return!0}}return!1}function C_(s,e,o,c){if(!s||!o)return!1;let d=s.vertices;if(!e.canonical.equals(c.canonical)||e.wrap!==c.wrap){if(o.vertices.length<s.vertices.length)return C_(o,c,s,e);const m=e.canonical,g=c.canonical,x=Math.pow(2,g.z-m.z);d=s.vertices.map(w=>new Je((w.x+m.x*ht)*x-g.x*ht,(w.y+m.y*ht)*x-g.y*ht))}return Nv(o,d,s.indices,0,s.indices.length,0,0)}function rc(s,e,o,c){const d=Math.pow(2,c.z-o.z);return new Je((s+o.x*ht)*d-c.x*ht,(e+o.y*ht)*d-c.y*ht)}function Dh(s,e){const o=[];e.grid.queryPoint(s,o);const c=e.indices,d=e.vertices;for(let m=0;m<o.length;m++){const g=o[m];if(wo([d[c[3*g+0]],d[c[3*g+1]],d[c[3*g+2]]],s))return!0}return!1}const A_=[new Je(0,0),new Je(ht,0),new Je(ht,ht),new Je(0,ht)];function Bv(s,e){const o=[];let c=[];if(!e||s.length<2)return[s];if(2===s.length)return Ji(s[0],s[1],A_)?[s]:[];for(let d=0;d<s.length+2;d++){const m=s[d%s.length],g=s[(d+1)%s.length],x=Ji(0===d?s[s.length-1]:s[(d-1)%s.length],m,A_),w=Ji(m,g,A_),T=x||w;T&&c.push(m),T&&w||c.length>0&&(c.length>1&&o.push(c),c=[])}return c.length>1&&o.push(c),o}const M_=Re.types,DD=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],ID=["fill-extrusion-flood-light-ground-radius"],CD=Math.pow(2,13),Vv=Math.pow(2,15)-1,P_=new Je(0,1),Ih=2147483648;function R_(s,e,o,c,d,m,g,x){s.emplaceBack((e<<1)+g,(o<<1)+m,(Math.floor(c*CD)<<1)+d,Math.round(x))}function Gf(s,e,o){s.emplaceBack(e.x*ht,e.y*ht,o?1:0)}function O_(s,e,o,c,d,m){s.emplaceBack(e.x,e.y,(o.x<<1)+c,(o.y<<1)+d,m)}function Nm(s,e,o){s.emplaceBack(e.x,e.y,e.z,16384*o[0],16384*o[1],16384*o[2])}class rb{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class ob{constructor(){this.centroidXY=new Je(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Je(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Je(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Je(this.max.x-this.min.x,this.max.y-this.min.y)}}class jv{constructor(){this.acc=new Je(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,o){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=o.x,e.min.y=e.max.y=o.y)}appendEdge(e,o,c){this.accCount++,this.acc._add(o);let d=!!this.borders;o.x<e.min.x?(e.min.x=o.x,d=!0):o.x>e.max.x&&(e.max.x=o.x,d=!0),o.y<e.min.y?(e.min.y=o.y,d=!0):o.y>e.max.y&&(e.max.y=o.y,d=!0),((0===o.x||o.x===ht)&&o.x===c.x)!=((0===o.y||o.y===ht)&&o.y===c.y)&&this.processBorderOverlap(o,c),d&&this.checkBorderIntersection(o,c)}checkBorderIntersection(e,o){o.x<0!=e.x<0&&this.addBorderIntersection(0,Ft(o.y,e.y,(0-o.x)/(e.x-o.x))),o.x>ht!=e.x>ht&&this.addBorderIntersection(1,Ft(o.y,e.y,(ht-o.x)/(e.x-o.x))),o.y<0!=e.y<0&&this.addBorderIntersection(2,Ft(o.x,e.x,(0-o.y)/(e.y-o.y))),o.y>ht!=e.y>ht&&this.addBorderIntersection(3,Ft(o.x,e.x,(ht-o.y)/(e.y-o.y)))}addBorderIntersection(e,o){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const c=this.borders[e];o<c[0]&&(c[0]=o),o>c[1]&&(c[1]=o)}processBorderOverlap(e,o){if(e.x===o.x){if(e.y===o.y)return;const c=0===e.x?0:1;this.addBorderIntersection(c,o.y),this.addBorderIntersection(c,e.y)}else{const c=0===e.y?2:3;this.addBorderIntersection(c,o.x),this.addBorderIntersection(c,e.x)}}centroid(){return 0===this.accCount?new Je(0,0):new Je(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,o)=>e+ +(o[0]!==Number.MAX_VALUE),0):0}}function Bm(s,e){const o=s.add(e)._unit(),c=se(s.x*o.x+s.y*o.y,-1,1);var d,m,g;return d=Math.acos(c),Math.min(4,Math.max(-4,Math.tan(d)))/4*Vv*((m=s).x*(g=e).y-m.y*g.x<0?-1:1)}const lE=[s=>s.x<0,s=>s.x>ht,s=>s.y<0,s=>s.y>ht];function Uv(s,e,o,c){const d=[4];if(0===c)return d;o._mult(c);const m=s.sub(o),g=e.sub(o),x=[s,e,m,g];for(let w=0;w<4;w++)for(const T of x)if(lE[w](T)){d.push(w);break}return d}class Hv{constructor(e){this.vertexArray=new Xs,this.indexArray=new Mi,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut},o=>ID.includes(o)),this._segments=new Gi,this.hiddenByLandmarkVertexArray=new fa,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Gi}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(e,o,c,d=!1){const m=e.length;if(m>2){let g=Math.max(0,this._segments.get().length-1);const x=this._segments._prepareSegment(4*m,this.vertexArray.length,2*this._segmentToGroundQuads[g].length);let w;g!==this._segments.get().length-1&&(g++,this._segmentToGroundQuads[g]=[],this._segmentToRegionTriCounts[g]=[0,0,0,0,0]);{const T=e[0],C=e[1];w=Bm(T.sub(e[m-1])._perp()._unit(),C.sub(T)._perp()._unit())}for(let T=0;T<m;T++){const C=T===m-1?0:T+1,A=e[T],M=e[C],k=e[C===m-1?0:C+1],F=M.sub(A)._perp()._unit(),V=Bm(F,k.sub(M)._perp()._unit()),j=w,W=V;if(L_(A,M,o)||d&&ab(A,o)&&ab(M,o)){w=V;continue}const Q=x.vertexLength;O_(this.vertexArray,A,M,1,1,j),O_(this.vertexArray,A,M,1,0,j),O_(this.vertexArray,A,M,0,1,W),O_(this.vertexArray,A,M,0,0,W),x.vertexLength+=4;const K=Uv(A,M,F,c);for(const te of K)this._segmentToGroundQuads[g].push({id:Q,region:te}),this._segmentToRegionTriCounts[g][te]+=2,x.primitiveLength+=2;w=V}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),o=e.length;for(let c=0;c<o;c++)this._segmentToGroundQuads[c].sort((d,m)=>d.region-m.region);for(let c=0;c<o;c++){const d=this._segmentToGroundQuads[c],m=e[c],g=this._segmentToRegionTriCounts[c];g.reduce((w,T)=>w+T,0);let x=0;for(let w=0;w<=4;w++){const T=g[w];if(0!==T){let C=this.regionSegments[w];C||(C=this.regionSegments[w]=new Gi);const A={vertexOffset:m.vertexOffset,primitiveOffset:m.primitiveOffset+x,vertexLength:m.vertexLength,primitiveLength:T};C.get().push(A)}x+=T}for(let w=0;w<d.length;w++){const T=d[w].id;this.indexArray.emplaceBack(T,T+1,T+3),this.indexArray.emplaceBack(T,T+3,T+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,o,c,d,m,g,x){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,o,c,d,m,g,void 0,x)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,eE.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,o,c,d,m,g,x,w){this.hasData()&&this.programConfigurations.updatePaintArrays(e,o,c,d,m,g,x,w)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Ih))}updateHiddenByLandmarkRange(e,o,c){if(!this.hasData())return;const d=o+e;if(0!==o){for(let m=e;m<d;++m)this.hiddenByLandmarkVertexArray.emplace(m,c?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,sd.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const o=this.regionSegments[e];o&&o.destroy()}}}}class iu{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(o=>o.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Mi,this.footprintVertices=new xs,this.footprintSegments=[],this.layoutVertexArray=new Qr,this.centroidVertexArray=new a_,this.wallVertexArray=new Bf,this.indexArray=new Mi,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut},o=>DD.includes(o)),this.segments=new Gi,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.groundEffect=new Hv(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,o){}populate(e,o,c,d){this.features=[],this.hasPattern=x_("fill-extrusion",this.layers,this.pixelRatio,o),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=ce(c),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:m,id:g,index:x,sourceLayerIndex:w}of e){const T=this.layers[0]._featureFilter.needGeometry,C=ze(m,T);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),C,c))continue;const A={id:g,sourceLayerIndex:w,index:x,geometry:T?C.geometry:_e(m,c,d),properties:m.properties,type:m.type,patterns:{}},M=this.layoutVertexArray.length,k="Polygon"===M_[A.type];if(this.hasPattern)this.features.push({featureId:m.id,feature:Rv("fill-extrusion",this.layers,A,this.zoom,this.pixelRatio,o)});else if(this.wallMode)for(const F of A.geometry)for(const V of Bv(F,k))this.addFeature(m.id,A,[V],x,c,{},o.availableImages,d,o.brightness);else this.addFeature(m.id,A,A.geometry,x,c,{},o.availableImages,d,o.brightness);o.featureIndex.insert(m,A.geometry,x,w,this.index,M)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,o,c,d,m,g){for(const{featureId:x,feature:w}of this.features){const T="Polygon"===M_[w.type],{geometry:C}=w;if(this.wallMode)for(const A of C)for(const M of Bv(A,T))this.addFeature(x,w,[M],w.index,o,c,d,m,g);else this.addFeature(x,w,C,w.index,o,c,d,m,g)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(e,o,c,d,m,g,x){this.programConfigurations.updatePaintArrays(e,o,m,c,d,g,x,this.worldview),this.groundEffect.update(e,o,m,c,d,g,x,this.worldview)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,iE),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,nE.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,zm.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,tE.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,o,c,d,m,g,x,w,T){const C=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(o,{})/this.tileToMeter,A=[new Je(0,0),new Je(ht,ht)],M=w.projection,k="globe"===M.name,F=this.wallMode||"Polygon"===M_[o.type],V=new jv;V.centroidDataIndex=this.centroidData.length;const j=new ob;j.buildingId=e,o.properties&&o.properties.hasOwnProperty("building_id")&&(j.buildingId=o.properties.building_id);const W=this.layers[0].paint.get("fill-extrusion-base").evaluate(o,{},m)<=0,Q=this.layers[0].paint.get("fill-extrusion-height").evaluate(o,{},m);let K;if(j.height=Q,j.vertexArrayOffset=this.layoutVertexArray.length,j.groundVertexArrayOffset=this.groundEffect.vertexArray.length,k&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Xu),this.wallMode){if(k)return void yn("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==c.length)return;K=function(Ie){const Ue=Ie[0].x===Ie[Ie.length-1].x&&Ie[0].y===Ie[Ie.length-1].y;(function(tt){let Dt=0;const yt=tt.length;for(let ft=0;ft<yt;ft++)Dt+=(tt[(ft+1)%yt].x-tt[ft].x)*(tt[(ft+1)%yt].y+tt[ft].y);return Dt>=0})(Ie)||(Ie=Ie.reverse());const $e={geometry:[],joinNormals:[],indices:[]},Ke=[],nt=[],Ne=[];let Qe=Ie.length;for(;Qe>=2&&Ie[Qe-1].equals(Ie[Qe-2]);)Qe--;if(Qe<(Ue?3:2))return $e;let Ce,Be,at,et,Ot,Tt=0;for(;Tt<Qe-1&&Ie[Tt].equals(Ie[Tt+1]);)Tt++;Ue&&(Ce=Ie[Qe-2],Ot=Ie[Tt].sub(Ce)._unit()._perp());for(let tt=Tt;tt<Qe;tt++){if(at=tt===Qe-1?Ue?Ie[Tt+1]:void 0:Ie[tt+1],at&&Ie[tt].equals(at))continue;Ot&&(et=Ot),Ce&&(Be=Ce),Ce=Ie[tt],Ot=at?at.sub(Ce)._unit()._perp():et,et=et||Ot;let Dt=et.add(Ot);0===Dt.x&&0===Dt.y||Dt._unit();const yt=Dt.x*Ot.x+Dt.y*Ot.y,ft=0!==yt?1/yt:1/0,xt=et.x*Ot.y-et.y*Ot.x>0;let zt="miter";const $t=2;"miter"===zt&&ft>$t&&(zt="bevel"),"bevel"===zt&&(ft>100&&(zt="flipbevel"),ft<$t&&(zt="miter"));const nn=(Xt,vn,dn,ni)=>{const ie=new Je(Xt.x,Xt.y),re=new Je(Xt.x,Xt.y);ie.x+=vn.x*ni,ie.y+=vn.y*ni,re.x-=vn.x*Math.max(dn,1),re.y-=vn.y*Math.max(dn,1),Ne.push(vn),Ke.push(ie),nt.push(re)};if("miter"===zt)Dt._mult(ft),nn(Ce,Dt,0,0);else if("flipbevel"===zt)Dt=Ot.mult(-1),nn(Ce,Dt,0,0),nn(Ce,Dt.mult(-1),0,0);else{const Xt=-Math.sqrt(ft*ft-1),vn=xt?Xt:0,dn=xt?0:Xt;Be&&nn(Ce,et,vn,dn),at&&nn(Ce,Ot,vn,dn)}}$e.geometry=[...Ke,...nt.reverse(),Ke[0]],$e.joinNormals=[...Ne,...Ne.reverse(),Ne[Ne.length-1]];const Xe=$e.geometry.length-1;for(let tt=0;tt<Xe/2;tt++)if(tt+1<Xe/2){let Dt=tt,yt=tt+1,ft=Xe-1-tt,xt=Xe-2-tt;Dt=0===Dt?Xe-1:Dt-1,yt=0===yt?Xe-1:yt-1,ft=0===ft?Xe-1:ft-1,xt=0===xt?Xe-1:xt-1,$e.indices.push(ft),$e.indices.push(yt),$e.indices.push(Dt),$e.indices.push(ft),$e.indices.push(xt),$e.indices.push(yt)}return $e}(c[0]),c=[K.geometry]}const te=(Ie,Ue)=>Ie<(Ue.length-1)/2||Ie===Ue.length-1,me=this.wallMode?[c]:Eh(c,500);for(let Ie=me.length-1;Ie>=0;Ie--){const Ue=me[Ie];(0===Ue.length||(he=Ue[0]).every(ot=>ot.x<=0)||he.every(ot=>ot.x>=ht)||he.every(ot=>ot.y<=0)||he.every(ot=>ot.y>=ht))&&me.splice(Ie,1)}var he;let fe;if(k)fe=db(me,A,m);else{fe=[];for(const Ie of me)fe.push({polygon:Ie,bounds:A})}const xe=F?this.edgeRadius:0,Ee=xe>0&&this.zoom<17,Ve=(Ie,Ue)=>{if(0===Ie.length)return!1;const ot=Ie[Ie.length-1];return Ue.x===ot.x&&Ue.y===ot.y};for(const{polygon:Ie,bounds:Ue}of fe){let ot=0,$e=0;for(const Qe of Ie)F&&!Qe[0].equals(Qe[Qe.length-1])&&Qe.push(Qe[0]),$e+=F?Qe.length-1:Qe.length;const Ke=this.segments.prepareSegment((F?5:4)*$e,this.layoutVertexArray,this.indexArray);j.footprintSegIdx<0&&(j.footprintSegIdx=this.footprintSegments.length),j.polygonSegIdx<0&&(j.polygonSegIdx=this.polygonSegments.length);const nt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ne=new rb;if(Ne.vertexOffset=this.footprintVertices.length,Ne.indexOffset=3*this.footprintIndices.length,Ne.ringIndices=[],F){const Qe=[],Ce=[];ot=Ke.vertexLength;for(let at=0;at<Ie.length;at++){const et=Ie[at];et.length&&0!==at&&Ce.push(Qe.length/2);const Ot=[];let Tt,Xe;Tt=et[1].sub(et[0])._perp()._unit(),Ne.ringIndices.push(et.length-1);for(let tt=1;tt<et.length;tt++){const Dt=et[tt],yt=et[tt===et.length-1?1:tt+1],ft=Dt.clone();if(xe){Xe=yt.sub(Dt)._perp()._unit();const xt=Tt.add(Xe)._unit(),zt=xe*Math.min(4,1/(Tt.x*xt.x+Tt.y*xt.y));ft.x+=zt*xt.x,ft.y+=zt*xt.y,ft.x=Math.round(ft.x),ft.y=Math.round(ft.y),Tt=Xe}if(!W||0!==xe&&!Ee||Ve(Ot,ft)||Ot.push(ft),R_(this.layoutVertexArray,ft.x,ft.y,0,0,1,1,0),this.wallMode){const xt=te(tt,et);Gf(this.wallVertexArray,K.joinNormals[tt],!xt)}Ke.vertexLength++,this.footprintVertices.emplaceBack(Dt.x,Dt.y),Qe.push(Dt.x,Dt.y),k&&Nm(this.layoutVertexExtArray,M.projectTilePoint(ft.x,ft.y,m),M.upVector(m,ft.x,ft.y))}W&&(0===xe||Ee)&&(0!==Ot.length&&Ve(Ot,Ot[0])&&Ot.pop(),this.groundEffect.addData(Ot,Ue,C))}const Be=this.wallMode?K.indices:yh(Qe,Ce);for(let at=0;at<Be.length;at+=3)this.footprintIndices.emplaceBack(Ne.vertexOffset+Be[at+0],Ne.vertexOffset+Be[at+1],Ne.vertexOffset+Be[at+2]),this.indexArray.emplaceBack(ot+Be[at],ot+Be[at+2],ot+Be[at+1]),Ke.primitiveLength++;Ne.indexCount+=Be.length,Ne.vertexCount+=this.footprintVertices.length-Ne.vertexOffset}for(let Qe=0;Qe<Ie.length;Qe++){const Ce=Ie[Qe];V.startRing(j,Ce[0]);let Be=Ce.length>4&&lb(Ce[Ce.length-2],Ce[0],Ce[1]),at=xe?cE(Ce[Ce.length-2],Ce[0],Ce[1],xe):0;const et=[];let Ot,Tt,Xe;Tt=Ce[1].sub(Ce[0])._perp()._unit();let tt=!0;for(let Dt=1,yt=0;Dt<Ce.length;Dt++){let ft=Ce[Dt-1],xt=Ce[Dt];const zt=Ce[Dt===Ce.length-1?1:Dt+1];if(V.appendEdge(j,xt,ft),L_(xt,ft,Ue)){xe&&(Tt=zt.sub(xt)._perp()._unit(),tt=!tt);continue}const $t=xt.sub(ft)._perp(),nn=$t.x/(Math.abs($t.x)+Math.abs($t.y)),Xt=$t.y>0?1:0,vn=ft.dist(xt);if(yt+vn>32768&&(yt=0),xe){Xe=zt.sub(xt)._perp()._unit();let re=Gv(ft,xt,zt,sb(Tt,Xe),xe);isNaN(re)&&(re=0);const Fe=xt.sub(ft)._unit();ft=ft.add(Fe.mult(at))._round(),xt=xt.add(Fe.mult(-re))._round(),at=re,Tt=Xe,W&&this.zoom>=17&&(Ve(et,ft)||et.push(ft),Ve(et,xt)||et.push(xt))}const dn=Ke.vertexLength,ni=Ce.length>4&&lb(ft,xt,zt);let ie=cb(yt,Be,tt);if(R_(this.layoutVertexArray,ft.x,ft.y,nn,Xt,0,0,ie),R_(this.layoutVertexArray,ft.x,ft.y,nn,Xt,0,1,ie),this.wallMode){const re=te(Dt-1,Ce),Fe=K.joinNormals[Dt-1];Gf(this.wallVertexArray,Fe,re),Gf(this.wallVertexArray,Fe,re)}if(yt+=vn,ie=cb(yt,ni,!tt),Be=ni,R_(this.layoutVertexArray,xt.x,xt.y,nn,Xt,0,0,ie),R_(this.layoutVertexArray,xt.x,xt.y,nn,Xt,0,1,ie),this.wallMode){const re=te(Dt,Ce),Fe=K.joinNormals[Dt];Gf(this.wallVertexArray,Fe,re),Gf(this.wallVertexArray,Fe,re)}if(Ke.vertexLength+=4,this.indexArray.emplaceBack(dn+0,dn+1,dn+2),this.indexArray.emplaceBack(dn+1,dn+3,dn+2),Ke.primitiveLength+=2,xe){const re=ot+(1===Dt?Ce.length-2:Dt-2),Fe=1===Dt?ot:re+1;if(this.indexArray.emplaceBack(dn+1,re,dn+3),this.indexArray.emplaceBack(re,Fe,dn+3),Ke.primitiveLength+=2,void 0===Ot&&(Ot=dn),!L_(zt,Ce[Dt],Ue)){const lt=Dt===Ce.length-1?Ot:Ke.vertexLength;this.indexArray.emplaceBack(dn+2,dn+3,lt),this.indexArray.emplaceBack(dn+3,lt+1,lt),this.indexArray.emplaceBack(dn+3,Fe,lt+1),Ke.primitiveLength+=3}tt=!tt}if(k){const re=this.layoutVertexExtArray,Fe=M.projectTilePoint(ft.x,ft.y,m),lt=M.projectTilePoint(xt.x,xt.y,m),ut=M.upVector(m,ft.x,ft.y),pt=M.upVector(m,xt.x,xt.y);Nm(re,Fe,ut),Nm(re,Fe,ut),Nm(re,lt,pt),Nm(re,lt,pt)}}F&&(ot+=Ce.length-1),W&&xe&&this.zoom>=17&&(0!==et.length&&Ve(et,et[0])&&et.pop(),this.groundEffect.addData(et,Ue,C,xe>0))}this.footprintSegments.push(Ne),nt.triangleCount=this.indexArray.length-nt.triangleArrayOffset,this.polygonSegments.push(nt),++j.footprintSegLen,++j.polygonSegLen}if(j.vertexCount=this.layoutVertexArray.length-j.vertexArrayOffset,j.groundVertexCount=this.groundEffect.vertexArray.length-j.groundVertexArrayOffset,0!==j.vertexCount){if(j.centroidXY=V.borders?P_:this.encodeCentroid(V,j),this.centroidData.push(j),V.borders){this.featuresOnBorder.push(V);const Ie=this.featuresOnBorder.length-1;for(let Ue=0;Ue<V.borders.length;Ue++)V.borders[Ue][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Ue].push(Ie)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,d,g,x,m,T,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(o,d,g,x,m,T,this.worldview),this.maxHeight=Math.max(this.maxHeight,Q)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((o,c)=>this.featuresOnBorder[o].borders[e][0]-this.featuresOnBorder[c].borders[e][0])}splitToSubtiles(){const e=[];for(let x=0;x<this.centroidData.length;x++){const w=this.centroidData[x],T=+(w.min.y+w.max.y>ht),C=2*T+(+(w.min.x+w.max.x>ht)^T);for(let A=0;A<w.polygonSegLen;A++){const M=w.polygonSegIdx+A;e.push({centroidIdx:x,subtile:C,polygonSegmentIdx:M,triangleSegmentIdx:this.polygonSegments[M].triangleSegIdx})}}const o=new Mi;e.sort((x,w)=>x.triangleSegmentIdx===w.triangleSegmentIdx?x.subtile-w.subtile:x.triangleSegmentIdx-w.triangleSegmentIdx);let c=0,d=0,m=0;for(const x of e){if(x.triangleSegmentIdx!==c)break;m++}const g=e.length;for(;d!==e.length;){c=e[d].triangleSegmentIdx;let x=0,w=d,T=d;for(let C=w;C<m&&e[C].subtile===x;C++)T++;for(;w!==m;){const C=e[w];x=C.subtile;const A=this.centroidData[C.centroidIdx].min.clone(),M=this.centroidData[C.centroidIdx].max.clone(),k={vertexOffset:this.segments.segments[c].vertexOffset,primitiveOffset:o.length,vertexLength:this.segments.segments[c].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let F=w;F<T;F++){const V=e[F],j=this.polygonSegments[V.polygonSegmentIdx],W=this.centroidData[V.centroidIdx].min,Q=this.centroidData[V.centroidIdx].max,K=this.indexArray.uint16;for(let te=j.triangleArrayOffset;te<j.triangleArrayOffset+j.triangleCount;te++)o.emplaceBack(K[3*te],K[3*te+1],K[3*te+2]);k.primitiveLength+=j.triangleCount,A.x=Math.min(A.x,W.x),A.y=Math.min(A.y,W.y),M.x=Math.max(M.x,Q.x),M.y=Math.max(M.y,Q.y)}k.primitiveLength>0&&this.triangleSubSegments.push({segment:k,min:A,max:M}),w=T;for(let F=w;F<m&&e[F].subtile===e[w].subtile;F++)T++}d=m;for(let C=d;C<g&&e[C].triangleSegmentIdx===e[d].triangleSegmentIdx;C++)m++}o._trim(),this.indexArray=o}getVisibleSegments(e,o,c){const d=new Gi;if(this.wallMode){for(const V of this.triangleSubSegments)d.segments.push(V.segment);return d}let m=0,g=0;const x=1<<e.canonical.z;if(o){const V=o.getMinMaxForTile(e);V&&(m=V.min,g=V.max)}g+=this.maxHeight;const w=e.toUnwrapped();let T;const C=[w.canonical.x/x+w.wrap,w.canonical.y/x],A=[(w.canonical.x+1)/x+w.wrap,(w.canonical.y+1)/x],M=(V,j,W)=>[V[0]*(1-W[0])+j[0]*W[0],V[1]*(1-W[1])+j[1]*W[1]],k=[],F=[];for(const V of this.triangleSubSegments){k[0]=V.min.x/ht,k[1]=V.min.y/ht,F[0]=V.max.x/ht,F[1]=V.max.y/ht;const j=M(C,A,k),W=M(C,A,F);if(0===new on([j[0],j[1],m],[W[0],W[1],g]).intersectsPrecise(c)){T&&(d.segments.push(T),T=void 0);continue}const Q=V.segment;T&&T.vertexOffset!==Q.vertexOffset&&(d.segments.push(T),T=void 0),T?(T.vertexLength+=Q.vertexLength,T.primitiveLength+=Q.primitiveLength):T={vertexOffset:Q.vertexOffset,primitiveLength:Q.primitiveLength,vertexLength:Q.vertexLength,primitiveOffset:Q.primitiveOffset,sortKey:void 0,vaos:{}}}return T&&d.segments.push(T),d}encodeCentroid(e,o){const c=e.centroid(),d=o.span(),m=Math.min(7,Math.round(d.x*this.tileToMeter/10)),g=Math.min(7,Math.round(d.y*this.tileToMeter/10));return new Je(se(c.x,1,ht-1)<<3|m,se(c.y,1,ht-1)<<3|g)}encodeBorderCentroid(e){if(!e.borders)return new Je(0,0);const o=e.borders,c=Number.MAX_VALUE;if(o[0][0]!==c||o[1][0]!==c){const d=o[0][0]!==c?0:1;return new Je(6|(o[0][0]!==c?0:65528),(o[d][0]+o[d][1])/2<<3|6)}{const d=o[2][0]!==c?2:3;return new Je((o[d][0]+o[d][1])/2<<3|6,6|(o[2][0]!==c?0:65528))}}showCentroid(e){const o=this.centroidData[e.centroidDataIndex];o.flags&=2147483647,o.centroidXY.x=0,o.centroidXY.y=0,this.writeCentroidToBuffer(o)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const o=e.vertexArrayOffset,c=e.vertexCount+e.vertexArrayOffset,d=e.flags&Ih?P_:e.centroidXY,m=this.centroidVertexArray.geta_centroid_pos0(o);if(this.centroidVertexArray.geta_centroid_pos1(o)!==d.y||m!==d.x){for(let g=o;g<c;++g)this.centroidVertexArray.emplace(g,d.x,d.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,o,c){if(o.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=o.updateTime;const d=o.getReplacementRegionsForTile(e.toUnwrapped());if(I_(this.activeReplacements,d))return;if(this.activeReplacements=d,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const g of this.centroidData)g.flags&=2147483647;const m=[];for(const g of this.activeReplacements){if(g.order<c)continue;const x=Math.max(1,Math.pow(2,g.footprintTileId.canonical.z-e.canonical.z));if(g.footprint.buildingId){const w=g.footprint.buildingId;for(const T of this.centroidData)T.buildingId===w&&(T.flags|=Ih)}else for(const w of this.centroidData)if(!(w.flags&Ih||g.min.x>w.max.x||w.min.x>g.max.x||g.min.y>w.max.y||w.min.y>g.max.y))for(let T=0;T<w.footprintSegLen;T++){const C=this.footprintSegments[w.footprintSegIdx+T];if(m.length=0,AD(this.footprintVertices,C.vertexOffset,C.vertexCount,g.footprintTileId.canonical,e.canonical,m),Nv(g.footprint,m,this.footprintIndices.uint16,C.indexOffset,C.indexCount,-C.vertexOffset,-x)){w.flags|=Ih;break}}}for(const g of this.centroidData)this.writeCentroidToBuffer(g);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,o,c){let d=!1;for(let m=0;m<c.footprintSegLen;m++){const g=this.footprintSegments[c.footprintSegIdx+m];let x=0;for(const w of g.ringIndices){for(let T=x,C=w+x-1;T<w+x;C=T++){const A=this.footprintVertices.int16[2*(T+g.vertexOffset)+0],M=this.footprintVertices.int16[2*(T+g.vertexOffset)+1],k=this.footprintVertices.int16[2*(C+g.vertexOffset)+1];M>o!=k>o&&e<(this.footprintVertices.int16[2*(C+g.vertexOffset)+0]-A)*(o-M)/(k-M)+A&&(d=!d)}x=w}}return d}getHeightAtTileCoord(e,o){let c=Number.NEGATIVE_INFINITY,d=!0;const m=4*(e+ht)*ht+(o+ht);if(this.partLookup.hasOwnProperty(m)){const g=this.partLookup[m];return g?{height:g.height,hidden:!!(g.flags&Ih)}:void 0}for(const g of this.centroidData)e>g.max.x||g.min.x>e||o>g.max.y||g.min.y>o||g.height<=c||this.footprintContainsPoint(e,o,g)&&(c=g.height,this.partLookup[m]=g,d=!!(g.flags&Ih));if(c!==Number.NEGATIVE_INFINITY)return{height:c,hidden:d};this.partLookup[m]=void 0}}function sb(s,e){const o=s.add(e)._unit();return s.x*o.x+s.y*o.y}function cE(s,e,o,c){const d=e.sub(s)._perp()._unit(),m=o.sub(e)._perp()._unit();return Gv(s,e,o,sb(d,m),c)}function Gv(s,e,o,c,d){const m=Math.sqrt(1-c*c);return Math.min(s.dist(e)/3,e.dist(o)/3,d*m/c)}function L_(s,e,o){return s.x<o[0].x&&e.x<o[0].x||s.x>o[1].x&&e.x>o[1].x||s.y<o[0].y&&e.y<o[0].y||s.y>o[1].y&&e.y>o[1].y}function ab(s,e){return s.x<e[0].x||s.x>e[1].x||s.y<e[0].y||s.y>e[1].y}function lb(s,e,o){if(s.x<0||s.x>=ht||e.x<0||e.x>=ht||o.x<0||o.x>=ht)return!1;const c=o.sub(e),d=c.perp(),m=s.sub(e);return(c.x*m.x+c.y*m.y)/Math.sqrt((c.x*c.x+c.y*c.y)*(m.x*m.x+m.y*m.y))>-.866&&d.x*m.x+d.y*m.y<0}function cb(s,e,o){const c=e?2|s:-3&s;return o?1|c:-2&c}function ub(){const s=Math.PI/32,e=Math.tan(s),o=I;return o*Math.sqrt(1+2*e*e)-o}function db(s,e,o){const c=1<<o.z,d=Y(o.x/c),m=Y((o.x+1)/c),g=ee(o.y/c),x=ee((o.y+1)/c);return function(w,T,C,A,M=0,k){const F=[];if(!w.length||!C||!A)return F;const V=(he,fe)=>{for(const xe of he)F.push({polygon:xe,bounds:fe})},j=Math.ceil(Math.log2(C)),W=Math.ceil(Math.log2(A)),Q=j-W,K=[];for(let he=0;he<Math.abs(Q);he++)K.push(Q>0?0:1);for(let he=0;he<Math.min(j,W);he++)K.push(0),K.push(1);let te=w;if(te=w_(te,T[0].y-M,T[1].y+M,1),te=w_(te,T[0].x-M,T[1].x+M,0),!te.length)return F;const me=[];for(K.length?me.push({polygons:te,bounds:T,depth:0}):V(te,T);me.length;){const he=me.pop(),fe=he.depth,xe=K[fe],Ee=he.bounds[0],Ve=he.bounds[1],Ie=0===xe?Ee.x:Ee.y,Ue=0===xe?Ve.x:Ve.y,ot=k?k(xe,Ie,Ue):.5*(Ie+Ue),$e=w_(he.polygons,Ie-M,ot+M,xe),Ke=w_(he.polygons,ot-M,Ue+M,xe);if($e.length){const nt=[Ee,new Je(0===xe?ot:Ve.x,1===xe?ot:Ve.y)];K.length>fe+1?me.push({polygons:$e,bounds:nt,depth:fe+1}):V($e,nt)}if(Ke.length){const nt=[new Je(0===xe?ot:Ee.x,1===xe?ot:Ee.y),Ve];K.length>fe+1?me.push({polygons:Ke,bounds:nt,depth:fe+1}):V(Ke,nt)}}return F}(s,e,Math.ceil((m-d)/11.25),Math.ceil((g-x)/11.25),1,(w,T,C)=>{if(0===w)return.5*(T+C);{const A=ee((o.y+T/ht)/c);return(q(.5*(ee((o.y+C/ht)/c)+A))*c-o.y)*ht}})}function AD(s,e,o,c,d,m){const g=Math.pow(2,c.z-d.z);for(let x=0;x<o;x++){let w=s.int16[2*(x+e)+0],T=s.int16[2*(x+e)+1];w=(w+d.x*ht)*g-c.x*ht,T=(T+d.y*ht)*g-c.y*ht,m.push(new Je(w,T))}}let uE,$f;wt(iu,"FillExtrusionBucket",{omit:["layers","features"]}),wt(ob,"PartData"),wt(rb,"FootprintSegment"),wt(jv,"BorderCentroidData"),wt(Hv,"GroundEffect");class oc extends Je{constructor(e,o,c){super(e,o),this.z=c}}class $v extends oc{constructor(e,o,c,d){super(e,o,c),this.w=d}}function qv(s,e,o,c){const d="x"===o?"y":"x",m=(c-s[o])/(e[o]-s[o]);s[d]=Math.round(s[d]+(e[d]-s[d])*m),s[o]=c,s.hasOwnProperty("z")&&(s.z=Ft(s.z,e.z,m)),s.hasOwnProperty("w")&&(s.w=Ft(s.w,e.w,m))}function k_(s,e,o,c){const d=o,m=c;for(const g of["x","y"]){let x=s,w=e;x[g]>=w[g]&&(x=e,w=s),x[g]<d&&w[g]>d&&qv(x,w,g,d),x[g]<m&&w[g]>m&&qv(w,x,g,m)}}function Vm(s,e,o,c,d,m){const g=[];for(let x=0;x<s.length;x++){const w=s[x];let T;const C=g.length;let A=0;for(let M=0;M<w.length-1;M++){let k=w[M],F=w[M+1],V=0;const j=A;let W,Q;m&&(V=Math.hypot(F.x-k.x,F.y-k.y),A+=V,W=k,Q=F),k.x<e&&F.x<e||(k.x<e?k=new Je(e,k.y+(e-k.x)/(F.x-k.x)*(F.y-k.y))._round():F.x<e&&(F=new Je(e,k.y+(e-k.x)/(F.x-k.x)*(F.y-k.y))._round()),k.y<o&&F.y<o||(k.y<o?k=new Je(k.x+(o-k.y)/(F.y-k.y)*(F.x-k.x),o)._round():F.y<o&&(F=new Je(k.x+(o-k.y)/(F.y-k.y)*(F.x-k.x),o)._round()),k.x>=c&&F.x>=c||(k.x>=c?k=new Je(c,k.y+(c-k.x)/(F.x-k.x)*(F.y-k.y))._round():F.x>=c&&(F=new Je(c,k.y+(c-k.x)/(F.x-k.x)*(F.y-k.y))._round()),k.y>=d&&F.y>=d||(k.y>=d?k=new Je(k.x+(d-k.y)/(F.y-k.y)*(F.x-k.x),d)._round():F.y>=d&&(F=new Je(k.x+(d-k.y)/(F.y-k.y)*(F.x-k.x),d)._round()),T&&k.equals(T[T.length-1])||(T=[k],g.push(T),m&&m.push({progress:{min:j+Wv(W,Q,k)*V,max:1},parentIndex:x,prevPoint:W,nextPoint:Q})),T.push(F),m&&(m[m.length-1].progress.max=j+Wv(W,Q,F)*V,m[m.length-1].nextPoint=Q)))))}if(m&&A>0)for(let M=C;M<g.length;M++)m[M].progress.min/=A,m[M].progress.max/=A}return g}function dE(s,e,o,c,d){if(s.length<2)return void c.push(s);const m=[];for(;e.valid();){const[T,C]=e.get();for(let A=0;A<s.length-1;A++){const M=s[A],k=s[A+1],F=Bs(M,k,T,C);if(F){const[V]=F,j=new Je(Ft(M.x,k.x,V),Ft(M.y,k.y,V));m.push({t:A+V,distance:0,point:j})}}e.next()}if(0===m.length)return void c.push(s);m.sort((T,C)=>T.t-C.t);let g=0,x=0,w=[];for(c.push(w);g!==s.length;){if(x===m.length){for(;g!==s.length;)0!==w.length&&w[w.length-1].equals(s[g])||w.push(s[g]),g++;break}m[x].t<=g?(0!==w.length&&w[w.length-1].equals(m[x].point)||w.push(m[x].point),Math.trunc(m[x].t),x++):(0!==w.length&&w[w.length-1].equals(s[g])||w.push(s[g]),g++)}}function Wv(s,e,o){return s.x!==e.x?(o.x-s.x)/(e.x-s.x):s.y!==e.y?(o.y-s.y)/(e.y-s.y):0}function qf(s,e){return s.x*e.x+s.y*e.y}function jm(s,e){if(1===s.length){let o=0;const c=e[o++];let d;for(;!d||c.equals(d);)if(d=e[o++],!d)return 1/0;for(;o<e.length;o++){const m=e[o],g=s[0],x=d.sub(c),w=m.sub(c),T=g.sub(c),C=qf(x,x),A=qf(x,w),M=qf(w,w),k=qf(T,x),F=qf(T,w),V=C*M-A*A,j=(M*k-A*F)/V,W=(C*F-A*k)/V,Q=c.z*(1-j-W)+d.z*j+m.z*W;if(isFinite(Q))return Q}return 1/0}{let o=1/0;for(const c of e)o=Math.min(o,c.z);return o}}function hE(s,e,o,c,d,m,g,x){const w=g*d.getElevationAt(s,e,!0,!0),T=0!==m[0],C=T?0===m[1]?g*(m[0]/7-450):g*function(A,M,k){const F=Math.floor(M[0]/8),V=Math.floor(M[1]/8),j=10*(M[0]-8*F),W=10*(M[1]-8*V),Q=A.getElevationAt(F,V,!0,!0),K=A.getMeterToDEM(k),te=Math.floor(.5*(j*K-1)),me=Math.floor(.5*(W*K-1)),he=A.tileCoordToPixel(F,V),fe=2*te+1,xe=2*me+1,Ee=(Qe=fe,Ce=xe,[(Ke=A).getElevationAtPixel(nt=he.x-te,Ne=he.y-me,!0),Ke.getElevationAtPixel(nt+Ce,Ne,!0),Ke.getElevationAtPixel(nt,Ne+Ce,!0),Ke.getElevationAtPixel(nt+Qe,Ne+Ce,!0)]),Ve=Math.abs(Ee[0]-Ee[1]),Ie=Math.abs(Ee[2]-Ee[3]),Ue=Math.abs(Ee[0]-Ee[2])+Math.abs(Ee[1]-Ee[3]),ot=Math.min(.25,.5*K*(Ve+Ie)/fe),$e=Math.min(.25,.5*K*Ue/xe);var Ke,nt,Ne,Qe,Ce;return Q+Math.max(ot*j,$e*W)}(d,m,x):w;return{base:w+(0===o?-1:o),top:T?Math.max(C+c,w+o+2):w+c}}class Zv{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class fE{constructor(){this.tasks={},this.taskQueue=[],Gt(["process"],this),this.invoker=new Zv(this.process),this.nextId=0}add(e,o){const c=this.nextId++,d=function({type:m,isSymbolTile:g,zoom:x}){return x=x||0,"message"===m?0:"maybePrepare"!==m||g?"parseTile"!==m||g?"parseTile"===m&&g?300-x:"maybePrepare"===m&&g?400-x:500:200-x:100-x}(o);if(0===d){try{e()}finally{}return null}return this.tasks[c]={fn:e,metadata:o,priority:d,id:c},this.taskQueue.push(c),this.invoker.trigger(),{cancel:()=>{delete this.tasks[c]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(c=>!!this.tasks[c]),!this.taskQueue.length)return;const e=this.pick();if(null===e)return;const o=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!o)return;o.fn()}finally{}}pick(){let e=null,o=1/0;for(let d=0;d<this.taskQueue.length;d++){const m=this.tasks[this.taskQueue[d]];m.priority<o&&(o=m.priority,e=d)}if(null===e)return null;const c=this.taskQueue[e];return this.taskQueue.splice(e,1),c}remove(){this.invoker.remove()}}class F_{constructor(e,o,c){this.target=e,this.parent=o,this.mapId=c,this.callbacks={},this.cancelCallbacks={},Gt(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new fE}send(e,o,c,d,m=!1,g){const x=Math.round(1e18*Math.random()).toString(36).substring(0,10);c&&(c.metadata=g,this.callbacks[x]=c);const w=new Set;return this.target.postMessage({id:x,type:e,hasCallback:!!c,targetMapId:d,mustQueue:m,sourceMapId:this.mapId,data:il(o,w)},w),{cancel:()=>{c&&delete this.callbacks[x],this.target.postMessage({id:x,type:"<cancel>",targetMapId:d,sourceMapId:this.mapId})}}}receive(e){const o=e.data;if(!o)return;const c=o.id;if(c&&(!o.targetMapId||this.mapId===o.targetMapId))if("<cancel>"===o.type){const d=this.cancelCallbacks[c];delete this.cancelCallbacks[c],d&&d.cancel()}else if(o.mustQueue||li(self)){const d=this.callbacks[c],m=this.scheduler.add(()=>this.processTask(c,o),d&&d.metadata||{type:"message"});m&&(this.cancelCallbacks[c]=m)}else this.processTask(c,o)}processTask(e,o){if(delete this.cancelCallbacks[e],"<response>"===o.type){const c=this.callbacks[e];delete this.callbacks[e],c&&(o.error?c(jo(o.error)):c(null,jo(o.data)))}else{const c=new Set,d=o.hasCallback?(g,x)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:g?il(g):null,data:il(x,c)},c)}:()=>{},m=jo(o.data);if(this.parent[o.type])this.parent[o.type](o.sourceMapId,m,d);else if(this.parent.getWorkerSource){const g=o.type.split("."),{source:x,scope:w}=m;this.parent.getWorkerSource(o.sourceMapId,g[0],x,w)[g[1]](m,d)}else d(new Error(`Could not find function ${o.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Wf={workerUrl:"",workerClass:null,workerParams:void 0};const z_="mapboxgl_preloaded_worker_pool";let Ch,Xf,sc=(()=>{class s{constructor(){this.active={}}acquire(o,c=s.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<c;)this.workers.push(null!=Wf.workerClass?new Wf.workerClass:new self.Worker(Wf.workerUrl,Wf.workerParams));return this.active[o]=!0,this.workers.slice()}release(o){delete this.active[o],this.workers&&0===this.numActive()&&(this.workers.forEach(c=>{c.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[z_]}numActive(){return Object.keys(this.active).length}}return s.workerCount=2,s})();class Zf{constructor(e,o,c="Worker",d=sc.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=qe();const m=this.workerPool.acquire(this.id,d);for(let g=0;g<m.length;g++){const x=new Zf.Actor(m[g],o,this.id);x.name=`${c} ${g}`,this.actors.push(x)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,o,c){Te(this.actors,(d,m)=>{d.send(e,o,m)},c=c||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}function N_(){return Ch||(Ch=new sc),Ch}Zf.Actor=F_;class Xv{constructor(e){this.module=e}createIntArray(e){const o=new Int32Array(e),c=this.module.malloc(o.length*o.BYTES_PER_ELEMENT);return this.module.heap32.set(o,c/o.BYTES_PER_ELEMENT),c}createFloatArray(e){const o=new Float32Array(e),c=this.module.malloc(o.length*o.BYTES_PER_ELEMENT);return this.module.heapF32.set(o,c/o.BYTES_PER_ELEMENT),c}createStringBuffer(e){const o=this.module.malloc(e.length+1);for(let c=0;c<e.length;++c)this.module.heapU8[o+c]=e.charCodeAt(c);return this.module.heapU8[o+e.length]=0,o}readStringBuffer(e){let o="";for(;0!==this.module.heapU8[e];)o+=String.fromCharCode(this.module.heapU8[e]),++e;return o}setStyle(e){const o=e.entranceColorRgb,c=e.facadeGlazingColorRgb,d=e.roofColorRgb,m=e.wallColorRgb,g=e.normalScale;this.module.setStyle(o[0],o[1],o[2],c[0],c[1],c[2],d[0],d[1],d[2],m[0],m[1],m[2],g[0],g[1],g[2],e.tileToMeters)}setAOOptions(e,o){this.module.setAOOptions(e?1:0,o)}setMetricOptions(e,o){this.module.setMetricOptions(e?1:0,o)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,o){this.module.setFacadeOptions(e,o?1:0)}setFauxFacadeOptions(e,o,c){this.module.setFauxFacadeOptions(e?1:0,o?1:0,c)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,o){for(const x of e){const w=this.createStringBuffer(x.roofType),T=[0],C=[];for(const k of x.coordinates)if(Array.isArray(k)){for(const F of k)C.push(F.x),C.push(F.y);T.push(C.length)}const A=this.createIntArray(T),M=this.createFloatArray(C);this.module.addFeature(x.id,x.sourceId,x.minHeight,x.height,w,x.roofType.length,M,A,T.length-1),this.module.free(w),this.module.free(A),this.module.free(M)}for(const x of o){let w;w=x.entrances?JSON.parse(x.entrances):[];const T=this.createFloatArray(w),C=[];for(const M of x.coordinates)C.push(M.x),C.push(M.y);const A=this.createFloatArray(C);this.module.addFacade(x.sourceId,x.crossPerc,x.distanceToRoad,T,w.length,A,C.length),this.module.free(T),this.module.free(A)}if(!this.module.generateMesh()){const x=this.module.getLastError();return this.readStringBuffer(x)}const c=this.module.getMeshCount(),d=new Array(c);for(let x=0;x<c;x++){const w=this.module.getPositionsPtr(x),T=this.module.getPositionsLength(x),C=new Float32Array(this.module.heapF32.buffer,w,T),A=this.module.getNormalsPtr(x),M=this.module.getNormalsLength(x),k=new Float32Array(this.module.heapF32.buffer,A,M),F=this.module.getColorsPtr(x),V=this.module.getColorsLength(x),j=new Uint8Array(this.module.heapU8.buffer,F,V),W=this.module.getAOPtr(x),Q=this.module.getAOLength(x),K=new Float32Array(this.module.heapF32.buffer,W,Q),te=this.module.getUVPtr(x),me=this.module.getUVLength(x),he=new Float32Array(this.module.heapF32.buffer,te,me),fe=this.module.getFauxFacadePtr(x),xe=this.module.getFauxFacadeLength(x),Ee=new Uint8Array(this.module.heapU8.buffer,fe,xe),Ve=this.module.getIndicesPtr(x),Ie=this.module.getIndicesLength(x),Ue=new Int32Array(this.module.heap32.buffer,Ve,Ie),ot=this.module.getBuildingPart(x),$e=this.readStringBuffer(ot);d[x]={positions:C,normals:k,colors:j,ao:K,uv:he,isFauxFacade:Ee,indices:Ue,buildingPart:$e}}const m=this.module.getRingCount(),g=[];for(let x=0;x<m;x++){const w=this.module.getRingPtr(x),T=this.module.getRingLength(x),C=new Float32Array(this.module.heapF32.buffer,w,T);g.push(C)}return{meshes:d,modifiedPolygonRings:g}}}let ad,dl,Ss,ld,Yv,Yf=null,Ah=null,Mh=null,B_=null;function hb(){return li(self)&&self.worker.dracoUrl?self.worker.dracoUrl:dl||no.DRACO_URL}function fb(){if(li(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(ld)return ld;const s=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return ld=WebAssembly.validate(s)?no.MESHOPT_SIMD_URL:no.MESHOPT_URL,ld}const Ph={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},pE={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Kf={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function cd(s,e,o){const c=o.json.bufferViews.length,d=o.buffers.length;e.bufferView=c,o.json.bufferViews[c]={buffer:d,byteLength:s.byteLength},o.buffers[d]=s}const pb="KHR_draco_mesh_compression";function Um(s,e){const o=s.extensions&&s.extensions[pb];if(!o)return;const c=new Ss.Decoder,d=V_(e,o.bufferView),m=new Ss.Mesh;if(!c.DecodeArrayToMesh(d,d.byteLength,m))throw new Error("Failed to decode Draco mesh");const g=e.json.accessors[s.indices],x=Ph[g.componentType],w=g.count*x.BYTES_PER_ELEMENT,T=Ss._malloc(w);x===Uint16Array?c.GetTrianglesUInt16Array(m,w,T):c.GetTrianglesUInt32Array(m,w,T),cd(Ss.memory.buffer.slice(T,T+w),g,e),Ss._free(T);for(const C of Object.keys(o.attributes)){const A=c.GetAttributeByUniqueId(m,o.attributes[C]),M=e.json.accessors[s.attributes[C]],k=pE[M.componentType],F=M.count*Kf[M.type]*Ph[M.componentType].BYTES_PER_ELEMENT,V=Ss._malloc(F);c.GetAttributeDataArrayForAllPoints(m,A,Ss[k],F,V),cd(Ss.memory.buffer.slice(V,V+F),M,e),Ss._free(V)}c.destroy(),m.destroy(),delete s.extensions[pb]}const Qf="EXT_meshopt_compression";function mE(s,e){if(!s.extensions||!s.extensions[Qf])return;const o=s.extensions[Qf],c=new Uint8Array(e.buffers[o.buffer],o.byteOffset||0,o.byteLength||0),d=new Uint8Array(o.count*o.byteStride);Yv.decodeGltfBuffer(d,o.count,o.byteStride,c,o.mode,o.filter),s.buffer=e.buffers.length,s.byteOffset=0,e.buffers[s.buffer]=d.buffer,delete s.extensions[Qf]}const gE=1179937895,_E=new TextDecoder("utf8");function Hm(s,e){return new URL(s,e).href}function yE(s,e,o,c){return fetch(Hm(s.uri,c)).then(d=>d.arrayBuffer()).then(d=>{e.buffers[o]=d})}function V_(s,e){const o=s.json.bufferViews[e];return new Uint8Array(s.buffers[o.buffer],o.byteOffset||0,o.byteLength)}function Qv(s,e,o,c){if(s.uri){const d=Hm(s.uri,c);return fetch(d).then(m=>m.blob()).then(m=>createImageBitmap(m)).then(m=>{e.images[o]=m})}if(void 0!==s.bufferView){const d=V_(e,s.bufferView),m=new Blob([d],{type:s.mimeType});return createImageBitmap(m).then(g=>{e.images[o]=g})}}function Rh(s,e=0,o){const c={json:null,images:[],buffers:[]};if(new Uint32Array(s,e,1)[0]===gE){const C=new Uint32Array(s,e);let A=2;const M=(C[A++]>>2)-3,k=C[A++]>>2;if(A++,c.json=JSON.parse(_E.decode(C.subarray(A,A+k))),A+=k,A<M){const F=C[A++];A++;const V=e+(A<<2);c.buffers[0]=s.slice(V,V+F)}}else c.json=JSON.parse(_E.decode(new Uint8Array(s,e)));const{buffers:d,images:m,meshes:g,extensionsUsed:x,bufferViews:w}=c.json;let T=Promise.resolve();if(d){const C=[];for(let A=0;A<d.length;A++){const M=d[A];M.uri?C.push(yE(M,c,A,o)):c.buffers[A]||(c.buffers[A]=null)}T=Promise.all(C)}return T.then(()=>{const C=[],A=x&&x.includes(pb),M=x&&x.includes(Qf);if(A&&C.push(function(){if(!Ss)return ad??(ad=function(k){let F,V=null;function j(){F=new Uint8Array(V.buffer)}function W(){throw new Error("Unexpected Draco error.")}const Q={a:{a:W,d:function(K,te,me){return F.copyWithin(K,te,te+me)},c:function(K){const te=F.length,me=Math.max(K>>>0,Math.ceil(1.2*te)),he=Math.ceil((me-te)/65536);try{return V.grow(he),j(),!0}catch{return!1}},b:W}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(k,Q):k.then(K=>K.arrayBuffer()).then(K=>WebAssembly.instantiate(K,Q))).then(K=>{const{Rb:te,Qb:me,P:he,T:fe,X:xe,Ja:Ee,La:Ve,Qa:Ie,Va:Ue,Wa:ot,eb:$e,jb:Ke,f:nt,e:Ne,yb:Qe,zb:Ce,Ab:Be,Bb:at,Db:et,Gb:Ot}=K.instance.exports;V=Ne;const Tt=(()=>{let Xe=0,tt=0,Dt=0,yt=0;return ft=>{Dt&&(te(yt),te(Xe),tt+=Dt,Dt=Xe=0),Xe||(tt+=128,Xe=me(tt));const xt=ft.length+7&-8;let zt=Xe;xt>=tt&&(Dt=xt,zt=yt=me(xt));for(let $t=0;$t<ft.length;$t++)F[zt+$t]=ft[$t];return zt}})();return j(),nt(),{memory:Ne,_free:te,_malloc:me,Mesh:class{constructor(){this.ptr=he()}destroy(){fe(this.ptr)}},Decoder:class{constructor(){this.ptr=Ee()}destroy(){Ke(this.ptr)}DecodeArrayToMesh(Xe,tt,Dt){const yt=Tt(Xe),ft=Ve(this.ptr,yt,tt,Dt.ptr);return!!xe(ft)}GetAttributeByUniqueId(Xe,tt){return{ptr:Ie(this.ptr,Xe.ptr,tt)}}GetTrianglesUInt16Array(Xe,tt,Dt){Ue(this.ptr,Xe.ptr,tt,Dt)}GetTrianglesUInt32Array(Xe,tt,Dt){ot(this.ptr,Xe.ptr,tt,Dt)}GetAttributeDataArrayForAllPoints(Xe,tt,Dt,yt,ft){$e(this.ptr,Xe.ptr,tt.ptr,Dt,yt,ft)}},DT_INT8:Qe(),DT_UINT8:Ce(),DT_INT16:Be(),DT_UINT16:at(),DT_UINT32:et(),DT_FLOAT32:Ot()}})}(fetch(hb())),ad.then(k=>{Ss=k,ad=void 0}))}()),M&&C.push(function(){if(Yv)return;const k=function(F){let V;const j=WebAssembly.instantiateStreaming(F,{}).then(K=>{V=K.instance,V.exports.__wasm_call_ctors()}),W={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Q={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:j,supported:!0,decodeGltfBuffer(K,te,me,he,fe,xe){!function(Ee,Ve,Ie,Ue,ot,$e,Ke){const nt=Ee.exports.sbrk,Ne=Ue+3&-4,Qe=nt(Ne*ot),Ce=nt($e.length),Be=new Uint8Array(Ee.exports.memory.buffer);Be.set($e,Ce);const at=Ve(Qe,Ue,ot,Ce,$e.length);if(0===at&&Ke&&Ke(Qe,Ne,ot),Ie.set(Be.subarray(Qe,Qe+Ue*ot)),nt(Qe-nt(0)),0!==at)throw new Error(`Malformed buffer data: ${at}`)}(V,V.exports[Q[fe]],K,te,me,he,V.exports[W[xe]])}}}(fetch(fb()));return k.ready.then(()=>{Yv=k})}()),m)for(let k=0;k<m.length;k++)C.push(Qv(m[k],c,k,o));return(C.length?Promise.all(C):Promise.resolve()).then(()=>{if(A&&g)for(const{primitives:k}of g)for(const F of k)Um(F,c);if(M&&g&&w)for(const k of w)mE(k,c);return c})})}function Gm(s){switch(s){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function $m(s){switch(s){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Oh{constructor(e,o,c,d){this.context=e,this.format=c,this.useMipmap=d&&d.useMipmap,this.texture=e.gl.createTexture(),this.update(o,{premultiply:d&&d.premultiply})}update(e,o){const c=e&&e instanceof HTMLVideoElement&&0===e.width?e.videoWidth:e.width,d=e&&e instanceof HTMLVideoElement&&0===e.height?e.videoHeight:e.height,{context:m}=this,{gl:g}=m,{x,y:w}=o&&o.position?o.position:{x:0,y:0},T=x+c,C=w+d;!this.size||this.size[0]===T&&this.size[1]===C||(g.bindTexture(g.TEXTURE_2D,null),g.deleteTexture(this.texture),this.texture=g.createTexture(),this.size=null),g.bindTexture(g.TEXTURE_2D,this.texture),m.pixelStoreUnpackFlipY.set(!1),m.pixelStoreUnpack.set(1),m.pixelStoreUnpackPremultiplyAlpha.set(this.format===g.RGBA8&&(!o||!1!==o.premultiply));const A=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&T>0&&C>0){const M=this.useMipmap?Math.floor(Math.log2(Math.max(T,C)))+1:1;g.texStorage2D(g.TEXTURE_2D,M,this.format,T,C),this.size=[T,C]}if(this.size)if(A)g.texSubImage2D(g.TEXTURE_2D,0,x,w,Gm(this.format),$m(this.format),e);else{const M=e.data;M&&g.texSubImage2D(g.TEXTURE_2D,0,x,w,c,d,Gm(this.format),$m(this.format),M)}this.useMipmap&&g.generateMipmap(g.TEXTURE_2D)}bind(e,o,c=!1){const{context:d}=this,{gl:m}=d;m.bindTexture(m.TEXTURE_2D,this.texture),e!==this.minFilter&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,e),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,this.useMipmap&&!c?e===m.NEAREST?m.NEAREST_MIPMAP_NEAREST:m.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),o!==this.wrapS&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,o),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,o),this.wrapS=o)}bindExtraParam(e,o,c,d,m){const{context:g}=this,{gl:x}=g;x.bindTexture(x.TEXTURE_2D,this.texture),o!==this.magFilter&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,o),this.magFilter=o),e!==this.minFilter&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,this.useMipmap?e===x.NEAREST?x.NEAREST_MIPMAP_NEAREST:x.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),c!==this.wrapS&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,c),this.wrapS=c),d!==this.wrapT&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,d),this.wrapT=d),m!==this.compareMode&&(m?(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_COMPARE_MODE,x.COMPARE_REF_TO_TEXTURE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_COMPARE_FUNC,m)):x.texParameteri(x.TEXTURE_2D,x.TEXTURE_COMPARE_MODE,x.NONE),this.compareMode=m)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class ud{constructor(e,o){this.context=e,this.texture=o}bind(e,o){const{context:c}=this,{gl:d}=c;d.bindTexture(d.TEXTURE_2D,this.texture),e!==this.minFilter&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,e),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,e),this.minFilter=e),o!==this.wrapS&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,o),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,o),this.wrapS=o)}}const Jf=En([{name:"a_pos_3f",components:3,type:"Float32"}]),Jv=En([{name:"a_color_3f",components:3,type:"Float32"}]),e0=En([{name:"a_color_4f",components:4,type:"Float32"}]),j_=En([{name:"a_uv_2f",components:2,type:"Float32"}]),MD=En([{name:"a_normal_3f",components:3,type:"Float32"}]),t0=En([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),qm=En([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function mb(s,e){const o=U_(s.projection,s.zoom,s.width,s.height),c=function(m,g,x,w,T){const C=new R(x.lng-180*dd,x.lat),A=new R(x.lng+180*dd,x.lat),M=m.project(C.lng,C.lat),k=m.project(A.lng,A.lat),F=-Math.atan2(k.y-M.y,k.x-M.x),V=ue.fromLngLat(x);V.y=se(V.y,-1+dd,1-dd);const j=V.toLngLat(),W=m.project(j.lng,j.lat),Q=ue.fromLngLat(j);Q.x+=dd;const K=Q.toLngLat(),te=m.project(K.lng,K.lat),me=r0(te.x-W.x,te.y-W.y,F),he=ue.fromLngLat(j);he.y+=dd;const fe=he.toLngLat(),xe=m.project(fe.lng,fe.lat),Ee=r0(xe.x-W.x,xe.y-W.y,F),Ve=Math.abs(me.x)/Math.abs(Ee.y),Ie=fn([]);Il(Ie,Ie,-F*(1-(T?0:w)));const Ue=fn([]);return eo(Ue,Ue,[1,1-(1-Ve)*w,1]),Ue[4]=-Ee.x/Ee.y*w,Il(Ue,Ue,F),Bi(Ue,Ie,Ue),Ue}(s.projection,0,s.center,o,e),d=n0(s);return eo(c,c,[d,d,1]),c}function n0(s){const e=s.projection,o=U_(s.projection,s.zoom,s.width,s.height),c=Wm(e,s.center),d=Wm(e,R.convert(e.center));return Math.pow(2,c*o+(1-o)*d)}function U_(s,e,o,c,d=1/0){const m=s.range;if(!m)return 0;const g=Math.min(d,Math.max(o,c)),x=Math.log(g/1024)/Math.LN2;return be(m[0]+x,m[1]+x,e)}const dd=1/4e4;function Wm(s,e){const o=se(e.lat,-le,le),c=new R(e.lng-180*dd,o),d=new R(e.lng+180*dd,o),m=s.project(c.lng,o),g=s.project(d.lng,o),x=ue.fromLngLat(c),w=ue.fromLngLat(d),T=g.x-m.x,C=g.y-m.y,A=w.x-x.x,M=w.y-x.y,k=Math.sqrt((A*A+M*M)/(T*T+C*C));return Math.log(k)/Math.LN2}function r0(s,e,o){const c=Math.cos(o),d=Math.sin(o);return{x:s*c-e*d,y:s*d+e*c}}function gb(s,e,o){fn(s),Il(s,s,Pn(e[2])),fs(s,s,Pn(e[0])),Vs(s,s,Pn(e[1])),eo(s,s,o),Bi(s,s,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function H_(s,e,o,c,d,m,g,x){const w=[o[0]-e[0],o[1]-e[1],0],T=[c[0]-e[0],c[1]-e[1],0];if(uo(w)<1e-12||uo(T)<1e-12)return Ta(s);const C=yi([],w,T);Ai(C,C),to(T,c,e),w[2]=(m-d)*x,T[2]=(g-d)*x;const A=w;return yi(A,w,T),Ai(A,A),wu(s,C,A)}function _b(s,e,o=!1){const c=eu(e.zoom),d=function(m,g,x){const w=g.worldSize,T=[m[12],m[13],m[14]],C=ee(T[1]/w),A=Y(T[0]/w),M=fn([]),k=G(1,C)*w,F=G(1,0)*w*pe(C,g.zoom),V=1/Go(w);let j=F*V;if(x){const te=U_(g.projection,g.zoom,g.width,g.height,1024);j=V*g.projection.pixelSpaceConversion(g.center.lat,w,te)}const W=S(C,A);Oi(W,W,Li([],Ai([],W),k*j*T[2]));const Q=function(te){const me=[te[0],te[1],te[2]];let he=[0,1,0];const fe=yi([],he,me);return yi(he,me,fe),0===rf(he)&&(he=[0,1,0],yi(fe,me,he)),Ai(fe,fe),Ai(he,he),Ai(me,me),[fe[0],fe[1],fe[2],0,he[0],he[1],he[2],0,me[0],me[1],me[2],0,te[0],te[1],te[2],1]}(W);eo(M,M,[j,j,j*k]),zo(M,M,[-T[0],-T[1],-T[2]]);const K=Bi([],g.globeMatrix,Q);return Bi(K,K,M),Bi(K,K,m),K}(s,e,o);return c>0?function(g,x,w){const T=(F,V,j)=>{const W=uo(F),Q=uo(V),K=Jc(F,V,j);return Li(K,K,1/uo(K)*Ft(W,Q,j))},C=T([g[0],g[1],g[2]],[x[0],x[1],x[2]],w),A=T([g[4],g[5],g[6]],[x[4],x[5],x[6]],w),M=T([g[8],g[9],g[10]],[x[8],x[9],x[10]],w),k=Jc([g[12],g[13],g[14]],[x[12],x[13],x[14]],w);return[C[0],C[1],C[2],0,A[0],A[1],A[2],0,M[0],M[1],M[2],0,k[0],k[1],k[2],1]}(d,function(g,x){const w=x.worldSize,T=G(1,0)*w*pe(x.center.lat,x.zoom)/Go(w),C=G(1,x.center.lat)*w,A=fn([]);return Vs(A,A,Pn(x.center.lng)),fs(A,A,Pn(x.center.lat)),zo(A,A,[0,0,Po]),eo(A,A,[T,T,T*C]),zo(A,A,[x.point.x-.5*w,x.point.y-.5*w,0]),Bi(A,A,g),Bi(A,x.globeMatrix,A)}(s,e),c):d}function yb(s,e,o,c){const d=on.projectAabbCorners(c,o);let m=Number.MAX_VALUE,g=-1;for(let T=0;T<d.length;++T){const C=d[T];C[0]=(.5*C[0]+.5)*e.width,C[1]=(.5-.5*C[1])*e.height,C[2]<m&&(g=T,m=C[2])}const x=T=>new Je(d[T][0],d[T][1]);let w;switch(g){case 0:case 6:w=[x(1),x(5),x(4),x(7),x(3),x(2),x(1)];break;case 1:case 7:w=[x(0),x(4),x(5),x(6),x(2),x(3),x(0)];break;case 3:case 5:w=[x(1),x(0),x(4),x(7),x(6),x(2),x(1)];break;default:w=[x(1),x(5),x(6),x(7),x(3),x(0),x(1)]}if(ci(s,w))return m}const hd={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function vb(s,e,o,c,d,m,g,x,w,T=!1){const C=o.zoom,A=o.project(c),M=pe(c.lat,C),k=1/M;fn(s),zo(s,s,[A.x+g[0]*k,A.y+g[1]*k,g[2]]);let F=1,V=1;const j=o.worldSize;if(T){if("mercator"===o.projection.name){let te=0;o.elevation&&(te=o.elevation.getAtPointOrZero(new ue(A.x/j,A.y/j),0));const me=ms([],[A.x,A.y,te,1],o.projMatrix)[3]/o.cameraToCenterDistance;F=me,V=me*pe(o.center.lat,C)}else if("globe"===o.projection.name){const te=_b(s,o),me=[0,0,0,1];ms(me,me,Bi([],o.projMatrix,te));const he=me[3]/o.cameraToCenterDistance,fe=eu(C),xe=o.projection.pixelsPerMeter(c.lat,j)*pe(c.lat,C),Ee=o.projection.pixelsPerMeter(o.center.lat,j)*pe(o.center.lat,C);F=he/Ft(xe,de(o.center.lat),fe),V=he*M/xe,F*=Ee,V*=Ee}}else F=k;eo(s,s,[F,F,V]);const W=[...s],Q=e.orientation,K=[];if(gb(K,[Q[0]+d[0],Q[1]+d[1],Q[2]+d[2]],m),Bi(s,W,K),x&&o.elevation){let te=0;const me=[];if(w&&o.elevation){te=function(fe,xe,Ee,Ve,Ie){const Ue=xe.elevation;if(!Ue)return 0;const ot=on.projectAabbCorners(Ee,Ve),$e=G(1,Ie.lat)*xe.worldSize,Ke=function(tt,Dt){const yt=[0,0,1],ft=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const xt of ft){const zt=tt[xt.corners[0]],$t=tt[xt.corners[1]],nn=tt[xt.corners[2]],Xt=[$t[0]-zt[0],$t[1]-zt[1],Dt*($t[2]-zt[2])],vn=yi(Xt,Xt,[nn[0]-zt[0],nn[1]-zt[1],Dt*(nn[2]-zt[2])]);Ai(vn,vn),xt.dotProductWithUp=ir(vn,yt)}return ft.sort((xt,zt)=>xt.dotProductWithUp-zt.dotProductWithUp),ft[0].corners}(ot,$e),nt=ot[Ke[0]],Ne=ot[Ke[1]],Qe=ot[Ke[2]],Ce=ot[Ke[3]],Be=Ue.getAtPointOrZero(new ue(nt[0]/xe.worldSize,nt[1]/xe.worldSize),0),at=Ue.getAtPointOrZero(new ue(Ne[0]/xe.worldSize,Ne[1]/xe.worldSize),0),et=Ue.getAtPointOrZero(new ue(Qe[0]/xe.worldSize,Qe[1]/xe.worldSize),0),Ot=Ue.getAtPointOrZero(new ue(Ce[0]/xe.worldSize,Ce[1]/xe.worldSize),0),Tt=(Be+Ot)/2,Xe=(at+et)/2;return Tt>Xe?at<et?H_(fe,Ne,Ce,nt,at,Ot,Be,$e):H_(fe,Qe,nt,Ce,et,Be,Ot,$e):Be<Ot?H_(fe,nt,Ne,Qe,Be,at,et,$e):H_(fe,Ce,Qe,Ne,Ot,et,at,$e),Math.max(Tt,Xe)}(me,o,e.aabb,s,c);const he=Bi([],ba([],me),K);Bi(s,W,he)}else te=o.elevation.getAtPointOrZero(new ue(A.x/j,A.y/j),0);0!==te&&(s[14]+=te)}}function ep(s,e,o=!1){s.uploaded||(s.gfxTexture=new Oh(e,s.image,o?e.gl.R8:e.gl.RGBA8,{useMipmap:s.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),s.uploaded=!0,s.image=null)}function o0(s,e,o){s.indexBuffer=e.createIndexBuffer(s.indexArray,!1,!0),s.vertexBuffer=e.createVertexBuffer(s.vertexArray,Jf.members,!1,!0),s.normalArray&&(s.normalBuffer=e.createVertexBuffer(s.normalArray,MD.members,!1,!0)),s.texcoordArray&&(s.texcoordBuffer=e.createVertexBuffer(s.texcoordArray,j_.members,!1,!0)),s.colorArray&&(s.colorBuffer=e.createVertexBuffer(s.colorArray,(12===s.colorArray.bytesPerElement?Jv:e0).members,!1,!0)),s.featureArray&&(s.pbrBuffer=e.createVertexBuffer(s.featureArray,qm.members,!0)),s.segments=Gi.simpleSegment(0,0,s.vertexArray.length,s.indexArray.length);const c=s.material;c.pbrMetallicRoughness.baseColorTexture&&ep(c.pbrMetallicRoughness.baseColorTexture,e),c.pbrMetallicRoughness.metallicRoughnessTexture&&ep(c.pbrMetallicRoughness.metallicRoughnessTexture,e),c.normalTexture&&ep(c.normalTexture,e),c.occlusionTexture&&ep(c.occlusionTexture,e,o),c.emissionTexture&&ep(c.emissionTexture,e)}function tp(s,e,o){if(s.meshes)for(const c of s.meshes)o0(c,e,o);if(s.children)for(const c of s.children)tp(c,e,o)}function G_(s){if(s.meshes)for(const e of s.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(s.children)for(const e of s.children)G_(e)}function $_(s){if(s.meshes)for(const o of s.meshes)o.vertexBuffer&&(o.vertexBuffer.destroy(),o.indexBuffer.destroy(),o.normalBuffer&&o.normalBuffer.destroy(),o.texcoordBuffer&&o.texcoordBuffer.destroy(),o.colorBuffer&&o.colorBuffer.destroy(),o.pbrBuffer&&o.pbrBuffer.destroy(),o.segments.destroy(),o.material&&((e=o.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(s.children)for(const o of s.children)$_(o)}function Lh(s,e){const o=s.json.bufferViews[e.bufferView],c=Ph[e.componentType];return new c(s.buffers[o.buffer],(e.byteOffset||0)+(o.byteOffset||0),e.count*(o.byteStride&&o.byteStride!==Kf[e.type]*c.BYTES_PER_ELEMENT?o.byteStride/c.BYTES_PER_ELEMENT:Kf[e.type]))}function q_(s,e,o,c){const d=Ph[e.componentType],m=function(C){switch(C){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(d),g=s.json.bufferViews[e.bufferView],x=g.byteStride?g.byteStride/d.BYTES_PER_ELEMENT:Kf[e.type],w=o.float32,T=w.length/o.capacity;for(let C=0,A=0;C<e.count*x;C+=x,A+=T)for(let M=0;M<T;M++)w[A+M]=c[C+M]*m;o._trim()}function PD(s,e,o){const c=s.indices,d=s.attributes,m={};m.indexArray=new Mi;const g=e.json.accessors[c],x=g.count/3;m.indexArray.reserve(x);const w=Lh(e,g);for(let M=0;M<x;M++)m.indexArray.emplaceBack(w[3*M],w[3*M+1],w[3*M+2]);m.indexArray._trim(),m.vertexArray=new bs;const T=e.json.accessors[d.POSITION];m.vertexArray.reserve(T.count);const C=Lh(e,T);for(let M=0;M<T.count;M++)m.vertexArray.emplaceBack(C[3*M],C[3*M+1],C[3*M+2]);if(m.vertexArray._trim(),m.aabb=new on(T.min,T.max),m.centroid=function(M,k){const F=[0,0,0],V=M.length;if(V>0){for(let j=0;j<V;j++){const W=3*M[j];F[0]+=k[W],F[1]+=k[W+1],F[2]+=k[W+2]}F[0]/=V,F[1]/=V,F[2]/=V}return F}(w,C),void 0!==d.COLOR_0){const M=e.json.accessors[d.COLOR_0],k=Kf[M.type],F=Lh(e,M);m.colorArray=3===k?new bs:new Ra,m.colorArray.resize(M.count),q_(e,M,m.colorArray,F)}if(void 0!==d.NORMAL){m.normalArray=new bs;const M=e.json.accessors[d.NORMAL];m.normalArray.resize(M.count);const k=Lh(e,M);q_(e,M,m.normalArray,k)}if(void 0!==d.TEXCOORD_0&&o.length>0){m.texcoordArray=new Jl;const M=e.json.accessors[d.TEXCOORD_0];m.texcoordArray.resize(M.count);const k=Lh(e,M);q_(e,M,m.texcoordArray,k)}if(void 0!==d._FEATURE_ID_RGBA4444){const M=e.json.accessors[d._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(m.featureData=Lh(e,M))}void 0!==d._FEATURE_RGBA4444&&(m.featureData=new Uint32Array(Lh(e,e.json.accessors[d._FEATURE_RGBA4444]).buffer));const A=s.material;return m.material=function(M,k){const{emissiveFactor:F=[0,0,0],alphaMode:V="OPAQUE",alphaCutoff:j=.5,normalTexture:W,occlusionTexture:Q,emissiveTexture:K,doubleSided:te}=M,{baseColorFactor:me=[1,1,1,1],metallicFactor:he=1,roughnessFactor:fe=1,baseColorTexture:xe,metallicRoughnessTexture:Ee}=M.pbrMetallicRoughness||{},Ve=Q?k[Q.index]:void 0;if(Q&&Q.extensions&&Q.extensions.KHR_texture_transform&&Ve){const Ie=Q.extensions.KHR_texture_transform;Ve.offsetScale=[Ie.offset[0],Ie.offset[1],Ie.scale[0],Ie.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Yn(...me),metallicFactor:he,roughnessFactor:fe,baseColorTexture:xe?k[xe.index]:void 0,metallicRoughnessTexture:Ee?k[Ee.index]:void 0},doubleSided:te,emissiveFactor:new Yn(...F),alphaMode:V,alphaCutoff:j,normalTexture:W?k[W.index]:void 0,occlusionTexture:Ve,emissionTexture:K?k[K.index]:void 0,defined:void 0===M.defined}}(void 0!==A?e.json.materials[A]:{defined:!1},o),m}function xb(s,e,o){const{matrix:c,rotation:d,translation:m,scale:g,mesh:x,extras:w,children:T}=s,C={};if(C.matrix=c||(k=m||[0,0,0],he=(V=(M=d||[0,0,0,1])[0])*(K=V+V),fe=V*(te=(j=M[1])+j),xe=V*(me=(W=M[2])+W),Ve=j*me,Ue=(Q=M[3])*K,ot=Q*te,$e=Q*me,nt=(F=g||[1,1,1])[1],Ne=F[2],(A=[])[0]=(1-((Ee=j*te)+(Ie=W*me)))*(Ke=F[0]),A[1]=(fe+$e)*Ke,A[2]=(xe-ot)*Ke,A[3]=0,A[4]=(fe-$e)*nt,A[5]=(1-(he+Ie))*nt,A[6]=(Ve+Ue)*nt,A[7]=0,A[8]=(xe+ot)*Ne,A[9]=(Ve-Ue)*Ne,A[10]=(1-(he+Ee))*Ne,A[11]=0,A[12]=k[0],A[13]=k[1],A[14]=k[2],A[15]=1,A),void 0!==x){C.meshes=o[x];const A=C.anchor=[0,0];for(const M of C.meshes){const{min:k,max:F}=M.aabb;A[0]+=k[0]+F[0],A[1]+=k[1]+F[1]}A[0]=Math.floor(A[0]/C.meshes.length/2),A[1]=Math.floor(A[1]/C.meshes.length/2)}var A,M,k,F,V,j,W,Q,K,te,me,he,fe,xe,Ee,Ve,Ie,Ue,ot,$e,Ke,nt,Ne;if(w&&(w.id&&(C.id=w.id),w.lights&&(C.lights=function(A){if(!A.length)return[];const M=function(W){const Q=atob(W),K=new Uint8Array(Q.length);for(let te=0;te<Q.length;te++)K[te]=Q.codePointAt(te);return K}(A),k=[],F=M.length/24,V=new Uint16Array(M.buffer),j=new Float32Array(M.buffer);for(let W=0;W<F;W++){const Q=V[2*W*6]/30,K=V[2*W*6+1]/30,te=V[2*W*6+10]/100,me=j[6*W+1],he=j[6*W+2],fe=j[6*W+3],xe=j[6*W+4],Ee=fe-me,Ve=xe-he,Ie=Math.hypot(Ee,Ve);k.push({pos:[me+.5*Ee,he+.5*Ve,K],normal:[Ve/Ie,-Ee/Ie,0],width:Ie,height:Q,depth:te,points:[me,he,fe,xe]})}return k}(w.lights))),T){const A=[];for(const M of T)A.push(xb(e.json.nodes[M],e,o));C.children=A}return C}function np(s){if(0===s.vertices.length||0===s.indices.length)return null;const e=new Fm(s.vertices,s.indices,8,256),[o,c]=[e.min.clone(),e.max.clone()];return{vertices:s.vertices,indices:s.indices,grid:e,min:o,max:c}}function vE(s){if(!s.extras||!s.extras.ground)return null;const e=s.extras.ground;if(!e||!Array.isArray(e)||0===e.length)return null;const o=e[0];if(!o||!Array.isArray(o)||0===o.length)return null;const c=[];for(const g of o){if(!Array.isArray(g)||2!==g.length)continue;const x=g[0],w=g[1];"number"==typeof x&&"number"==typeof w&&c.push(new Je(x,w))}if(c.length<3)return null;c.length>1&&c[c.length-1].equals(c[0])&&c.pop();let d=0;for(let g=0;g<c.length;g++){const x=c[g],w=c[(g+1)%c.length],T=c[(g+2)%c.length];d+=(x.x-w.x)*(T.y-w.y)-(T.x-w.x)*(x.y-w.y)}d>0&&c.reverse();const m=yh(c.flatMap(g=>[g.x,g.y]),[]);return 0===m.length?null:{vertices:c,indices:m}}function ip(s,e){const o=[],c=[];let d=0;const m=[];for(const g of s){d=o.length;const x=g.vertexArray.float32,w=g.indexArray.uint16;for(let T=0;T<g.vertexArray.length;T++)m[0]=x[3*T+0],m[1]=x[3*T+1],m[2]=x[3*T+2],rr(m,m,e),o.push(new Je(m[0],m[1]));for(let T=0;T<3*g.indexArray.length;T++)c.push(w[T]+d)}if(c.length%3!=0)return null;for(let g=0;g<c.length;g+=3){const x=o[c[g+0]],w=o[c[g+1]],T=o[c[g+2]];(x.x-w.x)*(T.y-w.y)-(T.x-w.x)*(x.y-w.y)>0&&([c[g+1],c[g+2]]=[c[g+2],c[g+1]])}return{vertices:o,indices:c}}function ga(s){const o=function(w,T){const C=[];for(const A of w.json.meshes){const M=[];for(const k of A.primitives)M.push(PD(k,w,T));C.push(M)}return C}(s,function(w,T){const C=[],A=WebGL2RenderingContext;if(w.json.textures)for(const M of w.json.textures){const k={magFilter:A.LINEAR,minFilter:A.NEAREST,wrapS:A.REPEAT,wrapT:A.REPEAT};void 0!==M.sampler&&Object.assign(k,w.json.samplers[M.sampler]),C.push({image:T[M.source],sampler:k,uploaded:!1})}return C}(s,s.images)),{scenes:c,scene:d,nodes:m}=s.json,g=c?c[d||0].nodes:m,x=[];for(const w of g)x.push(xb(m[w],s,o));return function(w,T,C){const A={},M=new Set;for(let k=0;k<w.length;k++){const F=C[T[k]];if(!F.extras)continue;const V=F.extras["mapbox:footprint:version"],j=F.extras["mapbox:footprint:id"];(V||j)&&M.add(k),"1.0.0"===V&&j&&(A[j]=k)}for(let k=0;k<w.length;k++){if(M.has(k))continue;const F=w[k],V=C[T[k]];if(!V.extras)continue;let j=null;F.id in A&&(j=ip(w[A[F.id]].meshes,F.matrix)),j||(j=vE(V)),j&&(F.footprint=np(j))}if(M.size>0){const k=Array.from(M.values()).sort((F,V)=>F-V);for(let F=k.length-1;F>=0;F--)w.splice(k[F],1)}}(x,g,s.json.nodes),x}function xE(s){s.heightmap=new Float32Array(4096),s.heightmap.fill(-1);const e=s.vertexArray.float32,o=s.aabb.min[0]-1,c=s.aabb.min[1]-1,d=64/(s.aabb.max[0]-o+2),m=64/(s.aabb.max[1]-c+2);for(let g=0;g<e.length;g+=3){const x=e[g+2],w=(e[g+0]-o)*d|0,T=(e[g+1]-c)*m|0;x>s.heightmap[64*T+w]&&(s.heightmap[64*T+w]=x)}}function rp(s,e,o,c,d){o.reserve(o.length+4*s.length),c.reserve(c.length+10*s.length),d.reserve(d.length+10*s.length);let m=c.length;for(const g of s){const x=Math.min(10,Math.max(4,1.3*g.height))*e,w=[-g.normal[1],g.normal[0],0],T=Math.min(.29,.1*g.width/g.depth),C=g.width-2*g.depth*e*(T+.01),A=No([],g.pos,w,C/2),M=No([],g.pos,w,-C/2),k=[A[0],A[1],A[2]+g.height],F=[M[0],M[1],M[2]+g.height],V=No([],g.normal,w,T);Li(V,V,x);const j=No([],g.normal,w,-T);Li(j,j,x),Oi(V,A,V),Oi(j,M,j),A[2]+=.1,M[2]+=.1,c.emplaceBack(V[0],V[1],V[2]),c.emplaceBack(j[0],j[1],j[2]),c.emplaceBack(A[0],A[1],A[2]),c.emplaceBack(M[0],M[1],M[2]),c.emplaceBack(k[0],k[1],k[2]),c.emplaceBack(F[0],F[1],F[2]),c.emplaceBack(A[0],A[1],A[2]),c.emplaceBack(M[0],M[1],M[2]),c.emplaceBack(V[0],V[1],V[2]),c.emplaceBack(j[0],j[1],j[2]);const W=C/x/2;d.emplaceBack(-W-T,-1,W,.8),d.emplaceBack(W+T,-1,W,.8),d.emplaceBack(-W,0,W,1.3),d.emplaceBack(W,0,W,1.3),d.emplaceBack(W+T,-.8,W,.7),d.emplaceBack(W+T,-.8,W,.7),d.emplaceBack(0,0,W,1.3),d.emplaceBack(0,0,W,1.3),d.emplaceBack(W+T,-1.2,W,.8),d.emplaceBack(W+T,-1.2,W,.8),o.emplaceBack(6+m,4+m,8+m),o.emplaceBack(7+m,9+m,5+m),o.emplaceBack(0+m,1+m,2+m),o.emplaceBack(1+m,3+m,2+m),m+=10}}function bb(s,e){const o={};o.indexArray=new Mi,o.vertexArray=new bs,o.colorArray=new Ra,rp(s,e,o.indexArray,o.vertexArray,o.colorArray);const c={defined:!0};c.emissiveFactor=Yn.black;const d={};return d.baseColorFactor=Yn.white,c.pbrMetallicRoughness=d,o.material=c,o.aabb=new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),o}const wb=En([{name:"a_pos_3f",components:3,type:"Float32"}]),bE=En([{name:"a_normal_3",components:3,type:"Int16"}]),op=En([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),wE=En([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),W_=Re.types;function s0(s,e){const o=ht+e;for(const c of s)for(const d of c)if(d.x<-e||d.x>o||d.y<-e||d.y>o)return!1;return!0}class a0{constructor(e){this.layoutAOArray=[],this.indexArrayForConflationUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.layoutVertexArray=new bs,this.layoutNormalArray=new Hc,this.layoutColorArray=new ha,this.indexArray=new Mi,this.indexArrayForConflation=new Mi,this.entranceBloom={layoutVertexArray:new bs,layoutVertexBuffer:null,layoutAttenuationArray:new Ra,layoutAttenuationBuffer:null,layoutColorArray:new ha,layoutColorBuffer:null,indexArray:new Mi,indexArrayForConflation:new Mi,indexBuffer:null,segmentsBucket:new Gi},this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut}),this.segmentsBucket=new Gi,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.projection=e.projection,this.groundEffect=new Hv(e)}get segments(){return this.segmentsBucket}get bloomGeometry(){return this.entranceBloom}updateFootprints(e,o){for(const c of this.footprints)o.push({footprint:c,id:e})}prepare(){return function(){if(null!=B_||null!=Mh)return null;if(null!=Ah)return Ah;const e=fetch(no.BUILDING_GEN_URL);return Ah=function(o){let c,d,m,g;function x(){c=new Uint8Array(g.buffer),d=new Int32Array(g.buffer),m=new Float32Array(g.buffer)}function w(){throw new Error("Unexpected BuildingGen error.")}const T=()=>{},C={a:{a:w,f:function(A){const M=c.length,k=Math.max(A>>>0,Math.ceil(1.2*M)),F=Math.ceil((k-M)/65536);try{return g.grow(F),x(),!0}catch{return!1}},g:w,b:T,c:T,d:T,e:T}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(o,C):o.then(A=>A.arrayBuffer()).then(A=>WebAssembly.instantiate(A,C))).then(A=>{const M=A.instance.exports;return(0,M.g)(),g=M.f,x(),new Xv({setStyle:M.h,setAOOptions:M.i,setMetricOptions:M.j,setStructuralOptions:M.k,setFacadeOptions:M.l,setFauxFacadeOptions:M.m,setFacadeClassifierOptions:M.n,addFeature:M.o,addFacade:M.p,generateMesh:M.q,getLastError:M.r,getMeshCount:M.s,getPositionsPtr:M.t,getPositionsLength:M.u,getNormalsPtr:M.v,getNormalsLength:M.w,getColorsPtr:M.x,getColorsLength:M.y,getAOPtr:M.z,getAOLength:M.A,getUVPtr:M.B,getUVLength:M.C,getFauxFacadePtr:M.D,getFauxFacadeLength:M.E,getIndicesPtr:M.F,getIndicesLength:M.G,getBuildingPart:M.H,getRingCount:M.I,getRingPtr:M.J,getRingLength:M.K,free:M.L,malloc:M.M,heapU8:c,heap32:d,heapF32:m})})}(e).then(o=>(Ah=null,B_=o,B_)).catch(o=>{yn("Could not load building-gen"),Ah=null,Mh=o}),Ah}()}populate(e,o,c,d){const m=function Kv(){return B_}();if(!m)return;const g=ce(c);this.tileToMeter=g,this.brightness=o.brightness,m.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,g],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:g,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),m.setAOOptions(!1,.3),m.setMetricOptions(!1,16),m.setStructuralOptions(!0),m.setFacadeOptions(4,!0),m.setFauxFacadeOptions(!1,!1,1),m.setFacadeClassifierOptions(3);const x=new Map;for(const{feature:w}of e){if("LineString"!==W_[w.type])continue;const T=this.layers[0]._featureFilter.needGeometry,C=ze(w,T);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom),C,c))continue;const A=T?C.geometry:_e(w,c,d),M=[];for(const j of A)for(const W of j)M.push({x:W.x,y:W.y});const k={coordinates:M,crossPerc:w.properties.cross_perc,distanceToRoad:w.properties.distance_to_road,entrances:w.properties.entrances,sourceId:0},F=w.properties.source_id;let V=x.get(F);V||(V=[],x.set(F,V)),V.push(k)}this.maxHeight=0;for(const{feature:w,index:T}of e){if("LineString"===W_[w.type])continue;const C=this.layers[0]._featureFilter.needGeometry,A=ze(w,C);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom),A,c))continue;const M=C?A.geometry:_e(w,c,d),k=Eh(M,500);if(!s0(M,163))continue;const F=this.layers[0],V=F.layout.get("building-base").evaluate(w,{},c),j=F.layout.get("building-height").evaluate(w,{},c),W=F.layout.get("building-roof-shape").evaluate(w,{},c),Q=F.paint.get("building-ambient-occlusion-intensity"),K=F.paint.get("building-ambient-occlusion-ground-radius")/this.tileToMeter;if("flat"===W)continue;const te=w.properties.source_id;let me;me=x.has(te)?x.get(te):[];const he=[],fe=new Je(1/0,1/0),xe=new Je(-1/0,-1/0);for(const Xe of k)if(Xe.length>0){const tt=[];for(const Dt of Xe){const yt=[];for(let ft=Dt.length-1;ft>=0;ft--){const xt=Dt[ft];yt.push({x:xt.x,y:xt.y}),fe.x=Math.min(fe.x,xt.x),fe.y=Math.min(fe.y,xt.y),xe.x=Math.max(xe.x,xt.x),xe.y=Math.max(xe.y,xt.y)}tt.push(yt)}he.push({id:w.id,height:j,minHeight:V,sourceId:0,roofType:W,coordinates:tt})}const Ee=m.generateMesh(he,me);if("string"==typeof Ee||0===Ee.meshes.length||0===Ee.modifiedPolygonRings.length)continue;let Ve=0;for(const Xe of Ee.meshes)Ve+=Xe.positions.length/3;const Ie=this.segmentsBucket.prepareSegment(Ve,this.layoutVertexArray,this.indexArray),Ue=[];let ot=null,$e=0,Ke=-1;const nt=this.indexArray.length;let Ne=0;for(const Xe of Ee.meshes){const tt=this.layoutVertexArray.length;if("entrance"===Xe.buildingPart){const yt=new Array;for(let $t=0;$t<Xe.indices.length;$t+=12){const nn=Xe.positions[$t+0],Xt=Xe.positions[$t+1],vn=Xe.positions[$t+3],dn=Xe.positions[$t+4],ni=Xe.positions[$t+2],ie=Xe.positions[$t+8]-ni,re=1,Fe=vn-nn,lt=dn-Xt,ut=Math.hypot(Fe,lt);yt.push({pos:[nn+.5*Fe,Xt+.5*lt,ni],normal:[lt/ut,-Fe/ut,0],width:ut,height:ie,depth:re,points:[nn,Xt,vn,dn]})}const ft=this.entranceBloom.segmentsBucket.prepareSegment(10*yt.length,this.entranceBloom.layoutVertexArray,this.entranceBloom.indexArray),xt=this.entranceBloom.layoutVertexArray.length;$e=this.entranceBloom.indexArray.length,rp(yt,.5/this.tileToMeter,this.entranceBloom.indexArray,this.entranceBloom.layoutVertexArray,this.entranceBloom.layoutAttenuationArray);const zt=this.entranceBloom.layoutVertexArray.length-xt;Ke=this.entranceBloom.indexArray.length-$e;for(let $t=0;$t<zt;$t++)this.entranceBloom.layoutColorArray.emplaceBack(65535,65535);ft.vertexLength+=zt,ft.primitiveLength+=Ke,ot={part:Xe.buildingPart,vertexOffset:xt,vertexLength:zt}}for(let yt=0;yt<Xe.positions.length;yt+=3)Ne=Math.max(Ne,Xe.positions[yt+2]),this.layoutVertexArray.emplaceBack(Xe.positions[yt],Xe.positions[yt+1],Xe.positions[yt+2]);for(let yt=0;yt<Xe.normals.length;yt+=3)this.layoutNormalArray.emplaceBack(32767*Xe.normals[yt+0],32767*Xe.normals[yt+1],32767*Xe.normals[yt+2]);for(let yt=0;yt<Xe.ao.length;yt++)this.layoutAOArray.push(Xe.ao[yt]);for(let yt=0;yt<Xe.colors.length;yt+=3){const ft=1+(Xe.ao[yt/3]-1)*Q;this.layoutColorArray.emplaceBack(Xe.colors[yt]*ft<<8|Xe.colors[yt+1]*ft,Xe.colors[yt+2]*ft<<8)}const Dt=Ie.vertexLength;for(let yt=0;yt<Xe.indices.length;yt+=3)this.indexArray.emplaceBack(Dt+Xe.indices[yt],Dt+Xe.indices[yt+1],Dt+Xe.indices[yt+2]);Ie.vertexLength+=Xe.positions.length/3,Ie.primitiveLength+=Xe.indices.length/3,("roof"===Xe.buildingPart||"wall"===Xe.buildingPart||"facade_glazing"===Xe.buildingPart||"entrance"===Xe.buildingPart)&&Ue.push({part:Xe.buildingPart,vertexOffset:tt,vertexLength:Xe.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Ne),this.buildingFeatures.push({feature:A,segment:Ie,parts:Ue,buildingBloom:ot});const Qe=this.indexArray.length-nt,Ce=[],Be=[],at=new Je(1/0,1/0),et=new Je(-1/0,-1/0),Ot=this.groundEffect.vertexArray.length;for(const Xe of Ee.modifiedPolygonRings){const tt=[],Dt=new Je(1/0,1/0),yt=new Je(-1/0,-1/0);for(let ft=0;ft<Xe.length;ft+=2){const xt=Xe.length-ft-2;Dt.x=Math.min(Dt.x,Xe[xt]),Dt.y=Math.min(Dt.y,Xe[xt+1]),yt.x=Math.max(yt.x,Xe[xt]),yt.y=Math.max(yt.y,Xe[xt+1]);const zt=new Je(Xe[xt],Xe[xt+1]);tt.push(zt),Ce.push(zt.x,zt.y),Be.push(zt.clone())}at.x=Math.min(at.x,Dt.x),at.y=Math.min(at.y,Dt.y),et.x=Math.max(et.x,yt.x),et.y=Math.max(et.y,yt.y),this.groundEffect.addData(tt,[Dt,yt],K)}const Tt=this.groundEffect.vertexArray.length-Ot;(fe.x<0||xe.x>ht||fe.y<0||xe.y>ht)&&this.featuresOnBorder.push({featureId:w.id,footprintIndex:this.footprints.length});{const Xe=yh(Ce,null,2),tt=new Fm(Be,Xe,8,256);let Dt=w.id;w.properties&&w.properties.hasOwnProperty("building_id")&&(Dt=w.properties.building_id),this.footprints.push({vertices:Be,indices:Xe,grid:tt,min:at,max:et,buildingId:Dt,hiddenFlags:0,indicesOffset:nt,indicesLength:Qe,bloomIndicesOffset:$e,bloomIndicesLength:Ke,groundEffectVertexOffset:Ot,groundEffectVertexLength:Tt,segment:Ie,height:Ne})}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,w,T,{},o.availableImages,c,o.brightness),this.groundEffect.addPaintPropertiesData(w,T,{},o.availableImages,c,o.brightness)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0])}update(e,o,c,d,m,g,x){this.programConfigurations.updatePaintArrays(e,o,m,c,d,g,x),this.groundEffect.update(e,o,m,c,d,g,x)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,wb.members),this.layoutNormalBuffer=e.createVertexBuffer(this.layoutNormalArray,bE.members),this.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(this.entranceBloom.layoutVertexArray,wb.members),this.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(this.entranceBloom.layoutAttenuationArray,wE.members),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.layoutNormalBuffer.destroy(),this.layoutColorBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segmentsBucket.destroy(),this.entranceBloom.layoutVertexBuffer.destroy(),this.entranceBloom.layoutColorBuffer.destroy(),this.entranceBloom.layoutAttenuationBuffer.destroy(),this.entranceBloom.indexBuffer.destroy(),this.entranceBloom.segmentsBucket.destroy())}updateFootprintHiddenFlags(e,o,c=!0){let d=!1;const m=c?o:0,g=0|(c?-1:~o);0===this.groundEffect.hiddenByLandmarkVertexArray.length&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const x of e){const w=this.footprints[x],T=w.hiddenFlags&g|m;w.hiddenFlags!==T&&(w.hiddenFlags=T,d=!0,this.groundEffect.updateHiddenByLandmarkRange(w.groundEffectVertexOffset,w.groundEffectVertexLength,0!==w.hiddenFlags))}return d&&(this.indexArrayForConflationUploaded=!1),d}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),!this.indexArrayForConflationUploaded&&0!==this.indexArray.length){this.indexArrayForConflation.resize(this.indexArray.length),this.indexArrayForConflation.uint16.set(this.indexArray.uint16),this.entranceBloom.indexArrayForConflation.resize(this.entranceBloom.indexArray.length),this.entranceBloom.indexArrayForConflation.uint16.set(this.entranceBloom.indexArray.uint16);for(const o of this.footprints){const c=o.indicesOffset+o.indicesLength;if(0!==o.hiddenFlags){for(let m=o.indicesOffset;m<c;m++)this.indexArrayForConflation.uint16[3*m+0]=0,this.indexArrayForConflation.uint16[3*m+1]=0,this.indexArrayForConflation.uint16[3*m+2]=0;const d=o.bloomIndicesOffset+o.bloomIndicesLength;for(let m=o.bloomIndicesOffset;m<d;m++)this.entranceBloom.indexArrayForConflation.uint16[3*m+0]=0,this.entranceBloom.indexArrayForConflation.uint16[3*m+1]=0,this.entranceBloom.indexArrayForConflation.uint16[3*m+2]=0}}this.indexBuffer?this.indexBuffer.updateData(this.indexArrayForConflation):this.indexBuffer=e.createIndexBuffer(this.indexArrayForConflation,!0),this.entranceBloom.indexBuffer?this.entranceBloom.indexBuffer.updateData(this.entranceBloom.indexArrayForConflation):this.entranceBloom.indexBuffer=e.createIndexBuffer(this.entranceBloom.indexArrayForConflation,!0),this.indexArrayForConflationUploaded=!0}}uploadUpdatedColorBuffer(e){this.layoutColorBuffer?this.layoutColorBuffer.updateData(this.layoutColorArray):this.layoutColorBuffer=e.createVertexBuffer(this.layoutColorArray,op.members,!0),this.entranceBloom.layoutColorBuffer?this.entranceBloom.layoutColorBuffer.updateData(this.entranceBloom.layoutColorArray):this.entranceBloom.layoutColorBuffer=e.createVertexBuffer(this.entranceBloom.layoutColorArray,op.members,!0)}evaluate(e){const o=e.paint.get("building-ambient-occlusion-intensity");for(const c of this.buildingFeatures){const d=c.feature;d.properties["building-part"]="roof";const m=e.paint.get("building-color").evaluate(d,{},this.canonical),g=e.paint.get("building-emissive-strength").evaluate(d,{},this.canonical);d.properties["building-part"]="wall";const x=e.paint.get("building-color").evaluate(d,{},this.canonical),w=e.paint.get("building-emissive-strength").evaluate(d,{},this.canonical);d.properties["building-part"]="window";const T=e.paint.get("building-color").evaluate(d,{},this.canonical),C=e.paint.get("building-emissive-strength").evaluate(d,{},this.canonical);d.properties["building-part"]="door";const A=e.paint.get("building-color").evaluate(d,{},this.canonical),M=e.paint.get("building-emissive-strength").evaluate(d,{},this.canonical);for(const F of c.parts){let V,j=m;"roof"===F.part?(j=m,V=g):"wall"===F.part?(j=x,V=w):"facade_glazing"===F.part?(j=T,V=C):"entrance"===F.part&&(j=A,V=M),V=se(V,0,1);for(let W=0;W<F.vertexLength;W++){const Q=F.vertexOffset+W,K=1+(this.layoutAOArray[Q]-1)*o;this.layoutColorArray.emplace(Q,j.r*K*255<<8|j.g*K*255,j.b*K*255<<8|255*V)}}const k=c.buildingBloom;if(k)for(let F=0;F<k.vertexLength;F++)this.bloomGeometry.layoutColorArray.emplace(k.vertexOffset+F,255*A.r<<8|255*A.g,255*A.b<<8|51*M)}}needsEvaluation(e,o){const c=e.transform.projectionOptions,d=e.style.getBrightness();return!(this.uploaded&&c.name===this.projection.name&&this.brightness===d||(this.projection=c,this.brightness=d,0))}updateReplacement(e,o,c){if(o.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=o.updateTime;const d=o.getReplacementRegionsForTile(e.toUnwrapped());if(I_(this.activeReplacements,d))return;this.activeReplacements=d;for(const g of this.footprints)g.hiddenFlags&=-2;const m=[];for(const g of this.activeReplacements){if(g.order<=rE)continue;const x=Math.max(1,Math.pow(2,g.footprintTileId.canonical.z-e.canonical.z));for(const w of this.footprints)w.min.x>g.max.x||w.max.x<g.min.x||w.min.y>g.max.y||w.max.y<g.min.y||(m.length=0,EE(w.vertices,0,w.vertices.length,g.footprintTileId.canonical,e.canonical,m),Nv(g.footprint,m,w.indices,0,w.indices.length,0,-x)&&(w.hiddenFlags|=1))}0===this.groundEffect.hiddenByLandmarkVertexArray.length&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const g of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(g.groundEffectVertexOffset,g.groundEffectVertexLength,0!==g.hiddenFlags);this.indexArrayForConflationUploaded=!1}getHeightAtTileCoord(e,o){let c=Number.NEGATIVE_INFINITY,d=!0;const m=4*(e+ht)*ht+(o+ht);if(this.footprintLookup.hasOwnProperty(m)){const x=this.footprintLookup[m];return x?{height:x.height,hidden:0!==x.hiddenFlags}:void 0}const g=new Je(e,o);for(const x of this.footprints)e>x.max.x||x.min.x>e||o>x.max.y||x.min.y>o||x.height<=c||Dh(g,x)&&(c=x.height,this.footprintLookup[m]=x,d=0!==x.hiddenFlags);if(c!==Number.NEGATIVE_INFINITY)return{height:c,hidden:d};this.footprintLookup[m]=void 0}}function EE(s,e,o,c,d,m){const g=Math.pow(2,c.z-d.z);for(let x=0;x<o;x++){let w=s[x+e].x,T=s[x+e].y;w=(w+d.x*ht)*g-c.x*ht,T=(T+d.y*ht)*g-c.y*ht,m.push(new Je(w,T))}}let Tb,l0;wt(a0,"BuildingBucket",{omit:["layers"]});const TE=En([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),Sb=En([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:SE}=TE,DE=En([{name:"a_packed",components:3,type:"Float32"}]),{members:RD}=DE,Db=En([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Ib}=Db;class cs{constructor(e,o){this.width=e,this.height=o,this.nextRow=0,this.image=new ic({width:e,height:o}),this.positions={},this.uploaded=!1}getDash(e,o){const c=this.getKey(e,o);return this.positions[c]}trim(){const e=this.width,o=this.height=kt(this.nextRow);this.image.resize({width:e,height:o})}getKey(e,o){return e.join(",")+o}getDashRanges(e,o,c){const d=[];let m=e.length%2==1?-e[e.length-1]*c:0,g=e[0]*c,x=!0;d.push({left:m,right:g,isDash:x,zeroLength:0===e[0]});let w=e[0];for(let T=1;T<e.length;T++){x=!x;const C=e[T];m=w*c,w+=C,g=w*c,d.push({left:m,right:g,isDash:x,zeroLength:0===C})}return d}addRoundDash(e,o,c){const d=o/2;for(let m=-c;m<=c;m++){const g=this.width*(this.nextRow+c+m);let x=0,w=e[x];for(let T=0;T<this.width;T++){T/w.right>1&&(w=e[++x]);const C=Math.abs(T-w.left),A=Math.abs(T-w.right),M=Math.min(C,A);let k;const F=m/c*(d+1);if(w.isDash){const V=d-Math.abs(F);k=Math.sqrt(M*M+V*V)}else k=d-Math.sqrt(M*M+F*F);this.image.data[g+T]=Math.max(0,Math.min(255,k+128))}}}addRegularDash(e,o){for(let w=e.length-1;w>=0;--w){const T=e[w],C=e[w+1];T.zeroLength?e.splice(w,1):C&&C.isDash===T.isDash&&(C.left=T.left,e.splice(w,1))}const c=e[0],d=e[e.length-1];c.isDash===d.isDash&&(c.left=d.left-this.width,d.right=c.right+this.width);const m=this.width*this.nextRow;let g=0,x=e[g];for(let w=0;w<this.width;w++){w/x.right>1&&(x=e[++g]);const T=Math.abs(w-x.left),C=Math.abs(w-x.right),A=Math.min(T,C);this.image.data[m+w]=Math.max(0,Math.min(255,(x.isDash?A:-A)+o+128))}}addDash(e,o){const c=this.getKey(e,o);if(this.positions[c])return this.positions[c];const d="round"===o,m=d?7:0,g=2*m+1;if(this.nextRow+g>this.height)return yn("LineAtlas out of space"),null;0===e.length&&e.push(1);let x=0;for(let C=0;C<e.length;C++)e[C]<0&&(yn("Negative value is found in line dasharray, replacing values with 0"),e[C]=0),x+=e[C];if(0!==x){const C=this.width/x,A=this.getDashRanges(e,this.width,C);d?this.addRoundDash(A,C,m):this.addRegularDash(A,"square"===o?.5*C:0)}const w=this.nextRow+m;this.nextRow+=g;const T={tl:[w,m],br:[x,0]};return this.positions[c]=T,T}}wt(cs,"LineAtlas");const Cb=Re.types,OD=Math.cos(Math.PI/180*37.5),c0=Math.cos(Math.PI/180*5);class hl{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(o=>{this.gradients[o.id]={}}),this.layoutVertexArray=new zf,this.layoutVertexArray2=new bs,this.patternVertexArray=new bs,this.indexArray=new Mi,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Gi,this.maxLineLength=0,this.zOffsetVertexArray=new bs,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:ht/64,this.worldview=e.worldview}updateFootprints(e,o){}populate(e,o,c,d){this.hasPattern=x_("line",this.layers,this.pixelRatio,o);const m=this.layers[0].layout.get("line-sort-key");this.tileToMeter=ce(c);const g=this.layers[0].layout.get("line-elevation-reference");if("hd-road-markup"===g)this.elevationType="road";else{const M=this.layers[0].layout.get("line-z-offset"),k=M.isConstant()&&!M.constantOr(0);this.elevationType="sea"!==g&&"ground"!==g&&k?"none":"offset","offset"===this.elevationType&&"none"===g&&yn(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const x=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope="offset"===this.elevationType&&void 0!==x;const w=[];for(const{feature:M,id:k,index:F,sourceLayerIndex:V}of e){const j=this.layers[0]._featureFilter.needGeometry,W=ze(M,j);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),W,c))continue;const Q=m?m.evaluate(W,{},c):void 0,K={id:k,properties:M.properties,type:M.type,sourceLayerIndex:V,index:F,geometry:j?W.geometry:_e(M,c,d),patterns:{},sortKey:Q};w.push(K)}m&&w.sort((M,k)=>M.sortKey-k.sortKey);const{lineAtlas:T,featureIndex:C}=o,A=this.addConstantDashes(T);for(const M of w){const{geometry:k,index:F,sourceLayerIndex:V}=M;if(A&&this.addFeatureDashes(M,T),this.hasPattern){const j=Rv("line",this.layers,M,this.zoom,this.pixelRatio,o);this.patternFeatures.push(j)}else this.addFeature(M,k,F,c,T.positions,o.availableImages,o.brightness,o.elevationFeatures);C.insert(e[F].feature,k,F,V,this.index)}}addConstantDashes(e){let o=!1;for(const c of this.layers){const d=c.paint.get("line-dasharray").value,m=c.layout.get("line-cap").value;if("constant"!==d.kind||"constant"!==m.kind)o=!0;else{const g=m.value,x=d.value;if(!x)continue;e.addDash(x,g)}}return o}addFeatureDashes(e,o){const c=this.zoom;for(const d of this.layers){const m=d.paint.get("line-dasharray").value,g=d.layout.get("line-cap").value;if("constant"===m.kind&&"constant"===g.kind)continue;let x,w;if("constant"===m.kind){if(x=m.value,!x)continue}else x=m.evaluate({zoom:c},e);w="constant"===g.kind?g.value:g.evaluate({zoom:c},e),o.addDash(x,w),e.patterns[d.id]=[o.getKey(x,w)]}}update(e,o,c,d,m,g,x,w){this.programConfigurations.updatePaintArrays(e,o,m,c,d,g,x,w)}addFeatures(e,o,c,d,m,g){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,o,c,d,g)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,RD)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,Ib)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Sb.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,SE),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,o,c,d,m,g,x,w){const T=this.layers[0].layout,C=T.get("line-join").evaluate(e,{}),A=T.get("line-cap").evaluate(e,{}),M=T.get("line-miter-limit"),k=T.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=T.get("line-z-offset").value;const F=this.layers[0].paint.get("line-width").value;if("constant"!==F.kind&&!1===F.isLineProgressConstant&&(this.variableWidthValue=F),"road"===this.elevationType){const V=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,o,d,w,C,A,M,k)){const[j,W]=this.clipRuntimeLinesToTile(o,1);for(let Q=0;Q<j.length;Q++){const K=j[Q],te=W[Q],me={progress:{min:te.progress.min,max:te.progress.max},nextDir:this.computeSegNextDir(te,K),prevDir:this.computeSegPrevDir(te,K)};this.addLine(K,e,d,C,A,M,k,me)}this.fillNonElevatedRoadSegment(V)}}else for(const V of o)this.addLine(V,e,d,C,A,M,k);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,c,m,g,d,x,void 0,this.worldview)}computeSegNextDir(e,o){return e.nextPoint.sub(o.at(-2)).unit()}computeSegPrevDir(e,o){return o[1].sub(e.prevPoint).unit()}clipLinesToTile(e,o){return Vm(e,-o,-o,ht+o,ht+o)}clipRuntimeLinesToTile(e,o){const c=[];return[Vm(e,-o,-o,ht+o,ht+o,c),c]}addElevatedRoadFeature(e,o,c,d,m,g,x,w){const T=[],C=Fi.getElevationFeature(e,d);if(C){const A=this.clipLinesToTile(o,1),M=this.prepareElevatedLines(A,C,c);for(const k of M)T.push({geometry:k,elevation:C,elevationTileID:c,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(0===T.length)return!1;for(const A of T){const M=this.layoutVertexArray.length;this.addLine(A.geometry,e,c,m,g,x,w);const k=new Mn(c,A.elevationTileID);if(A.elevation)for(let F=M;F<this.layoutVertexArray.length;F++){const V=new Je(this.layoutVertexArray.int16[6*F]>>1,this.layoutVertexArray.int16[6*F+1]>>1),j=k.pointElevation(V,A.elevation,.05);this.updateHeightRange(j),this.zOffsetVertexArray.emplaceBack(j,0,0)}else this.fillNonElevatedRoadSegment(M)}return!0}prepareElevatedLines(e,o,c){if(null!=o.constantHeight)return e;const d=[],m=1/ce(c);for(const g of e)dE(g,new ti(o,m),0,d);return d}fillNonElevatedRoadSegment(e){for(let o=e;o<this.layoutVertexArray.length;o++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,o,c,d,m,g,x,w){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const T="none"===d;this.patternJoinNone=this.hasPattern&&T,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const C=w&&w.progress.min>0,A=w&&w.progress.max<1;if(this.lineClips){let xe={min:this.lineClips.start,max:this.lineClips.end},Ee=1;if(w){const Ue=this.lineClips.end-this.lineClips.start;xe={min:Od((ot=w.progress).min,$e={min:0,max:1},Ke=xe),max:Od(ot.max,$e,Ke)},Ue>0&&(Ee=(xe.max-xe.min)/Ue)}const Ve=+o.properties.mapbox_clip_feature_len,Ie=+o.properties.mapbox_clip_seg_len;if(Number.isNaN(Ve)||Number.isNaN(Ie)){for(let ot=0;ot<e.length-1;ot++)this.totalDistance+=e[ot].dist(e[ot+1]);const Ue=this.totalDistance/(xe.max-xe.min);this.totalFeatureLength=Number.isFinite(Ue)?Ue:0,this.lineClips.start=xe.min,this.lineClips.end=xe.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Ve,this.distance=Ie*Ee,this.lineClips.start=xe.min,this.lineClips.end=xe.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}var ot,$e,Ke;const M="Polygon"===Cb[o.type];let k=e.length;for(;k>=2&&e[k-1].equals(e[k-2]);)k--;let F=0;for(;F<k-1&&e[F].equals(e[F+1]);)F++;if(k<(M?3:2))return;"bevel"===d&&(g=1.05);const V=this.segments.prepareSegment(10*k,this.layoutVertexArray,this.indexArray);let j,W,Q,K,te,me,he,fe;w&&w.prevDir&&(me=w.prevDir.perp()),w&&w.nextDir&&(he=w.nextDir.perp()),this.e1=this.e2=-1,M&&(j=e[k-2],te=e[F].sub(j)._unit()._perp());for(let xe=F;xe<k;xe++){if(Q=xe===k-1?M?e[F+1]:void 0:e[xe+1],Q&&e[xe].equals(Q))continue;te&&(K=te),j&&(W=j),j=e[xe],fe=this.evaluateLineProgressFeatures(W?W.dist(j):0),te=Q?Q.sub(j)._unit()._perp():K,K=K||te;const Ee=W&&Q;let Ve=Ee?d:M||T?"butt":m;const Ie=K.x*te.x+K.y*te.y;if(T){const Ce=function(Be){if(Be.patternJoinNone){const at=Be.segmentPoints.length/2,et=Be.lineSoFar-Be.segmentStart;for(let Ot=0;Ot<at;++Ot){const Tt=Be.segmentPoints[2*Ot+1],Xe=Math.round(Be.segmentPoints[2*Ot])+.5+.25*Tt;Be.patternVertexArray.emplaceBack(Xe,et,Be.segmentStart),Be.patternVertexArray.emplaceBack(Xe,et,Be.segmentStart)}Be.segmentPoints.length=0}Be.e1=Be.e2=-1};if(Ee&&Ie<c0){this.updateDistance(W,j),this.addCurrentVertex(j,K,1,1,V,fe),Ce(this),this.addCurrentVertex(j,te,-1,-1,V,fe);continue}if(W){if(!Q){this.updateDistance(W,j),this.addCurrentVertex(j,K,1,1,V,fe),Ce(this);continue}Ve="miter"}}let Ue=K.add(te);0===Ue.x&&0===Ue.y||Ue._unit();const ot=Ue.x*te.x+Ue.y*te.y,$e=0!==ot?1/ot:1/0,Ke=2*Math.sqrt(2-2*ot),nt=ot<OD&&W&&Q,Ne=K.x*te.y-K.y*te.x>0,Qe=this.overscaling<=16?15*ht/(512*this.overscaling):0;if(Ee&&"round"===Ve)if($e<x)Ve="miter";else if($e<=2){const Ce=sp(j,-10,ht+10);Ve="offset"===this.elevationType&&(Ce||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===Ve&&$e>g&&(Ve="bevel"),"bevel"===Ve&&($e>2&&(Ve="flipbevel"),$e<g&&(Ve="miter")),W&&!("miter"===Ve&&nt)&&this.updateDistance(W,j),"miter"===Ve)if(nt){const Ce=j.dist(W);if(Ce>2*Qe){const at=j.sub(j.sub(W)._mult(Qe/Ce)._round());this.updateDistance(W,at),this.addCurrentVertex(at,K,0,0,V,fe),W=at}this.updateDistance(W,j),Ue._mult($e),this.addCurrentVertex(j,Ue,0,0,V,fe);const Be=j.dist(Q);if(Be>2*Qe){const at=j.add(Q.sub(j)._mult(Qe/Be)._round());this.updateDistance(j,at),this.addCurrentVertex(at,te,0,0,V,fe),j=at}}else Ue._mult($e),this.addCurrentVertex(j,Ue,0,0,V,fe);else if("flipbevel"===Ve){if($e>100)Ue=te.mult(-1);else{const Ce=$e*K.add(te).mag()/K.sub(te).mag();Ue._perp()._mult(Ce*(Ne?-1:1))}this.addCurrentVertex(j,Ue,0,0,V,fe),this.addCurrentVertex(j,Ue.mult(-1),0,0,V,fe)}else if("bevel"===Ve||"fakeround"===Ve){null!=fe&&W&&this.addCurrentVertex(j,he||K,-1,-1,V,fe);const Ce=j.dist(W)<=2*Qe&&"bevel"!==Ve,Be=Ue.mult(Ne?1:-1);Be._mult($e);const at=te.mult(Ne?-1:1),et=K.mult(Ne?-1:1),Ot=this.evaluateLineProgressFeatures(this.distance);if(null==fe&&(this.addHalfVertex(j,Be.x,Be.y,!1,!Ne,0,V,Ot),Ce||this.addHalfVertex(j,Be.x+2*et.x,Be.y+2*et.y,!1,Ne,0,V,Ot)),"fakeround"===Ve){const Tt=Math.round(180*Ke/Math.PI/20);this.addHalfVertex(j,et.x,et.y,!1,Ne,0,V,Ot);for(let Xe=0;Xe<Tt;Xe++){let tt=Xe/Tt;if(.5!==tt){const yt=tt-.5;tt+=tt*yt*(tt-1)*((1.0904+Ie*(Ie*(3.55645-1.43519*Ie)-3.2452))*yt*yt+(.848013+Ie*(.215638*Ie-1.06021)))}const Dt=at.sub(et)._mult(tt)._add(et)._unit();this.addHalfVertex(j,Dt.x,Dt.y,!1,Ne,0,V,Ot)}this.addHalfVertex(j,at.x,at.y,!1,Ne,0,V,Ot)}Ce||null!=fe||this.addHalfVertex(j,Be.x+2*at.x,Be.y+2*at.y,!1,Ne,0,V,Ot),null!=fe&&Q&&this.addCurrentVertex(j,me||te,1,1,V,fe)}else if("butt"===Ve)this.addCurrentVertex(j,Ue,0,0,V,fe);else if("square"===Ve){if(!W){const Ce=C?0:-1;this.addCurrentVertex(j,Ue,Ce,Ce,V,fe)}if(this.addCurrentVertex(j,Ue,0,0,V,fe),W){const Ce=A?0:1;this.addCurrentVertex(j,Ue,Ce,Ce,V,fe)}}else if("round"===Ve){if(W){const Ce=!Ee&&he?he:K;this.addCurrentVertex(j,Ce,0,0,V,fe),!Ee&&A||this.addCurrentVertex(j,Ce,1,1,V,fe,!0)}if(Q){const Ce=!Ee&&me?me:te;!Ee&&C||this.addCurrentVertex(j,Ce,-1,-1,V,fe,!0),this.addCurrentVertex(j,Ce,0,0,V,fe)}}}}addVerticesTo(e,o,c,d,m,g,x,w,T,C){const A=(o.w-e.w)/this.tessellationStep|0;let M=0;const k=this.scaledDistance;if(A>1){this.lineSoFar=e.w;const V=(o.x-e.x)/A,j=(o.y-e.y)/A,W=(o.z-e.z)/A,Q=(o.w-e.w)/A;for(let K=1;K<A;++K){e.x+=V,e.y+=j,e.z+=W,this.lineSoFar+=Q,M+=Q;const te=this.evaluateLineProgressFeatures(this.prevDistance+M);this.scaledDistance=(this.prevDistance+M)/this.totalDistance,this.addHalfVertex(e,c,d,C,!1,x,T,te),this.addHalfVertex(e,m,g,C,!0,-w,T,te)}}this.lineSoFar=o.w,this.scaledDistance=k;const F=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(o,c,d,C,!1,x,T,F),this.addHalfVertex(o,m,g,C,!0,-w,T,F)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&"offset"!==this.elevationType)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):yn(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let o=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(o=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),"offset"!==this.elevationType?{zOffset:0,variableWidth:o}:"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:o}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:o}}addCurrentVertex(e,o,c,d,m,g,x=!1){const w=o.x+o.y*c,T=o.y-o.x*c,C=o.y*d-o.x,A=-o.y-o.x*d;if(null!=g){const M="offset"===this.elevationType,k=-10,F=ht+10,V=g.zOffset,j=new $v(e.x,e.y,V,this.lineSoFar),W=!!M&&sp(e,k,F),Q=this.lineSoFar,K=this.distance;if(this.currentVertex)if(W){const te=this.currentVertexIsOutside,me=this.currentVertex,he=new $v(e.x,e.y,V,this.lineSoFar);if(k_(me,he,k,F),!sp(he,k,F)){if(te){this.e1=this.e2=-1,this.distance-=me.dist(j),this.lineSoFar=me.w;const fe=this.evaluateLineProgressFeatures(me.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(me,w,T,x,!1,c,m,fe),this.addHalfVertex(me,C,A,x,!0,-d,m,fe),this.prevDistance=this.distance}this.distance=this.prevDistance+me.dist(he),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(me,he,w,T,C,A,c,d,m,x),this.distance=K,this.scaledDistance=this.distance/this.totalDistance}}else{const te=this.currentVertex;if(this.currentVertexIsOutside){k_(te,j,k,F),this.e1=this.e2=-1,this.distance-=te.dist(j),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=te.w;const me=this.evaluateLineProgressFeatures(te.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(te,w,T,x,!1,c,m,me),this.addHalfVertex(te,C,A,x,!0,-d,m,me),this.prevDistance=this.distance,this.distance=K,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(te,j,w,T,C,A,c,d,m,x)}else W||(this.addHalfVertex(e,w,T,x,!1,c,m,g),this.addHalfVertex(e,C,A,x,!0,-d,m,g));this.currentVertex=j,this.currentVertexIsOutside=W,this.lineSoFar=Q}else this.addHalfVertex(e,w,T,x,!1,c,m,g),this.addHalfVertex(e,C,A,x,!0,-d,m,g)}addHalfVertex({x:e,y:o},c,d,m,g,x,w,T){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),g||this.segmentPoints.push(this.lineSoFar-this.segmentStart,x)),this.layoutVertexArray.emplaceBack((e<<1)+(m?1:0),(o<<1)+(g?1:0),Math.round(63*c)+128,Math.round(63*d)+128,1+(0===x?0:x<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const A=Ft(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,A)}const C=w.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,C),w.primitiveLength++),g?this.e2=C:this.e1=C,null!=T&&this.zOffsetVertexArray.emplaceBack(T.zOffset,T.variableWidth,T.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,o){this.prevDistance=this.distance,this.distance+=e.dist(o),this.updateScaledDistance()}}function sp(s,e,o){return s.x<e||s.x>o||s.y<e||s.y>o}let Ab,Mb;function Pb(s,e,o){return e*(ht/(s.tileSize*Math.pow(2,o-s.tileID.overscaledZ)))}wt(hl,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Z_=(s,e,o)=>(1-o)*s+o*e;function ea(s,e){return 1/Pb(s,1,e.tileZoom)}function u0(s,e,o,c){return s.translatePosMatrix(c||e.tileID.projMatrix,e,o.paint.get("line-translate"),o.paint.get("line-translate-anchor"))}const Rb=s=>{const e=[];IE(s)&&e.push("RENDER_LINE_DASH"),s.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const o=s.paint.get("line-trim-offset");0===o[0]&&0===o[1]||e.push("RENDER_LINE_TRIM_OFFSET"),0!==s.paint.get("line-border-width").constantOr(1)&&e.push("RENDER_LINE_BORDER");const c="none"===s.layout.get("line-join").constantOr("miter"),d=!!s.paint.get("line-pattern").constantOr(1);return c&&d&&e.push("LINE_JOIN_NONE"),e};function IE(s){const e=s.paint.get("line-dasharray").value;return e.value||"constant"!==e.kind}let Ei;const Ob=()=>Ei||(Ei={layout:Ab||(Ab=new Wi({"line-cap":new _t(De.layout_line["line-cap"]),"line-join":new _t(De.layout_line["line-join"]),"line-miter-limit":new it(De.layout_line["line-miter-limit"]),"line-round-limit":new it(De.layout_line["line-round-limit"]),"line-sort-key":new _t(De.layout_line["line-sort-key"]),"line-z-offset":new _t(De.layout_line["line-z-offset"]),"line-elevation-reference":new it(De.layout_line["line-elevation-reference"]),"line-cross-slope":new it(De.layout_line["line-cross-slope"]),visibility:new it(De.layout_line.visibility),"line-width-unit":new it(De.layout_line["line-width-unit"])})),paint:Mb||(Mb=new Wi({"line-opacity":new _t(De.paint_line["line-opacity"]),"line-color":new _t(De.paint_line["line-color"]),"line-translate":new it(De.paint_line["line-translate"]),"line-translate-anchor":new it(De.paint_line["line-translate-anchor"]),"line-width":new _t(De.paint_line["line-width"]),"line-gap-width":new _t(De.paint_line["line-gap-width"]),"line-offset":new _t(De.paint_line["line-offset"]),"line-blur":new _t(De.paint_line["line-blur"]),"line-dasharray":new _t(De.paint_line["line-dasharray"]),"line-pattern":new _t(De.paint_line["line-pattern"]),"line-pattern-cross-fade":new it(De.paint_line["line-pattern-cross-fade"]),"line-gradient":new Uc(De.paint_line["line-gradient"]),"line-trim-offset":new it(De.paint_line["line-trim-offset"]),"line-trim-fade-range":new it(De.paint_line["line-trim-fade-range"]),"line-trim-color":new it(De.paint_line["line-trim-color"]),"line-emissive-strength":new it(De.paint_line["line-emissive-strength"]),"line-border-width":new _t(De.paint_line["line-border-width"]),"line-border-color":new _t(De.paint_line["line-border-color"]),"line-occlusion-opacity":new it(De.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},Ei);class d0 extends _t{possiblyEvaluate(e,o){return o=new Tn(Math.floor(o.zoom),{now:o.now,fadeDuration:o.fadeDuration,transition:o.transition,worldview:o.worldview}),super.possiblyEvaluate(e,o)}evaluate(e,o,c,d){return o=Ae({},o,{zoom:Math.floor(o.zoom)}),super.evaluate(e,o,c,d)}}let Zm;function Lb(s,e){return e>0?e+2*s:s}const h0=En([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),kb=En([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Fb=En([{name:"a_projected_pos",components:4,type:"Float32"}],4);En([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const CE=En([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),zb=En([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),Nb=En([{name:"a_texb",components:2,type:"Uint16"}]),AE=En([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),ME=En([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);En([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Bb=En([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Vb=En([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);En([{name:"triangle",components:3,type:"Uint16"}]),En([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),En([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),En([{type:"Float32",name:"offsetX"}]),En([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Sr=24;function ru(s,e,o){return s.sections.forEach(c=>{c.text=function(d,m,g){const x=m.layout.get("text-transform").evaluate(g,{});return"uppercase"===x?d=d.toLocaleUpperCase():"lowercase"===x&&(d=d.toLocaleLowerCase()),zs.applyArabicShaping&&(d=zs.applyArabicShaping(d)),d}(c.text,e,o)}),s}const lc={"!":"\ufe15","#":"\uff03",$:"\uff04","%":"\uff05","&":"\uff06","(":"\ufe35",")":"\ufe36","*":"\uff0a","+":"\uff0b",",":"\ufe10","-":"\ufe32",".":"\u30fb","/":"\uff0f",":":"\ufe13",";":"\ufe14","<":"\ufe3f","=":"\uff1d",">":"\ufe40","?":"\ufe16","@":"\uff20","[":"\ufe47","\\":"\uff3c","]":"\ufe48","^":"\uff3e",_:"\ufe33","`":"\uff40","{":"\ufe37","|":"\u2015","}":"\ufe38","~":"\uff5e","\xa2":"\uffe0","\xa3":"\uffe1","\xa5":"\uffe5","\xa6":"\uffe4","\xac":"\uffe2","\xaf":"\uffe3","\u2013":"\ufe32","\u2014":"\ufe31","\u2018":"\ufe43","\u2019":"\ufe44","\u201c":"\ufe41","\u201d":"\ufe42","\u2026":"\ufe19","\u2027":"\u30fb","\u20a9":"\uffe6","\u3001":"\ufe11","\u3002":"\ufe12","\u3008":"\ufe3f","\u3009":"\ufe40","\u300a":"\ufe3d","\u300b":"\ufe3e","\u300c":"\ufe41","\u300d":"\ufe42","\u300e":"\ufe43","\u300f":"\ufe44","\u3010":"\ufe3b","\u3011":"\ufe3c","\u3014":"\ufe39","\u3015":"\ufe3a","\u3016":"\ufe17","\u3017":"\ufe18","\uff01":"\ufe15","\uff08":"\ufe35","\uff09":"\ufe36","\uff0c":"\ufe10","\uff0d":"\ufe32","\uff0e":"\u30fb","\uff1a":"\ufe13","\uff1b":"\ufe14","\uff1c":"\ufe3f","\uff1e":"\ufe40","\uff1f":"\ufe16","\uff3b":"\ufe47","\uff3d":"\ufe48","\uff3f":"\ufe33","\uff5b":"\ufe37","\uff5c":"\u2015","\uff5d":"\ufe38","\uff5f":"\ufe35","\uff60":"\ufe36","\uff61":"\ufe12","\uff62":"\ufe41","\uff63":"\ufe42","\u2190":"\u2191","\u2192":"\u2193"};function PE(s){return"\ufe36"===s||"\ufe48"===s||"\ufe38"===s||"\ufe44"===s||"\ufe42"===s||"\ufe3e"===s||"\ufe3c"===s||"\ufe3a"===s||"\ufe18"===s||"\ufe40"===s||"\ufe10"===s||"\ufe13"===s||"\ufe14"===s||"\uff40"===s||"\uffe3"===s||"\ufe11"===s||"\ufe12"===s}function RE(s){return"\ufe35"===s||"\ufe47"===s||"\ufe37"===s||"\ufe43"===s||"\ufe41"===s||"\ufe3d"===s||"\ufe3b"===s||"\ufe39"===s||"\ufe17"===s||"\ufe3f"===s}const X_=4294967296,f0=1/X_,Y_=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let fd=class{constructor(s=new Uint8Array(16)){this.buf=ArrayBuffer.isView(s)?s:new Uint8Array(s),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(s,e,o=this.length){for(;this.pos<o;){const c=this.readVarint(),d=c>>3,m=this.pos;this.type=7&c,s(d,e,this),this.pos===m&&this.skip(c)}return e}readMessage(s,e){return this.readFields(s,e,this.readVarint()+this.pos)}readFixed32(){const s=this.dataView.getUint32(this.pos,!0);return this.pos+=4,s}readSFixed32(){const s=this.dataView.getInt32(this.pos,!0);return this.pos+=4,s}readFixed64(){const s=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*X_;return this.pos+=8,s}readSFixed64(){const s=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*X_;return this.pos+=8,s}readFloat(){const s=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,s}readDouble(){const s=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,s}readVarint(s){const e=this.buf;let o,c;return c=e[this.pos++],o=127&c,c<128?o:(c=e[this.pos++],o|=(127&c)<<7,c<128?o:(c=e[this.pos++],o|=(127&c)<<14,c<128?o:(c=e[this.pos++],o|=(127&c)<<21,c<128?o:(c=e[this.pos],o|=(15&c)<<28,function(d,m,g){const x=g.buf;let w,T;if(T=x[g.pos++],w=(112&T)>>4,T<128||(T=x[g.pos++],w|=(127&T)<<3,T<128)||(T=x[g.pos++],w|=(127&T)<<10,T<128)||(T=x[g.pos++],w|=(127&T)<<17,T<128)||(T=x[g.pos++],w|=(127&T)<<24,T<128)||(T=x[g.pos++],w|=(1&T)<<31,T<128))return function ou(s,e,o){return o?4294967296*e+(s>>>0):4294967296*(e>>>0)+(s>>>0)}(d,w,m);throw new Error("Expected varint not more than 10 bytes")}(o,s,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const s=this.readVarint();return s%2==1?(s+1)/-2:s/2}readBoolean(){return!!this.readVarint()}readString(){const s=this.readVarint()+this.pos,e=this.pos;return this.pos=s,s-e>=12&&Y_?Y_.decode(this.buf.subarray(e,s)):function(o,c,d){let m="",g=c;for(;g<d;){const x=o[g];let w,T,C,A=null,M=x>239?4:x>223?3:x>191?2:1;if(g+M>d)break;1===M?x<128&&(A=x):2===M?(w=o[g+1],128==(192&w)&&(A=(31&x)<<6|63&w,A<=127&&(A=null))):3===M?(w=o[g+1],T=o[g+2],128==(192&w)&&128==(192&T)&&(A=(15&x)<<12|(63&w)<<6|63&T,(A<=2047||A>=55296&&A<=57343)&&(A=null))):4===M&&(w=o[g+1],T=o[g+2],C=o[g+3],128==(192&w)&&128==(192&T)&&128==(192&C)&&(A=(15&x)<<18|(63&w)<<12|(63&T)<<6|63&C,(A<=65535||A>=1114112)&&(A=null))),null===A?(A=65533,M=1):A>65535&&(A-=65536,m+=String.fromCharCode(A>>>10&1023|55296),A=56320|1023&A),m+=String.fromCharCode(A),g+=M}return m}(this.buf,e,s)}readBytes(){const s=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,s);return this.pos=s,e}readPackedVarint(s=[],e){const o=this.readPackedEnd();for(;this.pos<o;)s.push(this.readVarint(e));return s}readPackedSVarint(s=[]){const e=this.readPackedEnd();for(;this.pos<e;)s.push(this.readSVarint());return s}readPackedBoolean(s=[]){const e=this.readPackedEnd();for(;this.pos<e;)s.push(this.readBoolean());return s}readPackedFloat(s=[]){const e=this.readPackedEnd();for(;this.pos<e;)s.push(this.readFloat());return s}readPackedDouble(s=[]){const e=this.readPackedEnd();for(;this.pos<e;)s.push(this.readDouble());return s}readPackedFixed32(s=[]){const e=this.readPackedEnd();for(;this.pos<e;)s.push(this.readFixed32());return s}readPackedSFixed32(s=[]){const e=this.readPackedEnd();for(;this.pos<e;)s.push(this.readSFixed32());return s}readPackedFixed64(s=[]){const e=this.readPackedEnd();for(;this.pos<e;)s.push(this.readFixed64());return s}readPackedSFixed64(s=[]){const e=this.readPackedEnd();for(;this.pos<e;)s.push(this.readSFixed64());return s}readPackedEnd(){return 2===this.type?this.readVarint()+this.pos:this.pos+1}skip(s){const e=7&s;if(0===e)for(;this.buf[this.pos++]>127;);else if(2===e)this.pos=this.readVarint()+this.pos;else if(5===e)this.pos+=4;else{if(1!==e)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(s,e){this.writeVarint(s<<3|e)}realloc(s){let e=this.length||16;for(;e<this.pos+s;)e*=2;if(e!==this.length){const o=new Uint8Array(e);o.set(this.buf),this.buf=o,this.dataView=new DataView(o.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(s){this.realloc(4),this.dataView.setInt32(this.pos,s,!0),this.pos+=4}writeSFixed32(s){this.realloc(4),this.dataView.setInt32(this.pos,s,!0),this.pos+=4}writeFixed64(s){this.realloc(8),this.dataView.setInt32(this.pos,-1&s,!0),this.dataView.setInt32(this.pos+4,Math.floor(s*f0),!0),this.pos+=8}writeSFixed64(s){this.realloc(8),this.dataView.setInt32(this.pos,-1&s,!0),this.dataView.setInt32(this.pos+4,Math.floor(s*f0),!0),this.pos+=8}writeVarint(s){(s=+s||0)>268435455||s<0?function(e,o){let c,d;if(e>=0?(c=e%4294967296|0,d=e/4294967296|0):(c=~(-e%4294967296),d=~(-e/4294967296),4294967295^c?c=c+1|0:(c=0,d=d+1|0)),e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");var m,x;o.realloc(10),m=c,(x=o).buf[x.pos++]=127&m|128,m>>>=7,x.buf[x.pos++]=127&m|128,m>>>=7,x.buf[x.pos++]=127&m|128,m>>>=7,x.buf[x.pos++]=127&m|128,x.buf[x.pos]=127&(m>>>=7),function(m,g){const x=(7&m)<<4;g.buf[g.pos++]|=x|((m>>>=3)?128:0),m&&(g.buf[g.pos++]=127&m|((m>>>=7)?128:0),m&&(g.buf[g.pos++]=127&m|((m>>>=7)?128:0),m&&(g.buf[g.pos++]=127&m|((m>>>=7)?128:0),m&&(g.buf[g.pos++]=127&m|((m>>>=7)?128:0),m&&(g.buf[g.pos++]=127&m)))))}(d,o)}(s,this):(this.realloc(4),this.buf[this.pos++]=127&s|(s>127?128:0),s<=127||(this.buf[this.pos++]=127&(s>>>=7)|(s>127?128:0),s<=127||(this.buf[this.pos++]=127&(s>>>=7)|(s>127?128:0),s<=127||(this.buf[this.pos++]=s>>>7&127))))}writeSVarint(s){this.writeVarint(s<0?2*-s-1:2*s)}writeBoolean(s){this.writeVarint(+s)}writeString(s){s=String(s),this.realloc(4*s.length),this.pos++;const e=this.pos;this.pos=function(c,d,m){for(let g,x,w=0;w<d.length;w++){if(g=d.charCodeAt(w),g>55295&&g<57344){if(!x){g>56319||w+1===d.length?(c[m++]=239,c[m++]=191,c[m++]=189):x=g;continue}if(g<56320){c[m++]=239,c[m++]=191,c[m++]=189,x=g;continue}g=x-55296<<10|g-56320|65536,x=null}else x&&(c[m++]=239,c[m++]=191,c[m++]=189,x=null);g<128?c[m++]=g:(g<2048?c[m++]=g>>6|192:(g<65536?c[m++]=g>>12|224:(c[m++]=g>>18|240,c[m++]=g>>12&63|128),c[m++]=g>>6&63|128),c[m++]=63&g|128)}return m}(this.buf,s,this.pos);const o=this.pos-e;o>=128&&p0(e,o,this),this.pos=e-1,this.writeVarint(o),this.pos+=o}writeFloat(s){this.realloc(4),this.dataView.setFloat32(this.pos,s,!0),this.pos+=4}writeDouble(s){this.realloc(8),this.dataView.setFloat64(this.pos,s,!0),this.pos+=8}writeBytes(s){const e=s.length;this.writeVarint(e),this.realloc(e);for(let o=0;o<e;o++)this.buf[this.pos++]=s[o]}writeRawMessage(s,e){this.pos++;const o=this.pos;s(e,this);const c=this.pos-o;c>=128&&p0(o,c,this),this.pos=o-1,this.writeVarint(c),this.pos+=c}writeMessage(s,e,o){this.writeTag(s,2),this.writeRawMessage(e,o)}writePackedVarint(s,e){e.length&&this.writeMessage(s,jb,e)}writePackedSVarint(s,e){e.length&&this.writeMessage(s,OE,e)}writePackedBoolean(s,e){e.length&&this.writeMessage(s,FE,e)}writePackedFloat(s,e){e.length&&this.writeMessage(s,LE,e)}writePackedDouble(s,e){e.length&&this.writeMessage(s,kE,e)}writePackedFixed32(s,e){e.length&&this.writeMessage(s,Ub,e)}writePackedSFixed32(s,e){e.length&&this.writeMessage(s,LD,e)}writePackedFixed64(s,e){e.length&&this.writeMessage(s,zE,e)}writePackedSFixed64(s,e){e.length&&this.writeMessage(s,kD,e)}writeBytesField(s,e){this.writeTag(s,2),this.writeBytes(e)}writeFixed32Field(s,e){this.writeTag(s,5),this.writeFixed32(e)}writeSFixed32Field(s,e){this.writeTag(s,5),this.writeSFixed32(e)}writeFixed64Field(s,e){this.writeTag(s,1),this.writeFixed64(e)}writeSFixed64Field(s,e){this.writeTag(s,1),this.writeSFixed64(e)}writeVarintField(s,e){this.writeTag(s,0),this.writeVarint(e)}writeSVarintField(s,e){this.writeTag(s,0),this.writeSVarint(e)}writeStringField(s,e){this.writeTag(s,2),this.writeString(e)}writeFloatField(s,e){this.writeTag(s,5),this.writeFloat(e)}writeDoubleField(s,e){this.writeTag(s,1),this.writeDouble(e)}writeBooleanField(s,e){this.writeVarintField(s,+e)}};function p0(s,e,o){const c=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));o.realloc(c);for(let d=o.pos-1;d>=s;d--)o.buf[d+c]=o.buf[d]}function jb(s,e){for(let o=0;o<s.length;o++)e.writeVarint(s[o])}function OE(s,e){for(let o=0;o<s.length;o++)e.writeSVarint(s[o])}function LE(s,e){for(let o=0;o<s.length;o++)e.writeFloat(s[o])}function kE(s,e){for(let o=0;o<s.length;o++)e.writeDouble(s[o])}function FE(s,e){for(let o=0;o<s.length;o++)e.writeBoolean(s[o])}function Ub(s,e){for(let o=0;o<s.length;o++)e.writeFixed32(s[o])}function LD(s,e){for(let o=0;o<s.length;o++)e.writeSFixed32(s[o])}function zE(s,e){for(let o=0;o<s.length;o++)e.writeFixed64(s[o])}function kD(s,e){for(let o=0;o<s.length;o++)e.writeSFixed64(s[o])}const Hb=3;function Gb(s,e,o){e.glyphs=[],1===s&&o.readMessage($b,e)}function $b(s,e,o){if(3===s){const{id:c,bitmap:d,width:m,height:g,left:x,top:w,advance:T}=o.readMessage(FD,{});e.glyphs.push({id:c,bitmap:new ic({width:m+2*Hb,height:g+2*Hb},d),metrics:{width:m,height:g,left:x,top:w,advance:T}})}else 4===s?e.ascender=o.readSVarint():5===s&&(e.descender=o.readSVarint())}function FD(s,e,o){1===s?e.id=o.readVarint():2===s?e.bitmap=o.readBytes():3===s?e.width=o.readVarint():4===s?e.height=o.readVarint():5===s?e.left=o.readSVarint():6===s?e.top=o.readSVarint():7===s&&(e.advance=o.readVarint())}const Xm=Hb,Ds={horizontal:1,vertical:2,horizontalOnly:3};class ap{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,o){const c=new ap;return c.scale=e||1,c.fontStack=o,c}static forImage(e){const o=new ap;return o.image=e,o}}class lp{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,o,c){const d=new lp;for(let m=0;m<e.sections.length;m++){const g=e.sections[m];g.image?d.addImageSection(g,c):d.addTextSection(g,o)}return d}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(o,c){let d="";for(let m=0;m<o.length;m++){const g=o.charCodeAt(m+1)||null,x=o.charCodeAt(m-1)||null;d+=!c&&(g&&Vc(g)&&!lc[o[m+1]]||x&&Vc(x)&&!lc[o[m-1]])||!lc[o[m]]?o[m]:lc[o[m]]}return d}(this.text,e)}trim(){let e=0;for(let c=0;c<this.text.length&&Ym[this.text.charCodeAt(c)];c++)e++;let o=this.text.length;for(let c=this.text.length-1;c>=0&&c>=e&&Ym[this.text.charCodeAt(c)];c--)o--;this.text=this.text.substring(e,o),this.sectionIndex=this.sectionIndex.slice(e,o)}substring(e,o){const c=new lp;return c.text=this.text.substring(e,o),c.sectionIndex=this.sectionIndex.slice(e,o),c.sections=this.sections,c}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,o)=>Math.max(e,this.sections[o].scale),0)}addTextSection(e,o){this.text+=e.text,this.sections.push(ap.forText(e.scale,e.fontStack||o));const c=this.sections.length-1;for(let d=0;d<e.text.length;++d)this.sectionIndex.push(c)}addImageSection(e,o){const c=e.image?e.image.getPrimary():null;if(!c)return void yn("Can't add FormattedSection with an empty image.");c.scaleSelf(o);const d=this.getNextImageSectionCharCode();d?(this.text+=String.fromCodePoint(d),this.sections.push(ap.forImage(c)),this.sectionIndex.push(this.sections.length-1)):yn("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function K_(s,e,o,c,d,m,g,x,w,T,C,A,M,k,F,V=1){const j=lp.fromFeature(s,d,V);A===Ds.vertical&&j.verticalizePunctuation(M);let W=[];const Q=function(fe,xe,Ee,Ve,Ie,Ue){if(!fe)return[];const ot=[],$e=function(Qe,Ce,Be,at,et,Ot){let Tt=0;for(let Xe=0;Xe<Qe.length();Xe++){const tt=Qe.getSection(Xe);Tt+=qb(Qe.getCodePoint(Xe),tt,at,et,Ce,Ot)}return Tt/Math.max(1,Math.ceil(Tt/Be))}(fe,xe,Ee,Ve,Ie,Ue),Ke=fe.text.indexOf("\u200b")>=0;let nt=0;for(let Qe=0;Qe<fe.length();Qe++){const Ce=fe.getSection(Qe),Be=fe.getCodePoint(Qe);if(Ym[Be]||(nt+=qb(Be,Ce,Ve,Ie,xe,Ue)),Qe<fe.length()-1){const at=!((Ne=Be)<11904||!(Vt["Bopomofo Extended"](Ne)||Vt.Bopomofo(Ne)||Vt["CJK Compatibility Forms"](Ne)||Vt["CJK Compatibility Ideographs"](Ne)||Vt["CJK Compatibility"](Ne)||Vt["CJK Radicals Supplement"](Ne)||Vt["CJK Strokes"](Ne)||Vt["CJK Symbols and Punctuation"](Ne)||Vt["CJK Unified Ideographs Extension A"](Ne)||Vt["CJK Unified Ideographs"](Ne)||Vt["Enclosed CJK Letters and Months"](Ne)||Vt["Halfwidth and Fullwidth Forms"](Ne)||Vt.Hiragana(Ne)||Vt["Ideographic Description Characters"](Ne)||Vt["Kangxi Radicals"](Ne)||Vt["Katakana Phonetic Extensions"](Ne)||Vt.Katakana(Ne)||Vt["Vertical Forms"](Ne)||Vt["Yi Radicals"](Ne)||Vt["Yi Syllables"](Ne)));(oi[Be]||at||Ce.image)&&ot.push(g0(Qe+1,nt,$e,ot,sn(Be,fe.getCodePoint(Qe+1),at&&Ke),!1))}}var Ne;return Wb(g0(fe.length(),nt,$e,ot,0,!0))}(j,T,m,e,c,k),{processBidirectionalText:K,processStyledBidirectionalText:te}=zs;if(K&&1===j.sections.length){const fe=K(j.toString(),Q);for(const xe of fe){const Ee=new lp;Ee.text=xe,Ee.sections=j.sections;for(let Ve=0;Ve<xe.length;Ve++)Ee.sectionIndex.push(0);W.push(Ee)}}else if(te){const fe=te(j.text,j.sectionIndex,Q);for(const xe of fe){const Ee=new lp;Ee.text=xe[0],Ee.sectionIndex=xe[1],Ee.sections=j.sections,W.push(Ee)}}else W=function(fe,xe){const Ee=[],Ve=fe.text;let Ie=0;for(const Ue of xe)Ee.push(fe.substring(Ie,Ue)),Ie=Ue;return Ie<Ve.length&&Ee.push(fe.substring(Ie,Ve.length)),Ee}(j,Q);const me=[],he={positionedLines:me,text:j.toString(),top:C[1],bottom:C[1],left:C[0],right:C[0],writingMode:A,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(fe,xe,Ee,Ve,Ie,Ue,ot,$e,Ke,nt,Ne,Qe){let Ce=0,Be=0,at=0;const et="right"===$e?1:"left"===$e?0:.5;let Ot=!1;for(const ft of Ie){const xt=ft.getSections();for(const zt of xt){if(zt.image)continue;const $t=xe[zt.fontStack];if($t&&(Ot=void 0!==$t.ascender&&void 0!==$t.descender,!Ot))break}if(!Ot)break}let Tt=0;for(const ft of Ie){ft.trim();const xt=ft.getMaxScale(),zt=(xt-1)*Sr,$t={positionedGlyphs:[],lineOffset:0};fe.positionedLines[Tt]=$t;const nn=$t.positionedGlyphs;let Xt=0;if(!ft.length()){Be+=Ue,++Tt;continue}let vn=0,dn=0;for(let ie=0;ie<ft.length();ie++){const re=ft.getSection(ie),Fe=ft.getSectionIndex(ie),lt=ft.getCodePoint(ie);let ut=re.scale,pt=null,St=null,Ut=null,wn=Sr,Ht=0,hn=Ke;hn===Ds.vertical&&(12312===(Xe=lt)||12313===Xe||12316===Xe||12540===Xe||12448===Xe)&&(hn=Ds.horizontal);const si=!(hn===Ds.horizontal||!Ne&&!Af(lt)||Ne&&(Ym[lt]||nm(lt)));if(re.image){const $i=Ve.get(re.image.toString());if(!$i)continue;Ut=re.image,fe.iconsInText=fe.iconsInText||!0,St=$i.paddedRect;const en=$i.displaySize;ut=ut*Sr/Qe,pt={width:en[0],height:en[1],left:0,top:-Xm,advance:si?en[1]:en[0],localGlyph:!1},Ht=Ot?-pt.height*ut:xt*Sr-17-en[1]*ut,wn=pt.advance;const Pi=(si?en[0]:en[1])*ut-Sr*xt;Pi>0&&Pi>Xt&&(Xt=Pi)}else{const $i=Ee[re.fontStack];if(!$i)continue;$i[lt]&&(St=$i[lt]);const en=xe[re.fontStack];if(!en)continue;const Pi=en.glyphs[lt];if(!Pi)continue;if(pt=Pi.metrics,wn=8203!==lt?Sr:0,Ot){const ai=void 0!==en.ascender?Math.abs(en.ascender):0,Vn=void 0!==en.descender?Math.abs(en.descender):0,Wn=(ai+Vn)*ut;vn<Wn&&(vn=Wn,dn=(ai-Vn)/2*ut),Ht=-ai*ut}else Ht=(xt-ut)*Sr-17}si?(fe.verticalizable=!0,nn.push({glyph:lt,image:Ut,x:Ce,y:Be+Ht,vertical:si,scale:ut,localGlyph:pt.localGlyph,fontStack:re.fontStack,sectionIndex:Fe,metrics:pt,rect:St}),Ce+=wn*ut+nt):(nn.push({glyph:lt,image:Ut,x:Ce,y:Be+Ht,vertical:si,scale:ut,localGlyph:pt.localGlyph,fontStack:re.fontStack,sectionIndex:Fe,metrics:pt,rect:St}),Ce+=pt.advance*ut+nt)}0!==nn.length&&(at=Math.max(Ce-nt,at),Ot?kh(nn,et,Xt,dn,Ue*xt/2):kh(nn,et,Xt,0,Ue/2)),Ce=0;const ni=Ue*xt+Xt;$t.lineOffset=Math.max(Xt,zt),Be+=ni,++Tt}var Xe;const tt=Be,{horizontalAlign:Dt,verticalAlign:yt}=cp(ot);(function(ft,xt,zt,$t,nn,Xt){const vn=(xt-zt)*nn,dn=-Xt*$t;for(const ni of ft)for(const ie of ni.positionedGlyphs)ie.x+=vn,ie.y+=dn})(fe.positionedLines,et,Dt,yt,at,tt),fe.top+=-yt*tt,fe.bottom=fe.top+tt,fe.left+=-Dt*at,fe.right=fe.left+at,fe.hasBaseline=Ot}(he,e,o,c,W,g,x,w,A,T,M,F),!function(fe){for(const xe of fe)if(0!==xe.positionedGlyphs.length)return!1;return!0}(me))return he}const Ym={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},oi={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function qb(s,e,o,c,d,m){if(e.image){const g=c.get(e.image.toString());return g?g.displaySize[0]*e.scale*Sr/m+d:0}{const g=o[e.fontStack],x=g&&g.glyphs[s];return x?x.metrics.advance*e.scale+d:0}}function m0(s,e,o,c){const d=Math.pow(s-e,2);return c?s<e?d/2:2*d:d+Math.abs(o)*o}function sn(s,e,o){let c=0;return 10===s&&(c-=1e4),o&&(c+=150),40!==s&&65288!==s||(c+=50),41!==e&&65289!==e||(c+=50),c}function g0(s,e,o,c,d,m){let g=null,x=m0(e,o,d,m);for(const w of c){const T=m0(e-w.x,o,d,m)+w.badness;T<=x&&(g=w,x=T)}return{index:s,x:e,priorBreak:g,badness:x}}function Wb(s){return s?Wb(s.priorBreak).concat(s.index):[]}function cp(s){let e=.5,o=.5;switch(s){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(s){case"bottom":case"bottom-right":case"bottom-left":o=1;break;case"top":case"top-right":case"top-left":o=0}return{horizontalAlign:e,verticalAlign:o}}function kh(s,e,o,c,d){if(!(e||o||c||d))return;const m=s.length-1,g=s[m],x=(g.x+g.metrics.advance*g.scale)*e;for(let w=0;w<=m;w++)s[w].x-=x,s[w].y+=o+c+d}function Q_(s){return void 0!==s.imagePrimary&&void 0!==s.top&&void 0!==s.bottom&&void 0!==s.left&&void 0!==s.right}function Km(s,e,o,c){const{horizontalAlign:d,verticalAlign:m}=cp(c),g=o[0]-s.displaySize[0]*d,x=o[1]-s.displaySize[1]*m;return{imagePrimary:s,imageSecondary:e,top:x,bottom:x+s.displaySize[1],left:g,right:g+s.displaySize[0]}}function _0(s,e,o,c,d,m){const g=s.imagePrimary;let x;if(g.content){const j=g.content,W=g.pixelRatio||1;x=[j[0]/W,j[1]/W,g.displaySize[0]-j[2]/W,g.displaySize[1]-j[3]/W]}const w=e.left*m,T=e.right*m;let C,A,M,k;"width"===o||"both"===o?(k=d[0]+w-c[3],A=d[0]+T+c[1]):(k=d[0]+(w+T-g.displaySize[0])/2,A=k+g.displaySize[0]);const F=e.top*m,V=e.bottom*m;return"height"===o||"both"===o?(C=d[1]+F-c[0],M=d[1]+V+c[2]):(C=d[1]+(F+V-g.displaySize[1])/2,M=C+g.displaySize[1]),{imagePrimary:g,imageSecondary:void 0,top:C,right:A,bottom:M,left:k,collisionPadding:x}}function J_(s){return!s.imagePrimary.stretchX}function ey(s){return!s.imagePrimary.stretchY}function ty(s){return{width:s.right-s.left,height:s.bottom-s.top}}const fl=128;function ny(s,e,o){const{expression:c}=e;if("constant"===c.kind)return{kind:"constant",layoutSize:c.evaluate(new Tn(s+1,{worldview:o}))};if("source"===c.kind)return{kind:"source"};{const{zoomStops:d,interpolationType:m}=c;let g=0;for(;g<d.length&&d[g]<=s;)g++;g=Math.max(0,g-1);let x=g;for(;x<d.length&&d[x]<s+1;)x++;x=Math.min(d.length-1,x);const w=d[g],T=d[x];return"composite"===c.kind?{kind:"composite",minZoom:w,maxZoom:T,interpolationType:m}:{kind:"camera",minZoom:w,maxZoom:T,minSize:c.evaluate(new Tn(w,{worldview:o})),maxSize:c.evaluate(new Tn(T,{worldview:o})),interpolationType:m}}}function y0(s,{uSize:e,uSizeT:o},{lowerSize:c,upperSize:d}){return"source"===s.kind?c/fl:"composite"===s.kind?Ft(c/fl,d/fl,o):e}function Qm(s,e,o=1){let c=0,d=0;if("constant"===s.kind)d=s.layoutSize*o;else if("source"!==s.kind){const{interpolationType:m,minZoom:g,maxZoom:x}=s,w=m?se(ns.interpolationFactor(m,e,g,x),0,1):0;"camera"===s.kind?d=Ft(s.minSize,s.maxSize,w)*o:c=w*o}return{uSizeT:c,uSize:d}}class su extends Je{constructor(e,o,c,d,m){super(e,o),this.angle=d,this.z=c,void 0!==m&&(this.segment=m)}clone(){return new su(this.x,this.y,this.z,this.angle,this.segment)}}function v0(s,e,o,c,d){if(void 0===e.segment)return!0;let m=e,g=e.segment+1,x=0;for(;x>-o/2;){if(g--,g<0)return!1;x-=s[g].dist(m),m=s[g]}x+=s[g].dist(s[g+1]),g++;const w=[];let T=0;for(;x<o/2;){const C=s[g],A=s[g+1];if(!A)return!1;let M=s[g-1].angleTo(C)-C.angleTo(A);for(M=Math.abs((M+3*Math.PI)%(2*Math.PI)-Math.PI),w.push({distance:x,angleDelta:M}),T+=M;x-w[0].distance>c;)T-=w.shift().angleDelta;if(T>d)return!1;g++,x+=C.dist(A)}return!0}function Zb(s){let e=0;for(let o=0;o<s.length-1;o++)e+=s[o].dist(s[o+1]);return e}function Xb(s,e,o){return s?.6*e*o:0}function Yb(s,e){return Math.max(s?s.right-s.left:0,e?e.right-e.left:0)}function NE(s,e,o,c,d,m){const g=Xb(o,d,m),x=Yb(o,c)*m;let w=0;const T=Zb(s)/2;for(let C=0;C<s.length-1;C++){const A=s[C],M=s[C+1],k=A.dist(M);if(w+k>T){const F=(T-w)/k,V=Ft(A.x,M.x,F),j=Ft(A.y,M.y,F),W=new su(V,j,0,M.angleTo(A),C);return!g||v0(s,W,x,g,e)?W:void 0}w+=k}}function Kb(s,e,o,c,d,m,g,x,w){const T=Xb(c,m,g),C=Yb(c,d),A=C*g,M=0===s[0].x||s[0].x===w||0===s[0].y||s[0].y===w;return e-A<e/4&&(e=A+e/4),x0(s,M?e/2*x%e:(C/2+2*m)*g*x%e,e,T,o,A,M,!1,w)}function x0(s,e,o,c,d,m,g,x,w){const T=m/2,C=Zb(s);let A=0,M=e-o,k=[];for(let F=0;F<s.length-1;F++){const V=s[F],j=s[F+1],W=V.dist(j),Q=j.angleTo(V);for(;M+o<A+W;){M+=o;const K=(M-A)/W,te=Ft(V.x,j.x,K),me=Ft(V.y,j.y,K);if(te>=0&&te<w&&me>=0&&me<w&&M-T>=0&&M+T<=C){const he=new su(te,me,0,Q,F);c&&!v0(s,he,m,c,d)||k.push(he)}}A+=W}return x||k.length||g||(k=x0(s,A/2,o,c,d,m,g,!0,w)),k}function Qb(s){let e=0,o=0;for(const g of s)e+=g.w*g.h,o=Math.max(o,g.w);s.sort((g,x)=>x.h-g.h);const c=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),o),h:1/0}];let d=0,m=0;for(const g of s)for(let x=c.length-1;x>=0;x--){const w=c[x];if(!(g.w>w.w||g.h>w.h)){if(g.x=w.x,g.y=w.y,m=Math.max(m,g.y+g.h),d=Math.max(d,g.x+g.w),g.w===w.w&&g.h===w.h){const T=c.pop();T&&x<c.length&&(c[x]=T)}else g.h===w.h?(w.x+=g.w,w.w-=g.w):g.w===w.w?(w.y+=g.h,w.h-=g.h):(c.push({x:w.x+g.w,y:w.y,w:w.w-g.w,h:g.h}),w.y+=g.h,w.h-=g.h);break}}return{w:d,h:m,fill:e/(d*m)||0}}wt(su,"Anchor");const Fh=1;class us{static getImagePositionScale(e,o,c){if(o&&e&&e.options&&e.options.transform){const d=e.options.transform;return{x:d.a,y:d.d}}return{x:c,y:c}}constructor(e,o,c,d){this.paddedRect=e;const{pixelRatio:m,version:g,stretchX:x,stretchY:w,content:T,sdf:C,usvg:A}=o;this.pixelRatio=m,this.stretchX=x,this.stretchY=w,this.content=T,this.version=g,this.padding=c,this.sdf=C,this.usvg=A,this.scale=us.getImagePositionScale(d,A,m)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function b0(s,e,o){const c=aa.parse(s),d=function(m,g,x=[1,1]){return{x:0,y:0,w:(m.data?m.data.width:m.width*x[0])+2*g,h:(m.data?m.data.height:m.height*x[1])+2*g}}(e,o,[c.options.transform.a,c.options.transform.d]);return{bin:d,imagePosition:new us(d,e,o,c),imageVariant:c}}class Jb{constructor(e,o,c){const d=new Map,m=new Map;this.haveRenderCallbacks=[];const g=[];this.addImages(e,d,Fh,g),this.addImages(o,m,2,g);const{w:x,h:w}=Qb(g),T=new jr({width:x||1,height:w||1});for(const[C,A]of e.entries()){const M=d.get(C).paddedRect;jr.copy(A.data,T,{x:0,y:0},{x:M.x+Fh,y:M.y+Fh},A.data,c,A.sdf)}for(const[C,A]of o.entries()){const M=m.get(C),k=M.paddedRect;let F=M.padding;const V=k.x+F,j=k.y+F,W=A.data.width,Q=A.data.height;F=F>1?F-1:F,jr.copy(A.data,T,{x:0,y:0},{x:V,y:j},A.data,c),jr.copy(A.data,T,{x:0,y:Q-F},{x:V,y:j-F},{width:W,height:F},c),jr.copy(A.data,T,{x:0,y:0},{x:V,y:j+Q},{width:W,height:F},c),jr.copy(A.data,T,{x:W-F,y:0},{x:V-F,y:j},{width:F,height:Q},c),jr.copy(A.data,T,{x:0,y:0},{x:V+W,y:j},{width:F,height:Q},c),jr.copy(A.data,T,{x:W-F,y:Q-F},{x:V-F,y:j-F},{width:F,height:F},c),jr.copy(A.data,T,{x:0,y:Q-F},{x:V+W,y:j-F},{width:F,height:F},c),jr.copy(A.data,T,{x:0,y:0},{x:V+W,y:j+Q},{width:F,height:F},c),jr.copy(A.data,T,{x:W-F,y:0},{x:V-F,y:j+Q},{width:F,height:F},c)}this.lut=c,this.image=T,this.iconPositions=d,this.patternPositions=m}addImages(e,o,c,d){for(const[m,g]of e.entries()){const{bin:x,imagePosition:w,imageVariant:T}=b0(m,g,c);o.set(m,w),d.push(x),g.hasRenderCallback&&this.haveRenderCallbacks.push(T.id)}}patchUpdatedImages(e,o,c){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(d=>e.hasImage(d,c)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,c);for(const d of e.getUpdatedImages(c)){for(const m of this.iconPositions.keys()){const g=aa.parse(m);if(Qt.isEqual(g.id,d)){const x=e.getImage(d,c);this.patchUpdatedImage(this.iconPositions.get(m),x,o)}}for(const m of this.patternPositions.keys()){const g=aa.parse(m);if(Qt.isEqual(g.id,d)){const x=e.getImage(d,c);this.patchUpdatedImage(this.patternPositions.get(m),x,o)}}}}patchUpdatedImage(e,o,c){if(!e||!o||e.version===o.version)return;e.version=o.version;const[d,m]=e.tl,g=e.sdf;if(this.lut||g){const x={width:o.data.width,height:o.data.height},w=new jr(x);jr.copy(o.data,w,{x:0,y:0},{x:0,y:0},x,this.lut,g),c.update(w,{position:{x:d,y:m}})}else c.update(o.data,{position:{x:d,y:m}})}}wt(us,"ImagePosition"),wt(Jb,"ImageAtlas");const iy=1e20;function ry(s,e,o,c,d,m,g,x,w){for(let T=e;T<e+c;T++)w0(s,o*m+T,m,d,g,x,w);for(let T=o;T<o+d;T++)w0(s,T*m+e,1,c,g,x,w)}function w0(s,e,o,c,d,m,g){m[0]=0,g[0]=-iy,g[1]=iy,d[0]=s[e];for(let x=1,w=0,T=0;x<c;x++){d[x]=s[e+x*o];const C=x*x;do{const A=m[w];T=(d[x]-d[A]+C-A*A)/(x-A)/2}while(T<=g[w]&&--w>-1);w++,m[w]=x,g[w]=T,g[w+1]=iy}for(let x=0,w=0;x<c;x++){for(;g[w+1]<x;)w++;const T=m[w],C=x-T;s[e+x*o]=d[T]+C*C}}const pl=2,E0={none:0,ideographs:1,all:2};class up{constructor(e,o,c){this.requestManager=e,this.localGlyphMode=o,this.localFontFamily=c,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,o){const c=[],d=this.url||no.GLYPHS_URL;for(const m in e)for(const g of e[m])c.push({stack:m,id:g});Te(c,({stack:m,id:g},x)=>{let w=this.entries[m];w||(w=this.entries[m]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let T=w.glyphs[g];if(void 0!==T)return void x(null,{stack:m,id:g,glyph:T});if(T=this._tinySDF(w,m,g),T)return w.glyphs[g]=T,void x(null,{stack:m,id:g,glyph:T});const C=Math.floor(g/256);if(256*C>65535)return yn("glyphs > 65535 not supported"),void x(null,{stack:m,id:g,glyph:T});if(w.ranges[C])return void x(null,{stack:m,id:g,glyph:T});let A=w.requests[C];A||(A=w.requests[C]=[],up.loadGlyphRange(m,C,d,this.requestManager,(M,k)=>{if(k){w.ascender=k.ascender,w.descender=k.descender;for(const F in k.glyphs)this._doesCharSupportLocalGlyph(+F)||(w.glyphs[+F]=k.glyphs[+F]);w.ranges[C]=!0}for(const F of A)F(M,k);delete w.requests[C]})),A.push((M,k)=>{M?x(M):k&&x(null,{stack:m,id:g,glyph:k.glyphs[g]||null})})},(m,g)=>{if(m)o(m);else if(g){const x={};for(const{stack:w,id:T,glyph:C}of g)void 0===x[w]&&(x[w]={}),void 0===x[w].glyphs&&(x[w].glyphs={}),x[w].glyphs[T]=C&&{id:C.id,bitmap:C.bitmap.clone(),metrics:C.metrics},x[w].ascender=this.entries[w].ascender,x[w].descender=this.entries[w].descender;o(null,x)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==E0.none&&(this.localGlyphMode===E0.all?!!this.localFontFamily:!!this.localFontFamily&&(Vt["CJK Unified Ideographs"](e)||Vt["Hangul Syllables"](e)||Vt.Hiragana(e)||Vt.Katakana(e)||Vt["CJK Symbols and Punctuation"](e)||Vt["CJK Unified Ideographs Extension A"](e)||Vt["CJK Unified Ideographs Extension B"](e)||Vt.Osage(e)))}_tinySDF(e,o,c){const d=this.localFontFamily;if(!d||!this._doesCharSupportLocalGlyph(c))return;let m=e.tinySDF;if(!m){let V="400";/bold/i.test(o)?V="900":/medium/i.test(o)?V="500":/light/i.test(o)&&(V="200"),m=e.tinySDF=new up.TinySDF({fontFamily:d,fontWeight:V,fontSize:24*pl,buffer:3*pl,radius:8*pl}),m.fontWeight=V}if(this.localGlyphs[m.fontWeight][c])return this.localGlyphs[m.fontWeight][c];const g=String.fromCodePoint(c),{data:x,width:w,height:T,glyphWidth:C,glyphHeight:A,glyphLeft:M,glyphTop:k,glyphAdvance:F}=m.draw(g);return this.localGlyphs[m.fontWeight][c]={id:c,bitmap:new ic({width:w,height:T},x),metrics:{width:C/pl,height:A/pl,left:M/pl,top:k/pl-27,advance:F/pl,localGlyph:!0}}}}up.loadGlyphRange=function(s,e,o,c,d){const m=256*e,g=m+255,x=c.transformRequest(c.normalizeGlyphsURL(o).replace("{fontstack}",s).replace("{range}",`${m}-${g}`),ki.Glyphs);vc(x,(w,T)=>{if(w)d(w);else if(T){const C={},A=new fd(T).readFields(Gb,{});for(const M of A.glyphs)C[M.id]=M;d(null,{glyphs:C,ascender:A.ascender,descender:A.descender})}})},up.TinySDF=class{constructor({fontSize:s=24,buffer:e=3,radius:o=8,cutoff:c=.25,fontFamily:d="sans-serif",fontWeight:m="normal",fontStyle:g="normal"}={}){this.buffer=e,this.cutoff=c,this.radius=o;const x=this.size=s+4*e,w=this._createCanvas(x),T=this.ctx=w.getContext("2d",{willReadFrequently:!0});T.font=`${g} ${m} ${s}px ${d}`,T.textBaseline="alphabetic",T.textAlign="left",T.fillStyle="black",this.gridOuter=new Float64Array(x*x),this.gridInner=new Float64Array(x*x),this.f=new Float64Array(x),this.z=new Float64Array(x+1),this.v=new Uint16Array(x)}_createCanvas(s){const e=document.createElement("canvas");return e.width=e.height=s,e}draw(s){const{width:e,actualBoundingBoxAscent:o,actualBoundingBoxDescent:c,actualBoundingBoxLeft:d,actualBoundingBoxRight:m}=this.ctx.measureText(s),g=Math.ceil(o),x=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(m-d))),w=Math.min(this.size-this.buffer,g+Math.ceil(c)),T=x+2*this.buffer,C=w+2*this.buffer,A=Math.max(T*C,0),M=new Uint8ClampedArray(A),k={data:M,width:T,height:C,glyphWidth:x,glyphHeight:w,glyphTop:g,glyphLeft:0,glyphAdvance:e};if(0===x||0===w)return k;const{ctx:F,buffer:V,gridInner:j,gridOuter:W}=this;F.clearRect(V,V,x,w),F.fillText(s,V,V+g);const Q=F.getImageData(V,V,x,w);W.fill(iy,0,A),j.fill(0,0,A);for(let K=0;K<w;K++)for(let te=0;te<x;te++){const me=Q.data[4*(K*x+te)+3]/255;if(0===me)continue;const he=(K+V)*T+te+V;if(1===me)W[he]=0,j[he]=iy;else{const fe=.5-me;W[he]=fe>0?fe*fe:0,j[he]=fe<0?fe*fe:0}}ry(W,0,0,T,C,T,this.f,this.v,this.z),ry(j,V,V,x,w,T,this.f,this.v,this.z);for(let K=0;K<A;K++){const te=Math.sqrt(W[K])-Math.sqrt(j[K]);M[K]=Math.round(255-255*(te/this.radius+this.cutoff))}return k}};const au=Fh;function e1(s,e){return s+e[1]-e[0]}function t1(s,e,o,c,d=1){const m=[],g=s.imagePrimary,x=g.pixelRatio,w=g.paddedRect.w-2*au,T=g.paddedRect.h-2*au,C=(s.right-s.left)*d,A=(s.bottom-s.top)*d,M=g.stretchX||[[0,w]],k=g.stretchY||[[0,T]],F=M.reduce(e1,0),V=k.reduce(e1,0),j=w-F,W=T-V;let Q=0,K=F,te=0,me=V,he=0,fe=j,xe=0,Ee=W;if(g.content&&c){const Ie=g.content;Q=dp(M,0,Ie[0]),te=dp(k,0,Ie[1]),K=dp(M,Ie[0],Ie[2]),me=dp(k,Ie[1],Ie[3]),he=Ie[0]-Q,xe=Ie[1]-te,fe=Ie[2]-Ie[0]-K,Ee=Ie[3]-Ie[1]-me}const Ve=(Ie,Ue,ot,$e)=>{const Ke=oy(Ie.stretch-Q,K,C,s.left*d),nt=sy(Ie.fixed-he,fe,Ie.stretch,F),Ne=oy(Ue.stretch-te,me,A,s.top*d),Qe=sy(Ue.fixed-xe,Ee,Ue.stretch,V),Ce=oy(ot.stretch-Q,K,C,s.left*d),Be=sy(ot.fixed-he,fe,ot.stretch,F),at=oy($e.stretch-te,me,A,s.top*d),et=sy($e.fixed-xe,Ee,$e.stretch,V),Ot=new Je(Ke,Ne),Tt=new Je(Ce,Ne),Xe=new Je(Ce,at),tt=new Je(Ke,at),Dt=new Je(nt/x,Qe/x),yt=new Je(Be/x,et/x),ft=e*Math.PI/180;if(ft){const vn=Math.sin(ft),dn=Math.cos(ft),ni=[dn,-vn,vn,dn];Ot._matMult(ni),Tt._matMult(ni),tt._matMult(ni),Xe._matMult(ni)}const xt=Ie.stretch+Ie.fixed,zt=ot.stretch+ot.fixed,$t=Ue.stretch+Ue.fixed,nn=$e.stretch+$e.fixed,Xt=s.imageSecondary;return{tl:Ot,tr:Tt,bl:tt,br:Xe,texPrimary:{x:g.paddedRect.x+au+xt,y:g.paddedRect.y+au+$t,w:zt-xt,h:nn-$t},texSecondary:Xt?{x:Xt.paddedRect.x+au+xt,y:Xt.paddedRect.y+au+$t,w:zt-xt,h:nn-$t}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Dt,pixelOffsetBR:yt,minFontScaleX:fe/x/C,minFontScaleY:Ee/x/A,isSDF:o}};if(c&&(g.stretchX||g.stretchY)){const Ie=n1(M,j,F),Ue=n1(k,W,V);for(let ot=0;ot<Ie.length-1;ot++){const $e=Ie[ot],Ke=Ie[ot+1];for(let nt=0;nt<Ue.length-1;nt++)m.push(Ve($e,Ue[nt],Ke,Ue[nt+1]))}}else m.push(Ve({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:w+1},{fixed:0,stretch:T+1}));return m}function dp(s,e,o){let c=0;for(const d of s)c+=Math.max(e,Math.min(o,d[1]))-Math.max(e,Math.min(o,d[0]));return c}function n1(s,e,o){const c=[{fixed:-au,stretch:0}];for(const[d,m]of s){const g=c[c.length-1];c.push({fixed:d-g.stretch,stretch:g.stretch}),c.push({fixed:d-g.stretch,stretch:g.stretch+(m-d)})}return c.push({fixed:e+au,stretch:o}),c}function oy(s,e,o,c){return s/e*o+c}function sy(s,e,o,c){return s-e*o/c}function BE(s,e,o,c){const d=e+s.positionedLines[c].lineOffset;return 0===c?o+d/2:o+(d+(e+s.positionedLines[c-1].lineOffset))/2}function VE(s,e=1,o=!1){let c=1/0,d=1/0,m=-1/0,g=-1/0;const x=s[0];for(let k=0;k<x.length;k++){const F=x[k];(!k||F.x<c)&&(c=F.x),(!k||F.y<d)&&(d=F.y),(!k||F.x>m)&&(m=F.x),(!k||F.y>g)&&(g=F.y)}const w=Math.min(m-c,g-d);let T=w/2;const C=new gf([],cc);if(0===w)return new Je(c,d);for(let k=c;k<m;k+=w)for(let F=d;F<g;F+=w)C.push(new pd(k+T,F+T,T,s));let A=function(k){let F=0,V=0,j=0;const W=k[0];for(let Q=0,K=W.length,te=K-1;Q<K;te=Q++){const me=W[Q],he=W[te],fe=me.x*he.y-he.x*me.y;V+=(me.x+he.x)*fe,j+=(me.y+he.y)*fe,F+=3*fe}return new pd(V/F,j/F,0,k)}(s),M=C.length;for(;C.length;){const k=C.pop();(k.d>A.d||!A.d)&&(A=k,o&&console.log("found best %d after %d probes",Math.round(1e4*k.d)/1e4,M)),k.max-A.d<=e||(T=k.h/2,C.push(new pd(k.p.x-T,k.p.y-T,T,s)),C.push(new pd(k.p.x+T,k.p.y-T,T,s)),C.push(new pd(k.p.x-T,k.p.y+T,T,s)),C.push(new pd(k.p.x+T,k.p.y+T,T,s)),M+=4)}return o&&(console.log(`num probes: ${M}`),console.log(`best distance: ${A.d}`)),A.p}function cc(s,e){return e.max-s.max}class pd{constructor(e,o,c,d){this.p=new Je(e,o),this.h=c,this.d=function(m,g){let x=!1,w=1/0;for(let T=0;T<g.length;T++){const C=g[T];for(let A=0,M=C.length,k=M-1;A<M;k=A++){const F=C[A],V=C[k];F.y>m.y!=V.y>m.y&&m.x<(V.x-F.x)*(m.y-F.y)/(V.y-F.y)+F.x&&(x=!x),w=Math.min(w,Ys(m,F,V))}}return(x?1:-1)*Math.sqrt(w)}(this.p,d),this.max=this.d+this.h*Math.SQRT2}}const jE=Object.keys,ay=Number.POSITIVE_INFINITY,UE=Math.sqrt(2);function T0(s,[e,o]){let c=0,d=0;if(o===ay){e<0&&(e=0);const m=e/UE;switch(s){case"top-right":case"top-left":d=m-7;break;case"bottom-right":case"bottom-left":d=7-m;break;case"bottom":d=7-e;break;case"top":d=e-7}switch(s){case"top-right":case"bottom-right":c=-m;break;case"top-left":case"bottom-left":c=m;break;case"left":c=e;break;case"right":c=-e}}else{switch(e=Math.abs(e),o=Math.abs(o),s){case"top-right":case"top-left":case"top":d=o-7;break;case"bottom-right":case"bottom-left":case"bottom":d=7-o}switch(s){case"top-right":case"bottom-right":case"right":c=-e;break;case"top-left":case"bottom-left":case"left":c=e}}return[c,d]}function Jm(s,e,o,c,d,m,g,x,w){if(!e||!e.usvg)return;const T=ty(c),C=ty(d),A="both"!==m&&"width"!==m||!J_(c)?1:C.width/T.width,M="both"!==m&&"height"!==m||!ey(c)?1:C.height/T.height;o.scaleSelf(A,M);const k=o.toString();g.set(k,o),x.set(k,e);const{imagePosition:F}=b0(k,e,Fh);w.set(k,F)}function eg(s,e,o,c,d,m,g,x,w){if(!s)return;const T=function(C,A,M,k,F,V){if("camera"===C.kind)return C.maxSize;if("composite"===C.kind){const j=A.possiblyEvaluate(new Tn(C.maxZoom,{worldview:V}),M).evaluate(F,{},M),W=A.possiblyEvaluate(new Tn(C.minZoom,{worldview:V}),M).evaluate(F,{},M);return Math.max(j,W)}return A.possiblyEvaluate(new Tn(k,{worldview:V})).evaluate(F,{},M)}(e,o,c,d,m,w);return s.scaleSelf(T*x*g)}function ly(s,e,o,c,d,m,g,x,w){return{iconPrimary:eg(s.getPrimary(),e,o,c,d,m,g,x,w),iconSecondary:eg(s.getSecondary(),e,o,c,d,m,g,x,w)}}function zD(s,e,o){if(!e)return;const c=o.get(s.toString()),d=o.get(e.toString());d&&(c.paddedRect.w===d.paddedRect.w&&c.paddedRect.h===d.paddedRect.h||yn(`Mismatch in icon variant sizes: ${s.toString()} and ${e.toString()}`),c.usvg!==d.usvg&&yn(`Mismatch in icon variant image types: ${s.id} and ${e.id}`))}function S0(s,e,o,c){if(!s)return;const d=e.get(o.toString());if(s.imagePrimary=d,c){const m=e.get(c.toString());s.imageSecondary=m}}function r1(s,e){for(const o in s.horizontal)D0(s.horizontal[o],e);D0(s.vertical,e)}function D0(s,e){if(s)for(const o of s.positionedLines)for(const c of o.positionedGlyphs)if(null!==c.image){const d=c.image.toString();c.rect=e.get(d).paddedRect}}function cy(s){switch(s){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function I0(s,e,o,c,d,m,g,x,w){const T=C0(m.horizontal)||m.vertical,C=o.get("icon-text-fit-padding").evaluate(c,{},d);let A,M=e;return e&&"none"!==w&&(s.allowVerticalPlacement&&m.vertical&&(A=_0(e,m.vertical,w,C,x,g)),T&&(M=_0(e,T,w,C,x,g))),{defaultShapedIcon:M,verticallyShapedIcon:A}}function lu(s,e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W,Q,K){let te=g.textMaxSize.evaluate(e,{},M);void 0===te?te=x*g.textScaleFactor:te*=g.textScaleFactor;const me=s.layers[0].layout,he=C0(o.horizontal)||o.vertical,fe="globe"===k.name,xe=Sr,Ee=s.tilePixelRatio*te/xe,Ve=(nt=s.overscaling,s.zoom>18&&nt>2&&(nt>>=1),Math.max(ht/(512*nt),1)*me.get("symbol-spacing")),Ie=me.get("text-padding")*s.tilePixelRatio,Ue=me.get("icon-padding")*s.tilePixelRatio,ot=Pn(me.get("text-max-angle")),$e="map"===me.get("icon-rotation-alignment")&&"point"!==K,Ke=Ve/2;var nt;!1===s.hasAnyIconTextFit&&"none"!==j&&(s.hasAnyIconTextFit=!0);const Ne=e.properties?+e.properties[vt]:null,Qe=Ne&&s.elevationFeatureIdToIndex?s.elevationFeatureIdToIndex.get(Ne):65535,Ce=(Be,at,et)=>{if(at.x<0||at.x>=ht||at.y<0||at.y>=ht)return;let Ot=null;if(fe){const{x:Tt,y:Xe,z:tt}=k.projectTilePoint(at.x,at.y,et);Ot={anchor:new su(Tt,Xe,tt,0,void 0),up:k.upVector(et,at.x,at.y)}}!function(Tt,Xe,tt,Dt,yt,ft,xt,zt,$t,nn,Xt,vn,dn,ni,ie,re,Fe,lt,ut,pt,St,Ut,wn,Ht,hn,si,$i,en,Pi){const ai=Tt.addToLineVertexArray(Xe,Dt);let Vn,Wn,Ri,hi,gi,ii,ln,ri=0,zi=0,jt=0,Cn=0,Ci=-1,Xi=-1;const fi={};let Mr=Bd("");const ui=tt?tt.anchor:Xe,Dr="none"!==en;let Lo=0,lo=0;if(void 0===$t._unevaluatedLayout.getValue("text-radial-offset")){const ur=$t.layout.get("text-offset").evaluate(St,{},hn);Lo=ur[0]*Sr,lo=ur[1]*Sr}else Lo=$t.layout.get("text-radial-offset").evaluate(St,{},hn)*Sr,lo=ay;if(Tt.allowVerticalPlacement&&yt.vertical){const ur=yt.vertical;if(ie)ii=A0(ur),zt&&(ln=A0(zt));else{const xr=$t.layout.get("text-rotate").evaluate(St,{},hn)+90;Ri=ng(nn,ui,Xe,Xt,vn,dn,ur,ni,xr,re),zt&&(hi=ng(nn,ui,Xe,Xt,vn,dn,zt,lt,xr))}}if(ft){const ur=Tt.iconSizeData,xr=$t.layout.get("icon-rotate").evaluate(St,{},hn),Eo=t1(ft,xr,wn,Dr,Ut.iconScaleFactor),$o=zt?t1(zt,xr,wn,Dr,Ut.iconScaleFactor):void 0;Wn=ng(nn,ui,Xe,Xt,vn,dn,ft,lt,xr,null),ri=4*Eo.length;let ko=null;"source"===ur.kind?(ko=[fl*$t.layout.get("icon-size").evaluate(St,{},hn)*Ut.iconScaleFactor],ko[0]>md&&yn(`${Tt.layerIds[0]}: Value for "icon-size" is >= ${tg}. Reduce your "icon-size".`)):"composite"===ur.kind&&(ko=[fl*Ut.compositeIconSizes[0].evaluate(St,{},hn)*Ut.iconScaleFactor,fl*Ut.compositeIconSizes[1].evaluate(St,{},hn)*Ut.iconScaleFactor],(ko[0]>md||ko[1]>md)&&yn(`${Tt.layerIds[0]}: Value for "icon-size" is >= ${tg}. Reduce your "icon-size".`)),Tt.addSymbols(Tt.icon,Eo,ko,pt,ut,St,void 0,tt,Xe,ai.lineStartIndex,ai.lineLength,-1,Ht,hn,si,$i),Ci=Tt.icon.placedSymbolArray.length-1,$o&&(zi=4*$o.length,Tt.addSymbols(Tt.icon,$o,ko,pt,ut,St,Ds.vertical,tt,Xe,ai.lineStartIndex,ai.lineLength,-1,Ht,hn,si,$i),Xi=Tt.icon.placedSymbolArray.length-1)}for(const ur in yt.horizontal){const xr=ur,Eo=yt.horizontal[xr];Vn||(Mr=Bd(Eo.text),ie?gi=A0(Eo):Vn=ng(nn,ui,Xe,Xt,vn,dn,Eo,ni,$t.layout.get("text-rotate").evaluate(St,{},hn),re));const $o=1===Eo.positionedLines.length;if(jt+=uy(Tt,tt,Xe,Eo,xt,$t,ie,St,re,ai,yt.vertical?Ds.horizontal:Ds.horizontalOnly,$o?jE(yt.horizontal):[xr],fi,Ci,Ut,Ht,hn,si),$o)break}yt.vertical&&(Cn+=uy(Tt,tt,Xe,yt.vertical,xt,$t,ie,St,re,ai,Ds.vertical,["vertical"],fi,Xi,Ut,Ht,hn,si));let Jr=-1;const hs=(ur,xr)=>ur?Math.max(ur,xr):xr;Jr=hs(gi,Jr),Jr=hs(ii,Jr),Jr=hs(ln,Jr);const uc=Jr>-1?1:0;Tt.glyphOffsetArray.length>=65535&&yn("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==St.sortKey&&Tt.addToSortKeyRanges(Tt.symbolInstances.length,St.sortKey),Tt.symbolInstances.emplaceBack(Xe.x,Xe.y,ui.x,ui.y,ui.z,fi.right>=0?fi.right:-1,fi.center>=0?fi.center:-1,fi.left>=0?fi.left:-1,fi.vertical>=0?fi.vertical:-1,Ci,Xi,Mr,void 0!==Vn?Vn:Tt.collisionBoxArray.length,void 0!==Vn?Vn+1:Tt.collisionBoxArray.length,void 0!==Ri?Ri:Tt.collisionBoxArray.length,void 0!==Ri?Ri+1:Tt.collisionBoxArray.length,void 0!==Wn?Wn:Tt.collisionBoxArray.length,void 0!==Wn?Wn+1:Tt.collisionBoxArray.length,hi||Tt.collisionBoxArray.length,hi?hi+1:Tt.collisionBoxArray.length,Xt,jt,Cn,ri,zi,uc,0,Lo,lo,Jr,0,Dr?1:0,Pi)}(s,at,Ot,Be,o,c,m,d,s.layers[0],s.collisionBoxArray,e.index,e.sourceLayerIndex,s.index,Ie,Q,T,0,Ue,$e,W,e,g,C,A,M,F,V,j,Qe)};if("line"===K)for(const Be of Vm(e.geometry,0,0,ht,ht)){const at=Kb(Be,Ve,ot,o.vertical||he,c,xe,Ee,s.overscaling,ht);for(const et of at)he&&dy(s,he.text,Ke,et)||Ce(Be,et,M)}else if("line-center"===K){for(const Be of e.geometry)if(Be.length>1){const at=NE(Be,ot,o.vertical||he,c,xe,Ee);at&&Ce(Be,at,M)}}else if("Polygon"===e.type)for(const Be of Eh(e.geometry,0)){const at=VE(Be,16);Ce(Be[0],new su(at.x,at.y,0,0,void 0),M)}else if("LineString"===e.type)for(const Be of e.geometry)Ce(Be,new su(Be[0].x,Be[0].y,0,0,void 0),M);else if("Point"===e.type)for(const Be of e.geometry)for(const at of Be)Ce([at],new su(at.x,at.y,0,0,void 0),M)}const tg=255,md=tg*fl;function uy(s,e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j,W){const Q=function(me,he,fe,xe,Ee,Ve,Ie,Ue){const ot=[];if(0===he.positionedLines.length)return ot;const $e=xe.layout.get("text-rotate").evaluate(Ve,{})*Math.PI/180,Ke=function(Be){const at=Be[0],et=Be[1],Ot=at*et;return Ot>0?[at,-et]:Ot<0?[-at,et]:0===at?[et,at]:[et,-at]}(fe);let nt=Math.abs(he.top-he.bottom);for(const Be of he.positionedLines)nt-=Be.lineOffset;const Ne=he.positionedLines.length,Qe=nt/Ne;let Ce=he.top-fe[1];for(let Be=0;Be<Ne;++Be){const at=he.positionedLines[Be];Ce=BE(he,Qe,Ce,Be);for(const et of at.positionedGlyphs){if(!et.rect)continue;const Ot=et.rect||{};let Tt=Xm+1,Xe=!0,tt=1,Dt=0;if(et.image){const St=Ie.get(et.image.toString());if(!St)continue;if(St.sdf){yn("SDF images are not supported in formatted text and will be ignored.");continue}Xe=!1,tt=St.pixelRatio,Tt=Fh/tt}const yt=(Ee||Ue)&&et.vertical,ft=et.metrics.advance*et.scale/2,xt=et.metrics,zt=et.rect;if(null===zt)continue;Ue&&he.verticalizable&&(Dt=et.image?ft-et.metrics.width*et.scale/2:0);const $t=Ee?[et.x+ft,et.y]:[0,0];let nn=[0,0],Xt=[0,0],vn=!1;Ee||(yt?(Xt=[et.x+ft+Ke[0],et.y+Ke[1]-Dt],vn=!0):nn=[et.x+ft+fe[0],et.y+fe[1]-Dt]);const dn=zt.w*et.scale/(tt*(et.localGlyph?pl:1)),ni=zt.h*et.scale/(tt*(et.localGlyph?pl:1));let ie,re,Fe,lt;if(yt){const St=et.y-Ce,Ut=new Je(-ft,ft-St),wn=-Math.PI/2,Ht=new Je(...Xt);ie=new Je(-ft+nn[0],nn[1]),ie._rotateAround(wn,Ut)._add(Ht),ie.x+=-St+ft,ie.y-=(xt.left-Tt)*et.scale;const hn=et.image?xt.advance*et.scale:Sr*et.scale,si=String.fromCodePoint(et.glyph);PE(si)?ie.x+=(1-Tt)*et.scale:RE(si)?ie.x+=hn-xt.height*et.scale+(-Tt-1)*et.scale:ie.x+=et.image||xt.width+2*Tt===zt.w&&xt.height+2*Tt===zt.h?(hn-ni)/2:(hn-(xt.height+2*Tt)*et.scale)/2,re=new Je(ie.x,ie.y-dn),Fe=new Je(ie.x+ni,ie.y),lt=new Je(ie.x+ni,ie.y-dn)}else{const St=(xt.left-Tt)*et.scale-ft+nn[0],Ut=(-xt.top-Tt)*et.scale+nn[1],wn=St+dn,Ht=Ut+ni;ie=new Je(St,Ut),re=new Je(wn,Ut),Fe=new Je(St,Ht),lt=new Je(wn,Ht)}if($e){let St;St=Ee?new Je(0,0):vn?new Je(Ke[0],Ke[1]):new Je(fe[0],fe[1]),ie._rotateAround($e,St),re._rotateAround($e,St),Fe._rotateAround($e,St),lt._rotateAround($e,St)}const ut=new Je(0,0),pt=new Je(0,0);ot.push({tl:ie,tr:re,bl:Fe,br:lt,texPrimary:Ot,texSecondary:void 0,writingMode:he.writingMode,glyphOffset:$t,sectionIndex:et.sectionIndex,isSDF:Xe,pixelOffsetTL:ut,pixelOffsetBR:pt,minFontScaleX:0,minFontScaleY:0})}}return ot}(0,c,w,m,g,x,d,s.allowVerticalPlacement),K=s.textSizeData;let te=null;"source"===K.kind?(te=[fl*m.layout.get("text-size").evaluate(x,{},j)*F.textScaleFactor],te[0]>md&&yn(`${s.layerIds[0]}: Value for "text-size" is >= ${tg}. Reduce your "text-size".`)):"composite"===K.kind&&(te=[fl*F.compositeTextSizes[0].evaluate(x,{},j)*F.textScaleFactor,fl*F.compositeTextSizes[1].evaluate(x,{},j)*F.textScaleFactor],(te[0]>md||te[1]>md)&&yn(`${s.layerIds[0]}: Value for "text-size" is >= ${tg}. Reduce your "text-size".`)),s.addSymbols(s.text,Q,te,w,g,x,C,e,o,T.lineStartIndex,T.lineLength,k,V,j,W,!1);for(const me of A)M[me]=s.text.placedSymbolArray.length-1;return 4*Q.length}function C0(s){for(const e in s)return s[e];return null}function ng(s,e,o,c,d,m,g,x,w,T){let C=g.top,A=g.bottom,M=g.left,k=g.right;if(Q_(g)&&g.collisionPadding){const F=g.collisionPadding;M-=F[0],C-=F[1],k+=F[2],A+=F[3]}if(w){const F=new Je(M,C),V=new Je(k,C),j=new Je(M,A),W=new Je(k,A),Q=Pn(w);let K=new Je(0,0);T&&(K=new Je(T[0],T[1])),F._rotateAround(Q,K),V._rotateAround(Q,K),j._rotateAround(Q,K),W._rotateAround(Q,K),M=Math.min(F.x,V.x,j.x,W.x),k=Math.max(F.x,V.x,j.x,W.x),C=Math.min(F.y,V.y,j.y,W.y),A=Math.max(F.y,V.y,j.y,W.y)}return s.emplaceBack(e.x,e.y,e.z,o.x,o.y,M,C,k,A,x,c,d,m),s.length-1}function A0(s){Q_(s)&&s.collisionPadding&&(s.top-=s.collisionPadding[1],s.bottom+=s.collisionPadding[3]);const e=s.bottom-s.top;return e>0?Math.max(10,e):null}function dy(s,e,o,c){const d=s.compareText;if(e in d){const m=d[e];for(let g=m.length-1;g>=0;g--)if(c.dist(m[g])<o)return!0}else d[e]=[];return d[e].push(c),!1}function hp(s,e){const o=s.fovAboveCenter,c=s.elevation?s.elevation.getMinElevationBelowMSL()*e:0,d=(s._camera.position[2]*s.worldSize-c)/Math.cos(s._pitch),m=Math.sin(o)*d/Math.sin(Math.max(Math.PI/2-s._pitch-o,.01));let g=Math.sin(s._pitch)*m+d;const x=d*(1/s._horizonShift);if(!s.elevation||0===s.elevation.exaggeration()){let w=Math.max(s.zoom-17,0);s.isOrthographic&&(w/=10),g*=1+w}return Math.min(1.01*g,x)}function fp(s,e){if(!e.isReprojectedInTileSpace)return{scale:1<<s.z,x:s.x,y:s.y,x2:s.x+1,y2:s.y+1,projection:e};const o=Math.pow(2,-s.z),c=s.x*o,d=(s.x+1)*o,m=s.y*o,g=(s.y+1)*o,x=Y(c),w=Y(d),T=ee(m),C=ee(g),A=e.project(x,T),M=e.project(w,T),k=e.project(w,C),F=e.project(x,C);let V=Math.min(A.x,M.x,k.x,F.x),j=Math.min(A.y,M.y,k.y,F.y),W=Math.max(A.x,M.x,k.x,F.x),Q=Math.max(A.y,M.y,k.y,F.y);const K=o/16;function te(he,fe,xe,Ee,Ve,Ie){const Ue=(xe+Ve)/2,ot=(Ee+Ie)/2,$e=e.project(Y(Ue),ee(ot)),Ke=Math.max(0,V-$e.x,j-$e.y,$e.x-W,$e.y-Q);V=Math.min(V,$e.x),W=Math.max(W,$e.x),j=Math.min(j,$e.y),Q=Math.max(Q,$e.y),Ke>K&&(te(he,$e,xe,Ee,Ue,ot),te($e,fe,Ue,ot,Ve,Ie))}te(A,M,c,m,d,m),te(M,k,d,m,d,g),te(k,F,d,g,c,g),te(F,A,c,g,c,m),V-=K,j-=K,W+=K,Q+=K;const me=1/Math.max(W-V,Q-j);return{scale:me,x:V*me,y:j*me,x2:W*me,y2:Q*me,projection:e}}function ig(s,{x:e,y:o},c=0){return new Je(((e-c)*s.scale-s.x)*ht,(o*s.scale-s.y)*ht)}const ND=fn(new Float32Array(16));class gd{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,o){return{x:0,y:0,z:0}}unproject(e,o){return new R(0,0)}projectTilePoint(e,o,c){return{x:e,y:o,z:0}}locationPoint(e,o,c,d=!0){return e._coordinatePoint(e.locationCoordinate(o,c),d)}pixelsPerMeter(e,o){return G(1,e)*o}pixelSpaceConversion(e,o,c){return 1}farthestPixelDistance(e){return hp(e,e.pixelsPerMeter)}pointCoordinate(e,o,c,d){const m=e.horizonLineFromTop(!1),g=new Je(o,Math.max(m,c));return e.rayIntersectionCoordinate(e.pointRayIntersection(g,d))}pointCoordinate3D(e,o,c){const d=new Je(o,c);if(e.elevation)return e.elevation.pointCoordinate(d);{const m=this.pointCoordinate(e,d.x,d.y,0);return[m.x,m.y,m.z]}}isPointAboveHorizon(e,o){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,o.x,o.y);const c=e.horizonLineFromTop();return o.y<c}createInversionMatrix(e,o){return ND}createTileMatrix(e,o,c){let d,m,g;const x=c.canonical,w=fn(new Float64Array(16));if(this.isReprojectedInTileSpace){const T=fp(x,this);d=1,m=T.x+c.wrap*T.scale,g=T.y,eo(w,w,[d/T.scale,d/T.scale,e.pixelsPerMeter/o])}else d=o/e.zoomScale(x.z),m=(x.x+Math.pow(2,x.z)*c.wrap)*d,g=x.y*d;return zo(w,w,[m,g,0]),eo(w,w,[d/ht,d/ht,1]),w}upVector(e,o,c){return[0,0,1]}upVectorScale(e,o,c){return{metersToTile:1}}}class o1 extends gd{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[o,c]=this.parallels=e.parallels||[29.5,45.5],d=Math.sin(Pn(o));this.n=(d+Math.sin(Pn(c)))/2,this.c=1+d*(2*this.n-d),this.r0=Math.sqrt(this.c)/this.n}project(e,o){const{n:c,c:d,r0:m}=this,g=Pn(e-this.center[0]),x=Pn(o),w=Math.sqrt(d-2*c*Math.sin(x))/c;return{x:w*Math.sin(g*c),y:w*Math.cos(g*c)-m,z:0}}unproject(e,o){const{n:c,c:d,r0:m}=this,g=m+o;let x=Math.atan2(e,Math.abs(g))*Math.sign(g);g*c<0&&(x-=Math.PI*Math.sign(e)*Math.sign(g));const w=Pn(this.center[0])*c;x=ke(x,-Math.PI-w,Math.PI-w);const T=se(Pe(x/c)+this.center[0],-180,180),C=Math.asin(se((d-(e*e+g*g)*c*c)/(2*c),-1,1)),A=se(Pe(C),-le,le);return new R(T,A)}}const pp=1.340264,rg=-.081106,og=893e-6,mp=.003796,sg=Math.sqrt(3)/2;class ag extends gd{project(e,o){o=o/180*Math.PI,e=e/180*Math.PI;const c=Math.asin(sg*Math.sin(o)),d=c*c,m=d*d*d;return{x:.5*(e*Math.cos(c)/(sg*(pp+3*rg*d+m*(7*og+9*mp*d)))/Math.PI+.5),y:1-.5*(c*(pp+rg*d+m*(og+mp*d))/Math.PI+1),z:0}}unproject(e,o){e=(2*e-.5)*Math.PI;let c=o=(2*(1-o)-1)*Math.PI,d=c*c,m=d*d*d;for(let C,A,M,k=0;k<12&&(A=c*(pp+rg*d+m*(og+mp*d))-o,M=pp+3*rg*d+m*(7*og+9*mp*d),C=A/M,c=se(c-C,-Math.PI/3,Math.PI/3),d=c*c,m=d*d*d,!(Math.abs(C)<1e-12));++k);const g=sg*e*(pp+3*rg*d+m*(7*og+9*mp*d))/Math.cos(c),x=Math.asin(Math.sin(c)/sg),w=se(180*g/Math.PI,-180,180),T=se(180*x/Math.PI,-le,le);return new R(w,T)}}class HE extends gd{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,o){return{x:.5+e/360,y:.5-o/360,z:0}}unproject(e,o){const c=360*(e-.5),d=se(360*(.5-o),-le,le);return new R(c,d)}}const zh=Math.PI/2;function lg(s){return Math.tan((zh+s)/2)}class GE extends gd{constructor(e){super(e),this.center=e.center||[0,30];const[o,c]=this.parallels=e.parallels||[30,30];let d=Pn(o),m=Pn(c);this.southernCenter=d+m<0,this.southernCenter&&(d=-d,m=-m);const g=Math.cos(d),x=lg(d);this.n=d===m?Math.sin(d):Math.log(g/Math.cos(m))/Math.log(lg(m)/x),this.f=g*Math.pow(lg(d),this.n)/this.n}project(e,o){o=Pn(o),this.southernCenter&&(o=-o),e=Pn(e-this.center[0]);const c=1e-6,{n:d,f:m}=this;m>0?o<-zh+c&&(o=-zh+c):o>zh-c&&(o=zh-c);const g=m/Math.pow(lg(o),d);let x=g*Math.sin(d*e),w=m-g*Math.cos(d*e);return x=.5*(x/Math.PI+.5),w=.5*(w/Math.PI+.5),{x,y:this.southernCenter?w:1-w,z:0}}unproject(e,o){e=(2*e-.5)*Math.PI,this.southernCenter&&(o=1-o),o=(2*(1-o)-.5)*Math.PI;const{n:c,f:d}=this,m=d-o,g=Math.sign(m),x=Math.sign(c)*Math.sqrt(e*e+m*m);let w=Math.atan2(e,Math.abs(m))*g;m*c<0&&(w-=Math.PI*Math.sign(e)*g);const T=se(Pe(w/c)+this.center[0],-180,180),C=se(Pe(2*Math.atan(Math.pow(d/x,1/c))-zh),-le,le);return new R(T,this.southernCenter?-C:C)}}class s1 extends gd{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,o){return{x:U(e),y:q(o),z:0}}unproject(e,o){const c=Y(e),d=ee(o);return new R(c,d)}}const gp=Pn(le);class $E extends gd{project(e,o){const c=(o=Pn(o))*o,d=c*c;return{x:.5*((e=Pn(e))*(.8707-.131979*c+d*(d*(.003971*c-.001529*d)-.013791))/Math.PI+.5),y:1-.5*(o*(1.007226+c*(.015085+d*(.028874*c-.044475-.005916*d)))/Math.PI+1),z:0}}unproject(e,o){e=(2*e-.5)*Math.PI;let c=o=(2*(1-o)-1)*Math.PI,d=25,m=0,g=c*c;do{g=c*c;const T=g*g;m=(c*(1.007226+g*(.015085+T*(.028874*g-.044475-.005916*T)))-o)/(1.007226+g*(.045255+T*(.259866*g-.311325-.005916*11*T))),c=se(c-m,-gp,gp)}while(Math.abs(m)>1e-6&&--d>0);g=c*c;const x=se(Pe(e/(.8707+g*(g*(g*g*g*(.003971-.001529*g)-.013791)-.131979))),-180,180),w=Pe(c);return new R(x,w)}}const a1=Pn(le);class qE extends gd{project(e,o){o=Pn(o),e=Pn(e);const c=Math.cos(o),d=2/Math.PI,m=Math.acos(c*Math.cos(e/2)),g=Math.sin(m)/m,x=.5*(e*d+2*c*Math.sin(e/2)/g)||0,w=.5*(o+Math.sin(o)/g)||0;return{x:.5*(x/Math.PI+.5),y:1-.5*(w/Math.PI+1),z:0}}unproject(e,o){let c=e=(2*e-.5)*Math.PI,d=o=(2*(1-o)-1)*Math.PI,m=25;const g=1e-6;let x=0,w=0;do{const T=Math.cos(d),C=Math.sin(d),A=2*C*T,M=C*C,k=T*T,F=Math.cos(c/2),V=Math.sin(c/2),j=2*F*V,W=V*V,Q=1-k*F*F,K=Q?1/Q:0,te=Q?Math.acos(T*F)*Math.sqrt(1/Q):0,me=.5*(2*te*T*V+2*c/Math.PI)-e,he=.5*(te*C+d)-o,fe=.5*K*(k*W+te*T*F*M)+1/Math.PI,xe=K*(j*A/4-te*C*V),Ee=.125*K*(A*V-te*C*k*j),Ve=.5*K*(M*F+te*W*T)+.5,Ie=xe*Ee-Ve*fe;x=(he*xe-me*Ve)/Ie,w=(me*Ee-he*fe)/Ie,c=se(c-x,-Math.PI,Math.PI),d=se(d-w,-a1,a1)}while((Math.abs(x)>g||Math.abs(w)>g)&&--m>0);return new R(Pe(c),Pe(d))}}class l1 extends gd{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Pn(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,o){const{scale:c,cosPhi:d}=this;return{x:Pn(e)*d*c+.5,y:-Math.sin(Pn(o))/d*c+.5,z:0}}unproject(e,o){const{scale:c,cosPhi:d}=this,m=-(o-.5)/c,g=se(Pe((e-.5)/c)/d,-180,180),x=Math.asin(se(m*d,-1,1)),w=se(Pe(x),-le,le);return new R(g,w)}}class WE extends s1{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,o,c){const d=Em(e,o,c);return rr(d,d,Tm(Oa(c))),{x:d[0],y:d[1],z:d[2]}}locationPoint(e,o,c){const d=S(o.lat,o.lng),m=Ai([],d),g=c?e._centerAltitude+c:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(o),e._centerAltitude):e._centerAltitude;No(d,d,m,G(1,0)*ht*g);const x=fn(new Float64Array(16));return Bi(x,e.pixelMatrix,e.globeMatrix),rr(d,d,x),new Je(d[0],d[1])}pixelsPerMeter(e,o){return G(1,0)*o}pixelSpaceConversion(e,o,c){const d=G(1,e)*o,m=Ft(G(1,45)*o,d,c);return this.pixelsPerMeter(e,o)/m}createTileMatrix(e,o,c){const d=Sm(Oa(c.canonical));return Bi(new Float64Array(16),e.globeMatrix,d)}createInversionMatrix(e,o){const{center:c}=e,d=Tm(Oa(o));return Vs(d,d,Pn(c.lng)),fs(d,d,Pn(c.lat)),eo(d,d,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(d)}pointCoordinate(e,o,c,d){return zx(e,o,c,!0)||new ue(0,0)}pointCoordinate3D(e,o,c){const d=this.pointCoordinate(e,o,c,0);return[d.x,d.y,d.z]}isPointAboveHorizon(e,o){return!zx(e,o.x,o.y,!1)}farthestPixelDistance(e){const o=function(d,m){const g=d.cameraToCenterDistance,x=d._centerAltitude*m,w=d._camera,T=d._camera.forward(),C=Oi([],Li([],T,-g),[0,0,x]),A=d.worldSize/(2*Math.PI),M=[0,0,-A],k=d.width/d.height,F=Math.tan(d.fovAboveCenter),V=Li([],w.up(),F),j=Li([],w.right(),F*k),W=Ai([],Oi([],Oi([],T,V),j)),Q=[];let K;if(new An(C,W).closestPointOnSphere(M,A,Q)){const te=Oi([],Q,M),me=or([],te,C);K=Math.cos(d.fovAboveCenter)*uo(me)}else{const te=or([],C,M),me=or([],M,C);Ai(me,me);const he=uo(te)-A;K=Math.sqrt(he*(he+2*A));const fe=Math.acos(K/(A+he))-Math.acos(ir(T,me));K*=Math.cos(fe)}return 1.01*K}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),c=eu(e.zoom);if(c>0){const d=hp(e,G(1,e.center.lat)*e.worldSize),m=e.worldSize/(2*Math.PI),g=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Ft(o,d+m*(1-Math.cos(g)),Math.pow(c,10))}return o}upVector(e,o,c){return Em(o,c,e,1)}upVectorScale(e){return{metersToTile:cl(ls(Oa(e)))}}}function c1(s){const e=s.parallels,o=!!e&&Math.abs(e[0]+e[1])<.01;switch(s.name){case"mercator":return new s1(s);case"equirectangular":return new HE(s);case"naturalEarth":return new $E(s);case"equalEarth":return new ag(s);case"winkelTripel":return new qE(s);case"albers":return o?new l1(s):new o1(s);case"lambertConformalConic":return o?new l1(s):new GE(s);case"globe":return new WE(s)}throw new Error(`Invalid projection name: ${s.name}`)}const ZE=Re.types,XE=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function cg(s,e,o,c,d,m,g,x,w,T,C,A,M){const k=x?Math.min(md,Math.round(x[0])):0,F=x?Math.min(md,Math.round(x[1])):0;s.emplaceBack(e,o,Math.round(32*c),Math.round(32*d),m,g,(k<<1)+(w?1:0),F,16*T,16*C,256*A,256*M)}function cu(s,e,o){s.emplaceBack(e,o)}function hy(s,e,o,c,d,m,g){s.emplaceBack(e,o,c,d,m,g)}const Nh=(s,e,o,c)=>{for(let d=0;d<e;d++)s.emplaceBack(o[0],o[1],o[2],c[0],c[1],c[2])};function fy(s,e,o,c,d){s.emplaceBack(e,o,c,d),s.emplaceBack(e,o,c,d),s.emplaceBack(e,o,c,d),s.emplaceBack(e,o,c,d)}function YE(s){for(const e of s.sections)if(e_(e.text))return!0;return!1}class M0{constructor(e){this.layoutVertexArray=new Yu,this.indexArray=new Mi,this.programConfigurations=e,this.segments=new Gi,this.dynamicLayoutVertexArray=new Ra,this.opacityVertexArray=new lm,this.placedSymbolArray=new ec,this.iconTransitioningVertexArray=new ha,this.globeExtVertexArray=new Gc,this.zOffsetVertexArray=new os,this.orientationVertexArray=new um}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(e,o,c,d,m){this.isEmpty()||(c&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,h0.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,o),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Fb.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,XE,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,Nb.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,kb.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||m)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,CE.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,zb.members,!0)),this.opacityVertexBuffer.itemSize=1),(c||d)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}wt(M0,"SymbolBuffers");class P0{constructor(e,o,c){this.layoutVertexArray=new e,this.layoutAttributes=o,this.indexArray=new c,this.segments=new Gi,this.collisionVertexArray=new qc,this.collisionVertexArrayExt=new Ra}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,AE.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,ME.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}wt(P0,"CollisionBuffers");class py{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(g=>g.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=fn([]),this.placementViewportMatrix=fn([]);const o=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=ny(this.zoom,o["text-size"],this.worldview),this.iconSizeData=ny(this.zoom,o["icon-size"],this.worldview);const c=this.layers[0].layout,d=c.get("symbol-sort-key"),m=c.get("symbol-z-order");this.canOverlap=c.get("text-allow-overlap")||c.get("icon-allow-overlap")||c.get("text-ignore-placement")||c.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==m&&void 0!==d.constantOr(1),this.sortFeaturesByY=("viewport-y"===m||"auto"===m&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=c.get("text-writing-mode").map(g=>Ds[g]),this.stateDependentLayerIds=this.layers.filter(g=>g.isStateDependent()).map(g=>g.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1}createArrays(){this.text=new M0(new ws(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new M0(new ws(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new Nf,this.lineVertexArray=new s_,this.symbolInstances=new mm}calculateGlyphDependencies(e,o,c,d,m){for(const g of e){const x=g.codePointAt(0);if(void 0===x)break;if(o[x]=!0,d&&m&&x<=65535){const w=lc[g];w&&(o[w.charCodeAt(0)]=!0)}}}updateFootprints(e,o){}updateReplacement(e,o){if(o.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=o.updateTime;const c=o.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!I_(this.activeReplacements,c)&&(this.activeReplacements=c,!0)}populate(e,o,c,d){const m=this.layers[0],g=m.layout,x="globe"===this.projection.name,w=g.get("text-font"),T=g.get("text-field"),C=g.get("icon-image"),[A,M]=g.get("icon-size-scale-range"),k=se(o.scaleFactor||1,A,M),F=("constant"!==T.value.kind||T.value.value instanceof Wr&&!T.value.value.isEmpty()||T.value.value.toString().length>0)&&("constant"!==w.value.kind||w.value.value.length>0),V="constant"!==C.value.kind||!!C.value.value||Object.keys(C.parameters).length>0,j=g.get("symbol-sort-key");if(this.features=[],!F&&!V)return;const W=o.iconDependencies,Q=o.glyphDependencies,K=o.availableImages,te=new Tn(this.zoom,{worldview:this.worldview});for(const{feature:me,id:he,index:fe,sourceLayerIndex:xe}of e){const Ee=m._featureFilter.needGeometry,Ve=ze(me,Ee);if(!m._featureFilter.filter(te,Ve,c))continue;if(Ee||(Ve.geometry=_e(me,c,d)),x&&1!==me.type&&c.z<=5){const Ke=Ve.geometry,nt=.98078528056,Ne=(Qe,Ce)=>ir(Em(Qe.x,Qe.y,c,1),Em(Ce.x,Ce.y,c,1))<nt;for(let Qe=0;Qe<Ke.length;Qe++)Ke[Qe]=Le(Ke[Qe],Ne)}let Ie,Ue;if(F){const Ke=m.getValueAndResolveTokens("text-field",Ve,c,K),nt=Wr.factory(Ke);YE(nt)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===ar()||this.hasRTLText&&zs.isParsed())&&(Ie=ru(nt,m,Ve))}if(V){const Ke=m.getValueAndResolveTokens("icon-image",Ve,c,K);Ue="string"==typeof Ke?po.build(Ke):Ke}if(!Ie&&!Ue)continue;const ot=this.sortFeaturesByKey?j.evaluate(Ve,{},c):void 0,$e={id:he,text:Ie,icon:Ue,index:fe,sourceLayerIndex:xe,geometry:Ve.geometry,properties:me.properties,type:ZE[me.type],sortKey:ot};if(this.features.push($e),Ue){const Ke=this.layers[0]._unevaluatedLayout._values,{iconPrimary:nt,iconSecondary:Ne}=ly(Ue,this.iconSizeData,Ke["icon-size"],c,this.zoom,$e,this.pixelRatio,k,this.worldview),Qe=nt.id.toString();if(W.has(Qe)?W.get(Qe).push(nt):W.set(Qe,[nt]),Ne){this.hasAnySecondaryIcon=!0;const Ce=Ne.id.toString();W.has(Ce)?W.get(Ce).push(Ne):W.set(Ce,[Ne])}}if(Ie){const Ke=w.evaluate(Ve,{},c).join(","),nt="map"===g.get("text-rotation-alignment")&&"point"!==g.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Ds.vertical)>=0;for(const Ne of Ie.sections)if(Ne.image){const Qe=Ne.image.getPrimary().scaleSelf(this.pixelRatio),Ce=Qe.id.toString(),Be=W.get(Ce)||[];Be.push(Qe),W.set(Ce,Be)}else{const Qe=Cf(Ie.toString()),Ce=Ne.fontStack||Ke,Be=Q[Ce]=Q[Ce]||{};this.calculateGlyphDependencies(Ne.text,Be,nt,this.allowVerticalPlacement,Qe)}}}if("line"===g.get("symbol-placement")&&(this.features=function(me){const he={},fe={},xe=[];let Ee=0;function Ve($e){xe.push(me[$e]),Ee++}function Ie($e,Ke,nt){const Ne=fe[$e];return delete fe[$e],fe[Ke]=Ne,xe[Ne].geometry[0].pop(),xe[Ne].geometry[0]=xe[Ne].geometry[0].concat(nt[0]),Ne}function Ue($e,Ke,nt){const Ne=he[Ke];return delete he[Ke],he[$e]=Ne,xe[Ne].geometry[0].shift(),xe[Ne].geometry[0]=nt[0].concat(xe[Ne].geometry[0]),Ne}function ot($e,Ke,nt){const Ne=nt?Ke[0][Ke[0].length-1]:Ke[0][0];return`${$e}:${Ne.x}:${Ne.y}`}for(let $e=0;$e<me.length;$e++){const Ke=me[$e],nt=Ke.geometry,Ne=Ke.text?Ke.text.toString():null;if(!Ne){Ve($e);continue}const Qe=ot(Ne,nt),Ce=ot(Ne,nt,!0);if(Qe in fe&&Ce in he&&fe[Qe]!==he[Ce]){const Be=Ue(Qe,Ce,nt),at=Ie(Qe,Ce,xe[Be].geometry);delete he[Qe],delete fe[Ce],fe[ot(Ne,xe[at].geometry,!0)]=at,xe[Be].geometry=null}else Qe in fe?Ie(Qe,Ce,nt):Ce in he?Ue(Qe,Ce,nt):(Ve($e),he[Qe]=Ee-1,fe[Ce]=Ee-1)}return xe.filter($e=>$e.geometry)}(this.features)),"hd-road-markup"===g.get("symbol-elevation-reference")){if(this.elevationType="road",o.elevationFeatures){!this.elevationFeatures&&o.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const me of o.elevationFeatures)this.elevationFeatureIdToIndex.set(me.id,this.elevationFeatures.length),this.elevationFeatures.push(me)}}else g.get("symbol-z-elevate")&&(this.elevationType="offset");"none"!==this.elevationType&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((me,he)=>me.sortKey-he.sortKey)}update(e,o,c,d,m,g,x){this.text.programConfigurations.updatePaintArrays(e,o,m,c,d,g,x,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,o,m,c,d,g,x,this.worldview)}updateRoadElevation(e){if("road"!==this.elevationType||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let o=!1;const c=ce(e),d=1/c;let m=!1,g=!1;for(let x=0;x<this.symbolInstances.length;x++){const w=this.symbolInstances.get(x),T=dr(1,0,0),C=dr(0,1,0),{numHorizontalGlyphVertices:A,numVerticalGlyphVertices:M,numIconVertices:k,numVerticalIconVertices:F}=w,V=A>0||M>0,j=k>0,W=this.elevationFeatures[w.elevationFeatureIndex];if(W){const Q=new Je(w.tileAnchorX,w.tileAnchorY),K=.075+W.pointElevation(Q);w.zOffset!==K&&(o=!0,w.zOffset=K);const te=W.computeSlopeNormal(Q,d),me=wu(Ba(),dr(0,0,1),te);Ea(T,T,me),Ea(C,C,me),T[2]*=c,C[2]*=c,1===T[0]&&0===T[1]&&0===T[2]&&0===C[0]&&1===C[1]&&0===C[2]||(m=m||V,g=g||j)}if(V&&(Nh(this.text.orientationVertexArray,A,T,C),Nh(this.text.orientationVertexArray,M,T,C)),j){const{placedIconSymbolIndex:Q,verticalPlacedIconSymbolIndex:K}=w;Q>=0&&Nh(this.icon.orientationVertexArray,k,T,C),K>=0&&Nh(this.icon.orientationVertexArray,F,T,C)}}m||(this.text.orientationVertexArray=void 0),g||(this.icon.orientationVertexArray=void 0),o&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(m,g,x)=>{c+=g,c>m.length&&m.resize(c);for(let w=-g;w<0;w++)m.emplace(w+c,x)},o=(m,g,x)=>{d+=g,d>m.length&&m.resize(d);for(let w=-g;w<0;w++)m.emplace(w+d,x)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let c=0,d=0;for(let m=0;m<this.symbolInstances.length;m++){const g=this.symbolInstances.get(m),{numHorizontalGlyphVertices:x,numVerticalGlyphVertices:w,numIconVertices:T}=g,C=g.zOffset,A=T>0;if((x>0||w>0)&&(e(this.text.zOffsetVertexArray,x,C),e(this.text.zOffsetVertexArray,w,C)),A){const{placedIconSymbolIndex:M,verticalPlacedIconSymbolIndex:k}=g;M>=0&&o(this.icon.zOffsetVertexArray,T,C),k>=0&&o(this.icon.zOffsetVertexArray,g.numVerticalIconVertices,C)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=c1(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,o){const c=this.lineVertexArray.length;if(void 0!==e.segment)for(const{x:d,y:m}of o)this.lineVertexArray.emplaceBack(d,m);return{lineStartIndex:c,lineLength:this.lineVertexArray.length-c}}addSymbols(e,o,c,d,m,g,x,w,T,C,A,M,k,F,V,j){const W=e.indexArray,Q=e.layoutVertexArray,K=e.globeExtVertexArray,te=e.segments.prepareSegment(4*o.length,Q,W,this.canOverlap?g.sortKey:void 0),me=this.glyphOffsetArray.length,he=te.vertexLength,fe=this.allowVerticalPlacement&&x===Ds.vertical?Math.PI/2:0,xe=g.text&&g.text.sections;for(let Ve=0;Ve<o.length;Ve++){const{tl:Ie,tr:Ue,bl:ot,br:$e,texPrimary:Ke,texSecondary:nt,pixelOffsetTL:Ne,pixelOffsetBR:Qe,minFontScaleX:Ce,minFontScaleY:Be,glyphOffset:at,isSDF:et,sectionIndex:Ot}=o[Ve],Tt=te.vertexLength,Xe=at[1];if(cg(Q,T.x,T.y,Ie.x,Xe+Ie.y,Ke.x,Ke.y,c,et,Ne.x,Ne.y,Ce,Be),cg(Q,T.x,T.y,Ue.x,Xe+Ue.y,Ke.x+Ke.w,Ke.y,c,et,Qe.x,Ne.y,Ce,Be),cg(Q,T.x,T.y,ot.x,Xe+ot.y,Ke.x,Ke.y+Ke.h,c,et,Ne.x,Qe.y,Ce,Be),cg(Q,T.x,T.y,$e.x,Xe+$e.y,Ke.x+Ke.w,Ke.y+Ke.h,c,et,Qe.x,Qe.y,Ce,Be),w){const{x:tt,y:Dt,z:yt}=w.anchor,[ft,xt,zt]=w.up;hy(K,tt,Dt,yt,ft,xt,zt),hy(K,tt,Dt,yt,ft,xt,zt),hy(K,tt,Dt,yt,ft,xt,zt),hy(K,tt,Dt,yt,ft,xt,zt),fy(e.dynamicLayoutVertexArray,tt,Dt,yt,fe)}else fy(e.dynamicLayoutVertexArray,T.x,T.y,T.z,fe);if(j){const tt=nt||Ke;cu(e.iconTransitioningVertexArray,tt.x,tt.y),cu(e.iconTransitioningVertexArray,tt.x+tt.w,tt.y),cu(e.iconTransitioningVertexArray,tt.x,tt.y+tt.h),cu(e.iconTransitioningVertexArray,tt.x+tt.w,tt.y+tt.h)}W.emplaceBack(Tt,Tt+1,Tt+2),W.emplaceBack(Tt+1,Tt+2,Tt+3),te.vertexLength+=4,te.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(at[0]),Ve!==o.length-1&&Ot===o[Ve+1].sectionIndex||e.programConfigurations.populatePaintArrays(Q.length,g,g.index,{},k,F,V,xe&&xe[Ot],this.worldview)}const Ee=w?w.anchor:T;e.placedSymbolArray.emplaceBack(Ee.x,Ee.y,Ee.z,T.x,T.y,me,this.glyphOffsetArray.length-me,he,C,A,T.segment,c?c[0]:0,c?c[1]:0,d[0],d[1],x,0,0,0,M,0)}_commitLayoutVertex(e,o,c,d,m,g,x){e.emplaceBack(o,c,d,m,g,Math.round(x.x),Math.round(x.y))}_addCollisionDebugVertices(e,o,c,d,m,g,x){const w=c.segments.prepareSegment(4,c.layoutVertexArray,c.indexArray),T=w.vertexLength,C=x.tileAnchorX,A=x.tileAnchorY;for(let k=0;k<4;k++)c.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(c.collisionVertexArrayExt,o,e.padding,x.zOffset),this._commitLayoutVertex(c.layoutVertexArray,d,m,g,C,A,new Je(e.x1,e.y1)),this._commitLayoutVertex(c.layoutVertexArray,d,m,g,C,A,new Je(e.x2,e.y1)),this._commitLayoutVertex(c.layoutVertexArray,d,m,g,C,A,new Je(e.x2,e.y2)),this._commitLayoutVertex(c.layoutVertexArray,d,m,g,C,A,new Je(e.x1,e.y2)),w.vertexLength+=4;const M=c.indexArray;M.emplaceBack(T,T+1),M.emplaceBack(T+1,T+2),M.emplaceBack(T+2,T+3),M.emplaceBack(T+3,T),w.primitiveLength+=4}_addTextDebugCollisionBoxes(e,o,c,d,m,g){for(let x=d;x<m;x++){const w=c.get(x),T=this.getSymbolInstanceTextSize(e,g,o,x);this._addCollisionDebugVertices(w,T,this.textCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,g)}}_addIconDebugCollisionBoxes(e,o,c,d,m,g){for(let x=d;x<m;x++){const w=c.get(x),T=this.getSymbolInstanceIconSize(e,o,g.placedIconSymbolIndex);this._addCollisionDebugVertices(w,T,this.iconCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,g)}}generateCollisionDebugBuffers(e,o,c){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new P0(uh,Bb.members,ha),this.iconCollisionBox=new P0(uh,Bb.members,ha);const d=Qm(this.iconSizeData,e),m=Qm(this.textSizeData,e,c);for(let g=0;g<this.symbolInstances.length;g++){const x=this.symbolInstances.get(g);this._addTextDebugCollisionBoxes(m,e,o,x.textBoxStartIndex,x.textBoxEndIndex,x),this._addTextDebugCollisionBoxes(m,e,o,x.verticalTextBoxStartIndex,x.verticalTextBoxEndIndex,x),this._addIconDebugCollisionBoxes(d,e,o,x.iconBoxStartIndex,x.iconBoxEndIndex,x),this._addIconDebugCollisionBoxes(d,e,o,x.verticalIconBoxStartIndex,x.verticalIconBoxEndIndex,x)}}getSymbolInstanceTextSize(e,o,c,d){const m=this.text.placedSymbolArray.get(o.rightJustifiedTextSymbolIndex>=0?o.rightJustifiedTextSymbolIndex:o.centerJustifiedTextSymbolIndex>=0?o.centerJustifiedTextSymbolIndex:o.leftJustifiedTextSymbolIndex>=0?o.leftJustifiedTextSymbolIndex:o.verticalPlacedTextSymbolIndex>=0?o.verticalPlacedTextSymbolIndex:d),g=y0(this.textSizeData,e,m)/Sr;return this.tilePixelRatio*g}getSymbolInstanceIconSize(e,o,c){const d=this.icon.placedSymbolArray.get(c),m=y0(this.iconSizeData,e,d);return this.tilePixelRatio*m}_commitDebugCollisionVertexUpdate(e,o,c,d){e.emplaceBack(o,-c,-c,d),e.emplaceBack(o,c,-c,d),e.emplaceBack(o,c,c,d),e.emplaceBack(o,-c,c,d)}_updateTextDebugCollisionBoxes(e,o,c,d,m,g,x){for(let w=d;w<m;w++){const T=c.get(w),C=this.getSymbolInstanceTextSize(e,g,o,w);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,C,T.padding,g.zOffset)}}_updateIconDebugCollisionBoxes(e,o,c,d,m,g,x){for(let w=d;w<m;w++){const T=c.get(w),C=this.getSymbolInstanceIconSize(e,o,g.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,C,T.padding,g.zOffset)}}updateCollisionDebugBuffers(e,o,c,d){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const m=Qm(this.iconSizeData,e,d),g=Qm(this.textSizeData,e,c);for(let x=0;x<this.symbolInstances.length;x++){const w=this.symbolInstances.get(x);this._updateTextDebugCollisionBoxes(g,e,o,w.textBoxStartIndex,w.textBoxEndIndex,w,c),this._updateTextDebugCollisionBoxes(g,e,o,w.verticalTextBoxStartIndex,w.verticalTextBoxEndIndex,w,c),this._updateIconDebugCollisionBoxes(m,e,o,w.iconBoxStartIndex,w.iconBoxEndIndex,w,d),this._updateIconDebugCollisionBoxes(m,e,o,w.verticalIconBoxStartIndex,w.verticalIconBoxEndIndex,w,d)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,o,c,d,m,g,x,w,T){const C={};if(o<c){const{x1:A,y1:M,x2:k,y2:F,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te,featureIndex:me}=e.get(o);C.textBox={x1:A,y1:M,x2:k,y2:F,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te},C.textFeatureIndex=me}if(d<m){const{x1:A,y1:M,x2:k,y2:F,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te,featureIndex:me}=e.get(d);C.verticalTextBox={x1:A,y1:M,x2:k,y2:F,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te},C.verticalTextFeatureIndex=me}if(g<x){const{x1:A,y1:M,x2:k,y2:F,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te,featureIndex:me}=e.get(g);C.iconBox={x1:A,y1:M,x2:k,y2:F,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te},C.iconFeatureIndex=me}if(w<T){const{x1:A,y1:M,x2:k,y2:F,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te,featureIndex:me}=e.get(w);C.verticalIconBox={x1:A,y1:M,x2:k,y2:F,padding:V,projectedAnchorX:j,projectedAnchorY:W,projectedAnchorZ:Q,tileAnchorX:K,tileAnchorY:te},C.verticalIconFeatureIndex=me}return C}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let o=0;o<this.symbolInstances.length;o++){const c=this.symbolInstances.get(o);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,c.textBoxStartIndex,c.textBoxEndIndex,c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c.iconBoxStartIndex,c.iconBoxEndIndex,c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,o){const c=e.placedSymbolArray.get(o),d=c.vertexStartIndex+4*c.numGlyphs;for(let m=c.vertexStartIndex;m<d;m+=4)e.indexArray.emplaceBack(m,m+1,m+2),e.indexArray.emplaceBack(m+1,m+2,m+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const o=Math.sin(e),c=Math.cos(e),d=[],m=[],g=[];for(let x=0;x<this.symbolInstances.length;++x){g.push(x);const w=this.symbolInstances.get(x);d.push(0|Math.round(o*w.tileAnchorX+c*w.tileAnchorY)),m.push(w.featureIndex)}return g.sort((x,w)=>d[x]-d[w]||m[w]-m[x]),g}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,o)=>this.symbolInstances.get(o).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,o){const c=this.sortKeyRanges[this.sortKeyRanges.length-1];c&&c.sortKey===o?c.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:o,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const o of this.symbolInstanceIndexes){const c=this.symbolInstances.get(o);this.featureSortOrder.push(c.featureIndex);const{rightJustifiedTextSymbolIndex:d,centerJustifiedTextSymbolIndex:m,leftJustifiedTextSymbolIndex:g,verticalPlacedTextSymbolIndex:x,placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:T}=c;d>=0&&this.addIndicesForPlacedSymbol(this.text,d),m>=0&&m!==d&&this.addIndicesForPlacedSymbol(this.text,m),g>=0&&g!==m&&g!==d&&this.addIndicesForPlacedSymbol(this.text,g),x>=0&&this.addIndicesForPlacedSymbol(this.text,x),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w),T>=0&&this.addIndicesForPlacedSymbol(this.icon,T)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let u1,d1,my;wt(py,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),py.addDynamicAttributes=fy;class R0{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Tc,this.defaultValue=e}evaluate(e){if(e.formattedSection){const o=this.defaultValue.property.overrides;if(o&&o.hasOverride(e.formattedSection))return o.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}wt(R0,"FormatSectionOverride",{omit:["defaultValue"]});const O0=()=>my||(my={layout:u1||(u1=new Wi({"symbol-placement":new it(De.layout_symbol["symbol-placement"]),"symbol-spacing":new it(De.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new it(De.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new _t(De.layout_symbol["symbol-sort-key"]),"symbol-z-order":new it(De.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new it(De.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new it(De.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new it(De.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new it(De.layout_symbol["icon-ignore-placement"]),"icon-optional":new it(De.layout_symbol["icon-optional"]),"icon-rotation-alignment":new it(De.layout_symbol["icon-rotation-alignment"]),"icon-size":new _t(De.layout_symbol["icon-size"]),"icon-size-scale-range":new it(De.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new _t(De.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new _t(De.layout_symbol["icon-text-fit-padding"]),"icon-image":new _t(De.layout_symbol["icon-image"]),"icon-rotate":new _t(De.layout_symbol["icon-rotate"]),"icon-padding":new it(De.layout_symbol["icon-padding"]),"icon-keep-upright":new it(De.layout_symbol["icon-keep-upright"]),"icon-offset":new _t(De.layout_symbol["icon-offset"]),"icon-anchor":new _t(De.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new it(De.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new it(De.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new it(De.layout_symbol["text-rotation-alignment"]),"text-field":new _t(De.layout_symbol["text-field"]),"text-font":new _t(De.layout_symbol["text-font"]),"text-size":new _t(De.layout_symbol["text-size"]),"text-size-scale-range":new it(De.layout_symbol["text-size-scale-range"]),"text-max-width":new _t(De.layout_symbol["text-max-width"]),"text-line-height":new _t(De.layout_symbol["text-line-height"]),"text-letter-spacing":new _t(De.layout_symbol["text-letter-spacing"]),"text-justify":new _t(De.layout_symbol["text-justify"]),"text-radial-offset":new _t(De.layout_symbol["text-radial-offset"]),"text-variable-anchor":new it(De.layout_symbol["text-variable-anchor"]),"text-anchor":new _t(De.layout_symbol["text-anchor"]),"text-max-angle":new it(De.layout_symbol["text-max-angle"]),"text-writing-mode":new it(De.layout_symbol["text-writing-mode"]),"text-rotate":new _t(De.layout_symbol["text-rotate"]),"text-padding":new it(De.layout_symbol["text-padding"]),"text-keep-upright":new it(De.layout_symbol["text-keep-upright"]),"text-transform":new _t(De.layout_symbol["text-transform"]),"text-offset":new _t(De.layout_symbol["text-offset"]),"text-allow-overlap":new it(De.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new it(De.layout_symbol["text-ignore-placement"]),"text-optional":new it(De.layout_symbol["text-optional"]),visibility:new it(De.layout_symbol.visibility)})),paint:d1||(d1=new Wi({"icon-opacity":new _t(De.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new _t(De.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new _t(De.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new _t(De.paint_symbol["text-emissive-strength"]),"icon-color":new _t(De.paint_symbol["icon-color"]),"icon-halo-color":new _t(De.paint_symbol["icon-halo-color"]),"icon-halo-width":new _t(De.paint_symbol["icon-halo-width"]),"icon-halo-blur":new _t(De.paint_symbol["icon-halo-blur"]),"icon-translate":new it(De.paint_symbol["icon-translate"]),"icon-translate-anchor":new it(De.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new it(De.paint_symbol["icon-image-cross-fade"]),"text-opacity":new _t(De.paint_symbol["text-opacity"]),"text-occlusion-opacity":new _t(De.paint_symbol["text-occlusion-opacity"]),"text-color":new _t(De.paint_symbol["text-color"],{runtimeType:mi,getOverride:s=>s.textColor,hasOverride:s=>!!s.textColor}),"text-halo-color":new _t(De.paint_symbol["text-halo-color"]),"text-halo-width":new _t(De.paint_symbol["text-halo-width"]),"text-halo-blur":new _t(De.paint_symbol["text-halo-blur"]),"text-translate":new it(De.paint_symbol["text-translate"]),"text-translate-anchor":new it(De.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new it(De.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new it(De.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new it(De.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new it(De.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new _t(De.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},my);class L0 extends bo{constructor(e,o,c,d){super(e,O0(),o,c,d),this._colorAdjustmentMatrix=fn([]),this.hasInitialOcclusionOpacityProperties=void 0!==e.paint&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,o){super.recalculate(e,o),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const c=this.layout.get("text-writing-mode");if(c){const d=[];for(const m of c)d.indexOf(m)<0&&d.push(m);this.layout._values["text-writing-mode"]=d}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,o,c,d){return this._saturation===e&&this._contrast===o&&this._brightnessMin===c&&this._brightnessMax===d||(this._colorAdjustmentMatrix=function(m,g,x,w){m=ho(m),g=Bo(g);const T=Dl(),C=m/3,A=1-2*C,M=[A,C,C,0,C,A,C,0,C,C,A,0,0,0,0,1],k=.5-.5*g,F=w-x;return Bi(T,[F,0,0,0,0,F,0,0,0,0,F,0,x,x,x,1],[g,0,0,0,0,g,0,0,0,0,g,0,k,k,k,1]),Bi(T,T,M),T}(e,o,c,d),this._saturation=e,this._contrast=o,this._brightnessMin=c,this._brightnessMax=d),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,o,c,d){const m=this.layout.get(e).evaluate(o,{},c,d),g=this._unevaluatedLayout._values[e];return g.isDataDriven()||Qg(g.value)||!m?m:(x=o.properties,m.replace(/{([^{}]+)}/g,(T,C)=>C in x?String(x[C]):""));var x}createBucket(e){return new py(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of O0().paint.overridableProperties){if(!L0.hasPaintOverride(this.layout,e))continue;const o=this.paint.get(e),c=new R0(o),d=new Kg(c,o.property.specification,this.scope,this.options);let m=null;m="constant"===o.value.kind||"source"===o.value.kind?new Sf("source",d):new Bc("composite",d,o.value.zoomStops,o.value.interpolationType),this.paint._values[e]=new jc(o.property,m,o.parameters)}}_handleOverridablePaintPropertyUpdate(e,o,c){return!(!this.layout||o.isDataDriven()||c.isDataDriven())&&L0.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,o){const c=e.get("text-field"),d=O0().paint.properties[o];let m=!1;const g=x=>{for(const w of x)if(d.overrides&&d.overrides.hasOverride(w))return void(m=!0)};if("constant"===c.value.kind&&c.value.value instanceof Wr)g(c.value.value.sections);else if("source"===c.value.kind){const x=T=>{m||(T instanceof Bt&&bt(T.value)===Sc?g(T.value.sections):T instanceof gt?g(T.sections):T.eachChild(x))},w=c.value;w._styleExpression&&x(w._styleExpression.expression)}return m}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,o,c){return{config:new Uo(this,{zoom:o,lut:c}),overrideFog:!1}}hasElevation(){return this.layout&&"hd-road-markup"===this.layout.get("symbol-elevation-reference")}}let k0,h1,KE,ug;var F0=En([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function gy(s,e,o,c,d,m,g,x){const w=[s,e,1,o,c,1,d,m,1],T=[g,x,1],C=Cs([],w),[A,M,k]=js(T,T,C);return As(w,w,[A,0,0,0,M,0,0,0,k])}function _y(s,e,o,c,d,m,g,x){const w=function(T,C,A,M,k,F,V,j){const W=gy(0,0,1,0,1,1,0,1),Q=gy(T,C,A,M,k,F,V,j);return As(Q,Q,Cs([],W))}(s,e,o,c,d,m,g,x);return[w[2]/w[8]/ht,w[5]/w[8]/ht]}function yy(s){return[s[0],Math.min(Math.max(s[1],-le),le)]}class ml extends Mu{constructor(e,o,c,d){super(),this.id=e,this.dispatcher=c,this.coordinates=o.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(d),this.options=o,this._dirty=!1}load(e,o){if(this._loaded=o||!1,this.fire(new qr("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=sa(this.map._requestManager.transformRequest(this.url,ki.Image),(c,d)=>{this._imageRequest=null,this._loaded=!0,c?this.fire(new _n(c)):d&&(this.image=d instanceof HTMLImageElement?Us.getImageData(d):d,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new ud(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new qr("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof ud||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let o=e[0][1],c=e[0][1];for(const m of e)m[1]>c&&(c=m[1]),m[1]<o&&(o=m[1]);const d=(c+o)/2;if(d>le?this.onNorthPole=!0:d<-le&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const m=e.map(ue.fromLngLat);this.tileID=function(g){let x=1/0,w=1/0,T=-1/0,C=-1/0;for(const V of g)x=Math.min(x,V.x),w=Math.min(w,V.y),T=Math.max(T,V.x),C=Math.max(C,V.y);const A=Math.max(T-x,C-w),M=Math.max(0,Math.floor(-Math.log(A)/Math.LN2)),k=Math.pow(2,M);let F=Math.floor((x+T)/2*k);return F>1&&(F-=1),new Ho(M,F,Math.floor((w+C)/2*k))}(m),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new qr("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof ud||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const W in this.tiles){const Q=this.tiles[W];"loaded"!==Q.state&&(Q.state="loaded",Q.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const o=fp(new Ho(0,0,0),this.map.transform.projection),c=[o.projection.project(this.coordinates[0][0],this.coordinates[0][1]),o.projection.project(this.coordinates[1][0],this.coordinates[1][1]),o.projection.project(this.coordinates[2][0],this.coordinates[2][1]),o.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(W){const Q=W[1].x-W[0].x,K=W[1].y-W[0].y,te=W[2].x-W[1].x,me=W[2].y-W[1].y,he=W[3].x-W[2].x,fe=W[3].y-W[2].y,xe=W[0].x-W[3].x,Ee=W[0].y-W[3].y,Ve=Q*me-te*K,Ie=te*fe-he*me,Ue=he*Ee-xe*fe,ot=xe*K-Q*Ee;return Ve>0&&Ie>0&&Ue>0&&ot>0||Ve<0&&Ie<0&&Ue<0&&ot<0}(c))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const d=fp(this.tileID,this.map.transform.projection),[m,g,x,w]=this.coordinates.map(W=>{const Q=d.projection.project(W[0],W[1]);return ig(d,Q)._round()});this.perspectiveTransform=_y(m.x,m.y,g.x,g.y,x.x,x.y,w.x,w.y);const T=this._boundsArray=new Qr;T.emplaceBack(m.x,m.y,0,0),T.emplaceBack(g.x,g.y,ht,0),T.emplaceBack(w.x,w.y,0,ht),T.emplaceBack(x.x,x.y,ht,ht),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(T,F0.members),this.boundsSegments=Gi.simpleSegment(0,0,4,2);const C=[],A=[yy((M=this.coordinates)[0]),yy(M[1]),yy(M[2]),yy(M[3])];var M;const[k,F,V,j]=function(W){let Q=W[0][0],K=Q,te=W[0][1],me=te;for(let he=1;he<W.length;he++)W[he][0]<Q?Q=W[he][0]:W[he][0]>K&&(K=W[he][0]),W[he][1]<te?te=W[he][1]:W[he][1]>me&&(me=W[he][1]);return[Q,te,K-Q,me-te]}(A);{const W=new Qr,[Q,K,te,me]=function(Ne){let Qe=Ne[0].x,Ce=Qe,Be=Ne[0].y,at=Be;for(let et=1;et<Ne.length;et++)Ne[et].x<Qe?Qe=Ne[et].x:Ne[et].x>Ce&&(Ce=Ne[et].x),Ne[et].y<Be?Be=Ne[et].y:Ne[et].y>at&&(at=Ne[et].y);return[Qe,Be,Ce-Qe,at-Be]}(c),he=Ne=>[(Ne.x-Q)/te,(Ne.y-K)/me],[fe,xe,Ee,Ve]=c.map(he),Ie=function(Ne,Qe,Ce,Be,at,et,Ot,Tt){const Xe=gy(0,0,1,0,1,1,0,1);return As(Xe,Xe,Cs([],gy(Ne,Qe,Ce,Be,at,et,Ot,Tt)))}(fe[0],fe[1],xe[0],xe[1],Ee[0],Ee[1],Ve[0],Ve[1]);this.elevatedGlobePerspectiveTransform=_y(fe[0],fe[1],xe[0],xe[1],Ee[0],Ee[1],Ve[0],Ve[1]);const Ue=(Ne,Qe)=>{C.push(Ne.lng);const Ce=Math.round((Ne.lng-k)/V*ht),Be=Math.round((Ne.lat-F)/j*ht),at=he(Qe),et=js([],[at[0],at[1],1],Ie),Ot=Math.round(et[0]/et[2]*ht),Tt=Math.round(et[1]/et[2]*ht);W.emplaceBack(Ce,Be,Ot,Tt)},ot=c[3].x-c[0].x,$e=c[3].y-c[0].y,Ke=c[2].x-c[1].x,nt=c[2].y-c[1].y;for(let Ne=0;Ne<65;Ne++){const Qe=Ne/64,Ce=[c[0].x+Qe*ot,c[0].y+Qe*$e],Be=[c[1].x+Qe*Ke,c[1].y+Qe*nt],at=Be[0]-Ce[0],et=Be[1]-Ce[1];for(let Ot=0;Ot<65;Ot++){const Tt=Ot/64,Xe={x:Ce[0]+at*Tt,y:Ce[1]+et*Tt};Ue(o.projection.unproject(Xe.x,Xe.y),Xe)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(W,F0.members)}{this.maxLongitudeTriangleSize=0;let W=[],Q=new Mi;const K=(te,me,he)=>{Q.emplaceBack(te,me,he);const fe=C[te],xe=C[me],Ee=C[he],Ve=Math.min(Math.min(fe,xe),Ee),Ie=Math.max(Math.max(fe,xe),Ee)-Ve;Ie>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Ie),W.push(Ve+Ie/2)};for(let te=0;te<64;te++)for(let me=0;me<64;me++){const he=65*te+me,fe=he+1,xe=he+65,Ee=xe+1;K(he,xe,fe),K(fe,xe,Ee)}[W,Q]=function(te,me){const he=Array.from({length:te.length},(Ee,Ve)=>Ve);he.sort((Ee,Ve)=>te[Ee]-te[Ve]);const fe=[],xe=new Mi;for(let Ee=0;Ee<he.length;Ee++){const Ve=he[Ee];fe.push(te[Ve]);const Ie=3*Ve,Ue=Ie+1;xe.emplaceBack(me.uint16[Ie],me.uint16[Ue],me.uint16[Ue+1])}return[fe,xe]}(W,Q),this.elevatedGlobeTrianglesCenterLongitudes=W,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(Q)}this.elevatedGlobeSegments=Gi.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,V/ht,0,j/ht,0,0,F,k,0])}prepare(){const e=0!==Object.keys(this.tiles).length;if(this.tileID&&!e)return;const o=this.map.painter.context,c=o.gl;!this._dirty||this.texture instanceof ud||(this.texture?this.texture.update(this.image):(this.texture=new Oh(o,this.image,c.RGBA8),this.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(o)}loadTile(e,o){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},o(null)):(e.state="errored",o(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const o=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!o)return null;const c=this.elevatedGlobeTrianglesCenterLongitudes;let d=(m=e+180)+360*Math.round((c[0]-m)/360);var m;const g=new Gi,x=(A,M)=>{g.segments.push({vertexOffset:0,primitiveOffset:A,vertexLength:o.segments[0].vertexLength,primitiveLength:M,sortKey:void 0,vaos:{}})},w=.51*this.maxLongitudeTriangleSize;if(Math.abs(c[0]-d)<=w){const A=$r(c,0,c.length,d+w);return A===c.length||x(A,Si(c,A+1,c.length,d+360-w)-A),g}d<c[0]&&(d+=360);const T=Si(c,0,c.length,d-w);if(T===c.length)return x(0,c.length),g;x(0,T-0);const C=$r(c,T+1,c.length,d+w);return C!==c.length&&x(C,c.length-C),g}}const dg=(Math.pow(256,2)-1)/16907520;class ds extends bo{constructor(e,o,c,d){super(e,{layout:KE||(KE=new Wi({visibility:new it(De.layout_raster.visibility)})),paint:ug||(ug=new Wi({"raster-opacity":new it(De.paint_raster["raster-opacity"]),"raster-color":new Uc(De.paint_raster["raster-color"]),"raster-color-mix":new it(De.paint_raster["raster-color-mix"]),"raster-color-range":new it(De.paint_raster["raster-color-range"]),"raster-hue-rotate":new it(De.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new it(De.paint_raster["raster-brightness-min"]),"raster-brightness-max":new it(De.paint_raster["raster-brightness-max"]),"raster-saturation":new it(De.paint_raster["raster-saturation"]),"raster-contrast":new it(De.paint_raster["raster-contrast"]),"raster-resampling":new it(De.paint_raster["raster-resampling"]),"raster-fade-duration":new it(De.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new it(De.paint_raster["raster-emissive-strength"]),"raster-array-band":new it(De.paint_raster["raster-array-band"]),"raster-elevation":new it(De.paint_raster["raster-elevation"]),"raster-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},o,c,d),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof ml&&(e._source.onNorthPole||e._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(e){"raster-color"!==e&&"raster-color-range"!==e||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const o=this._transitionablePaint._values["raster-color"].value.expression,[c,d]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(c)&&isNaN(d)||c===this._curRampRange[0]&&d===this._curRampRange[1]||(this.colorRamp=Cm({expression:o,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:c,end:d}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[c,d])}}let _d,hg,_a,fg,Bh;class Vh extends bo{constructor(e,o,c,d){super(e,{layout:_d||(_d=new Wi({visibility:new it(De["layout_raster-particle"].visibility)})),paint:hg||(hg=new Wi({"raster-particle-array-band":new it(De["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new it(De["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Uc(De["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new it(De["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new it(De["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new it(De["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new it(De["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new it(De["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},o,c,d),this._updateColorRamp(),this.lastInvalidatedAt=Us.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){"raster-particle-color"!==e&&"raster-particle-max-speed"!==e||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===e&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,o=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Cm({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:o}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Us.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class _p extends bo{constructor(e,o){super(e,{},o,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(e){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function yd(s,e,o){const c=[0,0,1],d=Ta([]);return Ml(d,d,o?-Pn(s)+Math.PI:Pn(s)),mc(d,d,-Pn(e)),Ea(c,c,d),Ai(c,c)}const jh={None:0,Model:1,Symbol:2,FillExtrusion:4};class uu{constructor(e,o,c,d){this.message=(e?`${e}: `:"")+c,d&&(this.identifier=d),null!=o&&o.__line__&&(this.line=o.__line__)}}function vd(s,e){const o=-1===s.indexOf("://");try{return new URL(s,o&&e?"http://example.com":void 0),!0}catch{return!1}}class Uh{constructor(e,o){this.feature=e,this.instancedDataOffset=o,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Hh{constructor(){this.instancedDataArray=new dh,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class vy{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(o=>o.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,o){}populate(e,o,c,d){this.tileToMeter=ce(c);const m=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:g,id:x,index:w,sourceLayerIndex:T}of e){const C=x??(g.properties&&g.properties.hasOwnProperty("id")?g.properties.id:void 0),A=ze(g,m);if(!this.layers[0]._featureFilter.filter(new Tn(this.zoom,{worldview:this.worldview}),A,c))continue;const M={id:C,sourceLayerIndex:T,index:w,geometry:m?A.geometry:_e(g,c,d),properties:g.properties,type:g.type,patterns:{}},k=this.addFeature(M,M.geometry,A);k&&o.featureIndex.insert(g,M.geometry,w,T,this.index,this.instancesPerModel[k].instancedDataArray.length,ht/32)}this.lookup=null}update(e,o,c,d){for(const m in this.instancesPerModel){const g=this.instancesPerModel[m];for(const x in e)g.idToFeaturesIndex.hasOwnProperty(x)&&(this.evaluate(g.features[g.idToFeaturesIndex[x]],e[x],g,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const o in this.instancesPerModel){const c=this.instancesPerModel[o];for(const d of c.features){const m=this.layers[0],g=d.feature,x=this.canonical,w=m.paint.get("model-rotation").evaluate(g,{},x),T=m.paint.get("model-scale").evaluate(g,{},x),C=m.paint.get("model-translation").evaluate(g,{},x);ps(d.rotation,w)&&ps(d.scale,T)&&ps(d.translation,C)||(this.evaluate(d,d.featureStates,c,!0),e=!0)}}return e}updateReplacement(e,o,c,d){if(o.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=o.updateTime;const m=o.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(I_(this.activeReplacements,m))return!1;this.activeReplacements=m;let g=!1;for(const x in this.instancesPerModel){const w=this.instancesPerModel[x],T=w.instancedDataArray;for(const C of w.features){const A=C.instancedDataOffset,M=C.instancedDataCount;for(let k=0;k<M;k++){const F=16*(k+A);let V=T.float32[F+0];const j=V>ht;V=j?V-ht:V;const W=Math.floor(V),Q=T.float32[F+1];let K=!1;for(const te of this.activeReplacements)if(!oE(te,c,jh.Model,d)&&!(te.min.x>W||W>te.max.x||te.min.y>Q||Q>te.max.y)&&(K=Dh(rc(W,Q,e.canonical,te.footprintTileId.canonical),te.footprint),K))break;T.float32[F]=K?V+ht:V,g=g||K!==j}}}return g}isEmpty(){for(const e in this.instancesPerModel)if(0!==this.instancesPerModel[e].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const o in this.instancesPerModel){const c=this.instancesPerModel[o];c.instancedDataArray.length<0||0===c.instancedDataArray.length||(c.instancedDataBuffer?c.instancedDataBuffer.updateData(c.instancedDataArray):c.instancedDataBuffer=e.createVertexBuffer(c.instancedDataArray,t0.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const o in this.instancesPerModel){const c=this.instancesPerModel[o];0!==c.instancedDataArray.length&&c.instancedDataBuffer&&c.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(const o of this.modelUris)e.removeModel(o,"",!0)}addFeature(e,o,c){const d=this.layers[0],m=d.layout.get("model-id").evaluate(c,{},this.canonical);if(!m)return yn(`modelId is not evaluated for layer ${d.id} and it is not going to get rendered.`),m;(vd(m,!1)||void 0!==this.styleDefinedModelURLs[m])&&(this.modelUris.includes(m)||this.modelUris.push(m)),this.instancesPerModel[m]||(this.instancesPerModel[m]=new Hh);const g=this.instancesPerModel[m],x=g.instancedDataArray,w=new Uh(c,x.length);for(const T of o)for(const C of T){if(C.x<0||C.x>=ht||C.y<0||C.y>=ht)continue;const A=(this.lookupDim-1)/ht,M=this.lookupDim*(C.y*A|0)+C.x*A|0;if(this.lookup){if(0!==this.lookup[M])continue;this.lookup[M]=1}this.instanceCount++;const k=x.length;x.resize(k+1),g.instancesEvaluatedElevation.push(0),x.float32[16*k]=C.x,x.float32[16*k+1]=C.y}return w.instancedDataCount=g.instancedDataArray.length-w.instancedDataOffset,w.instancedDataCount>0&&(e.id&&(g.idToFeaturesIndex[e.id]=g.features.length),g.features.push(w),this.evaluate(w,{},g,!1)),m}getModelUris(){return this.modelUris}evaluate(e,o,c,d){const m=this.layers[0],g=e.feature,x=this.canonical,w=e.rotation=m.paint.get("model-rotation").evaluate(g,o,x),T=e.scale=m.paint.get("model-scale").evaluate(g,o,x),C=e.translation=m.paint.get("model-translation").evaluate(g,o,x),A=m.paint.get("model-color").evaluate(g,o,x);A.a=m.paint.get("model-color-mix-intensity").evaluate(g,o,x);const M=[];this.maxVerticalOffset<C[2]&&(this.maxVerticalOffset=C[2]),this.maxScale=Math.max(Math.max(this.maxScale,T[0]),Math.max(T[1],T[2])),gb(M,w,T);const k=Math.round(100*A.a)+A.b/1.05;for(let F=0;F<e.instancedDataCount;++F){const V=e.instancedDataOffset+F,j=16*V,W=c.instancedDataArray.float32;let Q=0;d&&(Q=W[j+6]-c.instancesEvaluatedElevation[V]);const K=0|W[j+1];W[j]=(0|W[j])+A.r/1.05,W[j+1]=K+A.g/1.05,W[j+2]=k,W[j+3]=1/(x.z>10?this.tileToMeter:ce(x,K)),W[j+4]=C[0],W[j+5]=C[1],W[j+6]=C[2]+Q,W[j+7]=M[0],W[j+8]=M[1],W[j+9]=M[2],W[j+10]=M[4],W[j+11]=M[5],W[j+12]=M[6],W[j+13]=M[8],W[j+14]=M[9],W[j+15]=M[10],c.instancesEvaluatedElevation[V]=C[2]}}}let z0,N0;wt(vy,"ModelBucket",{omit:["layers"]}),wt(Hh,"PerModelAttributes"),wt(Uh,"ModelFeature");class Gh{constructor(e,o,c){this._demTile=e,this._dem=this._demTile.dem,this._scale=o,this._offset=c}static create(e,o,c){const d=c||e.findDEMTileFor(o);if(!d||!d.dem)return;const m=d.dem,g=d.tileID,x=1<<o.canonical.z-g.canonical.z;return new Gh(d,m.dim/ht/x,[(o.canonical.x/x-g.canonical.x)*m.dim,(o.canonical.y/x-g.canonical.y)*m.dim])}tileCoordToPixel(e,o){const c=o*this._scale+this._offset[1];return new Je(Math.floor(e*this._scale+this._offset[0]),Math.floor(c))}getElevationAt(e,o,c,d){const m=e*this._scale+this._offset[0],g=o*this._scale+this._offset[1],x=Math.floor(m),w=Math.floor(g),T=this._dem;return d=!!d,c?Ft(Ft(T.get(x,w,d),T.get(x,w+1,d),g-w),Ft(T.get(x+1,w,d),T.get(x+1,w+1,d),g-w),m-x):T.get(x,w,d)}getElevationAtPixel(e,o,c){return this._dem.get(e,o,!!c)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*G(1,e)*this._dem.stride}}const xy=new Float32Array(262144),xd=new Uint8Array(262144);function B0(s){let e=0;if(s.meshes)for(const o of s.meshes)e=Math.max(e,o.aabb.max[2]);if(s.children)for(const o of s.children)e=Math.max(e,B0(o));return e}function V0(s,e,o){if(s.meshes)for(const c of s.meshes){if(c.aabb.min[0]===1/0)continue;const d=on.applyTransform(c.aabb,s.matrix);o.insert(e,d.min[0],d.min[1],d.max[0],d.max[1])}if(s.children)for(const c of s.children)V0(c,e,o)}const j0=["","wall","door","roof","window","lamp","logo"];class by{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:B0(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const o=new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const c of this.node.meshes)this.node.lightMeshIndex!==e&&(c.transformedAabb=on.applyTransformFast(c.aabb,this.node.matrix),o.encapsulate(c.transformedAabb)),e++;this.aabb=o}return this.aabb}}class wy{constructor(e,o,c,d,m,g,x,w){this.id=c,this.layers=e,this.layerIds=this.layers.map(T=>T.fqid),this.stateDependentLayerIds=this.layers.filter(T=>T.isStateDependent()).map(T=>T.id),this.modelTraits|=hd.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,d&&(this.modelTraits|=hd.HasMapboxMeshFeatures),m&&(this.modelTraits|=hd.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=g,this.worldview=w,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const T of o)this.nodesInfo.push(new by(T)),V0(T,x.featureIndexArray.length,x.grid),x.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,x.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,o){for(const c of this.getNodesInfo()){const d=c.node;d.footprint&&o.push({footprint:d.footprint,id:e})}}update(e){const o=0!==Object.keys(e).length;if(o&&!this.stateDependentLayers.length)return;const c=o?this.stateDependentLayers:this.layers;if(!Ga(e,this.states))for(const d of c)this.evaluate(d,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const o=this.getNodesInfo();for(const c of o){const d=c.node;this.uploaded?this.updatePbrBuffer(d):tp(d,e,!0)}for(const c of o)G_(c.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let o=!1;if(!e.meshes)return o;for(const c of e.meshes)c.pbrBuffer&&(c.pbrBuffer.updateData(c.featureArray),o=!0);return o}needsReEvaluation(e,o,c){const d=e.transform.projectionOptions,m=e.style.getBrightness(),g=this.brightness!==m;if(!this.uploaded||this.dirty||d.name!==this.projection.name||Ey(c.paint.get("model-color").value,g)||Ey(c.paint.get("model-color-mix-intensity").value,g)||Ey(c.paint.get("model-roughness").value,g)||Ey(c.paint.get("model-emissive-strength").value,g)||Ey(c.paint.get("model-height-based-emissive-strength-multiplier").value,g)){this.projection=d,this.brightness=m;const x=this.getNodesInfo();for(const w of x)w.state=null;return!0}return!1}evaluateTransform(e,o){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const c=this.getNodesInfo(),d=this.id.canonical;for(const m of c){const g=m.feature;m.evaluatedTranslation=o.paint.get("model-translation").evaluate(g,{},d),m.evaluatedScale=o.paint.get("model-scale").evaluate(g,{},d)}}evaluate(e,o){const c=this.getNodesInfo();for(const d of c){if(!d.node.meshes)continue;const m=d.feature,g=o&&o[m.id];if(Ga(g,d.state))continue;d.state=structuredClone(g);const x=d.node.meshes&&d.node.meshes[0].featureData,w=d.evaluatedColor[2],T=d.evaluatedRMEA[2],C=this.id.canonical;if(d.hasTranslucentParts=!1,x){for(let A=0;A<j0.length;A++){const M=j0[A];M.length&&(m.properties.part=M);const k=e.paint.get("model-color").evaluate(m,g,C).toPremultipliedRenderColor(null),F=e.paint.get("model-color-mix-intensity").evaluate(m,g,C);d.evaluatedColor[A]=[k.r,k.g,k.b,F],d.evaluatedRMEA[A][0]=e.paint.get("model-roughness").evaluate(m,g,C),d.evaluatedRMEA[A][2]=e.paint.get("model-emissive-strength").evaluate(m,g,C),d.evaluatedRMEA[A][3]=k.a,d.emissionHeightBasedParams[A]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(m,g,C),!d.hasTranslucentParts&&k.a<1&&(d.hasTranslucentParts=!0)}delete m.properties.part,QE(d,w!==d.evaluatedColor[2]||T!==d.evaluatedRMEA[2],this.modelTraits)}else d.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(m,g,C);d.evaluatedTranslation=e.paint.get("model-translation").evaluate(m,g,C),d.evaluatedScale=e.paint.get("model-scale").evaluate(m,g,C),this.updatePbrBuffer(d.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,o,c,d){const m=e.findDEMTileFor(c);if(m&&(m.tileID.canonical!==this.terrainTile||o!==this.terrainExaggeration)){if(m.dem&&m.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=m.tileID.overscaledZ;const g=Gh.create(e,c,m);if(!g)return;this.modelTraits&hd.HasMapboxMeshFeatures&&this.updateDEM(e,g,c,d);for(const x of this.getNodesInfo()){const w=x.node;if(!w.footprint||!w.footprint.vertices||!w.footprint.vertices.length)continue;const T=w.footprint.vertices;let C=g.getElevationAt(T[0].x,T[0].y,!0,!0);for(let A=1;A<T.length;A++)C=Math.min(C,g.getElevationAt(T[A].x,T[A].y,!0,!0));w.elevation=C}}this.terrainTile=m.tileID.canonical,this.terrainExaggeration=o}}updateDEM(e,o,c,d){let m=o._dem._modifiedForSources[d];if(void 0===m&&(o._dem._modifiedForSources[d]=[],m=o._dem._modifiedForSources[d]),m.includes(c.canonical))return;const g=o._dem.dim;m.push(c.canonical);let x=!1;for(const w of this.getNodesInfo()){const T=w.node;if(!T.footprint||!T.footprint.grid)continue;const C=T.footprint.grid,A=o.tileCoordToPixel(C.min.x,C.min.y),M=o.tileCoordToPixel(C.max.x,C.max.y),k=Math.min(Math.min(g-M.y,A.x),Math.min(A.y,g-M.x));if(k<0)continue;const F=se(k,2,5);let V=Math.max(0,A.x-F),j=Math.max(0,A.y-F),W=Math.min(M.x+F,g-1),Q=Math.min(M.y+F,g-1);for(let he=j;he<=Q;++he)for(let fe=V;fe<=W;++fe)xd[he*g+fe]=255;let K=0,te=0;for(let he=0;he<C.cellsY;++he)for(let fe=0;fe<C.cellsX;++fe){if(!C.cells[he*C.cellsX+fe])continue;const xe=o.tileCoordToPixel(C.min.x+fe/C.xScale,C.min.y+he/C.yScale),Ee=o.tileCoordToPixel(C.min.x+(fe+1)/C.xScale,C.min.y+(he+1)/C.yScale);for(let Ve=xe.y;Ve<=Math.min(Ee.y+1,g-1);++Ve)for(let Ie=xe.x;Ie<=Math.min(Ee.x+1,g-1);++Ie)255===xd[Ve*g+Ie]&&(xd[Ve*g+Ie]=0,K+=o.getElevationAtPixel(Ie,Ve),te++)}const me=K/te;V=Math.max(1,A.x-F),j=Math.max(1,A.y-F),W=Math.min(M.x+F,g-2),Q=Math.min(M.y+F,g-2),x=!0;for(let he=j;he<=Q;++he)for(let fe=V;fe<=W;++fe)0===xd[he*g+fe]&&(xy[he*g+fe]=o._dem.set(fe,he,me));for(let he=1;he<F;++he){V=Math.max(1,A.x-he),j=Math.max(1,A.y-he),W=Math.min(M.x+he,g-2),Q=Math.min(M.y+he,g-2);for(let fe=j;fe<=Q;++fe)for(let xe=V;xe<=W;++xe){const Ee=fe*g+xe;if(255===xd[Ee]){let Ve=0,Ie=0,Ue=-1,ot=-1;for(let $e=-1;$e<=1;++$e)for(let Ke=-1;Ke<=1;++Ke){const nt=(fe+$e)*g+xe+Ke;if(xd[nt]>=he)continue;const Ne=xy[nt],Qe=Math.abs(Ne);Qe>Ie&&(Ve=Ne,Ie=Qe,Ue=Ke,ot=$e)}if(Ie>.1){const $e=1-(he+.5*Math.abs(Ue*ot))/F;let Ke=o._dem.get(xe,fe)+Ve*$e;const nt=o._dem.get(xe+Ue,fe+ot),Ne=o._dem.get(xe-Ue,fe-ot,!0);(Ke-nt)*(Ke-Ne)>0&&(Ke=(nt+Ne)/2),xy[Ee]=o._dem.set(xe,fe,Ke),xd[Ee]=he}}}}}x&&(o._demTile.needsDEMTextureUpload=!0,o._dem._timestamp=Us.now())}setFilter(e){this.filter=e?ah(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new Tn(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const o of e)G_(o.node),$_(o.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,o){if(o.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=o.updateTime;const c=o.getReplacementRegionsForTile(e.toUnwrapped());for(const d of this.getNodesInfo()){const m=d.node.footprint;d.hiddenByReplacement=!!m&&!c.find(g=>g.footprint===m)}}getHeightAtTileCoord(e,o){const c=[],d=[0,0,0],m=fn([]);for(const g of this.getNodesInfo()){const x=g.node.meshes[0],w=x.transformedAabb;if(e<w.min[0]||o<w.min[1]||e>w.max[0]||o>w.max[1])continue;if(!0===g.node.hidden)return{height:1/0,maxHeight:g.feature.properties.height,hidden:!1,verticalScale:g.evaluatedScale[2]};Zo(m,g.node.matrix),d[0]=e,d[1]=o,rr(d,d,m);const T=(d[0]-x.aabb.min[0])/(x.aabb.max[0]-x.aabb.min[0])*64|0,C=64*Math.min(63,(d[1]-x.aabb.min[1])/(x.aabb.max[1]-x.aabb.min[1])*64|0)+Math.min(63,T),A=x.heightmap[C];if(!(A<0&&g.node.footprint))return g.hiddenByReplacement?void 0:{height:A,maxHeight:g.feature.properties.height,hidden:!1,verticalScale:g.evaluatedScale[2]};if(g.node.footprint.grid.query(new Je(e,o),new Je(e,o),c),c.length>0)return{height:void 0,maxHeight:g.feature.properties.height,hidden:g.hiddenByReplacement,verticalScale:g.evaluatedScale[2]}}}}function Ey(s,e){return s instanceof Sf&&!s.isLightConstant&&e}function BD(s,e,o,c,d,m,g,x){let w=(61440&e|(61440&e)>>4)>>8,T=(3840&e|(3840&e)>>4)>>4,C=240&e|(240&e)>>4;o[3]>0&&(w=Ft(w,255*o[0],o[3]),T=Ft(T,255*o[1],o[3]),C=Ft(C,255*o[2],o[3]));const A=w<<8|T,M=C<<8|Math.floor(255*c[3]),k=function(he){const fe=se(he,0,2);return Math.min(Math.round(.5*fe*255),255)}(c[2])<<8|15*c[0]<<4|15*c[1],F=se(d[0],0,1),V=se(d[1],0,1),j=se(d[2],0,1),W=se(d[3],0,1);let Q,K,te,me;if(F!==V&&g!==m&&V!==F){const he=g-m;K=1/(he*(V-F)),te=-(m+he*F)/(he*(V-F));const fe=se(d[4],-1,1);me=Math.pow(10,fe),Q=255*j<<8|255*W}else Q=65535,K=0,te=1,me=1;if(s.emplaceBack(A,M,k,Q,K,te,me),x){const he=x.length;x.clear();for(let fe=0;fe<he;fe++)x.emplaceBack(A,M,k,Q,K,te,me)}}function QE(s,e,o){const c=s.node;let d=0;const m=o&hd.HasMeshoptCompression;for(const g of c.meshes){if(c.lights&&c.lightMeshIndex===d||!g.featureData)continue;g.featureArray=new Wc,g.featureArray.reserve(g.featureData.length);let x=e;for(const w of g.featureData){const T=m?65535&w:w>>16&65535,C=m?w>>16&65535:65535&w,A=(15&C)<8?15&C:0,M=s.evaluatedRMEA[A],k=s.evaluatedColor[A],F=s.emissionHeightBasedParams[A];let V;if(x&&2===A&&c.lights&&(V=new Wc,V.resize(10*c.lights.length)),BD(g.featureArray,T,k,M,F,g.aabb.min[2],g.aabb.max[2],V),V&&x){x=!1;const j=c.meshes[c.lightMeshIndex];j.featureArray=V,j.featureArray._trim()}}g.featureArray._trim(),d++}}function f1(s,e,o,c){const d=1<<s.z;e.lat=ee((c/ht+s.y)/d),e.lng=Y((o/ht+s.x)/d)}function VD(s,e,o,c){const d=s.getNodesInfo()[e];if(!d||d.hiddenByReplacement||!d.node.meshes)return;let m=Number.MAX_VALUE;const g=d.node,x=o.tile,w=c.calculatePosMatrix(x.tileID.toUnwrapped(),c.worldSize),T=d.evaluatedScale;let C=0;c.elevation&&g.elevation&&(C=g.elevation*c.elevation.exaggeration()),zo(w,w,[(g.anchor?g.anchor[0]:0)*(T[0]-1),(g.anchor?g.anchor[1]:0)*(T[1]-1),C]),eo(w,w,T);const A=o.queryGeometry,M=A.isPointQuery()?A.screenBounds:A.screenGeometry,k=function(V){const j=Bi([],w,V.matrix);Bi(j,c.expandedFarZProjMatrix,j);for(let W=0;W<V.meshes.length;++W){const Q=V.meshes[W];if(W===V.lightMeshIndex)continue;const K=yb(M,c,j,Q.aabb);null!=K&&(m=Math.min(K,m))}if(V.children)for(const W of V.children)k(W)};if(k(g),m===Number.MAX_VALUE)return;const F=new R(0,0);return f1(x.tileID.canonical,F,d.node.anchor[0],d.node.anchor[1]),{intersectionZ:m,position:F,feature:d.feature}}wt(wy,"Tiled3dModelBucket",{omit:["layers"]}),wt(by,"Tiled3dModelFeature");const JE={circle:class extends bo{constructor(s,e,o,c){super(s,{layout:Qc||(Qc=new Wi({"circle-sort-key":new _t(De.layout_circle["circle-sort-key"]),"circle-elevation-reference":new it(De.layout_circle["circle-elevation-reference"]),visibility:new it(De.layout_circle.visibility)})),paint:id||(id=new Wi({"circle-radius":new _t(De.paint_circle["circle-radius"]),"circle-color":new _t(De.paint_circle["circle-color"]),"circle-blur":new _t(De.paint_circle["circle-blur"]),"circle-opacity":new _t(De.paint_circle["circle-opacity"]),"circle-translate":new it(De.paint_circle["circle-translate"]),"circle-translate-anchor":new it(De.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new it(De.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new it(De.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new _t(De.paint_circle["circle-stroke-width"]),"circle-stroke-color":new _t(De.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new _t(De.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new it(De.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c)}createBucket(s){return new qn(s)}queryRadius(s){const e=s;return ao("circle-radius",this,e)+ao("circle-stroke-width",this,e)+cr(this.paint.get("circle-translate"))}queryIntersectsFeature(s,e,o,c,d,m,g,x){const w=nd(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),m.angle,s.pixelToTileUnitsFactor),T=this.paint.get("circle-radius").evaluate(e,o)+this.paint.get("circle-stroke-width").evaluate(e,o);return $x(s,c,m,g,x,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),w,T)}getProgramIds(){return["circle"]}getDefaultProgramParams(s,e,o){const c=Gx(this);return{config:new Uo(this,{zoom:e,lut:o}),defines:c,overrideFog:!1}}is3D(s){return!s&&!!this.layout&&"none"!==this.layout.get("circle-elevation-reference")}hasElevation(){return this.layout&&"none"!==this.layout.get("circle-elevation-reference")}},heatmap:class extends bo{createBucket(s){return new qx(s)}constructor(s,e,o,c){super(s,{layout:Wx||(Wx=new Wi({visibility:new it(De.layout_heatmap.visibility)})),paint:Dv||(Dv=new Wi({"heatmap-radius":new _t(De.paint_heatmap["heatmap-radius"]),"heatmap-weight":new _t(De.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new it(De.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Uc(De.paint_heatmap["heatmap-color"]),"heatmap-opacity":new it(De.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(s){"heatmap-color"===s&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Cm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(s){return ao("heatmap-radius",this,s)}queryIntersectsFeature(s,e,o,c,d,m,g,x){const w=this.paint.get("heatmap-radius").evaluate(e,o);return $x(s,c,m,g,x,!0,!0,new Je(0,0),w)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(s,e,o){return"heatmap"===s?{config:new Uo(this,{zoom:e,lut:o}),overrideFog:!1}:{}}},hillshade:class extends bo{constructor(s,e,o,c){super(s,{layout:Iv||(Iv=new Wi({visibility:new it(De.layout_hillshade.visibility)})),paint:Cv||(Cv=new Wi({"hillshade-illumination-direction":new it(De.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new it(De.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new it(De.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new it(De.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new it(De.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new it(De.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new it(De.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(s,e,o){return{overrideFog:!1}}},fill:class extends bo{constructor(s,e,o,c){super(s,{layout:km||(km=new Wi({"fill-sort-key":new _t(De.layout_fill["fill-sort-key"]),visibility:new it(De.layout_fill.visibility),"fill-elevation-reference":new it(De.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new _t(De.layout_fill["fill-construct-bridge-guard-rail"])})),paint:T_||(T_=new Wi({"fill-antialias":new it(De.paint_fill["fill-antialias"]),"fill-opacity":new _t(De.paint_fill["fill-opacity"]),"fill-color":new _t(De.paint_fill["fill-color"]),"fill-outline-color":new _t(De.paint_fill["fill-outline-color"]),"fill-translate":new it(De.paint_fill["fill-translate"]),"fill-translate-anchor":new it(De.paint_fill["fill-translate-anchor"]),"fill-pattern":new _t(De.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new it(De.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new it(De.paint_fill["fill-emissive-strength"]),"fill-z-offset":new _t(De.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new _t(De.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new _t(De.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c)}getProgramIds(){const s=this.paint.get("fill-pattern"),e=s&&s.constantOr(1),o=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&o.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),o}getDefaultProgramParams(s,e,o){return{config:new Uo(this,{zoom:e,lut:o}),overrideFog:!1}}recalculate(s,e){super.recalculate(s,e);const o=this.paint._values["fill-outline-color"];"constant"===o.value.kind&&void 0===o.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(s){return new od(s)}queryRadius(){return cr(this.paint.get("fill-translate"))}queryIntersectsFeature(s,e,o,c,d,m){return!s.queryGeometry.isAboveHorizon&&lr(Qs(s.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),m.angle,s.pixelToTileUnitsFactor),c)}isTileClipped(){return 0===this.paint.get("fill-z-offset").constantOr(1)}is3D(s){if(0!==this.paint.get("fill-z-offset").constantOr(1))return!0;const e=this.layout&&"none"!==this.layout.get("fill-elevation-reference");return null!=s?e&&!s:e}hasElevation(){return this.layout&&"none"!==this.layout.get("fill-elevation-reference")}hasShadowPass(){return this.layout&&"none"!==this.layout.get("fill-elevation-reference")}},"fill-extrusion":class extends bo{constructor(s,e,o,c){super(s,{layout:uE||(uE=new Wi({visibility:new it(De["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new it(De["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:$f||($f=new Wi({"fill-extrusion-opacity":new it(De["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new _t(De["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new it(De["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new it(De["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new _t(De["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new it(De["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new _t(De["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new _t(De["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new it(De["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new it(De["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new it(De["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new it(De["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new it(De["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new it(De["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new it(De["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new it(De["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new it(De["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new it(De["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new _t(De["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new _t(De["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new it(De["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new it(De["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new it(De["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new it(De["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new _t(De["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new _t(De["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new it(De["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(s){return new iu(s)}queryRadius(){return cr(this.paint.get("fill-extrusion-translate"))}is3D(s){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(s,e,o,c,d,m,g,x,w){const T=nd(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),m.angle,s.pixelToTileUnitsFactor),C=this.paint.get("fill-extrusion-height").evaluate(e,o),A=this.paint.get("fill-extrusion-base").evaluate(e,o),M=[0,0],k=x&&m.elevation,F=m.elevation?m.elevation.exaggeration():1,V=s.tile.getBucket(this);if(k&&V instanceof iu){const te=V.centroidVertexArray,me=w+1;me<te.length&&(M[0]=te.geta_centroid_pos0(me),M[1]=te.geta_centroid_pos1(me))}if(0===M[0]&&1===M[1])return!1;"globe"===m.projection.name&&(c=db([c],[new Je(0,0),new Je(ht,ht)],s.tileID.canonical).map(te=>te.polygon).flat());const j=k?x:null,[W,Q]=(me=c,he=A,fe=C,xe=T,Ee=g,Ve=j,Ie=M,Ue=F,ot=m.center.lat,"globe"===(te=m).projection.name?function(Ke,nt,Ne,Qe,Ce,Be,at,et,Ot,Tt,Xe){const tt=[],Dt=[],yt=Ke.projection.upVectorScale(Xe,Ke.center.lat,Ke.worldSize).metersToTile,ft=[0,0,0,1],xt=[0,0,0,1],zt=(nn,Xt,vn,dn)=>{nn[0]=Xt,nn[1]=vn,nn[2]=dn,nn[3]=1},$t=ub();Ne>0&&(Ne+=$t),Qe+=$t;for(const nn of nt){const Xt=[],vn=[];for(const dn of nn){const ni=dn.x+Ce.x,ie=dn.y+Ce.y,re=Ke.projection.projectTilePoint(ni,ie,Xe),Fe=Ke.projection.upVector(Xe,dn.x,dn.y);let lt=Ne,ut=Qe;if(at){const pt=hE(ni,ie,Ne,Qe,at,et,Ot,Tt);lt+=pt.base,ut+=pt.top}0!==Ne?zt(ft,re.x+Fe[0]*yt*lt,re.y+Fe[1]*yt*lt,re.z+Fe[2]*yt*lt):zt(ft,re.x,re.y,re.z),zt(xt,re.x+Fe[0]*yt*ut,re.y+Fe[1]*yt*ut,re.z+Fe[2]*yt*ut),rr(ft,ft,Be),rr(xt,xt,Be),Xt.push(new oc(ft[0],ft[1],ft[2])),vn.push(new oc(xt[0],xt[1],xt[2]))}tt.push(Xt),Dt.push(vn)}return[tt,Dt]}(te,me,he,fe,xe,Ee,Ve,Ie,Ue,ot,s.tileID.canonical):Ve?function(Ke,nt,Ne,Qe,Ce,Be,at,et,Ot){const Tt=[],Xe=[],tt=[0,0,0,1];for(const Dt of Ke){const yt=[],ft=[];for(const xt of Dt){const zt=xt.x+Qe.x,$t=xt.y+Qe.y,nn=hE(zt,$t,nt,Ne,Be,at,et,Ot);tt[0]=zt,tt[1]=$t,tt[2]=nn.base,tt[3]=1,ms(tt,tt,Ce),tt[3]=Math.max(tt[3],1e-5);const Xt=new oc(tt[0]/tt[3],tt[1]/tt[3],tt[2]/tt[3]);tt[0]=zt,tt[1]=$t,tt[2]=nn.top,tt[3]=1,ms(tt,tt,Ce),tt[3]=Math.max(tt[3],1e-5);const vn=new oc(tt[0]/tt[3],tt[1]/tt[3],tt[2]/tt[3]);yt.push(Xt),ft.push(vn)}Tt.push(yt),Xe.push(ft)}return[Tt,Xe]}(me,he,fe,xe,Ee,Ve,Ie,Ue,ot):function(Ke,nt,Ne,Qe,Ce){const Be=[],at=[],et=Ce[8]*nt,Ot=Ce[9]*nt,Tt=Ce[10]*nt,Xe=Ce[11]*nt,tt=Ce[8]*Ne,Dt=Ce[9]*Ne,yt=Ce[10]*Ne,ft=Ce[11]*Ne;for(const xt of Ke){const zt=[],$t=[];for(const nn of xt){const Xt=nn.x+Qe.x,vn=nn.y+Qe.y,dn=Ce[0]*Xt+Ce[4]*vn+Ce[12],ni=Ce[1]*Xt+Ce[5]*vn+Ce[13],ie=Ce[2]*Xt+Ce[6]*vn+Ce[14],re=Ce[3]*Xt+Ce[7]*vn+Ce[15],Fe=dn+et,lt=ni+Ot,ut=ie+Tt,pt=Math.max(re+Xe,1e-5),St=dn+tt,Ut=ni+Dt,wn=ie+yt,Ht=Math.max(re+ft,1e-5);zt.push(new oc(Fe/pt,lt/pt,ut/pt)),$t.push(new oc(St/Ht,Ut/Ht,wn/Ht))}Be.push(zt),at.push($t)}return[Be,at]}(me,he,fe,xe,Ee)),K=s.queryGeometry;var te,me,he,fe,xe,Ee,Ve,Ie,Ue,ot;return function(te,me,he){let fe=1/0;lr(he,me)&&(fe=jm(he,me[0]));for(let xe=0;xe<me.length;xe++){const Ee=me[xe],Ve=te[xe];for(let Ie=0;Ie<Ee.length-1;Ie++){const Ue=Ee[Ie],ot=[Ue,Ee[Ie+1],Ve[Ie+1],Ve[Ie],Ue];ci(he,ot)&&(fe=Math.min(fe,jm(he,ot)))}}return fe!==1/0&&fe}(W,Q,K.isPointQuery()?K.screenBounds:K.screenGeometry)}},building:class extends bo{constructor(s,e,o,c){super(s,{layout:Tb||(Tb=new Wi({visibility:new it(De.layout_building.visibility),"building-facade":new _t(De.layout_building["building-facade"]),"building-facade-floors":new _t(De.layout_building["building-facade-floors"]),"building-facade-window":new _t(De.layout_building["building-facade-window"]),"building-roof-shape":new _t(De.layout_building["building-roof-shape"]),"building-height":new _t(De.layout_building["building-height"]),"building-base":new _t(De.layout_building["building-base"])})),paint:l0||(l0=new Wi({"building-opacity":new it(De.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new it(De.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new it(De.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new it(De.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new it(De.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new it(De.paint_building["building-vertical-scale"]),"building-cast-shadows":new it(De.paint_building["building-cast-shadows"]),"building-color":new _t(De.paint_building["building-color"]),"building-emissive-strength":new _t(De.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new it(De.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new it(De.paint_building["building-cutoff-fade-range"]),"building-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(s){return new a0(s)}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(s){return!0}},line:class extends bo{constructor(s,e,o,c){const d=Ob();super(s,d,e,o,c),d.layout&&(this.layout=new xo(d.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(s){if("line-gradient"===s){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Za,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(s,e){super.recalculate(s,e),this.paint._values["line-floorwidth"]=(()=>{if(Zm)return Zm;const o=Ob();return Zm=new d0(o.paint.properties["line-width"].specification),Zm.useIntegerZoom=!0,Zm})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,s)}createBucket(s){return new hl(s)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(s,e,o){const c=Rb(this);return{config:new Uo(this,{zoom:e,lut:o}),defines:c,overrideFog:!1}}queryRadius(s){const e=s,o=Lb(ao("line-width",this,e),ao("line-gap-width",this,e)),c=ao("line-offset",this,e);return o/2+Math.abs(c)+cr(this.paint.get("line-translate"))}queryIntersectsFeature(s,e,o,c,d,m){if(s.queryGeometry.isAboveHorizon)return!1;const g=Qs(s.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),m.angle,s.pixelToTileUnitsFactor),x=s.pixelToTileUnitsFactor/2*Lb(this.paint.get("line-width").evaluate(e,o),this.paint.get("line-gap-width").evaluate(e,o)),w=this.paint.get("line-offset").evaluate(e,o);return w&&(c=function(T,C){const A=[],M=new Je(0,0);for(let k=0;k<T.length;k++){const F=T[k],V=[];for(let j=0;j<F.length;j++){const W=F[j],Q=F[j+1],K=0===j?M:W.sub(F[j-1])._unit()._perp(),te=j===F.length-1?M:Q.sub(W)._unit()._perp(),me=K._add(te)._unit();me._mult(1/(me.x*te.x+me.y*te.y)),V.push(me._mult(C)._add(W))}A.push(V)}return A}(c,w*s.pixelToTileUnitsFactor)),function(T,C,A){for(let M=0;M<C.length;M++){const k=C[M];if(T.length>=3)for(let F=0;F<k.length;F++)if(wo(T,k[F]))return!0;if(tr(T,k,A))return!0}return!1}(g,c,x)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(s){return!this.hasElevatedBuckets||this.layout&&"hd-road-markup"===this.layout.get("line-elevation-reference")}hasElevation(){return this.layout&&"none"!==this.layout.get("line-elevation-reference")}},symbol:L0,background:class extends bo{constructor(s,e,o,c){super(s,{layout:k0||(k0=new Wi({visibility:new it(De.layout_background.visibility)})),paint:h1||(h1=new Wi({"background-pitch-alignment":new it(De.paint_background["background-pitch-alignment"]),"background-color":new it(De.paint_background["background-color"]),"background-pattern":new it(De.paint_background["background-pattern"]),"background-opacity":new it(De.paint_background["background-opacity"]),"background-emissive-strength":new it(De.paint_background["background-emissive-strength"]),"background-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(s,e,o){return{overrideFog:!1}}is3D(s){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:ds,"raster-particle":Vh,sky:class extends bo{constructor(s,e,o,c){super(s,{layout:_a||(_a=new Wi({visibility:new it(De.layout_sky.visibility)})),paint:fg||(fg=new Wi({"sky-type":new it(De.paint_sky["sky-type"]),"sky-atmosphere-sun":new it(De.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new it(De.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new it(De.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new it(De.paint_sky["sky-gradient-radius"]),"sky-gradient":new Uc(De.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new it(De.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new it(De.paint_sky["sky-atmosphere-color"]),"sky-opacity":new it(De.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(s){"sky-gradient"===s?this._updateColorRamp():"sky-atmosphere-sun"!==s&&"sky-atmosphere-halo-color"!==s&&"sky-atmosphere-color"!==s&&"sky-atmosphere-sun-intensity"!==s||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Cm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(s){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=s.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(s,e){if("atmosphere"===this.paint.get("sky-type")){const c=this.paint.get("sky-atmosphere-sun"),d=!c,m=s.style.light,g=m.properties.get("position");return d&&"viewport"===m.properties.get("anchor")&&yn("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),d?yd(g.azimuthal,90-g.polar,e):yd(c[0],90-c[1],e)}const o=this.paint.get("sky-gradient-center");return yd(o[0],90-o[1],e)}isSky(){return!0}markSkyboxValid(s){this._skyboxInvalidated=!1,this._lightPosition=s.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const s=this.paint.get("sky-type");return"atmosphere"===s?["skyboxCapture","skybox"]:"gradient"===s?["skyboxGradient"]:null}},slot:class extends bo{constructor(s,e,o,c){super(s,{paint:Bh||(Bh=new Wi({}))},e,null)}},model:class extends bo{constructor(s,e,o,c){super(s,{layout:z0||(z0=new Wi({visibility:new it(De.layout_model.visibility),"model-id":new _t(De.layout_model["model-id"])})),paint:N0||(N0=new Wi({"model-opacity":new _t(De.paint_model["model-opacity"]),"model-rotation":new _t(De.paint_model["model-rotation"]),"model-scale":new _t(De.paint_model["model-scale"]),"model-translation":new _t(De.paint_model["model-translation"]),"model-color":new _t(De.paint_model["model-color"]),"model-color-mix-intensity":new _t(De.paint_model["model-color-mix-intensity"]),"model-type":new it(De.paint_model["model-type"]),"model-cast-shadows":new it(De.paint_model["model-cast-shadows"]),"model-receive-shadows":new it(De.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new it(De.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new _t(De.paint_model["model-emissive-strength"]),"model-roughness":new _t(De.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new _t(De.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new it(De.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new it(De.paint_model["model-front-cutoff"]),"model-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,o,c),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(s){return new vy(s)}getProgramIds(){return["model"]}is3D(s){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(s){return s instanceof wy?ht-1:0}queryIntersectsFeature(s,e,o,c,d,m){if(!this.modelManager)return!1;const g=this.modelManager,x=s.tile.getBucket(this);if(!(x&&x instanceof vy))return!1;for(const w in x.instancesPerModel){const T=x.instancesPerModel[w],C=void 0!==e.id?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(T.idToFeaturesIndex.hasOwnProperty(C)){const A=T.features[T.idToFeaturesIndex[C]],M=g.getModel(w,this.scope);if(!M)return!1;let k=Dl();const F=new R(0,0),V=x.canonical;let j=Number.MAX_VALUE;for(let W=0;W<A.instancedDataCount;++W){const Q=16*(A.instancedDataOffset+W),K=T.instancedDataArray.float32,te=[K[Q+4],K[Q+5],K[Q+6]];f1(V,F,K[Q],0|K[Q+1]),vb(k,M,m,F,A.rotation,A.scale,te,!1,!1,!1),"globe"===m.projection.name&&(k=_b(k,m));const me=Bi([],m.projMatrix,k),he=s.queryGeometry,fe=yb(he.isPointQuery()?he.screenBounds:he.screenGeometry,m,me,M.aabb);null!=fe&&(j=Math.min(fe,j))}return j!==Number.MAX_VALUE&&j}}return!1}_handleOverridablePaintPropertyUpdate(s,e,o){return!(!this.layout||e.isDataDriven()||o.isDataDriven()||"model-color"!==s&&"model-color-mix-intensity"!==s&&"model-rotation"!==s&&"model-scale"!==s&&"model-translation"!==s&&"model-emissive-strength"!==s)}_isPropertyZoomDependent(s){const e=this._transitionablePaint._values[s];return null!=e&&null!=e.value&&null!=e.value.expression&&e.value.expression instanceof Bc}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends bo{constructor(s,e,o,c){super(s,{layout:kv||(kv=new Wi({"clip-layer-types":new it(De.layout_clip["clip-layer-types"]),"clip-layer-scope":new it(De.layout_clip["clip-layer-scope"])})),paint:Fv||(Fv=new Wi({}))},e,o,c)}recalculate(s,e){super.recalculate(s,e)}createBucket(s){return new nb(s)}is3D(s){return!0}}},p1=new Yn(0,0,0),U0={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},H0={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},Ty={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},G0={PAINT_ORDER_FILL_AND_STROKE:1},du={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},Sy={MASK_TYPE_LUMINANCE:1};function Dy(s,e,o){var c,d;1===s&&e.icons.push((c=o,d=o.readVarint()+o.pos,function(m){if(m.usvg_tree.height||(m.usvg_tree.height=m.usvg_tree.width),!m.metadata)return m;const{metadata:g}=m;if(g.content_area){const{content_area:x}=g;null==x.top&&(x.top=x.left),null==x.width&&(x.width=m.usvg_tree.width),null==x.height&&(x.height=x.width)}return g.stretch_x&&g.stretch_x.length&&$0(g,"x"),g.stretch_y&&g.stretch_y.length&&$0(g,"y"),m}(c.readFields(pg,{name:void 0},d))))}function $0(s,e){const o=[],c=s[`stretch_${e}`];let d=null;for(let m=0;m<c.length;m++)null===d?d=0===o.length?c[0]:o[o.length-1][1]+c[m]:(o.push([d,d+c[m]]),d=null);s[`stretch_${e}_areas`]=o}function pg(s,e,o){var c,d;1===s?e.name=o.readString():2===s?e.metadata=(c=o,d=o.readVarint()+o.pos,c.readFields(m1,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},d)):3===s&&(e.usvg_tree=function(c,d){return c.readFields(tT,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},d)}(o,o.readVarint()+o.pos),e.data="usvg_tree")}function m1(s,e,o){var c,d;1===s?e.stretch_x=o.readPackedVarint():2===s?e.stretch_y=o.readPackedVarint():3===s?e.content_area=(c=o,d=o.readVarint()+o.pos,c.readFields(eT,{left:0},d)):4===s&&e.variables.push(function(c,d){return c.readFields(mg,{name:void 0},d)}(o,o.readVarint()+o.pos))}function eT(s,e,o){1===s?e.left=o.readVarint():2===s?e.width=o.readVarint():3===s?e.top=o.readVarint():4===s&&(e.height=o.readVarint())}function mg(s,e,o){1===s?e.name=o.readString():2===s&&(e.rgb_color=My(o.readVarint()),e.value="rgb_color")}function tT(s,e,o){var c,d;1===s?e.width=e.height=o.readVarint():2===s?e.height=o.readVarint():3===s?e.children.push(Iy(o,o.readVarint()+o.pos)):4===s?e.linear_gradients.push((c=o,d=o.readVarint()+o.pos,c.readFields(q0,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},d))):5===s?e.radial_gradients.push(function(c,d){return c.readFields(oT,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},d)}(o,o.readVarint()+o.pos)):7===s?e.clip_paths.push(function(c,d){return c.readFields(sT,{children:[]},d)}(o,o.readVarint()+o.pos)):8===s&&e.masks.push(function(c,d){const m=c.readFields(W0,{left:0,width:20,mask_type:Sy.MASK_TYPE_LUMINANCE,children:[]},d);return null==m.height&&(m.height=m.width),null==m.top&&(m.top=m.left),m}(o,o.readVarint()+o.pos))}function Iy(s,e){return s.readFields(nT,{},e)}function nT(s,e,o){var c,d;1===s?(e.group=(c=o,d=o.readVarint()+o.pos,c.readFields(iT,{opacity:255,children:[]},d)),e.node="group"):2===s&&(e.path=function(c,d){return c.readFields(Ay,{paint_order:1,commands:[],step:1,diffs:[],rule:U0.PATH_RULE_NON_ZERO},d)}(o,o.readVarint()+o.pos),e.node="path")}function iT(s,e,o){1===s?e.transform=yp(o,o.readVarint()+o.pos):2===s?e.opacity=o.readVarint():5===s?e.clip_path_idx=o.readVarint():6===s?e.mask_idx=o.readVarint():7===s&&e.children.push(Iy(o,o.readVarint()+o.pos))}function yp(s,e){return s.readFields(Cy,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function Cy(s,e,o){1===s?e.sx=o.readFloat():2===s?e.ky=o.readFloat():3===s?e.kx=o.readFloat():4===s?e.sy=o.readFloat():5===s?e.tx=o.readFloat():6===s&&(e.ty=o.readFloat())}function Ay(s,e,o){var c,d;1===s?e.fill=(c=o,d=o.readVarint()+o.pos,c.readFields(jD,{rgb_color:p1,paint:"rgb_color",opacity:255},d)):2===s?e.stroke=function(c,d){return c.readFields(rT,{rgb_color:p1,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},d)}(o,o.readVarint()+o.pos):3===s?e.paint_order=o.readVarint():5===s?o.readPackedVarint(e.commands):6===s?e.step=o.readFloat():7===s?o.readPackedSVarint(e.diffs):8===s&&(e.rule=o.readVarint())}function jD(s,e,o){1===s?(e.rgb_color=My(o.readVarint()),e.paint="rgb_color"):2===s?(e.linear_gradient_idx=o.readVarint(),e.paint="linear_gradient_idx"):3===s?(e.radial_gradient_idx=o.readVarint(),e.paint="radial_gradient_idx"):5===s&&(e.opacity=o.readVarint())}function My(s){return new Yn((s>>16&255)/255,(s>>8&255)/255,(255&s)/255,1)}function rT(s,e,o){1===s?(e.rgb_color=My(o.readVarint()),e.paint="rgb_color"):2===s?(e.linear_gradient_idx=o.readVarint(),e.paint="linear_gradient_idx"):3===s?(e.radial_gradient_idx=o.readVarint(),e.paint="radial_gradient_idx"):5===s?o.readPackedFloat(e.dasharray):6===s?e.dashoffset=o.readFloat():7===s?e.miterlimit=o.readFloat():8===s?e.opacity=o.readVarint():9===s?e.width=o.readFloat():10===s?e.linecap=o.readVarint():11===s&&(e.linejoin=o.readVarint())}function q0(s,e,o){1===s?e.transform=yp(o,o.readVarint()+o.pos):2===s?e.spread_method=o.readVarint():3===s?e.stops.push(g1(o,o.readVarint()+o.pos)):4===s?e.x1=o.readFloat():5===s?e.y1=o.readFloat():6===s?e.x2=o.readFloat():7===s&&(e.y2=o.readFloat())}function g1(s,e){return s.readFields(_1,{offset:0,opacity:255,rgb_color:p1},e)}function _1(s,e,o){1===s?e.offset=o.readFloat():2===s?e.opacity=o.readVarint():3===s&&(e.rgb_color=My(o.readVarint()))}function oT(s,e,o){1===s?e.transform=yp(o,o.readVarint()+o.pos):2===s?e.spread_method=o.readVarint():3===s?e.stops.push(g1(o,o.readVarint()+o.pos)):4===s?e.cx=o.readFloat():5===s?e.cy=o.readFloat():6===s?e.r=o.readFloat():7===s?e.fx=o.readFloat():8===s?e.fy=o.readFloat():9===s&&(e.fr=o.readFloat())}function sT(s,e,o){1===s?e.transform=yp(o,o.readVarint()+o.pos):2===s?e.clip_path_idx=o.readVarint():3===s&&e.children.push(Iy(o,o.readVarint()+o.pos))}function W0(s,e,o){1===s?e.left=e.top=o.readFloat():2===s?e.width=e.height=o.readFloat():3===s?e.top=o.readFloat():4===s?e.height=o.readFloat():5===s?e.mask_type=o.readVarint():6===s?e.mask_idx=o.readVarint():7===s&&e.children.push(Iy(o,o.readVarint()+o.pos))}class y1{static calculate(e={},o=[]){const c=new Map,d=new Map;if(0===Object.keys(e).length)return c;o.forEach(m=>{d.set(m.name,m.rgb_color||new Yn(0,0,0))});for(const[m,g]of Object.entries(e))d.has(m)?c.set(d.get(m).toString(),g):console.warn(`Ignoring unknown image variable "${m}"`);return c}}function $h(s,e=255,o){const c=e/255,d=s.toString(),m=o.has(d)?o.get(d).clone():s.clone();return m.a*=c,m.toString()}function gg(s,e){if(!gc()){const o=document.createElement("canvas");return o.width=s,o.height=e,o}return new OffscreenCanvas(s,e)}function aT(s,e){const o=y1.calculate(e.params,s.metadata?s.metadata.variables:[]),c=s.usvg_tree,d=c.width,m=c.height,g=e.transform?e.transform:new DOMMatrix,x=Math.max(1,Math.round(d*g.a)),w=Math.max(1,Math.round(m*g.d)),T=new DOMMatrix([x/d,0,0,w/m,0,0]),C=gg(x,w).getContext("2d");return Z0(C,T,c,c,o),C.getImageData(0,0,x,w)}function Z0(s,e,o,c,d){for(const m of c.children)v1(s,e,o,m,d)}function v1(s,e,o,c,d){var m,x,w,T;c.group?(s.save(),function(m,g,x,w,T){const C=null!=w.mask_idx?x.masks[w.mask_idx]:null,A=null!=w.clip_path_idx?x.clip_paths[w.clip_path_idx]:null;if(w.transform&&(g=vp(w.transform).preMultiplySelf(g)),255===w.opacity&&!(null!=A)&&!(null!=C))return void Z0(m,g,x,w,T);const M=gg(m.canvas.width,m.canvas.height),k=M.getContext("2d");Z0(k,g,x,w,T),A&&Y0(k,g,x,A),C&&b1(k,g,x,C,T),m.globalAlpha=w.opacity/255,m.drawImage(M,0,0)}(s,e,o,c.group,d),s.restore()):c.path&&(s.save(),x=o,w=c.path,T=d,(m=s).setTransform(e),w.paint_order===G0.PAINT_ORDER_FILL_AND_STROKE?(X0(m,x,w,T),x1(m,x,w,T)):(x1(m,x,w,T),X0(m,x,w,T)),s.restore())}function X0(s,e,o,c){const d=o.fill;if(!d)return;const m=d.opacity/255;switch(s.save(),s.beginPath(),w1(o,s),d.paint){case"rgb_color":s.fillStyle=$h(d.rgb_color,d.opacity,c);break;case"linear_gradient_idx":{const g=e.linear_gradients[d.linear_gradient_idx];g.transform&&s.setTransform(vp(g.transform).preMultiplySelf(s.getTransform())),s.fillStyle=qh(s,g,m,c);break}case"radial_gradient_idx":{const g=e.radial_gradients[d.radial_gradient_idx];g.transform&&s.setTransform(vp(g.transform).preMultiplySelf(s.getTransform())),s.fillStyle=Wh(s,g,m,c)}}s.fill(Py(o)),s.restore()}function Py(s){return s.rule===U0.PATH_RULE_NON_ZERO?"nonzero":s.rule===U0.PATH_RULE_EVEN_ODD?"evenodd":void 0}function x1(s,e,o,c){const d=o.stroke;if(!d)return;const m=Ry(o);s.lineWidth=d.width,s.miterLimit=d.miterlimit,s.setLineDash(d.dasharray),s.lineDashOffset=d.dashoffset;const g=d.opacity/255;switch(d.paint){case"rgb_color":s.strokeStyle=$h(d.rgb_color,d.opacity,c);break;case"linear_gradient_idx":s.strokeStyle=qh(s,e.linear_gradients[d.linear_gradient_idx],g,c,!0);break;case"radial_gradient_idx":s.strokeStyle=Wh(s,e.radial_gradients[d.radial_gradient_idx],g,c,!0)}switch(d.linejoin){case Ty.LINE_JOIN_MITER_CLIP:case Ty.LINE_JOIN_MITER:s.lineJoin="miter";break;case Ty.LINE_JOIN_ROUND:s.lineJoin="round";break;case Ty.LINE_JOIN_BEVEL:s.lineJoin="bevel"}switch(d.linecap){case H0.LINE_CAP_BUTT:s.lineCap="butt";break;case H0.LINE_CAP_ROUND:s.lineCap="round";break;case H0.LINE_CAP_SQUARE:s.lineCap="square"}s.stroke(m)}function qh(s,e,o,c,d=!1){if(1===e.stops.length){const M=e.stops[0];return $h(M.rgb_color,M.opacity*o,c)}const{x1:m,y1:g,x2:x,y2:w}=e;let T=new DOMPoint(m,g),C=new DOMPoint(x,w);if(d){const M=vp(e.transform);T=M.transformPoint(T),C=M.transformPoint(C)}const A=s.createLinearGradient(T.x,T.y,C.x,C.y);for(const M of e.stops)A.addColorStop(M.offset,$h(M.rgb_color,M.opacity*o,c));return A}function Wh(s,e,o,c,d=!1){if(1===e.stops.length){const W=e.stops[0];return $h(W.rgb_color,W.opacity*o,c)}const m=vp(e.transform),{fx:g,fy:x,fr:w,cx:T,cy:C,r:A}=e;let M=new DOMPoint(g,x),k=new DOMPoint(T,C),F=w,V=A;if(d){M=m.transformPoint(M),k=m.transformPoint(k);const W=(m.a+m.d)/2;F=w*W,V=e.r*W}const j=s.createRadialGradient(M.x,M.y,F,k.x,k.y,V);for(const W of e.stops)j.addColorStop(W.offset,$h(W.rgb_color,W.opacity*o,c));return j}function Zh(s,e,o,c){const d=c.transform?vp(c.transform).preMultiplySelf(e):e,m=gg(s.canvas.width,s.canvas.height),g=m.getContext("2d");for(const w of c.children)if(w.group)Zh(g,d,o,w.group);else if(w.path){const T=w.path,C=new Path2D;C.addPath(Ry(T),d),g.fill(C,Py(T))}const x=null!=c.clip_path_idx?o.clip_paths[c.clip_path_idx]:null;x&&Y0(g,d,o,x),s.globalCompositeOperation="source-over",s.drawImage(m,0,0)}function Y0(s,e,o,c){const d=gg(s.canvas.width,s.canvas.height);Zh(d.getContext("2d"),e,o,c),s.globalCompositeOperation="destination-in",s.drawImage(d,0,0)}function b1(s,e,o,c,d){if(0===c.children.length)return;const m=null!=c.mask_idx?o.masks[c.mask_idx]:null;m&&b1(s,e,o,m,d);const g=s.canvas.width,x=s.canvas.height,w=gg(g,x),T=w.getContext("2d"),C=c.width,A=c.height,M=c.left,k=c.top,F=new Path2D,V=new Path2D;V.rect(M,k,C,A),F.addPath(V,e),T.clip(F);for(const Q of c.children)v1(T,e,o,Q,d);const j=T.getImageData(0,0,g,x),W=j.data;if(c.mask_type===Sy.MASK_TYPE_LUMINANCE)for(let Q=0;Q<W.length;Q+=4)W[Q+3]=W[Q+3]/255*(.2126*W[Q]+.7152*W[Q+1]+.0722*W[Q+2]);T.putImageData(j,0,0),s.globalCompositeOperation="destination-in",s.drawImage(w,0,0)}function vp(s){return s?new DOMMatrix([s.sx,s.ky,s.kx,s.sy,s.tx,s.ty]):new DOMMatrix}function w1(s,e){const o=s.step;let c=s.diffs[0]*o,d=s.diffs[1]*o;e.moveTo(c,d);for(let m=0,g=2;m<s.commands.length;m++)switch(s.commands[m]){case du.PATH_COMMAND_MOVE:c+=s.diffs[g++]*o,d+=s.diffs[g++]*o,e.moveTo(c,d);break;case du.PATH_COMMAND_LINE:c+=s.diffs[g++]*o,d+=s.diffs[g++]*o,e.lineTo(c,d);break;case du.PATH_COMMAND_QUAD:{const x=c+s.diffs[g++]*o,w=d+s.diffs[g++]*o;c=x+s.diffs[g++]*o,d=w+s.diffs[g++]*o,e.quadraticCurveTo(x,w,c,d);break}case du.PATH_COMMAND_CUBIC:{const x=c+s.diffs[g++]*o,w=d+s.diffs[g++]*o,T=x+s.diffs[g++]*o,C=w+s.diffs[g++]*o;c=T+s.diffs[g++]*o,d=C+s.diffs[g++]*o,e.bezierCurveTo(x,w,T,C,c,d);break}case du.PATH_COMMAND_CLOSE:e.closePath()}return e}function Ry(s){return w1(s,new Path2D)}class xp{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const o=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,o),o}put(e,o){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,o)}delete(e){this.cache.delete(e)}}wt(xp,"LRUCache");class Oy{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new jr(e,e.data)}getFromCache(e,o,c){return this.cacheMap.has(c)||this.cacheMap.set(c,new xp(150)),this.cacheMap.get(c).get(Wu(e.toString(),o))}setInCache(e,o,c,d){this.cacheDependenciesMap.has(d)||this.cacheDependenciesMap.set(d,new Map),this.cacheMap.has(d)||this.cacheMap.set(d,new xp(150));const m=this.cacheDependenciesMap.get(d),g=Wu(e.id.toString(),c);m.get(g)||m.set(g,new Set);const x=this.cacheMap.get(d),w=e.toString();m.get(g).add(w),x.put(Wu(e.toString(),c),o)}removeImagesFromCacheByIds(e,o,c=0){if(!this.cacheMap.has(c)||!this.cacheDependenciesMap.has(c))return;const d=this.cacheMap.get(c),m=this.cacheDependenciesMap.get(c);for(const g of e){const x=Wu(g.toString(),o);if(m.has(x)){for(const w of m.get(x))d.delete(w);m.delete(x)}}}rasterize(e,o,c,d,m=aT){const g=this.getFromCache(e,c,d);if(g)return g.clone();const x=m(o.icon,e.options),w=Oy._getImage(x);return this.setInCache(e,w,c,d),w.clone()}}class K0{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,o){const c=this.toIdx(e,o);return{min:this.minimums[c],max:this.maximums[c]}}isLeaf(e,o){return this.leaves[this.toIdx(e,o)]}toIdx(e,o){return o*this.size+e}}function E1(s,e,o,c){let d=0,m=Number.MAX_VALUE;for(let g=0;g<3;g++)if(Math.abs(c[g])<1e-15){if(o[g]<s[g]||o[g]>e[g])return null}else{const x=1/c[g];let w=(s[g]-o[g])*x,T=(e[g]-o[g])*x;if(w>T){const C=w;w=T,T=C}if(w>d&&(d=w),T<m&&(m=T),d>m)return null}return d}function T1(s,e,o,c,d,m,g,x,w,T,C){const A=c-s,M=d-e,k=m-o,F=g-s,V=x-e,j=w-o,W=C[1]*j-C[2]*V,Q=C[2]*F-C[0]*j,K=C[0]*V-C[1]*F,te=A*W+M*Q+k*K;if(Math.abs(te)<1e-15)return null;const me=1/te,he=T[0]-s,fe=T[1]-e,xe=T[2]-o,Ee=(he*W+fe*Q+xe*K)*me;if(Ee<0||Ee>1)return null;const Ve=fe*k-xe*M,Ie=xe*A-he*k,Ue=he*M-fe*A,ot=(C[0]*Ve+C[1]*Ie+C[2]*Ue)*me;return ot<0||Ee+ot>1?null:(F*Ve+V*Ie+j*Ue)*me}function S1(s,e,o){return(s-e)/(o-e)}function Ly(s,e,o,c,d,m,g,x,w){const T=1<<o,C=m-c,A=g-d,M=(s+1)/T*C+c,k=(e+0)/T*A+d,F=(e+1)/T*A+d;x[0]=(s+0)/T*C+c,x[1]=k,w[0]=M,w[1]=F}class Q0{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const o=function(m){const g=Math.ceil(Math.log2(m.dim/8)),x=[];let w=Math.ceil(Math.pow(2,g));const T=1/w,C=(k,F,V,j,W)=>{const Q=j?1:0,K=(k+1)*V-Q,te=F*V,me=(F+1)*V-Q;W[0]=k*V,W[1]=te,W[2]=K,W[3]=me};let A=new K0(w);const M=[];for(let k=0;k<w*w;k++){C(k%w,Math.floor(k/w),T,!1,M);const F=hu(M[0],M[1],m),V=hu(M[2],M[1],m),j=hu(M[2],M[3],m),W=hu(M[0],M[3],m);A.minimums.push(Math.min(F,V,j,W)),A.maximums.push(Math.max(F,V,j,W)),A.leaves.push(1)}for(x.push(A),w/=2;w>=1;w/=2){const k=x[x.length-1];A=new K0(w);for(let F=0;F<w*w;F++){C(F%w,Math.floor(F/w),2,!0,M);const V=k.getElevation(M[0],M[1]),j=k.getElevation(M[2],M[1]),W=k.getElevation(M[2],M[3]),Q=k.getElevation(M[0],M[3]),K=k.isLeaf(M[0],M[1]),te=k.isLeaf(M[2],M[1]),me=k.isLeaf(M[2],M[3]),he=k.isLeaf(M[0],M[3]),fe=Math.min(V.min,j.min,W.min,Q.min),xe=Math.max(V.max,j.max,W.max,Q.max),Ee=K&&te&&me&&he;A.maximums.push(xe),A.minimums.push(fe),A.leaves.push(xe-fe<=5&&Ee?1:0)}x.push(A)}return x}(this.dem),c=o.length-1,d=o[c];this._addNode(d.minimums[0],d.maximums[0],d.leaves[0]),this._construct(o,0,0,c,0)}raycastRoot(e,o,c,d,m,g,x=1){return E1([e,o,-100],[c,d,this.maximums[0]*x],m,g)}raycast(e,o,c,d,m,g,x=1){if(!this.nodeCount)return null;const w=this.raycastRoot(e,o,c,d,m,g,x);if(null==w)return null;const T=[],C=[],A=[],M=[],k=[{idx:0,t:w,nodex:0,nodey:0,depth:0}];for(;k.length>0;){const{idx:F,t:V,nodex:j,nodey:W,depth:Q}=k.pop();if(this.leaves[F]){Ly(j,W,Q,e,o,c,d,A,M);const te=1<<Q,me=(j+0)/te,he=(j+1)/te,fe=(W+0)/te,xe=(W+1)/te,Ee=hu(me,fe,this.dem)*x,Ve=hu(he,fe,this.dem)*x,Ie=hu(he,xe,this.dem)*x,Ue=hu(me,xe,this.dem)*x,ot=T1(A[0],A[1],Ee,M[0],A[1],Ve,M[0],M[1],Ie,m,g),$e=T1(M[0],M[1],Ie,A[0],M[1],Ue,A[0],A[1],Ee,m,g),Ke=Math.min(null!==ot?ot:Number.MAX_VALUE,null!==$e?$e:Number.MAX_VALUE);if(Ke!==Number.MAX_VALUE)return Ke;{const nt=No([],m,g,V);if(J0(Ee,Ve,Ue,Ie,S1(nt[0],A[0],M[0]),S1(nt[1],A[1],M[1]))>=nt[2])return V}continue}let K=0;for(let te=0;te<this._siblingOffset.length;te++){Ly((j<<1)+this._siblingOffset[te][0],(W<<1)+this._siblingOffset[te][1],Q+1,e,o,c,d,A,M),A[2]=-100,M[2]=this.maximums[this.childOffsets[F]+te]*x;const me=E1(A,M,m,g);if(null!=me){const he=me;T[te]=he;let fe=!1;for(let xe=0;xe<K&&!fe;xe++)he>=T[C[xe]]&&(C.splice(xe,0,te),fe=!0);fe||(C[K]=te),K++}}for(let te=0;te<K;te++){const me=C[te];k.push({idx:this.childOffsets[F]+me,t:T[me],nodex:(j<<1)+this._siblingOffset[me][0],nodey:(W<<1)+this._siblingOffset[me][1],depth:Q+1})}}return null}_addNode(e,o,c){return this.minimums.push(e),this.maximums.push(o),this.leaves.push(c),this.childOffsets.push(0),this.nodeCount++}_construct(e,o,c,d,m){if(1===e[d].isLeaf(o,c))return;this.childOffsets[m]||(this.childOffsets[m]=this.nodeCount);const g=d-1,x=e[g];let w=0,T=0;for(let C=0;C<this._siblingOffset.length;C++){const A=2*o+this._siblingOffset[C][0],M=2*c+this._siblingOffset[C][1],k=x.getElevation(A,M),F=x.isLeaf(A,M),V=this._addNode(k.min,k.max,F);F&&(w|=1<<C),T||(T=V)}for(let C=0;C<this._siblingOffset.length;C++)w&1<<C||this._construct(e,2*o+this._siblingOffset[C][0],2*c+this._siblingOffset[C][1],g,T+C)}}function J0(s,e,o,c,d,m){return Ft(Ft(s,o,m),Ft(e,c,m),d)}function hu(s,e,o){const c=o.dim,d=se(s*c-.5,0,c-1),m=se(e*c-.5,0,c-1),g=Math.floor(d),x=Math.floor(m),w=Math.min(g+1,c-1),T=Math.min(x+1,c-1);return J0(o.get(g,x),o.get(w,x),o.get(g,T),o.get(w,T),d-g,m-x)}const lT={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function D1(s,e,o){return(256*s*256+256*e+o)/10-1e4}function I1(s,e,o){return 256*s+e+o/256-32768}class _g{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,o,c,d=!1){if(this.uid=e,o.height!==o.width)throw new RangeError("DEM tiles must be square");if(c&&"mapbox"!==c&&"terrarium"!==c)return void yn(`"${c}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=o.height;const m=this.dim=o.height-2,g=new Uint32Array(o.data.buffer);if(this.pixels=new Uint8Array(o.data.buffer),this.floatView=new Float32Array(o.data.buffer),this.borderReady=d,this._modifiedForSources={},!d){for(let w=0;w<m;w++)g[this._idx(-1,w)]=g[this._idx(0,w)],g[this._idx(m,w)]=g[this._idx(m-1,w)],g[this._idx(w,-1)]=g[this._idx(w,0)],g[this._idx(w,m)]=g[this._idx(w,m-1)];g[this._idx(-1,-1)]=g[this._idx(0,0)],g[this._idx(m,-1)]=g[this._idx(m-1,0)],g[this._idx(-1,m)]=g[this._idx(0,m-1)],g[this._idx(m,m)]=g[this._idx(m-1,m-1)]}const x="terrarium"===c?I1:D1;for(let w=0;w<g.length;++w){const T=4*w;this.floatView[w]=x(this.pixels[T],this.pixels[T+1],this.pixels[T+2])}this._timestamp=Us.now()}_buildQuadTree(){this._tree=new Q0(this)}get(e,o,c=!1){c&&(e=se(e,-1,this.dim),o=se(o,-1,this.dim));const d=this._idx(e,o);return this.floatView[d]}set(e,o,c){const d=this._idx(e,o),m=this.floatView[d];return this.floatView[d]=c,c-m}static getUnpackVector(e){return lT[e]}_idx(e,o){if(e<-1||e>=this.dim+1||o<-1||o>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(o+1)*this.stride+(e+1)}static pack(e,o){const c=[0,0,0,0],d=_g.getUnpackVector(o);let m=Math.floor((e+d[3])/d[2]);return c[2]=m%256,m=Math.floor(m/256),c[1]=m%256,m=Math.floor(m/256),c[0]=m,c}getPixels(){return new Zx({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,o,c){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let d=o*this.dim,m=o*this.dim+this.dim,g=c*this.dim,x=c*this.dim+this.dim;switch(o){case-1:d=m-1;break;case 1:m=d+1}switch(c){case-1:g=x-1;break;case 1:x=g+1}const w=-o*this.dim,T=-c*this.dim;for(let C=g;C<x;C++)for(let A=d;A<m;A++){const M=4*this._idx(A,C),k=4*this._idx(A+w,C+T);this.pixels[M+0]=e.pixels[k+0],this.pixels[M+1]=e.pixels[k+1],this.pixels[M+2]=e.pixels[k+2],this.pixels[M+3]=e.pixels[k+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function cT(s,e,o){var c,d;1===s?e.headerLength=o.readFixed32():2===s?e.x=o.readVarint():3===s?e.y=o.readVarint():4===s?e.z=o.readVarint():5===s&&e.layers.push((c=o,d=o.readVarint()+o.pos,c.readFields(ex,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},d)))}function uT(s,e,o){var c,d;1===s?(e.delta_filter=(c=o,d=o.readVarint()+o.pos,c.readFields(dT,{blockSize:0},d)),e.filter="delta_filter"):2===s?(o.readVarint(),e.filter="zigzag_filter"):3===s?(o.readVarint(),e.filter="bitshuffle_filter"):4===s&&(o.readVarint(),e.filter="byteshuffle_filter")}function dT(s,e,o){1===s&&(e.blockSize=o.readVarint())}function hT(s,e,o){1===s?(o.readVarint(),e.codec="gzip_data"):2===s?(o.readVarint(),e.codec="jpeg_image"):3===s?(o.readVarint(),e.codec="webp_image"):4===s&&(o.readVarint(),e.codec="png_image")}function C1(s,e,o){let c=0,d=0;var m,g;1===s?e.firstByte=o.readFixed64():2===s?e.lastByte=o.readFixed64():3===s?e.filters.push((m=o,g=o.readVarint()+o.pos,m.readFields(uT,{},g))):4===s?e.codec=function(m,g){return m.readFields(hT,{},g)}(o,o.readVarint()+o.pos):5===s?d=o.readFloat():6===s?c=o.readFloat():7===s?e.bands.push(o.readString()):8===s?e.offset=o.readDouble():9===s&&(e.scale=o.readDouble()),0===e.offset&&(e.offset=d),0===e.scale&&(e.scale=c)}function ex(s,e,o){var c,d;1===s?e.version=o.readVarint():2===s?e.name=o.readString():3===s?e.units=o.readString():4===s?e.tileSize=o.readVarint():5===s?e.buffer=o.readVarint():6===s?e.pixelFormat=o.readVarint():7===s&&e.dataIndex.push((c=o,d=o.readVarint()+o.pos,c.readFields(C1,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},d)))}function A1(s,e,o){if(2===s)c=o,d=o.readVarint()+o.pos,c.readFields(M1,e,d);else if(3===s)throw new Error("Not implemented");var c,d}function M1(s,e,o){if(1===s){let c=0;const d=o.readVarint()+o.pos;for(;o.pos<d;)e[c++]=o.readVarint()}}function P1(s,e){if(4!==e.length)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let o=e[3];for(let c=2;c>=1;c--){const d=1===c?1:0,m=2===c?1:0;for(let g=0;g<e[0];g++){const x=e[1]*g;for(let w=d;w<e[1];w++){const T=e[2]*(w+x);for(let C=m;C<e[2];C++){const A=e[3]*(C+T);for(let M=0;M<e[3];M++){const k=A+M;s[k]+=s[k-o]}}}}o*=e[c]}return s}function R1(s){for(let e=0,o=s.length;e<o;e++)s[e]=s[e]>>>1^-(1&s[e]);return s}function O1(s,e){switch(e){case"uint32":return s;case"uint16":for(let o=0;o<s.length;o+=2){const c=s[o],d=s[o+1];s[o]=(240&c)>>4|(61440&c)>>8|(240&d)<<4|61440&d,s[o+1]=15&c|(3840&c)>>4|(15&d)<<8|(3840&d)<<4}return s;case"uint8":for(let o=0;o<s.length;o+=4){const c=s[o],d=s[o+1],m=s[o+2],g=s[o+3];s[o+0]=(192&c)>>6|(192&d)>>4|(192&m)>>2|192&g,s[o+1]=(48&c)>>4|(48&d)>>2|48&m|(48&g)<<2,s[o+2]=(12&c)>>2|12&d|(12&m)<<2|(12&g)<<4,s[o+3]=3&c|(3&d)<<2|(3&m)<<4|(3&g)<<6}return s;default:throw new Error(`Invalid pixel format, "${e}"`)}}wt(_g,"DEMData"),wt(Q0,"DemMinMaxQuadTree",{omit:["dem"]});var ta=Uint8Array,bp=Uint16Array,L1=Int32Array,yg=new ta([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fu=new ta([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),fT=new ta([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),k1=function(s,e){for(var o=new bp(31),c=0;c<31;++c)o[c]=e+=1<<s[c-1];var d=new L1(o[30]);for(c=1;c<30;++c)for(var m=o[c];m<o[c+1];++m)d[m]=m-o[c]<<5|c;return{b:o,r:d}},ky=k1(yg,2),bd=ky.b,tx=ky.r;bd[28]=258,tx[258]=28;for(var pT=k1(fu,0).b,Fy=new bp(32768),zr=0;zr<32768;++zr){var vg=(43690&zr)>>1|(21845&zr)<<1;Fy[zr]=((65280&(vg=(61680&(vg=(52428&vg)>>2|(13107&vg)<<2))>>4|(3855&vg)<<4))>>8|(255&vg)<<8)>>1}var xg=function(s,e,o){for(var c=s.length,d=0,m=new bp(e);d<c;++d)s[d]&&++m[s[d]-1];var g,x=new bp(e);for(d=1;d<e;++d)x[d]=x[d-1]+m[d-1]<<1;g=new bp(1<<e);var w=15-e;for(d=0;d<c;++d)if(s[d])for(var T=d<<4|s[d],C=e-s[d],A=x[s[d]-1]++<<C,M=A|(1<<C)-1;A<=M;++A)g[Fy[A]>>w]=T;return g},bg=new ta(288);for(zr=0;zr<144;++zr)bg[zr]=8;for(zr=144;zr<256;++zr)bg[zr]=9;for(zr=256;zr<280;++zr)bg[zr]=7;for(zr=280;zr<288;++zr)bg[zr]=8;var nx=new ta(32);for(zr=0;zr<32;++zr)nx[zr]=5;var mT=xg(bg,9),Oo=xg(nx,5),zy=function(s){for(var e=s[0],o=1;o<s.length;++o)s[o]>e&&(e=s[o]);return e},gl=function(s,e,o){var c=e/8|0;return(s[c]|s[c+1]<<8)>>(7&e)&o},ix=function(s,e){var o=e/8|0;return(s[o]|s[o+1]<<8|s[o+2]<<16)>>(7&e)},F1=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],_l=function(s,e,o){var c=new Error(e||F1[s]);if(c.code=s,Error.captureStackTrace&&Error.captureStackTrace(c,_l),!o)throw c;return c},z1=new ta(0),N1=typeof TextDecoder<"u"&&new TextDecoder;try{N1.decode(z1,{stream:!0})}catch{}const wp={gzip_data:"gzip"};class La extends Error{constructor(e){super(e),this.name="MRTError"}}const gT={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},rx={uint32:1,uint16:2,uint8:4},_T={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Ny;class ox{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const o=this.layers[e];if(!o)throw new La(`Layer '${e}' not found`);return o}getHeaderLength(e){const o=new Uint8Array(e),c=new DataView(e);if(13!==o[0])throw new La("File is not a valid MRT.");return c.getUint32(1,!0)}parseHeader(e){const o=new Uint8Array(e),c=this.getHeaderLength(e);if(o.length<c)throw new La(`Expected header with length >= ${c} but got buffer of length ${o.length}`);const d=new Ny(o.subarray(0,c)).readFields(cT,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==d.x||this.y!==d.y||this.z!==d.z))throw new La(`Invalid attempt to parse header ${d.z}/${d.x}/${d.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=d.x,this.y=d.y,this.z=d.z;for(const m of d.layers)this.layers[m.name]=new sx(m,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const o=[],c=this.getLayer(e.layerName);for(let d of e.blockIndices){const m=c.dataIndex[d],g=m.firstByte-e.firstByte,x=m.lastByte-e.firstByte;if(c._blocksInProgress.has(d))continue;const w={layerName:c.name,firstByte:g,lastByte:x,pixelFormat:c.pixelFormat,blockIndex:d,blockShape:[m.bands.length].concat(c.bandShape),buffer:c.buffer,codec:m.codec.codec,filters:m.filters.map(T=>T.filter)};c._blocksInProgress.add(d),o.push(w)}return new By(o,()=>{o.forEach(d=>c._blocksInProgress.delete(d.blockIndex))},(d,m)=>{if(o.forEach(g=>c._blocksInProgress.delete(g.blockIndex)),d)throw d;m.forEach(g=>{this.getLayer(g.layerName).processDecodedData(g)})})}}class sx{constructor({version:e,name:o,units:c,tileSize:d,pixelFormat:m,buffer:g,dataIndex:x},w){if(this.version=e,1!==this.version)throw new La(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=o,this.units=c,this.tileSize=d,this.buffer=g,this.pixelFormat=gT[m],this.dataIndex=x,this.bandShape=[d+2*g,d+2*g,rx[this.pixelFormat]],this._decodedBlocks=new xp(w?w.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return rx[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){const o=e.blockIndex.toString();this._decodedBlocks.get(o)||this._decodedBlocks.put(o,e.data)}getBlockForBand(e){let o=0;switch(typeof e){case"string":for(const[c,d]of this.dataIndex.entries()){for(const[m,g]of d.bands.entries())if(g===e)return{bandIndex:o+m,blockIndex:c,blockBandIndex:m};o+=d.bands.length}break;case"number":for(const[c,d]of this.dataIndex.entries()){if(e>=o&&e<o+d.bands.length)return{bandIndex:e,blockIndex:c,blockBandIndex:e-o};o+=d.bands.length}break;default:throw new La(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let o=1/0,c=-1/0;const d=[],m=new Set;for(const g of e){const{blockIndex:x}=this.getBlockForBand(g);if(x<0)throw new La(`Invalid band: ${JSON.stringify(g)}`);const w=this.dataIndex[x];d.includes(x)||d.push(x),m.add(x),o=Math.min(o,w.firstByte),c=Math.max(c,w.lastByte)}if(m.size>this.cacheSize)throw new La(`Number of blocks to decode (${m.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:o,lastByte:c,blockIndices:d}}hasBand(e){const{blockIndex:o}=this.getBlockForBand(e);return o>=0}hasDataForBand(e){const{blockIndex:o}=this.getBlockForBand(e);return o>=0&&!!this._decodedBlocks.get(o.toString())}getBandView(e){const{blockIndex:o,blockBandIndex:c}=this.getBlockForBand(e);if(o<0)throw new La(`Band not found: ${JSON.stringify(e)}`);const d=this._decodedBlocks.get(o.toString());if(!d)throw new La(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const m=this.dataIndex[o],g=this.bandShape.reduce((T,C)=>T*C,1),x=c*g,w=d.subarray(x,x+g);return{data:w,bytes:new Uint8Array(w.buffer).subarray(w.byteOffset,w.byteOffset+w.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:m.offset,scale:m.scale}}}ox.setPbf=function(s){Ny=s};class By{constructor(e,o,c){this.tasks=e,this._onCancel=o,this._onComplete=c,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,o){this._finalized||(this._onComplete(e,o),this._finalized=!0)}}ox.performDecoding=function(s,e){const o=new Uint8Array(s);return Promise.all(e.tasks.map(c=>{const{layerName:d,firstByte:m,lastByte:g,pixelFormat:x,blockShape:w,blockIndex:T,filters:C,codec:A}=c,M=o.subarray(m,g+1),k=new Uint32Array(w[0]*w[1]*w[2]);let F;if("gzip_data"!==A)throw new La(`Unhandled codec: ${A}`);return F=function(V,j){if(!globalThis.DecompressionStream&&"gzip_data"===j)return Promise.resolve(((te=function(fe){31==fe[0]&&139==fe[1]&&8==fe[2]||_l(6,"invalid gzip data");var xe=fe[3],Ee=10;4&xe&&(Ee+=2+(fe[10]|fe[11]<<8));for(var Ve=(xe>>3&1)+(xe>>4&1);Ve>0;Ve-=!fe[Ee++]);return Ee+(2&xe)}(K=V))+8>K.length&&_l(6,"invalid gzip data"),function(fe,xe,Ee,Ve){var Ie=fe.length;if(!Ie||xe.f&&!xe.l)return Ee||new ta(0);var Ue=!Ee,ot=Ue||2!=xe.i,$e=xe.i;Ue&&(Ee=new ta(3*Ie));var Ke,nt,Ne=function(Wn){var Ri=Ee.length;if(Wn>Ri){var hi=new ta(Math.max(2*Ri,Wn));hi.set(Ee),Ee=hi}},Qe=xe.f||0,Ce=xe.p||0,Be=xe.b||0,at=xe.l,et=xe.d,Ot=xe.m,Tt=xe.n,Xe=8*Ie;do{if(!at){Qe=gl(fe,Ce,1);var tt=gl(fe,Ce+1,3);if(Ce+=3,!tt){var Dt=fe[(ie=4+((Ce+7)/8|0))-4]|fe[ie-3]<<8,yt=ie+Dt;if(yt>Ie){$e&&_l(0);break}ot&&Ne(Be+Dt),Ee.set(fe.subarray(ie,yt),Be),xe.b=Be+=Dt,xe.p=Ce=8*yt,xe.f=Qe;continue}if(1==tt)at=mT,et=Oo,Ot=9,Tt=5;else if(2==tt){var ft=gl(fe,Ce,31)+257,xt=gl(fe,Ce+10,15)+4,zt=ft+gl(fe,Ce+5,31)+1;Ce+=14;for(var $t=new ta(zt),nn=new ta(19),Xt=0;Xt<xt;++Xt)nn[fT[Xt]]=gl(fe,Ce+3*Xt,7);Ce+=3*xt;var vn=zy(nn),dn=(1<<vn)-1,ni=xg(nn,vn);for(Xt=0;Xt<zt;){var ie,re=ni[gl(fe,Ce,dn)];if(Ce+=15&re,(ie=re>>4)<16)$t[Xt++]=ie;else{var Fe=0,lt=0;for(16==ie?(lt=3+gl(fe,Ce,3),Ce+=2,Fe=$t[Xt-1]):17==ie?(lt=3+gl(fe,Ce,7),Ce+=3):18==ie&&(lt=11+gl(fe,Ce,127),Ce+=7);lt--;)$t[Xt++]=Fe}}var ut=$t.subarray(0,ft),pt=$t.subarray(ft);Ot=zy(ut),Tt=zy(pt),at=xg(ut,Ot),et=xg(pt,Tt)}else _l(1);if(Ce>Xe){$e&&_l(0);break}}ot&&Ne(Be+131072);for(var St=(1<<Ot)-1,Ut=(1<<Tt)-1,wn=Ce;;wn=Ce){var Ht=(Fe=at[ix(fe,Ce)&St])>>4;if((Ce+=15&Fe)>Xe){$e&&_l(0);break}if(Fe||_l(2),Ht<256)Ee[Be++]=Ht;else{if(256==Ht){wn=Ce,at=null;break}var hn=Ht-254;Ht>264&&(hn=gl(fe,Ce,(1<<(en=yg[Xt=Ht-257]))-1)+bd[Xt],Ce+=en);var si=et[ix(fe,Ce)&Ut],$i=si>>4;if(si||_l(3),Ce+=15&si,pt=pT[$i],$i>3){var en=fu[$i];pt+=ix(fe,Ce)&(1<<en)-1,Ce+=en}if(Ce>Xe){$e&&_l(0);break}ot&&Ne(Be+131072);var Pi=Be+hn;if(Be<pt){var ai=0-pt,Vn=Math.min(pt,Pi);for(ai+Be<0&&_l(3);Be<Vn;++Be)Ee[Be]=(void 0)[ai+Be]}for(;Be<Pi;++Be)Ee[Be]=Ee[Be-pt]}}xe.l=at,xe.p=wn,xe.b=Be,xe.f=Qe,at&&(Qe=1,xe.m=Ot,xe.d=et,xe.n=Tt)}while(!Qe);return Be!=Ee.length&&Ue?(Ke=Ee,(null==(nt=Be)||nt>Ke.length)&&(nt=Ke.length),new ta(Ke.subarray(0,nt))):Ee.subarray(0,Be)}(K.subarray(te,-8),{i:2},new ta(((W=K)[(Q=W.length)-4]|W[Q-3]<<8|W[Q-2]<<16|W[Q-1]<<24)>>>0))));var W,Q,K,te;const me=wp[j];if(!me)throw new Error(`Unhandled codec: ${j}`);const he=new globalThis.DecompressionStream(me);return new Response(new Blob([V]).stream().pipeThrough(he)).arrayBuffer().then(fe=>new Uint8Array(fe))}(M,A).then(V=>(new Ny(V).readFields(A1,k),new _T[x](k.buffer))),F.then(V=>{for(let j=C.length-1;j>=0;j--)switch(C[j]){case"delta_filter":P1(V,w);break;case"zigzag_filter":R1(V);break;case"bitshuffle_filter":O1(V,x);break;default:throw new La(`Unhandled filter "${C[j]}"`)}return{layerName:d,blockIndex:T,data:V}}).catch(V=>{throw V})}))},wt(By,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),wt(ox,"MapboxRasterTile"),wt(sx,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class yl{constructor(e){this._stringToNumber={},this._numberToString=[];for(let o=0;o<e.length;o++){const c=e[o];this._stringToNumber[c]=o,this._numberToString[o]=c}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const yT=["id","tile","layer","source","sourceLayer","state"];class Ep{constructor(e,o,c,d,m){this.type="Feature",this._vectorTileFeature=e,this._z=o,this._x=c,this._y=d,this.properties=e.properties,this.id=m}clone(){const e=new Ep(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const o of yT)void 0!==this[o]&&(e[o]=this[o]);return e}}class vl{constructor(e,o){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Wl(ht,16,0),this.featureIndexArray=new Qu,this.promoteId=o,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,o,c,d,m,g=0,x=0){const w=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(c,d,m,g);const T=this.grid;for(let C=0;C<o.length;C++){const A=o[C],M=[1/0,1/0,-1/0,-1/0];for(let k=0;k<A.length;k++){const F=A[k];M[0]=Math.min(M[0],F.x),M[1]=Math.min(M[1],F.y),M[2]=Math.max(M[2],F.x),M[3]=Math.max(M[3],F.y)}0!==x&&(M[0]-=x,M[1]-=x,M[2]+=x,M[3]+=x),M[0]<ht&&M[1]<ht&&M[2]>=0&&M[3]>=0&&T.insert(w,M[0],M[1],M[2],M[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Ct(new fd(this.rawTileData)).layers,this.sourceLayerCoder=new yl(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,o){const{tilespaceGeometry:c,transform:d,tileTransform:m,pixelPosMatrix:g,availableImages:x,worldview:w}=o;this.loadVTLayers(),this.serializedLayersCache.clear();const T=c.bufferedTilespaceBounds,C=this.grid.query(T.min.x,T.min.y,T.max.x,T.max.y,(F,V,j,W)=>Zi(c.bufferedTilespaceGeometry,F,V,j,W));C.sort(xl);let A=null;d.elevation&&C.length>0&&(A=Gh.create(d.elevation,this.tileID));const M={};let k;for(let F=0;F<C.length;F++){const V=C[F];if(V===k)continue;k=V;const j=this.featureIndexArray.get(V);let W=null;this.is3DTile?this.loadMatchingModelFeature(M,j,e,c,d,w):this.loadMatchingFeature(M,j,e,x,w,(Q,K,te,me=0)=>(W||(W=_e(Q,this.tileID.canonical,m)),K.queryIntersectsFeature(c,Q,te,W,this.z,d,g,A,me)))}return M}loadMatchingFeature(e,o,c,d,m,g){const{featureIndex:x,bucketIndex:w,sourceLayerIndex:T,layoutVertexArrayOffset:C}=o,A=this.bucketLayerIDs[w],M=c.layers,k=Object.keys(M);if(k.length&&!cn(k,A))return;const F=c.sourceCache,V=this.sourceLayerCoder.decode(T),j=this.vtLayers[V].feature(x),W=this.getId(j,V);for(let Q=0;Q<A.length;Q++){const K=A[Q];if(!M[K])continue;const{styleLayer:te,targets:me}=M[K];let he={};void 0!==W&&(he=F.getFeatureState(te.sourceLayer,W));const fe=!g||g(j,te,he,C);if(!fe)continue;const xe=new Ep(j,this.z,this.x,this.y,W);xe.tile=this.tileID.canonical,xe.state=he;let Ee=this.serializedLayersCache.get(K);Ee||(Ee=te.serialize(),Ee.id=K,this.serializedLayersCache.set(K,Ee)),xe.source=Ee.source,xe.sourceLayer=Ee["source-layer"],xe.layer=Ae({},Ee),xe.layer.paint=ka(Ee.paint,te.paint,j,he,d),xe.layer.layout=ka(Ee.layout,te.layout,j,he,d);let Ve=!1;for(const Ie of me){this.updateFeatureProperties(xe,Ie);const{filter:Ue}=Ie;if(Ue)if(j.properties=xe.properties,Ue.needGeometry){const ot=ze(j,!0);if(!Ue.filter(new Tn(this.tileID.overscaledZ,{worldview:m}),ot,this.tileID.canonical))continue}else if(!Ue.filter(new Tn(this.tileID.overscaledZ,{worldview:m}),j))continue;Ve=!0,Ie.targetId&&this.addFeatureVariant(xe,Ie)}Ve&&this.appendToResult(e,K,x,xe,fe)}}loadMatchingModelFeature(e,o,c,d,m,g){const{featureIndex:x,bucketIndex:w}=o,T=this.bucketLayerIDs[w],C=c.layers,A=Object.keys(C);if(!A.length||cn(A,T))for(let M=0;M<T.length;M++){const k=T[M],{styleLayer:F,targets:V}=C[k];if("model"!==F.type)continue;const j=d.tile,W=j.getBucket(F);if(!(W&&W instanceof wy))continue;const Q=VD(W,x,d,m);if(!Q)continue;const{z:K,x:te,y:me}=j.tileID.canonical,{feature:he,intersectionZ:fe,position:xe}=Q;let Ee={};void 0!==he.id&&(Ee=c.sourceCache.getFeatureState(F.sourceLayer,he.id));const Ve=new Ep({},K,te,me,he.id);Ve.tile=this.tileID.canonical,Ve.state=Ee,Ve.properties=he.properties,Ve.geometry={type:"Point",coordinates:[xe.lng,xe.lat]};let Ie=this.serializedLayersCache.get(k);Ie||(Ie=F.serialize(),Ie.id=k,this.serializedLayersCache.set(k,Ie)),Ve.source=Ie.source,Ve.sourceLayer=Ie["source-layer"],Ve.layer=Ae({},Ie);let Ue=!1;for(const ot of V){this.updateFeatureProperties(Ve,ot);const{filter:$e}=ot;if($e)if(he.properties=Ve.properties,$e.needGeometry){if(!$e.filter(new Tn(this.tileID.overscaledZ,{worldview:g}),he,this.tileID.canonical))continue}else if(!$e.filter(new Tn(this.tileID.overscaledZ,{worldview:g}),he))continue;Ue=!0,ot.targetId&&this.addFeatureVariant(Ve,ot)}Ue&&this.appendToResult(e,k,x,Ve,fe)}}updateFeatureProperties(e,o,c){if(o.properties){const d={};for(const m in o.properties){const g=o.properties[m].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,c);null!=g&&(d[m]=g)}e.properties=d}}addFeatureVariant(e,o,c){const d={target:o.target,namespace:o.namespace,uniqueFeatureID:o.uniqueFeatureID};o.properties&&(d.properties=e.properties),e.variants=e.variants||{},e.variants[o.targetId]=e.variants[o.targetId]||[],e.variants[o.targetId].push(d)}appendToResult(e,o,c,d,m){let g=e[o];void 0===g&&(g=e[o]=[]),g.push({featureIndex:c,feature:d,intersectionZ:m})}lookupSymbolFeatures(e,o,c,d,m,g){const x={};this.loadVTLayers();for(const w of e)this.loadMatchingFeature(x,{bucketIndex:o,sourceLayerIndex:c,featureIndex:w,layoutVertexArrayOffset:0},d,m,g);return x}loadFeature(e){const{featureIndex:o,sourceLayerIndex:c}=e;this.loadVTLayers();const d=this.sourceLayerCoder.decode(c),m=this.vtFeatures[d];if(m[o])return m[o];const g=this.vtLayers[d].feature(o);return m[o]=g,g}hasLayer(e){for(const o of this.bucketLayerIDs)for(const c of o)if(e===c)return!0;return!1}getId(e,o){let c=e.id;if(this.promoteId){const d=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[o];if(null!=d)if(Array.isArray(d)){if(!this.promoteIdExpression){const m=Nc(d);if("success"!==m.result)return void yn(`Failed to create expression for promoteId: ${m.value.map(x=>`${x.key}: ${x.message}`).join(", ")}`);this.promoteIdExpression=m.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Hd),c=this.promoteIdExpression.evaluate({zoom:0},e)}else c=e.properties[d];"boolean"==typeof c&&(c=Number(c))}return c}}function ka(s,e,o,c,d){return Wt(s,(m,g)=>{const x=e instanceof xo?e.get(g):null;return x&&x.evaluate?x.evaluate(o,c,void 0,d):x})}function xl(s,e){return e-s}wt(vl,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const ax=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Vy{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[o,c]=new Uint8Array(e,0,2);if(219!==o)throw new Error("Data does not appear to be in a KDBush format.");const d=c>>4;if(1!==d)throw new Error(`Got v${d} data when expected v1.`);const m=ax[15&c];if(!m)throw new Error("Unrecognized array type.");const[g]=new Uint16Array(e,2,1),[x]=new Uint32Array(e,4,1);return new Vy(x,g,m,e)}constructor(e,o=64,c=Float64Array,d){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+o,2),65535),this.ArrayType=c,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const m=ax.indexOf(this.ArrayType),g=2*e*this.ArrayType.BYTES_PER_ELEMENT,x=e*this.IndexArrayType.BYTES_PER_ELEMENT,w=(8-x%8)%8;if(m<0)throw new Error(`Unexpected typed array class: ${c}.`);d&&d instanceof ArrayBuffer?(this.data=d,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+x+w,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+g+x+w),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+x+w,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+m]),new Uint16Array(this.data,2,1)[0]=o,new Uint32Array(this.data,4,1)[0]=e)}add(e,o){const c=this._pos>>1;return this.ids[c]=c,this.coords[this._pos++]=e,this.coords[this._pos++]=o,c}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return lx(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,o,c,d){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:m,coords:g,nodeSize:x}=this,w=[0,m.length-1,0],T=[];for(;w.length;){const C=w.pop()||0,A=w.pop()||0,M=w.pop()||0;if(A-M<=x){for(let j=M;j<=A;j++){const W=g[2*j],Q=g[2*j+1];W>=e&&W<=c&&Q>=o&&Q<=d&&T.push(m[j])}continue}const k=M+A>>1,F=g[2*k],V=g[2*k+1];F>=e&&F<=c&&V>=o&&V<=d&&T.push(m[k]),(0===C?e<=F:o<=V)&&(w.push(M),w.push(k-1),w.push(1-C)),(0===C?c>=F:d>=V)&&(w.push(k+1),w.push(A),w.push(1-C))}return T}within(e,o,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:d,coords:m,nodeSize:g}=this,x=[0,d.length-1,0],w=[],T=c*c;for(;x.length;){const C=x.pop()||0,A=x.pop()||0,M=x.pop()||0;if(A-M<=g){for(let j=M;j<=A;j++)jy(m[2*j],m[2*j+1],e,o)<=T&&w.push(d[j]);continue}const k=M+A>>1,F=m[2*k],V=m[2*k+1];jy(F,V,e,o)<=T&&w.push(d[k]),(0===C?e-c<=F:o-c<=V)&&(x.push(M),x.push(k-1),x.push(1-C)),(0===C?e+c>=F:o+c>=V)&&(x.push(k+1),x.push(A),x.push(1-C))}return w}}function lx(s,e,o,c,d,m){if(d-c<=o)return;const g=c+d>>1;B1(s,e,g,c,d,m),lx(s,e,o,c,g-1,1-m),lx(s,e,o,g+1,d,1-m)}function B1(s,e,o,c,d,m){for(;d>c;){if(d-c>600){const T=d-c+1,C=o-c+1,A=Math.log(T),M=.5*Math.exp(2*A/3),k=.5*Math.sqrt(A*M*(T-M)/T)*(C-T/2<0?-1:1);B1(s,e,o,Math.max(c,Math.floor(o-C*M/T+k)),Math.min(d,Math.floor(o+(T-C)*M/T+k)),m)}const g=e[2*o+m];let x=c,w=d;for(wg(s,e,c,o),e[2*d+m]>g&&wg(s,e,c,d);x<w;){for(wg(s,e,x,w),x++,w--;e[2*x+m]<g;)x++;for(;e[2*w+m]>g;)w--}e[2*c+m]===g?wg(s,e,c,w):(w++,wg(s,e,w,d)),w<=o&&(c=w+1),o<=w&&(d=w-1)}}function wg(s,e,o,c){cx(s,o,c),cx(e,2*o,2*c),cx(e,2*o+1,2*c+1)}function cx(s,e,o){const c=s[e];s[e]=s[o],s[o]=c}function jy(s,e,o,c){const d=s-o,m=e-c;return d*d+m*m}u.$=Xr,u.A=qr,u.B=aa,u.C=Wu,u.D=Zf,u.E=Mu,u.F=2,u.G=us,u.H=Qb,u.I=Qt,u.J=di,u.K=class extends uu{},u.L=Ec,u.M=n_,u.N=Uu,u.O=ju,u.P=Je,u.Q=Ef,u.R=ki,u.S=Qg,u.T=Oh,u.U=Sn,u.V=uu,u.W=Df,u.X=Nc,u.Y=Hl,u.Z=ca,u._=On,u.a=function(s){return no.API_CDN_URL_REGEX.test(s)},u.a$=qe,u.a0=Pu,u.a1=Gu,u.a2=th,u.a3=Jp,u.a4=function(s){const e=s.value;let o=[];if(!e)return o;const c=di(e);return"string"!==c?(o=o.concat([new uu(s.key,e,`string expected, "${c}" found`)]),o):(vd(e,!0)||(o=o.concat([new uu(s.key,e,`invalid url "${e}"`)])),o)},u.a5=De,u.a6=Pa,u.a7=Wi,u.a8=it,u.a9=class{constructor(s){this.specification=s}possiblyEvaluate(s,e){return Pr(s.expression.evaluate(e))}interpolate(s,e,o){return{x:Ft(s.x,e.x,o),y:Ft(s.y,e.y,o),z:Ft(s.z,e.z,o),azimuthal:Ft(s.azimuthal,e.azimuthal,o),polar:Ft(s.polar,e.polar,o)}}},u.aA=ms,u.aB=Po,u.aC=wo,u.aD=U,u.aE=ye,u.aF=function(s,e){const o={};for(let c=0;c<e.length;c++){const d=e[c];d in s&&(o[d]=s[d])}return o},u.aG=z,u.aH=q,u.aI=class{constructor(s){this.entries={},this.scheduler=s}request(s,e,o,c){const d=this.entries[s]=this.entries[s]||{callbacks:[]};if(d.result){const[m,g]=d.result;return this.scheduler?this.scheduler.add(()=>{c(m,g)},e):c(m,g),()=>{}}return d.callbacks.push(c),d.cancel||(d.cancel=o((m,g)=>{d.result=[m,g];for(const x of d.callbacks)this.scheduler?this.scheduler.add(()=>{x(m,g)},e):x(m,g);setTimeout(()=>delete this.entries[s],3e3)})),()=>{d.result||(d.callbacks=d.callbacks.filter(m=>m!==c),d.callbacks.length||(d.cancel(),delete this.entries[s]))}}},u.aJ=function(s,e,o){const c=JSON.stringify(s.request);return s.data&&(this.deduped.entries[c]={result:[null,s.data]}),this.deduped.request(c,{type:"parseTile",isSymbolTile:s.isSymbolTile,zoom:s.tileZoom},d=>{const m=vc(s.request,(g,x,w,T)=>{g?d(g):x&&d(null,{vectorTile:o?void 0:new Ct(new fd(x)),rawData:x,cacheControl:w,expires:T})});return()=>{m.cancel(),d()}},e)},u.aK=function(s){Fn++,Fn>Di&&(s.getActor().send("enforceCacheSizeLimit",oa),Fn=0)},u.aL=function(s){return s<=1?1:Math.pow(2,Math.floor(Math.log(s)/Math.LN2))},u.aM=Tr,u.aN=ds,u.aO=Vh,u.aP=ml,u.aQ=function(s,e){const o=document.createElement("video");o.muted=!0,o.onloadstart=function(){e(null,o)};for(let c=0;c<s.length;c++){const d=document.createElement("source");Rs(s[c])||(o.crossOrigin="Anonymous"),d.src=s[c],o.appendChild(d)}return{cancel:()=>{}}},u.aR=ud,u.aS=function(s){return fetch(s).then(e=>e.arrayBuffer()).then(e=>Rh(e,0,s))},u.aT=ga,u.aU=class{constructor(s,e,o,c){this.id=s,this.position=null!=e?new R(e[0],e[1]):new R(0,0),this.orientation=o??[0,0,0],this.nodes=c,this.uploaded=!1,this.aabb=new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(s,e){if(Bi(s.matrix,e,s.matrix),s.meshes)for(const o of s.meshes){const c=on.applyTransformFast(o.aabb,s.matrix);this.aabb.encapsulate(c)}if(s.children)for(const o of s.children)this._applyTransformations(o,s.matrix)}computeBoundsAndApplyParent(){const s=fn([]);for(const e of this.nodes)this._applyTransformations(e,s)}computeModelMatrix(s,e,o,c,d,m,g=!1){vb(this.matrix,this,s.transform,this.position,e,o,c,d,m,g)}upload(s){if(!this.uploaded){for(const e of this.nodes)tp(e,s);for(const e of this.nodes)G_(e);this.uploaded=!0}}destroy(){for(const s of this.nodes)$_(s)}},u.aV=Gt,u.aW=fp,u.aX=Y,u.aY=ee,u.aZ=Qr,u.a_=Mi,u.aa=Tn,u.ab=Bc,u.ac=ue,u.ad=rr,u.ae=uo,u.af=be,u.ag=xo,u.ah=eu,u.ai=Ft,u.aj=ht,u.ak=uf,u.al=Pn,u.am=Yn,u.an=class{constructor(s){this.specification=s}possiblyEvaluate(s,e){return function([o,c]){const d=Pr([1,o,c]);return{x:d.x,y:d.y,z:d.z}}(s.expression.evaluate(e))}interpolate(s,e,o){return{x:Ft(s.x,e.x,o),y:Ft(s.y,e.y,o),z:Ft(s.z,e.z,o)}}},u.ao=function(s,e,o=0,c=!0){const d=new Je(o,o),m=s.sub(d),g=e.add(d),x=[m,new Je(g.x,m.y),g,new Je(m.x,g.y)];return c&&x.push(m.clone()),x},u.ap=function(s,e){const o=[];for(let c=0;c<s.length;c++){const d=ke(c-1,-1,s.length-1),m=ke(c+1,-1,s.length-1),g=s[c],x=s[m],w=s[d].sub(g).unit(),T=x.sub(g).unit(),C=T.angleWithSep(w.x,w.y),A=w.add(T).unit().mult(-1*e/Math.sin(C/2));o.push(g.add(A))}return o},u.aq=ig,u.ar=Zi,u.as=function(s,e,o=0){return dr(((e.x-o)*s.scale-s.x)*ht,(e.y*s.scale-s.y)*ht,ne(e.z,e.y))},u.at=or,u.au=Ai,u.av=An,u.aw=Pb,u.ax=function(s){let e=1/0,o=1/0,c=-1/0,d=-1/0;for(const m of s)e=Math.min(e,m.x),o=Math.min(o,m.y),c=Math.max(c,m.x),d=Math.max(d,m.y);return{min:new Je(e,o),max:new Je(c,d)}},u.ay=se,u.az=Bi,u.b=function(s){return no.API_FONTS_REGEX.test(s)},u.b$=cy,u.b0=hh,u.b1=py,u.b2=function(){zs.isLoading()||zs.isLoaded()||"deferred"!==ar()||Of()},u.b3=ah,u.b4=ze,u.b5=Ep,u.b6=Bn,u.b7=hl,u.b8=od,u.b9=_e,u.bA=function(s,e){const{x:o,y:c}=s.point,d=Tv(o,c,s.worldSize/s._pixelsPerMercatorPixel,0,0);return Bi(d,d,Sm(Oa(e)))},u.bB=xa,u.bC=Cd,u.bD=function(s,e){return Math.hypot(e[0]-s[0],e[1]-s[1],e[2]-s[2])},u.bE=No,u.bF=yi,u.bG=ir,u.bH=Qm,u.bI=Ds,u.bJ=y0,u.bK=function(s,e,o,c,d){const m=5*e+2;s.float32[m+0]=o,s.float32[m+1]=c,s.float32[m+2]=d},u.bL=fy,u.bM=Gr,u.bN=Ha,u.bO=ja,u.bP=Ps,u.bQ=ke,u.bR=function(s,e,o,c){var d=new Ni(4);return d[0]=s,d[1]=e,d[2]=o,d[3]=c,d},u.bS=Vm,u.bT=ci,u.bU=Sr,u.bV=oE,u.bW=jh,u.bX=rc,u.bY=Dh,u.bZ=cp,u.b_=T0,u.ba=xs,u.bb=fm,u.bc=bm,u.bd=Gi,u.be=yh,u.bf=F0,u.bg=function(s,e){const o=eu(e.zoom);if(0===o)return Oa(s);const c=wm(s),d=Ev(c),m=U(c.getWest())*e.worldSize,g=U(c.getEast())*e.worldSize,x=q(c.getNorth())*e.worldSize,w=q(c.getSouth())*e.worldSize,T=[m,x,0],C=[g,x,0],A=[m,w,0],M=[g,w,0],k=Zo([],e.globeMatrix);return rr(T,T,k),rr(C,C,k),rr(A,A,k),rr(M,M,k),d[0]=Jc(d[0],A,o),d[1]=Jc(d[1],M,o),d[2]=Jc(d[2],C,o),d[3]=Jc(d[3],T,o),on.fromPoints(d)},u.bh=Tm,u.bi=Zo,u.bj=Em,u.bk=Jc,u.bl=Hc,u.bm=d_,u.bn=Cl,u.bo=zo,u.bp=ox,u.bq=fd,u.br=vc,u.bs=function(s,e){const o=[];for(const c in s)c in e||o.push(c);return o},u.bt=Te,u.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],u.bv=Ga,u.bw=function(s){var e=new Ni(16);return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],e},u.bx=fn,u.by=Il,u.bz=Dl,u.c=af,u.c$=45,u.c0=Vy,u.c1=Li,u.c2=Al,u.c3=Ta,u.c4=function(s,e,o){o*=.5;var c=e[0],d=e[1],m=e[2],g=e[3],x=Math.sin(o),w=Math.cos(o);return s[0]=c*w+d*x,s[1]=d*w-c*x,s[2]=m*w+g*x,s[3]=g*w-m*x,s},u.c5=mc,u.c6=Ui,u.c7=function(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s[3]=e[3],s},u.c8=ba,u.c9=function(s,e,o,c,d){var m,g=1/Math.tan(e/2);return s[0]=g/o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=g,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,null!=d&&d!==1/0?(s[10]=(d+c)*(m=1/(c-d)),s[14]=2*d*c*m):(s[10]=-1,s[14]=-2*c),s},u.cA=Ho,u.cB=Bx,u.cC=function(s,e,o,c,d,m,g,x,w){if("globe"===w.name)return Bx(s,e,new Ho(o,c,d),!1);const T=fp({z:o,x:c,y:d},w);return new on([(m+T.x/T.scale)*e,e*(T.y/T.scale),g],[(m+T.x2/T.scale)*e,e*(T.y2/T.scale),x])},u.cD=function(s,e,o){return s[0]=Math.min(e[0],o[0]),s[1]=Math.min(e[1],o[1]),s[2]=Math.min(e[2],o[2]),s[3]=Math.min(e[3],o[3]),s},u.cE=function(s,e,o){return s[0]=Math.max(e[0],o[0]),s[1]=Math.max(e[1],o[1]),s[2]=Math.max(e[2],o[2]),s[3]=Math.max(e[3],o[3]),s},u.cF=function(s){const e=Math.round((s+45+360)%360/90)%4;return Z[e]},u.cG=le,u.cH=Na,u.cI=f,u.cJ=function(s){const e=fn(new Float64Array(16));Bi(e,s.pixelMatrix,s.globeMatrix);const o=[0,_,0],c=[0,v,0];return rr(o,o,e),rr(c,c,e),[o[0]>0&&o[0]<=s.width&&o[1]>0&&o[1]<=s.height&&!p_(s,new R(s.center.lat,90)),c[0]>0&&c[0]<=s.width&&c[1]>0&&c[1]<=s.height&&!p_(s,new R(s.center.lat,-90))]},u.cK=function(s,e){const{scale:o}=s.tileTransform,c=o*ht/(s.tileSize*Math.pow(2,e.zoom-s.tileID.overscaledZ+s.tileID.canonical.z));return d=new Float32Array(4),x=(m=e.inverseAdjustmentMatrix)[1],w=m[2],T=m[3],A=(g=[c,c])[1],d[0]=m[0]*(C=g[0]),d[1]=x*C,d[2]=w*A,d[3]=T*A,d;var d,m,g,x,w,T,C,A},u.cL=U_,u.cM=tf,u.cN=mb,u.cO=function(s){const e=mb(s,!0);return xa([],[e[0],e[1],e[4],e[5]])},u.cP=eo,u.cQ=Ln,u.cR=fs,u.cS=function(s){const{x:e,y:o}=s.point,{lng:c,lat:d}=s._center;return Tv(e,o,s.worldSize,c,d)},u.cT=nf,u.cU=Pe,u.cV=Es,u.cW=Ji,u.cX=Uf,u.cY=function(s,e,o){let c=0;for(let d=0;d<2;++d)s[d]>0&&(c+=(s[d]-0)*(s[d]-0)),e[d]<0&&(c+=(0-e[d])*(0-e[d]));return c},u.cZ=function(s){return s*s*s*s*s},u.c_=H,u.ca=function(s,e,o,c,d,m,g){var x=1/(e-o),w=1/(c-d),T=1/(m-g);return s[0]=-2*x,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*w,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*T,s[11]=0,s[12]=(e+o)*x,s[13]=(d+c)*w,s[14]=(g+m)*T,s[15]=1,s},u.cb=G,u.cc=function(s,e,o){s[4*e+0]=o[0],s[4*e+1]=o[1],s[4*e+2]=o[2],s[4*e+3]=o[3]},u.cd=ph,u.ce=ed,u.cf=pr,u.cg=ro,u.ch=nc,u.ci=R,u.cj=c1,u.ck=function(){var s=new Ni(4);return Ni!=Float32Array&&(s[1]=0,s[2]=0),s[0]=1,s[3]=1,s},u.cl=function(s,e,o){var c=e[0],d=e[1],m=e[2],g=e[3],x=Math.sin(o),w=Math.cos(o);return s[0]=c*w+m*x,s[1]=d*w+g*x,s[2]=c*-x+m*w,s[3]=d*-x+g*w,s},u.cm=function(s,e){return s[0]===e[0]&&s[1]===e[1]&&s[2]===e[2]&&s[3]===e[3]},u.cn=ps,u.co=function(s){return Math.hypot(s[0],s[1],s[2],s[3])},u.cp=Va,u.cq=Ea,u.cr=ma,u.cs=3,u.ct=2,u.cu=7,u.cv=6,u.cw=er,u.cx=jn,u.cy=In,u.cz=n0,u.d=function(s){return no.API_TILEJSON_REGEX.test(s)},u.d$=(s,e,o,c,d,m,g,x,w,T)=>{const C=s.transform,A=C.calculatePixelsToTileUnitsMatrix(e),M="none"===o.paint.get("line-trim-color-use-theme").constantOr("default"),k=C.pitch<15?Z_(.07,.7,se((14-C.zoom)/5,0,1)):.07;return{u_matrix:u0(s,e,o,c),u_pixels_to_tile_units:A,u_device_pixel_ratio:m,u_width_scale:g,u_floor_width_scale:x,u_units_to_pixels:[1/C.pixelsToGLUnits[0],1/C.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:d,u_texsize:IE(o)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:ea(e,s.transform),u_alpha_discard_threshold:0,u_trim_offset:w,u_trim_fade_range:o.paint.get("line-trim-fade-range"),u_trim_color:o.paint.get("line-trim-color").toPremultipliedRenderColor(M?null:o.lut).toArray01(),u_emissive_strength:o.paint.get("line-emissive-strength"),u_zbias_factor:k,u_tile_to_meter:ce(e.tileID.canonical,0),u_ground_shadow_factor:T}},u.d0=tc,u.d1=function(s,e,o){const c=Math.sqrt(s*s+e*e+o*o),d=c>0?Math.acos(o/c)*sf:0;let m=0!==s||0!==e?Math.atan2(-e,-s)*sf+90:0;return m<0&&(m+=360),[c,m,d]},u.d2=dr,u.d3=Pr,u.d4=ce,u.d5=Oi,u.d6=on,u.d7=to,u.d8=function(s){return[Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)]},u.d9=vd,u.dA=wm,u.dB=function(s){const e=le-5;s=se(s,-e,e)/e*90;const o=Math.pow(Math.abs(Math.sin(Pn(s))),3);return Math.round(o*(p.length-1))},u.dC=function(s,e,o,c){const d=e.getNorth(),m=e.getSouth(),g=e.getWest(),x=e.getEast(),w=1<<s.z,T=x-g,C=d-m,A=T/l,M=-C/p[o],k=[0,A,0,M,0,0,d,g,0];if(s.z>0){const F=180/c;As(k,k,[F/T+1,0,0,0,F/C+1,0,-.5*F/A,.5*F/M,1])}return k[2]=w,k[5]=s.x,k[8]=s.y,k},u.dD=Oa,u.dE=function(s,e,o){const c=fn(new Float64Array(16)),d=(e/(1<<s)-.5)*Math.PI*2;return Vs(c,o.globeMatrix,d),Float32Array.from(c)},u.dF=class{isDataAvailableAtPoint(s){const e=this._source();if(this.isUsingMockSource()||!e||s.y<0||s.y>1)return!1;const o=e.getSource().maxzoom,c=1<<o,d=Math.floor(s.x),m=Math.floor((s.x-d)*c),g=Math.floor(s.y*c),x=this.findDEMTileFor(new Tr(o,d,o,m,g));return!(!x||!x.dem)}getAtPointOrZero(s,e=0){return this.getAtPoint(s,e)||0}getAtPoint(s,e,o=!0){if(this.isUsingMockSource())return null;null==e&&(e=null);const c=this._source();if(!c||s.y<0||s.y>1)return e;const d=c.getSource().maxzoom,m=1<<d,g=Math.floor(s.x),x=s.x-g,w=new Tr(d,g,d,Math.floor(x*m),Math.floor(s.y*m)),T=this.findDEMTileFor(w);if(!T||!T.dem)return e;const C=T.dem,A=1<<T.tileID.canonical.z,M=(x*A-T.tileID.canonical.x)*C.dim,k=(s.y*A-T.tileID.canonical.y)*C.dim,F=Math.floor(M),V=Math.floor(k);return(o?this.exaggeration():1)*Ft(Ft(C.get(F,V),C.get(F,V+1),k-V),Ft(C.get(F+1,V),C.get(F+1,V+1),k-V),M-F)}getAtTileOffset(s,e,o){const c=1<<s.canonical.z;return this.getAtPointOrZero(new ue(s.wrap+(s.canonical.x+e/ht)/c,(s.canonical.y+o/ht)/c))}getAtTileOffsetFunc(s,e,o,c){return d=>{const m=this.getAtTileOffset(s,d.x,d.y),g=c.upVector(s.canonical,d.x,d.y);return Li(g,g,m*c.upVectorScale(s.canonical,e,o).metersToTile),g}}getForTilePoints(s,e,o,c){if(this.isUsingMockSource())return!1;const d=Gh.create(this,s,c);return!!d&&(e.forEach(m=>{m[2]=this.exaggeration()*d.getElevationAt(m[0],m[1],o)}),!0)}getMinMaxForTile(s){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(s);if(!e||!e.dem)return null;const o=e.dem.tree,c=e.tileID,d=1<<s.canonical.z-c.canonical.z;let m=s.canonical.x/d-c.canonical.x,g=s.canonical.y/d-c.canonical.y,x=0;for(let w=0;w<s.canonical.z-c.canonical.z&&!o.leaves[x];w++){m*=2,g*=2;const T=2*Math.floor(g)+Math.floor(m);x=o.childOffsets[x]+T,m%=1,g%=1}return{min:this.exaggeration()*o.minimums[x],max:this.exaggeration()*o.maximums[x]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(s,e,o){throw new Error("Pure virtual method called.")}pointCoordinate(s){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(s){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const s=this.visibleDemTiles;if(0===s.length)return null;let e=!1,o=Number.MAX_VALUE,c=Number.MIN_VALUE;for(const d of s){const m=this.getMinMaxForTile(d.tileID);m&&(o=Math.min(o,m.min),c=Math.max(c,m.max),e=!0)}return e?{min:o,max:c}:null}},u.dG=Zx,u.dH=cl,u.dI=function(s,e){return[Math.pow(s[0],2.2)*e,Math.pow(s[1],2.2)*e,Math.pow(s[2],2.2)*e]},u.dJ=Id,u.dK=function(s,e){var o=Math.sin(e),c=Math.cos(e);return s[0]=c,s[1]=o,s[2]=0,s[3]=-o,s[4]=c,s[5]=0,s[6]=0,s[7]=0,s[8]=1,s},u.dL=js,u.dM=Hf,u.dN=Bo,u.dO=ho,u.dP=256,u.dQ=function(s,e){const o=[0,0,0];return rr(o,o,Tm(Oa(e.canonical))),rr(o,o,s),o},u.dR=s=>({u_matrix:new nc(s),u_texsize:new ro(s),u_pixels_to_tile_units:new Vf(s),u_device_pixel_ratio:new pr(s),u_width_scale:new pr(s),u_floor_width_scale:new pr(s),u_image:new ph(s),u_units_to_pixels:new ro(s),u_tile_units_to_pixels:new pr(s),u_alpha_discard_threshold:new pr(s),u_trim_offset:new ro(s),u_trim_fade_range:new ro(s),u_trim_color:new tc(s),u_emissive_strength:new pr(s),u_zbias_factor:new pr(s),u_tile_to_meter:new pr(s),u_ground_shadow_factor:new ed(s),u_pattern_transition:new pr(s)}),u.dS=s=>({u_matrix:new nc(s),u_pixels_to_tile_units:new Vf(s),u_device_pixel_ratio:new pr(s),u_width_scale:new pr(s),u_floor_width_scale:new pr(s),u_units_to_pixels:new ro(s),u_dash_image:new ph(s),u_gradient_image:new ph(s),u_image_height:new pr(s),u_texsize:new ro(s),u_tile_units_to_pixels:new pr(s),u_alpha_discard_threshold:new pr(s),u_trim_offset:new ro(s),u_trim_fade_range:new ro(s),u_trim_color:new tc(s),u_emissive_strength:new pr(s),u_zbias_factor:new pr(s),u_tile_to_meter:new pr(s),u_ground_shadow_factor:new ed(s)}),u.dT=s=>({u_camera_to_center_distance:new pr(s),u_extrude_scale:new Vf(s),u_device_pixel_ratio:new pr(s),u_matrix:new nc(s),u_inv_rot_matrix:new nc(s),u_merc_center:new ro(s),u_tile_id:new ed(s),u_zoom_transition:new pr(s),u_up_dir:new ed(s),u_emissive_strength:new pr(s)}),u.dU=$c,u.dV=Vb,u.dW=Gx,u.dX=(s,e,o,c,d,m)=>{const g=s.transform,x="globe"===g.projection.name;let w;if("map"===m.paint.get("circle-pitch-alignment"))if(x){const C=Hf(g.zoom,e.canonical)*g._pixelsPerMercatorPixel;w=Float32Array.from([C,0,0,C])}else w=g.calculatePixelsToTileUnitsMatrix(o);else w=new Float32Array([g.pixelsToGLUnits[0],0,0,g.pixelsToGLUnits[1]]);const T={u_camera_to_center_distance:s.transform.getCameraToCenterDistance(g.projection),u_matrix:s.translatePosMatrix(e.projMatrix,o,m.paint.get("circle-translate"),m.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Us.devicePixelRatio,u_extrude_scale:w,u_inv_rot_matrix:Hx,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:m.paint.get("circle-emissive-strength")};if(x){T.u_inv_rot_matrix=c,T.u_merc_center=d,T.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],T.u_zoom_transition=eu(g.zoom);const C=d[0]*ht,A=d[1]*ht;T.u_up_dir=g.projection.upVector(new Ho(0,0,0),C,A)}return T},u.dY=Rb,u.dZ=po,u.d_=(s,e,o,c,d,m,g,x,w,T)=>{const C=s.transform,A=C.pitch<15?Z_(.07,.7,se((14-C.zoom)/5,0,1)):.07,M="none"===o.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:u0(s,e,o,c),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:C.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:d,u_width_scale:m,u_floor_width_scale:g,u_image:0,u_tile_units_to_pixels:ea(e,C),u_units_to_pixels:[1/C.pixelsToGLUnits[0],1/C.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:x,u_trim_fade_range:o.paint.get("line-trim-fade-range"),u_trim_color:o.paint.get("line-trim-color").toPremultipliedRenderColor(M?null:o.lut).toArray01(),u_emissive_strength:o.paint.get("line-emissive-strength"),u_zbias_factor:A,u_tile_to_meter:ce(e.tileID.canonical,0),u_ground_shadow_factor:w,u_pattern_transition:T}},u.da=function(s,e){return s.readFields(Dy,{icons:[]},e)},u.db=N_,u.dc=up,u.dd=E0,u.de=Lp,u.df=ua,u.dg=Hs,u.dh=Bd,u.di=pn,u.dj=function(s){const e=s.indexOf("\x1f");return e>=0?s.slice(0,e):s},u.dk=function(s){return s.indexOf("\x1f")>=0},u.dl=function(s){const e=s.lastIndexOf("\x1f");return e>=0?s.slice(e+1):""},u.dm=function(s){const e=[],o=s.id;return void 0===o&&e.push({message:`layers.${o}: missing required property "id"`}),void 0===s.render&&e.push({message:`layers.${o}: missing required method "render"`}),s.renderingMode&&"2d"!==s.renderingMode&&"3d"!==s.renderingMode&&e.push({message:`layers.${o}: property "renderingMode" must be either "2d" or "3d"`}),e},u.dn=function(s,e,o,c){return"custom"===s.type?new _p(s,e):new JE[s.type](s,e,o,c)},u.dp=bn,u.dq=function(s){const e=s.indexOf("\x1f");return e>=0?s.slice(e+1):""},u.dr=class extends Ep{constructor(s,e){super(s._vectorTileFeature,s._z,s._x,s._y,s.id),s.state&&(this.state=Object.assign({},s.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=s.source,this.sourceLayer=s.sourceLayer,this.layer=s.layer)}toJSON(){const s=super.toJSON();return s.target=this.target,s.namespace=this.namespace,s}},u.ds=Rf,u.dt=Au,u.du=function(s){return s({pluginStatus:vo,pluginURL:Zl}),Rf.on("pluginStateChange",s),s},u.dv=mh,u.dw=class extends Ns{constructor(s){super(s),this.current=vm}set(s,e,o){if(this.fetchUniformLocation(s,e))for(let c=0;c<9;c++)if(o[c]!==this.current[c]){this.current=o,this.gl.uniformMatrix3fv(this.location,!1,o);break}}},u.dx=X,u.dy=function(s,e,o){const c=eu(o.zoom),d=s.style.map._antialias,m=s.terrain&&s.terrain.exaggeration()>0;return 0===c&&!d&&!m},u.dz=function(s){const e=s.pixelsPerMeter,o=e/G(1,s.center.lat),c=fn(new Float64Array(16));return zo(c,c,[s.point.x,s.point.y,0]),eo(c,c,[o,o,e]),Float32Array.from(c)},u.e=no,u.e$=ar,u.e0=kt,u.e1=Cm,u.e2=ne,u.e3=Js,u.e4=iu,u.e5=ub,u.e6=Ih,u.e7=450,u.e8=7,u.e9=pe,u.eA=function(s,e,o,c,d,m,g,x,w,T,C,A,M,k,F,V){var j=new Ni(16);return j[0]=s,j[1]=e,j[2]=o,j[3]=c,j[4]=d,j[5]=m,j[6]=g,j[7]=x,j[8]=w,j[9]=T,j[10]=C,j[11]=A,j[12]=M,j[13]=k,j[14]=F,j[15]=V,j},u.eB=I,u.eC=dm,u.eD=fr,u.eE=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Je(1/0,1/0),max:new Je(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(s,e=!1){const o=ib(new Je(0,0),new Je(ht,ht),s),c=[];if(e&&!D_(o,this._globalClipBounds))return c;for(const d of this._activeRegions){if(d.hiddenByOverlap||!D_(o,d))continue;const m=aE(d.min,d.max,s);c.push({min:m.min,max:m.max,sourceId:this._sourceIds[d.priority],footprint:d.footprint,footprintTileId:d.tileId,order:d.order,clipMask:d.clipMask,clipScope:d.clipScope})}return c}setSources(s){this._setSources(s.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const o=[];for(const c of e.cache.getVisibleCoordinates()){const d=e.cache.getTile(c).buckets[e.layer];d&&d.updateFootprints(c.toUnwrapped(),o)}return o},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(s){const e=s.getFootprints();if(0===e.length)return;const o=s.getOrder(),c=s.getClipMask(),d=s.getClipScope();for(const m of e){if(!m.footprint)continue;const g=ib(m.footprint.min,m.footprint.max,m.id);this._activeRegions.push({min:g.min,max:g.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:m.id,footprint:m.footprint,order:o,clipMask:c,clipScope:d})}this._sourceIds.push(s.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,o)=>e.priority-o.priority||zv(e.min,o.min)||zv(e.max,o.max)||e.order-o.order||e.clipMask-o.clipMask||function(c,d){const m=(g,x)=>g+x;return c.length-d.length||c.reduce(m,"").localeCompare(d.reduce(m,""))}(e.clipScope,o.clipScope));let s=this._activeRegions.length!==this._prevRegions.length;if(!s){let e=0;for(;!s&&e!==this._activeRegions.length;){const o=this._activeRegions[e],c=this._prevRegions[e];s=o.priority!==c.priority||!sE(o,c)||o.order!==c.order||o.clipMask!==c.clipMask||!Ga(o.clipScope,c.clipScope),++e}}if(s){++this._updateTime;for(const o of this._activeRegions)o.order!==S_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,o.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,o.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,o.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,o.max.y));const e=o=>{const c=this._activeRegions;if(o>=c.length)return o;const d=c[o].priority;for(;o<c.length&&c[o].priority===d;)++o;return o};if(this._sourceIds.length>1){let o=0,c=e(o);for(;o!==c;){let d=o;const m=o;for(;d!==c;){const g=this._activeRegions[d];g.hiddenByOverlap=!1;for(let x=0;x<m;x++){const w=this._activeRegions[x];if(!w.hiddenByOverlap&&g.order===S_&&D_(g,w)&&(g.hiddenByOverlap=C_(g.footprint,g.tileId,w.footprint,w.tileId),g.hiddenByOverlap))break}++d}o=c,c=e(o)}}}}_setSources(s){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=s.length-1;e>=0;e--)this._addSource(s[e]);this._computeReplacement()}},u.eF=S_,u.eG=class{constructor(s){this._createGrid(s),this._createPoles(s)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const s of this._poleSegments)s.destroy();for(const s of this._gridSegments)s.withSkirts.destroy(),s.withoutSkirts.destroy()}_fillGridMeshWithLods(s,e){const o=new xs,c=new Mi,d=[],m=s+1+2,g=e[0]+1,x=e[0]+1+(1+e.length),w=(T,C,A)=>{let M=T===m-1?T-2:0===T?T:T-1;return M+=A?24575:0,[M,C]};for(let T=0;T<m;++T)o.emplaceBack(...w(T,0,!0));for(let T=0;T<g;++T)for(let C=0;C<m;++C)o.emplaceBack(...w(C,T,(0===C||C===m-1)&&!0));for(let T=0;T<e.length;++T){const C=e[T];for(let A=0;A<m;++A)o.emplaceBack(...w(A,C,!0))}for(let T=0;T<e.length;++T){const C=c.length,A=e[T]+1+2,M=new Mi;for(let V=0;V<A-1;V++){const j=V===A-2,W=j?m*(x-e.length+T-V):m;for(let Q=0;Q<m-1;Q++){const K=V*m+Q;0===V||j||0===Q||Q===m-2?(M.emplaceBack(K+1,K,K+W),M.emplaceBack(K+W,K+W+1,K+1)):(c.emplaceBack(K+1,K,K+W),c.emplaceBack(K+W,K+W+1,K+1))}}const k=Gi.simpleSegment(0,C,o.length,c.length-C);for(let V=0;V<M.uint16.length;V+=3)c.emplaceBack(M.uint16[V],M.uint16[V+1],M.uint16[V+2]);const F=Gi.simpleSegment(0,C,o.length,c.length-C);d.push({withoutSkirts:k,withSkirts:F})}return{vertices:o,indices:c,segments:d}}_createGrid(s){const e=this._fillGridMeshWithLods(l,p);this._gridSegments=e.segments,this._gridBuffer=s.createVertexBuffer(e.vertices,bm.members),this._gridIndexBuffer=s.createIndexBuffer(e.indices,!0)}_createPoles(s){const e=new Mi;for(let g=0;g<=l;g++)e.emplaceBack(0,g+1,g+2);this._poleIndexBuffer=s.createIndexBuffer(e,!0);const o=new Br,c=new Br,d=new Br,m=new Br;this._poleSegments=[];for(let g=0,x=0;g<Uf;g++){const w=360/(1<<g);o.emplaceBack(0,-Po,0,.5,0),c.emplaceBack(0,-Po,0,.5,1),d.emplaceBack(0,-Po,0,.5,.5),m.emplaceBack(0,-Po,0,.5,.5);for(let T=0;T<=l;T++){let C=T/l,A=0;const M=Ft(0,w,C),[k,F,V]=b(Ux,Gw,M,Po);o.emplaceBack(k,F,V,C,A),c.emplaceBack(k,F,V,C,1-A);const j=Pn(M);C=.5+.5*Math.sin(j),A=.5+.5*Math.cos(j),d.emplaceBack(k,F,V,C,A),m.emplaceBack(k,F,V,C,1-A)}this._poleSegments.push(Gi.simpleSegment(x,0,66,64)),x+=66}this._poleNorthVertexBuffer=s.createVertexBuffer(o,xm,!1),this._poleSouthVertexBuffer=s.createVertexBuffer(c,xm,!1),this._texturedPoleNorthVertexBuffer=s.createVertexBuffer(d,xm,!1),this._texturedPoleSouthVertexBuffer=s.createVertexBuffer(m,xm,!1)}getGridBuffers(s,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[s].withSkirts:this._gridSegments[s].withoutSkirts]}getPoleBuffers(s,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[s]]}},u.eH=rE,u.eI=oe,u.eJ=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},u.eK=ge,u.eL=ae,u.eM=function(s,e,o){return s[0]=e[0]/o[0],s[1]=e[1]/o[1],s[2]=e[2]/o[2],s},u.eN=Xo,u.eO=S,u.eP=rf,u.eQ=hr,u.eR=function([s,e,o]){const c=Math.hypot(s,e,o),d=Math.atan2(s,o),m=.5*Math.PI-Math.acos(-e/c);return new R(Pe(d),Pe(m))},u.eS=Ms,u.eT=Wm,u.eU=function(s){const e=s.navigator?s.navigator.userAgent:null;return!!function(o){if(null==ji){const c=o.navigator?o.navigator.userAgent:null;ji=!!o.safari||!(!c||!(/\b(iPad|iPhone|iPod)\b/.test(c)||c.match("Safari")&&!c.match("Chrome")))}return ji}(s)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},u.eV=function(s,e){oa=s,Di=e},u.eW=p_,u.eX=Vx,u.eY=function(s){const e=[0,0,0],o=fn(new Float64Array(16));return Bi(o,s.pixelMatrix,s.globeMatrix),rr(e,e,o),new Je(e[0],e[1])},u.eZ=function(){const s=Ch;s&&(s.isPreloaded()&&1===s.numActive()?(s.release(z_),Ch=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},u.e_=function(){N_().acquire(z_)},u.ea=function(s,e){if(s===e){var o=e[1],c=e[2],d=e[3],m=e[6],g=e[7],x=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=o,s[6]=e[9],s[7]=e[13],s[8]=c,s[9]=m,s[11]=e[14],s[12]=d,s[13]=g,s[14]=x}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s},u.eb=dg,u.ec=En,u.ed=Ku,u.ee=256,u.ef=Sm,u.eg=bs,u.eh=Vs,u.ei=function(s,e){return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],s},u.ej=Br,u.ek=rl,u.el=Qa,u.em=function(s,e,o,c,d){return se((s-e)/(o-e)*(d-c)+c,c,d)},u.en=Ml,u.eo=function(s,e){var o=e[0],c=e[1],d=e[2],m=e[3],g=e[4],x=e[5],w=e[6],T=e[7],C=e[8],A=C*g-x*T,M=-C*m+x*w,k=T*m-g*w,F=o*A+c*M+d*k;return F?(s[0]=A*(F=1/F),s[1]=(-C*c+d*T)*F,s[2]=(x*c-d*g)*F,s[3]=M*F,s[4]=(C*o-d*w)*F,s[5]=(-x*o+d*m)*F,s[6]=k*F,s[7]=(-T*o+c*w)*F,s[8]=(g*o-c*m)*F,s):null},u.ep=2,u.eq=Vi,u.er=_b,u.es=[1,1,1],u.et=class{constructor(s,e,o,c){this.context=s,this.format=c,this.size=o,this.texture=s.gl.createTexture();const[d,m,g]=this.size,{gl:x}=s;x.bindTexture(x.TEXTURE_3D,this.texture),s.pixelStoreUnpackFlipY.set(!1),s.pixelStoreUnpack.set(1),s.pixelStoreUnpackPremultiplyAlpha.set(!1),x.texImage3D(x.TEXTURE_3D,0,this.format,d,m,g,0,Gm(this.format),$m(this.format),e.data)}bind(s,e){const{context:o}=this,{gl:c}=o;c.bindTexture(c.TEXTURE_3D,this.texture),s!==this.minFilter&&(c.texParameteri(c.TEXTURE_3D,c.TEXTURE_MAG_FILTER,s),c.texParameteri(c.TEXTURE_3D,c.TEXTURE_MIN_FILTER,s),this.minFilter=s),e!==this.wrapS&&(c.texParameteri(c.TEXTURE_3D,c.TEXTURE_WRAP_S,e),c.texParameteri(c.TEXTURE_3D,c.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:s}=this.context;s.deleteTexture(this.texture),this.texture=null}},u.eu=Gh,u.ev=Ad,u.ew=function(s,e,o,c){var d=e[0],m=e[1],g=e[2],x=e[3];return s[0]=d+c*(o[0]-d),s[1]=m+c*(o[1]-m),s[2]=g+c*(o[2]-g),s[3]=x+c*(o[3]-x),s},u.ex=hd,u.ey=ha,u.ez=Jl,u.f=function(s){return btoa(encodeURIComponent(s).replace(/%([0-9A-F]{2})/g,(e,o)=>String.fromCharCode(+("0x"+o))))},u.f0=function(s,e,o=!1){if(vo===rs.deferred||vo===rs.loading||vo===rs.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");Zl=Us.resolveURL(s),vo=rs.deferred,im=e,Pf(),o||Of()},u.f1=function(s){ld=Us.resolveURL(s),Yf||(Yf=new Zf(N_(),new Mu)),Yf.broadcast("setMeshoptUrl",ld)},u.f2=fb,u.f3=function(s){dl=Us.resolveURL(s),Yf||(Yf=new Zf(N_(),new Mu)),Yf.broadcast("setDracoUrl",dl)},u.f4=hb,u.f5=Wf,u.f6=function(s){const e=yc();if(!e)return;const o=e.delete(Sa);s&&o.then(()=>s()).catch(s)},u.f7=sc,u.f8=wt,u.f9=ic,u.fa=pl,u.fb=yl,u.fc=vl,u.fd=cs,u.fe=vt,u.ff="hd_road_elevation",u.fg=Fi,u.fh=Wt,u.fi=Th,u.fj=b0,u.fk=Fh,u.fl=function(s,e,o,c,d,m,g,x=1,w,T,C){s.createArrays(),s.tilePixelRatio=ht/(512*s.overscaling),s.compareText={},s.iconsNeedLinear=!1;const A=s.layers[0].layout,M=s.layers[0]._unevaluatedLayout._values,k={};k.scaleFactor=x,k.textSizeScaleRange=A.get("text-size-scale-range"),k.iconSizeScaleRange=A.get("icon-size-scale-range");const[F,V]=k.textSizeScaleRange,[j,W]=k.iconSizeScaleRange;k.textScaleFactor=se(k.scaleFactor,F,V),k.iconScaleFactor=se(k.scaleFactor,j,W);const Q=M["text-size"],K=M["icon-size"];if("composite"===s.textSizeData.kind){const{minZoom:Ee,maxZoom:Ve}=s.textSizeData;k.compositeTextSizes=[Q.possiblyEvaluate(new Tn(Ee,{worldview:C}),m),Q.possiblyEvaluate(new Tn(Ve,{worldview:C}),m)]}if("composite"===s.iconSizeData.kind){const{minZoom:Ee,maxZoom:Ve}=s.iconSizeData;k.compositeIconSizes=[K.possiblyEvaluate(new Tn(Ee,{worldview:C}),m),K.possiblyEvaluate(new Tn(Ve,{worldview:C}),m)]}k.layoutTextSize=Q.possiblyEvaluate(new Tn(g+1,{worldview:C}),m),k.layoutIconSize=K.possiblyEvaluate(new Tn(g+1,{worldview:C}),m),k.textMaxSize=Q.possiblyEvaluate(new Tn(18,{worldview:C}),m);const te=A.get("symbol-placement"),me="map"===A.get("text-rotation-alignment")&&"point"!==te,he=A.get("text-size");let fe=!1;const xe=[];for(const Ee of s.features){const Ve=A.get("text-font").evaluate(Ee,{},m).join(","),Ie=he.evaluate(Ee,{},m)*k.textScaleFactor,Ue=k.layoutTextSize.evaluate(Ee,{},m)*k.textScaleFactor,ot=k.layoutIconSize.evaluate(Ee,{},m)*k.iconScaleFactor,$e={horizontal:{},vertical:void 0},Ke=Ee.text;let nt,Ne=[0,0];if(Ke){const xt=Ke.toString(),zt=A.get("text-letter-spacing").evaluate(Ee,{},m)*Sr,$t=A.get("text-line-height").evaluate(Ee,{},m)*Sr,nn=pv(xt)?zt:0,Xt=A.get("text-anchor").evaluate(Ee,{},m),vn=A.get("text-variable-anchor");if(!vn){const Fe=A.get("text-radial-offset").evaluate(Ee,{},m);if(Fe)Ne=T0(Xt,[Fe*Sr,ay]);else{const lt=A.get("text-offset").evaluate(Ee,{},m);Ne=[lt[0]*Sr,lt[1]*Sr]}}let dn=me?"center":A.get("text-justify").evaluate(Ee,{},m);const ni="point"===te,ie=ni?A.get("text-max-width").evaluate(Ee,{},m)*Sr:1/0,re=Fe=>{s.allowVerticalPlacement&&Cf(xt)&&($e.vertical=K_(Ke,e,o,d,Ve,ie,$t,Xt,Fe,nn,Ne,Ds.vertical,!0,Ue,Ie,w))};if(!me&&vn){const Fe="auto"===dn?vn.map(ut=>cy(ut)):[dn];let lt=!1;for(let ut=0;ut<Fe.length;ut++){const pt=Fe[ut];if(!$e.horizontal[pt])if(lt)$e.horizontal[pt]=$e.horizontal[0];else{const St=K_(Ke,e,o,d,Ve,ie,$t,"center",pt,nn,Ne,Ds.horizontal,!1,Ue,Ie,w);St&&($e.horizontal[pt]=St,lt=1===St.positionedLines.length)}}re("left")}else{if("auto"===dn&&(dn=cy(Xt)),ni||A.get("text-writing-mode").indexOf("horizontal")>=0||!Cf(xt)){const Fe=K_(Ke,e,o,d,Ve,ie,$t,Xt,dn,nn,Ne,Ds.horizontal,!1,Ue,Ie,w);Fe&&($e.horizontal[dn]=Fe)}re(ni?"left":dn)}}let Qe,Ce,Be,at,et,Ot,Tt=!1;const Xe=A.get("icon-text-fit").evaluate(Ee,{},m);if(Ee.icon&&Ee.icon.hasPrimary()){const xt=ly(Ee.icon,s.iconSizeData,M["icon-size"],m,s.zoom,Ee,w,k.iconScaleFactor,C);Qe=xt.iconPrimary,Be=xt.iconSecondary;const zt=Qe.toString();if(Ce=c.get(zt),Ce&&(et=A.get("icon-offset").evaluate(Ee,{},m),Ot=A.get("icon-anchor").evaluate(Ee,{},m),nt=Km(d.get(zt),Be?d.get(Be.toString()):void 0,et,Ot),Tt=Ce.sdf,void 0===s.sdfIcons?s.sdfIcons=Ce.sdf:s.sdfIcons!==Ce.sdf&&yn("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ce.pixelRatio!==s.pixelRatio||0!==A.get("icon-rotate").constantOr(1))&&(s.iconsNeedLinear=!0)),Be){const $t=Be.toString();at=c.get($t)}}fe=fe||!(!Ee.icon||!Ee.icon.hasSecondary());const tt=C0($e.horizontal)||$e.vertical;s.iconsInText||(s.iconsInText=!!tt&&tt.iconsInText);const Dt=Ue*k.textScaleFactor/Sr,{defaultShapedIcon:yt,verticallyShapedIcon:ft}=I0(s,nt,A,Ee,m,$e,Dt,et,Xe);"none"!==Xe&&nt&&(J_(nt)||ey(nt))&&(Jm(0,Ce,Qe,nt,yt,Xe,T,c,d),Jm(0,at,Be,nt,yt,Xe,T,c,d),ft&&(Jm(0,Ce,Qe,nt,ft,Xe,T,c,d),Jm(0,at,Be,nt,ft,Xe,T,c,d))),nt=yt,xe.push({feature:Ee,shapedTextOrientations:$e,shapedText:tt,shapedIcon:nt,iconPrimary:Qe,iconSecondary:Be,iconOffset:et,iconAnchor:Ot,verticallyShapedIcon:ft,layoutTextSize:Ue,layoutIconSize:ot,textOffset:Ne,isSDFIcon:Tt,iconTextFit:Xe})}return{featureData:xe,sizes:k,hasAnySecondaryIcon:fe,textAlongLine:me,symbolPlacement:te}},u.fm=Jb,u.fn=function(s,e,o,c,d,m,g,x,w,T){const{featureData:C,hasAnySecondaryIcon:A,sizes:M,textAlongLine:k,symbolPlacement:F}=e;for(const V of C){const{shapedIcon:j,verticallyShapedIcon:W,feature:Q,shapedTextOrientations:K,shapedText:te,layoutTextSize:me,textOffset:he,isSDFIcon:fe,iconPrimary:xe,iconSecondary:Ee,iconTextFit:Ve,iconOffset:Ie}=V;S0(j,T.iconPositions,xe,Ee),S0(W,T.iconPositions,xe,Ee),r1(K,T.iconPositions),zD(xe,Ee,T.iconPositions),(te||j)&&lu(s,Q,K,j,W,w,M,me,0,he,fe,c,d,g,x,A,Ve,Ie,k,F)}o&&s.generateCollisionDebugBuffers(m,s.collisionBoxArray,M.textScaleFactor)},u.fo=Ct,u.fp=_g,u.fq=Re,u.fr=function(s){let e=0;if(new Uint32Array(s,0,1)[0]!==gE){const o=new Uint32Array(s,0,7),[,,c,d,m,g]=o;e=o.byteLength+d+m+g+m,(c!==s.byteLength||e>=s.byteLength)&&yn("Invalid b3dm header information.")}return Rh(s,e)},u.fs=function(s,e){const o=ga(s);for(const c of o){for(const d of c.meshes)xE(d);c.lights&&(c.lightMeshIndex=c.meshes.length,c.meshes.push(bb(c.lights,e)))}return o},u.ft=wy,u.fu=li,u.fv=F_,u.fw=zs,u.fx=rs,u.fy=function(s){kl(),sr?.then(e=>{e.keys().then(o=>{for(let c=0;c<o.length-s;c++)e.delete(o[c]).catch(d=>yn(d.message))}).catch(o=>yn(o.message))}).catch(e=>yn(e.message))},u.g=function(s,e){return Au(Ae(s,{method:"GET"}),e)},u.h=Ae,u.i=function(s){return no.API_STYLE_REGEX.test(s)&&!af(s)},u.j=function(s){return 0===s.indexOf("mapbox:")},u.k=Rl,u.l=kd,u.m=function(s){return decodeURIComponent(atob(s).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},u.n=function(s,e){return Au(Ae(s,{type:"json"}),e)},u.o=sa,u.p=function(s,e){return Au(Ae(s,{method:"POST"}),e)},u.q=Us,u.r=jr,u.s=function(s){try{const e=self[s];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},u.t=gc,u.u=function(){return function s(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,s)}()},u.v=function(s){return!!s&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s)},u.w=yn,u.x=function(){return Xf||(Xf=new sc),Xf},u.y=Oy,u.z=_n}),Fg(0,function(u){function Ki(Pe){const Z=Pe?Pe.url.toString():void 0;return Z?performance.getEntriesByName(Z):[]}function Ni(Pe){if("number"==typeof Pe||"boolean"==typeof Pe||"string"==typeof Pe||null==Pe)return JSON.stringify(Pe);if(Array.isArray(Pe)){let X="[";for(const oe of Pe)X+=`${Ni(oe)},`;return`${X}]`}let Z="{";for(const X of Object.keys(Pe).sort())Z+=`${X}:${Ni(Pe[X])},`;return`${Z}}`}function xa(Pe){let Z="";for(const X of u.bu)Z+=`/${Ni(Pe[X])}`;return Z}class Id{constructor(Z){this.keyCache={},this._layers={},this._layerConfigs={},Z&&this.replace(Z)}replace(Z,X){this._layerConfigs={},this._layers={},this.update(Z,[],X)}update(Z,X,oe){this._options=oe;for(const se of Z)this._layerConfigs[se.id]=se,(this._layers[se.id]=u.dn(se,this.scope,null,this._options)).compileFilter(oe),this.keyCache[se.id]&&delete this.keyCache[se.id];for(const se of X)delete this.keyCache[se],delete this._layerConfigs[se],delete this._layers[se];this.familiesBySource={};const ge=function(se,be){const ke={};for(let Ae=0;Ae<se.length;Ae++){const st=se[Ae];let qe=be&&be[st.id];qe||("symbol"===st.type?qe=st.id:(qe=xa(st),"line"===st.type&&st.paint&&function Gt(Wt){return"string"==typeof Wt&&"line-progress"===Wt||(Array.isArray(Wt)?Wt.some(Gt):!(!Wt||"object"!=typeof Wt)&&Object.values(Wt).some(Gt))}(st.paint["line-width"])&&(qe+=`/${Ni(st.paint["line-width"])}`))),be&&(be[st.id]=qe);let kt=ke[qe];kt||(kt=ke[qe]=[]),kt.push(st)}const Te=[];for(const Ae in ke)Te.push(ke[Ae]);return Te}(Object.values(this._layerConfigs),this.keyCache);for(const se of ge){const be=se.map(kt=>this._layers[kt.id]),ke=be[0];if("none"===ke.visibility)continue;const Te=ke.source||"";let Ae=this.familiesBySource[Te];Ae||(Ae=this.familiesBySource[Te]={});const st=ke.sourceLayer||"_geojsonTileLayer";let qe=Ae[st];qe||(qe=Ae[st]=[]),qe.push(be)}}}const Cs=1*u.fa;class As{constructor(Z){const X={},oe=[];for(const ke in Z){const Te=Z[ke],Ae=X[ke]={};for(const st in Te.glyphs){const qe=Te.glyphs[+st];if(!qe||0===qe.bitmap.width||0===qe.bitmap.height)continue;const kt=qe.metrics.localGlyph?Cs:1,Gt={x:0,y:0,w:qe.bitmap.width+2*kt,h:qe.bitmap.height+2*kt};oe.push(Gt),Ae[st]=Gt}}const{w:ge,h:se}=u.H(oe),be=new u.f9({width:ge||1,height:se||1});for(const ke in Z){const Te=Z[ke];for(const Ae in Te.glyphs){const st=Te.glyphs[+Ae];if(!st||0===st.bitmap.width||0===st.bitmap.height)continue;const qe=X[ke][Ae],kt=st.metrics.localGlyph?Cs:1;u.f9.copy(st.bitmap,be,{x:0,y:0},{x:qe.x+kt,y:qe.y+kt},st.bitmap)}}this.image=be,this.positions=X}}u.f8(As,"GlyphAtlas");class Dl{constructor(Z){this.tileID=new u.aM(Z.tileID.overscaledZ,Z.tileID.wrap,Z.tileID.canonical.z,Z.tileID.canonical.x,Z.tileID.canonical.y),this.tileZoom=Z.tileZoom,this.uid=Z.uid,this.zoom=Z.zoom,this.lut=Z.lut,this.canonical=Z.tileID.canonical,this.pixelRatio=Z.pixelRatio,this.tileSize=Z.tileSize,this.source=Z.source,this.scope=Z.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=Z.showCollisionBoxes,this.collectResourceTiming=!!Z.request&&Z.request.collectResourceTiming,this.promoteId=Z.promoteId,this.isSymbolTile=Z.isSymbolTile,this.tileTransform=u.aW(Z.tileID.canonical,Z.projection),this.projection=Z.projection,this.worldview=Z.worldview,this.localizableLayerIds=Z.localizableLayerIds,this.brightness=Z.brightness,this.extraShadowCaster=!!Z.extraShadowCaster,this.tessellationStep=Z.tessellationStep,this.scaleFactor=Z.scaleFactor,this.worldview=Z.worldview}parse(Z,X,oe,ge,se,be){this.status="parsing",this.data=Z,this.collisionBoxArray=new u.b0;const ke=new u.fb(Object.keys(Z.layers).sort()),Te=new u.fc(this.tileID,this.promoteId);Te.bucketLayerIDs=[];const Ae={},st=new u.fd(256,256),qe={featureIndex:Te,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:st,availableImages:oe,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},kt=[],Gt=X.familiesBySource[this.source];for(const bn in Gt){const pn=Z.layers[bn];if(!pn)continue;let cn=!1,pi=!1,yn=!1;for(const li of Gt[bn])"symbol"===li[0].type?cn=!0:pi=!0,li[0].is3D()&&"model"!==li[0].type&&(yn=!0);if(this.extraShadowCaster&&!yn||!0===this.isSymbolTile&&!cn||!1===this.isSymbolTile&&!pi)continue;1===pn.version&&u.w(`Vector tile source "${this.source}" layer "${bn}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Qi=ke.encode(bn),wr=[];let Pr=!1;for(let li=0,Bn=0;li<pn.length;li++){const ji=pn.feature(li),Ui=Te.getId(ji,bn);if(this.localizableLayerIds&&this.localizableLayerIds.has(bn)){const Si=ji.properties?ji.properties.worldview:null;if(this.worldview&&"string"==typeof Si)if("all"===Si)ji.properties.$localized=!0;else{if(!Si.split(",").includes(this.worldview))continue;ji.properties.$localized=!0,ji.properties.worldview=this.worldview}}!Pr&&ji.properties&&ji.properties.hasOwnProperty(u.fe)&&(Pr=!0),wr.push({feature:ji,id:Ui,index:Bn,sourceLayerIndex:Qi}),Bn++}Pr&&!qe.elevationFeatures&&Z.layers.hasOwnProperty(u.ff)&&(qe.elevationFeatures=u.fg.parseFrom(Z.layers[u.ff],this.canonical));for(const li of Gt[bn]){const Bn=li[0];if(this.extraShadowCaster&&(!Bn.is3D()||"model"===Bn.type)||void 0!==this.isSymbolTile&&"symbol"===Bn.type!==this.isSymbolTile||Bn.minzoom&&this.zoom<Math.floor(Bn.minzoom)||Bn.maxzoom&&this.zoom>=Bn.maxzoom||"none"===Bn.visibility)continue;fn(li,this.zoom,qe.brightness,oe,this.worldview);const ji=Ae[Bn.id]=Bn.createBucket({index:Te.bucketLayerIDs.length,layers:li,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Qi,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:ge,worldview:this.worldview});Te.bucketLayerIDs.push(li.map(Si=>u.C(Si.id,Si.scope)));let Ui=ji.prepare?ji.prepare():null;null!=Ui?(Ui=Ui.then(()=>ji.populate(wr,qe,this.tileID.canonical,this.tileTransform)),kt.push(Ui)):ji.populate(wr,qe,this.tileID.canonical,this.tileTransform)}}const Wt=()=>{let bn,pn,cn,pi,yn,Qi;st.trim();const wr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Pr=()=>{if(bn)return this.status="done",be(bn);if(this.extraShadowCaster)this.status="done",be(null,{buckets:Object.values(Ae).filter(Bn=>!Bn.isEmpty()),featureIndex:Te,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:qe.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(pn&&cn&&pi){const Bn=new As(pn),ji=new Map;for(const[$r,Bo]of cn.entries()){const{imagePosition:ho}=u.fj($r,Bo,u.fk);ji.set($r,ho)}const Ui={};for(const $r in Ae){const Bo=Ae[$r];Bo instanceof u.b1&&(fn(Bo.layers,this.zoom,qe.brightness,oe,this.worldview),Ui[$r]=u.fl(Bo,pn,Bn.positions,cn,ji,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,yn,this.worldview))}const Si={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(se,cn,yn,()=>{Si.iconsPending=!1,li(Ui,Bn,Si)}),this.rasterizeIfNeeded(se,pi,Qi,()=>{Si.patternsPending=!1,li(Ui,Bn,Si)})}},li=(Bn,ji,Ui,Si)=>{if(Ui.iconsPending||Ui.patternsPending)return;const $r=new u.fm(cn,pi,this.lut);for(const Bo in Ae){const ho=Ae[Bo];if(Bo in Bn)u.fn(ho,Bn[Bo],this.showCollisionBoxes,oe,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,cn,$r);else if(ho.hasPattern&&(ho instanceof u.b7||ho instanceof u.b8||ho instanceof u.e4)){fn(ho.layers,this.zoom,qe.brightness,oe,this.worldview);const Od=Object.fromEntries($r.patternPositions);ho.addFeatures(qe,this.tileID.canonical,Od,oe,this.tileTransform,this.brightness)}}this.status="done",be(null,{buckets:Object.values(Ae).filter(Bo=>!Bo.isEmpty()),featureIndex:Te,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:ji.image,lineAtlas:st,imageAtlas:$r,brightness:qe.brightness})};if(!this.extraShadowCaster){const Bn=u.fh(qe.glyphDependencies,Si=>Object.keys(Si).map(Number));Object.keys(Bn).length?se.send("getGlyphs",{uid:this.uid,stacks:Bn},(Si,$r)=>{bn||(bn=Si,pn=$r,Pr())},void 0,!1,wr):pn={};const ji=Array.from(qe.iconDependencies.keys()).map(Si=>u.I.parse(Si));ji.length?se.send("getImages",{images:ji,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Si,$r)=>{bn||(bn=Si,cn=new Map,yn=this.updateImageMapAndGetImageTaskQueue(cn,$r,qe.iconDependencies),Pr())},void 0,!1,wr):(cn=new Map,yn=new Map);const Ui=Array.from(qe.patternDependencies.keys()).map(Si=>u.I.parse(Si));Ui.length?se.send("getImages",{images:Ui,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Si,$r)=>{bn||(bn=Si,pi=new Map,Qi=this.updateImageMapAndGetImageTaskQueue(pi,$r,qe.patternDependencies),Pr())},void 0,!1,wr):(pi=new Map,Qi=new Map)}if(qe.elevationFeatures&&qe.elevationFeatures.length>0){const Bn=[];for(const Ui of Object.values(Ae))if(Ui instanceof u.b8){const Si=Ui.getUnevaluatedPortalGraph();Si&&Bn.push(Si)}const ji=u.fi.evaluate(Bn);for(const Ui of Object.values(Ae))if(Ui instanceof u.b8){const Si=Z.layers[ke.decode(Ui.sourceLayerIndex)];Ui.setEvaluatedPortalGraph(ji,Si,this.tileID.canonical,qe.availableImages,qe.brightness)}}Pr()};kt.length>0?Promise.allSettled(kt).then(Wt).catch(be):Wt()}rasterizeIfNeeded(Z,X,oe,ge){Array.from(X.values()).some(se=>se.usvg)?this.rasterize(Z,X,oe,ge):ge()}updateImageMapAndGetImageTaskQueue(Z,X,oe){const ge=new Map;for(const se of X.keys()){const be=oe.get(se)||[];for(const ke of be){const Te=ke.toString(),Ae=X.get(ke.id.toString());Ae.usvg?ge.has(Te)||(ge.set(Te,ke),Z.set(Te,Object.assign({},Ae))):Z.set(Te,Ae)}}return ge}rasterize(Z,X,oe,ge){this.rasterizeTask=Z.send("rasterizeImages",{scope:this.scope,tasks:oe},(se,be)=>{if(!se)for(const[ke,Te]of be.entries()){const Ae=Object.assign(X.get(ke),{data:Te});X.set(ke,Ae)}ge()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function fn(Pe,Z,X,oe,ge){const se=new u.aa(Z,{brightness:X,worldview:ge});for(const be of Pe)be.recalculate(se,oe)}class Zo extends u.E{constructor(Z,X,oe,ge,se,be,ke){super(),this.actor=Z,this.layerIndex=X,this.availableImages=oe,this.availableModels=ge,this.loadVectorData=be||u.aJ,this.loading={},this.loaded={},this.deduped=new u.aI(Z.scheduler),this.isSpriteLoaded=se,this.scheduler=Z.scheduler,this.brightness=ke}loadTile(Z,X){const oe=Z.uid,ge=Z&&Z.request,se=ge&&ge.collectResourceTiming,be=this.loading[oe]=new Dl(Z);be.abort=this.loadVectorData(Z,(ke,Te)=>{const Ae=!this.loading[oe];if(delete this.loading[oe],be.cancelRasterize(),Ae||ke||!Te)return be.status="done",Ae||(this.loaded[oe]=be),X(ke);const st=Te.rawData,qe={};Te.expires&&(qe.expires=Te.expires),Te.cacheControl&&(qe.cacheControl=Te.cacheControl),be.vectorTile=Te.vectorTile||new u.fo(new u.bq(st));const kt=()=>{be.parse(be.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Gt,Wt)=>{if(Gt||!Wt)return X(Gt);const bn={};if(se){const pn=Ki(ge);pn.length>0&&(bn.resourceTiming=JSON.parse(JSON.stringify(pn)))}X(null,u.h({rawTileData:st.slice(0)},Wt,qe,bn))})};this.isSpriteLoaded?kt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(kt,{type:"parseTile",isSymbolTile:Z.isSymbolTile,zoom:Z.tileZoom}):kt()}),this.loaded=this.loaded||{},this.loaded[oe]=be})}reloadTile(Z,X){const oe=this.loaded,ge=Z.uid;if(oe&&oe[ge]){const se=oe[ge];se.scaleFactor=Z.scaleFactor,se.showCollisionBoxes=Z.showCollisionBoxes,se.projection=Z.projection,se.brightness=Z.brightness,se.tileTransform=u.aW(Z.tileID.canonical,Z.projection),se.extraShadowCaster=Z.extraShadowCaster,se.lut=Z.lut,se.worldview=Z.worldview;const be=(ke,Te)=>{const Ae=se.reloadCallback;Ae&&(delete se.reloadCallback,se.parse(se.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ae)),X(ke,Te)};"parsing"===se.status?se.reloadCallback=be:"done"===se.status&&(se.vectorTile?se.parse(se.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,be):be())}else X(null,void 0)}abortTile(Z,X){const oe=Z.uid,ge=this.loading[oe];ge&&(ge.abort&&ge.abort(),delete this.loading[oe]),X()}removeTile(Z,X){const oe=this.loaded,ge=Z.uid;oe&&oe[ge]&&delete oe[ge],X()}}class Bi{loadTile(Z,X){const{uid:oe,encoding:ge,rawImageData:se,padding:be}=Z,ke=ImageBitmap&&se instanceof ImageBitmap?this.getImageData(se,be):se;X(null,new u.fp(oe,ke,ge,be<1))}reloadTile(Z,X){X(null,null)}abortTile(Z,X){X()}removeTile(Z,X){X()}getImageData(Z,X){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(Z.width,Z.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=Z.width,this.offscreenCanvas.height=Z.height,this.offscreenCanvasContext.drawImage(Z,0,0,Z.width,Z.height);const oe=this.offscreenCanvasContext.getImageData(-X,-X,Z.width+2*X,Z.height+2*X);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),oe}}u.bp.setPbf(u.bq);class zo{constructor(Z){this._mrt=new u.bp(Z.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=Z.uid,this.tileID=Z.tileID,this.source=Z.source}parse(Z,X){const oe=this._mrt;this.status="parsing",this._entireBuffer=Z;try{oe.parseHeader(Z),this._isHeaderLoaded=!0;const ge=[];for(const se in oe.layers){const be=oe.getLayer(se),ke=be.getDataRange(be.getBandList()),Te=oe.createDecodingTask(ke),Ae=Z.slice(ke.firstByte,ke.lastByte+1),st=u.bp.performDecoding(Ae,Te).then(qe=>Te.complete(null,qe)).catch(qe=>Te.complete(qe,null));ge.push(st)}Promise.allSettled(ge).then(()=>X(null,oe)).catch(se=>X(se))}catch(ge){X(ge)}}}class eo{constructor(Z){this.actor=Z,this.loading={},this.loaded={}}loadTile(Z,X){const oe=Z.uid,ge=Z.request,se=this.loading[oe]=new zo(Z),{cancel:be}=u.br(ge,(ke,Te,Ae,st)=>{const qe=!this.loading[oe];if(delete this.loading[oe],qe||ke||!Te)return se.status="done",qe||(this.loaded[oe]=se),X(ke);se.parse(Te,(kt,Gt)=>{if(kt||!Gt)return X(kt);X(null,Gt,Ae,st)}),this.loaded[oe]=se});se.abort=be}reloadTile(Z,X){X(null,void 0)}abortTile(Z,X){const oe=Z.uid,ge=this.loading[oe];ge&&(ge.abort&&ge.abort(),delete this.loading[oe]),X()}removeTile(Z,X){const oe=Z.uid;this.loaded[oe]&&delete this.loaded[oe],X()}decodeRasterArray(Z,X){u.bp.performDecoding(Z.buffer,Z.task).then(oe=>X(null,oe)).catch(oe=>X(oe))}}const fs=u.fq.prototype.toGeoJSON;class Vs{constructor(Z){this._feature=Z,this.extent=u.aj,this.type=Z.type,this.properties=Z.tags,"id"in Z&&!isNaN(Z.id)&&(this.id=parseInt(Z.id,10))}loadGeometry(){if(1===this._feature.type){const Z=[];for(const X of this._feature.geometry)Z.push([new u.P(X[0],X[1])]);return Z}{const Z=[];for(const X of this._feature.geometry){const oe=[];for(const ge of X)oe.push(new u.P(ge[0],ge[1]));Z.push(oe)}return Z}}toGeoJSON(Z,X,oe){return fs.call(this,Z,X,oe)}}class Il{constructor(Z,X){this.name=Z,this.extent=u.aj,this.length=X.length,this._jsonFeatures=X}feature(Z){return new Vs(this._jsonFeatures[Z])}}class Cl{constructor(Z){this.layers={},this.extent=u.aj;for(const X of Object.keys(Z))this.layers[X]=new Il(X,Z[X])}}const ra=64/4096,ba=128;class tf{constructor(){this.features=new Map}clear(){this.features.clear()}load(Z=[],X){for(const oe of Z){const ge=oe.id;if(null==ge)continue;let se=this.features.get(ge);se&&this.updateCache(se,X),oe.geometry?(se=za(oe),this.updateCache(se,X),this.features.set(ge,se)):this.features.delete(ge),this.updateCache(se,X)}}updateCache(Z,X){for(const{canonical:oe,uid:ge}of Object.values(X)){const{z:se,x:be,y:ke}=oe;jn(Z,Math.pow(2,se),be,ke)&&delete X[ge]}}getTile(Z,X,oe){const ge=Math.pow(2,Z),se=[];for(const be of this.features.values())jn(be,ge,X,oe)&&se.push(Oi(be,ge,X,oe));return{features:se}}getFeatures(){return[...this.features.values()]}}function jn({minX:Pe,minY:Z,maxX:X,maxY:oe},ge,se,be){return Pe<(se+1+ra)/ge&&Z<(be+1+ra)/ge&&X>(se-ra)/ge&&oe>(be-ra)/ge}function za(Pe){const{id:Z,geometry:X,properties:oe}=Pe;if(!X)return;if("GeometryCollection"===X.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:ge,coordinates:se}=X,be={id:Z,type:1,geometry:[],tags:oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},ke=be.geometry;if("Point"===ge)uo(se,ke,be);else if("MultiPoint"===ge)for(const Te of se)uo(Te,ke,be);else if("LineString"===ge)be.type=2,dr(se,ke,be);else if("MultiLineString"===ge)be.type=2,hr(se,ke,be);else if("Polygon"===ge)be.type=3,hr(se,ke,be,!0);else{if("MultiPolygon"!==ge)throw new Error("Input data is not a valid GeoJSON object.");be.type=3;for(const Te of se)hr(Te,ke,be,!0)}return be}function uo([Pe,Z],X,oe){const ge=u.aD(Pe);let se=u.aH(Z);se=se<0?0:se>1?1:se,X.push(ge,se),oe.minX=Math.min(oe.minX,ge),oe.minY=Math.min(oe.minY,se),oe.maxX=Math.max(oe.maxX,ge),oe.maxY=Math.max(oe.maxY,se)}function dr(Pe,Z,X,oe=!1,ge=!1){const se=[];for(const be of Pe)uo(be,se,X);Z.push(se),oe&&function(be,ke){let Te=0;for(let Ae=0,st=be.length,qe=st-2;Ae<st;qe=Ae,Ae+=2)Te+=(be[Ae]-be[qe])*(be[Ae+1]+be[qe+1]);if(Te>0===ke)for(let Ae=0,st=be.length;Ae<st/2;Ae+=2){const qe=be[Ae],kt=be[Ae+1];be[Ae]=be[st-2-Ae],be[Ae+1]=be[st-1-Ae],be[st-2-Ae]=qe,be[st-1-Ae]=kt}}(se,ge)}function hr(Pe,Z,X,oe=!1){for(let ge=0;ge<Pe.length;ge++)dr(Pe[ge],Z,X,oe,0===ge)}function Oi(Pe,Z,X,oe){const{id:ge,type:se,geometry:be,tags:ke}=Pe,Te=[];if(1===se)!function(Ae,st,qe,kt,Gt){for(let Wt=0;Wt<Ae.length;Wt+=2){const bn=Math.round(u.aj*(Ae[Wt+0]*st-qe)),pn=Math.round(u.aj*(Ae[Wt+1]*st-kt));Gt.push([bn,pn])}}(be,Z,X,oe,Te);else for(const Ae of be)to(Ae,Z,X,oe,Te);return{id:ge,type:se,geometry:Te,tags:ke}}function to(Pe,Z,X,oe,ge){const se=-ba,be=u.aj+ba;let ke;for(let Te=0;Te<Pe.length-2;Te+=2){let Ae=Math.round(u.aj*(Pe[Te+0]*Z-X)),st=Math.round(u.aj*(Pe[Te+1]*Z-oe)),qe=Math.round(u.aj*(Pe[Te+2]*Z-X)),kt=Math.round(u.aj*(Pe[Te+3]*Z-oe));const Gt=qe-Ae,Wt=kt-st;Ae<se&&qe<se||(Ae<se?(st+=Math.round(Wt*((se-Ae)/Gt)),Ae=se):qe<se&&(kt=st+Math.round(Wt*((se-Ae)/Gt)),qe=se),st<se&&kt<se||(st<se?(Ae+=Math.round(Gt*((se-st)/Wt)),st=se):kt<se&&(qe=Ae+Math.round(Gt*((se-st)/Wt)),kt=se),Ae>=be&&qe>=be||(Ae>=be?(st+=Math.round(Wt*((be-Ae)/Gt)),Ae=be):qe>=be&&(kt=st+Math.round(Wt*((be-Ae)/Gt)),qe=be),st>=be&&kt>=be||(st>=be?(Ae+=Math.round(Gt*((be-st)/Wt)),st=be):kt>=be&&(qe=Ae+Math.round(Gt*((be-st)/Wt)),kt=be),ke&&Ae===ke[ke.length-1][0]&&st===ke[ke.length-1][1]||(ke=[[Ae,st]],ge.push(ke)),ke.push([qe,kt])))))}}function nf({name:Pe,features:Z},X){X.writeStringField(1,Pe),X.writeVarintField(5,u.aj);const oe=new Map,ge=new Map,se={keys:oe,values:ge,feature:null};for(const be of Z)se.feature=be,X.writeMessage(2,wa,se);for(const be of oe.keys())X.writeStringField(3,be);for(const be of ge.keys())X.writeMessage(4,rf,be)}function wa(Pe,Z){const X=Pe.feature;void 0===X.id||isNaN(+X.id)||Z.writeVarintField(1,+X.id),X.tags&&Z.writeMessage(2,qi,Pe),Z.writeVarintField(3,X.type),Z.writeMessage(4,xu,X)}function qi({keys:Pe,values:Z,feature:X},oe){for(const ge of Object.keys(X.tags)){let se=X.tags[ge];if(null===se)continue;let be=Pe.get(ge);void 0===be&&(be=Pe.size,Pe.set(ge,be)),oe.writeVarint(be);const ke=typeof se;"string"!==ke&&"boolean"!==ke&&"number"!==ke&&(se=JSON.stringify(se));let Te=Z.get(se);void 0===Te&&(Te=Z.size,Z.set(se,Te)),oe.writeVarint(Te)}}function Li(Pe,Z){return(Z<<3)+(7&Pe)}function No(Pe){return Pe<<1^Pe>>31}function xu(Pe,Z){const{geometry:X,type:oe}=Pe;let ge=0,se=0;if(1===oe){Z.writeVarint(Li(1,X.length));for(const be of X){const ke=be[0]-ge,Te=be[1]-se;Z.writeVarint(No(ke)),Z.writeVarint(No(Te)),ge+=ke,se+=Te}}else for(const be of X){Z.writeVarint(Li(1,1));const ke=be.length-(3===oe?1:0);for(let Te=0;Te<ke;Te++){1===Te&&Z.writeVarint(Li(2,ke-1));const Ae=be[Te][0]-ge,st=be[Te][1]-se;Z.writeVarint(No(Ae)),Z.writeVarint(No(st)),ge+=Ae,se+=st}3===oe&&Z.writeVarint(Li(7,1))}}function rf(Pe,Z){const X=typeof Pe;"string"===X?Z.writeStringField(1,Pe):"boolean"===X?Z.writeBooleanField(7,Pe):"number"===X&&(Pe%1!=0?Z.writeDoubleField(3,Pe):Pe<0?Z.writeSVarintField(6,Pe):Z.writeVarintField(5,Pe))}const Vi={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Pe=>Pe},Ai=Math.fround||(ir=new Float32Array(1),Pe=>(ir[0]=+Pe,ir[0]));var ir;const yi=3,er=5,rr=6;class js{constructor(Z){this.options=Object.assign(Object.create(Vi),Z),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(Z){const{log:X,minZoom:oe,maxZoom:ge}=this.options;X&&console.time("total time");const se=`prepare ${Z.length} points`;X&&console.time(se),this.points=Z;const be=[];for(let Te=0;Te<Z.length;Te++){const Ae=Z[Te];if(!Ae.geometry)continue;const[st,qe]=Ae.geometry.coordinates,kt=Ai(ps(st)),Gt=Ai(or(qe));be.push(kt,Gt,1/0,Te,-1,1),this.options.reduce&&be.push(0)}let ke=this.trees[ge+1]=this._createTree(be);X&&console.timeEnd(se);for(let Te=ge;Te>=oe;Te--){const Ae=+Date.now();ke=this.trees[Te]=this._createTree(this._cluster(ke,Te)),X&&console.log("z%d: %d clusters in %dms",Te,ke.numItems,+Date.now()-Ae)}return X&&console.timeEnd("total time"),this}getClusters(Z,X){let oe=((Z[0]+180)%360+360)%360-180;const ge=Math.max(-90,Math.min(90,Z[1]));let se=180===Z[2]?180:((Z[2]+180)%360+360)%360-180;const be=Math.max(-90,Math.min(90,Z[3]));if(Z[2]-Z[0]>=360)oe=-180,se=180;else if(oe>se){const qe=this.getClusters([oe,ge,180,be],X),kt=this.getClusters([-180,ge,se,be],X);return qe.concat(kt)}const ke=this.trees[this._limitZoom(X)],Te=ke.range(ps(oe),or(be),ps(se),or(ge)),Ae=ke.data,st=[];for(const qe of Te){const kt=this.stride*qe;st.push(Ae[kt+er]>1?Ea(Ae,kt,this.clusterProps):this.points[Ae[kt+yi]])}return st}getChildren(Z){const X=this._getOriginId(Z),oe=this._getOriginZoom(Z),ge="No cluster with the specified id.",se=this.trees[oe];if(!se)throw new Error(ge);const be=se.data;if(X*this.stride>=be.length)throw new Error(ge);const ke=this.options.radius/(this.options.extent*Math.pow(2,oe-1)),Te=se.within(be[X*this.stride],be[X*this.stride+1],ke),Ae=[];for(const st of Te){const qe=st*this.stride;be[qe+4]===Z&&Ae.push(be[qe+er]>1?Ea(be,qe,this.clusterProps):this.points[be[qe+yi]])}if(0===Ae.length)throw new Error(ge);return Ae}getLeaves(Z,X,oe){const ge=[];return this._appendLeaves(ge,Z,X=X||10,oe=oe||0,0),ge}getTile(Z,X,oe){const ge=this.trees[this._limitZoom(Z)],se=Math.pow(2,Z),{extent:be,radius:ke}=this.options,Te=ke/be,Ae=(oe-Te)/se,st=(oe+1+Te)/se,qe={features:[]};return this._addTileFeatures(ge.range((X-Te)/se,Ae,(X+1+Te)/se,st),ge.data,X,oe,se,qe),0===X&&this._addTileFeatures(ge.range(1-Te/se,Ae,1,st),ge.data,se,oe,se,qe),X===se-1&&this._addTileFeatures(ge.range(0,Ae,Te/se,st),ge.data,-1,oe,se,qe),qe.features.length?qe:null}getClusterExpansionZoom(Z){let X=this._getOriginZoom(Z)-1;for(;X<=this.options.maxZoom;){const oe=this.getChildren(Z);if(X++,1!==oe.length)break;Z=oe[0].properties.cluster_id}return X}_appendLeaves(Z,X,oe,ge,se){const be=this.getChildren(X);for(const ke of be){const Te=ke.properties;if(Te&&Te.cluster?se+Te.point_count<=ge?se+=Te.point_count:se=this._appendLeaves(Z,Te.cluster_id,oe,ge,se):se<ge?se++:Z.push(ke),Z.length===oe)break}return se}_createTree(Z){const X=new u.c0(Z.length/this.stride|0,this.options.nodeSize,Float32Array);for(let oe=0;oe<Z.length;oe+=this.stride)X.add(Z[oe],Z[oe+1]);return X.finish(),X.data=Z,X}_addTileFeatures(Z,X,oe,ge,se,be){for(const ke of Z){const Te=ke*this.stride,Ae=X[Te+er]>1;let st,qe,kt;if(Ae)st=Cd(X,Te,this.clusterProps),qe=X[Te],kt=X[Te+1];else{const bn=this.points[X[Te+yi]];st=bn.properties;const[pn,cn]=bn.geometry.coordinates;qe=ps(pn),kt=or(cn)}const Gt={type:1,geometry:[[Math.round(this.options.extent*(qe*se-oe)),Math.round(this.options.extent*(kt*se-ge))]],tags:st};let Wt;Wt=Ae||this.options.generateId?X[Te+yi]:this.points[X[Te+yi]].id,void 0!==Wt&&(Gt.id=Wt),be.features.push(Gt)}}_limitZoom(Z){return Math.max(this.options.minZoom,Math.min(Math.floor(+Z),this.options.maxZoom+1))}_cluster(Z,X){const{radius:oe,extent:ge,reduce:se,minPoints:be}=this.options,ke=oe/(ge*Math.pow(2,X)),Te=Z.data,Ae=[],st=this.stride;for(let qe=0;qe<Te.length;qe+=st){if(Te[qe+2]<=X)continue;Te[qe+2]=X;const kt=Te[qe],Gt=Te[qe+1],Wt=Z.within(Te[qe],Te[qe+1],ke),bn=Te[qe+er];let pn=bn;for(const cn of Wt){const pi=cn*st;Te[pi+2]>X&&(pn+=Te[pi+er])}if(pn>bn&&pn>=be){let cn,pi=kt*bn,yn=Gt*bn,Qi=-1;const wr=(qe/st<<5)+(X+1)+this.points.length;for(const Pr of Wt){const li=Pr*st;if(Te[li+2]<=X)continue;Te[li+2]=X;const Bn=Te[li+er];pi+=Te[li]*Bn,yn+=Te[li+1]*Bn,Te[li+4]=wr,se&&(cn||(cn=this._map(Te,qe,!0),Qi=this.clusterProps.length,this.clusterProps.push(cn)),se(cn,this._map(Te,li)))}Te[qe+4]=wr,Ae.push(pi/pn,yn/pn,1/0,wr,-1,pn),se&&Ae.push(Qi)}else{for(let cn=0;cn<st;cn++)Ae.push(Te[qe+cn]);if(pn>1)for(const cn of Wt){const pi=cn*st;if(!(Te[pi+2]<=X)){Te[pi+2]=X;for(let yn=0;yn<st;yn++)Ae.push(Te[pi+yn])}}}}return Ae}_getOriginId(Z){return Z-this.points.length>>5}_getOriginZoom(Z){return(Z-this.points.length)%32}_map(Z,X,oe){if(Z[X+er]>1){const be=this.clusterProps[Z[X+rr]];return oe?Object.assign({},be):be}const ge=this.points[Z[X+yi]].properties,se=this.options.map(ge);return oe&&se===ge?Object.assign({},se):se}}function Ea(Pe,Z,X){return{type:"Feature",id:Pe[Z+yi],properties:Cd(Pe,Z,X),geometry:{type:"Point",coordinates:[(oe=Pe[Z],360*(oe-.5)),Xo(Pe[Z+1])]}};var oe}function Cd(Pe,Z,X){const oe=Pe[Z+er],ge=oe>=1e4?`${Math.round(oe/1e3)}k`:oe>=1e3?Math.round(oe/100)/10+"k":oe,se=Pe[Z+rr],be=-1===se?{}:Object.assign({},X[se]);return Object.assign(be,{cluster:!0,cluster_id:Pe[Z+yi],point_count:oe,point_count_abbreviated:ge})}function ps(Pe){return Pe/360+.5}function or(Pe){const Z=Math.sin(Pe*Math.PI/180),X=.5-.25*Math.log((1+Z)/(1-Z))/Math.PI;return X<0?0:X>1?1:X}function Xo(Pe){const Z=(180-360*Pe)*Math.PI/180;return 360*Math.atan(Math.exp(Z))/Math.PI-90}function Al(Pe,Z,X,oe){let ge=oe;const se=Z+(X-Z>>1);let be,ke=X-Z;const Te=Pe[Z],Ae=Pe[Z+1],st=Pe[X],qe=Pe[X+1];for(let kt=Z+3;kt<X;kt+=3){const Gt=Ad(Pe[kt],Pe[kt+1],Te,Ae,st,qe);if(Gt>ge)be=kt,ge=Gt;else if(Gt===ge){const Wt=Math.abs(kt-se);Wt<ke&&(be=kt,ke=Wt)}}ge>oe&&(be-Z>3&&Al(Pe,Z,be,oe),Pe[be+2]=ge,X-be>3&&Al(Pe,be,X,oe))}function Ad(Pe,Z,X,oe,ge,se){let be=ge-X,ke=se-oe;if(0!==be||0!==ke){const Te=((Pe-X)*be+(Z-oe)*ke)/(be*be+ke*ke);Te>1?(X=ge,oe=se):Te>0&&(X+=be*Te,oe+=ke*Te)}return be=Pe-X,ke=Z-oe,be*be+ke*ke}function Na(Pe,Z,X,oe){const ge={id:Pe??null,type:Z,geometry:X,tags:oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===Z||"MultiPoint"===Z||"LineString"===Z)Ms(ge,X);else if("Polygon"===Z)Ms(ge,X[0]);else if("MultiLineString"===Z)for(const se of X)Ms(ge,se);else if("MultiPolygon"===Z)for(const se of X)Ms(ge,se[0]);return ge}function Ms(Pe,Z){for(let X=0;X<Z.length;X+=3)Pe.minX=Math.min(Pe.minX,Z[X]),Pe.minY=Math.min(Pe.minY,Z[X+1]),Pe.maxX=Math.max(Pe.maxX,Z[X]),Pe.maxY=Math.max(Pe.maxY,Z[X+1])}function ms(Pe,Z,X,oe){if(!Z.geometry)return;const ge=Z.geometry.coordinates;if(ge&&0===ge.length)return;const se=Z.geometry.type,be=Math.pow(X.tolerance/((1<<X.maxZoom)*X.extent),2);let ke=[],Te=Z.id;if(X.promoteId?Te=Z.properties[X.promoteId]:X.generateId&&(Te=oe||0),"Point"===se)Ba(ge,ke);else if("MultiPoint"===se)for(const Ae of ge)Ba(Ae,ke);else if("LineString"===se)Ta(ge,ke,be,!1);else if("MultiLineString"===se){if(X.lineMetrics){for(const Ae of ge)ke=[],Ta(Ae,ke,be,!1),Pe.push(Na(Te,"LineString",ke,Z.properties));return}mc(ge,ke,be,!1)}else if("Polygon"===se)mc(ge,ke,be,!0);else{if("MultiPolygon"!==se){if("GeometryCollection"===se){for(const Ae of Z.geometry.geometries)ms(Pe,{id:Te,geometry:Ae,properties:Z.properties},X,oe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ae of ge){const st=[];mc(Ae,st,be,!0),ke.push(st)}}Pe.push(Na(Te,se,ke,Z.properties))}function Ba(Pe,Z){Z.push(Ml(Pe[0]),Yo(Pe[1]),0)}function Ta(Pe,Z,X,oe){let ge,se,be=0;for(let Te=0;Te<Pe.length;Te++){const Ae=Ml(Pe[Te][0]),st=Yo(Pe[Te][1]);Z.push(Ae,st,0),Te>0&&(be+=oe?(ge*st-Ae*se)/2:Math.sqrt(Math.pow(Ae-ge,2)+Math.pow(st-se,2))),ge=Ae,se=st}const ke=Z.length-3;Z[2]=1,Al(Z,0,ke,X),Z[ke+2]=1,Z.size=Math.abs(be),Z.start=0,Z.end=Z.size}function mc(Pe,Z,X,oe){for(let ge=0;ge<Pe.length;ge++){const se=[];Ta(Pe[ge],se,X,oe),Z.push(se)}}function Ml(Pe){return Pe/360+.5}function Yo(Pe){const Z=Math.sin(Pe*Math.PI/180),X=.5-.25*Math.log((1+Z)/(1-Z))/Math.PI;return X<0?0:X>1?1:X}function Ko(Pe,Z,X,oe,ge,se,be,ke){if(oe/=Z,se>=(X/=Z)&&be<oe)return Pe;if(be<X||se>=oe)return null;const Te=[];for(const Ae of Pe){const st=Ae.geometry;let qe=Ae.type;const kt=0===ge?Ae.minX:Ae.minY,Gt=0===ge?Ae.maxX:Ae.maxY;if(kt>=X&&Gt<oe){Te.push(Ae);continue}if(Gt<X||kt>=oe)continue;let Wt=[];if("Point"===qe||"MultiPoint"===qe)bu(st,Wt,X,oe,ge);else if("LineString"===qe)Va(st,Wt,X,oe,ge,!1,ke.lineMetrics);else if("MultiLineString"===qe)So(st,Wt,X,oe,ge,!1);else if("Polygon"===qe)So(st,Wt,X,oe,ge,!0);else if("MultiPolygon"===qe)for(const bn of st){const pn=[];So(bn,pn,X,oe,ge,!0),pn.length&&Wt.push(pn)}if(Wt.length){if(ke.lineMetrics&&"LineString"===qe){for(const bn of Wt)Te.push(Na(Ae.id,qe,bn,Ae.tags));continue}"LineString"!==qe&&"MultiLineString"!==qe||(1===Wt.length?(qe="LineString",Wt=Wt[0]):qe="MultiLineString"),"Point"!==qe&&"MultiPoint"!==qe||(qe=3===Wt.length?"Point":"MultiPoint"),Te.push(Na(Ae.id,qe,Wt,Ae.tags))}}return Te.length?Te:null}function bu(Pe,Z,X,oe,ge){for(let se=0;se<Pe.length;se+=3){const be=Pe[se+ge];be>=X&&be<=oe&&Gr(Z,Pe[se],Pe[se+1],Pe[se+2])}}function Va(Pe,Z,X,oe,ge,se,be){let ke=wu(Pe);const Te=0===ge?ja:Ua;let Ae,st,qe=Pe.start;for(let pn=0;pn<Pe.length-3;pn+=3){const cn=Pe[pn],pi=Pe[pn+1],yn=Pe[pn+2],Qi=Pe[pn+3],wr=Pe[pn+4],Pr=0===ge?cn:pi,li=0===ge?Qi:wr;let Bn=!1;be&&(Ae=Math.sqrt(Math.pow(cn-Qi,2)+Math.pow(pi-wr,2))),Pr<X?li>X&&(st=Te(ke,cn,pi,Qi,wr,X),be&&(ke.start=qe+Ae*st)):Pr>oe?li<oe&&(st=Te(ke,cn,pi,Qi,wr,oe),be&&(ke.start=qe+Ae*st)):Gr(ke,cn,pi,yn),li<X&&Pr>=X&&(st=Te(ke,cn,pi,Qi,wr,X),Bn=!0),li>oe&&Pr<=oe&&(st=Te(ke,cn,pi,Qi,wr,oe),Bn=!0),!se&&Bn&&(be&&(ke.end=qe+Ae*st),Z.push(ke),ke=wu(Pe)),be&&(qe+=Ae)}let kt=Pe.length-3;const Gt=Pe[kt],Wt=Pe[kt+1],bn=0===ge?Gt:Wt;bn>=X&&bn<=oe&&Gr(ke,Gt,Wt,Pe[kt+2]),kt=ke.length-3,se&&kt>=3&&(ke[kt]!==ke[0]||ke[kt+1]!==ke[1])&&Gr(ke,ke[0],ke[1],ke[2]),ke.length&&Z.push(ke)}function wu(Pe){const Z=[];return Z.size=Pe.size,Z.start=Pe.start,Z.end=Pe.end,Z}function So(Pe,Z,X,oe,ge,se){for(const be of Pe)Va(be,Z,X,oe,ge,se,!1)}function Gr(Pe,Z,X,oe){Pe.push(Z,X,oe)}function ja(Pe,Z,X,oe,ge,se){const be=(se-Z)/(oe-Z);return Gr(Pe,se,X+(ge-X)*be,1),be}function Ua(Pe,Z,X,oe,ge,se){const be=(se-X)/(ge-X);return Gr(Pe,Z+(oe-Z)*be,se,1),be}function Ha(Pe,Z){const X=[];for(let oe=0;oe<Pe.length;oe++){const ge=Pe[oe],se=ge.type;let be;if("Point"===se||"MultiPoint"===se||"LineString"===se)be=Pl(ge.geometry,Z);else if("MultiLineString"===se||"Polygon"===se){be=[];for(const ke of ge.geometry)be.push(Pl(ke,Z))}else if("MultiPolygon"===se){be=[];for(const ke of ge.geometry){const Te=[];for(const Ae of ke)Te.push(Pl(Ae,Z));be.push(Te)}}X.push(Na(ge.id,se,be,ge.tags))}return X}function Pl(Pe,Z){const X=[];X.size=Pe.size,void 0!==Pe.start&&(X.start=Pe.start,X.end=Pe.end);for(let oe=0;oe<Pe.length;oe+=3)X.push(Pe[oe]+Z,Pe[oe+1],Pe[oe+2]);return X}function Eu(Pe,Z){if(Pe.transformed)return Pe;const X=1<<Pe.z,oe=Pe.x,ge=Pe.y;for(const se of Pe.features){const be=se.geometry,ke=se.type;if(se.geometry=[],1===ke)for(let Te=0;Te<be.length;Te+=2)se.geometry.push(Ti(be[Te],be[Te+1],Z,X,oe,ge));else for(let Te=0;Te<be.length;Te++){const Ae=[];for(let st=0;st<be[Te].length;st+=2)Ae.push(Ti(be[Te][st],be[Te][st+1],Z,X,oe,ge));se.geometry.push(Ae)}}return Pe.transformed=!0,Pe}function Ti(Pe,Z,X,oe,ge,se){return[Math.round(X*(Pe*oe-ge)),Math.round(X*(Z*oe-se))]}function Md(Pe,Z,X,oe,ge){const se=Z===ge.maxZoom?0:ge.tolerance/((1<<Z)*ge.extent),be={features:[],numPoints:0,numSimplified:0,numFeatures:Pe.length,source:null,x:X,y:oe,z:Z,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const ke of Pe)Pd(be,ke,se,ge);return be}function Pd(Pe,Z,X,oe){const ge=Z.geometry,se=Z.type,be=[];if(Pe.minX=Math.min(Pe.minX,Z.minX),Pe.minY=Math.min(Pe.minY,Z.minY),Pe.maxX=Math.max(Pe.maxX,Z.maxX),Pe.maxY=Math.max(Pe.maxY,Z.maxY),"Point"===se||"MultiPoint"===se)for(let ke=0;ke<ge.length;ke+=3)be.push(ge[ke],ge[ke+1]),Pe.numPoints++,Pe.numSimplified++;else if("LineString"===se)Ps(be,ge,Pe,X,!1,!1);else if("MultiLineString"===se||"Polygon"===se)for(let ke=0;ke<ge.length;ke++)Ps(be,ge[ke],Pe,X,"Polygon"===se,0===ke);else if("MultiPolygon"===se)for(let ke=0;ke<ge.length;ke++){const Te=ge[ke];for(let Ae=0;Ae<Te.length;Ae++)Ps(be,Te[Ae],Pe,X,!0,0===Ae)}if(be.length){let ke=Z.tags||null;if("LineString"===se&&oe.lineMetrics){ke={};for(const Ae in Z.tags)ke[Ae]=Z.tags[Ae];ke.mapbox_clip_start=ge.start/ge.size,ke.mapbox_clip_end=ge.end/ge.size}const Te={geometry:be,type:"Polygon"===se||"MultiPolygon"===se?3:"LineString"===se||"MultiLineString"===se?2:1,tags:ke};null!==Z.id&&(Te.id=Z.id),Pe.features.push(Te)}}function Ps(Pe,Z,X,oe,ge,se){const be=oe*oe;if(oe>0&&Z.size<(ge?be:oe))return void(X.numPoints+=Z.length/3);const ke=[];for(let Te=0;Te<Z.length;Te+=3)(0===oe||Z[Te+2]>be)&&(X.numSimplified++,ke.push(Z[Te],Z[Te+1])),X.numPoints++;ge&&function(Te,Ae){let st=0;for(let qe=0,kt=Te.length,Gt=kt-2;qe<kt;Gt=qe,qe+=2)st+=(Te[qe]-Te[Gt])*(Te[qe+1]+Te[Gt+1]);if(st>0===Ae)for(let qe=0,kt=Te.length;qe<kt/2;qe+=2){const Gt=Te[qe],Wt=Te[qe+1];Te[qe]=Te[kt-2-qe],Te[qe+1]=Te[kt-1-qe],Te[kt-2-qe]=Gt,Te[kt-1-qe]=Wt}}(ke,se),Pe.push(ke)}const Rd={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Rp{constructor(Z,X){const oe=(X=this.options=function(se,be){for(const ke in be)se[ke]=be[ke];return se}(Object.create(Rd),X)).debug;if(oe&&console.time("preprocess data"),X.maxZoom<0||X.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(X.promoteId&&X.generateId)throw new Error("promoteId and generateId cannot be used together.");let ge=function(se,be){const ke=[];if("FeatureCollection"===se.type)for(let Te=0;Te<se.features.length;Te++)ms(ke,se.features[Te],be,Te);else ms(ke,"Feature"===se.type?se:{geometry:se},be);return ke}(Z,X);this.tiles={},this.tileCoords=[],oe&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",X.indexMaxZoom,X.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ge=function(se,be){const ke=be.buffer/be.extent;let Te=se;const Ae=Ko(se,1,-1-ke,ke,0,-1,2,be),st=Ko(se,1,1-ke,2+ke,0,-1,2,be);return(Ae||st)&&(Te=Ko(se,1,-ke,1+ke,0,-1,2,be)||[],Ae&&(Te=Ha(Ae,1).concat(Te)),st&&(Te=Te.concat(Ha(st,-1)))),Te}(ge,X),ge.length&&this.splitTile(ge,0,0,0),oe&&(ge.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(Z,X,oe,ge,se,be,ke){const Te=[Z,X,oe,ge],Ae=this.options,st=Ae.debug;for(;Te.length;){ge=Te.pop(),oe=Te.pop(),X=Te.pop(),Z=Te.pop();const qe=1<<X,kt=Tu(X,oe,ge);let Gt=this.tiles[kt];if(!Gt&&(st>1&&console.time("creation"),Gt=this.tiles[kt]=Md(Z,X,oe,ge,Ae),this.tileCoords.push({z:X,x:oe,y:ge}),st)){st>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",X,oe,ge,Gt.numFeatures,Gt.numPoints,Gt.numSimplified),console.timeEnd("creation"));const Bn=`z${X}`;this.stats[Bn]=(this.stats[Bn]||0)+1,this.total++}if(Gt.source=Z,null==se){if(X===Ae.indexMaxZoom||Gt.numPoints<=Ae.indexMaxPoints)continue}else{if(X===Ae.maxZoom||X===se)continue;if(null!=se){const Bn=se-X;if(oe!==be>>Bn||ge!==ke>>Bn)continue}}if(Gt.source=null,0===Z.length)continue;st>1&&console.time("clipping");const Wt=.5*Ae.buffer/Ae.extent,bn=.5-Wt,pn=.5+Wt,cn=1+Wt;let pi=null,yn=null,Qi=null,wr=null,Pr=Ko(Z,qe,oe-Wt,oe+pn,0,Gt.minX,Gt.maxX,Ae),li=Ko(Z,qe,oe+bn,oe+cn,0,Gt.minX,Gt.maxX,Ae);Z=null,Pr&&(pi=Ko(Pr,qe,ge-Wt,ge+pn,1,Gt.minY,Gt.maxY,Ae),yn=Ko(Pr,qe,ge+bn,ge+cn,1,Gt.minY,Gt.maxY,Ae),Pr=null),li&&(Qi=Ko(li,qe,ge-Wt,ge+pn,1,Gt.minY,Gt.maxY,Ae),wr=Ko(li,qe,ge+bn,ge+cn,1,Gt.minY,Gt.maxY,Ae),li=null),st>1&&console.timeEnd("clipping"),Te.push(pi||[],X+1,2*oe,2*ge),Te.push(yn||[],X+1,2*oe,2*ge+1),Te.push(Qi||[],X+1,2*oe+1,2*ge),Te.push(wr||[],X+1,2*oe+1,2*ge+1)}}getTile(Z,X,oe){Z=+Z,X=+X,oe=+oe;const ge=this.options,{extent:se,debug:be}=ge;if(Z<0||Z>24)return null;const ke=1<<Z,Te=Tu(Z,X=X+ke&ke-1,oe);if(this.tiles[Te])return Eu(this.tiles[Te],se);be>1&&console.log("drilling down to z%d-%d-%d",Z,X,oe);let Ae,st=Z,qe=X,kt=oe;for(;!Ae&&st>0;)st--,qe>>=1,kt>>=1,Ae=this.tiles[Tu(st,qe,kt)];return Ae&&Ae.source?(be>1&&(console.log("found parent tile z%d-%d-%d",st,qe,kt),console.time("drilling down")),this.splitTile(Ae.source,st,qe,kt,Z,X,oe),be>1&&console.timeEnd("drilling down"),this.tiles[Te]?Eu(this.tiles[Te],se):null):null}}function Tu(Pe,Z,X){return 32*((1<<Pe)*X+Z)+Pe}function Je(Pe,Z){const X=Pe.tileID.canonical;if(!this._geoJSONIndex)return void Z(null,null);const oe=this._geoJSONIndex.getTile(X.z,X.x,X.y);if(!oe)return void Z(null,null);const ge=Ae=>Ae.tags&&"3d_elevation_id"in Ae.tags&&"source"in Ae.tags&&"elevation"===Ae.tags.source,se=oe.features.filter(Ae=>ge(Ae));let be={_geojsonTileLayer:oe.features};se.length>0&&(be={_geojsonTileLayer:oe.features.filter(Ae=>!ge(Ae)),hd_road_elevation:se}),Z(null,{vectorTile:new Cl(be),rawData:function(Ae){const st=new u.bq;for(const qe of Object.keys(Ae))st.writeMessage(3,nf,{name:qe,features:Ae[qe]});return st.finish()}(be).buffer})}class Ga extends Zo{constructor(Z,X,oe,ge,se,be,ke){super(Z,X,oe,ge,se,Je,ke),be&&(this.loadGeoJSON=be),this._dynamicIndex=new tf}loadData(Z,X){const oe=Z&&Z.request,ge=oe&&oe.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(Z,(se,be)=>{if(se||!be)return X(se);if("object"!=typeof be)return X(new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`));{try{if(Z.filter){const Te=u.X(Z.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Te.result)throw new Error(Te.value.map(Ae=>`${Ae.key}: ${Ae.message}`).join(", "));be.features=be.features.filter(Ae=>Te.value.evaluate({zoom:0},Ae))}Z.dynamic?("Feature"===be.type&&(be={type:"FeatureCollection",features:[be]}),Z.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(be.features,this.loaded),Z.cluster&&(be.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=Z.cluster?new js(function({superclusterOptions:Te,clusterProperties:Ae}){if(!Ae||!Te)return Te;const st={},qe={},kt={accumulated:null,zoom:0},Gt={properties:null},Wt=Object.keys(Ae);for(const bn of Wt){const[pn,cn]=Ae[bn],pi=u.X(cn),yn=u.X("string"==typeof pn?[pn,["accumulated"],["get",bn]]:pn);st[bn]=pi.value,qe[bn]=yn.value}return Te.map=bn=>{Gt.properties=bn;const pn={};for(const cn of Wt)pn[cn]=st[cn].evaluate(kt,Gt);return pn},Te.reduce=(bn,pn)=>{Gt.properties=pn;for(const cn of Wt)kt.accumulated=bn[cn],bn[cn]=qe[cn].evaluate(kt,Gt)},Te}(Z)).load(be.features):Z.dynamic?this._dynamicIndex:new Rp(Te=be,Z.geojsonVtOptions)}catch(Te){return X(Te)}const ke={};if(ge){const Te=Ki(oe);Te&&(ke.resourceTiming={},ke.resourceTiming[Z.source]=JSON.parse(JSON.stringify(Te)))}X(null,ke)}var Te})}reloadTile(Z,X){const oe=this.loaded;return oe&&oe[Z.uid]?Z.partial?X(null,void 0):super.reloadTile(Z,X):this.loadTile(Z,X)}loadGeoJSON(Z,X){if(Z.request)u.n(Z.request,X);else{if("string"!=typeof Z.data)return X(new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return X(null,JSON.parse(Z.data))}catch{return X(new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(Z,X){try{X(null,this._geoJSONIndex.getClusterExpansionZoom(Z.clusterId))}catch(oe){X(oe)}}getClusterChildren(Z,X){try{X(null,this._geoJSONIndex.getChildren(Z.clusterId))}catch(oe){X(oe)}}getClusterLeaves(Z,X){try{X(null,this._geoJSONIndex.getLeaves(Z.clusterId,Z.limit,Z.offset))}catch(oe){X(oe)}}}class Op{constructor(Z,X,oe){this.tileID=new u.aM(Z.tileID.overscaledZ,Z.tileID.wrap,Z.tileID.canonical.z,Z.tileID.canonical.x,Z.tileID.canonical.y),this.tileZoom=Z.tileZoom,this.uid=Z.uid,this.zoom=Z.zoom,this.canonical=Z.tileID.canonical,this.pixelRatio=Z.pixelRatio,this.tileSize=Z.tileSize,this.source=Z.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=Z.projection,this.brightness=X,this.worldview=oe}parse(Z,X,oe,ge){this.status="parsing";const se=new u.aM(oe.tileID.overscaledZ,oe.tileID.wrap,oe.tileID.canonical.z,oe.tileID.canonical.x,oe.tileID.canonical.y),be=[],ke=X.familiesBySource[oe.source],Te=new u.fc(se,oe.promoteId);Te.bucketLayerIDs=[],Te.is3DTile=!0,u.fr(Z).then(Ae=>{if(!Ae)return ge(new Error("Could not parse tile"));const st=Ae.json.extensionsUsed&&Ae.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ae.json.asset.extras&&Ae.json.asset.extras.MAPBOX_mesh_features,qe=Ae.json.extensionsUsed&&Ae.json.extensionsUsed.includes("EXT_meshopt_compression"),kt=new u.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const Gt in ke)for(const Wt of ke[Gt]){const bn=Wt[0];Te.bucketLayerIDs.push(Wt.map(pi=>u.C(pi.id,pi.scope))),bn.recalculate(kt,[]);const pn=u.fs(Ae,1/u.d4(oe.tileID.canonical)),cn=new u.ft(Wt,pn,se,st,qe,this.brightness,Te,this.worldview);st||(cn.needsUpload=!0),be.push(cn),cn.evaluate(bn)}this.status="done",ge(null,{buckets:be,featureIndex:Te,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Ae=>ge(new Error(Ae.message)))}}class sf{constructor(Z,X,oe,ge,se,be,ke,Te){this.actor=Z,this.layerIndex=X,this.availableImages=oe,this.availableModels=ge,this.brightness=ke,this.loading={},this.loaded={},this.worldview=Te}loadTile(Z,X){const oe=Z.uid,ge=this.loading[oe]=new Op(Z,this.brightness,this.worldview);u.br(Z.request,(se,be)=>{const ke=!this.loading[oe];return delete this.loading[oe],ke||se?(ge.status="done",ke||(this.loaded[oe]=ge),X(se)):be&&0!==be.byteLength?void ge.parse(be,this.layerIndex,Z,(Te,Ae)=>{ge.status="done",this.loaded=this.loaded||{},this.loaded[oe]=ge,Te||!Ae?X(Te):X(null,Ae)}):(ge.status="done",this.loaded[oe]=ge,X())})}reloadTile(Z,X){const oe=this.loaded,ge=Z.uid;if(oe&&oe[ge]){const se=oe[ge];se.projection=Z.projection,se.brightness=Z.brightness;const be=(ke,Te)=>{se.reloadCallback&&(delete se.reloadCallback,this.loadTile(Z,X)),X(ke,Te)};"parsing"===se.status?se.reloadCallback=be:"done"===se.status&&this.loadTile(Z,X)}}abortTile(Z,X){const oe=Z.uid;this.loading[oe]&&delete this.loading[oe],X()}removeTile(Z,X){const oe=this.loaded,ge=Z.uid;oe&&oe[ge]&&delete oe[ge],X()}}class Pn{constructor(Z){this.self=Z,this.actor=new u.fv(Z,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new u.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=u.cj({name:"mercator"}),this.workerSourceTypes={vector:Zo,geojson:Ga,"raster-dem":Bi,"raster-array":eo,"batched-model":sf},this.workerSources={},this.self.registerWorkerSource=(X,oe)=>{if(this.workerSourceTypes[X])throw new Error(`Worker source with name "${X}" already registered.`);this.workerSourceTypes[X]=oe},this.self.registerRTLTextPlugin=X=>{if(u.fw.isParsed())throw new Error("RTL text plugin already registered.");u.fw.setState({pluginStatus:u.fx.parsed,pluginURL:u.fw.getPluginURL()}),u.fw.applyArabicShaping=X.applyArabicShaping,u.fw.processBidirectionalText=X.processBidirectionalText,u.fw.processStyledBidirectionalText=X.processStyledBidirectionalText;for(const oe of this.rtlPluginParsingListeners)oe(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(Z,X,oe){delete this.layerIndexes[Z],delete this.availableImages[Z],delete this.availableModels[Z],delete this.workerSources[Z],oe()}checkIfReady(Z,X,oe){oe()}setReferrer(Z,X){this.referrer=X}spriteLoaded(Z,X){this.isSpriteLoaded[Z]||(this.isSpriteLoaded[Z]={});const{scope:oe,isLoaded:ge}=X;if(this.isSpriteLoaded[Z][oe]=ge,this.workerSources[Z]&&this.workerSources[Z][oe])for(const se in this.workerSources[Z][oe]){const be=this.workerSources[Z][oe][se];for(const ke in be){const Te=be[ke];Te instanceof Zo&&(Te.isSpriteLoaded=ge,Te.fire(new u.A("isSpriteLoaded")))}}}setImages(Z,X,oe){this.availableImages[Z]||(this.availableImages[Z]={});const{scope:ge,images:se}=X;if(this.availableImages[Z][ge]=se,this.workerSources[Z]&&this.workerSources[Z][ge]){for(const be in this.workerSources[Z][ge]){const ke=this.workerSources[Z][ge][be];for(const Te in ke)ke[Te].availableImages=se}oe()}else oe()}setModels(Z,{scope:X,models:oe},ge){if(this.availableModels[Z]||(this.availableModels[Z]={}),this.availableModels[Z][X]=oe,this.workerSources[Z]&&this.workerSources[Z][X]){for(const se in this.workerSources[Z][X]){const be=this.workerSources[Z][X][se];for(const ke in be)be[ke].availableModels=oe}ge()}else ge()}setProjection(Z,X){this.projections[Z]=u.cj(X)}setBrightness(Z,X,oe){this.brightness=X,oe()}setWorldview(Z,X,oe){this.worldview=X,oe()}setLayers(Z,X,oe){this.getLayerIndex(Z,X.scope).replace(X.layers,X.options),oe()}updateLayers(Z,X,oe){this.getLayerIndex(Z,X.scope).update(X.layers,X.removedIds,X.options),oe()}loadTile(Z,X,oe){X.projection=this.projections[Z]||this.defaultProjection,this.getWorkerSource(Z,X.type,X.source,X.scope).loadTile(X,oe)}decodeRasterArray(Z,X,oe){this.getWorkerSource(Z,X.type,X.source,X.scope).decodeRasterArray(X,oe)}reloadTile(Z,X,oe){X.projection=this.projections[Z]||this.defaultProjection,this.getWorkerSource(Z,X.type,X.source,X.scope).reloadTile(X,oe)}abortTile(Z,X,oe){this.getWorkerSource(Z,X.type,X.source,X.scope).abortTile(X,oe)}removeTile(Z,X,oe){this.getWorkerSource(Z,X.type,X.source,X.scope).removeTile(X,oe)}removeSource(Z,X,oe){if(!(this.workerSources[Z]&&this.workerSources[Z][X.scope]&&this.workerSources[Z][X.scope][X.type]&&this.workerSources[Z][X.scope][X.type][X.source]))return;const ge=this.workerSources[Z][X.scope][X.type][X.source];delete this.workerSources[Z][X.scope][X.type][X.source],void 0!==ge.removeSource?ge.removeSource(X,oe):oe()}loadWorkerSource(Z,X,oe){try{this.self.importScripts(X.url),oe()}catch(ge){oe(ge.toString())}}syncRTLPluginState(Z,X,oe){if(u.fw.isParsed())oe(null,!0);else if(u.fw.isParsing())this.rtlPluginParsingListeners.push(oe);else try{u.fw.setState(X);const ge=u.fw.getPluginURL();!u.fw.isLoaded()||u.fw.isParsed()||u.fw.isParsing()||null==ge||(u.fw.setState({pluginStatus:u.fx.parsing,pluginURL:u.fw.getPluginURL()}),this.self.importScripts(ge),u.fw.isParsed()?oe(null,!0):this.rtlPluginParsingListeners.push(oe))}catch(ge){oe(ge.toString())}}setDracoUrl(Z,X){this.dracoUrl=X}getAvailableImages(Z,X){this.availableImages[Z]||(this.availableImages[Z]={});let oe=this.availableImages[Z][X];return oe||(oe=[]),oe}getAvailableModels(Z,X){this.availableModels[Z]||(this.availableModels[Z]={});let oe=this.availableModels[Z][X];return oe||(oe={}),oe}getLayerIndex(Z,X){this.layerIndexes[Z]||(this.layerIndexes[Z]={});let oe=this.layerIndexes[Z][X];return oe||(oe=this.layerIndexes[Z][X]=new Id,oe.scope=X),oe}getWorkerSource(Z,X,oe,ge){const se=this.workerSources;return se[Z]||(se[Z]={}),se[Z][ge]||(se[Z][ge]={}),se[Z][ge][X]||(se[Z][ge][X]={}),this.isSpriteLoaded[Z]||(this.isSpriteLoaded[Z]={}),se[Z][ge][X][oe]||(se[Z][ge][X][oe]=new this.workerSourceTypes[X]({send:(be,ke,Te,Ae,st,qe)=>this.actor.send(be,ke,Te,Z,st,qe),scheduler:this.actor.scheduler},this.getLayerIndex(Z,ge),this.getAvailableImages(Z,ge),this.getAvailableModels(Z,ge),this.isSpriteLoaded[Z][ge],void 0,this.brightness,this.worldview)),se[Z][ge][X][oe]}rasterizeImagesWorker(Z,X,oe){const ge=new Map;for(const[se,{image:be,imageVariant:ke}]of X.tasks.entries()){const Te=this.imageRasterizer.rasterize(ke,be,X.scope,Z);ge.set(se,Te)}oe(void 0,ge)}removeRasterizedImages(Z,X,oe){this.imageRasterizer.removeImagesFromCacheByIds(X.imageIds,X.scope,Z),oe()}enforceCacheSizeLimit(Z,X){u.fy(X)}getWorkerPerformanceMetrics(Z,X,oe){oe(void 0,void 0)}}return u.fu(self)&&(self.worker=new Pn(self)),Pn}),Fg(0,function(u){var Ki="3.14.0";const Ni={create:"create",load:"load",fullLoad:"fullLoad"},xa={mark(f){performance.mark(f)},measure(f,r,l){performance.measure(f,r,l)}};function Id(f){const r=f.name.split("?")[0];return u.a(r)&&r.includes("mapbox-gl.js")?"javascript":u.a(r)&&r.includes("mapbox-gl.css")?"css":u.b(r)?"fontRange":u.c(r)?"sprite":u.i(r)?"style":u.d(r)?"tilejson":"other"}var Cs,As={},Dl=function(){if(Cs)return As;function f(p){return!r(p)}function r(p){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var v,b,S=new Blob([""],{type:"text/javascript"}),I=URL.createObjectURL(S);try{b=new Worker(I),v=!0}catch{v=!1}return b&&b.terminate(),URL.revokeObjectURL(I),v}()?function(){var v=document.createElement("canvas");v.width=v.height=1;var b=v.getContext("2d");if(!b)return!1;var S=b.getImageData(0,0,1,1);return S&&S.width===v.width}()?(void 0===l[_=p&&p.failIfMajorPerformanceCaveat]&&(l[_]=function(v){var b,I,P,R,S=(I=v,P=document.createElement("canvas"),(R=Object.create(f.webGLContextAttributes)).failIfMajorPerformanceCaveat=I,P.getContext("webgl2",R));if(!S)return!1;try{b=S.createShader(S.VERTEX_SHADER)}catch{return!1}return!(!b||S.isContextLost())&&(S.shaderSource(b,"void main() {}"),S.compileShader(b),!0===S.getShaderParameter(b,S.COMPILE_STATUS))}(_)),l[_]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var _}Cs=1,As.supported=f,As.notSupportedReason=r;var l={};return f.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},As}();function fn(f,r,l){const p=document.createElement(f);return null!=r&&(p.className=r),l&&l.appendChild(p),p}function Zo(f,r,l){const p=document.createElementNS("http://www.w3.org/2000/svg",f);for(const _ of Object.keys(r))p.setAttributeNS(null,_,String(r[_]));return l&&l.appendChild(p),p}const Bi=typeof document<"u"?document.documentElement&&document.documentElement.style:null,zo=Bi&&void 0!==Bi.userSelect?"userSelect":"WebkitUserSelect";let eo;function fs(){Bi&&zo&&(eo=Bi[zo],Bi[zo]="none")}function Vs(){Bi&&zo&&(Bi[zo]=eo)}function Il(f){f.preventDefault(),f.stopPropagation(),window.removeEventListener("click",Il,!0)}function Cl(){window.addEventListener("click",Il,!0),window.setTimeout(()=>{window.removeEventListener("click",Il,!0)},0)}function ra(f,r){const l=f.getBoundingClientRect();return jn(f,l,r)}function ba(f,r){const l=f.getBoundingClientRect(),p=[];for(let _=0;_<r.length;_++)p.push(jn(f,l,r[_]));return p}function tf(f){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===f.button&&f.ctrlKey?0:f.button}function jn(f,r,l){const p=f.offsetWidth===r.width?1:f.offsetWidth/r.width;return new u.P((l.clientX-r.left)*p,(l.clientY-r.top)*p)}const za="01",uo="NO_ACCESS_TOKEN";class dr{constructor(r,l,p){this._transformRequestFn=r,this._customAccessToken=l,this._silenceAuthErrors=!!p,this._createSkuToken()}_createSkuToken(){const r=function(){let l="";for(let p=0;p<10;p++)l+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",za,l].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=r.token,this._skuTokenExpiresAt=r.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(r,l){return this._transformRequestFn&&this._transformRequestFn(r,l)||{url:r}}normalizeStyleURL(r,l){if(!u.j(r))return r;const p=Oi(r);return p.params.push(`sdk=js-${Ki}`),p.path=`/styles/v1${p.path}`,this._makeAPIURL(p,this._customAccessToken||l)}normalizeGlyphsURL(r,l){if(!u.j(r))return r;const p=Oi(r);return p.path=`/fonts/v1${p.path}`,this._makeAPIURL(p,this._customAccessToken||l)}normalizeModelURL(r,l){if(!u.j(r))return r;const p=Oi(r);return p.path=`/models/v1${p.path}`,this._makeAPIURL(p,this._customAccessToken||l)}normalizeSourceURL(r,l,p,_){if(!u.j(r))return r;const v=Oi(r);return v.path=`/v4/${v.authority}.json`,v.params.push("secure"),p&&v.params.push(`language=${p}`),_&&v.params.push(`worldview=${_}`),this._makeAPIURL(v,this._customAccessToken||l)}normalizeIconsetURL(r,l){const p=Oi(r);return u.j(r)?(p.path=`/styles/v1${p.path}/iconset.pbf`,this._makeAPIURL(p,this._customAccessToken||l)):to(p)}normalizeSpriteURL(r,l,p,_){const v=Oi(r);return u.j(r)?(v.path=`/styles/v1${v.path}/sprite${l}${p}`,this._makeAPIURL(v,this._customAccessToken||_)):(v.path+=`${l}${p}`,to(v))}normalizeTileURL(r,l,p){if(this._isSkuTokenExpired()&&this._createSkuToken(),r&&!u.j(r))return r;const _=Oi(r);_.path=_.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${l||p&&"raster"!==_.authority&&512===p?"@2x":""}${u.l.supported?".webp":"$1"}`),"raster"===_.authority?_.path=`/${u.e.RASTER_URL_PREFIX}${_.path}`:"rasterarrays"===_.authority?_.path=`/${u.e.RASTERARRAYS_URL_PREFIX}${_.path}`:"3dtiles"===_.authority?_.path=`/${u.e.TILES3D_URL_PREFIX}${_.path}`:(_.path=_.path.replace(/^.+\/v4\//,"/"),_.path=`/${u.e.TILE_URL_VERSION}${_.path}`);const v=this._customAccessToken||function(b){for(const S of b){const I=S.match(/^access_token=(.*)$/);if(I)return I[1]}return null}(_.params)||u.e.ACCESS_TOKEN;return u.e.REQUIRE_ACCESS_TOKEN&&v&&this._skuToken&&_.params.push(`sku=${this._skuToken}`),this._makeAPIURL(_,v)}canonicalizeTileURL(r,l){const p=Oi(r);if(!p.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!p.path.match(/\.[\w]+$/))return r;let _="mapbox://";p.path.match(/^\/raster\/v1\//)?_+=`raster/${p.path.replace(`/${u.e.RASTER_URL_PREFIX}/`,"")}`:p.path.match(/^\/rasterarrays\/v1\//)?_+=`rasterarrays/${p.path.replace(`/${u.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:_+=`tiles/${p.path.replace(`/${u.e.TILE_URL_VERSION}/`,"")}`;let v=p.params;return l&&(v=v.filter(b=>!b.match(/^access_token=/))),v.length&&(_+=`?${v.join("&")}`),_}canonicalizeTileset(r,l){const p=!!l&&u.j(l),_=[];for(const v of r.tiles||[])u.k(v)?_.push(this.canonicalizeTileURL(v,p)):_.push(v);return _}_makeAPIURL(r,l){const p="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",_=Oi(u.e.API_URL);if(r.protocol=_.protocol,r.authority=_.authority,"http"===r.protocol){const v=r.params.indexOf("secure");v>=0&&r.params.splice(v,1)}if("/"!==_.path&&(r.path=`${_.path}${r.path}`),!u.e.REQUIRE_ACCESS_TOKEN)return to(r);if(l=l||u.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!l)throw new Error(`An API access token is required to use Mapbox GL. ${p}`);if("s"===l[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${p}`)}return r.params=r.params.filter(v=>-1===v.indexOf("access_token")),r.params.push(`access_token=${l||""}`),to(r)}}const hr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Oi(f){const r=f.match(hr);if(!r)throw new Error("Unable to parse URL object");return{protocol:r[1],authority:r[2],path:r[3]||"/",params:r[4]?r[4].split("&"):[]}}function to(f){const r=f.params.length?`?${f.params.join("&")}`:"";return`${f.protocol}://${f.authority}${f.path}${r}`}const nf="mapbox.eventData";function wa(f){if(!f)return null;const r=f.split(".");if(!r||3!==r.length)return null;try{return JSON.parse(u.m(r[1]))}catch{return null}}class qi{constructor(r){this.type=r,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(r){const l=wa(u.e.ACCESS_TOKEN);let p="";return p=l&&l.u?u.f(l.u):u.e.ACCESS_TOKEN||"",r?`${nf}.${r}:${p}`:`${nf}:${p}`}fetchEventData(){const r=u.s("localStorage"),l=this.getStorageKey(),p=this.getStorageKey("uuid");if(r)try{const _=localStorage.getItem(l);_&&(this.eventData=JSON.parse(_));const v=localStorage.getItem(p);v&&(this.anonId=v)}catch{u.w("Unable to read from LocalStorage")}}saveEventData(){const r=u.s("localStorage"),l=this.getStorageKey(),p=this.getStorageKey("uuid"),_=this.anonId;if(r&&_)try{localStorage.setItem(p,_),Object.keys(this.eventData).length>=1&&localStorage.setItem(l,JSON.stringify(this.eventData))}catch{u.w("Unable to write to LocalStorage")}}processRequests(r){}postEvent(r,l,p,_){if(!u.e.EVENTS_URL)return;const v=Oi(u.e.EVENTS_URL);v.params.push(`access_token=${_||u.e.ACCESS_TOKEN||""}`);const b={event:this.type,created:new Date(r).toISOString()},S=l?u.h(b,l):b,I={url:to(v),headers:{"Content-Type":"text/plain"},body:JSON.stringify([S])};this.pendingRequest=u.p(I,P=>{this.pendingRequest=null,p(P),this.saveEventData(),this.processRequests(_)})}queueRequest(r,l){this.queue.push(r),this.processRequests(l)}}const Li=new class extends qi{constructor(f){super("appUserTurnstile"),this._customAccessToken=f}postTurnstileEvent(f,r){u.e.EVENTS_URL&&u.e.ACCESS_TOKEN&&Array.isArray(f)&&f.some(l=>u.j(l)||u.k(l))&&this.queueRequest(Date.now(),r)}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const r=wa(u.e.ACCESS_TOKEN),l=r?r.u:u.e.ACCESS_TOKEN;let p=l!==this.eventData.tokenU;u.v(this.anonId)||(this.anonId=u.u(),p=!0);const _=this.queue.shift();if(this.eventData.lastSuccess){const v=new Date(this.eventData.lastSuccess),b=new Date(_),S=(_-this.eventData.lastSuccess)/864e5;p=p||S>=1||S<-1||v.getDate()!==b.getDate()}else p=!0;p?this.postEvent(_,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Ki,skuId:za,"enabled.telemetry":!1,userId:this.anonId},v=>{v||(this.eventData.lastSuccess=_,this.eventData.tokenU=l)},f):this.processRequests()}},No=Li.postTurnstileEvent.bind(Li),xu=new class extends qi{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(f,r,l,p){this.skuToken=r,this.errorCb=p,u.e.EVENTS_URL&&(l||u.e.ACCESS_TOKEN?this.queueRequest({id:f,timestamp:Date.now()},l):this.errorCb(new Error(uo)))}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;const{id:r,timestamp:l}=this.queue.shift();r&&this.success[r]||(this.anonId||this.fetchEventData(),u.v(this.anonId)||(this.anonId=u.u()),this.postEvent(l,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Ki,skuId:za,skuToken:this.skuToken,userId:this.anonId},p=>{p?this.errorCb(p):r&&(this.success[r]=!0)},f))}remove(){this.errorCb=null}},rf=xu.postMapLoadEvent.bind(xu),Vi=new class extends qi{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(f){let r=this.mapInstanceIdMap.get(f);return r||(r=u.u(),this.mapInstanceIdMap.set(f,r)),r}getEventId(f){const r=this.eventIdPerMapInstanceMap.get(f)||0;return this.eventIdPerMapInstanceMap.set(f,r+1),r}postStyleLoadEvent(f,r){const{map:l,style:p,importedStyles:_}=r;if(!u.e.EVENTS_URL||!f&&!u.e.ACCESS_TOKEN)return;const v=this.getMapInstanceId(l),b={mapInstanceId:v,eventId:this.getEventId(v),style:p};_.length&&(b.importedStyles=_),this.queueRequest({timestamp:Date.now(),payload:b},f)}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:r,payload:l}=this.queue.shift();this.postEvent(r,l,()=>{},f)}},Ai=Vi.postStyleLoadEvent.bind(Vi),ir=new class extends qi{constructor(){super("gljs.performance")}postPerformanceEvent(f,r){u.e.EVENTS_URL&&(f||u.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:r},f)}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:r,performanceData:l}=this.queue.shift(),p=function(_){const v=performance.getEntriesByType("resource"),b=performance.getEntriesByType("mark"),S=function(B){const H={};if(B)for(const U in B)if("other"!==U)for(const q of B[U]){const G=`${U}ResolveRangeMin`,Y=`${U}ResolveRangeMax`,ee=`${U}RequestCount`,ne=`${U}RequestCachedCount`;H[G]=Math.min(H[G]||1/0,q.startTime),H[Y]=Math.max(H[Y]||-1/0,q.responseEnd);const le=de=>{void 0===H[de]&&(H[de]=0),++H[de]};void 0!==q.transferSize&&0===q.transferSize&&le(ne),le(ee)}return H}(function(B,H){const U={};if(B)for(const q of B){const G=H(q);void 0===U[G]&&(U[G]=[]),U[G].push(q)}return U}(v,Id)),I=window.devicePixelRatio,P=navigator.connection||navigator.mozConnection||navigator.webkitConnection,R=P?P.effectiveType:void 0,z={counters:[],metadata:[],attributes:[]},L=(B,H,U)=>{null!=U&&B.push({name:H,value:U.toString()})};for(const B in S)L(z.counters,B,S[B]);if(_.interactionRange[0]!==1/0&&_.interactionRange[1]!==-1/0&&(L(z.counters,"interactionRangeMin",_.interactionRange[0]),L(z.counters,"interactionRangeMax",_.interactionRange[1])),b)for(const B of Object.keys(Ni)){const H=Ni[B],U=b.find(q=>q.name===H);U&&L(z.counters,H,U.startTime)}return L(z.counters,"visibilityHidden",_.visibilityHidden),L(z.attributes,"style",function(B){if(B)for(const H of B){const U=H.name.split("?")[0];if(u.i(U)){const q=U.split("/").slice(-2);if(2===q.length)return`mapbox://styles/${q[0]}/${q[1]}`}}}(v)),L(z.attributes,"terrainEnabled",_.terrainEnabled?"true":"false"),L(z.attributes,"fogEnabled",_.fogEnabled?"true":"false"),L(z.attributes,"projection",_.projection),L(z.attributes,"zoom",_.zoom),L(z.metadata,"devicePixelRatio",I),L(z.metadata,"connectionEffectiveType",R),L(z.metadata,"navigatorUserAgent",navigator.userAgent),L(z.metadata,"screenWidth",window.screen.width),L(z.metadata,"screenHeight",window.screen.height),L(z.metadata,"windowWidth",window.innerWidth),L(z.metadata,"windowHeight",window.innerHeight),L(z.metadata,"mapWidth",_.width/I),L(z.metadata,"mapHeight",_.height/I),L(z.metadata,"webglRenderer",_.renderer),L(z.metadata,"webglVendor",_.vendor),L(z.metadata,"sdkVersion",Ki),L(z.metadata,"sdkIdentifier","mapbox-gl-js"),z}(l);for(const _ of p.metadata);for(const _ of p.counters);for(const _ of p.attributes);this.postEvent(r,p,()=>{},f)}},yi=ir.postPerformanceEvent.bind(ir),er=new class extends qi{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(f,r,l,p){if(!u.e.API_URL||!u.e.SESSION_PATH)return;const _=Oi(u.e.API_URL+u.e.SESSION_PATH);_.params.push(`sku=${r||""}`),_.params.push(`access_token=${p||u.e.ACCESS_TOKEN||""}`);const v={url:to(_),headers:{"Content-Type":"text/plain"}};this.pendingRequest=u.g(v,b=>{this.pendingRequest=null,l(b),this.saveEventData(),this.processRequests(p)})}getSessionAPI(f,r,l,p){this.skuToken=r,this.errorCb=p,u.e.SESSION_PATH&&u.e.API_URL&&(l||u.e.ACCESS_TOKEN?this.queueRequest({id:f,timestamp:Date.now()},l):this.errorCb(new Error(uo)))}processRequests(f){if(this.pendingRequest||0===this.queue.length)return;const{id:r,timestamp:l}=this.queue.shift();r&&this.success[r]||this.getSession(l,this.skuToken,p=>{p?this.errorCb(p):r&&(this.success[r]=!0)},f)}remove(){this.errorCb=null}},rr=er.getSessionAPI.bind(er),js=new Set;function Ea(f,r){r?js.add(f):js.delete(f)}class Cd{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(r,l){this._updatedSourceCaches[r]=l,this.setDirty()}discardSourceCacheUpdate(r){delete this._updatedSourceCaches[r]}updateLayer(r){const l=r.scope;this._updatedLayers[l]=this._updatedLayers[l]||new Set,this._updatedLayers[l].add(r.id),this.setDirty()}removeLayer(r){const l=r.scope;this._removedLayers[l]=this._removedLayers[l]||{},this._updatedLayers[l]=this._updatedLayers[l]||new Set,this._removedLayers[l][r.id]=r,this._updatedLayers[l].delete(r.id),this._updatedPaintProps.delete(r.fqid),this.setDirty()}getRemovedLayer(r){return this._removedLayers[r.scope]?this._removedLayers[r.scope][r.id]:null}discardLayerRemoval(r){this._removedLayers[r.scope]&&delete this._removedLayers[r.scope][r.id]}getLayerUpdatesByScope(){const r={};for(const l in this._updatedLayers)r[l]=r[l]||{},r[l].updatedIds=Array.from(this._updatedLayers[l].values());for(const l in this._removedLayers)r[l]=r[l]||{},r[l].removedIds=Object.keys(this._removedLayers[l]);return r}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(r){this._updatedPaintProps.add(r.fqid),this.setDirty()}getUpdatedImages(r){return this._updatedImages[r]?Array.from(this._updatedImages[r].values()):[]}updateImage(r,l){this._updatedImages[l]=this._updatedImages[l]||new Set,this._updatedImages[l].add(u.I.toString(r)),this.setDirty()}resetUpdatedImages(r){this._updatedImages[r]&&this._updatedImages[r].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function ps(f){const{userImage:r}=f;return!!(r&&r.render&&r.render())&&(f.data.replace(new Uint8Array(r.data.buffer)),!0)}class or extends u.E{constructor(r){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=r,"raster"!==r&&u.t()&&(this.imageRasterizerDispatcher=new u.D(u.x(),this,"Image Rasterizer Worker",1))}addScope(r){this.loaded.set(r,!1),this.imageProviders.set(r,new Map),this.images.set(r,new Map),this.updatedImages.set(r,new Set),this.callbackDispatchedThisFrame.set(r,new Set),this.patterns.set(r,new Map),this.atlasImage.set(r,new u.r({width:1,height:1}))}removeScope(r){this.loaded.delete(r),this.imageProviders.delete(r),this.images.delete(r),this.updatedImages.delete(r),this.callbackDispatchedThisFrame.delete(r),this.patterns.delete(r),this.atlasImage.delete(r);const l=this.atlasTexture.get(r);l&&(l.destroy(),this.atlasTexture.delete(r))}addImageProvider(r,l){this.imageProviders.has(l)||this.imageProviders.set(l,new Map),this.imageProviders.get(l).set(r.id,r)}removeImageProvider(r,l){this.imageProviders.has(l)&&this.imageProviders.get(l).delete(r)}getPendingImageProviders(){const r=[];for(const l of this.imageProviders.values())for(const p of l.values())p.hasPendingRequests()&&r.push(p);return r}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new u.y),this._imageRasterizer}isLoaded(){for(const r of this.loaded.keys())if(!this.loaded.get(r))return!1;return!0}setLoaded(r,l){if(this.loaded.get(l)!==r&&(this.loaded.set(l,r),r)){for(const{ids:p,callback:_}of this.requestors)this._notify(p,l,_);this.requestors=[]}}hasImage(r,l){return!!this.getImage(r,l)}getImage(r,l){return this.images.get(l).get(r.toString())}addImage(r,l,p){this._validate(r,p)&&this.images.get(l).set(r.toString(),p)}_validate(r,l){let p=!0;return this._validateStretch(l.stretchX,l.data&&l.data.width)||(this.fire(new u.z(new Error(`Image "${r.name}" has invalid "stretchX" value`))),p=!1),this._validateStretch(l.stretchY,l.data&&l.data.height)||(this.fire(new u.z(new Error(`Image "${r.name}" has invalid "stretchY" value`))),p=!1),this._validateContent(l.content,l)||(this.fire(new u.z(new Error(`Image "${r.name}" has invalid "content" value`))),p=!1),p}_validateStretch(r,l){if(!r)return!0;let p=0;for(const _ of r){if(_[0]<p||_[1]<_[0]||l<_[1])return!1;p=_[1]}return!0}_validateContent(r,l){return!r||!(4!==r.length||!l.usvg&&(r[0]<0||l.data.width<r[0]||r[1]<0||l.data.height<r[1]||r[2]<0||l.data.width<r[2]||r[3]<0||l.data.height<r[3]))&&!(r[2]<r[0]||r[3]<r[1])}updateImage(r,l,p){const _=this.images.get(l).get(r.toString());p.version=_.version+1,this.images.get(l).set(r.toString(),p),this.updatedImages.get(l).add(r),this.removeFromImageRasterizerCache(r,l)}clearUpdatedImages(r){this.updatedImages.get(r).clear()}removeFromImageRasterizerCache(r,l){"raster"!==this.spriteFormat&&(u.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[r],scope:l}):this.imageRasterizer.removeImagesFromCacheByIds([r],l))}removeImage(r,l){const p=this.images.get(l),_=p.get(r.toString());p.delete(r.toString()),this.patterns.get(l).delete(r.toString()),this.removeFromImageRasterizerCache(r,l),_.userImage&&_.userImage.onRemove&&_.userImage.onRemove()}listImages(r){return Array.from(this.images.get(r).keys()).map(l=>u.I.from(l))}getImages(r,l,p){const _=[],v=[],b=this.imageProviders.get(l);for(const R of r){if(!R.iconsetId){_.push(R);continue}const z=b.get(R.iconsetId);z&&(this.getImage(R,l)?v.push(R):z.addPendingRequest(R))}if(0===_.length)return void this._notify(v,l,p);let S=!0;const I=!!this.loaded.get(l),P=this.images.get(l);if(!I)for(const R of _)P.has(R.toString())||(S=!1);I||S?this._notify(_,l,p):this.requestors.push({ids:_,scope:l,callback:p})}rasterizeImages(r,l){const p=new Map,{tasks:_,scope:v}=r;for(const[b,S]of _.entries()){const I=this.getImage(S.id,v);I&&p.set(b,{image:I,imageVariant:S})}this._rasterizeImages(v,p,l)}_rasterizeImages(r,l,p){if(u.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:l,scope:r},p);else{const _=new Map;for(const[v,{image:b,imageVariant:S}]of l.entries())_.set(v,this.imageRasterizer.rasterize(S,b,r,0));p(void 0,_)}}getUpdatedImages(r){return this.updatedImages.get(r)||new Set}_notify(r,l,p){const _=this.images.get(l),v=new Map;for(const b of r){if(!_.get(b.toString())){if(b.iconsetId)continue;this.fire(new u.A("styleimagemissing",{id:b.name}))}const S=_.get(b.toString());if(!S){u.w(`Image "${b.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const I={data:S.usvg?null:S.data.clone(),pixelRatio:S.pixelRatio,sdf:S.sdf,usvg:S.usvg,version:S.version,stretchX:S.stretchX,stretchY:S.stretchY,content:S.content,hasRenderCallback:!(!S.userImage||!S.userImage.render)};S.usvg&&Object.assign(I,{width:S.icon.usvg_tree.width,height:S.icon.usvg_tree.height}),v.set(u.I.toString(b),I)}p(null,v)}getPixelSize(r){const{width:l,height:p}=this.atlasImage.get(r);return{width:l,height:p}}getPattern(r,l,p){const _=r.toString(),v=this.patterns.get(l),b=v.get(_),S=this.getImage(r,l);if(!S)return null;if(b){if(b.position.version===S.version)return b.position;b.position.version=S.version}else{if(S.usvg&&!S.data){const I=this.getPatternInFlightId(_,l);if(this.patternsInFlight.has(I))return null;this.patternsInFlight.add(I);const P=new u.B(r).scaleSelf(u.q.devicePixelRatio),R=new Map([[P.toString(),{image:S,imageVariant:P}]]);return this._rasterizeImages(l,R,(z,L)=>this.storePatternImage(P,l,S,p,L)),null}this.storePattern(r,l,S)}return this._updatePatternAtlas(l,p),v.get(_).position}getPatternInFlightId(r,l){return u.C(r,l)}hasPatternsInFlight(){return 0!==this.patternsInFlight.size}storePatternImage(r,l,p,_,v){const b=r.toString(),S=v?v.get(b):void 0;S&&(p.data=S,this.storePattern(r.id,l,p),this._updatePatternAtlas(l,_),this.patternsInFlight.delete(this.getPatternInFlightId(r.id.toString(),l)))}storePattern(r,l,p){const _={w:p.data.width+2*u.F,h:p.data.height+2*u.F,x:0,y:0},v=new u.G(_,p,u.F);this.patterns.get(l).set(r.toString(),{bin:_,position:v})}destroyAtlasTextures(){for(const r of this.atlasTexture.values())r&&r.destroy();this.atlasTexture.clear()}bind(r,l){const p=r.gl;let _=this.atlasTexture.get(l);_?this.dirty&&(_.update(this.atlasImage.get(l)),this.dirty=!1):(_=new u.T(r,this.atlasImage.get(l),p.RGBA8),this.atlasTexture.set(l,_)),_.bind(p.LINEAR,p.CLAMP_TO_EDGE)}_updatePatternAtlas(r,l){const p=this.patterns.get(r),_=Array.from(p.values()).map(({bin:P})=>P),{w:v,h:b}=u.H(_),S=this.atlasImage.get(r);S.resize({width:v||1,height:b||1});const I=this.images.get(r);for(const[P,{bin:R,position:z}]of p.entries()){let L=z.padding;const B=R.x+L,H=R.y+L,U=I.get(P).data,q=U.width,G=U.height;L=L>1?L-1:L,u.r.copy(U,S,{x:0,y:0},{x:B,y:H},{width:q,height:G},l),u.r.copy(U,S,{x:0,y:G-L},{x:B,y:H-L},{width:q,height:L},l),u.r.copy(U,S,{x:0,y:0},{x:B,y:H+G},{width:q,height:L},l),u.r.copy(U,S,{x:q-L,y:0},{x:B-L,y:H},{width:L,height:G},l),u.r.copy(U,S,{x:0,y:0},{x:B+q,y:H},{width:L,height:G},l),u.r.copy(U,S,{x:q-L,y:G-L},{x:B-L,y:H-L},{width:L,height:L},l),u.r.copy(U,S,{x:0,y:G-L},{x:B+q,y:H-L},{width:L,height:L},l),u.r.copy(U,S,{x:0,y:0},{x:B+q,y:H+G},{width:L,height:L},l),u.r.copy(U,S,{x:q-L,y:0},{x:B-L,y:H+G},{width:L,height:L},l)}this.dirty=!0}beginFrame(){for(const r of this.images.keys())this.callbackDispatchedThisFrame.set(r,new Set)}dispatchRenderCallbacks(r,l){const p=this.images.get(l);for(const _ of r){if(this.callbackDispatchedThisFrame.get(l).has(_.toString()))continue;this.callbackDispatchedThisFrame.get(l).add(_.toString());const v=p.get(_.toString());ps(v)&&this.updateImage(_,l,v)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Xo(f){const r=f.key,l=f.value,p=f.valueSpec||{},_=f.objectElementValidators||{},v=f.style,b=f.styleSpec;let S=[];const I=u.J(l);if("object"!==I)return[new u.V(r,l,`object expected, ${I} found`)];for(const P in l){const R=P.split(".")[0];let z;_[R]?z=_[R]:p[R]?z=Ti:_["*"]?z=_["*"]:p["*"]&&(z=Ti),z?S=S.concat(z({key:(r&&`${r}.`)+P,value:l[P],valueSpec:p[R]||p["*"],style:v,styleSpec:b,object:l,objectKey:P},l)):S.push(new u.K(r,l[P],`unknown property "${P}"`))}for(const P in p)_[P]||p[P].required&&void 0===p[P].default&&void 0===l[P]&&S.push(new u.V(r,l,`missing required property "${P}"`));return S}function Al(f){const r=f.value,l=f.valueSpec,p=f.style,_=f.styleSpec,v=f.key,b=f.arrayElementValidator||Ti;if("array"!==u.J(r))return[new u.V(v,r,`array expected, ${u.J(r)} found`)];if(l.length&&r.length!==l.length)return[new u.V(v,r,`array length ${l.length} expected, length ${r.length} found`)];if(l["min-length"]&&r.length<l["min-length"])return[new u.V(v,r,`array length at least ${l["min-length"]} expected, length ${r.length} found`)];let S={type:l.value,values:l.values,minimum:l.minimum,maximum:l.maximum,function:void 0};_.$version<7&&(S.function=l.function),"object"===u.J(l.value)&&(S=l.value);let I=[];for(let P=0;P<r.length;P++)I=I.concat(b({array:r,arrayIndex:P,value:r[P],valueSpec:S,style:p,styleSpec:_,key:`${v}[${P}]`},!0));return I}function Ad(f){const r=f.key,l=f.value,p=f.valueSpec;let _=u.J(l);if("number"===_&&l!=l&&(_="NaN"),"number"!==_)return[new u.V(r,l,`number expected, ${_} found`)];if("minimum"in p){let v=p.minimum;if("array"===u.J(p.minimum)&&(v=p.minimum[f.arrayIndex]),l<v)return[new u.V(r,l,`${l} is less than the minimum value ${v}`)]}if("maximum"in p){let v=p.maximum;if("array"===u.J(p.maximum)&&(v=p.maximum[f.arrayIndex]),l>v)return[new u.V(r,l,`${l} is greater than the maximum value ${v}`)]}return[]}function Na(f){const r=f.valueSpec,l=u.M(f.value.type);let p,_,v,b={};const S="categorical"!==l&&void 0===f.value.property,I=!S,P="array"===u.J(f.value.stops)&&"array"===u.J(f.value.stops[0])&&"object"===u.J(f.value.stops[0][0]),R=Xo({key:f.key,value:f.value,valueSpec:f.styleSpec.function,style:f.style,styleSpec:f.styleSpec,objectElementValidators:{stops:function(B){if("identity"===l)return[new u.V(B.key,B.value,'identity function may not have a "stops" property')];let H=[];const U=B.value;return H=H.concat(Al({key:B.key,value:U,valueSpec:B.valueSpec,style:B.style,styleSpec:B.styleSpec,arrayElementValidator:z})),"array"===u.J(U)&&0===U.length&&H.push(new u.V(B.key,U,"array must have at least one stop")),H},default:function(B){return Ti({key:B.key,value:B.value,valueSpec:r,style:B.style,styleSpec:B.styleSpec})}}});return"identity"===l&&S&&R.push(new u.V(f.key,f.value,'missing required property "property"')),"identity"===l||f.value.stops||R.push(new u.V(f.key,f.value,'missing required property "stops"')),"exponential"===l&&f.valueSpec.expression&&!u.N(f.valueSpec)&&R.push(new u.V(f.key,f.value,"exponential functions not supported")),f.styleSpec.$version>=8&&(I&&!u.O(f.valueSpec)?R.push(new u.V(f.key,f.value,"property functions not supported")):S&&!u.Q(f.valueSpec)&&R.push(new u.V(f.key,f.value,"zoom functions not supported"))),"categorical"!==l&&!P||void 0!==f.value.property||R.push(new u.V(f.key,f.value,'"property" property is required')),R;function z(B){let H=[];const U=B.value,q=B.key;if("array"!==u.J(U))return[new u.V(q,U,`array expected, ${u.J(U)} found`)];if(2!==U.length)return[new u.V(q,U,`array length 2 expected, length ${U.length} found`)];if(P){if("object"!==u.J(U[0]))return[new u.V(q,U,`object expected, ${u.J(U[0])} found`)];if(void 0===U[0].zoom)return[new u.V(q,U,"object stop key must have zoom")];if(void 0===U[0].value)return[new u.V(q,U,"object stop key must have value")];const G=u.M(U[0].zoom);if("number"!=typeof G)return[new u.V(q,U[0].zoom,"stop zoom values must be numbers")];if(v&&v>G)return[new u.V(q,U[0].zoom,"stop zoom values must appear in ascending order")];G!==v&&(v=G,_=void 0,b={}),H=H.concat(Xo({key:`${q}[0]`,value:U[0],valueSpec:{zoom:{}},style:B.style,styleSpec:B.styleSpec,objectElementValidators:{zoom:Ad,value:L}}))}else H=H.concat(L({key:`${q}[0]`,value:U[0],style:B.style,styleSpec:B.styleSpec},U));return u.S(u.U(U[1]))?H.concat([new u.V(`${q}[1]`,U[1],"expressions are not allowed in function stops.")]):H.concat(Ti({key:`${q}[1]`,value:U[1],valueSpec:r,style:B.style,styleSpec:B.styleSpec}))}function L(B,H){const U=u.J(B.value),q=u.M(B.value),G=null!==B.value?B.value:H;if(p){if(U!==p)return[new u.V(B.key,G,`${U} stop domain type must match previous stop domain type ${p}`)]}else p=U;if("number"!==U&&"string"!==U&&"boolean"!==U&&"number"!=typeof q&&"string"!=typeof q&&"boolean"!=typeof q)return[new u.V(B.key,G,"stop domain value must be a number, string, or boolean")];if("number"!==U&&"categorical"!==l){let Y=`number expected, ${U} found`;return u.O(r)&&void 0===l&&(Y+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new u.V(B.key,G,Y)]}return"categorical"!==l||"number"!==U||"number"==typeof q&&isFinite(q)&&Math.floor(q)===q?"categorical"!==l&&"number"===U&&"number"==typeof q&&"number"==typeof _&&void 0!==_&&q<_?[new u.V(B.key,G,"stop domain values must appear in ascending order")]:(_=q,"categorical"===l&&q in b?[new u.V(B.key,G,"stop domain values must be unique")]:(b[q]=!0,[])):[new u.V(B.key,G,`integer expected, found ${String(q)}`)]}}function Ms(f){const r=("property"===f.expressionContext?u.W:u.X)(u.U(f.value),f.valueSpec);if("error"===r.result)return r.value.map(p=>new u.V(`${f.key}${p.key}`,f.value,p.message));const l=r.value.expression||r.value._styleExpression.expression;if("property"===f.expressionContext&&"text-font"===f.propertyKey&&!l.outputDefined())return[new u.V(f.key,f.value,`Invalid data expression for "${f.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===f.expressionContext&&"layout"===f.propertyType&&!u.Y(l))return[new u.V(f.key,f.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===f.expressionContext)return ms(l,f);if(f.expressionContext&&0===f.expressionContext.indexOf("cluster")){if(!u.Z(l,["zoom","feature-state"]))return[new u.V(f.key,f.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===f.expressionContext&&!u._(l))return[new u.V(f.key,f.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ms(f,r){const l=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(r.valueSpec&&r.valueSpec.expression)for(const _ of r.valueSpec.expression.parameters)l.delete(_);if(0===l.size)return[];const p=[];return f instanceof u.$&&l.has(f.name)?[new u.V(r.key,r.value,`["${f.name}"] expression is not supported in a filter for a ${r.object.type} layer with id: ${r.object.id}`)]:(f.eachChild(_=>{p.push(...ms(_,r))}),p)}function Ba(f){const r=f.key,l=f.value,p=f.valueSpec,_=[];return Array.isArray(p.values)?-1===p.values.indexOf(u.M(l))&&_.push(new u.V(r,l,`expected one of [${p.values.join(", ")}], ${JSON.stringify(l)} found`)):-1===Object.keys(p.values).indexOf(u.M(l))&&_.push(new u.V(r,l,`expected one of [${Object.keys(p.values).join(", ")}], ${JSON.stringify(l)} found`)),_}function Ta(f){return u.a1(u.U(f.value))?Ms(u.L({},f,{expressionContext:"filter",valueSpec:f.styleSpec[`filter_${f.layerType||"fill"}`]})):mc(f)}function mc(f){const r=f.value,l=f.key;if("array"!==u.J(r))return[new u.V(l,r,`array expected, ${u.J(r)} found`)];const p=f.styleSpec;let _,v=[];if(r.length<1)return[new u.V(l,r,"filter array must have at least 1 element")];switch(v=v.concat(Ba({key:`${l}[0]`,value:r[0],valueSpec:p.filter_operator,style:f.style,styleSpec:f.styleSpec})),u.M(r[0])){case"<":case"<=":case">":case">=":r.length>=2&&"$type"===u.M(r[1])&&v.push(new u.V(l,r,`"$type" cannot be use with operator "${r[0]}"`));case"==":case"!=":3!==r.length&&v.push(new u.V(l,r,`filter array for operator "${r[0]}" must have 3 elements`));case"in":case"!in":r.length>=2&&(_=u.J(r[1]),"string"!==_&&v.push(new u.V(`${l}[1]`,r[1],`string expected, ${_} found`)));for(let b=2;b<r.length;b++)_=u.J(r[b]),"$type"===u.M(r[1])?v=v.concat(Ba({key:`${l}[${b}]`,value:r[b],valueSpec:p.geometry_type,style:f.style,styleSpec:f.styleSpec})):"string"!==_&&"number"!==_&&"boolean"!==_&&v.push(new u.V(`${l}[${b}]`,r[b],`string, number, or boolean expected, ${_} found`));break;case"any":case"all":case"none":for(let b=1;b<r.length;b++)v=v.concat(mc({key:`${l}[${b}]`,value:r[b],style:f.style,styleSpec:f.styleSpec}));break;case"has":case"!has":_=u.J(r[1]),2!==r.length?v.push(new u.V(l,r,`filter array for "${r[0]}" operator must have 2 elements`)):"string"!==_&&v.push(new u.V(`${l}[1]`,r[1],`string expected, ${_} found`))}return v}function Ml(f,r){const l=f.key,p=f.style,_=f.layer,v=f.styleSpec,b=f.value,S=f.objectKey,I=v[`${r}_${f.layerType}`];if(!I)return[];const P=S.match(/^(.*)-use-theme$/);if("paint"===r&&P&&I[P[1]])return u.S(b)?[].concat(Ti({key:f.key,value:b,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:p,styleSpec:v,expressionContext:"property",propertyType:r,propertyKey:S})):Ti({key:l,value:b,valueSpec:{type:"string"},style:p,styleSpec:v});const R=S.match(/^(.*)-transition$/);if("paint"===r&&R&&I[R[1]]&&I[R[1]].transition)return Ti({key:l,value:b,valueSpec:v.transition,style:p,styleSpec:v});const z=f.valueSpec||I[S];if(!z)return[new u.K(l,b,`unknown property "${S}"`)];let L;if("string"===u.J(b)&&u.O(z)&&!z.tokens&&(L=/^{([^}]+)}$/.exec(b))){const H=`\`{ "type": "identity", "property": ${L?JSON.stringify(L[1]):'"_"'} }\``;return[new u.V(l,b,`"${S}" does not support interpolation syntax\nUse an identity property function instead: ${H}.`)]}const B=[];if("symbol"===f.layerType)"text-field"!==S||!p||p.glyphs||p.imports||B.push(new u.V(l,b,'use of "text-field" requires a style "glyphs" property')),"text-font"===S&&u.a2(u.U(b))&&"identity"===u.M(b.type)&&B.push(new u.V(l,b,'"text-font" does not support identity functions'));else if("model"===f.layerType&&"paint"===r&&_&&_.layout&&_.layout.hasOwnProperty("model-id")&&u.O(z)&&(u.a3(z)||u.Q(z))){const H=u.W(u.U(b),z),U=H.value.expression||H.value._styleExpression.expression;U&&!u.Z(U,["measure-light"])&&("model-emissive-strength"===S&&u._(U)&&u.Y(U)||B.push(new u.V(l,b,`${S} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return B.concat(Ti({key:f.key,value:b,valueSpec:z,style:p,styleSpec:v,expressionContext:"property",propertyType:r,propertyKey:S}))}function Yo(f){return Ml(f,"paint")}function Ko(f){return Ml(f,"layout")}function bu(f){let r=[];const l=f.value,p=f.key,_=f.style,v=f.styleSpec;l.type||l.ref||r.push(new u.V(p,l,'either "type" or "ref" is required'));let b=u.M(l.type);const S=u.M(l.ref);if(l.id){const I=u.M(l.id);for(let P=0;P<f.arrayIndex;P++){const R=_.layers[P];u.M(R.id)===I&&r.push(new u.V(p,l.id,`duplicate layer id "${l.id}", previously used at line ${R.id.__line__}`))}}if("ref"in l){let I;["type","source","source-layer","filter","layout"].forEach(P=>{P in l&&r.push(new u.V(p,l[P],`"${P}" is prohibited for ref layers`))}),_.layers.forEach(P=>{u.M(P.id)===S&&(I=P)}),I?I.ref?r.push(new u.V(p,l.ref,"ref cannot reference another ref layer")):b=u.M(I.type):"string"==typeof S&&r.push(new u.V(p,l.ref,`ref layer "${S}" not found`))}else if("background"!==b&&"sky"!==b&&"slot"!==b)if(l.source){const I=_.sources&&_.sources[l.source],P=I&&u.M(I.type);I?"vector"===P&&"raster"===b?r.push(new u.V(p,l.source,`layer "${l.id}" requires a raster source`)):"raster"===P&&"raster"!==b?r.push(new u.V(p,l.source,`layer "${l.id}" requires a vector source`)):"vector"!==P||l["source-layer"]?"raster-dem"===P&&"hillshade"!==b?r.push(new u.V(p,l.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==P||["raster","raster-particle"].includes(b)?"line"===b&&l.paint&&(l.paint["line-gradient"]||l.paint["line-trim-offset"])&&"geojson"===P&&!I.lineMetrics?r.push(new u.V(p,l,`layer "${l.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):"raster-particle"===b&&"raster-array"!==P&&r.push(new u.V(p,l.source,`layer "${l.id}" requires a 'raster-array' source.`)):r.push(new u.V(p,l.source,"raster-array source can only be used with layer type 'raster'.")):r.push(new u.V(p,l,`layer "${l.id}" must specify a "source-layer"`)):r.push(new u.V(p,l.source,`source "${l.source}" not found`))}else r.push(new u.V(p,l,'missing required property "source"'));return r=r.concat(Xo({key:p,value:l,valueSpec:v.layer,style:f.style,styleSpec:f.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Ti({key:`${p}.type`,value:l.type,valueSpec:v.layer.type,style:f.style,styleSpec:f.styleSpec,object:l,objectKey:"type"}),filter:I=>Ta(u.L({layerType:b},I)),layout:I=>Xo({layer:l,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":P=>Ko(u.L({layerType:b},P))}}),paint:I=>Xo({layer:l,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":P=>Yo(u.L({layerType:b,layer:l},P))}})}})),r}function Va(f){const r=f.value,l=f.key,p=u.J(r);return"string"!==p?[new u.V(l,r,`string expected, ${p} found`)]:[]}const wu={promoteId:function f({key:r,value:l}){if("string"===u.J(l))return Va({key:r,value:l});if(Array.isArray(l)){const p=[],_=u.U(l),v=u.X(_);return"error"===v.result&&v.value.forEach(b=>{p.push(new u.V(`${r}${b.key}`,null,`${b.message}`))}),u.Z(v.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||p.push(new u.V(`${r}`,null,"promoteId expression should be only feature dependent")),p}{const p=[];for(const _ in l)p.push(...f({key:`${r}.${_}`,value:l[_]}));return p}}};function So(f){const r=f.value,l=f.key,p=f.styleSpec,_=f.style;if(!r.type)return[new u.V(l,r,'"type" is required')];const v=u.M(r.type);let b=[];switch(["vector","raster","raster-dem","raster-array"].includes(v)&&(r.url||r.tiles||b.push(new u.K(l,r,'Either "url" or "tiles" is required.'))),v){case"vector":case"raster":case"raster-dem":case"raster-array":return b=b.concat(Xo({key:l,value:r,valueSpec:p[`source_${v.replace("-","_")}`],style:f.style,styleSpec:p,objectElementValidators:wu})),b;case"geojson":if(b=Xo({key:l,value:r,valueSpec:p.source_geojson,style:_,styleSpec:p,objectElementValidators:wu}),r.cluster)for(const S in r.clusterProperties){const[I,P]=r.clusterProperties[S],R="string"==typeof I?[I,["accumulated"],["get",S]]:I;b.push(...Ms({key:`${l}.${S}.map`,value:P,expressionContext:"cluster-map"})),b.push(...Ms({key:`${l}.${S}.reduce`,value:R,expressionContext:"cluster-reduce"}))}return b;case"video":return Xo({key:l,value:r,valueSpec:p.source_video,style:_,styleSpec:p});case"image":return Xo({key:l,value:r,valueSpec:p.source_image,style:_,styleSpec:p});case"canvas":return[new u.V(l,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Ba({key:`${l}.type`,value:r.type,valueSpec:{values:Gr(p)}})}}function Gr(f){return f.source.reduce((r,l)=>{const p=f[l];return"enum"===p.type.type&&(r=r.concat(Object.keys(p.type.values))),r},[])}function ja(f){const r=f.value,l=f.styleSpec,p=l.light,_=f.style;let v=[];const b=u.J(r);if(void 0===r)return v;if("object"!==b)return v=v.concat([new u.V("light",r,`object expected, ${b} found`)]),v;for(const S in r){const I=S.match(/^(.*)-transition$/),P=S.match(/^(.*)-use-theme$/);v=v.concat(P&&p[P[1]]?Ti({key:S,value:r[S],valueSpec:{type:"string"},style:_,styleSpec:l}):I&&p[I[1]]&&p[I[1]].transition?Ti({key:S,value:r[S],valueSpec:l.transition,style:_,styleSpec:l}):p[S]?Ti({key:S,value:r[S],valueSpec:p[S],style:_,styleSpec:l}):[new u.V(S,r[S],`unknown property "${S}"`)])}return v}function Ua(f){const r=f.value;let l=[];if(!r)return l;const p=u.J(r);if("object"!==p)return l=l.concat([new u.V("light-3d",r,`object expected, ${p} found`)]),l;const _=f.styleSpec,v=_["light-3d"],b=f.key,S=f.style,I=f.style.lights;for(const z of["type","id"])if(!(z in r))return l=l.concat([new u.V("light-3d",r,`missing property ${z} on light`)]),l;if(r.type&&I)for(let z=0;z<f.arrayIndex;z++){const L=u.M(r.type),B=I[z];u.M(B.type)===L&&l.push(new u.V(b,r.id,`duplicate light type "${r.type}", previously defined at line ${B.id.__line__}`))}const P=`properties_light_${r.type}`;if(!(P in _))return l=l.concat([new u.V("light-3d",r,`Invalid light type ${r.type}`)]),l;const R=_[P];for(const z in r)if("properties"===z){const L=r[z],B=u.J(L);if("object"!==B)return l=l.concat([new u.V("properties",L,`object expected, ${B} found`)]),l;for(const H in L){const U=H.match(/^(.*)-transition$/),q=H.match(/^(.*)-use-theme$/);l=l.concat(q&&R[q[1]]?Ti({key:z,value:L[H],valueSpec:{type:"string"},style:S,styleSpec:_}):U&&R[U[1]]&&R[U[1]].transition?Ti({key:z,value:r[z],valueSpec:_.transition,style:S,styleSpec:_}):R[H]?Ti({key:H,value:L[H],valueSpec:R[H],style:S,styleSpec:_}):[new u.K(f.key,L[H],`unknown property "${H}"`)])}}else l=l.concat(v[z]?Ti({key:z,value:r[z],valueSpec:v[z],style:S,styleSpec:_}):[new u.K(z,r[z],`unknown property "${z}"`)]);return l}function Ha(f){const r=f.value,l=f.key,p=f.style,_=f.styleSpec,v=_.terrain;let b=[];const S=u.J(r);if(void 0===r||"null"===S)return b;if("object"!==S)return b=b.concat([new u.V("terrain",r,`object expected, ${S} found`)]),b;for(const I in r){const P=I.match(/^(.*)-transition$/),R=I.match(/^(.*)-use-theme$/);b=b.concat(R&&v[R[1]]?Ti({key:I,value:r[I],valueSpec:{type:"string"},style:p,styleSpec:_}):P&&v[P[1]]&&v[P[1]].transition?Ti({key:I,value:r[I],valueSpec:_.transition,style:p,styleSpec:_}):v[I]?Ti({key:I,value:r[I],valueSpec:v[I],style:p,styleSpec:_}):[new u.K(I,r[I],`unknown property "${I}"`)])}if(r.source){const I=p.sources&&p.sources[r.source],P=I&&u.M(I.type);I?"raster-dem"!==P&&b.push(new u.V(l,r.source,`terrain cannot be used with a source of type ${String(P)}, it only be used with a "raster-dem" source type`)):b.push(new u.V(l,r.source,`source "${r.source}" not found`))}else b.push(new u.V(l,r,'terrain is missing required property "source"'));return b}function Pl(f){const r=f.value,l=f.style,p=f.styleSpec,_=p.fog;let v=[];const b=u.J(r);if(void 0===r)return v;if("object"!==b)return v=v.concat([new u.V("fog",r,`object expected, ${b} found`)]),v;for(const S in r){const I=S.match(/^(.*)-transition$/),P=S.match(/^(.*)-use-theme$/);v=v.concat(P&&_[P[1]]?Ti({key:S,value:r[S],valueSpec:{type:"string"},style:l,styleSpec:p}):I&&_[I[1]]&&_[I[1]].transition?Ti({key:S,value:r[S],valueSpec:p.transition,style:l,styleSpec:p}):_[S]?Ti({key:S,value:r[S],valueSpec:_[S],style:l,styleSpec:p}):[new u.K(S,r[S],`unknown property "${S}"`)])}return v}const Eu={"*":()=>[],array:Al,boolean:function(f){const r=f.value,l=f.key,p=u.J(r);return"boolean"!==p?[new u.V(l,r,`boolean expected, ${p} found`)]:[]},number:Ad,color:function(f){const r=f.key,l=f.value,p=u.J(l);return"string"!==p?[new u.V(r,l,`color expected, ${p} found`)]:null===u.a0.parseCSSColor(l)?[new u.V(r,l,`color expected, "${l}" found`)]:[]},enum:Ba,filter:Ta,function:Na,layer:bu,object:Xo,source:So,model:u.a4,light:ja,"light-3d":Ua,terrain:Ha,fog:Pl,string:Va,formatted:function(f){return 0===Va(f).length?[]:Ms(f)},resolvedImage:function(f){return 0===Va(f).length?[]:Ms(f)},projection:function(f){const r=f.value,l=f.styleSpec,p=l.projection,_=f.style;let v=[];const b=u.J(r);if("object"===b)for(const S in r)v=v.concat(Ti({key:S,value:r[S],valueSpec:p[S],style:_,styleSpec:l}));else"string"!==b&&(v=v.concat([new u.V("projection",r,`object or string expected, ${b} found`)]));return v},import:function(f){const{value:r,styleSpec:l}=f,{data:p,..._}=r;Object.defineProperty(_,"__line__",{value:r.__line__,enumerable:!1});let v=Xo(u.L({},f,{value:_,valueSpec:l.import}));return""===u.M(_.id)&&v.push(new u.V(`${f.key}.id`,_,"import id can't be an empty string")),p&&(v=v.concat(Pd(p,l,{key:`${f.key}.data`}))),v},iconset:function(f){const r=f.value,l=f.key,p=f.styleSpec,_=f.style;if(!r.type)return[new u.V(l,r,'"type" is required')];const v=u.M(r.type);let b=[];if(b=b.concat(Xo({key:l,value:r,valueSpec:p[`iconset_${v}`],style:_,styleSpec:p})),"source"===v&&r.source){const S=_.sources&&_.sources[r.source],I=S&&u.M(S.type);S?"raster-array"!==I&&b.push(new u.V(l,r.source,`iconset cannot be used with a source of type ${String(I)}, it only be used with a "raster-array" source type`)):b.push(new u.V(l,r.source,`source "${r.source}" not found`))}return b}};function Ti(f,r=!1){const l=f.value,p=f.valueSpec,_=f.styleSpec;if(p.expression&&u.a2(u.M(l)))return Na(f);if(p.expression&&u.S(u.U(l)))return Ms(f);if(p.type&&Eu[p.type]){const v=Eu[p.type](f);return!0===r&&v.length>0&&"array"===u.J(f.value)?Ms(f):v}return Xo(u.L({},f,{valueSpec:p.type?_[p.type]:p}))}function Md(f){const r=f.value,l=f.key,p=Va(f);return p.length||(-1===r.indexOf("{fontstack}")&&p.push(new u.V(l,r,'"glyphs" url must include a "{fontstack}" token')),-1===r.indexOf("{range}")&&p.push(new u.V(l,r,'"glyphs" url must include a "{range}" token'))),p}function Pd(f,r=u.a5,l={}){return Ti({key:l.key||"",value:f,valueSpec:r.$root,styleSpec:r,style:f,objectElementValidators:{glyphs:Md,"*":()=>[]}})}function Ps(f,r=u.a5){return ge(Pd(f,r))}const Rd=f=>ge(So(f)),Rp=f=>ge(ja(f)),Tu=f=>ge(Ua(f)),Je=f=>ge(Ha(f)),Ga=f=>ge(Pl(f)),Op=f=>ge(function(r){const l=r.value,p=r.style,_=r.styleSpec,v=_.snow;let b=[];const S=u.J(l);if(void 0===l)return b;if("object"!==S)return b=b.concat([new u.V("snow",l,`object expected, ${S} found`)]),b;for(const I in l){const P=I.match(/^(.*)-transition$/);b=b.concat(P&&v[P[1]]&&v[P[1]].transition?Ti({key:I,value:l[I],valueSpec:_.transition,style:p,styleSpec:_}):v[I]?Ti({key:I,value:l[I],valueSpec:v[I],style:p,styleSpec:_}):[new u.K(I,l[I],`unknown property "${I}"`)])}return b}(f)),sf=f=>ge(function(r){const l=r.value,p=r.style,_=r.styleSpec,v=_.rain;let b=[];const S=u.J(l);if(void 0===l)return b;if("object"!==S)return b=b.concat([new u.V("rain",l,`object expected, ${S} found`)]),b;for(const I in l){const P=I.match(/^(.*)-transition$/);b=b.concat(P&&v[P[1]]&&v[P[1]].transition?Ti({key:I,value:l[I],valueSpec:_.transition,style:p,styleSpec:_}):v[I]?Ti({key:I,value:l[I],valueSpec:v[I],style:p,styleSpec:_}):[new u.K(I,l[I],`unknown property "${I}"`)])}return b}(f)),Pn=f=>ge(bu(f)),Pe=f=>ge(Ta(f)),Z=f=>ge(Yo(f)),X=f=>ge(Ko(f)),oe=f=>ge(u.a4(f));function ge(f){return f.slice().sort((r,l)=>r.line&&l.line?r.line-l.line:0)}function se(f,r){let l=!1;if(r&&r.length)for(const p of r)p instanceof u.K?u.w(p.message):(f.fire(new u.z(new Error(p.message))),l=!0);return l}let be;class ke extends u.E{constructor(r,l="flat"){super(),this._transitionable=new u.a6(be||(be=new u.a7({anchor:new u.a8(u.a5.light.anchor),position:new u.a9(u.a5.light.position),color:new u.a8(u.a5.light.color),intensity:new u.a8(u.a5.light.intensity)}))),this.setLight(r,l),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(r,l,p={}){this._validate(Rp,r,p)||(this._transitionable.setTransitionOrValue(r),this.id=l)}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}_validate(r,l,p){return(!p||!1!==p.validate)&&se(this,r.call(Ps,u.h({value:l,style:{glyphs:!0,sprite:!0},styleSpec:u.a5})))}}let Te=class extends u.E{constructor(f,r,l,p,_){super(),this.scope=l,this._transitionable=new u.a6(new u.a7({source:new u.a8(u.a5.terrain.source),exaggeration:new u.a8(u.a5.terrain.exaggeration)}),l,p),this._transitionable.setTransitionOrValue(f,p),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=r,this.worldview=_}get(){return this._transitionable.serialize()}set(f,r){this._transitionable.setTransitionOrValue(f,r)}updateTransitions(f){this._transitioning=this._transitionable.transitioned(f,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(f){this.properties=this._transitioning.possiblyEvaluate(f)}getExaggeration(f){return this._transitioning.possiblyEvaluate(new u.aa(f,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const f=this._transitionable._values.exaggeration;if(!f)return null;const r=f.value.expression;if(!r)return null;let l=-1,p=-1,_=1;for(const v of r.zoomStops)_=r.evaluate(new u.aa(v,{worldview:this.worldview})),_>.01?(l=v,p=-1):p=v;return _<.01&&l>0&&p>l?[l,p]:null}isZoomDependent(){const f=this._transitionable._values.exaggeration;return null!=f&&null!=f.value&&null!=f.value.expression&&f.value.expression instanceof u.ab}};const Ae=45,st=65,qe=.05;function kt(f,r,l,p){const _=u.af(Ae,st,l),[v,b]=Gt(f,p);let S=1-Math.min(1,Math.exp((r-v)/(b-v)*-6));return S*=S*S,S=Math.min(1,1.00747*S),S*_*f.alpha}function Gt(f,r){const l=.5/Math.tan(.5*r);return[f.range[0]+l,f.range[1]+l]}function Wt(f,r,l,p,_){const v=u.ad([],[r,l,p],_.mercatorFogMatrix);return kt(f,u.ae(v),_.pitch,_._fov)}function bn(f,r,l,p,_,v,b){const S=[[l,p,0],[_,p,0],[_,v,0],[l,v,0]];let I=Number.MAX_VALUE,P=-Number.MAX_VALUE;for(const R of S){const z=u.ad([],R,r),L=u.ae(z);I=Math.min(I,L),P=Math.max(P,L)}return[kt(f,I,b.pitch,b._fov),kt(f,P,b.pitch,b._fov)]}class pn extends u.E{constructor(r,l,p,_){super();const v=new u.a7({range:new u.a8(u.a5.fog.range),color:new u.a8(u.a5.fog.color),"color-use-theme":new u.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new u.a8(u.a5.fog["high-color"]),"high-color-use-theme":new u.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new u.a8(u.a5.fog["space-color"]),"space-color-use-theme":new u.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new u.a8(u.a5.fog["horizon-blend"]),"star-intensity":new u.a8(u.a5.fog["star-intensity"]),"vertical-range":new u.a8(u.a5.fog["vertical-range"])});this._transitionable=new u.a6(v,p,new Map(_)),this.set(r,_),this._transitioning=this._transitionable.untransitioned(),this._transform=l,this.properties=new u.ag(v),this.scope=p}get state(){const r=this._transform,l="globe"===r.projection.name,p=u.ah(r.zoom),_=this.properties.get("range"),v=[.5,3];return{range:l?[u.ai(v[0],_[0],p),u.ai(v[1],_[1],p)]:_,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(r,l,p={}){if(this._validate(Ga,r,p))return;const _=u.h({},r);for(const v of Object.keys(u.a5.fog))void 0===_[v]&&(_[v]=u.a5.fog[v].default);this._options=_,this._transitionable.setTransitionOrValue(this._options,l)}getOpacity(r){if(!this._transform.projection.supportsFog)return 0;const l=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:u.af(Ae,st,r))*l.a}getOpacityAtLatLng(r,l){return this._transform.projection.supportsFog?function(p,_,v){const b=u.ac.fromLngLat(_),S=v.elevation?v.elevation.getAtPointOrZero(b):0;return Wt(p,b.x,b.y,S,v)}(this.state,r,l):0}getOpacityForTile(r){if(!this._transform.projection.supportsFog)return[1,1];const l=this._transform.calculateFogTileMatrix(r.toUnwrapped());return bn(this.state,l,0,0,u.aj,u.aj,this._transform)}getOpacityForBounds(r,l,p,_,v){return this._transform.projection.supportsFog?bn(this.state,r,l,p,_,v,this._transform):[1,1]}getFovAdjustedRange(r){return this._transform.projection.supportsFog?Gt(this.state,r):[0,1]}isVisibleOnFrustum(r){if(!this._transform.projection.supportsFog)return!1;const l=[4,5,6,7];for(const p of l){const _=r.points[p];let v;if(_[2]>=0)v=_;else{const b=r.points[p-4];v=u.ak(b,_,b[2]/(b[2]-_[2]))}if(Wt(this.state,v[0],v[1],0,this._transform)>=qe)return!0}return!1}updateConfig(r){this._transitionable.setTransitionOrValue(this._options,new Map(r))}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}_validate(r,l,p){return(!p||!1!==p.validate)&&se(this,r.call(Ps,u.h({value:l,style:{glyphs:!0,sprite:!0},styleSpec:u.a5})))}}let cn,pi,yn,Qi,wr=class extends u.E{constructor(f,r,l,p){super();const _=cn||(cn=new u.a7({density:new u.a8(u.a5.snow.density),intensity:new u.a8(u.a5.snow.intensity),color:new u.a8(u.a5.snow.color),opacity:new u.a8(u.a5.snow.opacity),vignette:new u.a8(u.a5.snow.vignette),"vignette-color":new u.a8(u.a5.snow["vignette-color"]),"center-thinning":new u.a8(u.a5.snow["center-thinning"]),direction:new u.a8(u.a5.snow.direction),"flake-size":new u.a8(u.a5.snow["flake-size"])}));this._transitionable=new u.a6(_,l,new Map(p)),this.set(f,p),this._transitioning=this._transitionable.untransitioned(),this.properties=new u.ag(_),this.scope=l}get state(){const f=this.properties.get("opacity"),r=this.properties.get("color"),l=this.properties.get("direction"),p=u.al(l[0]),_=-Math.max(u.al(l[1]),.01),v=[Math.cos(p)*Math.cos(_),Math.sin(p)*Math.cos(_),Math.sin(_)],b=this.properties.get("vignette"),S=this.properties.get("vignette-color");return S.a=b,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new u.am(r.r,r.g,r.b,r.a*f),direction:v,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:S}}get(){return this._transitionable.serialize()}set(f,r,l={}){if(this._validate(Op,f,l))return;const p=u.h({},f);for(const _ of Object.keys(u.a5.snow))void 0===p[_]&&(p[_]=u.a5.snow[_].default);this._options=p,this._transitionable.setTransitionOrValue(this._options,r)}updateConfig(f){this._transitionable.setTransitionOrValue(this._options,new Map(f))}updateTransitions(f){this._transitioning=this._transitionable.transitioned(f,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(f){this.properties=this._transitioning.possiblyEvaluate(f)}_validate(f,r,l){return(!l||!1!==l.validate)&&se(this,f.call(Ps,u.h({value:r,style:{glyphs:!0,sprite:!0},styleSpec:u.a5})))}},Pr=class extends u.E{constructor(f,r,l,p){super();const _=pi||(pi=new u.a7({density:new u.a8(u.a5.rain.density),intensity:new u.a8(u.a5.rain.intensity),color:new u.a8(u.a5.rain.color),opacity:new u.a8(u.a5.rain.opacity),vignette:new u.a8(u.a5.rain.vignette),"vignette-color":new u.a8(u.a5.rain["vignette-color"]),"center-thinning":new u.a8(u.a5.rain["center-thinning"]),direction:new u.a8(u.a5.rain.direction),"droplet-size":new u.a8(u.a5.rain["droplet-size"]),"distortion-strength":new u.a8(u.a5.rain["distortion-strength"])}));this._transitionable=new u.a6(_,l,new Map(p)),this.set(f,p),this._transitioning=this._transitionable.untransitioned(),this.properties=new u.ag(_),this.scope=l}get state(){const f=this.properties.get("opacity"),r=this.properties.get("color"),l=this.properties.get("direction"),p=u.al(l[0]),_=-Math.max(u.al(l[1]),.01),v=[Math.cos(p)*Math.cos(_),Math.sin(p)*Math.cos(_),Math.sin(_)],b=this.properties.get("vignette-color");return b.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new u.am(r.r,r.g,r.b,r.a*f),direction:v,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:b}}get(){return this._transitionable.serialize()}set(f,r,l={}){if(this._validate(sf,f,l))return;const p=u.h({},f);for(const _ of Object.keys(u.a5.rain))void 0===p[_]&&(p[_]=u.a5.rain[_].default);this._options=p,this._transitionable.setTransitionOrValue(this._options,r)}updateConfig(f){this._transitionable.setTransitionOrValue(this._options,new Map(f))}updateTransitions(f){this._transitioning=this._transitionable.transitioned(f,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(f){this.properties=this._transitioning.possiblyEvaluate(f)}_validate(f,r,l){return(!l||!1!==l.validate)&&se(this,f.call(Ps,u.h({value:r,style:{glyphs:!0,sprite:!0},styleSpec:u.a5})))}};class li extends u.E{constructor(r,l,p,_){super(),this.scope=p,this._options=r,this.properties=new u.ag(l),this._transitionable=new u.a6(l,p,new Map(_)),this._transitionable.setTransitionOrValue(r.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(r){this._transitionable.setTransitionOrValue(this._options.properties,new Map(r))}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(r,l){this._options=r,this._transitionable.setTransitionOrValue(r.properties,l)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}class Bn{constructor(r,l,p){this.screenBounds=r,this.cameraPoint=p.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=l,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,p)}static createFromScreenPoints(r,l){let p,_;if(r instanceof u.P||"number"==typeof r[0]){const v=u.P.convert(r);p=[v],_=l.isPointAboveHorizon(v)}else{const v=u.P.convert(r[0]),b=u.P.convert(r[1]),S=v.add(b)._div(2);p=[v,b],_=u.ao(v,b).every(I=>l.isPointAboveHorizon(I))&&l.isPointAboveHorizon(S)}return new Bn(p,_,l)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(r){return u.ao(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],r)}bufferedCameraGeometry(r){const l=this.screenBounds[0],p=1===this.screenBounds.length?this.screenBounds[0].add(new u.P(1,1)):this.screenBounds[1],_=u.ao(l,p,0,!1);return this.cameraPoint.y>p.y&&(this.cameraPoint.x>l.x&&this.cameraPoint.x<p.x?_.splice(3,0,this.cameraPoint):this.cameraPoint.x>=p.x?_[2]=this.cameraPoint:this.cameraPoint.x<=l.x&&(_[3]=this.cameraPoint)),u.ap(_,r)}bufferedCameraGeometryGlobe(r){const l=this.screenBounds[0],p=1===this.screenBounds.length?this.screenBounds[0].add(new u.P(1,1)):this.screenBounds[1],_=u.ao(l,p,r),v=this.cameraPoint.clone();switch(3*((v.y>l.y)+(v.y>p.y))+((v.x>l.x)+(v.x>p.x))){case 0:_[0]=v,_[4]=v.clone();break;case 1:_.splice(1,0,v);break;case 2:_[1]=v;break;case 3:_.splice(4,0,v);break;case 5:_.splice(2,0,v);break;case 6:_[3]=v;break;case 7:_.splice(3,0,v);break;case 8:_[2]=v}return _}containsTile(r,l,p,_=0){const v=r.queryPadding/l._pixelsPerMercatorPixel+1,b=p?this._bufferedCameraMercator(v,l):this._bufferedScreenMercator(v,l);let S=r.tileID.wrap+(b.unwrapped?_:0);const I=b.polygon.map(q=>u.aq(r.tileTransform,q,S));if(!u.ar(I,0,0,u.aj,u.aj))return;S=r.tileID.wrap+(this.screenGeometryMercator.unwrapped?_:0);const P=this.screenGeometryMercator.polygon.map(q=>u.as(r.tileTransform,q,S)),R=P.map(q=>new u.P(q[0],q[1])),z=l.getFreeCameraOptions().position||new u.ac(0,0,0),L=u.as(r.tileTransform,z,S),B=P.map(q=>{const G=u.at(q,q,L);return u.au(G,G),new u.av(L,G)}),H=u.aw(r,1,l.zoom)*l._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:R,tilespaceRays:B,bufferedTilespaceGeometry:I,bufferedTilespaceBounds:(U=u.ax(I),U.min.x=u.ay(U.min.x,0,u.aj),U.min.y=u.ay(U.min.y,0,u.aj),U.max.x=u.ay(U.max.x,0,u.aj),U.max.y=u.ay(U.max.y,0,u.aj),U),tile:r,tileID:r.tileID,pixelToTileUnitsFactor:H};var U}_bufferedScreenMercator(r,l){const p=Si(r);if(this._screenRaycastCache[p])return this._screenRaycastCache[p];{let _;return _="globe"===l.projection.name?this._projectAndResample(this.bufferedScreenGeometry(r),l):{polygon:this.bufferedScreenGeometry(r).map(v=>l.pointCoordinate3D(v)),unwrapped:!0},this._screenRaycastCache[p]=_,_}}_bufferedCameraMercator(r,l){const p=Si(r);if(this._cameraRaycastCache[p])return this._cameraRaycastCache[p];{let _;return _="globe"===l.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(r),l):{polygon:this.bufferedCameraGeometry(r).map(v=>l.pointCoordinate3D(v)),unwrapped:!0},this._cameraRaycastCache[p]=_,_}}_projectAndResample(r,l){const p=function(v,b){const S=u.az([],b.pixelMatrix,b.globeMatrix),I=[0,-u.aB,0,1],P=[0,u.aB,0,1],R=[0,0,0,1];u.aA(I,I,S),u.aA(P,P,S),u.aA(R,R,S);const z=new u.P(I[0]/I[3],I[1]/I[3]),L=new u.P(P[0]/P[3],P[1]/P[3]),B=u.aC(v,z)&&I[3]<R[3],H=u.aC(v,L)&&P[3]<R[3];if(!B&&!H)return null;const U=function(pe,ae,ce){for(let ue=1;ue<pe.length;ue++){const Me=Ui(ae.pointCoordinate3D(pe[ue-1]).x),ye=Ui(ae.pointCoordinate3D(pe[ue]).x);if(ce<0){if(Me<ye)return{idx:ue,t:-Me/(ye-1-Me)}}else if(ye<Me)return{idx:ue,t:(1-Me)/(ye+1-Me)}}return null}(v,b,B?-1:1);if(!U)return null;const{idx:q,t:G}=U;let Y=q>1?ji(v.slice(0,q),b):[],ee=q<v.length?ji(v.slice(q),b):[];Y=Y.map(pe=>new u.P(Ui(pe.x),pe.y)),ee=ee.map(pe=>new u.P(Ui(pe.x),pe.y));const ne=[...Y];0===ne.length&&ne.push(ee[ee.length-1]);const le=u.ai(ne[ne.length-1].y,(0===ee.length?Y[0]:ee[0]).y,G);let de;return de=B?[new u.P(0,le),new u.P(0,0),new u.P(1,0),new u.P(1,le)]:[new u.P(1,le),new u.P(1,1),new u.P(0,1),new u.P(0,le)],ne.push(...de),0===ee.length?ne.push(Y[0]):ne.push(...ee),{polygon:ne.map(pe=>new u.ac(pe.x,pe.y)),unwrapped:!1}}(r,l);if(p)return p;const _=function(v,b){let S=!1,I=-1/0,P=0;for(let z=0;z<v.length-1;z++)v[z].x>I&&(I=v[z].x,P=z);for(let z=0;z<v.length-1;z++){const L=(P+z)%(v.length-1),B=v[L],H=v[L+1];Math.abs(B.x-H.x)>.5&&(B.x<H.x?(B.x+=1,0===L&&(v[v.length-1].x+=1)):(H.x+=1,L+1===v.length-1&&(v[0].x+=1)),S=!0)}const R=u.aD(b.center.lng);return S&&R<Math.abs(R-1)&&v.forEach(z=>{z.x-=1}),{polygon:v,unwrapped:S}}(ji(r,l).map(v=>new u.P(Ui(v.x),v.y)),l);return{polygon:_.polygon.map(v=>new u.ac(v.x,v.y)),unwrapped:_.unwrapped}}}function ji(f,r){return u.aE(f,l=>{const p=r.pointCoordinate3D(l);l.x=p.x,l.y=p.y},1/256)}function Ui(f){return f<0?1+f%1:f%1}function Si(f){return 100*f|0}function $r(f,r,l,p,_){const v=function(S,I){if(S)return _(S);if(I){if(f.url&&I.tiles&&f.tiles&&delete f.tiles,I.variants){if(!Array.isArray(I.variants))return _(new Error("variants must be an array"));for(const R of I.variants){if(null==R||"object"!=typeof R||R.constructor!==Object)return _(new Error("variant must be an object"));if(!Array.isArray(R.capabilities))return _(new Error("capabilities must be an array"));if(1===R.capabilities.length&&"meshopt"===R.capabilities[0]){I=u.h(I,R);break}}}const P=u.aF(u.h({},I,f),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);P.tiles=r.canonicalizeTileset(P,f.url),_(null,P)}},b=function(S,I,P){if(!S)return null;if(!I&&!P)return S;P=P||S.worldview_default;const R=Object.values(S.language||{});if(0===R.length)return null;const z=Object.values(S.worldview||{});if(0===z.length)return null;const L=R.every(H=>H===I),B=z.every(H=>H===P);return L&&B?S:I in(S.language_options||{})||P in(S.worldview_options||{})?null:S.language_options&&S.worldview_options?S:null}(f.data,l,p);return b?u.q.frame(()=>v(null,b)):f.url?u.n(r.transformRequest(r.normalizeSourceURL(f.url,null,l,p),u.R.Source),v):u.q.frame(()=>{const{data:S,...I}=f;v(null,I)})}function Bo(f,r){const l=Math.pow(2,r.z),p=Math.floor(u.aD(f.getWest())*l),_=Math.floor(u.aH(f.getNorth())*l),v=Math.ceil(u.aD(f.getEast())*l),b=Math.ceil(u.aH(f.getSouth())*l);return r.x>=p&&r.x<v&&r.y>=_&&r.y<b}class ho{constructor(r,l,p){this.bounds=r?u.aG.convert(this.validateBounds(r)):null,this.minzoom=l||0,this.maxzoom=p||24}validateBounds(r){return Array.isArray(r)&&4===r.length?[Math.max(-180,r[0]),Math.max(-90,r[1]),Math.min(180,r[2]),Math.min(90,r[3])]:[-180,-90,180,90]}addExtraBounds(r){if(r){this.extraBounds||(this.extraBounds=[]);for(const l of r)this.extraBounds.push(u.aG.convert(this.validateBounds(l)))}}contains(r){if(r.z>this.maxzoom||r.z<this.minzoom||this.bounds&&!Bo(this.bounds,r))return!1;if(!this.extraBounds)return!0;for(const l of this.extraBounds)if(Bo(l,r))return!0;return!1}static fromTileJSON(r){if(!r.bounds&&!r.extra_bounds)return null;const l=new ho(r.bounds,r.minzoom,r.maxzoom);return l.addExtraBounds(r.extra_bounds),l}}class Od extends u.E{constructor(r,l,p,_){if(super(),this.id=r,this.dispatcher=p,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,u.h(this,u.aF(l,["url","scheme","tileSize","promoteId"])),this._options=u.h({type:"vector"},l),this._collectResourceTiming=!!l.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(_),this._tileWorkers={},this._deduped=new u.aI}load(r){this._loaded=!1,this.fire(new u.A("dataloading",{dataType:"source"}));const l=Array.isArray(this.map._language)?this.map._language.join():this.map._language,p=this.map.getWorldview();this._tileJSONRequest=$r(this._options,this.map._requestManager,l,p,(_,v)=>{if(this._tileJSONRequest=null,this._loaded=!0,_)l&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${l}`),p&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${p}`),this.fire(new u.z(_));else if(v){if(u.h(this,v),this.hasWorldviews=!!v.worldview_options,v.worldview_default&&(this.worldviewDefault=v.worldview_default),v.vector_layers){this.vectorLayers=v.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const b of v.vector_layers)this.vectorLayerIds.push(b.id),v.worldview&&v.worldview[b.source]&&this.localizableLayerIds.add(b.id)}this.tileBounds=ho.fromTileJSON(v),No(v.tiles,this.map._requestManager._customAccessToken),this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))}r&&r(_)})}loaded(){return this._loaded}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}onAdd(r){this.map=r,this.load()}reload(){this.cancelTileJSONRequest();const r=u.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(r))}setTiles(r){return this._options.tiles=r,this.reload(),this}setUrl(r){return this.url=r,this._options.url=r,this.reload(),this}onRemove(r){this.cancelTileJSONRequest()}serialize(){return u.h({},this._options)}loadTile(r,l){const p=r.tileID.canonical.url(this.tiles,this.scheme),_=this.map._requestManager.normalizeTileURL(p),v=this.map._requestManager.transformRequest(_,u.R.Tile),b=this.map.style?this.map.style.getLut(this.scope):null,S=b?{image:b.image.clone()}:null,I={request:v,data:void 0,uid:r.uid,tileID:r.tileID,tileZoom:r.tileZoom,zoom:r.tileID.overscaledZ,maxZoom:this.maxzoom,lut:S,tileSize:this.tileSize*r.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:u.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:r.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:r.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&u.j(p)&&(I.localizableLayerIds=this.localizableLayerIds),I.request.collectResourceTiming=this._collectResourceTiming,r.actor&&"expired"!==r.state)"loading"===r.state?r.reloadCallback=l:r.request=r.actor.send("reloadTile",I,P.bind(this));else if(r.actor=this._tileWorkers[_]=this._tileWorkers[_]||this.dispatcher.getActor(),this.dispatcher.ready)r.request=r.actor.send("loadTile",I,P.bind(this),void 0,!0);else{const R=u.aJ.call({deduped:this._deduped},I,(z,L)=>{z||!L?P.call(this,z):(I.data={cacheControl:L.cacheControl,expires:L.expires,rawData:L.rawData.slice(0)},r.actor&&r.actor.send("loadTile",I,P.bind(this),void 0,!0))},!0);r.request={cancel:R}}function P(R,z){return delete r.request,r.aborted?l(null):R&&404!==R.status?l(R):(z&&z.resourceTiming&&(r.resourceTiming=z.resourceTiming),this.map._refreshExpiredTiles&&z&&r.setExpiryData(z),r.loadVectorData(z,this.map.painter),u.aK(this.dispatcher),l(null),void(r.reloadCallback&&(this.loadTile(r,r.reloadCallback),r.reloadCallback=null)))}}abortTile(r){r.request&&(r.request.cancel(),delete r.request),r.actor&&r.actor.send("abortTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(r,l){r.actor&&r.actor.send("removeTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope}),r.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class no extends u.E{constructor(r,l,p,_){super(),this.id=r,this.dispatcher=p,this.setEventedParent(_),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=u.h({type:"raster"},l),u.h(this,u.aF(l,["url","scheme","tileSize"]))}load(r){this._loaded=!1,this.fire(new u.A("dataloading",{dataType:"source"}));const l=this.map.getWorldview();this._tileJSONRequest=$r(this._options,this.map._requestManager,null,l,(p,_)=>{this._tileJSONRequest=null,this._loaded=!0,p?this.fire(new u.z(p)):_&&(u.h(this,_),_.raster_layers&&(this.rasterLayers=_.raster_layers,this.rasterLayerIds=this.rasterLayers.map(v=>v.id)),this.tileBounds=ho.fromTileJSON(_),No(_.tiles),this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))),r&&r(p)})}loaded(){return this._loaded}onAdd(r){this.map=r,this.load()}reload(){this.cancelTileJSONRequest();const r=u.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(r))}setTiles(r){return this._options.tiles=r,this.reload(),this}setUrl(r){return this.url=r,this._options.url=r,this.reload(),this}onRemove(r){this.cancelTileJSONRequest()}serialize(){return u.h({},this._options)}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}loadTile(r,l){const p=u.q.devicePixelRatio>=2,_=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme),p,this.tileSize);r.request=u.o(this.map._requestManager.transformRequest(_,u.R.Tile),(v,b,S,I)=>(delete r.request,r.aborted?(r.state="unloaded",l(null)):v?(r.state="errored",l(v)):b?(this.map._refreshExpiredTiles&&r.setExpiryData({cacheControl:S,expires:I}),r.setTexture(b,this.map.painter),r.state="loaded",u.aK(this.dispatcher),void l(null)):l(null)))}abortTile(r,l){r.request&&(r.request.cancel(),delete r.request),l&&l()}unloadTile(r,l){r.texture&&r.texture instanceof u.T?(r.destroy(!0),r.texture&&r.texture instanceof u.T&&this.map.painter.saveTileTexture(r.texture)):r.destroy(),l&&l()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Rl extends no{constructor(r,l,p,_){super(r,l,p,_),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=u.h({type:"raster-array"},l)}triggerRepaint(r){const l=this.map.painter._terrain,p=this.map.style.getSourceCache(this.id);l&&l.enabled&&p&&l._clearRenderCacheForTile(p.id,r.tileID),this.map.triggerRepaint()}loadTile(r,l){const p=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),_=this.map._requestManager.transformRequest(p,u.R.Tile),v={request:_,uid:r.uid,tileID:r.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};r.source=this.id,r.scope=this.scope,r.requestParams=_,r.actor||(r.actor=this.dispatcher.getActor());const b=(S,I,P,R)=>{if(delete r.request,r.aborted)return r.state="unloaded",l(null);if(S)return"AbortError"===S.name?void 0:(r.state="errored",l(S));if(this.map._refreshExpiredTiles&&I&&r.setExpiryData({cacheControl:P,expires:R}),this.partial)r.state="empty";else{if(!I)return l(null);r.state="loaded",r._isHeaderLoaded=!0,r._mrt=I}l(null)};r.request=this.partial?r.fetchHeader(void 0,b.bind(this)):r.actor.send("loadTile",v,b.bind(this),void 0,!0)}abortTile(r){r.request&&(r.request.cancel(),delete r.request),r.actor&&r.actor.send("abortTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(r,l){const p=r.texturePerLayer;if(r.flushAllQueues(),p.size){r.destroy(!0);for(const _ of p.values())this.map.painter.saveTileTexture(_)}else r.destroy()}prepareTile(r,l,p,_){r._isHeaderLoaded&&("empty"!==r.state&&(r.state="reloading"),r.fetchBand(l,p,_,(v,b)=>{if(v)return r.state="errored",this.fire(new u.z(v)),void this.triggerRepaint(r);b&&(r._isHeaderLoaded=!0,r.setTexturePerLayer(p,b,this.map.painter),r.state="loaded",this.triggerRepaint(r))}))}getInitialBand(r){if(!this.rasterLayers)return 0;const l=this.rasterLayers.find(({id:v})=>v===r),p=l&&l.fields,_=p&&p.bands&&p.bands;return _?_[0]:0}getTextureDescriptor(r,l,p){if(!r)return;const _=l.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!_)return;let v=null;l instanceof u.aN?v=l.paint.get("raster-array-band"):l instanceof u.aO&&(v=l.paint.get("raster-particle-array-band"));const b=v||this.getInitialBand(_);if(null==b)return;if(!r.textureDescriptorPerLayer.get(l.id))return void this.prepareTile(r,_,l.id,b);if(r.updateNeeded(l.id,b)&&!p)return;const S=r.textureDescriptorPerLayer.get(l.id);return Object.assign({},S,{texture:r.texturePerLayer.get(l.id)})}getImages(r,l){const p=new Map;for(const _ of r)for(const v of l){const[b,S]=v.split("/"),I=_.getLayer(b);if(!I||!I.hasBand(S)||!I.hasDataForBand(S))continue;const{bytes:P,tileSize:R,buffer:z}=I.getBandView(S),L=R+2*z,B={data:new u.r({width:L,height:L},P),pixelRatio:2,sdf:!1,usvg:!1,version:0};p.set(v,B)}return p}}const af={vector:Od,raster:no,"raster-dem":class extends no{constructor(f,r,l,p){super(f,r,l,p),this.type="raster-dem",this.maxzoom=22,this._options=u.h({type:"raster-dem"},r),this.encoding=r.encoding||"mapbox"}loadTile(f,r){const l=this.map._requestManager.normalizeTileURL(f.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function p(_,v){_&&(f.state="errored",r(_)),v&&(f.dem=v,f.dem.onDeserialize(),f.needsHillshadePrepare=!0,f.needsDEMTextureUpload=!0,f.state="loaded",r(null))}f.request=u.o(this.map._requestManager.transformRequest(l,u.R.Tile),function(_,v,b,S){if(delete f.request,f.aborted)f.state="unloaded",r(null);else if(_)f.state="errored",r(_);else if(v){this.map._refreshExpiredTiles&&f.setExpiryData({cacheControl:b,expires:S});const I=ImageBitmap&&v instanceof ImageBitmap&&u.t(),P=1-(v.width-u.aL(v.width))/2;P<1||f.neighboringTiles||(f.neighboringTiles=this._getNeighboringTiles(f.tileID));const R=I?v:u.q.getImageData(v,P),z={uid:f.uid,tileID:f.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:R,encoding:this.encoding,padding:P};f.actor&&"expired"!==f.state||(f.actor=this.dispatcher.getActor(),f.actor.send("loadTile",z,p.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(f){const r=f.canonical,l=Math.pow(2,r.z),p=(r.x-1+l)%l,_=0===r.x?f.wrap-1:f.wrap,v=(r.x+1+l)%l,b=r.x+1===l?f.wrap+1:f.wrap,S={};return S[new u.aM(f.overscaledZ,_,r.z,p,r.y).key]={backfilled:!1},S[new u.aM(f.overscaledZ,b,r.z,v,r.y).key]={backfilled:!1},r.y>0&&(S[new u.aM(f.overscaledZ,_,r.z,p,r.y-1).key]={backfilled:!1},S[new u.aM(f.overscaledZ,f.wrap,r.z,r.x,r.y-1).key]={backfilled:!1},S[new u.aM(f.overscaledZ,b,r.z,v,r.y-1).key]={backfilled:!1}),r.y+1<l&&(S[new u.aM(f.overscaledZ,_,r.z,p,r.y+1).key]={backfilled:!1},S[new u.aM(f.overscaledZ,f.wrap,r.z,r.x,r.y+1).key]={backfilled:!1},S[new u.aM(f.overscaledZ,b,r.z,v,r.y+1).key]={backfilled:!1}),S}},"raster-array":Rl,geojson:class extends u.E{constructor(f,r,l,p){super(),this.id=f,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=l.getActor(),this.setEventedParent(p),this._data=r.data,this._options=u.h({},r),this._collectResourceTiming=r.collectResourceTiming,void 0!==r.maxzoom&&(this.maxzoom=r.maxzoom),void 0!==r.minzoom&&(this.minzoom=r.minzoom),r.type&&(this.type=r.type),r.attribution&&(this.attribution=r.attribution),this.promoteId=r.promoteId;const _=u.aj/this.tileSize;this.workerOptions=u.h({source:this.id,scope:this.scope,cluster:r.cluster||!1,geojsonVtOptions:{buffer:(void 0!==r.buffer?r.buffer:128)*_,tolerance:(void 0!==r.tolerance?r.tolerance:.375)*_,extent:u.aj,maxZoom:this.maxzoom,lineMetrics:r.lineMetrics||!1,generateId:r.generateId||!1},superclusterOptions:{maxZoom:void 0!==r.clusterMaxZoom?r.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,r.clusterMinPoints||2),extent:u.aj,radius:(void 0!==r.clusterRadius?r.clusterRadius:50)*_,log:!1,generateId:r.generateId||!1},clusterProperties:r.clusterProperties,filter:r.filter,dynamic:r.dynamic},r.workerOptions)}onAdd(f){this.map=f,this.setData(this._data)}setData(f){return this._data=f,this._updateWorkerData(),this}updateData(f){if(!this._options.dynamic)return this.fire(new u.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof f&&("Feature"===f.type&&(f={type:"FeatureCollection",features:[f]}),"FeatureCollection"!==f.type))return this.fire(new u.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof f&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const r=new Map;for(const l of this._data.features)r.set(l.id,l);for(const l of f.features)r.set(l.id,l);this._data.features=[...r.values()]}else this._data=f;return this._updateWorkerData(!0),this}getClusterExpansionZoom(f,r){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:f,source:this.id,scope:this.scope},r),this}getClusterChildren(f,r){return this.actor.send("geojson.getClusterChildren",{clusterId:f,source:this.id,scope:this.scope},r),this}getClusterLeaves(f,r,l,p){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:f,limit:r,offset:l},p),this}_updateWorkerData(f=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new u.A("dataloading",{dataType:"source"})),this._loaded=!1;const r=u.h({append:f},this.workerOptions);r.scope=this.scope;const l=this._data;"string"==typeof l?(r.request=this.map._requestManager.transformRequest(u.q.resolveURL(l),u.R.Source),r.request.collectResourceTiming=this._collectResourceTiming):r.data=JSON.stringify(l),this._pendingLoad=this.actor.send(`${this.type}.loadData`,r,(p,_)=>{if(this._loaded=!0,this._pendingLoad=null,p)this.fire(new u.z(p));else{const v={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&_&&_.resourceTiming&&_.resourceTiming[this.id]&&(v.resourceTiming=_.resourceTiming[this.id]),f&&(this._partialReload=!0),this.fire(new u.A("data",v)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(f),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const f=u.C(this.id,this.scope);this.map.style.clearSource(f),this._updateWorkerData()}loadTile(f,r){const l=f.actor?"reloadTile":"loadTile";f.actor=this.actor;const p=this.map.style?this.map.style.getLut(this.scope):null,_=p?{image:p.image.clone()}:null,v=this._partialReload,b={type:this.type,uid:f.uid,tileID:f.tileID,tileZoom:f.tileZoom,zoom:f.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:_,scope:this.scope,pixelRatio:u.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:f.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:v,worldview:this.map.getWorldview()};f.request=this.actor.send(l,b,(S,I)=>v&&!I?(f.state="loaded",r(null)):(delete f.request,f.destroy(),f.aborted?r(null):S?r(S):(f.loadVectorData(I,this.map.painter,"reloadTile"===l),r(null))),void 0,"loadTile"===l)}abortTile(f){f.request&&(f.request.cancel(),delete f.request),f.aborted=!0}unloadTile(f,r){this.actor.send("removeTile",{uid:f.uid,type:this.type,source:this.id,scope:this.scope}),f.destroy()}onRemove(f){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return u.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends u.aP{constructor(f,r,l,p){super(f,r,l,p),this.roundZoom=!0,this.type="video",this.options=r}load(){this._loaded=!1;const f=this.options;this.urls=[];for(const r of f.urls)this.urls.push(this.map._requestManager.transformRequest(r,u.R.Source).url);u.aQ(this.urls,(r,l)=>{this._loaded=!0,r?this.fire(new u.z(r)):l&&(this.video=l,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(f){if(this.video){const r=this.video.seekable;f<r.start(0)||f>r.end(0)?this.fire(new u.z(new u.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${r.start(0)} and ${r.end(0)}-second mark.`))):this.video.currentTime=f}}getVideo(){return this.video}onAdd(f){this.map||(this.map=f,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const f=this.map.painter.context,r=f.gl;this.texture?this.video.paused||(this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),r.texSubImage2D(r.TEXTURE_2D,0,0,0,r.RGBA,r.UNSIGNED_BYTE,this.video)):(this.texture=new u.T(f,this.video,r.RGBA8),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(f)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:u.aP,model:class extends u.E{constructor(f,r,l,p){super(),this.id=f,this.type="model",this.models=[],this._loaded=!1,this._options=r}load(){const f=[];for(const r in this._options.models){const l=this._options.models[r],p=u.aS(this.map._requestManager.transformRequest(l.uri,u.R.Model).url).then(_=>{if(!_)return;const v=u.aT(_),b=new u.aU(r,l.position,l.orientation,v);b.computeBoundsAndApplyParent(),this.models.push(b)}).catch(_=>{this.fire(new u.z(new Error(`Could not load model ${r} from ${l.uri}: ${_.message}`)))});f.push(p)}Promise.allSettled(f).then(()=>{this._loaded=!0,this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(r=>{this._loaded=!0,this.fire(new u.z(new Error(`Could not load models: ${r.message}`)))})}onAdd(f){this.map=f,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(f,r){}serialize(){return this._options}},"batched-model":class extends u.E{constructor(f,r,l,p){super(),this.type="batched-model",this.id=f,this.tileSize=512,this._options=r,this.tiles=this._options.tiles,this.maxzoom=r.maxzoom||19,this.minzoom=r.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=l,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(p)}onAdd(f){this.map=f,this.load()}reload(){this.cancelTileJSONRequest();const f=u.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(f))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(f){this._loaded=!1,this.fire(new u.A("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,l=this.map.getWorldview();this._tileJSONRequest=$r(this._options,this.map._requestManager,r,l,(p,_)=>{this._tileJSONRequest=null,this._loaded=!0,p?(r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),l&&2!==l.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${l}`),this.fire(new u.z(p))):_&&(u.h(this,_),_.bounds&&(this.tileBounds=new ho(_.bounds,this.minzoom,this.maxzoom)),No(_.tiles,this.map._requestManager._customAccessToken),this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))),f&&f(p)})}hasTransition(){return!1}hasTile(f){return!this.tileBounds||this.tileBounds.contains(f.canonical)}loaded(){return this._loaded}loadTile(f,r){const l=this.map._requestManager.normalizeTileURL(f.tileID.canonical.url(this.tiles,this.scheme)),p={request:this.map._requestManager.transformRequest(l,u.R.Tile),data:void 0,uid:f.uid,tileID:f.tileID,tileZoom:f.tileZoom,zoom:f.tileID.overscaledZ,tileSize:this.tileSize*f.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:f.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:u.q.devicePixelRatio,promoteId:this.promoteId};if(f.actor&&"expired"!==f.state)if("loading"===f.state)f.reloadCallback=r;else{if(f.buckets){const v=Object.values(f.buckets);for(const b of v)b.dirty=!0;return void(f.state="loaded")}f.request=f.actor.send("reloadTile",p,_.bind(this))}else f.actor=this.dispatcher.getActor(),f.request=f.actor.send("loadTile",p,_.bind(this),void 0,!0);function _(v,b){return f.aborted?r(null):v&&404!==v.status?r(v):(this.map._refreshExpiredTiles&&b&&f.setExpiryData(b),f.loadModelData(b,this.map.painter),f.state="loaded",void r(null))}}serialize(){return u.h({},this._options)}},canvas:class extends u.aP{constructor(f,r,l,p){super(f,r,l,p),r.coordinates?Array.isArray(r.coordinates)&&4===r.coordinates.length&&!r.coordinates.some(_=>!Array.isArray(_)||2!==_.length||_.some(v=>"number"!=typeof v))||this.fire(new u.z(new u.V(`sources.${f}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new u.z(new u.V(`sources.${f}`,null,'missing required property "coordinates"'))),r.animate&&"boolean"!=typeof r.animate&&this.fire(new u.z(new u.V(`sources.${f}`,null,'optional "animate" property must be a boolean value'))),r.canvas?"string"==typeof r.canvas||r.canvas instanceof HTMLCanvasElement||this.fire(new u.z(new u.V(`sources.${f}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new u.z(new u.V(`sources.${f}`,null,'missing required property "canvas"'))),this.options=r,this.animate=void 0===r.animate||r.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new u.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(f){this.map=f,this.load(),this.canvas&&this.animate&&this.play()}onRemove(f){this.pause()}prepare(){let f=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,f=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,f=!0),this._hasInvalidDimensions()||0===Object.keys(this.tiles).length)return;const r=this.map.painter.context;this.texture?!f&&!this._playing||this.texture instanceof u.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new u.T(r,this.canvas,r.gl.RGBA8,{premultiply:!0}),this._prepareData(r)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const f of[this.canvas.width,this.canvas.height])if(isNaN(f)||f<=0)return!0;return!1}},custom:class extends u.E{constructor(f,r,l,p){super(),this.id=f,this.type="custom",this._dataType="raster",this._dispatcher=l,this._implementation=r,this.setEventedParent(p),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new u.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new u.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new ho(this._implementation.bounds,this.minzoom,this.maxzoom)),r.update=this._update.bind(this),r.clearTiles=this._clearTiles.bind(this),r.coveringTiles=this._coveringTiles.bind(this),u.h(this,u.aF(r,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return u.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new u.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(f){this.map=f,this._loaded=!1,this.fire(new u.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(f),this.load()}onRemove(f){this._implementation.onRemove&&this._implementation.onRemove(f)}hasTile(f){if(this._implementation.hasTile){const{x:r,y:l,z:p}=f.canonical;return this._implementation.hasTile({x:r,y:l,z:p})}return!this.tileBounds||this.tileBounds.contains(f.canonical)}loadTile(f,r){const{x:l,y:p,z:_}=f.tileID.canonical,v=new AbortController;f.request=Promise.resolve(this._implementation.loadTile({x:l,y:p,z:_},{signal:v.signal})).then(function(b){return delete f.request,f.aborted?(f.state="unloaded",r(null)):void 0===b?(f.state="errored",r(null)):null===b?(this.loadTileData(f,{width:this.tileSize,height:this.tileSize,data:null}),f.state="loaded",r(null)):(S=b)instanceof ImageData||S instanceof HTMLCanvasElement||S instanceof ImageBitmap||S instanceof HTMLImageElement?(this.loadTileData(f,b),f.state="loaded",void r(null)):(f.state="errored",r(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)));var S}.bind(this)).catch(b=>{"AbortError"!==b.name&&(f.state="errored",r(b))}),f.request.cancel=()=>v.abort()}loadTileData(f,r){f.setTexture(r,this.map.painter)}unloadTile(f,r){if(f.texture&&f.texture instanceof u.T?(f.destroy(!0),f.texture&&f.texture instanceof u.T&&this.map.painter.saveTileTexture(f.texture)):f.destroy(),this._implementation.unloadTile){const{x:l,y:p,z:_}=f.tileID.canonical;this._implementation.unloadTile({x:l,y:p,z:_})}r&&r()}abortTile(f,r){f.request&&f.request.cancel&&(f.request.cancel(),delete f.request),r&&r()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(f=>({x:f.canonical.x,y:f.canonical.y,z:f.canonical.z}))}_clearTiles(){const f=u.C(this.id,this.scope);this.map.style.clearSource(f)}_update(){this.fire(new u.A("data",{dataType:"source",sourceDataType:"content"}))}}},Su=function(f,r,l,p){const _=new af[r.type](f,r,l,p);if(_.id!==f)throw new Error(`Expected Source id to be ${f} instead of ${_.id}`);return u.aV(["load","abort","unload","serialize","prepare"],_),_};function Ld(f,r,l=""){return`${l}:${r.id||""}:${r.layer.id}:${function(p){if("layerId"in p)return`layer:${p.layerId}`;{const{featuresetId:_,importId:v}=p;return`featureset:${_}${v?`:import:${v}`:""}`}}(f.target)}`}function lf(f,r,l,p=""){if(f.uniqueFeatureID){const _=Ld(f,r,p);if(l.has(_))return!0;l.add(_)}return!1}function Ol(f,r,l,p,_=!1){const v=r.sourceCache.transform,b=r.sourceCache.tilesIn(f,r.has3DLayers,_);b.sort(gc);const S=[];for(const I of b){const P=I.tile.queryRenderedFeatures(r,I,l,p,v,_);Object.keys(P).length&&S.push({wrappedTileID:I.tile.tileID.wrapped().key,queryResults:P})}return 0===S.length?{}:function(I){const P={},R={};for(const z of I){const L=z.queryResults,B=z.wrappedTileID,H=R[B]=R[B]||{};for(const U in L){const q=L[U],G=H[U]=H[U]||{},Y=P[U]=P[U]||[];for(const ee of q)G[ee.featureIndex]||(G[ee.featureIndex]=!0,Y.push(ee))}}return P}(S)}function $a(f,r,l,p,_,v){const b={},S=p.queryRenderedSymbols(f),I=[];for(const P of Object.keys(S).map(Number))I.push(_[P]);I.sort(gc);for(const P of I){const R=P.featureIndex.lookupSymbolFeatures(S[P.bucketInstanceId],P.bucketIndex,P.sourceLayerIndex,r,l,v);for(const z in R){const L=b[z]=b[z]||[],B=R[z];B.sort((H,U)=>{const q=P.featureSortOrder;if(q){const G=q.indexOf(H.featureIndex);return q.indexOf(U.featureIndex)-G}return U.featureIndex-H.featureIndex});for(const H of B)L.push(H)}}return b}function Du(f,r){const l=f.getRenderableIds().map(v=>f.getTileByID(v)),p=[],_={};for(let v=0;v<l.length;v++){const b=l[v],S=b.tileID.canonical.key;_[S]||(_[S]=!0,b.querySourceFeatures(p,r))}return p}function gc(f,r){const l=f.tileID,p=r.tileID;return l.overscaledZ-p.overscaledZ||l.canonical.y-p.canonical.y||l.wrap-p.wrap||l.canonical.x-p.canonical.x}function Us(f,r){const l={};if(!r)return l;for(const p of f){const _=p.layerIds.map(v=>r.getLayer(v)).filter(Boolean);if(0!==_.length){p.layers=_,p.stateDependentLayerIds&&(p.stateDependentLayers=p.stateDependentLayerIds.map(v=>_.filter(b=>b.id===v)[0]));for(const v of _)l[v.fqid]=p}}return l}const Sa=new Uint16Array(8184);for(let f=0;f<2046;f++){let r=f+2,l=0,p=0,_=0,v=0,b=0,S=0;for(1&r?_=v=b=32:l=p=S=32;(r>>=1)>1;){const P=l+_>>1,R=p+v>>1;1&r?(_=l,v=p,l=b,p=S):(l=_,p=v,_=b,v=S),b=P,S=R}const I=4*f;Sa[I+0]=l,Sa[I+1]=p,Sa[I+2]=_,Sa[I+3]=v}const oa=new Uint16Array(2178),Di=new Uint8Array(1089),Ll=new Uint16Array(1089);function sr(f){return 0===f?-.03125:32===f?.03125:0}const _c={type:2,extent:u.aj,loadGeometry:()=>[[new u.P(0,0),new u.P(u.aj+1,0),new u.P(u.aj+1,u.aj+1),new u.P(0,u.aj+1),new u.P(0,0)]]};class yc{constructor(r,l,p,_,v,b){this.tileID=r,this.uid=u.a$(),this.uses=0,this.tileSize=l,this.tileZoom=p,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=v,_&&_.style&&(this._lastUpdatedBrightness=_.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",_&&_.transform&&(this.projection=_.transform.projection),this.worldview=b}registerFadeDuration(r){const l=r+this.timeAdded;l<u.q.now()||this.fadeEndTime&&l<this.fadeEndTime||(this.fadeEndTime=l)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=u.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(r,l,p){if(this.unloadVectorData(),this.state="loaded",r){r.featureIndex&&(this.latestFeatureIndex=r.featureIndex,r.rawTileData?(this.latestRawTileData=r.rawTileData,this.latestFeatureIndex.rawTileData=r.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=r.collisionBoxArray,this.buckets=Us(r.buckets,l.style),this.hasSymbolBuckets=!1;for(const _ in this.buckets){const v=this.buckets[_];if(v instanceof u.b1){if(this.hasSymbolBuckets=!0,!p)break;v.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const _ in this.buckets){const v=this.buckets[_];if(v instanceof u.b1&&v.hasRTLText){this.hasRTLText=!0,u.b2();break}}this.queryPadding=0;for(const _ in this.buckets){const v=this.buckets[_],b=l.style.getOwnLayer(_);if(!b)continue;const S=b.queryRadius(v);this.queryPadding=Math.max(this.queryPadding,S)}r.imageAtlas&&(this.imageAtlas=r.imageAtlas),r.glyphAtlasImage&&(this.glyphAtlasImage=r.glyphAtlasImage),r.lineAtlas&&(this.lineAtlas=r.lineAtlas),this._lastUpdatedBrightness=r.brightness}else this.collisionBoxArray=new u.b0}unloadVectorData(){if(this.hasData()){for(const r in this.buckets)this.buckets[r].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(r,l,p){r&&(r.resourceTiming&&(this.resourceTiming=r.resourceTiming),this.buckets=Object.assign({},this.buckets,Us(r.buckets,l.style)),r.featureIndex&&(this.latestFeatureIndex=r.featureIndex))}getBucket(r){return this.buckets[r.fqid]}upload(r){for(const _ in this.buckets){const v=this.buckets[_];v.uploadPending()&&v.upload(r)}const l=r.gl,p=this.imageAtlas;p&&!p.uploaded&&(this.imageAtlasTexture=new u.T(r,p.image,l.RGBA8,{useMipmap:!!p.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new u.T(r,this.glyphAtlasImage,l.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new u.T(r,this.lineAtlas.image,l.R8),this.lineAtlas.uploaded=!0)}prepare(r,l,p){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(r,this.imageAtlasTexture,p),!l||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const _=l.style.getBrightness();(this._lastUpdatedBrightness||_)&&(this._lastUpdatedBrightness&&_&&Math.abs(this._lastUpdatedBrightness-_)<.001||(this.updateBuckets(l,this._lastUpdatedBrightness!==_),this._lastUpdatedBrightness=_))}queryRenderedFeatures(r,l,p,_,v,b){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const S=function(I,P){const R=u.bn([],[.5*I.width,.5*-I.height,1]);return u.bo(R,R,[1,-1,0]),u.az(R,R,I.calculateProjMatrix(P.toUnwrapped())),Float32Array.from(R)}(v,this.tileID);return this.latestFeatureIndex.query(r,{tilespaceGeometry:l,pixelPosMatrix:S,transform:_,availableImages:p,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(r,l){const p=this.latestFeatureIndex;if(!p||!p.rawTileData)return;const _=p.loadVTLayers(),v=l?l.sourceLayer:"",b=_._geojsonTileLayer||_[v];if(!b)return;const S=u.b3(l&&l.filter),{z:I,x:P,y:R}=this.tileID.canonical,z={z:I,x:P,y:R};for(let L=0;L<b.length;L++){const B=b.feature(L);if(S.needGeometry){const q=u.b4(B,!0);if(!S.filter(new u.aa(this.tileID.overscaledZ,{worldview:this.worldview}),q,this.tileID.canonical))continue}else if(!S.filter(new u.aa(this.tileID.overscaledZ,{worldview:this.worldview}),B))continue;const H=p.getId(B,v),U=new u.b5(B,I,P,R,H);U.tile=z,r.push(U)}}loaded(){return"loaded"===this.state||"errored"===this.state}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(r){const l=this.expirationTime;if(r.cacheControl){const p=u.b6(r.cacheControl);p["max-age"]&&(this.expirationTime=Date.now()+1e3*p["max-age"])}else r.expires&&(this.expirationTime=new Date(r.expires).getTime());if(this.expirationTime){const p=Date.now();let _=!1;if(this.expirationTime>p)_=!1;else if(l)if(this.expirationTime<l)_=!0;else{const v=this.expirationTime-l;v?this.expirationTime=p+Math.max(v,3e4):_=!0}else _=!0;_?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(r){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&r&&this.updateBuckets(r)}updateBuckets(r,l){if(!this.latestFeatureIndex||!r.style)return;const p=this.latestFeatureIndex.loadVTLayers(),_=r.style.listImages(),v=r.style.getBrightness();for(const b in this.buckets){if(!r.style.hasLayer(b))continue;const S=this.buckets[b],I=S.layers[0],P=I.sourceLayer||"_geojsonTileLayer",R=p[P],z=r.style.getLayerSourceCache(I);let L={};z&&(L=z._state.getState(P,void 0));const B=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},H=Object.keys(L).length>0&&!l;H&&!S.stateDependentLayers.length&&!l||S.update(L,R,_,B,H?S.stateDependentLayers:S.layers,l,v),(S instanceof u.b7||S instanceof u.b8)&&r._terrain&&r._terrain.enabled&&z&&S.uploadPending()&&r._terrain._clearRenderCacheForTile(z.id,this.tileID);const U=r&&r.style&&r.style.getOwnLayer(b);U&&(this.queryPadding=Math.max(this.queryPadding,U.queryRadius(S)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<u.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(r){this.symbolFadeHoldUntil=u.q.now()+r}setTexture(r,l){const p=l.context,_=p.gl;this.texture=this.texture||l.getTileTexture(r.width),this.texture&&this.texture instanceof u.T?this.texture.update(r):(this.texture=new u.T(p,r,_.RGBA8,{useMipmap:!0}),this.texture.bind(_.LINEAR,_.CLAMP_TO_EDGE))}setDependencies(r,l){const p={};for(const _ of l)p[_]=!0;this.dependencies[r]=p}hasDependency(r,l){for(const p of r){const _=this.dependencies[p];if(_)for(const v of l)if(_[v])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(r,l){if(!l||"mercator"===l.name||this._tileDebugBuffer)return;const p=u.b9(_c,this.tileID.canonical,this.tileTransform)[0],_=new u.ba,v=new u.bb;for(let b=0;b<p.length;b++){const{x:S,y:I}=p[b];_.emplaceBack(S,I),v.emplaceBack(b)}v.emplaceBack(0),this._tileDebugIndexBuffer=r.createIndexBuffer(v),this._tileDebugBuffer=r.createVertexBuffer(_,u.bc.members),this._tileDebugSegments=u.bd.simpleSegment(0,0,_.length,v.length)}_makeTileBoundsBuffers(r,l){if(this._tileBoundsBuffer||!l||"mercator"===l.name)return;const p=u.b9(_c,this.tileID.canonical,this.tileTransform)[0];let _,v;if(this.isRaster){const b=function(S,I){const P=u.aW(S,I),R=Math.pow(2,S.z);for(let q=0;q<33;q++)for(let G=0;G<33;G++){const Y=u.aX((S.x+(G+sr(G))/32)/R),ee=u.aY((S.y+(q+sr(q))/32)/R),ne=I.project(Y,ee),le=33*q+G;oa[2*le+0]=Math.round((ne.x*P.scale-P.x)*u.aj),oa[2*le+1]=Math.round((ne.y*P.scale-P.y)*u.aj)}Di.fill(0),Ll.fill(0);for(let q=2045;q>=0;q--){const G=4*q,Y=Sa[G+0],ee=Sa[G+1],ne=Sa[G+2],le=Sa[G+3],de=Y+ne>>1,pe=ee+le>>1,ae=de+pe-ee,ce=pe+Y-de,ue=33*ee+Y,Me=33*le+ne,ye=33*pe+de,je=Math.hypot((oa[2*ue+0]+oa[2*Me+0])/2-oa[2*ye+0],(oa[2*ue+1]+oa[2*Me+1])/2-oa[2*ye+1])>=16;Di[ye]=Di[ye]||(je?1:0),q<1022&&(Di[ye]=Di[ye]||Di[33*(ee+ce>>1)+(Y+ae>>1)]||Di[33*(le+ce>>1)+(ne+ae>>1)])}const z=new u.aZ,L=new u.a_;let B=0;function H(q,G){const Y=33*G+q;return 0===Ll[Y]&&(z.emplaceBack(oa[2*Y+0],oa[2*Y+1],q*u.aj/32,G*u.aj/32),Ll[Y]=++B),Ll[Y]-1}function U(q,G,Y,ee,ne,le){const de=q+Y>>1,pe=G+ee>>1;if(Math.abs(q-ne)+Math.abs(G-le)>1&&Di[33*pe+de])U(ne,le,q,G,de,pe),U(Y,ee,ne,le,de,pe);else{const ae=H(q,G),ce=H(Y,ee),ue=H(ne,le);L.emplaceBack(ae,ce,ue)}}return U(0,0,32,32,32,0),U(32,32,0,0,0,32),{vertices:z,indices:L}}(this.tileID.canonical,l);_=b.vertices,v=b.indices}else{_=new u.aZ,v=new u.a_;for(const{x:S,y:I}of p)_.emplaceBack(S,I,0,0);const b=u.be(_.int16.subarray(0,4*_.length),void 0,4);for(let S=0;S<b.length;S+=3)v.emplaceBack(b[S],b[S+1],b[S+2])}this._tileBoundsBuffer=r.createVertexBuffer(_,u.bf.members),this._tileBoundsIndexBuffer=r.createIndexBuffer(v),this._tileBoundsSegments=u.bd.simpleSegment(0,0,_.length,v.length)}_makeGlobeTileDebugBuffers(r,l){const p=l.projection;if(!p||"globe"!==p.name||l.freezeTileCoverage)return;const _=this.tileID.canonical,v=u.bg(_,l),b=u.bh(v),S=u.ah(l.zoom);let I;S>0&&(I=u.bi(new Float64Array(16),l.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(r,_,l,b,I,S),this._makeGlobeTileDebugTextBuffer(r,_,l,b,I,S)}_globePoint(r,l,p,_,v,b,S){let I=u.bj(r,l,p);if(b){const P=1<<p.z,R=u.aD(_.center.lng),z=u.aH(_.center.lat),L=(p.x+.5)/P-R;let B=0;L>.5?B=-1:L<-.5&&(B=1);let H=(r/u.aj+p.x)/P+B,U=(l/u.aj+p.y)/P;H=(H-R)*_._pixelsPerMercatorPixel+R,U=(U-z)*_._pixelsPerMercatorPixel+z;const q=[H*_.worldSize,U*_.worldSize,0];u.ad(q,q,b),I=u.bk(I,q,S)}return u.ad(I,I,v)}_makeGlobeTileDebugBorderBuffer(r,l,p,_,v,b){const S=new u.ba,I=new u.bb,P=new u.bl,R=(L,B,H,U,q)=>{const G=(H-L)/(q-1),Y=(U-B)/(q-1),ee=S.length;for(let ne=0;ne<q;ne++){const le=L+ne*G,de=B+ne*Y;S.emplaceBack(le,de);const pe=this._globePoint(le,de,l,p,_,v,b);P.emplaceBack(pe[0],pe[1],pe[2]),I.emplaceBack(ee+ne)}},z=u.aj;R(0,0,z,0,16),R(z,0,z,z,16),R(z,z,0,z,16),R(0,z,0,0,16),this._tileDebugIndexBuffer=r.createIndexBuffer(I),this._tileDebugBuffer=r.createVertexBuffer(S,u.bc.members),this._globeTileDebugBorderBuffer=r.createVertexBuffer(P,u.bm.members),this._tileDebugSegments=u.bd.simpleSegment(0,0,S.length,I.length)}_makeGlobeTileDebugTextBuffer(r,l,p,_,v,b){const S=u.aj/4,I=new u.ba,P=new u.a_,R=new u.bl,z=25;P.reserve(32),I.reserve(z),R.reserve(z);const L=(B,H)=>z*B+H;for(let B=0;B<z;B++){const H=B*S;for(let U=0;U<z;U++){const q=U*S;I.emplaceBack(q,H);const G=this._globePoint(q,H,l,p,_,v,b);R.emplaceBack(G[0],G[1],G[2])}}for(let B=0;B<4;B++)for(let H=0;H<4;H++){const U=L(B,H),q=L(B,H+1),G=L(B+1,H),Y=L(B+1,H+1);P.emplaceBack(U,q,G),P.emplaceBack(G,q,Y)}this._tileDebugTextIndexBuffer=r.createIndexBuffer(P),this._tileDebugTextBuffer=r.createVertexBuffer(I,u.bc.members),this._globeTileDebugTextBuffer=r.createVertexBuffer(R,u.bm.members),this._tileDebugTextSegments=u.bd.simpleSegment(0,0,z,32)}destroy(r=!1){for(const l in this.buckets)this.buckets[l].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!r&&this.texture&&this.texture instanceof u.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}u.bp.setPbf(u.bq);class kl extends yc{constructor(r,l,p,_,v){super(r,l,p,_,v),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(r){return this._mrt&&this._mrt.getLayer(r)}setTexturePerLayer(r,l,p){const _=p.context,v=_.gl;let b=this.texturePerLayer.get(r)||p.getTileTexture(l.width);b&&b instanceof u.T?b.update(l,{premultiply:!1}):b=new u.T(_,l,v.RGBA8,{premultiply:!1}),this.texturePerLayer.has(r)||this.texturePerLayer.set(r,b)}flushQueues(r){const l=this._workQueuePerLayer.get(r)||[],p=this._fetchQueuePerLayer.get(r)||[];for(;l.length;)l.pop()();for(;p.length;)p.pop()()}flushAllQueues(){for(const r of this._workQueuePerLayer.keys()){const l=this._workQueuePerLayer.get(r)||[];for(;l.length;)l.pop()()}for(const r of this._fetchQueuePerLayer.keys()){const l=this._fetchQueuePerLayer.get(r)||[];for(;l.length;)l.pop()()}}fetchHeader(r=16384,l){const p=this._mrt=new u.bp(30),_=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(r-1)}});return this.entireBuffer=null,this.request=u.br(_,(v,b,S,I)=>{if(v)l(v);else try{const P=p.getHeaderLength(b);if(P>r)return void(this.request=this.fetchHeader(P,l));p.parseHeader(b),this._isHeaderLoaded=!0;let R=0;for(const z of Object.values(p.layers))R=Math.max(R,z.dataIndex[z.dataIndex.length-1].lastByte);b.byteLength>=R&&(this.entireBuffer=b),l(null,this.entireBuffer||b,S,I)}catch(P){l(P)}}),this.request}fetchBand(r,l,p,_){const v=this._mrt;if(!this._isHeaderLoaded||!v)return void _(new Error("Tile header is not ready"));const b=this.actor;if(!b)return void _(new Error("Can't fetch tile band without an actor"));let S;const I=(L,B)=>{if(S.complete(L,B),L)return void _(L);this.updateTextureDescriptor(r,l,p);const H=this.textureDescriptorPerLayer.get(l);_(null,H&&H.img)},P=(L,B)=>{if(L)return _(L);const H=b.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:B,task:S},I,void 0,!0),U=this._workQueuePerLayer.get(l)||[];U.push(()=>{H&&H.cancel(),S.cancel()}),this._workQueuePerLayer.has(l)||this._workQueuePerLayer.set(l,U)},R=v.getLayer(r);if(!R)return void _(new Error(`Unknown sourceLayer "${r}"`));if(R.hasDataForBand(p)){this.updateTextureDescriptor(r,l,p);const L=this.textureDescriptorPerLayer.get(l);return void _(null,L?L.img:null)}const z=R.getDataRange([p]);if(S=v.createDecodingTask(z),!S||S.tasks.length)if(this.flushQueues(l),this.entireBuffer)P(null,this.entireBuffer.slice(z.firstByte,z.lastByte+1));else{const L=Object.assign({},this.requestParams,{headers:{Range:`bytes=${z.firstByte}-${z.lastByte}`}}),B=u.br(L,P),H=this._fetchQueuePerLayer.get(l)||[];H.push(()=>{B.cancel(),S.cancel()}),this._fetchQueuePerLayer.has(l)||this._fetchQueuePerLayer.set(l,H)}else _(null)}updateNeeded(r,l){return(!this.textureDescriptorPerLayer.get(r)||this.textureDescriptorPerLayer.get(r).band!==l)&&"errored"!==this.state}updateTextureDescriptor(r,l,p){if(!this._mrt)return;const _=this._mrt.getLayer(r);if(!_||!_.hasBand(p)||!_.hasDataForBand(p))return;const{bytes:v,tileSize:b,buffer:S,offset:I,scale:P}=_.getBandView(p),R=b+2*S,z=new u.r({width:R,height:R},v),L=this.texturePerLayer.get(l);L&&L instanceof u.T&&L.update(z,{premultiply:!1}),this.textureDescriptorPerLayer.set(l,{layer:r,band:p,img:z,buffer:S,offset:I,tileSize:b,format:_.pixelFormat,mix:[P,256*P,65536*P,16777216*P]})}destroy(r=!1){if(super.destroy(r),delete this._mrt,!r)for(const l of this.texturePerLayer.values())l&&l instanceof u.T&&l.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class Fn{constructor(r,l){this.max=r,this.onRemove=l,this.reset()}reset(){for(const r in this.data)for(const l of this.data[r])l.timeout&&clearTimeout(l.timeout),this.onRemove(l.value);return this.data={},this.order=[],this}add(r,l,p){const _=r.wrapped().key;void 0===this.data[_]&&(this.data[_]=[]);const v={value:l,timeout:void 0};if(void 0!==p&&(v.timeout=setTimeout(()=>{this.remove(r,v)},p)),this.data[_].push(v),this.order.push(_),this.order.length>this.max){const b=this._getAndRemoveByKey(this.order[0]);b&&this.onRemove(b)}return this}has(r){return r.wrapped().key in this.data}getAndRemove(r){return this.has(r)?this._getAndRemoveByKey(r.wrapped().key):null}_getAndRemoveByKey(r){const l=this.data[r].shift();return l.timeout&&clearTimeout(l.timeout),0===this.data[r].length&&delete this.data[r],this.order.splice(this.order.indexOf(r),1),l.value}getByKey(r){const l=this.data[r];return l?l[0].value:null}get(r){return this.has(r)?this.data[r.wrapped().key][0].value:null}remove(r,l){if(!this.has(r))return this;const p=r.wrapped().key,_=void 0===l?0:this.data[p].indexOf(l),v=this.data[p][_];return this.data[p].splice(_,1),v.timeout&&clearTimeout(v.timeout),0===this.data[p].length&&delete this.data[p],this.onRemove(v.value),this.order.splice(this.order.indexOf(p),1),this}setMaxSize(r){for(this.max=r;this.order.length>this.max;){const l=this._getAndRemoveByKey(this.order[0]);l&&this.onRemove(l)}return this}filter(r){const l=[];for(const p in this.data)for(const _ of this.data[p])r(_.value)||l.push(_);for(const p of l)this.remove(p.value.tileID,p)}}class kd{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(r,l,p){const _=String(l);if(this.stateChanges[r]=this.stateChanges[r]||{},this.stateChanges[r][_]=this.stateChanges[r][_]||{},u.h(this.stateChanges[r][_],p),null===this.deletedStates[r]){this.deletedStates[r]={};for(const v in this.state[r])v!==_&&(this.deletedStates[r][v]=null)}else if(this.deletedStates[r]&&null===this.deletedStates[r][_]){this.deletedStates[r][_]={};for(const v in this.state[r][_])p[v]||(this.deletedStates[r][_][v]=null)}else for(const v in p)this.deletedStates[r]&&this.deletedStates[r][_]&&null===this.deletedStates[r][_][v]&&delete this.deletedStates[r][_][v]}removeFeatureState(r,l,p){if(null===this.deletedStates[r])return;const _=String(l);if(this.deletedStates[r]=this.deletedStates[r]||{},p&&void 0!==l)null!==this.deletedStates[r][_]&&(this.deletedStates[r][_]=this.deletedStates[r][_]||{},this.deletedStates[r][_][p]=null);else if(void 0!==l)if(this.stateChanges[r]&&this.stateChanges[r][_])for(p in this.deletedStates[r][_]={},this.stateChanges[r][_])this.deletedStates[r][_][p]=null;else this.deletedStates[r][_]=null;else this.deletedStates[r]=null}getState(r,l){const p=this.state[r]||{},_=this.stateChanges[r]||{},v=this.deletedStates[r];if(null===v)return{};if(void 0!==l){const S=String(l),I=u.h({},p[S],_[S]);if(v){const P=v[l];if(null===P)return{};for(const R in P)delete I[R]}return I}const b=u.h({},p,_);if(v)for(const S in v)delete b[S];return b}initializeTileState(r,l){r.refreshFeatureState(l)}coalesceChanges(r,l){const p={};for(const _ in this.stateChanges){this.state[_]=this.state[_]||{};const v={};for(const b in this.stateChanges[_])this.state[_][b]||(this.state[_][b]={}),u.h(this.state[_][b],this.stateChanges[_][b]),v[b]=this.state[_][b];p[_]=v}for(const _ in this.deletedStates){this.state[_]=this.state[_]||{};const v={};if(null===this.deletedStates[_])for(const b in this.state[_])v[b]={},this.state[_][b]={};else for(const b in this.deletedStates[_]){if(null===this.deletedStates[_][b])this.state[_][b]={};else if(this.state[_][b])for(const S of Object.keys(this.deletedStates[_][b]))delete this.state[_][b][S];v[b]=this.state[_][b]}p[_]=p[_]||{},u.h(p[_],v)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(p).length)for(const _ in r)r[_].refreshFeatureState(l)}}class Do extends u.E{constructor(r,l,p){super(),this.id=r,this._onlySymbols=p,l.on("data",_=>{"source"===_.dataType&&"metadata"===_.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===_.dataType&&"content"===_.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))}),l.on("error",()=>{this._sourceErrored=!0}),this._source=l,this._tiles={},this._cache=new Fn(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new kd,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(r){this.map=r,this._minTileCacheSize=void 0===this._minTileCacheSize&&r?r._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&r?r._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const r in this._tiles)if(!this._tiles[r].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const r=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,r&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(r,l){return r.isSymbolTile=this._onlySymbols,r.isExtraShadowCaster=this._shadowCasterTiles[r.tileID.key],this._source.loadTile(r,l)}_unloadTile(r){if(this._source.unloadTile)return this._source.unloadTile(r)}_abortTile(r){if(this._source.abortTile)return this._source.abortTile(r)}serialize(){return this._source.serialize()}prepare(r){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const l in this._tiles){const p=this._tiles[l];p.upload(r),p.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(r=>r.tileID).sort(Iu).map(r=>r.key)}getRenderableIds(r,l){const p=[];for(const _ in this._tiles)this._isIdRenderable(+_,r,l)&&p.push(this._tiles[_]);return r?p.sort((_,v)=>{const b=_.tileID,S=v.tileID,I=new u.P(b.canonical.x,b.canonical.y)._rotate(this.transform.angle),P=new u.P(S.canonical.x,S.canonical.y)._rotate(this.transform.angle);return b.overscaledZ-S.overscaledZ||P.y-I.y||P.x-I.x}).map(_=>_.tileID.key):p.map(_=>_.tileID).sort(Iu).map(_=>_.key)}hasRenderableParent(r){const l=this.findLoadedParent(r,0);return!!l&&this._isIdRenderable(l.tileID.key)}_isIdRenderable(r,l,p){return this._tiles[r]&&this._tiles[r].hasData()&&!this._coveredTiles[r]&&(l||!this._tiles[r].holdingForFade())&&(p||!this._shadowCasterTiles[r])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const r in this._tiles)"errored"!==this._tiles[r].state&&this._reloadTile(+r,"reloading")}}_reloadTile(r,l){const p=this._tiles[r];p&&("loading"!==p.state&&(p.state=l),this._loadTile(p,this._tileLoaded.bind(this,p,r,l)))}_tileLoaded(r,l,p,_){if(_)if(r.state="errored",404!==_.status)this._source.fire(new u.z(_,{tile:r}));else{if(this._source.fire(new u.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:r})),!(r.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const v=this.map.painter.terrain;this.update(this.transform,v.getScaledDemTileSize(),!0),v.resetTileLookupCache(this.id)}else this.update(this.transform)}else r.timeAdded=u.q.now(),"expired"===p&&(r.refreshedUponExpiration=!0),this._setTileReloadTimer(l,r),"raster-dem"===this._source.type&&r.dem&&this._backfillDEM(r),this._state.initializeTileState(r,this.map?this.map.painter:null),this._source.fire(new u.A("data",{dataType:"source",tile:r,coord:r.tileID,sourceCacheId:this.id}))}_backfillDEM(r){const l=this.getRenderableIds();for(let _=0;_<l.length;_++){const v=l[_];if(r.neighboringTiles&&r.neighboringTiles[v]){const b=this.getTileByID(v);p(r,b),p(b,r)}}function p(_,v){if(!_.dem||_.dem.borderReady)return;_.needsHillshadePrepare=!0,_.needsDEMTextureUpload=!0;let b=v.tileID.canonical.x-_.tileID.canonical.x;const S=v.tileID.canonical.y-_.tileID.canonical.y,I=Math.pow(2,_.tileID.canonical.z),P=v.tileID.key;0===b&&0===S||Math.abs(S)>1||(Math.abs(b)>1&&(1===Math.abs(b+I)?b+=I:1===Math.abs(b-I)&&(b-=I)),v.dem&&_.dem&&(_.dem.backfillBorder(v.dem,b,S),_.neighboringTiles&&_.neighboringTiles[P]&&(_.neighboringTiles[P].backfilled=!0)))}}getTile(r){return this.getTileByID(r.key)}getTileByID(r){return this._tiles[r]}_retainLoadedChildren(r,l,p,_){for(const v in this._tiles){let b=this._tiles[v];if(_[v]||!b.hasData()||b.tileID.overscaledZ<=l||b.tileID.overscaledZ>p)continue;let S=b.tileID;for(;b&&b.tileID.overscaledZ>l+1;){const P=b.tileID.scaledTo(b.tileID.overscaledZ-1);b=this._tiles[P.key],b&&b.hasData()&&(S=P)}let I=S;for(;I.overscaledZ>l;)if(I=I.scaledTo(I.overscaledZ-1),r[I.key]){_[S.key]=S;break}}}findLoadedParent(r,l){if(r.key in this._loadedParentTiles){const p=this._loadedParentTiles[r.key];return p&&p.tileID.overscaledZ>=l?p:null}for(let p=r.overscaledZ-1;p>=l;p--){const _=r.scaledTo(p),v=this._getLoadedTile(_);if(v)return v}}_getLoadedTile(r){const l=this._tiles[r.key];return l&&l.hasData()?l:this._cache.getByKey(this._source.reparseOverscaled?r.wrapped().key:r.canonical.key)}updateCacheSize(r,l){l=l||this._source.tileSize;const p=Math.ceil(r.width/l)+1,_=Math.ceil(r.height/l)+1,v=Math.floor(p*_*5),b="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,v):v,S="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,b):b;this._cache.setMaxSize(S)}handleWrapJump(r){const l=Math.round((r-(void 0===this._prevLng?r:this._prevLng))/360);if(this._prevLng=r,l){const p={};for(const _ in this._tiles){const v=this._tiles[_];v.tileID=v.tileID.unwrapTo(v.tileID.wrap+l),p[v.tileID.key]=v}this._tiles=p;for(const _ in this._timers)clearTimeout(this._timers[_]),delete this._timers[_];for(const _ in this._tiles)this._setTileReloadTimer(+_,this._tiles[_])}}update(r,l,p,_,v){if(this.transform=r,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!p)return;this.updateCacheSize(r,l),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const b="batched-model"===this._source.type;let S,I=this._source.maxzoom;const P=this.map&&this.map.painter?this.map.painter._terrain:null;if(P&&P.sourceCache===this&&P.attenuationRange()){const L=P.attenuationRange()[0],B=Math.floor(L)-Math.log2(P.getDemUpscale());I>B&&(I=B)}if(this.used||this.usedForTerrain){if(this._source.tileID)S=r.getVisibleUnwrappedCoordinates(this._source.tileID).map(L=>new u.aM(L.canonical.z,L.wrap,L.canonical.z,L.canonical.x,L.canonical.y));else if(0!==this.tileCoverLift){const L=r.clone();L.tileCoverLift=this.tileCoverLift,S=L.coveringTiles({tileSize:l||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:I,roundZoom:this._source.roundZoom&&!p,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.minzoom<=1&&"globe"===r.projection.name&&(S.push(new u.aM(1,0,1,0,0)),S.push(new u.aM(1,0,1,1,0)),S.push(new u.aM(1,0,1,0,1)),S.push(new u.aM(1,0,1,1,1)))}else if(S=r.coveringTiles({tileSize:l||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:I,roundZoom:this._source.roundZoom&&!p,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.hasTile){const L=this._source.hasTile.bind(this._source);S=S.filter(B=>L(B))}}else S=[];if(S.length>0&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!Cu(this._source.type)){const L=r.coveringZoomLevel({tileSize:l||this._source.tileSize,roundZoom:this._source.roundZoom&&!p}),B=Math.min(L,this._source.maxzoom);if(b){const H=r.extendTileCover(S,B);for(const U of H)S.push(U)}else if(v){const H=r.extendTileCoverToNearPlane(S,this.transform.getFrustum(B),B);for(const U of H)S.push(U)}else if(this.castsShadows&&_){const H=r.extendTileCover(S,B,_);for(const U of H)this._shadowCasterTiles[U.key]=!0,S.push(U)}}const R=this._updateRetainedTiles(S);if(Cu(this._source.type)&&0!==S.length){const L={},B={},H=Object.keys(R);for(const q of H){const G=R[q],Y=this._tiles[q];if(!Y||Y.fadeEndTime&&Y.fadeEndTime<=u.q.now())continue;const ee=this.findLoadedParent(G,Math.max(G.overscaledZ-Do.maxOverzooming,this._source.minzoom));ee&&(this._addTile(ee.tileID),L[ee.tileID.key]=ee.tileID),B[q]=G}const U=S[S.length-1].overscaledZ;for(const q in this._tiles){const G=this._tiles[q];if(R[q]||!G.hasData())continue;let Y=G.tileID;for(;Y.overscaledZ>U;){Y=Y.scaledTo(Y.overscaledZ-1);const ee=this._tiles[Y.key];if(ee&&ee.hasData()&&B[Y.key]){R[q]=G.tileID;break}}}for(const q in L)R[q]||(this._coveredTiles[q]=!0,R[q]=L[q])}for(const L in R)this._tiles[L].clearFadeHold();const z=u.bs(this._tiles,R);for(const L of z){const B=this._tiles[L];B.hasSymbolBuckets&&!B.holdingForFade()?B.setHoldDuration(this.map._fadeDuration):B.hasSymbolBuckets&&!B.symbolFadeFinished()||this._removeTile(+L)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const r in this._tiles)this._tiles[r].holdingForFade()&&this._removeTile(+r)}_updateRetainedTiles(r){const l={};if(0===r.length)return l;const p={},_=r.reduce((P,R)=>Math.min(P,R.overscaledZ),1/0),v=r[0].overscaledZ,b=Math.max(v-Do.maxOverzooming,this._source.minzoom),S=Math.max(v+Do.maxUnderzooming,this._source.minzoom),I={};for(const P of r){const R=this._addTile(P);l[P.key]=P,R.hasData()||_<this._source.maxzoom&&(I[P.key]=P)}this._retainLoadedChildren(I,_,S,l);for(const P of r){let R=this._tiles[P.key];if(R.hasData())continue;if(P.canonical.z>=this._source.maxzoom){const L=P.children(this._source.maxzoom)[0],B=this.getTile(L);if(B&&B.hasData()){l[L.key]=L;continue}}else{const L=P.children(this._source.maxzoom);if(l[L[0].key]&&l[L[1].key]&&l[L[2].key]&&l[L[3].key])continue}let z=R.wasRequested();for(let L=P.overscaledZ-1;L>=b;--L){const B=P.scaledTo(L);if(p[B.key]||(p[B.key]=!0,R=this.getTile(B),!R&&z&&(R=this._addTile(B)),R&&(l[B.key]=B,z=R.wasRequested(),R.hasData())))break}}return l}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const r in this._tiles){const l=[];let p,_=this._tiles[r].tileID;for(;_.overscaledZ>0;){if(_.key in this._loadedParentTiles){p=this._loadedParentTiles[_.key];break}l.push(_.key);const v=_.scaledTo(_.overscaledZ-1);if(p=this._getLoadedTile(v),p)break;_=v}for(const v of l)this._loadedParentTiles[v]=p}}_addTile(r){let l=this._tiles[r.key];if(l)return!0!==l.isExtraShadowCaster||this._shadowCasterTiles[r.key]||this._reloadTile(r.key,"reloading"),l;l=this._cache.getAndRemove(r),l&&(this._setTileReloadTimer(r.key,l),l.tileID=r,this._state.initializeTileState(l,this.map?this.map.painter:null),this._cacheTimers[r.key]&&(clearTimeout(this._cacheTimers[r.key]),delete this._cacheTimers[r.key],this._setTileReloadTimer(r.key,l)));const p=!!l;if(!p){const _=this.map?this.map.painter:null,v=this._source.tileSize*r.overscaleFactor();l="raster-array"===this._source.type?new kl(r,v,this.transform.tileZoom,_,this._isRaster):new yc(r,v,this.transform.tileZoom,_,this._isRaster,this._source.worldview),this._loadTile(l,this._tileLoaded.bind(this,l,r.key,l.state))}return l.uses++,this._tiles[r.key]=l,p||this._source.fire(new u.A("dataloading",{tile:l,coord:l.tileID,dataType:"source"})),l}_setTileReloadTimer(r,l){r in this._timers&&(clearTimeout(this._timers[r]),delete this._timers[r]);const p=l.getExpiryTimeout();p&&(this._timers[r]=setTimeout(()=>{this._reloadTile(r,"expired"),delete this._timers[r]},p))}_removeTile(r){const l=this._tiles[r];l&&(l.uses--,delete this._tiles[r],this._timers[r]&&(clearTimeout(this._timers[r]),delete this._timers[r]),l.uses>0||(l.hasData()&&"reloading"!==l.state||"empty"===l.state?this._cache.add(l.tileID,l,l.getExpiryTimeout()):(l.aborted=!0,this._abortTile(l),this._unloadTile(l))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const r in this._tiles)this._removeTile(+r);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(r,l,p){const _=[],v=this.transform;if(!v)return _;const b="globe"===v.projection.name,S=u.aD(v.center.lng);for(const I in this._tiles){const P=this._tiles[I];if(p&&P.clearQueryDebugViz(),P.holdingForFade())continue;let R;if(b){const z=P.tileID.canonical;if(0===z.z){const L=[Math.abs(u.ay(S,...Pt(z,-1))-S),Math.abs(u.ay(S,...Pt(z,1))-S)];R=[0,2*L.indexOf(Math.min(...L))-1]}else{const L=[Math.abs(u.ay(S,...Pt(z,-1))-S),Math.abs(u.ay(S,...Pt(z,0))-S),Math.abs(u.ay(S,...Pt(z,1))-S)];R=[L.indexOf(Math.min(...L))-1]}}else R=[0];for(const z of R){const L=r.containsTile(P,v,l,z);L&&_.push(L)}}return _}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(r){return this._getRenderableCoordinates(r)}_getRenderableCoordinates(r,l){const p=this.getRenderableIds(r,l).map(v=>this._tiles[v].tileID),_="globe"===this.transform.projection.name;for(const v of p)v.projMatrix=this.transform.calculateProjMatrix(v.toUnwrapped()),v.expandedProjMatrix=_?this.transform.calculateProjMatrix(v.toUnwrapped(),!1,!0):v.projMatrix;return p}sortCoordinatesByDistance(r){const l=r.slice(),p=this.transform._camera.position,_=this.transform._camera.forward(),v={};for(const b of l){const S=1/(1<<b.canonical.z);v[b.key]=((b.canonical.x+.5)*S+b.wrap-p[0])*_[0]+((b.canonical.y+.5)*S-p[1])*_[1]-p[2]*_[2]}return l.sort((b,S)=>v[b.key]-v[S.key]),l}hasTransition(){if(this._source.hasTransition())return!0;if(Cu(this._source.type))for(const r in this._tiles){const l=this._tiles[r];if(void 0!==l.fadeEndTime&&l.fadeEndTime>=u.q.now())return!0}return!1}setFeatureState(r,l,p){this._state.updateState(r=r||"_geojsonTileLayer",l,p)}removeFeatureState(r,l,p){this._state.removeFeatureState(r=r||"_geojsonTileLayer",l,p)}getFeatureState(r,l){return this._state.getState(r=r||"_geojsonTileLayer",l)}setDependencies(r,l,p){const _=this._tiles[r];_&&_.setDependencies(l,p)}reloadTilesForDependencies(r,l){for(const p in this._tiles)this._tiles[p].hasDependency(r,l)&&this._reloadTile(+p,"reloading");this._cache.filter(p=>!p.hasDependency(r,l))}_preloadTiles(r,l){if(!this._sourceLoaded){const I=()=>{this._sourceLoaded&&(this._source.off("data",I),this._preloadTiles(r,l))};return void this._source.on("data",I)}const p=new Map,_=Array.isArray(r)?r:[r],v=this.map.painter.terrain,b=this.usedForTerrain&&v?v.getScaledDemTileSize():this._source.tileSize;for(const I of _){const P=I.coveringTiles({tileSize:b,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const R of P)p.set(R.key,R);this.usedForTerrain&&I.updateElevation(!1)}const S=Array.from(p.values());u.bt(S,(I,P)=>{const R=new yc(I,this._source.tileSize*I.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(R,z=>{"raster-dem"===this._source.type&&R.dem&&this._backfillDEM(R),P(z,R)})},l)}}function Iu(f,r){const l=Math.abs(2*f.wrap)-+(f.wrap<0),p=Math.abs(2*r.wrap)-+(r.wrap<0);return f.overscaledZ-r.overscaledZ||p-l||r.canonical.y-f.canonical.y||r.canonical.x-f.canonical.x}function Cu(f){return"raster"===f||"image"===f||"video"===f||"custom"===f}function Pt(f,r){const l=1<<f.z;return[f.x/l+r,(f.x+1)/l+r]}Do.maxOverzooming=10,Do.maxUnderzooming=3;class Fd{constructor(r){this.style=r,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];for(const p in this.style._mergedLayers){const _=this.style._mergedLayers[p];if("fill-extrusion"===_.type||"building"===_.type)this.layers.push({layer:_,visible:false,visibilityChanged:false});else if("model"===_.type){const v=this.style.getLayerSource(_);v&&"batched-model"===v.type&&this.layers.push({layer:_,visible:false,visibilityChanged:false})}}}onNewFrame(r){this.layersGotHidden=!1;for(const l of this.layers){const p=l.layer;let _=!1;"fill-extrusion"===p.type?_=!p.isHidden(r)&&p.paint.get("fill-extrusion-opacity")>0:"building"===p.type?_=!p.isHidden(r)&&p.paint.get("building-opacity")>0:"model"===p.type&&(_=!p.isHidden(r)&&p.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!_&&l.visible,l.visible=_}}updateZOffset(r,l){this.currentBuildingBuckets=[];for(const _ of this.layers){const v=_.layer,b=this.style.getLayerSourceCache(v);let S=1;"fill-extrusion"===v.type?S=_.visible?v.paint.get("fill-extrusion-vertical-scale"):0:"building"===v.type&&(S=_.visible?v.paint.get("building-vertical-scale"):0);let I=b?b.getTile(l):null;if(!I&&b)for(const P in b._tiles){const R=b._tiles[P];if(l.canonical.isChildOf(R.tileID.canonical)){I=R;break}}this.currentBuildingBuckets.push({bucket:I?I.getBucket(v):null,tileID:I?I.tileID:l,verticalScale:S})}r.hasAnyZOffset=!1;let p=!1;for(let _=0;_<r.symbolInstances.length;_++){const v=r.symbolInstances.get(_),b=v.zOffset,S=this._getHeightAtTileOffset(l,v.tileAnchorX,v.tileAnchorY);v.zOffset=S!==Number.NEGATIVE_INFINITY?S:b,p||b===v.zOffset||(p=!0),r.hasAnyZOffset||0===v.zOffset||(r.hasAnyZOffset=!0)}p&&(r.zOffsetBuffersNeedUpload=!0,r.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(r,l,p,_){let v=l,b=p;if(r.canonical.z!==_.canonical.z){const S=_.canonical,I=1/(1<<r.canonical.z-S.z);v=(l+r.canonical.x*u.aj)*I-S.x*u.aj|0,b=(p+r.canonical.y*u.aj)*I-S.y*u.aj|0}return{tileX:v,tileY:b}}_getHeightAtTileOffset(r,l,p){let _,v;for(let b=0;b<this.layers.length;++b){const S=this.layers[b].layer;if("fill-extrusion"!==S.type&&"building"!==S.type)continue;const{bucket:I,tileID:P,verticalScale:R}=this.currentBuildingBuckets[b];if(!I)continue;const{tileX:z,tileY:L}=this._mapCoordToOverlappingTile(r,l,p,P),B=I.getHeightAtTileCoord(z,L);B&&void 0!==B.height&&(B.hidden?_=B.height:v=Math.max(B.height*R,v||0))}if(void 0!==v)return v;for(let b=0;b<this.layers.length;++b){const S=this.layers[b];if("model"!==S.layer.type||!S.visible)continue;const{bucket:I,tileID:P}=this.currentBuildingBuckets[b];if(!I)continue;const{tileX:R,tileY:z}=this._mapCoordToOverlappingTile(r,l,p,P),L=I.getHeightAtTileCoord(R,z);if(L&&!L.hidden)return void 0===L.height&&void 0!==_?Math.min(L.maxHeight,_)*L.verticalScale:L.height?L.height*L.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function $n(f,r){const l={};for(const p in f)"ref"!==p&&(l[p]=f[p]);return u.bu.forEach(p=>{p in r&&(l[p]=r[p])}),l}function ki(f){f=f.slice();const r=Object.create(null);for(let l=0;l<f.length;l++)r[f[l].id]=f[l];for(let l=0;l<f.length;l++)"ref"in f[l]&&(f[l]=$n(f[l],r[f[l].ref]));return f}const Rn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Lp(f,r,l){l.push({command:Rn.addSource,args:[f,r[f]]})}function Au(f,r,l){r.push({command:Rn.removeSource,args:[f]}),l[f]=!0}function vc(f,r,l,p){Au(f,l,p),Lp(f,r,l)}function Rs(f,r,l){let p;for(p in f[l])if(f[l].hasOwnProperty(p)&&"data"!==p&&!u.bv(f[l][p],r[l][p]))return!1;for(p in r[l])if(r[l].hasOwnProperty(p)&&"data"!==p&&!u.bv(f[l][p],r[l][p]))return!1;return!0}function cf(f,r,l,p,_,v){let b;for(b in r=r||{},f=f||{})f.hasOwnProperty(b)&&(u.bv(f[b],r[b])||l.push({command:v,args:[p,b,r[b],_]}));for(b in r)r.hasOwnProperty(b)&&!f.hasOwnProperty(b)&&(u.bv(f[b],r[b])||l.push({command:v,args:[p,b,r[b],_]}))}function xc(f){return f.id}function bc(f,r){return f[r.id]=r,f}function sa(f,r,l){const p=r.createTileMatrix(f,f.worldSize,l.toUnwrapped());return u.az(new Float32Array(16),f.projMatrix,p)}function nv(f,r,l){if(r.projection.name===l.projection.name)return f.projMatrix;const p=l.clone();return p.setProjection(r.projection),sa(p,r.getProjection(),f)}function kp(f,r,l){return r.name===l.projection.name?f.projMatrix:sa(l,r,f)}class iv{constructor(r,l){this.reset(r,l)}reset(r,l){this.points=r||[],this._distances=[0];for(let p=1;p<this.points.length;p++)this._distances[p]=this._distances[p-1]+this.points[p].dist(this.points[p-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(l||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(r){if(1===this.points.length)return this.points[0];r=u.ay(r,0,1);let l=1,p=this._distances[l];const _=r*this.paddedLength+this.padding;for(;p<_&&l<this._distances.length;)p=this._distances[++l];const v=l-1,b=this._distances[v],S=p-b,I=S>0?(_-b)/S:0;return this.points[v].mult(1-I).add(this.points[l].mult(I))}}class zd{constructor(r,l,p){const _=this.boxCells=[],v=this.circleCells=[];this.xCellCount=Math.ceil(r/p),this.yCellCount=Math.ceil(l/p);for(let b=0;b<this.xCellCount*this.yCellCount;b++)_.push([]),v.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=r,this.height=l,this.xScale=this.xCellCount/r,this.yScale=this.yCellCount/l,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(r,l,p,_,v){this._forEachCell(l,p,_,v,this._insertBoxCell,this.boxUid++),this.boxKeys.push(r),this.bboxes.push(l),this.bboxes.push(p),this.bboxes.push(_),this.bboxes.push(v)}insertCircle(r,l,p,_){this._forEachCell(l-_,p-_,l+_,p+_,this._insertCircleCell,this.circleUid++),this.circleKeys.push(r),this.circles.push(l),this.circles.push(p),this.circles.push(_)}_insertBoxCell(r,l,p,_,v,b){this.boxCells[v].push(b)}_insertCircleCell(r,l,p,_,v,b){this.circleCells[v].push(b)}_query(r,l,p,_,v,b){if(p<0||r>this.width||_<0||l>this.height)return!v&&[];const S=[];if(r<=0&&l<=0&&this.width<=p&&this.height<=_){if(v)return!0;for(let I=0;I<this.boxKeys.length;I++)S.push({key:this.boxKeys[I],x1:this.bboxes[4*I],y1:this.bboxes[4*I+1],x2:this.bboxes[4*I+2],y2:this.bboxes[4*I+3]});for(let I=0;I<this.circleKeys.length;I++){const P=this.circles[3*I],R=this.circles[3*I+1],z=this.circles[3*I+2];S.push({key:this.circleKeys[I],x1:P-z,y1:R-z,x2:P+z,y2:R+z})}return b?S.filter(b):S}return this._forEachCell(r,l,p,_,this._queryCell,S,{hitTest:v,seenUids:{box:{},circle:{}}},b),v?S.length>0:S}_queryCircle(r,l,p,_,v){const b=r-p,S=r+p,I=l-p,P=l+p;if(S<0||b>this.width||P<0||I>this.height)return!_&&[];const R=[];return this._forEachCell(b,I,S,P,this._queryCellCircle,R,{hitTest:_,circle:{x:r,y:l,radius:p},seenUids:{box:{},circle:{}}},v),_?R.length>0:R}query(r,l,p,_,v){return this._query(r,l,p,_,!1,v)}hitTest(r,l,p,_,v){return this._query(r,l,p,_,!0,v)}hitTestCircle(r,l,p,_){return this._queryCircle(r,l,p,!0,_)}_queryCell(r,l,p,_,v,b,S,I){const P=S.seenUids,R=this.boxCells[v];if(null!==R){const L=this.bboxes;for(const B of R)if(!P.box[B]){P.box[B]=!0;const H=4*B;if(r<=L[H+2]&&l<=L[H+3]&&p>=L[H+0]&&_>=L[H+1]&&(!I||I(this.boxKeys[B]))){if(S.hitTest)return b.push(!0),!0;b.push({key:this.boxKeys[B],x1:L[H],y1:L[H+1],x2:L[H+2],y2:L[H+3]})}}}const z=this.circleCells[v];if(null!==z){const L=this.circles;for(const B of z)if(!P.circle[B]){P.circle[B]=!0;const H=3*B;if(this._circleAndRectCollide(L[H],L[H+1],L[H+2],r,l,p,_)&&(!I||I(this.circleKeys[B]))){if(S.hitTest)return b.push(!0),!0;{const U=L[H],q=L[H+1],G=L[H+2];b.push({key:this.circleKeys[B],x1:U-G,y1:q-G,x2:U+G,y2:q+G})}}}}}_queryCellCircle(r,l,p,_,v,b,S,I){const P=S.circle,R=S.seenUids,z=this.boxCells[v];if(null!==z){const B=this.bboxes;for(const H of z)if(!R.box[H]){R.box[H]=!0;const U=4*H;if(this._circleAndRectCollide(P.x,P.y,P.radius,B[U+0],B[U+1],B[U+2],B[U+3])&&(!I||I(this.boxKeys[H])))return b.push(!0),!0}}const L=this.circleCells[v];if(null!==L){const B=this.circles;for(const H of L)if(!R.circle[H]){R.circle[H]=!0;const U=3*H;if(this._circlesCollide(B[U],B[U+1],B[U+2],P.x,P.y,P.radius)&&(!I||I(this.circleKeys[H])))return b.push(!0),!0}}}_forEachCell(r,l,p,_,v,b,S,I){const P=this._convertToXCellCoord(r),R=this._convertToYCellCoord(l),z=this._convertToXCellCoord(p),L=this._convertToYCellCoord(_);for(let B=P;B<=z;B++)for(let H=R;H<=L;H++)if(v.call(this,r,l,p,_,this.xCellCount*H+B,b,S,I))return}_convertToXCellCoord(r){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(r*this.xScale)))}_convertToYCellCoord(r){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(r*this.yScale)))}_circlesCollide(r,l,p,_,v,b){const S=_-r,I=v-l,P=p+b;return P*P>S*S+I*I}_circleAndRectCollide(r,l,p,_,v,b,S){const I=(b-_)/2,P=Math.abs(r-(_+I));if(P>I+p)return!1;const R=(S-v)/2,z=Math.abs(l-(v+R));if(z>R+p)return!1;if(P<=I||z<=R)return!0;const L=P-I,B=z-R;return L*L+B*B<=p*p}}const wc={unknown:0,flipRequired:1,flipNotRequired:2},rv=Math.tan(85*Math.PI/180);function Nd(f,r,l,p,_,v,b){const S=u.bz();if(l)if("globe"===v.name){const I=u.bA(_,r);u.az(S,S,I)}else{const I=u.bB([],b);S[0]=I[0],S[1]=I[1],S[4]=I[2],S[5]=I[3],p||u.by(S,S,_.angle)}else u.az(S,_.labelPlaneMatrix,f);return S}function Bd(f,r,l,p,_,v,b){const S=Nd(f,r,l,p,_,v,b);return"globe"===v.name&&l||(S[2]=S[6]=S[10]=S[14]=0),S}function qr(f,r,l,p,_,v,b){if(l){if("globe"===v.name){const S=Nd(f,r,l,p,_,v,b);return u.bi(S,S),u.az(S,f,S),S}{const S=u.bw(f),I=u.bx([]);return I[0]=b[0],I[1]=b[1],I[4]=b[2],I[5]=b[3],u.az(S,S,I),p||u.by(S,S,-_.angle),S}}return _.glCoordMatrix}function _n(f,r,l,p){const _=[f,r,l,1];l?u.aA(_,_,p):Vd(_,_,p);const v=_[3];return _[0]/=v,_[1]/=v,_[2]/=v,_}function zg(f,r){return Math.min(.5+f/r*.5,1.5)}function Ng(f,r){const l=f[0]/f[3],p=f[1]/f[3];return l>=-r[0]&&l<=r[0]&&p>=-r[1]&&p<=r[1]}function Mu(f,r,l,p,_,v,b,S,I,P){const R=l.transform,z=p?f.textSizeData:f.iconSizeData,L=u.bH(z,l.transform.zoom),B="globe"===R.projection.name,H=[256/l.width*2+1,256/l.height*2+1],U=p?f.text.dynamicLayoutVertexArray:f.icon.dynamicLayoutVertexArray;U.clear();let q=null;B&&(q=p?f.text.globeExtVertexArray:f.icon.globeExtVertexArray);const G=f.lineVertexArray,Y=p?f.text.placedSymbolArray:f.icon.placedSymbolArray,ee=l.transform.width/l.transform.height;let ne,le=!1;for(let de=0;de<Y.length;de++){const pe=Y.get(de),{numGlyphs:ae,writingMode:ce}=pe;if(ce!==u.bI.vertical||le||ne===u.bI.horizontal||(le=!0),ne=ce,(pe.hidden||ce===u.bI.vertical)&&!le){Ou(ae,U);continue}le=!1;const ue=new u.P(pe.tileAnchorX,pe.tileAnchorY);let{x:Me,y:ye,z:je}=R.projection.projectTilePoint(ue.x,ue.y,P.canonical);if(I){const[Ct,Lt,vt]=I(ue);Me+=Ct,ye+=Lt,je+=vt}const Le=[Me,ye,je,1];if(u.aA(Le,Le,r),!Ng(Le,H)){Ou(ae,U);continue}const Ge=Le[3],rt=zg(l.transform.getCameraToCenterDistance(R.projection),Ge),Se=u.bJ(z,L,pe),_e=b?Se/rt:Se*rt,ze=_n(Me,ye,je,_);if(ze[3]<=0){Ou(ae,U);continue}let Re={};const We=u.al(f.layers[0].layout.get("text-max-angle")),Ze=Math.cos(We),Ye=b?null:I,ct=Or(pe,_e,!1,S,r,_,v,f.glyphOffsetArray,G,U,q,ze,ue,Re,ee,Ye,R.projection,P,b,Ze);le=ct.useVertical,Ye&&ct.needsFlipping&&(Re={}),(ct.notEnoughRoom||le||ct.needsFlipping&&Or(pe,_e,!0,S,r,_,v,f.glyphOffsetArray,G,U,q,ze,ue,Re,ee,Ye,R.projection,P,b,Ze).notEnoughRoom)&&Ou(ae,U)}p?(f.text.dynamicLayoutVertexBuffer.updateData(U),q&&f.text.globeExtVertexBuffer&&f.text.globeExtVertexBuffer.updateData(q)):(f.icon.dynamicLayoutVertexBuffer.updateData(U),q&&f.icon.globeExtVertexBuffer&&f.icon.globeExtVertexBuffer.updateData(q))}function Qt(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q){const{lineStartIndex:G,glyphStartIndex:Y,segment:ee}=S,ne=Y+S.numGlyphs,le=G+S.lineLength,de=r.getoffsetX(Y),pe=r.getoffsetX(ne-1),ae=Ru(f*de,l,p,_,v,b,ee,G,le,I,P,R,z,L,!0,B,H,U,q);if(!ae)return null;const ce=Ru(f*pe,l,p,_,v,b,ee,G,le,I,P,R,z,L,!0,B,H,U,q);return ce?{first:ae,last:ce}:null}function Bg(f,r,l,p){return f===u.bI.horizontal&&Math.abs(p)>Math.abs(l)?{useVertical:!0}:f===u.bI.vertical?p>0?{needsFlipping:!0}:null:r!==wc.unknown&&(0===(_=l)||Math.abs(p/_)>rv)?r===wc.flipRequired?{needsFlipping:!0}:null:l<0?{needsFlipping:!0}:null;var _}function Or(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q,G,Y,ee){const ne=r/24,le=f.lineOffsetX*ne,de=f.lineOffsetY*ne,{lineStartIndex:pe,glyphStartIndex:ae,numGlyphs:ce,segment:ue,writingMode:Me,flipState:ye}=f,je=pe+f.lineLength,Le=Ge=>{if(R){const[ze,Re,We]=Ge.up,Ze=P.length;u.bK(R,Ze+0,ze,Re,We),u.bK(R,Ze+1,ze,Re,We),u.bK(R,Ze+2,ze,Re,We),u.bK(R,Ze+3,ze,Re,We)}const[rt,Se,_e]=Ge.point;u.bL(P,rt,Se,_e,Ge.angle)};if(ce>1){const Ge=Qt(ne,S,le,de,l,z,L,f,I,v,B,U,!1,q,G,Y,ee);if(!Ge)return{notEnoughRoom:!0};if(p&&!l){let[rt,Se,_e]=Ge.first.point,[ze,Re,We]=Ge.last.point;[rt,Se]=_n(rt,Se,_e,b),[ze,Re]=_n(ze,Re,We,b);const Ze=Bg(Me,ye,(ze-rt)*H,Re-Se);if(f.flipState=Ze&&Ze.needsFlipping?wc.flipRequired:wc.flipNotRequired,Ze)return Ze}Le(Ge.first);for(let rt=ae+1;rt<ae+ce-1;rt++){const Se=Ru(ne*S.getoffsetX(rt),le,de,l,z,L,ue,pe,je,I,v,B,U,!1,!1,q,G,Y,ee);if(!Se)return P.length-=4*(rt-ae),{notEnoughRoom:!0};Le(Se)}Le(Ge.last)}else{if(p&&!l){const rt=_n(L.x,L.y,0,_),Se=pe+ue+1,_e=new u.P(I.getx(Se),I.gety(Se)),ze=_n(_e.x,_e.y,0,_),Re=ze[3]>0?ze:Yn(L,_e,rt,1,_,void 0,q,G.canonical),We=Bg(Me,ye,(Re[0]-rt[0])*H,Re[1]-rt[1]);if(f.flipState=We&&We.needsFlipping?wc.flipRequired:wc.flipNotRequired,We)return We}const Ge=Ru(ne*S.getoffsetX(ae),le,de,l,z,L,ue,pe,je,I,v,B,U,!1,!1,q,G,Y,ee);if(!Ge)return{notEnoughRoom:!0};Le(Ge)}return{}}function Pu(f,r,l,p,_){const{x:v,y:b,z:S}=p.projectTilePoint(f.x,f.y,r);if(!_)return _n(v,b,S,l);const[I,P,R]=_(f);return _n(v+I,b+P,S+R,l)}function Yn(f,r,l,p,_,v,b,S){const I=Pu(f.sub(r)._unit()._add(f),S,_,b,v);return u.at(I,l,I),u.au(I,I),u.bE(I,l,I,p)}function Ru(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q,G,Y){const ee=p?f-r:f+r;let ne=ee>0?1:-1,le=0;p&&(ne*=-1,le=Math.PI),ne<0&&(le+=Math.PI);let de=S+b+(ne>0?0:1)|0,pe=_,ae=_,ce=0,ue=0;const Me=Math.abs(ee),ye=[],je=[];let Le=v,Ge=Le,rt=u.bC([]);const Se=()=>Yn(Ge,Le,ae,Me-ce+1,R,L,U,q.canonical);for(;ce+ue<=Me;){if(de+=ne,de<S||de>=I)return null;if(ae=pe,Ge=Le,ye.push(ae),B&&je.push(Ge),Le=new u.P(P.getx(de),P.gety(de)),pe=z[de],!pe){const vt=Pu(Le,q.canonical,R,U,L);pe=vt[3]>0?z[de]=vt:Se()}ce+=ue;const Ct=u.at([],pe,ae),Lt=u.bD(ae,pe);if(l&&Lt>0&&ue>0&&u.bG(rt,Ct)/(ue*Lt)<Y)return null;ue=Lt,rt=Ct}H&&L&&(z[de]&&(pe=Se(),ue=u.bD(ae,pe),rt=u.at([],pe,ae)),z[de]=pe);const _e=(Me-ce)/ue,ze=Le.sub(Ge)._mult(_e)._add(Ge),Re=u.bE([],ae,rt,_e);let We=[0,0,1],Ze=rt[0],Ye=rt[1];if(G&&(We=U.upVector(q.canonical,ze.x,ze.y),0!==We[0]||0!==We[1]||1!==We[2])){const Ct=[We[2],0,-We[0]],Lt=u.bF([],We,Ct);u.au(Ct,Ct),u.au(Lt,Lt),Ze=u.bG(rt,Ct),Ye=u.bG(rt,Lt)}if(l){const Ct=u.bF([],We,rt);u.au(Ct,Ct),u.bE(Re,Re,Ct,l*ne)}const ct=le+Math.atan2(Ye,Ze);return ye.push(Re),B&&je.push(ze),{point:Re,angle:ct,path:ye,tilePath:je,up:We}}function Ou(f,r){const l=r.length,p=l+4*f;r.resize(p),r.float32.fill(-1/0,4*l,4*p)}function Vd(f,r,l){const p=r[0],_=r[1];return f[0]=l[0]*p+l[4]*_+l[12],f[1]=l[1]*p+l[5]*_+l[13],f[3]=l[3]*p+l[7]*_+l[15],f}const Ft=100;class uf{constructor(r,l,p=new zd(r.width+200,r.height+200,25),_=new zd(r.width+200,r.height+200,25)){this.transform=r,this.grid=p,this.ignoredGrid=_,this.pitchfactor=Math.cos(r._pitch)*r.cameraToCenterDistance,this.screenRightBoundary=r.width+Ft,this.screenBottomBoundary=r.height+Ft,this.gridRightBoundary=r.width+200,this.gridBottomBoundary=r.height+200,this.fogState=l}placeCollisionBox(r,l,p,_,v,b,S,I,P,R,z){let L=p.projectedAnchorX,B=p.projectedAnchorY,H=p.projectedAnchorZ;const U=p.tileAnchorX,q=p.tileAnchorY,G=p.elevation,Y=p.tileID,ee=r.getProjection();if(G&&Y){const[je,Le,Ge]=ee.upVector(Y.canonical,p.tileAnchorX,p.tileAnchorY),rt=ee.upVectorScale(Y.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;L+=je*G*rt,B+=Le*G*rt,H+=Ge*G*rt}const ne="globe"===r.projection.name,le="globe"===r.projection.name?u.ah(this.transform.zoom):0;if(Y&&ne&&le<1&&!b){const je=1<<Y.canonical.z,Le=u.bM(U,q);u.bN(Le,Le,1/u.aj),u.bO(Le,Le,u.bM(Y.canonical.x,Y.canonical.y)),u.bN(Le,Le,1/je),u.bP(Le,Le,u.bM(_[0],_[1])),Le[0]=u.bQ(Le[0],-.5,.5),u.bN(Le,Le,u.aj);const Ge=u.bR(Le[0],Le[1],u.aj/(2*Math.PI),1);u.aA(Ge,Ge,v),L=u.ai(L,Ge[0],le),B=u.ai(B,Ge[1],le),H=u.ai(H,Ge[2],le)}const de=this.projectAndGetPerspectiveRatio(R,L,B,H,p.tileID,"globe"===ee.name||!!G||this.transform.pitch>0,ee),pe=P*de.perspectiveRatio,ae=(p.x1*l+S.x-p.padding)*pe+de.point.x,ce=(p.y1*l+S.y-p.padding)*pe+de.point.y,ue=(p.x2*l+S.x+p.padding)*pe+de.point.x,Me=(p.y2*l+S.y+p.padding)*pe+de.point.y,ye=de.perspectiveRatio<=.55||de.occluded;return!this.isInsideGrid(ae,ce,ue,Me)||!I&&this.grid.hitTest(ae,ce,ue,Me,z)||ye?{box:[],offscreen:!1,occluded:de.occluded}:{box:[ae,ce,ue,Me],offscreen:this.isOffscreen(ae,ce,ue,Me),occluded:!1}}placeCollisionCircles(r,l,p,_,v,b,S,I,P,R,z,L,B,H,U){const q=[],G=this.transform.elevation,Y=r.getProjection(),ee=G?G.getAtTileOffsetFunc(U,this.transform.center.lat,this.transform.worldSize,Y):null,ne=new u.P(p.tileAnchorX,p.tileAnchorY);let{x:le,y:de,z:pe}=Y.projectTilePoint(ne.x,ne.y,U.canonical);if(ee){const[We,Ze,Ye]=ee(ne);le+=We,de+=Ze,pe+=Ye}const ae="globe"===Y.name,ce=this.projectAndGetPerspectiveRatio(S,le,de,pe,U,ae||!!G||this.transform.pitch>0,Y),{perspectiveRatio:ue}=ce,Me=(z?b/ue:b*ue)/u.bU,ye=_n(le,de,pe,I),je=p.lineOffsetX*Me,Le=p.lineOffsetY*Me,Ge=u.al(r.layers[0].layout.get("text-max-angle")),rt=Math.cos(Ge),Se=ce.signedDistanceFromCamera>0?Qt(Me,v,je,Le,!1,ye,ne,p,_,I,{},G&&!z?ee:null,z&&!!G,Y,U,z,rt):null;let _e=!1,ze=!1,Re=!0;if(Se&&!ce.occluded){const We=.5*B*ue+H,Ze=new u.P(-100,-100),Ye=new u.P(this.screenRightBoundary,this.screenBottomBoundary),ct=new iv,{first:Ct,last:Lt}=Se,vt=Ct.path.length;let Rt=[];for(let Kt=vt-1;Kt>=1;Kt--)Rt.push(Ct.path[Kt]);for(let Kt=1;Kt<Lt.path.length;Kt++)Rt.push(Lt.path[Kt]);const At=2.5*We;P&&(Rt=Rt.map(([Kt,mn,Dn],Zt)=>(ee&&!ae&&(Dn=ee(Zt<vt-1?Ct.tilePath[vt-1-Zt]:Lt.tilePath[Zt-vt+2])[2]),_n(Kt,mn,Dn,P))),Rt.some(Kt=>Kt[3]<=0)&&(Rt=[]));let qt=[];if(Rt.length>0){let Kt=1/0,mn=-1/0,Dn=1/0,Zt=-1/0;for(const An of Rt)Kt=Math.min(Kt,An[0]),Dn=Math.min(Dn,An[1]),mn=Math.max(mn,An[0]),Zt=Math.max(Zt,An[1]);mn>=Ze.x&&Kt<=Ye.x&&Zt>=Ze.y&&Dn<=Ye.y&&(qt=[Rt.map(An=>new u.P(An[0],An[1]))],(Kt<Ze.x||mn>Ye.x||Dn<Ze.y||Zt>Ye.y)&&(qt=u.bS(qt,Ze.x,Ze.y,Ye.x,Ye.y)))}for(const Kt of qt){ct.reset(Kt,.25*We);let mn=0;mn=ct.length<=.5*We?1:Math.ceil(ct.paddedLength/At)+1;for(let Dn=0;Dn<mn;Dn++){const Zt=Dn/Math.max(mn-1,1),An=ct.lerp(Zt),Ln=An.x+Ft,ei=An.y+Ft;q.push(Ln,ei,We,0);const un=Ln-We,kn=ei-We,zn=Ln+We,In=ei+We;if(Re=Re&&this.isOffscreen(un,kn,zn,In),ze=ze||this.isInsideGrid(un,kn,zn,In),!l&&this.grid.hitTestCircle(Ln,ei,We,L)&&(_e=!0,!R))return{circles:[],offscreen:!1,collisionDetected:_e,occluded:!1}}}}return{circles:!R&&_e||!ze?[]:q,offscreen:Re,collisionDetected:_e,occluded:ce.occluded}}queryRenderedSymbols(r){if(0===r.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const l=[];let p=1/0,_=1/0,v=-1/0,b=-1/0;for(const R of r){const z=new u.P(R.x+Ft,R.y+Ft);p=Math.min(p,z.x),_=Math.min(_,z.y),v=Math.max(v,z.x),b=Math.max(b,z.y),l.push(z)}const S=this.grid.query(p,_,v,b).concat(this.ignoredGrid.query(p,_,v,b)),I={},P={};for(const R of S){const z=R.key;if(void 0===I[z.bucketInstanceId]&&(I[z.bucketInstanceId]={}),I[z.bucketInstanceId][z.featureIndex])continue;const L=[new u.P(R.x1,R.y1),new u.P(R.x2,R.y1),new u.P(R.x2,R.y2),new u.P(R.x1,R.y2)];u.bT(l,L)&&(I[z.bucketInstanceId][z.featureIndex]=!0,void 0===P[z.bucketInstanceId]&&(P[z.bucketInstanceId]=[]),P[z.bucketInstanceId].push(z.featureIndex))}return P}insertCollisionBox(r,l,p,_,v){(l?this.ignoredGrid:this.grid).insert({bucketInstanceId:p,featureIndex:_,collisionGroupID:v},r[0],r[1],r[2],r[3])}insertCollisionCircles(r,l,p,_,v){const b=l?this.ignoredGrid:this.grid,S={bucketInstanceId:p,featureIndex:_,collisionGroupID:v};for(let I=0;I<r.length;I+=4)b.insertCircle(S,r[I],r[I+1],r[I+2])}projectAndGetPerspectiveRatio(r,l,p,_,v,b,S){const I=[l,p,_,1];let P=!1;_||this.transform.pitch>0?(u.aA(I,I,r),this.fogState&&v&&"globe"!==S.name&&(P=function(L,B,H,U,q,G){const Y=G.calculateFogTileMatrix(q),ee=[B,H,U];return u.ad(ee,ee,Y),kt(L,u.ae(ee),G.pitch,G._fov)}(this.fogState,l,p,_,v.toUnwrapped(),this.transform)>.9)):Vd(I,I,r);const R=I[3];return{point:new u.P((I[0]/R+1)/2*this.transform.width+Ft,(-I[1]/R+1)/2*this.transform.height+Ft),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(S)/R*.5,1.5),signedDistanceFromCamera:R,occluded:b&&I[2]>R||P}}isOffscreen(r,l,p,_){return p<Ft||r>=this.screenRightBoundary||_<Ft||l>this.screenBottomBoundary}isInsideGrid(r,l,p,_){return p>=0&&r<this.gridRightBoundary&&_>=0&&l<this.gridBottomBoundary}getViewportMatrix(){const r=u.bx([]);return u.bo(r,r,[-100,-100,0]),r}}class Lu{constructor(r,l,p,_){this.opacity=r?Math.max(0,Math.min(1,r.opacity+(r.placed?l:-l))):_&&p?1:0,this.placed=p}isHidden(){return 0===this.opacity&&!this.placed}}class Ec{constructor(r,l,p,_,v,b=!1){this.text=new Lu(r?r.text:null,l,p,v),this.icon=new Lu(r?r.icon:null,l,_,v),this.clipped=b}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Un{constructor(r,l,p,_=!1){this.text=r,this.icon=l,this.skipFade=p,this.clipped=_}}class jd{constructor(){this.invProjMatrix=u.bz(),this.viewportMatrix=u.bz(),this.circles=[]}}class Tc{constructor(r,l,p,_,v){this.bucketInstanceId=r,this.featureIndex=l,this.sourceLayerIndex=p,this.bucketIndex=_,this.tileID=v}}class Et{constructor(r){this.crossSourceCollisions=r,this.maxGroupID=0,this.collisionGroups={}}get(r){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[r]){const l=++this.maxGroupID;this.collisionGroups[r]={ID:l,predicate:p=>p.collisionGroupID===l}}return this.collisionGroups[r]}}function Hn(f,r,l,p,_){const{horizontalAlign:v,verticalAlign:b}=u.bZ(f),S=-(v-.5)*r,I=-(b-.5)*l,P=u.b_(f,p);return new u.P(S+P[0]*_,I+P[1]*_)}function Zn(f,r,l,p,_){const v=new u.P(f,r);return l&&v._rotate(p?_:-_),v}class mi{constructor(r,l,p,_,v,b){this.transform=r.clone(),this.projection=r.projection.name,this.collisionIndex=new uf(this.transform,v),this.buildingIndex=b,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=l,this.retainedQueryData={},this.collisionGroups=new Et(p),this.collisionCircleArrays={},this.prevPlacement=_,_&&(_.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(r,l,p,_,v=1){const b=p.getBucket(l),S=p.latestFeatureIndex;if(!b||!S||l.fqid!==b.layerIds[0])return;const I=b.layers[0].layout,P=b.layers[0].paint,R=p.collisionBoxArray,z=Math.pow(2,this.transform.zoom-p.tileID.overscaledZ),L=p.tileSize/u.aj,B=p.tileID.toUnwrapped();this.transform.setProjection(b.projection);const H=(U=p.tileID,q=b.getProjection(),G=this.transform,q.name===this.projection?G.calculateProjMatrix(U.toUnwrapped()):sa(G,q,U));var U,q,G;const Y="map"===I.get("text-pitch-alignment"),ee="map"===I.get("text-rotation-alignment");l.compileFilter(l.options);const ne=l.dynamicFilter(),le=l.dynamicFilterNeedsFeature(),de=this.transform.calculatePixelsToTileUnitsMatrix(p),pe=Bd(H,p.tileID.canonical,Y,ee,this.transform,b.getProjection(),de);let ae=null;const ce=b.getProjection().createInversionMatrix(this.transform,p.tileID.canonical);if(Y){const _e=qr(H,p.tileID.canonical,Y,ee,this.transform,b.getProjection(),de);ae=u.az([],this.transform.labelPlaneMatrix,_e)}let ue=null;ne&&p.latestFeatureIndex&&(ue={unwrappedTileID:B,dynamicFilter:ne,dynamicFilterNeedsFeature:le}),this.retainedQueryData[b.bucketInstanceId]=new Tc(b.bucketInstanceId,S,b.sourceLayerIndex,b.index,p.tileID);const[Me,ye]=b.layers[0].layout.get("text-size-scale-range"),je=u.ay(v,Me,ye),[Le,Ge]=I.get("icon-size-scale-range"),rt=u.ay(v,Le,Ge),Se={bucket:b,layout:I,paint:P,posMatrix:H,invMatrix:ce,mercatorCenter:[u.aD(this.transform.center.lng),u.aH(this.transform.center.lat)],textLabelPlaneMatrix:pe,labelToScreenMatrix:ae,clippingData:ue,scale:z,textPixelRatio:L,holdingForFade:p.holdingForFade(),collisionBoxArray:R,partiallyEvaluatedTextSize:u.bH(b.textSizeData,this.transform.zoom,je),partiallyEvaluatedIconSize:u.bH(b.iconSizeData,this.transform.zoom,rt),collisionGroup:this.collisionGroups.get(b.sourceID),latestFeatureIndex:p.latestFeatureIndex};if(_)for(const _e of b.sortKeyRanges){const{sortKey:ze,symbolInstanceStart:Re,symbolInstanceEnd:We}=_e;r.push({sortKey:ze,symbolInstanceStart:Re,symbolInstanceEnd:We,parameters:Se})}else r.push({symbolInstanceStart:0,symbolInstanceEnd:b.symbolInstances.length,parameters:Se})}attemptAnchorPlacement(r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q,G,Y,ee,ne,le){const{textOffset0:de,textOffset1:pe,crossTileID:ae}=U,ce=[de,pe],ue=Hn(r,b,S,ce,I),Me=this.collisionIndex.placeCollisionBox(G,I,l,p,_,v,Zn(ue.x,ue.y,P,R,this.transform.angle),H,z,L,B.predicate);if(ee){const ye=G.getSymbolInstanceIconSize(le,this.transform.zoom,U.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(G,ye,ee,p,_,v,Zn(ue.x,ue.y,P,R,this.transform.angle),H,z,L,B.predicate).box.length)return}if(Me.box.length>0){let ye;return this.prevPlacement&&this.prevPlacement.variableOffsets[ae]&&this.prevPlacement.placements[ae]&&this.prevPlacement.placements[ae].text&&(ye=this.prevPlacement.variableOffsets[ae].anchor),this.variableOffsets[ae]={textOffset:ce,width:b,height:S,anchor:r,textScale:I,prevAnchor:ye},this.markUsedJustification(G,r,U,Y),G.allowVerticalPlacement&&(this.markUsedOrientation(G,Y,U),this.placedOrientations[ae]=Y),{shift:ue,placedGlyphBoxes:Me}}}placeLayerBucketPart(r,l,p,_,v=1){const{bucket:b,layout:S,paint:I,posMatrix:P,textLabelPlaneMatrix:R,labelToScreenMatrix:z,clippingData:L,textPixelRatio:B,mercatorCenter:H,invMatrix:U,holdingForFade:q,collisionBoxArray:G,partiallyEvaluatedTextSize:Y,partiallyEvaluatedIconSize:ee,collisionGroup:ne,latestFeatureIndex:le}=r.parameters,de=S.get("text-optional"),pe=S.get("icon-optional"),ae=S.get("text-allow-overlap"),ce=S.get("icon-allow-overlap"),ue="map"===S.get("text-rotation-alignment"),Me="map"===S.get("icon-rotation-alignment"),ye="map"===S.get("text-pitch-alignment"),je=I.get("symbol-z-offset"),Le="sea"===S.get("symbol-elevation-reference"),Ge=S.get("symbol-placement"),[rt,Se]=S.get("text-size-scale-range"),[_e,ze]=S.get("icon-size-scale-range"),Re=u.ay(v,rt,Se),We=u.ay(v,_e,ze),Ze=S.get("text-variable-anchor"),Ye=ue&&"point"!==Ge,ct=Me&&"point"!==Ge,Ct=Ze&&b.hasTextData(),Lt=b.hasIconTextFit()&&Ct&&b.hasIconData();this.transform.setProjection(b.projection);const vt=Ct||Ye,Rt=ct||Lt;let At=ae&&(ce||!b.hasIconData()||pe),qt=ce&&(ae||!b.hasTextData()||de);const Kt=!je.isConstant();!b.collisionArrays&&G&&b.deserializeCollisionBoxes(G),p&&_&&b.updateCollisionDebugBuffers(this.transform.zoom,G,Re,We);const mn=(Zt,An,Ln)=>{const{crossTileID:ei,numVerticalGlyphVertices:un}=Zt;let kn=null;if(L&&L.dynamicFilterNeedsFeature||Kt){const Zi=this.retainedQueryData[b.bucketInstanceId];kn=le.loadFeature({featureIndex:Zt.featureIndex,bucketIndex:Zi.bucketIndex,sourceLayerIndex:Zi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(L&&!(0,L.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},kn,this.retainedQueryData[b.bucketInstanceId].tileID.canonical,new u.P(Zt.tileAnchorX,Zt.tileAnchorY),this.transform.calculateDistanceTileData(L.unwrappedTileID)))return this.placements[ei]=new Un(!1,!1,!1,!0),void l.add(ei);const zn=je.evaluate(kn,{});if(l.has(ei))return;if(q)return void(this.placements[ei]=new Un(!1,!1,!1));let In=!1,on=!1,ti=!0,Gn=!1,Fi=!1,Mn=null,qn={box:null,offscreen:null,occluded:null},ci={box:null},mr=null,lr=null,tr=null,Vr=0,pa=0,Ro=0;Ln.textFeatureIndex?Vr=Ln.textFeatureIndex:Zt.useRuntimeCollisionCircles&&(Vr=Zt.featureIndex),Ln.verticalTextFeatureIndex&&(pa=Ln.verticalTextFeatureIndex);const Bs=Zi=>{Zi.tileID=this.retainedQueryData[b.bucketInstanceId].tileID;const Ji=this.transform.elevation;Zi.elevation=Le?zn:zn+(Ji?Ji.getAtTileOffset(Zi.tileID,Zi.tileAnchorX,Zi.tileAnchorY):0),Zi.elevation+=Zt.zOffset},so=Ln.textBox;if(so){Bs(so);const Zi=wi=>{let vr=u.bI.horizontal;if(b.allowVerticalPlacement&&!wi&&this.prevPlacement){const ao=this.prevPlacement.placedOrientations[ei];ao&&(this.placedOrientations[ei]=ao,vr=ao,this.markUsedOrientation(b,vr,Zt))}return vr},Ji=(wi,vr)=>{if(b.allowVerticalPlacement&&un>0&&Ln.verticalTextBox){for(const ao of b.writingModes)if(ao===u.bI.vertical?(qn=vr(),ci=qn):qn=wi(),qn&&qn.box&&qn.box.length)break}else qn=wi()};if(Ze){let wi=Ze;if(this.prevPlacement&&this.prevPlacement.variableOffsets[ei]){const cr=this.prevPlacement.variableOffsets[ei];wi.indexOf(cr.anchor)>0&&(wi=wi.filter(Qs=>Qs!==cr.anchor),wi.unshift(cr.anchor))}const vr=(cr,Qs,nd)=>{const Qc=b.getSymbolInstanceTextSize(Y,Zt,this.transform.zoom,An),id=(cr.x2-cr.x1)*Qc+2*cr.padding,ll=(cr.y2-cr.y1)*Qc+2*cr.padding,Ho=Zt.hasIconTextFit&&!ce?Qs:null;Ho&&Bs(Ho);let ma={box:[],offscreen:!1,occluded:!1};const Tr=ae?2*wi.length:wi.length;for(let Es=0;Es<Tr;++Es){const Js=this.attemptAnchorPlacement(wi[Es%wi.length],cr,H,U,vt,id,ll,Qc,ue,ye,B,P,ne,Es>=wi.length,Zt,An,b,nd,Ho,Y,ee);if(Js&&(ma=Js.placedGlyphBoxes,ma&&ma.box&&ma.box.length)){In=!0,Mn=Js.shift;break}}return ma};Ji(()=>vr(so,Ln.iconBox,u.bI.horizontal),()=>{const cr=Ln.verticalTextBox;return cr&&Bs(cr),b.allowVerticalPlacement&&!(qn&&qn.box&&qn.box.length)&&un>0&&cr?vr(cr,Ln.verticalIconBox,u.bI.vertical):{box:null,offscreen:null,occluded:null}}),qn&&(In=qn.box,ti=qn.offscreen,Gn=qn.occluded);const ao=Zi(!(!qn||!qn.box));if(!In&&this.prevPlacement){const cr=this.prevPlacement.variableOffsets[ei];cr&&(this.variableOffsets[ei]=cr,this.markUsedJustification(b,cr.anchor,Zt,ao))}}else{const wi=(vr,ao)=>{const cr=b.getSymbolInstanceTextSize(Y,Zt,this.transform.zoom,An,v),Qs=this.collisionIndex.placeCollisionBox(b,cr,vr,H,U,vt,new u.P(0,0),ae,B,P,ne.predicate);return Qs&&Qs.box&&Qs.box.length&&(this.markUsedOrientation(b,ao,Zt),this.placedOrientations[ei]=ao),Qs};Ji(()=>wi(so,u.bI.horizontal),()=>{const vr=Ln.verticalTextBox;return b.allowVerticalPlacement&&un>0&&vr?(Bs(vr),wi(vr,u.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Zi(!!(qn&&qn.box&&qn.box.length))}}if(mr=qn,In=mr&&mr.box&&mr.box.length>0,ti=mr&&mr.offscreen,Gn=mr&&mr.occluded,Zt.useRuntimeCollisionCircles){const Zi=b.text.placedSymbolArray.get(Zt.centerJustifiedTextSymbolIndex>=0?Zt.centerJustifiedTextSymbolIndex:Zt.verticalPlacedTextSymbolIndex),Ji=u.bJ(b.textSizeData,Y,Zi),wi=S.get("text-padding");lr=this.collisionIndex.placeCollisionCircles(b,ae,Zi,b.lineVertexArray,b.glyphOffsetArray,Ji,P,R,z,p,ye,ne.predicate,Zt.collisionCircleDiameter*Ji/u.bU,wi,this.retainedQueryData[b.bucketInstanceId].tileID),In=ae||lr.circles.length>0&&!lr.collisionDetected,ti=ti&&lr.offscreen,Gn=lr.occluded}if(Ln.iconFeatureIndex&&(Ro=Ln.iconFeatureIndex),Ln.iconBox){const Zi=Ji=>{Bs(Ji);const wi=Zt.hasIconTextFit&&Mn?Zn(Mn.x,Mn.y,ue,ye,this.transform.angle):new u.P(0,0),vr=b.getSymbolInstanceIconSize(ee,this.transform.zoom,Zt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(b,vr,Ji,H,U,Rt,wi,ce,B,P,ne.predicate)};ci&&ci.box&&ci.box.length&&Ln.verticalIconBox?(tr=Zi(Ln.verticalIconBox),on=tr.box.length>0):(tr=Zi(Ln.iconBox),on=tr.box.length>0),ti=ti&&tr.offscreen,Fi=tr.occluded}const Ys=de||0===Zt.numHorizontalGlyphVertices&&0===un,Ks=pe||0===Zt.numIconVertices;if(Ys||Ks?Ks?Ys||(on=on&&In):In=on&&In:on=In=on&&In,In&&mr&&mr.box&&this.collisionIndex.insertCollisionBox(mr.box,S.get("text-ignore-placement"),b.bucketInstanceId,ci&&ci.box&&pa?pa:Vr,ne.ID),on&&tr&&this.collisionIndex.insertCollisionBox(tr.box,S.get("icon-ignore-placement"),b.bucketInstanceId,Ro,ne.ID),lr&&(In&&this.collisionIndex.insertCollisionCircles(lr.circles,S.get("text-ignore-placement"),b.bucketInstanceId,Vr,ne.ID),p)){const Zi=b.bucketInstanceId;let Ji=this.collisionCircleArrays[Zi];void 0===Ji&&(Ji=this.collisionCircleArrays[Zi]=new jd);for(let wi=0;wi<lr.circles.length;wi+=4)Ji.circles.push(lr.circles[wi+0]),Ji.circles.push(lr.circles[wi+1]),Ji.circles.push(lr.circles[wi+2]),Ji.circles.push(lr.collisionDetected?1:0)}const wo="globe"!==b.projection.name;At=At&&(wo||!Gn),qt=qt&&(wo||!Fi),this.placements[ei]=new Un(In||At,on||qt,ti||b.justReloaded),l.add(ei)},Dn=this.retainedQueryData[b.bucketInstanceId].tileID;if("offset"===b.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(b,Dn),"road"===b.elevationType&&b.updateRoadElevation(Dn.canonical),b.updateZOffset(),b.sortFeaturesByY){const Zt=b.getSortedSymbolIndexes(this.transform.angle);for(let An=Zt.length-1;An>=0;--An){const Ln=Zt[An];mn(b.symbolInstances.get(Ln),Ln,b.collisionArrays[Ln])}b.hasAnyZOffset&&u.w(`${b.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(b.hasAnyZOffset){const Zt=b.getSortedIndexesByZOffset();for(let An=0;An<Zt.length;++An){const Ln=Zt[An];mn(b.symbolInstances.get(Ln),Ln,b.collisionArrays[Ln])}}else for(let Zt=r.symbolInstanceStart;Zt<r.symbolInstanceEnd;Zt++)mn(b.symbolInstances.get(Zt),Zt,b.collisionArrays[Zt]);if(p&&b.bucketInstanceId in this.collisionCircleArrays){const Zt=this.collisionCircleArrays[b.bucketInstanceId];u.bi(Zt.invProjMatrix,P),Zt.viewportMatrix=this.collisionIndex.getViewportMatrix()}b.justReloaded=!1}markUsedJustification(r,l,p,_){const{leftJustifiedTextSymbolIndex:v,centerJustifiedTextSymbolIndex:b,rightJustifiedTextSymbolIndex:S,verticalPlacedTextSymbolIndex:I,crossTileID:P}=p,R=u.b$(l),z=_===u.bI.vertical?I:"left"===R?v:"center"===R?b:"right"===R?S:-1;v>=0&&(r.text.placedSymbolArray.get(v).crossTileID=z>=0&&v!==z?0:P),b>=0&&(r.text.placedSymbolArray.get(b).crossTileID=z>=0&&b!==z?0:P),S>=0&&(r.text.placedSymbolArray.get(S).crossTileID=z>=0&&S!==z?0:P),I>=0&&(r.text.placedSymbolArray.get(I).crossTileID=z>=0&&I!==z?0:P)}markUsedOrientation(r,l,p){const _=l===u.bI.horizontal||l===u.bI.horizontalOnly?l:0,v=l===u.bI.vertical?l:0,{leftJustifiedTextSymbolIndex:b,centerJustifiedTextSymbolIndex:S,rightJustifiedTextSymbolIndex:I,verticalPlacedTextSymbolIndex:P}=p,R=r.text.placedSymbolArray;b>=0&&(R.get(b).placedOrientation=_),S>=0&&(R.get(S).placedOrientation=_),I>=0&&(R.get(I).placedOrientation=_),P>=0&&(R.get(P).placedOrientation=v)}commit(r){this.commitTime=r,this.zoomAtLastRecencyCheck=this.transform.zoom;const l=this.prevPlacement;let p=!1;this.prevZoomAdjustment=l?l.zoomAdjustment(this.transform.zoom):0;const _=l?l.symbolFadeChange(r):1,v=l?l.opacities:{},b=l?l.variableOffsets:{},S=l?l.placedOrientations:{};for(const I in this.placements){const P=this.placements[I],R=v[I];R?(this.opacities[I]=new Ec(R,_,P.text,P.icon,null,P.clipped),p=p||P.text!==R.text.placed||P.icon!==R.icon.placed):(this.opacities[I]=new Ec(null,_,P.text,P.icon,P.skipFade,P.clipped),p=p||P.text||P.icon)}for(const I in v){const P=v[I];if(!this.opacities[I]){const R=new Ec(P,_,!1,!1);R.isHidden()||(this.opacities[I]=R,p=p||P.text.placed||P.icon.placed)}}for(const I in b)this.variableOffsets[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.variableOffsets[I]=b[I]);for(const I in S)this.placedOrientations[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.placedOrientations[I]=S[I]);p?this.lastPlacementChangeTime=r:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=l?l.lastPlacementChangeTime:r)}updateLayerOpacities(r,l,p,_){const v=new Set;for(const b of l){const S=b.getBucket(r);S&&b.latestFeatureIndex&&r.fqid===S.layerIds[0]&&(this.updateBucketOpacities(S,v,b,b.collisionBoxArray,p,_,b.tileID,r.scope),"offset"===S.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(S,b.tileID),"road"===S.elevationType&&S.updateRoadElevation(b.tileID.canonical),S.updateZOffset())}}updateBucketOpacities(r,l,p,_,v,b,S,I){r.hasTextData()&&r.text.opacityVertexArray.clear(),r.hasIconData()&&r.icon.opacityVertexArray.clear(),r.hasIconCollisionBoxData()&&r.iconCollisionBox.collisionVertexArray.clear(),r.hasTextCollisionBoxData()&&r.textCollisionBox.collisionVertexArray.clear();const P=r.layers[0].layout,R=r.layers[0].paint,z=!!r.layers[0].dynamicFilter(),L=new Ec(null,0,!1,!1,!0),B=P.get("text-allow-overlap"),H=P.get("icon-allow-overlap"),U=P.get("text-variable-anchor"),q="map"===P.get("text-rotation-alignment"),G="map"===P.get("text-pitch-alignment"),Y=R.get("symbol-z-offset"),ee="sea"===P.get("symbol-elevation-reference"),ne=!Y.isConstant(),le=new Ec(null,0,B&&(H||!r.hasIconData()||P.get("icon-optional")),H&&(B||!r.hasTextData()||P.get("text-optional")),!0);!r.collisionArrays&&_&&(r.hasIconCollisionBoxData()||r.hasTextCollisionBoxData())&&r.deserializeCollisionBoxes(_);const de=(ae,ce,ue)=>{for(let Me=0;Me<ce/4;Me++)ae.opacityVertexArray.emplaceBack(ue)};let pe=0;b&&r.updateReplacement(S,b);for(let ae=0;ae<r.symbolInstances.length;ae++){const ce=r.symbolInstances.get(ae),{numHorizontalGlyphVertices:ue,numVerticalGlyphVertices:Me,crossTileID:ye,numIconVertices:je,tileAnchorX:Le,tileAnchorY:Ge}=ce;let rt=null;const Se=this.retainedQueryData[r.bucketInstanceId];ne&&ce&&Se&&(rt=p.latestFeatureIndex.loadFeature({featureIndex:ce.featureIndex,bucketIndex:Se.bucketIndex,sourceLayerIndex:Se.sourceLayerIndex,layoutVertexArrayOffset:0}));const _e=Y.evaluate(rt,{}),ze=l.has(ye);let Re=this.opacities[ye];ze?Re=L:Re||(Re=le,this.opacities[ye]=Re),l.add(ye);const We=ue>0||Me>0,Ze=je>0,Ye=this.placedOrientations[ye],ct=Ye===u.bI.vertical,Ct=Ye===u.bI.horizontal||Ye===u.bI.horizontalOnly;!We&&!Ze||Re.isHidden()||pe++;let Lt=!1;if((We||Ze)&&b)for(const vt of r.activeReplacements){if(u.bV(vt,v,u.bW.Symbol,I)||vt.min.x>Le||Le>vt.max.x||vt.min.y>Ge||Ge>vt.max.y)continue;const Rt=u.bX(Le,Ge,S.canonical,vt.footprintTileId.canonical);if(Lt=u.bY(Rt,vt.footprint),Lt)break}if(We){const vt=Lt?Ic:zl(Re.text);de(r.text,ue,ct?Ic:vt),de(r.text,Me,Ct?Ic:vt);const Rt=Re.text.isHidden(),{leftJustifiedTextSymbolIndex:At,centerJustifiedTextSymbolIndex:qt,rightJustifiedTextSymbolIndex:Kt,verticalPlacedTextSymbolIndex:mn}=ce,Dn=r.text.placedSymbolArray,Zt=Rt||ct?1:0;At>=0&&(Dn.get(At).hidden=Zt),qt>=0&&(Dn.get(qt).hidden=Zt),Kt>=0&&(Dn.get(Kt).hidden=Zt),mn>=0&&(Dn.get(mn).hidden=Rt||Ct?1:0);const An=this.variableOffsets[ye];An&&this.markUsedJustification(r,An.anchor,ce,Ye);const Ln=this.placedOrientations[ye];Ln&&(this.markUsedJustification(r,"left",ce,Ln),this.markUsedOrientation(r,Ln,ce))}if(Ze){const vt=Lt?Ic:zl(Re.icon),{placedIconSymbolIndex:Rt,verticalPlacedIconSymbolIndex:At}=ce,qt=r.icon.placedSymbolArray,Kt=Re.icon.isHidden()?1:0;Rt>=0&&(de(r.icon,je,ct?Ic:vt),qt.get(Rt).hidden=Kt),At>=0&&(de(r.icon,ce.numVerticalIconVertices,Ct?Ic:vt),qt.get(At).hidden=Kt)}if(r.hasIconCollisionBoxData()||r.hasTextCollisionBoxData()){const vt=r.collisionArrays[ae];if(vt){let Rt=new u.P(0,0),At=!0;if(vt.textBox||vt.verticalTextBox){if(U){const Kt=this.variableOffsets[ye];Kt?(Rt=Hn(Kt.anchor,Kt.width,Kt.height,Kt.textOffset,Kt.textScale),q&&Rt._rotate(G?this.transform.angle:-this.transform.angle)):At=!1}z&&(At=!Re.clipped),vt.textBox&&Fl(r.textCollisionBox.collisionVertexArray,Re.text.placed,!At||ct,_e,ee,Rt.x,Rt.y),vt.verticalTextBox&&Fl(r.textCollisionBox.collisionVertexArray,Re.text.placed,!At||Ct,_e,ee,Rt.x,Rt.y)}const qt=At&&!(Ct||!vt.verticalIconBox);vt.iconBox&&Fl(r.iconCollisionBox.collisionVertexArray,Re.icon.placed,qt,_e,ee,ce.hasIconTextFit?Rt.x:0,ce.hasIconTextFit?Rt.y:0),vt.verticalIconBox&&Fl(r.iconCollisionBox.collisionVertexArray,Re.icon.placed,!qt,_e,ee,ce.hasIconTextFit?Rt.x:0,ce.hasIconTextFit?Rt.y:0)}}}if(r.fullyClipped=0===pe,r.sortFeatures(this.transform.angle),this.retainedQueryData[r.bucketInstanceId]&&(this.retainedQueryData[r.bucketInstanceId].featureSortOrder=r.featureSortOrder),r.hasTextData()&&r.text.opacityVertexBuffer&&r.text.opacityVertexBuffer.updateData(r.text.opacityVertexArray),r.hasIconData()&&r.icon.opacityVertexBuffer&&r.icon.opacityVertexBuffer.updateData(r.icon.opacityVertexArray),r.hasIconCollisionBoxData()&&r.iconCollisionBox.collisionVertexBuffer&&r.iconCollisionBox.collisionVertexBuffer.updateData(r.iconCollisionBox.collisionVertexArray),r.hasTextCollisionBoxData()&&r.textCollisionBox.collisionVertexBuffer&&r.textCollisionBox.collisionVertexBuffer.updateData(r.textCollisionBox.collisionVertexArray),r.bucketInstanceId in this.collisionCircleArrays){const ae=this.collisionCircleArrays[r.bucketInstanceId];r.placementInvProjMatrix=ae.invProjMatrix,r.placementViewportMatrix=ae.viewportMatrix,r.collisionCircleArray=ae.circles,delete this.collisionCircleArrays[r.bucketInstanceId]}}symbolFadeChange(r){return 0===this.fadeDuration?1:(r-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(r){return Math.max(0,(this.transform.zoom-r)/1.5)}hasTransitions(r){return this.stale||r-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(r,l){const p=this.zoomAtLastRecencyCheck===l?1-this.zoomAdjustment(l):1;return this.zoomAtLastRecencyCheck=l,this.commitTime+this.fadeDuration*p>r}setStale(){this.stale=!0}}function Fl(f,r,l,p,_,v,b){f.emplaceBack(r?1:0,l?1:0,v||0,b||0,p,_?1:0),f.emplaceBack(r?1:0,l?1:0,v||0,b||0,p,_?1:0),f.emplaceBack(r?1:0,l?1:0,v||0,b||0,p,_?1:0),f.emplaceBack(r?1:0,l?1:0,v||0,b||0,p,_?1:0)}const Kn=Math.pow(2,25),Jt=Math.pow(2,24),Sc=Math.pow(2,17),Dc=Math.pow(2,16),fo=Math.pow(2,9),yr=Math.pow(2,8),ov=Math.pow(2,1);function zl(f){if(0===f.opacity&&!f.placed)return 0;if(1===f.opacity&&f.placed)return 4294967295;const r=f.placed?1:0,l=Math.floor(127*f.opacity);return l*Kn+r*Jt+l*Sc+r*Dc+l*fo+r*yr+l*ov+r}const Ic=0;class df{constructor(r){this._sortAcrossTiles="viewport-y"!==r.layout.get("symbol-z-order")&&void 0!==r.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(r,l,p,_,v,b){const S=this._bucketParts;for(;this._currentTileIndex<r.length;)if(l.getBucketParts(S,_,r[this._currentTileIndex],this._sortAcrossTiles,b),this._currentTileIndex++,v())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,S.sort((I,P)=>I.sortKey-P.sortKey));this._currentPartIndex<S.length;){const I=S[this._currentPartIndex];if(l.placeLayerBucketPart(I,this._seenCrossTileIDs,p,0===I.symbolInstanceStart,b),this._currentPartIndex++,v())return!0}return!1}}class Fp{constructor(r,l,p,_,v,b,S,I,P){this.placement=new mi(r,v,b,S,I,P),this._currentPlacementIndex=l.length-1,this._forceFullPlacement=p,this._showCollisionBoxes=_,this._done=!1}isDone(){return this._done}continuePlacement(r,l,p,_,v){const b=u.q.now(),S=()=>{const I=u.q.now()-b;return!this._forceFullPlacement&&I>2};for(;this._currentPlacementIndex>=0;){const I=l[r[this._currentPlacementIndex]],P=this.placement.collisionIndex.transform.zoom;if("symbol"===I.type&&(!I.minzoom||I.minzoom<=P)&&(!I.maxzoom||I.maxzoom>P)){const R=I,z=R.layout.get("symbol-z-elevate"),L=void 0!==R.layout.get("symbol-sort-key").constantOr(1),B=R.layout.get("symbol-z-order"),H="viewport-y"===B||"auto"===B&&!("viewport-y"!==B&&L),U=R.layout.get("text-allow-overlap")||R.layout.get("icon-allow-overlap")||R.layout.get("text-ignore-placement")||R.layout.get("icon-ignore-placement"),q=H&&U,G=this._inProgressLayer=this._inProgressLayer||new df(R),Y=u.C(I.source,I.scope);if(G.continuePlacement(z||q?_[Y]:p[Y],this.placement,this._showCollisionBoxes,I,S,v))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(r){return this.placement.commit(r),this.placement}}const hf=512/u.aj/2;class zp{constructor(r,l,p){this.tileID=r,this.bucketInstanceId=p,this.index=new u.c0(l.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const _=r.canonical.x*u.aj,v=r.canonical.y*u.aj;for(let b=0;b<l.length;b++){const{key:S,crossTileID:I,tileAnchorX:P,tileAnchorY:R}=l.get(b),z=Math.floor((_+P)*hf),L=Math.floor((v+R)*hf);this.index.add(z,L),this.keys.push(S),this.crossTileIDs.push(I)}this.index.finish()}findMatches(r,l,p){const _=this.tileID.canonical.z<l.canonical.z?1:Math.pow(2,this.tileID.canonical.z-l.canonical.z),v=hf/Math.pow(2,l.canonical.z-this.tileID.canonical.z),b=l.canonical.x*u.aj,S=l.canonical.y*u.aj;for(let I=0;I<r.length;I++){const P=r.get(I);if(P.crossTileID)continue;const{key:R,tileAnchorX:z,tileAnchorY:L}=P,B=Math.floor((b+z)*v),H=Math.floor((S+L)*v),U=this.index.range(B-_,H-_,B+_,H+_).sort((q,G)=>q-G);for(const q of U){const G=this.crossTileIDs[q];if(this.keys[q]===R&&!p.has(G)){p.add(G),P.crossTileID=G;break}}}}}class Wr{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class aa{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(r){const l=Math.round((r-this.lng)/360);if(0!==l)for(const p in this.indexes){const _=this.indexes[p],v={};for(const b in _){const S=_[b];S.tileID=S.tileID.unwrapTo(S.tileID.wrap+l),v[S.tileID.key]=S}this.indexes[p]=v}this.lng=r}addBucket(r,l,p){if(this.indexes[r.overscaledZ]&&this.indexes[r.overscaledZ][r.key]){if(this.indexes[r.overscaledZ][r.key].bucketInstanceId===l.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(r.overscaledZ,this.indexes[r.overscaledZ][r.key])}for(let v=0;v<l.symbolInstances.length;v++)l.symbolInstances.get(v).crossTileID=0;this.usedCrossTileIDs[r.overscaledZ]||(this.usedCrossTileIDs[r.overscaledZ]=new Set);const _=this.usedCrossTileIDs[r.overscaledZ];for(const v in this.indexes){const b=this.indexes[v];if(Number(v)>r.overscaledZ)for(const S in b){const I=b[S];I.tileID.isChildOf(r)&&I.findMatches(l.symbolInstances,r,_)}else{const S=b[r.scaledTo(Number(v)).key];S&&S.findMatches(l.symbolInstances,r,_)}}for(let v=0;v<l.symbolInstances.length;v++){const b=l.symbolInstances.get(v);b.crossTileID||(b.crossTileID=p.generate(),_.add(b.crossTileID))}return void 0===this.indexes[r.overscaledZ]&&(this.indexes[r.overscaledZ]={}),this.indexes[r.overscaledZ][r.key]=new zp(r,l.symbolInstances,l.bucketInstanceId),!0}removeBucketCrossTileIDs(r,l){for(const p of l.crossTileIDs)this.usedCrossTileIDs[r].delete(p)}removeStaleBuckets(r){let l=!1;for(const p in this.indexes){const _=this.indexes[p];for(const v in _)r[_[v].bucketInstanceId]||(this.removeBucketCrossTileIDs(p,_[v]),delete _[v],l=!0)}return l}}class po{constructor(){this.layerIndexes={},this.crossTileIDs=new Wr,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(r,l,p,_){let v=this.layerIndexes[r.fqid];void 0===v&&(v=this.layerIndexes[r.fqid]=new aa);let b=!1;const S={};"globe"!==_.name&&v.handleWrapJump(p);for(const I of l){const P=I.getBucket(r);P&&r.fqid===P.layerIds[0]&&(P.bucketInstanceId||(P.bucketInstanceId=++this.maxBucketInstanceId),v.addBucket(I.tileID,P,this.crossTileIDs)&&(b=!0),S[P.bucketInstanceId]=!0)}return v.removeStaleBuckets(S)&&(b=!0),b}pruneUnusedLayers(r){const l={};r.forEach(p=>{l[p]=!0});for(const p in this.layerIndexes)l[p]||delete this.layerIndexes[p]}}class an{constructor(r,l,p,_){this.blendFunction=r,this.blendColor=l.toNonPremultipliedRenderColor(null),this.mask=p,this.blendEquation=_}}an.Replace=[1,0,1,0],an.disabled=new an(an.Replace,u.am.transparent,[!1,!1,!1,!1]),an.unblended=new an(an.Replace,u.am.transparent,[!0,!0,!0,!0]),an.alphaBlended=new an([1,771,1,771],u.am.transparent,[!0,!0,!0,!0]),an.alphaBlendedNonPremultiplied=new an([770,771,770,771],u.am.transparent,[!0,!0,!0,!0]),an.multiply=new an([774,0,774,0],u.am.transparent,[!0,!0,!0,!0]);class bt{constructor(r,l,p){this.func=r,this.mask=l,this.range=p}}bt.ReadOnly=!1,bt.ReadWrite=!0,bt.disabled=new bt(519,bt.ReadOnly,[0,1]);class Bt{constructor(r,l,p,_,v,b){this.test=r,this.ref=l,this.mask=p,this.fail=_,this.depthFail=v,this.pass=b}}Bt.disabled=new Bt({func:519,mask:0},0,0,7680,7680,7680);class Nt{constructor(r,l,p){this.enable=r,this.mode=l,this.frontFace=p}}function gt(f,r){const l=u.c6(f,3);u.c8(f,r),u.cc(f,3,l)}function Ac(f,r){const l=u.c3([]);return u.c4(l,l,-r),u.c5(l,l,-f),l}function di(f,r){const l=[f[0],f[1],0],p=[r[0],r[1],0];if(u.ae(l)>=1e-15){const b=u.au([],l);u.c1(p,b,u.bG(p,b)),r[0]=p[0],r[1]=p[1]}const _=u.bF([],r,f);if(u.c2(_)<1e-15)return null;const v=Math.atan2(-_[1],_[0]);return Ac(Math.atan2(Math.sqrt(f[0]*f[0]+f[1]*f[1]),-f[2]),v)}Nt.disabled=new Nt(!1,1029,2305),Nt.backCCW=new Nt(!0,1029,2305),Nt.backCW=new Nt(!0,1029,2304),Nt.frontCW=new Nt(!0,1028,2304),Nt.frontCCW=new Nt(!0,1028,2305);class Ud{constructor(r,l){this.position=r,this.orientation=l}get position(){return this._position}set position(r){if(r){const l=r instanceof u.ac?r:new u.ac(r[0],r[1],r[2]);this._renderWorldCopies&&(l.x=u.bQ(l.x,0,1)),this._position=l}else this._position=null}lookAtPoint(r,l){if(this.orientation=null,!this.position)return;const p=this.position,_=this._elevation?this._elevation.getAtPointOrZero(u.ac.fromLngLat(r)):0,v=u.ac.fromLngLat(r,_),b=[v.x-p.x,v.y-p.y,v.z-p.z];l||(l=[0,0,1]),l[2]=Math.abs(l[2]),this.orientation=di(b,l)}setPitchBearing(r,l){this.orientation=Ac(u.al(r),u.al(-l))}}class gs{constructor(r,l){this._transform=u.bx([]),this.orientation=l,this.position=r}get mercatorPosition(){const r=this.position;return new u.ac(r[0],r[1],r[2])}get position(){const r=u.c6(this._transform,3);return[r[0],r[1],r[2]]}set position(r){var l;r&&u.cc(this._transform,3,[(l=r)[0],l[1],l[2],1])}get orientation(){return this._orientation}set orientation(r){this._orientation=r||u.c3([]),r&&gt(this._transform,this._orientation)}getPitchBearing(){const r=this.forward(),l=this.right();return{bearing:Math.atan2(-l[1],l[0]),pitch:Math.atan2(Math.sqrt(r[0]*r[0]+r[1]*r[1]),-r[2])}}setPitchBearing(r,l){this._orientation=Ac(r,l),gt(this._transform,this._orientation)}forward(){const r=u.c6(this._transform,2);return[-r[0],-r[1],-r[2]]}up(){const r=u.c6(this._transform,1);return[-r[0],-r[1],-r[2]]}right(){const r=u.c6(this._transform,0);return[r[0],r[1],r[2]]}getCameraToWorld(r,l){const p=new Float64Array(16);return u.bi(p,this.getWorldToCamera(r,l)),p}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(r,l,p){const _=this.position;u.c1(_,_,-r);const v=new Float64Array(16);return u.bn(v,[p,p,p]),u.bo(v,v,_),v[10]*=l,v}getWorldToCamera(r,l){const p=new Float64Array(16),_=new Float64Array(4),v=this.position;return u.c7(_,this._orientation),u.c1(v,v,-r),u.c8(p,_),u.bo(p,p,v),p[1]*=-1,p[5]*=-1,p[9]*=-1,p[13]*=-1,p[8]*=l,p[9]*=l,p[10]*=l,p[11]*=l,p}getCameraToClipPerspective(r,l,p,_){const v=new Float64Array(16);return u.c9(v,r,l,p,_),v}getCameraToClipOrthographic(r,l,p,_,v,b){const S=new Float64Array(16);return u.ca(S,r,l,p,_,v,b),S}getDistanceToElevation(r,l=!1){const p=0===r?0:u.cb(r,l?u.aY(this.position[1]):this.position[1]),_=this.forward();return(p-this.position[2])/_[2]}clone(){return new gs([...this.position],[...this.orientation])}}const Zr={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Hd{constructor(r=0,l=0,p=0,_=0){if(isNaN(r)||r<0||isNaN(l)||l<0||isNaN(p)||p<0||isNaN(_)||_<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=r,this.bottom=l,this.left=p,this.right=_}interpolate(r,l,p){return null!=l.top&&null!=r.top&&(this.top=u.ai(r.top,l.top,p)),null!=l.bottom&&null!=r.bottom&&(this.bottom=u.ai(r.bottom,l.bottom,p)),null!=l.left&&null!=r.left&&(this.left=u.ai(r.left,l.left,p)),null!=l.right&&null!=r.right&&(this.right=u.ai(r.right,l.right,p)),this}getCenter(r,l){const p=u.ay((this.left+r-this.right)/2,0,r),_=u.ay((this.top+l-this.bottom)/2,0,l);return new u.P(p,_)}equals(r){return this.top===r.top&&this.bottom===r.bottom&&this.left===r.left&&this.right===r.right}clone(){return new Hd(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}class Np{constructor(r,l,p,_,v,b,S){this.tileSize=512,this._renderWorldCopies=void 0===v||v,this._minZoom=r||0,this._maxZoom=l||22,this._minPitch=p??0,this._maxPitch=_??60,this.setProjection(b),this.setMaxBounds(S),this.width=0,this.height=0,this._center=new u.ci(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Hd,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new gs,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const r=new Np(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return r._elevation=this._elevation,r._centerAltitude=this._centerAltitude,r._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,r.tileSize=this.tileSize,r.mercatorFromTransition=this.mercatorFromTransition,r.width=this.width,r.height=this.height,r.cameraElevationReference=this.cameraElevationReference,r._center=this._center,r._setZoom(this.zoom),r._seaLevelZoom=this._seaLevelZoom,r.angle=this.angle,r._fov=this._fov,r._pitch=this._pitch,r._nearZ=this._nearZ,r._farZ=this._farZ,r._averageElevation=this._averageElevation,r._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,r._unmodified=this._unmodified,r._edgeInsets=this._edgeInsets.clone(),r._camera=this._camera.clone(),r._calcMatrices(),r.freezeTileCoverage=this.freezeTileCoverage,r.frustumCorners=this.frustumCorners,r._allowWorldUnderZoom=this._allowWorldUnderZoom,r}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(r){this._elevation!==r&&(this._elevation=r,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(r,l=!1){const p=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||p)&&this._updateCameraOnTerrain(),(r||p)&&this._constrainCamera(l),this._calcMatrices()}getProjection(){return u.aF(this.projection,["name","center","parallels"])}setProjection(r){this.projectionOptions=r||{name:"mercator"};const l=this.projection?this.getProjection():void 0;this.projection=u.cj(this.projectionOptions);const p=this.getProjection(),_=!u.bv(l,p);return _&&this._calcMatrices(),this.mercatorFromTransition=!1,_}setOrthographicProjectionAtLowPitch(r){return this._orthographicProjectionAtLowPitch!==r&&(this._orthographicProjectionAtLowPitch=r,this._calcMatrices(),!0)}setMercatorFromTransition(){const r=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=u.cj({name:"mercator"});const l=r!==this.projection.name;return l&&this._calcMatrices(),l}get minZoom(){return this._minZoom}set minZoom(r){this._minZoom!==r&&(this._minZoom=r,this.zoom=Math.max(this.zoom,r))}get maxZoom(){return this._maxZoom}set maxZoom(r){this._maxZoom!==r&&(this._maxZoom=r,this.zoom=Math.min(this.zoom,r))}get minPitch(){return this._minPitch}set minPitch(r){this._minPitch!==r&&(this._minPitch=r,this.pitch=Math.max(this.pitch,r))}get maxPitch(){return this._maxPitch}set maxPitch(r){this._maxPitch!==r&&(this._maxPitch=r,this.pitch=Math.min(this.pitch,r))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(r){void 0===r?r=!0:null===r&&(r=!1),this._renderWorldCopies=r}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const r=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(r))}get cameraWorldSize(){const r=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(r))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return u.cb(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new u.P(this.width,this.height)}get bearing(){return u.bQ(this.rotation,-180,180)}set bearing(r){this.rotation=r}get rotation(){return-this.angle/Math.PI*180}set rotation(r){const l=-r*Math.PI/180;this.angle!==l&&(this._unmodified=!1,this.angle=l,this._calcMatrices(),this.rotationMatrix=u.ck(),u.cl(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(r){const l=u.ay(r,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==l&&(this._unmodified=!1,this._pitch=l,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(r){r=Math.max(.01,Math.min(60,r)),this._fov!==r&&(this._unmodified=!1,this._fov=u.al(r),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const r=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/r)}get averageElevation(){return this._averageElevation}set averageElevation(r){this._averageElevation=r,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(r){const l=Math.min(Math.max(r,this.minZoom),this.maxZoom);this._zoom!==l&&(this._unmodified=!1,this._setZoom(l),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(r){this._zoom=r,this.scale=this.zoomScale(r),this.tileZoom=Math.floor(r),this.zoomFraction=r-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(r){this._tileCoverLift!==r&&(this._tileCoverLift=r)}_updateCameraOnTerrain(){const r=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,l=this.elevation&&r===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||r===Number.NEGATIVE_INFINITY&&(!l||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const p=this._elevation;l||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&p.exaggeration()&&this._centerAltitudeValidForExaggeration!==p.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*p.exaggeration(),this._centerAltitudeValidForExaggeration=p.exaggeration()):(this._centerAltitude=r||0,this._centerAltitudeValidForExaggeration=p.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(void 0===this._centerAltitudeValidForExaggeration)return;const r=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(r)}sampleAverageElevation(){if(!this._elevation)return 0;const r=this._elevation,l=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],p=this.horizonLineFromTop();let _=0,v=0;for(let b=0;b<l.length;b++){const S=new u.P(l[b][0]*this.width,p+l[b][1]*(this.height-p)),I=r.pointCoordinate(S);if(!I)continue;const P=1/Math.hypot(I[0]-this._camera.position[0],I[1]-this._camera.position[1]);_+=I[3]*P,v+=P}return 0===v?NaN:_/v}get center(){return this._center}set center(r){r.lat===this._center.lat&&r.lng===this._center.lng||(this._unmodified=!1,this._center=r,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const r=this._seaLevelZoom,l=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),p=this.pixelsPerMeter/this.worldSize*l,_=this._mercatorZfromZoom(r),v=this._mercatorZfromZoom(this._maxZoom),b=Math.max(_-p,v);this._setZoom(this._zoomFromMercatorZ(b))}get padding(){return this._edgeInsets.toJSON()}set padding(r){this._edgeInsets.equals(r)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,r,1),this._calcMatrices())}computeZoomRelativeTo(r){const l=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,r.toAltitude()));let p;p=r.z<this._camera.position[2]?[l.x,l.y,l.z]:[r.x,r.y,r.z];const _=u.ae(u.at([],this._camera.position,p));return u.ay(this._zoomFromMercatorZ(_),this._minZoom,this._maxZoom)}setFreeCameraOptions(r){if(!this.height||!r.position&&!r.orientation)return;this._updateCameraState();let l=!1;if(r.orientation&&!u.cm(r.orientation,this._camera.orientation)&&(l=this._setCameraOrientation(r.orientation)),r.position){const p=[r.position.x,r.position.y,r.position.z];u.cn(p,this._camera.position)||(this._setCameraPosition(p),l=!0)}l&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const r=this._camera.position,l=new Ud;return l.position=new u.ac(r[0],r[1],r[2]),l.orientation=this._camera.orientation,l._elevation=this.elevation,l._renderWorldCopies=this.renderWorldCopies,l}_setCameraOrientation(r){if(!u.co(r))return!1;u.cp(r,r);const l=u.cq([],[0,0,-1],r),p=u.cq([],[0,-1,0],r);if(p[2]<0)return!1;const _=di(l,p);return!!_&&(this._camera.orientation=_,!0)}_setCameraPosition(r){const l=this.zoomScale(this.minZoom)*this.tileSize,p=this.zoomScale(this.maxZoom)*this.tileSize,_=this.cameraToCenterDistance;r[2]=u.ay(r[2],_/p,_/l),this._camera.position=r}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(r){return this._edgeInsets.equals(r)}interpolatePadding(r,l,p){this._unmodified=!1,this._edgeInsets.interpolate(r,l,p),this._constrain(),this._calcMatrices()}coveringZoomLevel(r){const l=(r.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/r.tileSize));return Math.max(0,l)}getVisibleUnwrappedCoordinates(r){const l=[new u.cr(0,r)];if(this.renderWorldCopies){const p=this.pointCoordinate(new u.P(0,0)),_=this.pointCoordinate(new u.P(this.width,0)),v=this.pointCoordinate(new u.P(this.width,this.height)),b=this.pointCoordinate(new u.P(0,this.height)),S=Math.floor(Math.min(p.x,_.x,v.x,b.x)),I=Math.floor(Math.max(p.x,_.x,v.x,b.x)),P=1;for(let R=S-P;R<=I+P;R++)0!==R&&l.push(new u.cr(R,r))}return l}isLODDisabled(r){return(!r||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(r,l,p){let _=[];const v=null!=p,b=!v;if(b&&this.zoom<l||v&&0===p[0]&&0===p[1])return _;const S=new Set,I=(R,z,L,B,H)=>{const U=u.cV(z,R,L,B,H);S.has(U)||(_.push(new u.aM(R,z,L,B,H)),S.add(U))};for(let R=0;R<r.length;R++){const z=r[R];if(b&&z.canonical.z!==l)continue;const L=z.canonical,B=z.overscaledZ,H=z.wrap,U=1<<L.z,q=L.x+1<U,G=L.x>0,Y=L.y+1<U,ee=L.y>0,ne=z.wrap-(G?0:1),le=z.wrap+(q?0:1),de=G?L.x-1:U-1,pe=q?L.x+1:0;if(v)p[0]<0?(I(B,le,L.z,pe,L.y),p[1]<0&&Y&&(I(B,H,L.z,L.x,L.y+1),I(B,le,L.z,pe,L.y+1)),p[1]>0&&ee&&(I(B,H,L.z,L.x,L.y-1),I(B,le,L.z,pe,L.y-1))):p[0]>0?(I(B,ne,L.z,de,L.y),p[1]<0&&Y&&(I(B,H,L.z,L.x,L.y+1),I(B,ne,L.z,de,L.y+1)),p[1]>0&&ee&&(I(B,H,L.z,L.x,L.y-1),I(B,ne,L.z,de,L.y-1))):p[1]<0&&Y?I(B,H,L.z,L.x,L.y+1):ee&&I(B,H,L.z,L.x,L.y-1);else{const ae=z.visibleQuadrants;1&ae&&(I(B,ne,L.z,de,L.y),ee&&(I(B,H,L.z,L.x,L.y-1),I(B,ne,L.z,de,L.y-1))),2&ae&&(I(B,le,L.z,pe,L.y),ee&&(I(B,H,L.z,L.x,L.y-1),I(B,le,L.z,pe,L.y-1))),4&ae&&(I(B,ne,L.z,de,L.y),Y&&(I(B,H,L.z,L.x,L.y+1),I(B,ne,L.z,de,L.y+1))),8&ae&&(I(B,le,L.z,pe,L.y),Y&&(I(B,H,L.z,L.x,L.y+1),I(B,le,L.z,pe,L.y+1)))}}const P=[];for(const R of _)_.some(z=>R.isChildOf(z))||P.push(R);if(_=P.filter(R=>!r.some(z=>!!(R.overscaledZ<l&&z.isChildOf(R))||R.equals(z)||R.isChildOf(z))),b){const R=1<<l,z="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),L=[R*z.x,R*z.y],B=4,H=B*B;_=_.filter(U=>{const q=U.canonical.x+.5-L[0],G=U.canonical.y+.5-L[1];return q*q+G*G<H})}return _}extendTileCoverToNearPlane(r,l,p){const _=[],v=new Set;for(const Y of r)v.add(Y.key);const b=(Y,ee,ne,le,de)=>{const pe=u.cV(ee,Y,ne,le,de);v.has(pe)||(_.push(new u.aM(Y,ee,ne,le,de)),v.add(pe))},S=r.reduce((Y,ee)=>Math.max(Y,ee.overscaledZ),p),I=1<<p,P=[new u.P(0,0),new u.P(u.aj,0),new u.P(u.aj,u.aj),new u.P(0,u.aj)],R=new u.P(0,0),z=new u.P(0,0),L=(Y,ee)=>{const ne=Math.floor(Y[0]),le=Math.floor(Y[1]),de=(Y[0]-ne)*u.aj,pe=(Y[1]-le)*u.aj,ae=Math.floor(ee[0]),ce=Math.floor(ee[1]),ue=(ee[0]-ae)*u.aj,Me=(ee[1]-ce)*u.aj;for(let ye=-1;ye<=1;ye++){const je=ne+ye;if(!(je<0||je>=I)){R.x=de-ye*u.aj,z.x=ue-(je-ae)*u.aj;for(let Le=-1;Le<=1;Le++){const Ge=le+Le;R.y=pe-Le*u.aj,z.y=Me-(Ge-ce)*u.aj,u.cW(R,z,P)&&b(S,0,p,je,Ge)}}}},B=l.points,H=B[u.cs],U=B[u.ct],q=this._projectToGround(H,B[u.cu]),G=this._projectToGround(U,B[u.cv]);return L(H,q),L(U,G),_}_projectToGround(r,l){return u.cw(u.cx(),r,l,r[2]/(r[2]-l[2]))}coveringTiles(r){let l=this.coveringZoomLevel(r);const p=l,_=this.elevation&&this.elevation.exaggeration(),v=_&&!r.isTerrainDEM,b="mercator"===this.projection.name;if(void 0!==r.minzoom&&l<r.minzoom)return[];void 0!==r.maxzoom&&l>r.maxzoom&&(l=r.maxzoom);const S=this.locationCoordinate(this.center),I=this.center.lat,P=1<<l,R=[P*S.x,P*S.y,0],z="globe"===this.projection.name,L=!z,B=u.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,l,L),H=z?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),U=P*u.cb(1,this.center.lat),q=this._camera.position[2]/u.cb(1,this.center.lat),G=[P*H.x,P*H.y,q*(L?1:U)],Y=z||_,ee=this.cameraToCenterDistance/r.tileSize*(r.roundZoom?1:.502),ne=this.isLODDisabled(!0)?l:0;let le;if(this._elevation&&r.isTerrainDEM)le=1e4*this._elevation.exaggeration();else if(this._elevation){const _e=this._elevation.getMinMaxForVisibleTiles();le=_e?_e.max:this._centerAltitude}else le=this._centerAltitude;const de=r.isTerrainDEM?-le:this._elevation?this._elevation.getMinElevationBelowMSL():0,pe=this.projection.isReprojectedInTileSpace?u.cz(this):1,ae=_e=>{const Re=new u.ac(_e.x+25e-6,_e.y,_e.z),We=new u.ac(_e.x,_e.y+25e-6,_e.z),Ze=_e.toLngLat(),Ye=Re.toLngLat(),ct=We.toLngLat(),Ct=this.locationCoordinate(Ze),Lt=this.locationCoordinate(Ye),vt=this.locationCoordinate(ct),Rt=Math.hypot(Lt.x-Ct.x,Lt.y-Ct.y),At=Math.hypot(vt.x-Ct.x,vt.y-Ct.y);return Math.sqrt(Rt*At)*pe/25e-6},ce=_e=>{const ze=le,Re=de;return{aabb:u.cC(this,P,0,0,0,_e,Re,ze,this.projection),zoom:0,x:0,y:0,minZ:Re,maxZ:ze,wrap:_e,fullyVisible:!1}},ue=[];let Me=[];const ye=l,je=r.reparseOverscaled?p:l,Le=(q-this._centerAltitude)*U,Ge=_e=>{if(!this._elevation||!_e.tileID||!b)return;const ze=this._elevation.getMinMaxForTile(_e.tileID),Re=_e.aabb;ze?(Re.min[2]=ze.min,Re.max[2]=ze.max,Re.center[2]=(Re.min[2]+Re.max[2])/2):(_e.shouldSplit=Se(_e),_e.shouldSplit||(Re.min[2]=Re.max[2]=Re.center[2]=this._centerAltitude))},rt=(_e,ze)=>{if(.707*ze<_e)return 1;const Re=ze/_e;return Re/(1.4144271570014144+(Math.pow(1.1,Re-1.4144271570014144+1)-1)/(1.1-1)-1)},Se=_e=>{if(_e.zoom<ne)return!0;if(_e.zoom===ye)return!1;if(null!=_e.shouldSplit)return _e.shouldSplit;const ze=_e.aabb.distanceX(G),Re=_e.aabb.distanceY(G);let We=Le,Ze=1;if(z){We=_e.aabb.distanceZ(G);const At=Math.pow(2,_e.zoom),qt=u.aY((_e.y+1)/At),Kt=u.aY(_e.y/At),mn=Math.min(Math.max(I,qt),Kt),Dn=u.c_(mn)/u.c_(I);if(Ze=mn===I?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Dn/this._mercatorScaleRatio),this.zoom<=u.cX&&_e.zoom===ye-1&&Dn>=.9)return!0}else if(v&&(We=_e.aabb.distanceZ(G)*U),this.projection.isReprojectedInTileSpace&&p<=5){const At=Math.pow(2,_e.zoom),qt=ae(new u.ac((_e.x+.5)/At,(_e.y+.5)/At));Ze=qt>.85?1:qt}if(!b){const At=Math.sqrt(ze*ze+Re*Re+We*We);let qt=(1<<ye-_e.zoom)*ee*Ze;return qt*=rt(Math.max(We,Le),At),At<qt}let Ye=Number.MAX_VALUE,ct=0;const Ct=_e.aabb.getCorners(),Lt=[];for(const At of Ct){u.at(Lt,At,G),z||(v?Lt[2]*=U:Lt[2]=Le);const qt=u.bG(Lt,this._camera.forward());qt<Ye&&(Ye=qt,ct=Math.abs(Lt[2]))}let vt=(1<<ye-_e.zoom)*ee*Ze;if(vt*=rt(Math.max(ct,Le),Ye),Ye<vt)return!0;const Rt=_e.aabb.closestPoint(R);return Rt[0]===R[0]&&Rt[1]===R[1]};if(this.renderWorldCopies)for(let _e=1;_e<=3;_e++)ue.push(ce(-_e)),ue.push(ce(_e));for(ue.push(ce(0));ue.length>0;){const _e=ue.pop(),ze=_e.x,Re=_e.y;let We=_e.fullyVisible;const Ze=()=>"globe"===this.projection.name&&(0===_e.y||_e.y===(1<<_e.zoom)-1);if(!We){let Ye=Y?_e.aabb.intersects(B):_e.aabb.intersectsFlat(B);if(0===Ye&&Ze()){const ct=new u.cA(_e.zoom,ze,Re);Ye=u.cB(this,P,ct,!0).intersects(B)}if(0===Ye)continue;We=2===Ye}if(_e.zoom!==ye&&Se(_e))for(let Ye=0;Ye<4;Ye++){const ct=(ze<<1)+Ye%2,Ct=(Re<<1)+(Ye>>1),Lt={aabb:b?_e.aabb.quadrant(Ye):u.cC(this,P,_e.zoom+1,ct,Ct,_e.wrap,_e.minZ,_e.maxZ,this.projection),zoom:_e.zoom+1,x:ct,y:Ct,wrap:_e.wrap,fullyVisible:We,tileID:void 0,shouldSplit:void 0,minZ:_e.minZ,maxZ:_e.maxZ};v&&!z&&(Lt.tileID=new u.aM(_e.zoom+1===ye?je:_e.zoom+1,_e.wrap,_e.zoom+1,ct,Ct),Ge(Lt)),ue.push(Lt)}else{const Ye=_e.zoom===ye?je:_e.zoom;if(r.minzoom&&r.minzoom>Ye)continue;let ct=0;if(!We){let Rt=Y?_e.aabb.intersectsPrecise(B):_e.aabb.intersectsPreciseFlat(B);if(0===Rt&&Ze()){const At=new u.cA(_e.zoom,ze,Re);Rt=u.cB(this,P,At,!0).intersectsPrecise(B)}if(0===Rt)continue;if(r.calculateQuadrantVisibility)if(B.containsPoint(_e.aabb.center))ct=15;else for(let At=0;At<4;At++)0!==_e.aabb.quadrant(At).intersects(B)&&(ct|=1<<At)}const Ct=R[0]-(.5+ze+(_e.wrap<<_e.zoom))*(1<<l-_e.zoom),Lt=R[1]-.5-Re,vt=_e.tileID?_e.tileID:new u.aM(Ye,_e.wrap,_e.zoom,ze,Re);r.calculateQuadrantVisibility&&(vt.visibleQuadrants=ct),Me.push({tileID:vt,distanceSq:Ct*Ct+Lt*Lt})}}if(this.fogCullDistSq){const _e=this.fogCullDistSq,ze=this.horizonLineFromTop();Me=Me.filter(Re=>{const We=[0,0,0,1],Ze=[u.aj,u.aj,0,1],Ye=this.calculateFogTileMatrix(Re.tileID.toUnwrapped());u.aA(We,We,Ye),u.aA(Ze,Ze,Ye);const ct=u.cD([],We,Ze),Ct=u.cE([],We,Ze),Lt=u.cY(ct,Ct);if(0===Lt)return!0;let vt=!1;const Rt=this._elevation;if(Rt&&Lt>_e&&0!==ze){const At=this.calculateProjMatrix(Re.tileID.toUnwrapped());let qt;r.isTerrainDEM||(qt=Rt.getMinMaxForTile(Re.tileID)),qt||(qt={min:de,max:le});const Kt=u.cF(this.rotation),mn=[Kt[0]*u.aj,Kt[1]*u.aj,qt.max];u.ad(mn,mn,At),vt=(1-mn[1])*this.height*.5<ze}return Lt<_e||vt})}return Me.sort((_e,ze)=>_e.distanceSq-ze.distanceSq).map(_e=>_e.tileID)}resize(r,l){this.width=r,this.height=l,this.pixelsToGLUnits=[2/r,-2/l],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(r){return Math.pow(2,r)}scaleZoom(r){return Math.log(r)/Math.LN2}project(r){const l=u.ay(r.lat,-u.cG,u.cG),p=this.projection.project(r.lng,l);return new u.P(p.x*this.worldSize,p.y*this.worldSize)}unproject(r){return this.projection.unproject(r.x/this.worldSize,r.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/u.cb(1,this.center.lat)/this.worldSize}setLocationAtPoint(r,l){let p,_;const v=this.centerPoint;if("globe"===this.projection.name){const S=this.worldSize;p=(l.x-v.x)/S,_=(l.y-v.y)/S}else{const S=this.pointCoordinate(l),I=this.pointCoordinate(v);p=S.x-I.x,_=S.y-I.y}const b=this.locationCoordinate(r);this.setLocation(new u.ac(b.x-p,b.y-_))}setLocation(r){this.center=this.coordinateLocation(r),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(r,l){return this.projection.locationPoint(this,r,l)}locationPoint3D(r,l){return this.projection.locationPoint(this,r,l,!0)}pointLocation(r){return this.coordinateLocation(this.pointCoordinate(r))}pointLocation3D(r,l){return this.coordinateLocation(this.pointCoordinate3D(r,l))}locationCoordinate(r,l){const p=l?u.cb(l,r.lat):void 0,_=this.projection.project(r.lng,r.lat);return new u.ac(_.x,_.y,p)}coordinateLocation(r){return this.projection.unproject(r.x,r.y)}pointRayIntersection(r,l){const p=l??this._centerAltitude,_=[r.x,r.y,0,1],v=[r.x,r.y,1,1];u.aA(_,_,this.pixelMatrixInverse),u.aA(v,v,this.pixelMatrixInverse);const b=v[3];u.cH(_,_,1/_[3]),u.cH(v,v,1/b);const S=_[2],I=v[2];return{p0:_,p1:v,t:S===I?0:(p-S)/(I-S)}}screenPointToMercatorRay(r){const l=[r.x,r.y,0,1],p=[r.x,r.y,1,1];return u.aA(l,l,this.pixelMatrixInverse),u.aA(p,p,this.pixelMatrixInverse),u.cH(l,l,1/l[3]),u.cH(p,p,1/p[3]),l[2]=u.cb(l[2],this._center.lat)*this.worldSize,p[2]=u.cb(p[2],this._center.lat)*this.worldSize,u.cH(l,l,1/this.worldSize),u.cH(p,p,1/this.worldSize),new u.av([l[0],l[1],l[2]],u.au([],u.at([],p,l)))}rayIntersectionCoordinate(r){const{p0:l,p1:p,t:_}=r,v=u.cb(l[2],this._center.lat),b=u.cb(p[2],this._center.lat);return new u.ac(u.ai(l[0],p[0],_)/this.worldSize,u.ai(l[1],p[1],_)/this.worldSize,u.ai(v,b,_))}pointCoordinate(r,l=this._centerAltitude){return this.projection.pointCoordinate(this,r.x,r.y,l)}pointCoordinate3D(r,l){if(!this.elevation)return this.pointCoordinate(r,l);let p=this.projection.pointCoordinate3D(this,r.x,r.y);if(p)return new u.ac(p[0],p[1],p[2]);let _=0,v=this.horizonLineFromTop();if(r.y>v)return this.pointCoordinate(r,l);const b=.02*v,S=r.clone();for(let I=0;I<10&&v-_>b;I++){S.y=u.ai(_,v,.66);const P=this.projection.pointCoordinate3D(this,S.x,S.y);P?(v=S.y,p=P):_=S.y}return p?new u.ac(p[0],p[1],p[2]):this.pointCoordinate(r)}isPointAboveHorizon(r){return this.projection.isPointAboveHorizon(this,r)}isPointOnSurface(r){if(r.y<0||r.y>this.height||r.x<0||r.x>this.width)return!1;if(this.elevation||this.zoom>=u.cI)return!this.isPointAboveHorizon(r);const l=this.pointCoordinate(r);return l.y>=0&&l.y<=1}_coordinatePoint(r,l){const p=l&&this.elevation?this.elevation.getAtPointOrZero(r,this._centerAltitude):this._centerAltitude,_=[r.x*this.worldSize,r.y*this.worldSize,p+r.toAltitude(),1];return u.aA(_,_,this.pixelMatrix),_[3]>0?new u.P(_[0]/_[3],_[1]/_[3]):new u.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:r,left:l}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,_=this.width-this._edgeInsets.right,v=this.pointLocation3D(new u.P(l,r)),b=this.pointLocation3D(new u.P(_,r)),S=this.pointLocation3D(new u.P(_,p)),I=this.pointLocation3D(new u.P(l,p));let P=Math.min(v.lng,b.lng,S.lng,I.lng),R=Math.max(v.lng,b.lng,S.lng,I.lng),z=Math.min(v.lat,b.lat,S.lat,I.lat),L=Math.max(v.lat,b.lat,S.lat,I.lat);const B=Math.pow(2,-this.zoom)/16*270,H="globe"===this.projection.name?1:4,U=(q,G,Y,ee,ne)=>{const le=(q+Y)/2,de=(G+ee)/2,pe=new u.P(le,de),{lng:ae,lat:ce}=this.pointLocation3D(pe),ue=Math.max(0,P-ae,z-ce,ae-R,ce-L);P=Math.min(P,ae),R=Math.max(R,ae),z=Math.min(z,ce),L=Math.max(L,ce),(ne<H||ue>B)&&(U(q,G,le,de,ne+1),U(le,de,Y,ee,ne+1))};if(U(l,r,_,r,1),U(_,r,_,p,1),U(_,p,l,p,1),U(l,p,l,r,1),"globe"===this.projection.name){const[q,G]=u.cJ(this);q?(L=90,R=180,P=-180):G&&(z=-90,R=180,P=-180)}return new u.aG(new u.ci(P,z),new u.ci(R,L))}_getBoundsRectangular(r,l){const{top:p,left:_}=this._edgeInsets,v=this.height-this._edgeInsets.bottom,b=this.width-this._edgeInsets.right,S=new u.P(_,p),I=new u.P(b,p),P=new u.P(b,v),R=new u.P(_,v);let z=this.pointCoordinate(S,r),L=this.pointCoordinate(I,r);const B=this.pointCoordinate(P,l),H=this.pointCoordinate(R,l),U=(q,G)=>(G.y-q.y)/(G.x-q.x);return z.y>1&&L.y>=0?z=new u.ac((1-H.y)/U(H,z)+H.x,1):z.y<0&&L.y<=1&&(z=new u.ac(-H.y/U(H,z)+H.x,0)),L.y>1&&z.y>=0?L=new u.ac((1-B.y)/U(B,L)+B.x,1):L.y<0&&z.y<=1&&(L=new u.ac(-B.y/U(B,L)+B.x,0)),(new u.aG).extend(this.coordinateLocation(z)).extend(this.coordinateLocation(L)).extend(this.coordinateLocation(H)).extend(this.coordinateLocation(B))}_getBoundsRectangularTerrain(){const r=this.elevation;if(!r.visibleDemTiles.length||r.isUsingMockSource())return this._getBoundsRectangular(0,0);const l=r.visibleDemTiles.reduce((p,_)=>{if(_.dem){const v=_.dem.tree;p.min=Math.min(p.min,v.minimums[0]),p.max=Math.max(p.max,v.maximums[0])}return p},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(l.min*r.exaggeration(),l.max*r.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(r=!0){const l=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,p=this.height/2-l*(1-this._horizonShift);return r?Math.max(0,p):p}getMaxBounds(){return this.maxBounds}setMaxBounds(r){this.maxBounds=r,this.minLat=-u.cG,this.maxLat=u.cG,this.minLng=-180,this.maxLng=180,r&&(this.minLat=r.getSouth(),this.maxLat=r.getNorth(),this.minLng=r.getWest(),this.maxLng=r.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=u.aD(this.minLng)*this.tileSize,this.worldMaxX=u.aD(this.maxLng)*this.tileSize,this.worldMinY=u.aH(this.maxLat)*this.tileSize,this.worldMaxY=u.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(r,l){return this.projection.createTileMatrix(this,l,r)}calculateDistanceTileData(r){const l=r.key,p=this._distanceTileDataCache;if(p[l])return p[l];const _=r.canonical,v=1/this.height,b=this.cameraWorldSize,S=b/this.zoomScale(_.z),I=(_.x+Math.pow(2,_.z)*r.wrap)*S,P=_.y*S,R=this.point;R.x*=b/this.worldSize,R.y*=b/this.worldSize;const z=this.angle,L=Math.sin(-z),B=-Math.cos(-z);return p[l]={bearing:[L,B],center:[(R.x-I)*v,(R.y-P)*v],scale:S/u.aj*v},p[l]}calculateFogTileMatrix(r){const l=r.key,p=this._fogTileMatrixCache;if(p[l])return p[l];const _=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,r);return u.az(_,this.worldToFogMatrix,_),p[l]=new Float32Array(_),p[l]}calculateProjMatrix(r,l=!1,p=!1){const _=r.key;let v;if(v=p?this._expandedProjMatrixCache:l?this._alignedProjMatrixCache:this._projMatrixCache,v[_])return v[_];const b=this.calculatePosMatrix(r,this.worldSize);let S;return S=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:p?this.expandedFarZProjMatrix:l?this.alignedProjMatrix:this.projMatrix,u.az(b,S,b),v[_]=new Float32Array(b),v[_]}calculatePixelsToTileUnitsMatrix(r){const l=r.tileID.key,p=this._pixelsToTileUnitsCache;if(p[l])return p[l];const _=u.cK(r,this);return p[l]=_,p[l]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const r=1/this.worldSize,l=u.bn([],[r,r,r]);return u.az(l,l,this.globeMatrix),l}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const r=this._elevation;this._updateCameraState();const l=u.cb(1,this._center.lat)*this.worldSize,p=this._computeCameraPosition(l),_=this._camera.forward(),v=u.cb(1,this._center.lat);p[2]/=v,_[2]/=v,u.au(_,_);const b=r.raycast(p,_,r.exaggeration());if(b){const S=u.bE([],p,_,b),I=new u.ac(S[0],S[1],u.cb(S[2],u.aY(S[1]))),P=(I.z+u.ae([I.x-p[0],I.y-p[1],I.z-p[2]*v]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(P),this._centerAltitude=I.toAltitude(),this._center=this.coordinateLocation(I),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(r=!1){if(!this._elevation)return;const l=this._elevation,p=u.cb(1,this._center.lat)*this.worldSize,_=this._computeCameraPosition(p),v=l.getAtPointOrZero(new u.ac(..._)),b=this.pixelsPerMeter/this.worldSize*v,S=this._minimumHeightOverTerrain(),I=_[2]-b;if(I<=S)if(I<0||r){const P=this.locationCoordinate(this._center,this._centerAltitude),R=[_[0],_[1],P.z-_[2]],z=u.ae(R);R[2]-=(S-I)/this._pixelsPerMercatorPixel;const L=u.ae(R);if(0===L)return;u.c1(R,R,z/L*this._pixelsPerMercatorPixel),this._camera.position=[_[0],_[1],P.z*this._pixelsPerMercatorPixel-R[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const r="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||r){const L=this.center;return L.lat=u.ay(L.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!r)&&(L.lng=u.ay(L.lng,this.minLng,this.maxLng)),this.center=L,void(this._constraining=!1)}const l=this._unmodified,{x:p,y:_}=this.point;let v=0,b=p,S=_;const I=this.width/2,P=this.height/2,R=this.worldMinY*this.scale,z=this.worldMaxY*this.scale;if(_-P<R&&(S=R+P),_+P>z&&(S=z-P),z-R<this.height&&(v=Math.max(v,this.height/(z-R)),S=(z+R)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const L=this.worldMinX*this.scale,B=this.worldMaxX*this.scale,H=this.worldSize/2-(L+B)/2;b=(p+H+this.worldSize)%this.worldSize-H,b-I<L&&(b=L+I),b+I>B&&(b=B-I),B-L<this.width&&(v=Math.max(v,this.width/(B-L)),b=(B+L)/2)}b===p&&S===_||this._allowWorldUnderZoom||(this.center=this.unproject(new u.P(b,S))),v&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(v)),this._constrainCamera(),this._unmodified=l,this._constraining=!1}_minZoomForBounds(){let r=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(r=Math.max(r,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),r}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const r=this.centerOffset,l="globe"===this.projection.name,p=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=u.cb(1,this.center.lat)/u.cb(1,u.c$));const _=u.cL(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,_),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const v="meters"===this.projection.zAxisUnit?p:1,b=this._camera.getWorldToCamera(this.worldSize,v);let S;const I=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(I[8]=2*-r.x/this.width,I[9]=2*r.y/this.height,this.isOrthographic){let ce=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ue=ce*this.aspect,Me=-ue,ye=-ce;ue-=r.x,Me-=r.x,ce+=r.y,ye+=r.y,S=this._camera.getCameraToClipOrthographic(Me,ue,ye,ce,this._nearZ,this._farZ),((je,Le,Ge,rt)=>{for(let Se=0;Se<16;Se++)je[Se]=u.ai(Le[Se],Ge[Se],rt)})(S,S,I,u.cZ(this.pitch>=15?1:this.pitch/15))}else S=I;const P=u.cM([],I,b);let R=u.cM([],S,b);if(this.projection.isReprojectedInTileSpace){const ce=this.locationCoordinate(this.center),ue=u.bx([]);u.bo(ue,ue,[ce.x*this.worldSize,ce.y*this.worldSize,0]),u.az(ue,ue,u.cN(this)),u.bo(ue,ue,[-ce.x*this.worldSize,-ce.y*this.worldSize,0]),u.az(R,R,ue),u.az(P,P,ue),this.inverseAdjustmentMatrix=u.cO(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=u.cP([],R,[this.worldSize,this.worldSize,this.worldSize/v,1]),this.projMatrix=R,this.invProjMatrix=u.bi(new Float64Array(16),this.projMatrix),l){const ce=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);ce[8]=2*-r.x/this.width,ce[9]=2*r.y/this.height,this.expandedFarZProjMatrix=u.cM([],ce,b)}else this.expandedFarZProjMatrix=this.projMatrix;const z=u.bi([],S);this.frustumCorners=u.cQ.fromInvProjectionMatrix(z,this.horizonLineFromTop(),this.height),this.cameraFrustum=u.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!l);const L=new Float32Array(16);u.bx(L),u.cP(L,L,[1,-1,1]),u.cR(L,L,this._pitch),u.by(L,L,this.angle);const B=u.c9(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=u.bw(B);const H=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;B[8]=2*-r.x/this.width,B[9]=2*(r.y+H)/this.height,this.skyboxMatrix=u.az(L,B,L);const U=this.point,q=U.x,G=U.y,Y=this.width%2/2,ee=this.height%2/2,ne=Math.cos(this.angle),le=Math.sin(this.angle),de=q-Math.round(q)+ne*Y+le*ee,pe=G-Math.round(G)+ne*ee+le*Y,ae=new Float64Array(R);if(u.bo(ae,ae,[de>.5?de-1:de,pe>.5?pe-1:pe,0]),this.alignedProjMatrix=ae,R=u.bz(),u.cP(R,R,[this.width/2,-this.height/2,1]),u.bo(R,R,[1,-1,0]),this.labelPlaneMatrix=R,R=u.bz(),u.cP(R,R,[1,-1,1]),u.bo(R,R,[-1,-1,0]),u.cP(R,R,[2/this.width,2/this.height,1]),this.glCoordMatrix=R,this.pixelMatrix=u.az(new Float64Array(16),this.labelPlaneMatrix,P),this._calcFogMatrices(),this._distanceTileDataCache={},R=u.bi(new Float64Array(16),this.pixelMatrix),!R)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=R,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=u.cS(this);const ce=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=u.ad(ce,ce,b),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=R;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const r=this.cameraWorldSizeForFog,l=this.cameraPixelsPerMeter,p=this._camera.position,_=1/this.height/this._pixelsPerMercatorPixel,v=[r,r,l];u.c1(v,v,_),u.c1(p,p,-1),u.cT(p,p,v);const b=u.bz();u.bo(b,b,p),u.cP(b,b,v),this.mercatorFogMatrix=b,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(r,l,_)}_computeCameraPosition(r){const l=(r=r||this.pixelsPerMeter)/this.pixelsPerMeter,p=this._camera.forward(),_=this.point,v=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*l-r/this.worldSize*this._centerAltitude;return[_.x/this.worldSize-p[0]*v,_.y/this.worldSize-p[1]*v,r/this.worldSize*this._centerAltitude-p[2]*v]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(r){const l=this._maxCameraBoundsDistance()*Math.cos(this._pitch),p=this._camera.position[2],_=r[2];let v=1;this.projection.wrap&&(this.center=this.center.wrap()),_>0&&(v=Math.min((l-p)/_,1)),this._camera.position=u.bE([],this._camera.position,r,v),this._updateStateFromCamera()}_updateStateFromCamera(){const r=this._camera.position,l=this._camera.forward(),{pitch:p,bearing:_}=this._camera.getPitchBearing(),v=u.cb(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,b=this._mercatorZfromZoom(this._maxZoom)*Math.cos(u.al(this._maxPitch)),S=Math.max((r[2]-v)/Math.cos(p),b),I=this._zoomFromMercatorZ(S);u.bE(r,r,l,S),this._pitch=u.ay(p,u.al(this.minPitch),u.al(this.maxPitch)),this.angle=u.bQ(_,-Math.PI,Math.PI),this._setZoom(u.ay(I,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new u.ac(r[0],r[1],r[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(r){return Math.pow(2,r)*this.tileSize}_mercatorZfromZoom(r){return this.cameraToCenterDistance/this._worldSizeFromZoom(r)}_minimumHeightOverTerrain(){const r=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(r)}_zoomFromMercatorZ(r){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,r)*this.tileSize))}zoomFromMercatorZAdjusted(r){let l=0,p=u.cI,_=0,v=1/0;for(;p-l>1e-6&&p>l;){const b=l+.5*(p-l),S=this.tileSize*Math.pow(2,b),I=this.getCameraToCenterDistance(this.projection,b,S),P=this.scaleZoom(I/(Math.max(0,r)*this.tileSize)),R=Math.abs(b-P);R<v&&(v=R,_=b),b<P?l=b:p=b}return _}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(u.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(r,l){const p=Math.min(r.x,l.x),_=Math.max(r.x,l.x),v=Math.min(r.y,l.y),b=Math.max(r.y,l.y);if(v<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const S=[new u.P(p,v),new u.P(_,b),new u.P(p,b),new u.P(_,v)],I=this.renderWorldCopies?-3:0,P=this.renderWorldCopies?4:1;for(const R of S){const z=this.pointRayIntersection(R);if(z.t<0)return!0;const L=this.rayIntersectionCoordinate(z);if(L.x<I||L.y<0||L.x>P||L.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+u.cU(this.fovAboveCenter)>88||this.anyCornerOffEdge(new u.P(0,0),new u.P(this.width,this.height))}zoomDeltaToMovement(r,l){const p=u.ae(u.at([],this._camera.position,r)),_=this._zoomFromMercatorZ(p)+l;return p-this._mercatorZfromZoom(_)}getCameraPoint(){if("globe"===this.projection.name){const r=function([l,p,_],v){const b=[l,p,_,1];u.aA(b,b,v);const S=b[3]=Math.max(b[3],1e-6);return b[0]/=S,b[1]/=S,b[2]/=S,b}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new u.P(r[0],r[1])}{const r=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new u.P(0,r))}}getCameraToCenterDistance(r,l=this.zoom,p=this.worldSize){const _=u.cL(r,l,this.width,this.height,1024),v=r.pixelSpaceConversion(this.center.lat,p,_);let b=.5/Math.tan(.5*this._fov)*this.height*v;return this.isOrthographic&&(b=u.ai(1,b,u.cZ(this.pitch>=15?1:this.pitch/15))),b}getWorldToCameraMatrix(){const r=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&u.az(r,r,this.globeMatrix),r}getFrustum(r){return u.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,r,"meters"===this.projection.zAxisUnit)}}const mo=(f,r)=>{if(r>0&&f.terrain&&u.w("Cutoff is currently disabled on terrain"),r<=0||f.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const l=f.transform,p=Math.max(Math.abs(l._zoom-(f.minCutoffZoom-1)),1),_=l.isLODDisabled(!1)?u.af(60,45,l.pitch):u.af(30,15,l.pitch),v=l._farZ-l._nearZ,b=r*l.height,S=((1-(I=_))*l.cameraToCenterDistance+I*(l._farZ+b))*p;var I;return{shouldRenderCutoff:_<1,uniformValues:{u_cutoff_params:[l._nearZ,l._farZ,(S-l._nearZ)/v,(S-b-l._nearZ)/v]}}},Yr={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Vo{constructor(r,l){this.aabb=r,this.lastCascade=l}}class Da{add(r,l){const p=this.receivers[r.key];void 0!==p?(p.aabb.min[0]=Math.min(p.aabb.min[0],l.min[0]),p.aabb.min[1]=Math.min(p.aabb.min[1],l.min[1]),p.aabb.min[2]=Math.min(p.aabb.min[2],l.min[2]),p.aabb.max[0]=Math.max(p.aabb.max[0],l.max[0]),p.aabb.max[1]=Math.max(p.aabb.max[1],l.max[1]),p.aabb.max[2]=Math.max(p.aabb.max[2],l.max[2])):this.receivers[r.key]=new Vo(l,null)}clear(){this.receivers={}}get(r){return this.receivers[r.key]}computeRequiredCascades(r,l,p){const _=u.d6.fromPoints(r.points);let v=0;for(const b in this.receivers){const S=this.receivers[b];if(!S||!_.intersectsAabb(S.aabb))continue;S.aabb.min=_.closestPoint(S.aabb.min),S.aabb.max=_.closestPoint(S.aabb.max);const I=S.aabb.getCorners();for(let P=0;P<p.length;P++){let R=!0;for(const z of I){const L=[z[0]*l,z[1]*l,z[2]];if(u.ad(L,L,p[P].matrix),L[0]<-1||L[0]>1||L[1]<-1||L[1]>1){R=!1;break}}if(S.lastCascade=P,v=Math.max(v,P),R)break}}return v+1}}class Hi{constructor(r){this.painter=r,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Da,this._depthMode=new bt(r.context.gl.LEQUAL,bt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,r.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),r.tp.registerParameter(Yr,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),r.tp.registerParameter(Yr,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),r.tp.registerParameter(Yr,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),r.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const r of this._cascades)r.texture.destroy(),r.framebuffer.destroy();this._cascades=[]}updateShadowParameters(r,l){const p=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!l||!l.properties)return;const _=l.properties.get("shadow-intensity");if(!l.shadowsEnabled()||_<=0||(this._shadowLayerCount=p.style.order.reduce((H,U)=>{const q=p.style._mergedLayers[U];return H+(q.hasShadowPass()&&!q.isHidden(r.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const v=p.context,b=Yr.shadowMapResolution,S=Yr.shadowMapResolution;if(0===this._cascades.length||Yr.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let H=0;H<Yr.cascadeCount;++H){const U=p._shadowMapDebug,q=v.gl,G=v.createFramebuffer(b,S,U,"texture"),Y=new u.T(v,{width:b,height:S,data:null},q.DEPTH_COMPONENT16);if(G.depthAttachment.set(Y.texture),U){const ee=new u.T(v,{width:b,height:S,data:null},q.RGBA8);G.colorAttachment.set(ee.texture)}this._cascades.push({framebuffer:G,texture:Y,matrix:[],far:0,boundingSphereRadius:0,frustum:new u.cy,scale:0})}}this.shadowDirection=Nl(l);let I=0;if(r.elevation){const H=r.elevation,U=[1e4,-1e4];H.visibleDemTiles.filter(q=>q.dem).forEach(q=>{const G=q.dem.tree;U[0]=Math.min(U[0],G.minimums[0]),U[1]=Math.max(U[1],G.maximums[0])}),1e4!==U[0]&&(I=(U[1]-U[0])*H.exaggeration())}const P=1.5*r.cameraToCenterDistance,R=3*P,z=new Float64Array(16);for(let H=0;H<this._cascades.length;++H){const U=this._cascades[H];let q=r.height/50,G=1;1===Yr.cascadeCount?G=R:0===H?G=P:(q=P,G=R);const[Y,ee]=Mc(r,this.shadowDirection,q,G,Yr.shadowMapResolution,I);U.scale=r.scale,U.matrix=Y,U.boundingSphereRadius=ee,u.bi(z,U.matrix),U.frustum=u.cy.fromInvProjectionMatrix(z,1,0,!0),U.far=G}const L=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[L].far,this._cascades[L].far],this._uniformValues.u_shadow_intensity=_,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Yr.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Yr.shadowMapResolution,this._uniformValues.u_shadowmap_0=Zr.ShadowMap0,this._uniformValues.u_shadowmap_1=Zr.ShadowMap0+1,this._groundShadowTiles=p.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const B=p.transform.elevation;for(const H of this._groundShadowTiles){let U={min:0,max:0};if(B){const q=B.getMinMaxForTile(H);q&&(U=q)}this.addShadowReceiver(H.toUnwrapped(),U.min,U.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(r){this._enabled=r}drawShadowPass(r,l){if(!this.enabled)return;const p=this.painter,_=p.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(p.transform.getFrustum(0),p.transform.worldSize,this._cascades),_.viewport.set([0,0,Yr.shadowMapResolution,Yr.shadowMapResolution]);for(let v=0;v<this._numCascadesToRender;++v){p.currentShadowCascade=v,_.bindFramebuffer.set(this._cascades[v].framebuffer.framebuffer),_.clear({color:u.am.white,depth:1});for(const b of r.order){const S=r._mergedLayers[b];if(!S.hasShadowPass()||S.isHidden(p.transform.zoom))continue;const I=r.getLayerSourceCache(S),P=I?l[I.id]:void 0;("model"===S.type||P&&P.length)&&p.renderLayer(p,I,S,P)}}p.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const r=this.painter,l=r.style,p=r.context,_=p.gl,v=l.directionalLight,b=l.ambientLight;if(!v||!b)return;const S=[],I=mo(r,r.longestCutoffRange);I.shouldRenderCutoff&&S.push("RENDER_CUTOFF"),S.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&S.push("NORMAL_OFFSET");const P=qa(l,v,b),R=new bt(_.LEQUAL,bt.ReadOnly,r.depthRangeFor3D),z=new Bt({func:_.EQUAL,mask:255},0,255,_.KEEP,_.KEEP,_.KEEP);for(const L of this._groundShadowTiles){const B=L.toUnwrapped(),H=r.isTileAffectedByFog(L),U=r.getOrCreateProgram("groundShadow",{defines:S,overrideFog:H});this.setupShadows(B,U),r.uploadCommonUniforms(p,U,B,null,I);const q={u_matrix:r.transform.calculateProjMatrix(B),u_ground_shadow_factor:P};U.draw(r,_.TRIANGLES,R,z,an.multiply,Nt.disabled,q,"ground_shadow",r.tileExtentBuffer,r.quadTriangleIndexBuffer,r.tileExtentSegments,null,r.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?an.unblended:an.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(r){const l=this.painter.transform,p=l.calculatePosMatrix(r,l.worldSize);return u.az(p,this._cascades[this.painter.currentShadowCascade].matrix,p),Float32Array.from(p)}calculateShadowPassMatrixFromMatrix(r){return u.az(r,this._cascades[this.painter.currentShadowCascade].matrix,r),Float32Array.from(r)}setupShadows(r,l,p){if(!this.enabled)return;const _=this.painter.transform,v=this.painter.context,b=v.gl,S=this._uniformValues,I=new Float64Array(16),P=_.calculatePosMatrix(r,_.worldSize);for(let R=0;R<this._cascades.length;R++)u.az(I,this._cascades[R].matrix,P),S[0===R?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(I),v.activeTexture.set(b.TEXTURE0+Zr.ShadowMap0+R),this._cascades[R].texture.bindExtraParam(b.LINEAR,b.LINEAR,b.CLAMP_TO_EDGE,b.CLAMP_TO_EDGE,b.GREATER);if(this.useNormalOffset=!!p,this.useNormalOffset){const R=u.d4(r.canonical),z=2/_.tileSize*u.aj/Yr.shadowMapResolution,L=z*this._cascades[0].boundingSphereRadius,B=z*this._cascades[this._cascades.length-1].boundingSphereRadius,H=("vector-tile"===p?1:3)*function(U,q,G,Y,ee){const ne=u.ay((U-22)/-22,0,1);return.125*(1-ne)+4*ne}(_.zoom);S.u_shadow_normal_offset=[R,L*H,B*H],S.u_shadow_bias=[1e-4,.0012,.012]}else S.u_shadow_bias=[36e-5,.0012,.012];l.setShadowUniformValues(v,S)}setupShadowsFromMatrix(r,l,p=!1){if(!this.enabled)return;const _=this.painter.context,v=_.gl,b=this._uniformValues,S=new Float64Array(16);for(let I=0;I<Yr.cascadeCount;I++)u.az(S,this._cascades[I].matrix,r),b[0===I?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(S),_.activeTexture.set(v.TEXTURE0+Zr.ShadowMap0+I),this._cascades[I].texture.bindExtraParam(v.LINEAR,v.LINEAR,v.CLAMP_TO_EDGE,v.CLAMP_TO_EDGE,v.GREATER);if(this.useNormalOffset=p,p){const I=Yr.normalOffset;b.u_shadow_normal_offset=[1,I,I],b.u_shadow_bias=[6e-5,.0012,.012]}else b.u_shadow_bias=[36e-5,.0012,.012];l.setShadowUniformValues(_,b)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(r,l,p,_){if(_[2]>=0)return{};const v=function(I,P,R){const z=R/(1<<I.canonical.z);return new u.d6([I.canonical.x*z+I.wrap*R,I.canonical.y*z+I.wrap*R,0],[(I.canonical.x+1)*z+I.wrap*R,(I.canonical.y+1)*z+I.wrap*R,P])}(r,l,p).getCorners(),b=l/-_[2];_[0]<0?(u.d5(v[0],v[0],[_[0]*b,0,0]),u.d5(v[3],v[3],[_[0]*b,0,0])):_[0]>0&&(u.d5(v[1],v[1],[_[0]*b,0,0]),u.d5(v[2],v[2],[_[0]*b,0,0])),_[1]<0?(u.d5(v[0],v[0],[0,_[1]*b,0]),u.d5(v[1],v[1],[0,_[1]*b,0])):_[1]>0&&(u.d5(v[2],v[2],[0,_[1]*b,0]),u.d5(v[3],v[3],[0,_[1]*b,0]));const S={};return S.vertices=v,S.planes=[la(v[1],v[0],v[4]),la(v[2],v[1],v[5]),la(v[3],v[2],v[6]),la(v[0],v[3],v[7])],S}addShadowReceiver(r,l,p){this._receivers.add(r,u.d6.fromTileIdAndHeight(r,l,p))}getMaxCascadeForTile(r){const l=this._receivers.get(r);return l&&l.lastCascade?l.lastCascade:0}}function la(f,r,l){const p=u.at([],l,r),_=u.at([],f,r),v=u.bF([],p,_),b=u.ae(v);return 0===b?[0,0,1,0]:(u.c1(v,v,1/b),[v[0],v[1],v[2],-u.bG(v,r)])}function Nl(f){const r=f.properties.get("direction"),l=u.d1(r.x,r.y,r.z);l[2]=u.ay(l[2],0,75);const p=u.d3([l[0],l[1],l[2]]);return u.d2(p.x,p.y,p.z)}function qa(f,r,l){const p="none"===r.properties.get("color-use-theme"),_=r.properties.get("color"),v=r.properties.get("intensity"),b=r.properties.get("direction"),S=[b.x,b.y,b.z],I="none"===l.properties.get("color-use-theme"),P=l.properties.get("color"),R=l.properties.get("intensity"),z=Math.max(u.bG([0,0,1],S),0),L=[0,0,0];u.c1(L,P.toPremultipliedRenderColor(I?null:f.getLut(r.scope)).toArray01Linear().slice(0,3),R);const B=[0,0,0];return u.c1(B,_.toPremultipliedRenderColor(p?null:f.getLut(l.scope)).toArray01Linear().slice(0,3),z*v),u.d8([L[0]>0?L[0]/(L[0]+B[0]):0,L[1]>0?L[1]/(L[1]+B[1]):0,L[2]>0?L[2]/(L[2]+B[2]):0])}function Mc(f,r,l,p,_,v){const b=f.zoom,S=f.scale,I=f.worldSize,P=1/I,R=f.aspect,z=Math.sqrt(1+R*R)*Math.tan(.5*f.fovX),L=z*z,B=p-l,H=p+l;let U,q;L>B/H?(U=p,q=p*z):(U=.5*H*(1+L),q=.5*Math.sqrt(B*B+2*(p*p+l*l)*L+H*H*L*L));const G=f.projection.pixelsPerMeter(f.center.lat,I),Y=f._camera.getCameraToWorldMercator(),ee=[0,0,-U*P];u.ad(ee,ee,Y);let ne=q*P;const le=f._edgeInsets;if(!(0===le.left&&0===le.top&&0===le.right&&0===le.bottom||le.left===le.right&&le.top===le.bottom)){const We=f._camera.getWorldToCamera(f.worldSize,"meters"===f.projection.zAxisUnit?G:1),Ze=f._camera.getCameraToClipPerspective(f._fov,f.width/f.height,l,p);Ze[8]=2*-f.centerOffset.x/f.width,Ze[9]=2*f.centerOffset.y/f.height;const Ye=new Float64Array(16);u.cM(Ye,Ze,We);const ct=new Float64Array(16);u.bi(ct,Ye);const Ct=u.cy.fromInvProjectionMatrix(ct,I,b,!0);for(const Lt of Ct.points){const vt=((de=Lt)[0]/=S,de[1]/=S,de[2]=u.cb(de[2],f._center.lat),de);ne=Math.max(ne,u.c2(u.d7([],ee,vt)))}}var de;ne*=_/(_-1);const pe=Math.acos(r[2]),ae=Math.atan2(-r[0],-r[1]),ce=new gs;ce.position=ee,ce.setPitchBearing(pe,ae);const ue=ce.getWorldToCamera(I,G),Me=ne*I,ye=Math.min(f._mercatorZfromZoom(17)*I*-2,-2*Me),je=ce.getCameraToClipOrthographic(-Me,Me,-Me,Me,ye,(Me+v*G)/r[2]),Le=new Float64Array(16);u.az(Le,je,ue);const Ge=u.d2(Math.floor(1e6*ee[0])/1e6*I,Math.floor(1e6*ee[1])/1e6*I,0),rt=.5*_,Se=[0,0,0];u.ad(Se,Ge,Le),u.c1(Se,Se,rt);const _e=[Math.floor(Se[0]),Math.floor(Se[1]),Math.floor(Se[2])],ze=[0,0,0];u.at(ze,Se,_e),u.c1(ze,ze,-1/rt);const Re=new Float64Array(16);return u.bx(Re),u.bo(Re,Re,ze),u.az(Le,Re,Le),[Le,Me]}class Ia extends u.E{constructor(r){super(),this.requestManager=r,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(r,l){return u.aS(this.requestManager.transformRequest(l,u.R.Model).url).then(p=>{if(!p)return;const _=u.aT(p),v=new u.aU(r,void 0,void 0,_);return v.computeBoundsAndApplyParent(),v}).catch(p=>{if(p&&404===p.status)return null;this.fire(new u.z(new Error(`Could not load model ${r} from ${l}: ${p.message}`)))})}load(r,l,p={forceReload:!1}){this.models[l]||(this.models[l]={});const _=Object.keys(r),v=[],b=[];for(const S of _){const I=r[S];this.hasURLBeenRequested(I)&&!p.forceReload||(this.modelByURL[I]={modelId:S,scope:l},v.push(this.loadModel(S,I)),b.push(S)),this.models[l][S]||(this.models[l][S]={model:null,numReferences:1})}this.numModelsLoading[l]=(this.numModelsLoading[l]||0)+b.length,Promise.allSettled(v).then(S=>{for(let I=0;I<S.length;I++){const{status:P}=S[I];if("rejected"===P)continue;const{value:R}=S[I];this.models[l][b[I]]||(this.models[l][b[I]]={model:null,numReferences:1}),this.models[l][b[I]].model=R}this.numModelsLoading[l]-=b.length,this.fire(new u.A("data",{dataType:"style"}))}).catch(S=>{this.fire(new u.z(new Error(`Could not load models: ${S.message}`)))})}isLoaded(){for(const r in this.numModelsLoading)if(this.numModelsLoading[r]>0)return!1;return!0}hasModel(r,l,p={exactIdMatch:!1}){return!!(p.exactIdMatch?this.getModel(r,l):this.getModelByURL(this.modelUris[l][r]))}getModel(r,l){return this.models[l]||(this.models[l]={}),this.models[l][r]?this.models[l][r].model:void 0}getModelByURL(r){if(!r)return null;const l=this.modelByURL[r];return l?this.models[l.scope][l.modelId].model:null}hasModelBeenAdded(r,l){return this.models[l]&&void 0!==this.models[l][r]}getModelURIs(r){return this.modelUris[r]||{}}addModel(r,l,p){this.models[p]||(this.models[p]={}),this.modelUris[p]||(this.modelUris[p]={});const _=this.requestManager.normalizeModelURL(l);if((this.hasModel(r,p,{exactIdMatch:!0})||this.hasModelBeenAdded(r,p))&&this.modelUris[p][r]===_)this.models[p][r].numReferences++;else if(this.hasURLBeenRequested(_)){const{scope:v,modelId:b}=this.modelByURL[_];this.models[v][b].numReferences++}else this.modelUris[p][r]=_,this.load({[r]:this.modelUris[p][r]},p)}addModelURLs(r,l){this.models[l]||(this.models[l]={}),this.modelUris[l]||(this.modelUris[l]={});const p=this.modelUris[l];for(const _ in r)p[_]=this.requestManager.normalizeModelURL(r[_])}reloadModels(r){this.load(this.modelUris[r],r,{forceReload:!0})}addModelsFromBucket(r,l){this.models[l]||(this.models[l]={}),this.modelUris[l]||(this.modelUris[l]={});const p={};for(const _ of r)this.hasModel(_,l,{exactIdMatch:!0})||this.hasURLBeenRequested(_)?this.models[l][_].numReferences++:this.modelUris[l][_]&&!this.hasURLBeenRequested(_)?p[_]=this.modelUris[l][_]:!this.hasURLBeenRequested(_)&&u.d9(_,!1)&&(this.modelUris[l][_]=this.requestManager.normalizeModelURL(_),p[_]=this.modelUris[l][_]);this.load(p,l)}hasURLBeenRequested(r){return void 0!==this.modelByURL[r]}removeModel(r,l,p=!1,_=!1){if(this.models[l]&&this.models[l][r]&&(this.models[l][r].numReferences--,0===this.models[l][r].numReferences||_)){const v=this.modelUris[l][r];p||delete this.modelUris[l][r],delete this.modelByURL[v];const b=this.models[l][r].model;if(!b)return;delete this.models[l][r],b.destroy()}}destroy(){for(const r of Object.keys(this.models))for(const l of Object.keys(this.models[r])){const p=this.models[r][l].model;delete this.models[r][l],p&&p.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(r){return this.models[r]||(this.models[r]={}),Object.keys(this.models[r])}upload(r,l){this.models[l]||(this.models[l]={});for(const p in this.models[l])this.models[l][p].model&&this.models[l][p].model.upload(r.context)}}const Bl=new u.a7({data:new u.a8(u.a5.colorTheme.data)});class ff{constructor(r){this._scope=r,this._buildingQueryParams={target:{featuresetId:"building-outline",importId:this._scope}},this._floorQueryParams={target:{featuresetId:"floor-outline",importId:this._scope}}}execute(r){const l=this._makeBuildingsQueryArea(r),p=this._makeFloorsQueryArea(r),_=r.queryRenderedFeatures(l,this._buildingQueryParams).filter(S=>"building"===S.properties.shape_type).reduce((S,I)=>{const P=I.properties.id;return"building"!==I.properties.shape_type||S.some(R=>R.properties.id===P)||S.push(I),S},[]),v=r.queryRenderedFeatures(p,this._floorQueryParams).filter(S=>"floor"===S.properties.shape_type).reduce((S,I)=>{const P=I.properties.id;return"floor"!==I.properties.shape_type||S.some(R=>R.properties.id===P)||S.push(I),S},[]),b=[r.getCenter().lng,r.getCenter().lat];return{floors:v,building:this._findBuildingAtCenter(b,_)||(_.length>0?_[0]:null)}}_makeBuildingsQueryArea(r){const l=r.transform.width,p=r.transform.height,_=Math.min(l,p),v=_*(1/8),b=_*(1/8),S=.5*(l-v),I=.5*(p-b);return[new u.P(S,I),new u.P(S+v,I+b)]}_makeFloorsQueryArea(r){const l=r.transform.width,p=r.transform.height,_=l*(2/3),v=p*(2/3),b=.5*(l-_),S=.5*(p-v);return[new u.P(b,S),new u.P(b+_,S+v)]}_findBuildingAtCenter(r,l){for(const p of l)if("Polygon"===p.geometry.type&&this._pointInPolygon(r,p.geometry.coordinates[0]))return p;return null}_pointInPolygon(r,l){let p=!1;for(let _=0,v=l.length-1;_<l.length;v=_++){const b=l[_][0],S=l[_][1],I=l[v][1];S>r[1]!=I>r[1]&&r[0]<(l[v][0]-b)*(r[1]-S)/(I-S)+b&&(p=!p)}return p}}class Wa{constructor(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}setBuildingId(r){this._selectedBuildingId=r}setFloors(r){if(this._floors=r.filter(l=>l.properties.building_id===this._selectedBuildingId),!this._selectedFloorId||!this._floors.map(l=>l.properties.id).includes(this._selectedFloorId)){const l=this._floors.map(p=>({id:p.properties.id,level:p.properties.floor_level})).reduce((p,_)=>{const v=Math.abs(p.level-1),b=Math.abs(_.level-1);return b<v||b===v&&_.level>p.level?_:p});this._selectedFloorId=l.id}}setFloorId(r){this._selectedFloorId=r}getSelectedFloorId(){return this._selectedFloorId}getCurrentBuildingFloors(){return this._floors}reset(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}}const Bp={"mbx-indoor-level-selected":{default:["literal",[]]}};function Vp(f){return f=f||{},Object.assign(f,Bp)}class Vg extends u.E{constructor(r){super(),u.aV(["_onLoad","_onMove"],this),this._map=r,this._floorSelectionState=new Wa,this._queryIndoor(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=null,this._floorSelectionState=null}_onLoad(){this._map.style.forEachFragmentStyle(r=>{r.stylesheet.indoor&&(this._indoorDataQuery?this.fire(new u.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._scope=r.scope,this._indoorDataQuery=new ff(this._scope)))}),this._map._addIndoorControl(),this._queryIndoor()}_onMove(){this._queryIndoor()}_queryIndoor(){if(!this._indoorDataQuery||!this._map.isStyleLoaded())return;if(this._map.transform.zoom<16)return void this._clearIndoorData();const r=this._indoorDataQuery.execute(this._map);r&&0!==r.floors.length?(this._floorSelectionState.getSelectedFloorId()||this._map._addIndoorControl(),this._selectFloors(r)):this._clearIndoorData()}_selectFloors(r){if(r.building)this._floorSelectionState.setBuildingId(r.building.properties.id),this._floorSelectionState.setFloors(r.floors),this._updateUI();else{const l=this._floorSelectionState.getSelectedFloorId();if(l&&r.floors.some(p=>p.properties.id===l))return;this._clearIndoorData()}}_clearIndoorData(){this._floorSelectionState.reset(),this._map._removeIndoorControl(),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[]])}_updateUI(){const r=this._floorSelectionState.getCurrentBuildingFloors().map(p=>({id:p.properties.id,name:p.properties.name,shortName:p.properties.floor_level,levelOrder:p.properties.floor_level})),l=this._floorSelectionState.getSelectedFloorId();l?(this._updateIndoorConfig(),this.fire(new u.A("indoorupdate",{selectedFloorId:l,floors:r}))):console.warn("IndoorManager: Selected floor is not set")}_updateIndoorConfig(){const r=this._floorSelectionState.getSelectedFloorId();r?this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[r]]):console.warn("IndoorManager: Selected floor is not set")}selectFloor(r){this._floorSelectionState.setFloorId(r),this._updateIndoorConfig()}}function ku(f){if(!f.metadata||!f.metadata.content_area)return;const r=u.q.devicePixelRatio,{left:l,top:p,width:_,height:v}=f.metadata.content_area,b=l*r,S=p*r;return[b,S,b+_*r,S+v*r]}function jp(f){if(f)return f.map(([r,l])=>[r*u.q.devicePixelRatio,l*u.q.devicePixelRatio])}class pf{constructor(r,l,p){this.id=r,this.scope=l,this.sourceCache=p,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(r){this.missingRequests.has(r.name)||this.pendingRequests.has(r.name)||this.pendingRequests.add(r.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const r=new Map;if(!this.sourceCache.loaded())return r;const l=this.sourceCache.getVisibleCoordinates();if(0===l.length)return r;const p=this.sourceCache.getSource();if(!(p instanceof Rl))return r;const _=l.map(b=>this.sourceCache.getTile(b)),v=p.getImages(_,Array.from(this.pendingRequests));for(const[b,S]of v)r.set(u.I.from({name:b,iconsetId:this.id}),S),this.pendingRequests.delete(b);for(const b of this.pendingRequests)this.missingRequests.add(b);return this.pendingRequests.clear(),r}}const Vl=(f,r)=>se(f,r&&r.filter(l=>"source.canvas"!==l.identifier)),Up=u.aF(Rn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),jg=u.aF(Rn,["setCenter","setZoom","setBearing","setPitch"]),mf=new Set(["background","sky","slot","custom"]),go={version:8,layers:[],sources:{}},Gd={duration:300,delay:0};class Ls extends u.E{constructor(r,l={}){super(),this.map=r,this.scope=l.scope||"",this.globalId=null,this.fragments=[],this.importDepth=l.importDepth||0,this.importsCache=l.importsCache||new Map,this.resolvedImports=l.resolvedImports||new Set,this.transition=u.h({},Gd),this._buildingIndex=new Fd(this),this.crossTileSymbolIndex=new po,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=l.styleChanges||new Cd,this.dispatcher=l.dispatcher?l.dispatcher:new u.D(u.db(),this),l.imageManager?this.imageManager=l.imageManager:(this.imageManager=new or(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=l.glyphManager?l.glyphManager:new u.dc(r._requestManager,l.localFontFamily?u.dd.all:l.localIdeographFontFamily?u.dd.ideographs:u.dd.none,l.localFontFamily||l.localIdeographFontFamily),l.modelManager?this.modelManager=l.modelManager:(this.modelManager=new Ia(r._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=l.configOptions?l.configOptions:new Map,this._configDependentLayers=l.configDependentLayers?l.configDependentLayers:new Set,this._config=l.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:l.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=l.initialConfig,this.dispatcher.broadcast("setReferrer",u.de());const p=this;this._rtlTextPluginCallback=Ls.registerForPluginStateChange(_=>{p.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:_.pluginStatus,pluginURL:_.pluginURL},(v,b)=>{if(u.df(v),b&&b.every(S=>S))for(const S in p._sourceCaches){const I=p._sourceCaches[S],P=I.getSource().type;"vector"!==P&&"geojson"!==P||I.reload()}})}),this.on("data",_=>{if("source"!==_.dataType||"metadata"!==_.sourceDataType)return;const v=this.getOwnSource(_.sourceId);if(v&&v.vectorLayerIds)for(const b in this._layers){const S=this._layers[b];S.source===v.id&&this._validateLayer(S)}})}load(r){return r?("string"==typeof r?this.loadURL(r):this.loadJSON(r),this):this}_getGlobalId(r){if(!r)return null;if("string"==typeof r){if(u.j(r))return r;const l=u.dg(r);if(!l.startsWith("http"))try{return new URL(l,location.href).toString()}catch{return l}return l}return`json://${u.dh(JSON.stringify(r))}`}_diffStyle(r,l,p){this.globalId=this._getGlobalId(r);const _=(v,b)=>{try{b(null,this.setState(v,p))}catch(S){b(S,!1)}};if("string"==typeof r){const v=this.map._requestManager.normalizeStyleURL(r),b=this.map._requestManager.transformRequest(v,u.R.Style);u.n(b,(S,I)=>{S?this.fire(new u.z(S)):I&&_(I,l)})}else"object"==typeof r&&_(r,l)}loadURL(r,l={}){this.fire(new u.A("dataloading",{dataType:"style"}));const p="boolean"==typeof l.validate?l.validate:!u.j(r);this.globalId=this._getGlobalId(r),r=this.map._requestManager.normalizeStyleURL(r,l.accessToken),this.resolvedImports.add(r);const _=this.importsCache.get(r);if(_)return this._load(_,p);const v=this.map._requestManager.transformRequest(r,u.R.Style);this._request=u.n(v,(b,S)=>{if(this._request=null,b)this.fire(new u.z(b));else if(S)return this.importsCache.set(r,S),this._load(S,p)})}loadJSON(r,l={}){this.fire(new u.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(r),this._request=u.q.frame(()=>{this._request=null,this._load(r,!1!==l.validate)})}loadEmpty(){this.fire(new u.A("dataloading",{dataType:"style"})),this._load(go,!1)}_loadImports(r,l,p){if(this.importDepth>=4)return u.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const _=[];for(const v of r){const b=this._createFragmentStyle(v),S=new Promise(R=>{b.once("style.import.load",R),b.once("error",R)}).then(()=>this.mergeAll());if(_.push(S),this.resolvedImports.has(v.url)){b.loadEmpty();continue}const I=v.data||this.importsCache.get(v.url);I?(b.loadJSON(I,{validate:l}),this._isInternalStyle(I)&&(b.globalId=null)):v.url?b.loadURL(v.url,{validate:l}):b.loadEmpty();const P={style:b,id:v.id,config:v.config};if(p){const R=this.fragments.findIndex(({id:z})=>z===p);this.fragments=this.fragments.slice(0,R).concat(P).concat(this.fragments.slice(R))}else this.fragments.push(P)}return Promise.allSettled(_)}getImportGlobalIds(r=this,l=new Set){for(const p of r.fragments)p.style.globalId&&l.add(p.style.globalId),this.getImportGlobalIds(p.style,l);return[...l.values()]}_createFragmentStyle(r){const l=this.scope?u.C(r.id,this.scope):r.id;let p;const _=this._initialConfig&&this._initialConfig[l];(r.config||_)&&(p=u.h({},r.config,_));const v=new Ls(this.map,{scope:l,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:p,configOptions:this.options,colorThemeOverride:r["color-theme"],configDependentLayers:this._configDependentLayers});return v.setEventedParent(this.map,{style:v}),v}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(r){return this.isRootStyle()&&(r.fragment||!!r.schema&&!1!==r.fragment)}_load(r,l){const p=r.indoor?Vp(r.schema):r.schema;if(this._isInternalStyle(r)){const b=u.h({},go,{imports:[{id:"basemap",data:r,url:""}]});return void this._load(b,l)}if(this.updateConfig(this._config,p),l&&Vl(this,Ps(r)))return;this._loaded=!0,this.stylesheet=u.di(r);const _=()=>{for(const P in r.sources)this.addSource(P,r.sources[P],{validate:!1,isInitialLoad:!0});if(r.iconsets)for(const P in r.iconsets)this.addIconset(P,r.iconsets[P]);r.sprite?this._loadIconset(r.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&r.glyphs&&this.glyphManager.setURL(r.glyphs);const b=ki(this.stylesheet.layers);if(this._order=b.map(P=>P.id),this.stylesheet.light&&u.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const P=this.stylesheet.lights[0];this.light=new ke(P.properties,P.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new ke(this.stylesheet.light)),this._layers={};for(const P of b){const R=u.dn(P,this.scope,this._styleColorTheme.lut,this.options);0!==R.configDependencies.size&&this._configDependentLayers.add(R.fqid),R.setEventedParent(this,{layer:{id:R.id}}),this._layers[R.id]=R;const z=this.getOwnLayerSourceCache(R),L=!!this.directionalLight&&this.directionalLight.shadowsEnabled();z&&R.canCastShadows()&&L&&(z.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const S=this.stylesheet.terrain;S&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(S,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new u.A("data",{dataType:"style"}));const I=this.isRootStyle();r.imports?this._loadImports(r.imports,l).then(()=>{this._reloadImports(),this.fire(new u.A(I?"style.load":"style.import.load"))}).catch(P=>{this.fire(new u.z(new Error("Failed to load imports",P))),this.fire(new u.A(I?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new u.A(I?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const v=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(v){const b=this._evaluateColorThemeData(v);this._loadColorTheme(b).then(()=>{_()}).catch(S=>{u.w(`Couldn't load color theme from the stylesheet: ${S}`),_()})}else this._styleColorTheme.lut=null,_()}isRootStyle(){return 0===this.importDepth}mergeAll(){let r,l,p,_,v,b,S,I,P,R;const z={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(L=>{if(L.stylesheet){if(null!=L.light&&(r=L.light),L.stylesheet.lights)for(const B of L.stylesheet.lights)"ambient"===B.type&&null!=L.ambientLight&&(l=L.ambientLight),"directional"===B.type&&null!=L.directionalLight&&(p=L.directionalLight);_=this._prioritizeTerrain(_,L.terrain,L.stylesheet.terrain),L.stylesheet.fog&&null!=L.fog&&(v=L.fog),L.stylesheet.snow&&null!=L.snow&&(b=L.snow),L.stylesheet.rain&&null!=L.rain&&(S=L.rain),null!=L.stylesheet.camera&&(R=L.stylesheet.camera),null!=L.stylesheet.projection&&(I=L.stylesheet.projection),null!=L.stylesheet.transition&&(P=L.stylesheet.transition),z[L.scope]=L._styleColorTheme}}),this.light=r,this.ambientLight=l,this.directionalLight=p,this.fog=v,this.snow=b,this.rain=S,this._styleColorThemeForScope=z,null===_?delete this.terrain:this.terrain=_,this.camera=R||{"camera-projection":"perspective"},this.projection=I||{name:"mercator"},this.transition=u.h({},Gd,P),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(r){const l=p=>{for(const _ of p.fragments)l(_.style);r(p)};l(this)}_prioritizeTerrain(r,l,p){const _=r&&0===r.drapeRenderMode;return null===p?l&&0===l.drapeRenderMode?l:_?r:null:null!=l&&(!r||_||l&&1===l.drapeRenderMode)?l:r}mergeTerrain(){let r;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(l=>{r=this._prioritizeTerrain(r,l.terrain,l.stylesheet.terrain)}),null===r?delete this.terrain:this.terrain=r}mergeProjection(){let r;this.forEachFragmentStyle(l=>{null!=l.stylesheet.projection&&(r=l.stylesheet.projection)}),this.projection=r||{name:"mercator"}}mergeSources(){const r={},l={},p={};this.forEachFragmentStyle(_=>{for(const v in _._sourceCaches){const b=u.C(v,_.scope);r[b]=_._sourceCaches[v]}for(const v in _._otherSourceCaches){const b=u.C(v,_.scope);l[b]=_._otherSourceCaches[v]}for(const v in _._symbolSourceCaches){const b=u.C(v,_.scope);p[b]=_._symbolSourceCaches[v]}}),this._mergedSourceCaches=r,this._mergedOtherSourceCaches=l,this._mergedSymbolSourceCaches=p}mergeLayers(){const r={},l=[],p={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(v=>{for(const b of v._order){const S=v._layers[b];if("slot"===S.type){const I=u.dj(b);if(r[I])continue;r[I]=[]}S.slot&&r[S.slot]?r[S.slot].push(S):l.push(S)}}),this._mergedOrder=[];const _=(v=[])=>{for(const b of v)if("slot"===b.type){const S=u.dj(b.id);r[S]&&_(r[S]),this._mergedSlots.push(S)}else{const S=u.C(b.id,b.scope);this._mergedOrder.push(S),p[S]=b,b.is3D(!!this.terrain)&&(this._has3DLayers=!0),"circle"===b.type&&(this._hasCircleLayers=!0),"symbol"===b.type&&(this._hasSymbolLayers=!0),"clip"===b.type&&(this._clipLayerPresent=!0)}};_(l),this._mergedOrder.sort((v,b)=>{const S=p[v],I=p[b];return S.hasInitialOcclusionOpacityProperties?I.is3D(!!this.terrain)?1:0:S.is3D(!!this.terrain)&&I.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=p,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(r){return this.stylesheet.camera=u.h({},this.stylesheet.camera,r),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(r){return r.data?function(l,p,_,v){const b=u.h({},p);for(const I of Object.keys(u.a5.colorTheme))void 0===b[I]&&(b[I]=u.a5.colorTheme[I].default);const S=new u.a6(Bl,l,new Map(_));return S.setTransitionOrValue(b,_),S.untransitioned().possiblyEvaluate(new u.aa(0,{worldview:void 0}))}(this.scope,r,this.options).get("data"):null}_loadColorTheme(r){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const l=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((p,_)=>{const v="data:image/png;base64,";if(!r||0===r.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void p();let b=r;b.startsWith(v)||(b=v+b);const S=u.I.from("mapbox-reserved-lut"),I=new Image;I.src=b,I.onerror=()=>{this._styleColorTheme.lutLoading=!1,_(new Error("Failed to load image data"))},I.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==l)return void p();this._styleColorTheme.lutLoading=!1;const{width:P,height:R,data:z}=u.q.getImageData(I);if(R>32)return void _(new Error("The height of the image must be less than or equal to 32 pixels."));if(P!==R*R)return void _(new Error("The width of the image must be equal to the height squared."));this.getImage(S)&&this.removeImage(S),this.addImage(S,{data:new u.r({width:P,height:R},z),pixelRatio:1,sdf:!1,usvg:!1,version:0});const L=this.imageManager.getImage(S,this.scope);L?(this._styleColorTheme.lut={image:L.data,data:r},p()):_(new Error("Missing LUT image."))}})}getLut(r){const l=this._styleColorThemeForScope[r];return l?l.lut:null}setProjection(r){r?this.stylesheet.projection=r:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(r){this._spriteRequest=function(l,p,_){let v,b,S;const I=u.q.devicePixelRatio>1?"@2x":"";let P=u.n(p.transformRequest(p.normalizeSpriteURL(l,I,".json"),u.R.SpriteJSON),(L,B)=>{P=null,S||(S=L,v=B,z())}),R=u.o(p.transformRequest(p.normalizeSpriteURL(l,I,".png"),u.R.SpriteImage),(L,B)=>{R=null,S||(S=L,b=B,z())});function z(){if(S)_(S);else if(v&&b){const L=u.q.getImageData(b),B={};for(const H in v){const{width:U,height:q,x:G,y:Y,sdf:ee,pixelRatio:ne,stretchX:le,stretchY:de,content:pe}=v[H],ae=new u.r({width:U,height:q});u.r.copy(L,ae,{x:G,y:Y},{x:0,y:0},{width:U,height:q},null),B[H]={data:ae,pixelRatio:ne,sdf:ee,stretchX:le,stretchY:de,content:pe,usvg:!1}}_(null,B)}}return{cancel(){P&&(P.cancel(),P=null),R&&(R.cancel(),R=null)}}}(r,this.map._requestManager,(l,p)=>{if(this._spriteRequest=null,l)this.fire(new u.z(l));else if(p){const _=new Map;for(const v in p)_.set(u.I.from(v),p[v]);this.addImages(_)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new u.A("data",{dataType:"style"}))})}addIconset(r,l){if("sprite"===l.type)return void this._loadSprite(l.url);const p=this.getOwnSourceCache(l.source);if(!p)return void this.fire(new u.z(new Error(`Source "${l.source}" as specified by iconset "${r}" does not exist and cannot be used as an iconset source`)));const _=p.getSource();if("raster-array"!==_.type)return void this.fire(new u.z(new Error(`Source "${l.source}" as specified by iconset "${r}" is not a "raster-array" source and cannot be used as an iconset source`)));_.partial=!1;const v=new pf(r,this.scope,p);this.imageManager.addImageProvider(v,this.scope)}removeIconset(r){this.imageManager.removeImageProvider(r,this.scope)}_loadIconset(r){if(!u.j(r)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(r);const l="auto"===this.map._spriteFormat;var p,_;this._spriteRequest=(_=(v,b)=>{if(this._spriteRequest=null,v)l?this._loadSprite(r):this.fire(new u.z(v));else if(b){const S=new Map;for(const I in b)S.set(u.I.from(I),b[I]);this.addImages(S)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new u.A("data",{dataType:"style"}))},u.br((p=this.map._requestManager).transformRequest(p.normalizeIconsetURL(r),u.R.Iconset),(v,b)=>{if(v)return void _(v);const S={},I=u.da(new u.bq(b));for(const P of I.icons){const R={version:1,pixelRatio:u.q.devicePixelRatio,content:ku(P),stretchX:P.metadata?jp(P.metadata.stretch_x_areas):void 0,stretchY:P.metadata?jp(P.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:P};S[P.name]=R}_(null,S)}))}_validateLayer(r){const l=this.getOwnSource(r.source);if(!l)return;const p=r.sourceLayer;p&&("geojson"===l.type||l.vectorLayerIds&&-1===l.vectorLayerIds.indexOf(p))&&this.fire(new u.z(new Error(`Source layer "${p}" does not exist on source "${l.id}" as specified by style layer "${r.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const r in this._sourceCaches)if(!this._sourceCaches[r].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:r}of this.fragments)if(!r.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((r,l)=>{const p=this.fragments[l];return p&&p.style&&(r.data=p.style.serialize()),r})}_serializeSources(){const r={};for(const l in this._sourceCaches){const p=this._sourceCaches[l].getSource();r[p.id]||(r[p.id]=p.serialize())}return r}_serializeLayers(r){const l=[];for(const p of r){const _=this._layers[p];_&&"custom"!==_.type&&l.push(_.serialize())}return l}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const r in this._sourceCaches)if(this._sourceCaches[r].hasTransition())return!0;for(const r in this._layers)if(this._layers[r].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(r){return r?this.order:this._mergedOrder}isLayerDraped(r){return!!this.terrain&&r.isDraped(this.getLayerSourceCache(r))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(r){const l=this.getOwnLayer(r);if(l)return l;this.fire(new u.z(new Error(`The layer '${r}' does not exist in the map's style.`)))}_checkSource(r){const l=this.getOwnSource(r);if(l)return l;this.fire(new u.z(new Error(`The source '${r}' does not exist in the map's style.`)))}precompilePrograms(r,l){const p=this.map.painter;if(p)for(let _=r.minzoom||0;_<(r.maxzoom||25.5);_++){const v=r.getProgramIds();if(v)for(const b of v){const S=r.getDefaultProgramParams(b,l.zoom,this._styleColorTheme.lut);S&&(p.style=this,this.fog&&(p._fogVisible=!0,S.overrideFog=!0,p.getOrCreateProgram(b,S)),p._fogVisible=!1,S.overrideFog=!1,p.getOrCreateProgram(b,S),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(S.overrideRtt=!0,p.getOrCreateProgram(b,S)))}}}update(r){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(r),this.directionalLight&&this.directionalLight.recalculate(r);const l=this.calculateLightsBrightness();r.brightness=l||0,l!==this._brightness&&(this._brightness=l,this.dispatcher.broadcast("setBrightness",l)),r.worldview!==this._worldview&&(this._worldview=r.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const p=this._changes.isDirty();let _=!1;if(this._changes.isDirty()){const S=this._changes.getLayerUpdatesByScope();for(const I in S){const{updatedIds:P,removedIds:R}=S[I];(P||R)&&(this._updateWorkerLayers(I,P,R),_=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(r),this.light&&this.light.updateTransitions(r),this.ambientLight&&this.ambientLight.updateTransitions(r),this.directionalLight&&this.directionalLight.updateTransitions(r),this.fog&&this.fog.updateTransitions(r),this.snow&&this.snow.updateTransitions(r),this.rain&&this.rain.updateTransitions(r),this._changes.reset()}const v={};for(const S in this._mergedSourceCaches){const I=this._mergedSourceCaches[S];v[S]=I.used,I.used=!1,I.tileCoverLift=0}for(const S of this._mergedOrder){const I=this._mergedLayers[S];if(I.recalculate(r,this._availableImages),!I.isHidden(r.zoom)){const P=this.getLayerSourceCache(I);P&&(P.used=!0,P.tileCoverLift=Math.max(P.tileCoverLift,I.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(I,r)}):this.precompilePrograms(I,r))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&_&&this.mergeLayers();const b=this.imageManager.getPendingImageProviders();for(const S of b)S.sourceCache.used=!0;for(const S in v){const I=this._mergedSourceCaches[S];v[S]!==I.used&&I.getSource().fire(new u.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:I.getSource().id}))}this.light&&this.light.recalculate(r),this.terrain&&this.terrain.recalculate(r),this.fog&&this.fog.recalculate(r),this.snow&&this.snow.recalculate(r),this.rain&&this.rain.recalculate(r),this.z=r.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),p&&this.fire(new u.A("data",{dataType:"style"}))}updateImageProviders(){const r=this.imageManager.getPendingImageProviders();for(const l of r){const p=l.resolvePendingRequests(),_=this.getFragmentStyle(l.scope);_&&_.addImages(p)}}_updateTilesForChangedImages(){const r={};for(const l in this._mergedSourceCaches){const p=this._mergedSourceCaches[l].getSource().scope;r[p]=r[p]||this._changes.getUpdatedImages(p),0!==r[p].length&&this._mergedSourceCaches[l].reloadTilesForDependencies(["icons","patterns"],r[p])}for(const l in r)this._changes.resetUpdatedImages(l)}_updateWorkerLayers(r,l,p){const _=this.getFragmentStyle(r);_&&this.dispatcher.broadcast("updateLayers",{layers:l?_._serializeLayers(l):[],scope:r,removedIds:p||[],options:_.options})}setState(r,l){if(this._checkLoaded(),Vl(this,Ps(r)))return!1;(r=u.di(r)).layers=ki(r.layers);const p=function(b,S){if(!b)return[{command:Rn.setStyle,args:[S]}];let I=[];try{if(!u.bv(b.version,S.version))return[{command:Rn.setStyle,args:[S]}];if(u.bv(b.center,S.center)||I.push({command:Rn.setCenter,args:[S.center]}),u.bv(b.zoom,S.zoom)||I.push({command:Rn.setZoom,args:[S.zoom]}),u.bv(b.bearing,S.bearing)||I.push({command:Rn.setBearing,args:[S.bearing]}),u.bv(b.pitch,S.pitch)||I.push({command:Rn.setPitch,args:[S.pitch]}),u.bv(b.sprite,S.sprite)||I.push({command:Rn.setSprite,args:[S.sprite]}),u.bv(b.glyphs,S.glyphs)||I.push({command:Rn.setGlyphs,args:[S.glyphs]}),u.bv(b.imports,S.imports)||function(B=[],H=[],U){H=H||[];const q=(B=B||[]).map(xc),G=H.map(xc),Y=B.reduce(bc,{}),ee=H.reduce(bc,{}),ne=q.slice();let le,de,pe,ae;for(le=0,de=0;le<q.length;le++)pe=q[le],ee.hasOwnProperty(pe)?de++:(U.push({command:Rn.removeImport,args:[pe]}),ne.splice(ne.indexOf(pe,de),1));for(le=0,de=0;le<G.length;le++)pe=G[G.length-1-le],ne[ne.length-1-le]!==pe&&(Y.hasOwnProperty(pe)?(U.push({command:Rn.removeImport,args:[pe]}),ne.splice(ne.lastIndexOf(pe,ne.length-de),1)):de++,ae=ne[ne.length-le],U.push({command:Rn.addImport,args:[ee[pe],ae]}),ne.splice(ne.length-le,0,pe));for(const ce of H){const ue=Y[ce.id];ue&&(delete ue.data,u.bv(ue,ce)||U.push({command:Rn.updateImport,args:[ce.id,ce]}))}}(b.imports,S.imports,I),u.bv(b.transition,S.transition)||I.push({command:Rn.setTransition,args:[S.transition]}),u.bv(b.light,S.light)||I.push({command:Rn.setLight,args:[S.light]}),u.bv(b.fog,S.fog)||I.push({command:Rn.setFog,args:[S.fog]}),u.bv(b.snow,S.snow)||I.push({command:Rn.setSnow,args:[S.snow]}),u.bv(b.rain,S.rain)||I.push({command:Rn.setRain,args:[S.rain]}),u.bv(b.projection,S.projection)||I.push({command:Rn.setProjection,args:[S.projection]}),u.bv(b.lights,S.lights)||I.push({command:Rn.setLights,args:[S.lights]}),u.bv(b.camera,S.camera)||I.push({command:Rn.setCamera,args:[S.camera]}),u.bv(b.iconsets,S.iconsets)||function(B,H,U){let q;for(q in H=H||{},B=B||{})B.hasOwnProperty(q)&&(H.hasOwnProperty(q)||U.push({command:Rn.removeIconset,args:[q]}));for(q in H){if(!H.hasOwnProperty(q))continue;const G=H[q];B.hasOwnProperty(q)?u.bv(B[q],G)||(U.push({command:Rn.removeIconset,args:[q]}),U.push({command:Rn.addIconset,args:[q,G]})):U.push({command:Rn.addIconset,args:[q,G]})}}(b.iconsets,S.iconsets,I),!u.bv(b["color-theme"],S["color-theme"]))return[{command:Rn.setStyle,args:[S]}];const P={},R=[];!function(B,H,U,q){let G;for(G in H=H||{},B=B||{})B.hasOwnProperty(G)&&(H.hasOwnProperty(G)||Au(G,U,q));for(G in H){if(!H.hasOwnProperty(G))continue;const Y=H[G];B.hasOwnProperty(G)?u.bv(B[G],Y)||("geojson"===B[G].type&&"geojson"===Y.type&&Rs(B,H,G)?U.push({command:Rn.setGeoJSONSourceData,args:[G,Y.data]}):vc(G,H,U,q)):Lp(G,H,U)}}(b.sources,S.sources,R,P);const z=[];b.layers&&b.layers.forEach(B=>{B.source&&P[B.source]?I.push({command:Rn.removeLayer,args:[B.id]}):z.push(B)});let L=b.terrain;L&&P[L.source]&&(I.push({command:Rn.setTerrain,args:[void 0]}),L=void 0),I=I.concat(R),u.bv(L,S.terrain)||I.push({command:Rn.setTerrain,args:[S.terrain]}),function(B,H,U){H=H||[];const q=(B=B||[]).map(xc),G=H.map(xc),Y=B.reduce(bc,{}),ee=H.reduce(bc,{}),ne=q.slice(),le=Object.create(null);let de,pe,ae,ce,ue,Me,ye;for(de=0,pe=0;de<q.length;de++)ae=q[de],ee.hasOwnProperty(ae)?pe++:(U.push({command:Rn.removeLayer,args:[ae]}),ne.splice(ne.indexOf(ae,pe),1));for(de=0,pe=0;de<G.length;de++)ae=G[G.length-1-de],ne[ne.length-1-de]!==ae&&(Y.hasOwnProperty(ae)?(U.push({command:Rn.removeLayer,args:[ae]}),ne.splice(ne.lastIndexOf(ae,ne.length-pe),1)):pe++,Me=ne[ne.length-de],U.push({command:Rn.addLayer,args:[ee[ae],Me]}),ne.splice(ne.length-de,0,ae),le[ae]=!0);for(de=0;de<G.length;de++)if(ae=G[de],ce=Y[ae],ue=ee[ae],!le[ae]&&!u.bv(ce,ue))if(u.bv(ce.source,ue.source)&&u.bv(ce["source-layer"],ue["source-layer"])&&u.bv(ce.type,ue.type)){for(ye in cf(ce.layout,ue.layout,U,ae,null,Rn.setLayoutProperty),cf(ce.paint,ue.paint,U,ae,null,Rn.setPaintProperty),u.bv(ce.slot,ue.slot)||U.push({command:Rn.setSlot,args:[ae,ue.slot]}),u.bv(ce.filter,ue.filter)||U.push({command:Rn.setFilter,args:[ae,ue.filter]}),u.bv(ce.minzoom,ue.minzoom)&&u.bv(ce.maxzoom,ue.maxzoom)||U.push({command:Rn.setLayerZoomRange,args:[ae,ue.minzoom,ue.maxzoom]}),ce)ce.hasOwnProperty(ye)&&"layout"!==ye&&"paint"!==ye&&"filter"!==ye&&"metadata"!==ye&&"minzoom"!==ye&&"maxzoom"!==ye&&"slot"!==ye&&(0===ye.indexOf("paint.")?cf(ce[ye],ue[ye],U,ae,ye.slice(6),Rn.setPaintProperty):u.bv(ce[ye],ue[ye])||U.push({command:Rn.setLayerProperty,args:[ae,ye,ue[ye]]}));for(ye in ue)ue.hasOwnProperty(ye)&&!ce.hasOwnProperty(ye)&&"layout"!==ye&&"paint"!==ye&&"filter"!==ye&&"metadata"!==ye&&"minzoom"!==ye&&"maxzoom"!==ye&&"slot"!==ye&&(0===ye.indexOf("paint.")?cf(ce[ye],ue[ye],U,ae,ye.slice(6),Rn.setPaintProperty):u.bv(ce[ye],ue[ye])||U.push({command:Rn.setLayerProperty,args:[ae,ye,ue[ye]]}))}else U.push({command:Rn.removeLayer,args:[ae]}),Me=ne[ne.lastIndexOf(ae)+1],U.push({command:Rn.addLayer,args:[ue,Me]})}(z,S.layers,I)}catch(P){console.warn("Unable to compute style diff:",P),I=[{command:Rn.setStyle,args:[S]}]}return I}(this.serialize(),r).filter(b=>!(b.command in jg));if(0===p.length)return!1;const _=p.filter(b=>!(b.command in Up));if(_.length>0)throw new Error(`Unimplemented: ${_.map(b=>b.command).join(", ")}.`);const v=[];return p.forEach(b=>{v.push(this[b.command](...b.args))}),l&&Promise.all(v).then(l).catch(l),this.stylesheet=r,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(r){if(0===r.size)return this;for(const[l,p]of r.entries()){if(this.getImage(l))return this.fire(new u.z(new Error(`An image with the name "${l.name}" already exists.`)));this.imageManager.addImage(l,this.scope,p),this._changes.updateImage(l,this.scope)}return this._updateWorkerImages(),this.fire(new u.A("data",{dataType:"style"})),this}addImage(r,l){return this.getImage(r)?this.fire(new u.z(new Error(`An image with the name "${r.name}" already exists.`))):(this.imageManager.addImage(r,this.scope,l),this._changes.updateImage(r,this.scope),this._updateWorkerImages(),this.fire(new u.A("data",{dataType:"style"})),this)}updateImage(r,l,p=!1){this.imageManager.updateImage(r,this.scope,l),p&&(this._changes.updateImage(r,this.scope),this._updateWorkerImages(),this.fire(new u.A("data",{dataType:"style"})))}getImage(r){return this.imageManager.getImage(r,this.scope)}removeImage(r){return this.getImage(r)?(this.imageManager.removeImage(r,this.scope),this._changes.updateImage(r,this.scope),this._updateWorkerImages(),this.fire(new u.A("data",{dataType:"style"})),this):this.fire(new u.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(r){return this.modelManager.addModelURLs(r,this.scope),this._updateWorkerModels(),this.fire(new u.A("data",{dataType:"style"})),this}addModel(r,l,p={}){return this._checkLoaded(),this._validate(oe,`models.${r}`,l,null,p)||(this.modelManager.addModel(r,l,this.scope),this.fire(new u.A("data",{dataType:"style"}))),this}hasModel(r){return this.modelManager.hasModel(r,this.scope)}removeModel(r){return this.hasModel(r)?(this.modelManager.removeModel(r,this.scope,!1,!0),this.fire(new u.A("data",{dataType:"style"})),this):this.fire(new u.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(r,l,p={}){if(this._checkLoaded(),void 0!==this.getOwnSource(r))throw new Error(`There is already a source with ID "${r}".`);if(!l.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(l).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(l.type)>=0&&this._validate(Rd,`sources.${r}`,l,null,p))return;this.map&&this.map._collectResourceTiming&&(l.collectResourceTiming=!0);const _=Su(r,l,this.dispatcher,this);_.scope=this.scope,_.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(_.id),source:_.serialize(),sourceId:_.id}));const v=b=>{const S=(b?"symbol:":"other:")+_.id,I=u.C(S,this.scope),P=this._sourceCaches[S]=new Do(I,_,b);(b?this._symbolSourceCaches:this._otherSourceCaches)[_.id]=P,P.onAdd(this.map)};v(!1),"vector"!==l.type&&"geojson"!==l.type||v(!0),_.onAdd&&_.onAdd(this.map),p.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(r){this._checkLoaded();const l=this.getOwnSource(r);if(!l)throw new Error("There is no source with this ID");for(const _ in this._layers)if(this._layers[_].source===r)return this.fire(new u.z(new Error(`Source "${r}" cannot be removed while layer "${_}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===r)return this.fire(new u.z(new Error(`Source "${r}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const _=Object.entries(this.stylesheet.iconsets).find(([v,b])=>"source"===b.type&&b.source===r);if(_)return this.fire(new u.z(new Error(`Source "${r}" cannot be removed while iconset "${_[0]}" is using it.`)))}const p=this.getOwnSourceCaches(r);for(const _ of p){const v=u.dj(_.id);delete this._sourceCaches[v],this._changes.discardSourceCacheUpdate(_.id),_.fire(new u.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:_.getSource().id})),_.setEventedParent(null),_.clearTiles()}return delete this._otherSourceCaches[r],delete this._symbolSourceCaches[r],this.mergeSources(),l.setEventedParent(null),l.onRemove&&l.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(r,l){this._checkLoaded(),this.getOwnSource(r).setData(l),this._changes.setDirty()}getOwnSource(r){const l=this.getOwnSourceCache(r);return l&&l.getSource()}getOwnSources(){const r=[];for(const l in this._otherSourceCaches){const p=this.getOwnSourceCache(l);p&&r.push(p.getSource())}return r}areTilesLoaded(){const r=this._mergedSourceCaches;for(const l in r){const p=r[l]._tiles;for(const _ in p){const v=p[_];if("loaded"!==v.state&&"errored"!==v.state)return!1}}return!0}setLights(r){if(this._checkLoaded(),!r)return delete this.ambientLight,void delete this.directionalLight;const l=this._getTransitionParameters();for(const v of r){if(this._validate(Tu,"lights",v))return;switch(v.type){case"ambient":if(this.ambientLight){const b=this.ambientLight;b.set(v),b.updateTransitions(l)}else this.ambientLight=new li(v,yn||(yn=new u.a7({color:new u.a8(u.a5.properties_light_ambient.color),"color-use-theme":new u.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new u.a8(u.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const b=this.directionalLight;b.set(v),b.updateTransitions(l)}else this.directionalLight=new li(v,Qi||(Qi=new u.a7({direction:new u.an(u.a5.properties_light_directional.direction),color:new u.a8(u.a5.properties_light_directional.color),"color-use-theme":new u.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new u.a8(u.a5.properties_light_directional.intensity),"cast-shadows":new u.a8(u.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new u.a8(u.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new u.a8(u.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const p=Object.assign(l,{worldview:this.map.getWorldview()}),_=new u.aa(this.z||0,p);this.ambientLight&&this.ambientLight.recalculate(_),this.directionalLight&&this.directionalLight.recalculate(_),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const r=this.directionalLight,l=this.ambientLight;if(!r||!l)return;const p=L=>.2126*(L[0]<=.03928?L[0]/12.92:Math.pow((L[0]+.055)/1.055,2.4))+.7152*(L[1]<=.03928?L[1]/12.92:Math.pow((L[1]+.055)/1.055,2.4))+.0722*(L[2]<=.03928?L[2]/12.92:Math.pow((L[2]+.055)/1.055,2.4)),_=r.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),v=r.properties.get("intensity"),b=r.properties.get("direction"),S=1-u.d1(b.x,b.y,b.z)[2]/90,I=p(_)*v*S,P=l.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),R=l.properties.get("intensity"),z=p(P)*R;return Number(((I+z)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const r=[];return this.directionalLight&&r.push(this.directionalLight.get()),this.ambientLight&&r.push(this.ambientLight.get()),r}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(r){if(null==r||""===r&&this.isRootStyle())return this;if(u.dk(r)){const l=u.dl(r),p=this.fragments.find(({id:v})=>v===l);if(!p)return;const _=u.dj(r);return p.style.getFragmentStyle(_)}{const l=this.fragments.find(({id:p})=>p===r);return l?l.style:void 0}}setFeaturesetSelectors(r){if(!r)return;const l={},p=(_,v="")=>`${_}::${v}`;this._featuresetSelectors={};for(const _ in r){const v=this._featuresetSelectors[_]=[];for(const b of r[_].selectors){if(b.featureNamespace){const I=this.getOwnLayer(b.layer);if(!I){u.w(`Layer is undefined for selector: ${b.layer}`);continue}const P=p(I.source,I.sourceLayer);if(P in l&&l[P]!==b.featureNamespace){u.w(`"featureNamespace ${b.featureNamespace} of featureset ${_}'s selector is not associated to the same source, skip this selector`);continue}l[P]=b.featureNamespace}let S;if(b.properties)for(const I in b.properties){const P=u.X(b.properties[I]);"success"===P.result&&(S=S||{},S[I]=P.value)}v.push({layerId:b.layer,namespace:b.featureNamespace,properties:S,uniqueFeatureID:b._uniqueFeatureID})}}}getFeaturesetDescriptors(r){const l=this.getFragmentStyle(r);if(!l||!l.stylesheet.featuresets)return[];const p=[];for(const _ in l.stylesheet.featuresets)p.push({featuresetId:_,importId:l.scope?l.scope:void 0});return p}getFeaturesetLayers(r,l){const p=this.getFragmentStyle(l),_=p.stylesheet.featuresets;if(!_||!_[r])return this.fire(new u.z(new Error(`The featureset '${r}' does not exist in the map's style and cannot be queried.`))),[];const v=[];for(const b of _[r].selectors){const S=p.getOwnLayer(b.layer);S&&v.push(S)}return v}getConfigProperty(r,l){const p=this.getFragmentStyle(r);if(!p)return null;const _=u.C(l,p.scope),v=p.options.get(_),b=v?v.value||v.default:null;return b?b.serialize():null}setConfigProperty(r,l,p){const _=this.getFragmentStyle(r);if(!_)return;const v=_.stylesheet.indoor?Vp(_.stylesheet.schema):_.stylesheet.schema;if(!v||!v[l])return;const b=u.X(p);if("success"!==b.result)return void Vl(this,b.value);const S=b.value.expression,I=u.C(l,_.scope),P=_.options.get(I);if(!P)return;let R;const{minValue:z,maxValue:L,stepValue:B,type:H,values:U}=v[l],q=u.X(v[l].default);"success"===q.result&&(R=q.value.expression),R?(this.options.set(I,Object.assign({},P,{value:S,default:R,minValue:z,maxValue:L,stepValue:B,type:H,values:U})),this.updateConfigDependencies(l)):this.fire(new u.z(new Error(`No schema defined for the config option "${l}" in the "${r}" fragment.`)))}getConfig(r){const l=this.getFragmentStyle(r);if(!l)return null;const p=l.stylesheet.schema;if(!p)return null;const _={};for(const v in p){const b=u.C(v,l.scope),S=l.options.get(b),I=S?S.value||S.default:null;_[v]=I?I.serialize():null}return _}setConfig(r,l){const p=this.getFragmentStyle(r);p&&(p.updateConfig(l,p.stylesheet.schema),this.updateConfigDependencies())}getSchema(r){const l=this.getFragmentStyle(r);return l?l.stylesheet.schema:null}setSchema(r,l){const p=this.getFragmentStyle(r);p&&(p.stylesheet.schema=l,p.updateConfig(p._config,l),this.updateConfigDependencies())}updateConfig(r,l){if(this._config=r,r||l)if(l)for(const p in l){let _,v;const b=u.X(l[p].default);if("success"===b.result&&(_=b.value.expression),r&&void 0!==r[p]){const L=u.X(r[p]);"success"===L.result&&(v=L.value.expression)}const{minValue:S,maxValue:I,stepValue:P,type:R,values:z}=l[p];if(_){const L=u.C(p,this.scope);this.options.set(L,{default:_,value:v,minValue:S,maxValue:I,stepValue:P,type:R,values:z})}else this.fire(new u.z(new Error(`No schema defined for config option "${p}".`)))}else this.fire(new u.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(r){for(const l of this._configDependentLayers){const p=this.getLayer(l);if(p){if(r&&!p.configDependencies.has(r))continue;p.possiblyEvaluateVisibility(),this._updateLayer(p)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(l=>{const p=l._styleColorTheme.colorThemeOverride?l._styleColorTheme.colorThemeOverride:l._styleColorTheme.colorTheme;if(p){const _=l._evaluateColorThemeData(p);(!l._styleColorTheme.lut&&""!==_||l._styleColorTheme.lut&&_!==l._styleColorTheme.lut.data)&&l.setColorTheme(p)}}),this._changes.setDirty()}addLayer(r,l,p={}){this._checkLoaded();const _=r.id;if(this._layers[_])return void this.fire(new u.z(new Error(`Layer with id "${_}" already exists on this map`)));let v;if("custom"===r.type){if(Vl(this,u.dm(r)))return;v=u.dn(r,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof r.source&&(this.addSource(_,r.source),r=u.di(r),r=u.h(r,{source:_})),this._validate(Pn,`layers.${_}`,r,{arrayIndex:-1},p))return;v=u.dn(r,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(v),v.setEventedParent(this,{layer:{id:_}})}0!==v.configDependencies.size&&this._configDependentLayers.add(v.fqid);let b=this._order.length;if(l){const R=this._order.indexOf(l);if(-1===R)return void this.fire(new u.z(new Error(`Layer with id "${l}" does not exist on this map.`)));v.slot===this._layers[l].slot?b=R:u.w(`Layer with id "${l}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(b,0,_),this._layerOrderChanged=!0,this._layers[_]=v;const S=this.getOwnLayerSourceCache(v),I=!!this.directionalLight&&this.directionalLight.shadowsEnabled();S&&v.canCastShadows()&&I&&(S.castsShadows=!0);const P=this._changes.getRemovedLayer(v);if(P&&v.source&&S&&"custom"!==v.type){this._changes.discardLayerRemoval(v);const R=u.C(v.source,v.scope);P.type!==v.type?this._changes.updateSourceCache(R,"clear"):(this._changes.updateSourceCache(R,"reload"),S.pause())}this._updateLayer(v),v.onAdd&&v.onAdd(this.map),v.scope=this.scope,this.mergeLayers()}moveLayer(r,l){this._checkLoaded();const p=this._checkLayer(r);if(!p||r===l)return;const _=this._order.indexOf(r);this._order.splice(_,1);let v=this._order.length;if(l){const b=this._order.indexOf(l);if(-1===b)return void this.fire(new u.z(new Error(`Layer with id "${l}" does not exist on this map.`)));p.slot===this._layers[l].slot?v=b:u.w(`Layer with id "${l}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(v,0,r),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(r){this._checkLoaded();const l=this._checkLayer(r);if(!l)return;l.setEventedParent(null);const p=this._order.indexOf(r);this._order.splice(p,1),delete this._layers[r],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(l.fqid),this._changes.removeLayer(l);const _=this.getOwnLayerSourceCache(l);if(_&&_.castsShadows){let v=!1;for(const b in this._layers)if(this._layers[b].source===l.source&&this._layers[b].canCastShadows()){v=!0;break}_.castsShadows=v}l.onRemove&&l.onRemove(this.map),this.mergeLayers()}getOwnLayer(r){return this._layers[r]}hasLayer(r){return r in this._mergedLayers}hasLayerType(r){for(const l in this._layers)if(this._layers[l].type===r)return!0;return!1}setLayerZoomRange(r,l,p){this._checkLoaded();const _=this._checkLayer(r);_&&(_.minzoom===l&&_.maxzoom===p||(null!=l&&(_.minzoom=l),null!=p&&(_.maxzoom=p),this._updateLayer(_)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(r,l){this._checkLoaded();const p=this._checkLayer(r);p&&p.slot!==l&&(p.slot=l,this._updateLayer(p))}setFilter(r,l,p={}){this._checkLoaded();const _=this._checkLayer(r);if(_&&!u.bv(_.filter,l))return null==l?(_.filter=void 0,void this._updateLayer(_)):void(this._validate(Pe,`layers.${_.id}.filter`,l,{layerType:_.type},p)||(_.filter=u.di(l),this._updateLayer(_)))}getFilter(r){const l=this._checkLayer(r);if(l)return u.di(l.filter)}setLayoutProperty(r,l,p,_={}){this._checkLoaded();const v=this._checkLayer(r);if(v&&!u.bv(v.getLayoutProperty(l),p)){if(null!=p&&(!_||!1!==_.validate)&&Vl(v,X.call(Ps,{key:`layers.${r}.layout.${l}`,layerType:v.type,objectKey:l,value:p,styleSpec:u.a5,style:{glyphs:!0,sprite:!0}})))return;v.setLayoutProperty(l,p),0!==v.configDependencies.size&&this._configDependentLayers.add(v.fqid),this._updateLayer(v)}}getLayoutProperty(r,l){const p=this._checkLayer(r);if(p)return p.getLayoutProperty(l)}setPaintProperty(r,l,p,_={}){this._checkLoaded();const v=this._checkLayer(r);if(!v||u.bv(v.getPaintProperty(l),p)||null!=p&&(!_||!1!==_.validate)&&Vl(v,Z.call(Ps,{key:`layers.${r}.paint.${l}`,layerType:v.type,objectKey:l,value:p,styleSpec:u.a5})))return;const b=v.setPaintProperty(l,p);0!==v.configDependencies.size&&this._configDependentLayers.add(v.fqid),b&&this._updateLayer(v),this._changes.updatePaintProperties(v)}getPaintProperty(r,l){const p=this._checkLayer(r);if(p)return p.getPaintProperty(l)}setFeatureState(r,l){if(this._checkLoaded(),"target"in r){if("featuresetId"in r.target){const{featuresetId:I,importId:P}=r.target,R=this.getFragmentStyle(P),z=R.getFeaturesetLayers(I);for(const{source:L,sourceLayer:B}of z)R.setFeatureState({id:r.id,source:L,sourceLayer:B},l)}else if("layerId"in r.target){const{layerId:I}=r.target,P=this.getLayer(I);this.setFeatureState({id:r.id,source:P.source,sourceLayer:P.sourceLayer},l)}return}const p=r.source,_=r.sourceLayer,v=this._checkSource(p);if(!v)return;const b=v.type;if("geojson"===b&&_)return void this.fire(new u.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===b&&!_)return void this.fire(new u.z(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===r.id&&this.fire(new u.z(new Error("The feature id parameter must be provided.")));const S=this.getOwnSourceCaches(p);for(const I of S)I.setFeatureState(_,r.id,l)}removeFeatureState(r,l){if(this._checkLoaded(),"target"in r){if("featuresetId"in r.target){const{featuresetId:I,importId:P}=r.target,R=this.getFragmentStyle(P),z=R.getFeaturesetLayers(I);for(const{source:L,sourceLayer:B}of z)R.removeFeatureState({id:r.id,source:L,sourceLayer:B},l)}else if("layerId"in r.target){const{layerId:I}=r.target,P=this.getLayer(I);this.removeFeatureState({id:r.id,source:P.source,sourceLayer:P.sourceLayer},l)}return}const p=r.source,_=this._checkSource(p);if(!_)return;const v=_.type,b="vector"===v?r.sourceLayer:void 0;if("vector"===v&&!b)return void this.fire(new u.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(l&&"string"!=typeof r.id&&"number"!=typeof r.id)return void this.fire(new u.z(new Error("A feature id is required to remove its specific state property.")));const S=this.getOwnSourceCaches(p);for(const I of S)I.removeFeatureState(b,r.id,l)}getFeatureState(r){if(this._checkLoaded(),"target"in r){let v;if("featuresetId"in r.target){const{featuresetId:b,importId:S}=r.target,I=this.getFragmentStyle(S),P=I.getFeaturesetLayers(b);for(const{source:R,sourceLayer:z}of P){const L=I.getFeatureState({id:r.id,source:R,sourceLayer:z});if(L&&!v)v=L;else if(!u.bv(v,L))return void this.fire(new u.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in r.target){const{layerId:b}=r.target,S=this.getLayer(b);v=this.getFeatureState({id:r.id,source:S.source,sourceLayer:S.sourceLayer})}return v}const l=r.source,p=r.sourceLayer,_=this._checkSource(l);if(_){if("vector"!==_.type||p)return void 0===r.id&&this.fire(new u.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(l)[0].getFeatureState(p,r.id);this.fire(new u.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(r){return this.stylesheet.transition=u.h({},this.stylesheet.transition,r),this.transition=this.stylesheet.transition,this}getTransition(){return u.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();const r=this.getTerrain(),l=r&&this.terrain&&this.terrain.scope===this.scope?r:this.stylesheet.terrain;return u.dp({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:l,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},p=>void 0!==p)}_updateFilteredLayers(r){for(const l of Object.values(this._mergedLayers))r(l)&&this._updateLayer(l)}_updateLayer(r){this._changes.updateLayer(r);const l=this.getLayerSourceCache(r),p=u.C(r.source,r.scope),_=this._changes.getUpdatedSourceCaches();r.source&&!_[p]&&l&&"raster"!==l.getSource().type&&(this._changes.updateSourceCache(p,"reload"),l.pause()),r.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(r){const l=S=>this._mergedLayers[S].is3D(!!this.terrain),p=this.order,_={},v=[];for(let S=p.length-1;S>=0;S--){const I=p[S];if(l(I)){_[I]=S;for(const P of r){const R=P[I];if(R)for(const z of R)v.push(z)}}}v.sort((S,I)=>I.intersectionZ-S.intersectionZ);const b=[];for(let S=p.length-1;S>=0;S--){const I=p[S];if(l(I))for(let P=v.length-1;P>=0;P--){const R=v[P].feature;if(R.layer&&_[R.layer.id]<S)break;b.push(R),v.pop()}else for(const P of r){const R=P[I];if(R)for(const z of R)b.push(z.feature)}}return b}queryRenderedFeatures(r,l,p){let _;l&&!Array.isArray(l)&&l.filter&&(this._validate(Pe,"queryRenderedFeatures.filter",l.filter,null,l),_=u.b3(l.filter));const v={},b=R=>{if(mf.has(R.type))return;const z=this.getOwnLayerSourceCache(R),L=v[z.id]=v[z.id]||{sourceCache:z,layers:{},has3DLayers:!1};R.is3D(!!this.terrain)&&(L.has3DLayers=!0),L.layers[R.fqid]=L.layers[R.fqid]||{styleLayer:R,targets:[]},L.layers[R.fqid].targets.push({filter:_})};if(l&&l.layers){if(!Array.isArray(l.layers))return this.fire(new u.z(new Error("parameters.layers must be an Array."))),[];for(const R of l.layers){const z=this._layers[R];if(!z)return this.fire(new u.z(new Error(`The layer '${R}' does not exist in the map's style and cannot be queried for features.`))),[];b(z)}}else for(const R in this._layers)b(this._layers[R]);const S=this._queryRenderedFeatures(r,v,p),I=this._flattenAndSortRenderedFeatures(S),P=[];for(const R of I)u.dq(R.layer.id)===this.scope&&P.push(R);return P}queryRenderedFeatureset(r,l,p){let _;l&&!Array.isArray(l)&&l.filter&&(this._validate(Pe,"queryRenderedFeatures.filter",l.filter,null,l),_=u.b3(l.filter));const v="mock",b=[];if(l&&l.target)b.push(Object.assign({},l,{targetId:v,filter:_}));else{const R=this.getFeaturesetDescriptors();for(const z of R)b.push({targetId:v,filter:_,target:z});for(const{style:z}of this.fragments){const L=z.getFeaturesetDescriptors();for(const B of L)b.push({targetId:v,filter:_,target:B})}}const S=this.queryRenderedTargets(r,b,p),I=[],P=new Set;for(const R of S)for(const z of R.variants[v])lf(z,R,P)||I.push(new u.dr(R,z));return I}queryRenderedTargets(r,l,p){const _={},v=(S,I,P,R)=>{const z=_[I.id]=_[I.id]||{sourceCache:I,layers:{},has3DLayers:!1};if(z.layers[S.fqid]=z.layers[S.fqid]||{styleLayer:S,targets:[]},S.is3D(!!this.terrain)&&(z.has3DLayers=!0),!R)return P.uniqueFeatureID=!1,void z.layers[S.fqid].targets.push(P);z.layers[S.fqid].targets.push(Object.assign({},P,{namespace:R.namespace,properties:R.properties,uniqueFeatureID:R.uniqueFeatureID}))};for(const S of l)if("featuresetId"in S.target){const{featuresetId:I,importId:P}=S.target,R=this.getFragmentStyle(P);if(!R||!R._featuresetSelectors)continue;const z=R._featuresetSelectors[I];if(!z){this.fire(new u.z(new Error(`The featureset '${I}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const L of z){const B=R.getOwnLayer(L.layerId);B&&!mf.has(B.type)&&v(B,R.getOwnLayerSourceCache(B),S,L)}}else if("layerId"in S.target){const{layerId:I}=S.target,P=this.getLayer(I);if(!P||mf.has(P.type))continue;v(P,this.getLayerSourceCache(P),S)}const b=this._queryRenderedFeatures(r,_,p);return this._flattenAndSortRenderedFeatures(b)}_queryRenderedFeatures(r,l,p){const _=[],v=!!this.map._showQueryGeometry,b=Bn.createFromScreenPoints(r,p);for(const S in l){const I=Ol(b,l[S],this._availableImages,p,v);Object.keys(I).length&&_.push(I)}if(this.placement)for(const S in l){if(!l[S].sourceCache._onlySymbols)continue;const I=$a(b.screenGeometry,l[S],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(I).length&&_.push(I)}return _}querySourceFeatures(r,l){const p=l&&l.filter;p&&this._validate(Pe,"querySourceFeatures.filter",p,null,l);let _=[];const v=this.getOwnSourceCaches(r);for(const b of v)_=_.concat(Du(b,l));return _}addSourceType(r,l,p){return Ls.getSourceType(r)?p(new Error(`A source type called "${r}" already exists.`)):(Ls.setSourceType(r,l),l.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:r,url:l.workerSourceURL},p):p(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(r,l,p={}){this._checkLoaded();const _=this.light.getLight();let v=!1;for(const S in r)if(!u.bv(r[S],_[S])){v=!0;break}if(!v)return;const b=this._getTransitionParameters();this.light.setLight(r,l,p),this.light.updateTransitions(b)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=u.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&u.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(r,l=1){if(this._checkLoaded(),!r)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===l&&delete this.terrain,null===r?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let p=r;const _=null==r.source;if(1===l){if(this.disableElevatedTerrain)return;if("object"==typeof p.source){const S="terrain-dem-src";this.addSource(S,p.source),p=u.di(p),p=u.h(p,{source:S})}const v=u.h({},p),b={};if(this.terrain&&_){v.source=this.terrain.get().source;const S=this.terrain?this.getFragmentStyle(this.terrain.scope):null;S&&(b.style=S.serialize())}if(this._validate(Je,"terrain",v,b))return}if(!this.terrain||this.terrain.scope!==this.scope&&!_||this.terrain&&l!==this.terrain.drapeRenderMode){if(!p)return;this._createTerrain(p,l),this.fire(new u.A("data",{dataType:"style"}))}else{const v=this.terrain,b=v.get();for(const S of Object.keys(u.a5.terrain))!p.hasOwnProperty(S)&&u.a5.terrain[S].default&&(p[S]=u.a5.terrain[S].default);for(const S in r)if(!u.bv(r[S],b[S])){v.set(r,this.options),this.stylesheet.terrain=r;const I=this._getTransitionParameters({duration:0});v.updateTransitions(I),this.fire(new u.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(r){const l=this.fog=new pn(r,this.map.transform,this.scope,this.options);this.stylesheet.fog=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}_createSnow(r){const l=this.snow=new wr(r,this.map.transform,this.scope,this.options);this.stylesheet.snow=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}_createRain(r){const l=this.rain=new Pr(r,this.map.transform,this.scope,this.options);this.stylesheet.rain=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(const r of this.map._markers)r._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(r){if(this._checkLoaded(),!r)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const l=this.fog;if(!u.bv(l.get(),r)){l.set(r,this.options),this.stylesheet.fog=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}}else this._createFog(r);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(r){if(this._checkLoaded(),!r)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const l=this.snow;if(!u.bv(l.get(),r)){l.set(r,this.options),this.stylesheet.snow=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}}else this._createSnow(r);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(r){if(this._checkLoaded(),!r)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const l=this.rain;if(!u.bv(l.get(),r)){l.set(r,this.options),this.stylesheet.rain=l.get();const p=this._getTransitionParameters({duration:0});l.updateTransitions(p)}}else this._createRain(r);this._markersNeedUpdate=!0}_reloadColorTheme(){const r=()=>{for(const _ in this._layers)this._layers[_].lut=this._styleColorTheme.lut;for(const _ in this._sourceCaches)this._sourceCaches[_].clearTiles()},l=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!l)return this._styleColorTheme.lut=null,void r();const p=this._evaluateColorThemeData(l);this._loadColorTheme(p).then(()=>{this.fire(new u.A("colorthemeset")),r()}).catch(_=>{u.w(`Couldn't set color theme: ${_}`)})}setColorTheme(r){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&u.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=r,this._reloadColorTheme()}setImportColorTheme(r,l){const p=this.getFragmentStyle(r);p&&(p._styleColorTheme.colorThemeOverride=l,p._reloadColorTheme())}_getTransitionParameters(r){return{now:u.q.now(),transition:u.h(this.transition,r)}}updateDrapeFirstLayers(){if(!this.terrain)return;const r=[],l=[];for(const p of this._mergedOrder)this.isLayerDraped(this._mergedLayers[p])?r.push(p):l.push(p);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...r),this._drapedFirstOrder.push(...l)}_createTerrain(r,l){const p=this.terrain=new Te(r,l,this.scope,this.options,this.map.getWorldview());1===l&&(this.stylesheet.terrain=r),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const _=this._getTransitionParameters({duration:0});p.updateTransitions(_)}_force3DLayerUpdate(){for(const r in this._layers){const l=this._layers[r];"fill-extrusion"===l.type&&this._updateLayer(l)}}_forceSymbolLayerUpdate(){for(const r in this._layers){const l=this._layers[r];"symbol"===l.type&&this._updateLayer(l)}}_validate(r,l,p,_,v={}){if(v&&!1===v.validate)return!1;const b=u.h({},this.serialize());return Vl(this,r.call(Ps,u.h({key:l,style:b,value:p,styleSpec:u.a5},_)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),u.ds.off("pluginStateChange",this._rtlTextPluginCallback);for(const r in this._mergedLayers)this._mergedLayers[r].setEventedParent(null);for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].clearTiles(),this._mergedSourceCaches[r].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(r){const l=this.getSourceCaches(r);for(const p of l)p.clearTiles()}clearSources(){for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].clearTiles()}clearLayers(){for(const r in this._mergedLayers){const l=this._mergedLayers[r];l._clear&&l._clear()}}reloadSource(r){const l=this.getSourceCaches(r);for(const p of l)p.resume(),p.reload()}reloadSources(){for(const r of this.getSources())r.reload&&r.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(r=>{r.modelManager.reloadModels(r.scope)})}updateSources(r){let l;this.directionalLight&&(l=Nl(this.directionalLight));const p=new Set;for(const _ in this._mergedLayers){const v=this._mergedLayers[_];v.hasElevation()&&!p.has(v.source)&&p.add(v.source)}for(const _ in this._mergedSourceCaches){const v=this._mergedSourceCaches[_],b=p.has(v._source.id);v.update(r,void 0,void 0,l,b)}}_generateCollisionBoxes(){for(const r in this._sourceCaches){const l=this._sourceCaches[r];l.resume(),l.reload()}}_updatePlacement(r,l,p,_,v,b,S=!1){let I=!1,P=!1;const R={},z={};for(const L of this._mergedOrder){const B=this._mergedLayers[L];if("symbol"!==B.type)continue;const H=u.C(B.source,B.scope);let U=R[H];if(!U){const G=this.getLayerSourceCache(B);if(!G)continue;const Y=G.getRenderableIds(!0).map(ee=>G.getTileByID(ee));z[H]=Y.slice(),U=R[H]=Y.sort((ee,ne)=>ne.tileID.overscaledZ-ee.tileID.overscaledZ||(ee.tileID.isLessThan(ne.tileID)?-1:1))}const q=this.crossTileSymbolIndex.addLayer(B,U,l.center.lng,l.projection);I=I||q}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),S=S||this._layerOrderChanged||0===_,this._layerOrderChanged&&this.fire(new u.A("neworder")),(S||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(u.q.now(),l.zoom))&&(this.pauseablePlacement=new Fp(l,this._mergedOrder,S,p,_,v,this.placement,this.fog&&l.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,R,z,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(u.q.now()),P=!0),I&&this.pauseablePlacement.placement.setStale()),P||I){this._buildingIndex.onNewFrame(l.zoom);for(let L=0;L<this._mergedOrder.length;L++){const B=this._mergedLayers[this._mergedOrder[L]];if("symbol"!==B.type)continue;const H=this.isLayerClipped(B);this.placement.updateLayerOpacities(B,R[u.C(B.source,B.scope)],L,H?b:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(u.q.now())}}_releaseSymbolFadeTiles(){for(const r in this._sourceCaches)this._sourceCaches[r].releaseSymbolFadeTiles()}addImport(r,l){this._checkLoaded();const p=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==p.findIndex(({id:v})=>v===r.id))return void this.fire(new u.z(new Error(`Import with id '${r.id}' already exists in the map's style.`)));if(!l)return p.push(r),this._loadImports([r],!0);const _=p.findIndex(({id:v})=>v===l);return-1===_&&this.fire(new u.z(new Error(`Import with id "${l}" does not exist on this map.`))),this.stylesheet.imports=p.slice(0,_).concat(r).concat(p.slice(_)),this._loadImports([r],!0,l)}updateImport(r,l){this._checkLoaded();const p=this.stylesheet.imports||[],_=this.getImportIndex(r);return-1===_?this:"string"==typeof l?(this.setImportUrl(r,l),this):(l.url&&l.url!==p[_].url&&this.setImportUrl(r,l.url),u.bv(l.config,p[_].config)||this.setImportConfig(r,l.config,l.data.schema),u.bv(l.data,p[_].data)||this.setImportData(r,l.data),this)}moveImport(r,l){this._checkLoaded();let p=this.stylesheet.imports||[];const _=this.getImportIndex(r);if(-1===_)return this;const v=this.getImportIndex(l);if(-1===v)return this;const b=p[_],S=this.fragments[_];return p=p.filter(({id:I})=>I!==r),this.fragments=this.fragments.filter(({id:I})=>I!==r),this.stylesheet.imports=p.slice(0,v).concat(b).concat(p.slice(v)),this.fragments=this.fragments.slice(0,v).concat(S).concat(this.fragments.slice(v)),this.mergeLayers(),this}setImportUrl(r,l){this._checkLoaded();const p=this.stylesheet.imports||[],_=this.getImportIndex(r);if(-1===_)return this;p[_].url=l;const v=this.fragments[_];return v.style=this._createFragmentStyle(p[_]),v.style.on("style.import.load",()=>this.mergeAll()),v.style.loadURL(l),this}setImportData(r,l){this._checkLoaded();const p=this.getImportIndex(r),_=this.stylesheet.imports||[];return-1===p?this:l?(this.fragments[p].style.setState(l),this._reloadImports(),this):(delete _[p].data,this.setImportUrl(r,_[p].url))}setImportConfig(r,l,p){this._checkLoaded();const _=this.getImportIndex(r),v=this.stylesheet.imports||[];if(-1===_)return this;l?v[_].config=l:delete v[_].config;const b=this.fragments[_];p&&b.style.stylesheet&&(b.style.stylesheet.schema=p);const S=b.style.stylesheet&&b.style.stylesheet.schema;return b.config=l,b.style.updateConfig(l,S),this.updateConfigDependencies(),this}removeImport(r){this._checkLoaded();const l=this.stylesheet.imports||[],p=this.getImportIndex(r);-1!==p&&(l.splice(p,1),this.fragments[p].style._remove(),this.fragments.splice(p,1),this._reloadImports())}getImportIndex(r){const l=(this.stylesheet.imports||[]).findIndex(p=>p.id===r);return-1===l&&this.fire(new u.z(new Error(`Import '${r}' does not exist in the map's style and cannot be updated.`))),l}getLayer(r){return this._mergedLayers[r]}getSources(){const r=[];for(const l in this._mergedOtherSourceCaches){const p=this._mergedOtherSourceCaches[l];p&&r.push(p.getSource())}return r}getSource(r,l){const p=this.getSourceCache(r,l);return p&&p.getSource()}getLayerSource(r){const l=this.getLayerSourceCache(r);return l&&l.getSource()}getSourceCache(r,l){const p=u.C(r,l);return this._mergedOtherSourceCaches[p]}getLayerSourceCache(r){const l=u.C(r.source,r.scope);return"symbol"===r.type?this._mergedSymbolSourceCaches[l]:this._mergedOtherSourceCaches[l]}getSourceCaches(r){if(null==r)return Object.values(this._mergedSourceCaches);const l=[];return this._mergedOtherSourceCaches[r]&&l.push(this._mergedOtherSourceCaches[r]),this._mergedSymbolSourceCaches[r]&&l.push(this._mergedSymbolSourceCaches[r]),l}updateSourceCaches(){const r=this._changes.getUpdatedSourceCaches();for(const l in r){const p=r[l];"reload"===p?this.reloadSource(l):"clear"===p&&this.clearSource(l)}}updateLayers(r){const l=this._changes.getUpdatedPaintProperties();for(const p of l){const _=this.getLayer(p);_&&_.updateTransitions(r)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(r){this.stylesheet.glyphs=r,this.glyphManager.setURL(r)}getImages(r,l,p){this.imageManager.getImages(l.images,l.scope,p),this._updateTilesForChangedImages();const _=b=>{if(b){const S=l.images.map(I=>u.I.toString(I));b.setDependencies(l.tileID.key,l.type,S)}},v=u.C(l.source,l.scope);_(this._mergedOtherSourceCaches[v]),_(this._mergedSymbolSourceCaches[v]),l.images.some(b=>b.iconsetId)&&this.fire(new u.A("data",{dataType:"style"}))}rasterizeImages(r,l,p){this.imageManager.rasterizeImages(l,p)}getGlyphs(r,l,p){this.glyphManager.getGlyphs(l.stacks,p)}getResource(r,l,p){return u.dt(l,p)}getOwnSourceCache(r){return this._otherSourceCaches[r]}getOwnLayerSourceCache(r){return"symbol"===r.type?this._symbolSourceCaches[r.source]:this._otherSourceCaches[r.source]}getOwnSourceCaches(r){const l=[];return this._otherSourceCaches[r]&&l.push(this._otherSourceCaches[r]),this._symbolSourceCaches[r]&&l.push(this._symbolSourceCaches[r]),l}_isSourceCacheLoaded(r){const l=this.getOwnSourceCaches(r);return 0===l.length?(this.fire(new u.z(new Error(`There is no source with ID '${r}'`))),!1):l.every(p=>p.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(r,l){if(!this._clipLayerPresent&&"fill-extrusion"!==r.type&&"building"!==r.type)return!1;const p="fill-extrusion"===r.type&&("building"===r.sourceLayer||"procedural_buildings"===r.sourceLayer),_="building"===r.type;if(r.is3D(!!this.terrain)){if(p||_||l&&"batched-model"===l.type||"model"===r.type)return!0}else if("symbol"===r.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(r=>{r.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Ls.getSourceType=function(f){return af[f]},Ls.setSourceType=function(f,r){af[f]=r},Ls.registerForPluginStateChange=u.du;var Hp="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",Fu="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",zu="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",Gp="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",$d="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",ks="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",gf="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",ht="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",jl="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",_f="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",yf="#ifdef RENDER_SHADOWS\nprecision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {\n#ifdef CLIP_ZERO_TO_ONE\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);\n#else\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);\n#endif\nreturn texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;\n#ifdef SHADOWS_SINGLE_CASCADE\nvec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);\n#else\nlight_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const qd=[];Qn(Hp,qd),Qn(zu,qd),Qn(Fu,qd);const Ir={"_prelude_fog.vertex.glsl":ks,"_prelude_terrain.vertex.glsl":$d,"_prelude_shadow.vertex.glsl":_f,"_prelude_fog.fragment.glsl":gf,"_prelude_shadow.fragment.glsl":yf,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":ht,"_prelude_raster_particle.glsl":jl},$s={};tn("",$d),tn(gf,ks),tn(yf,_f),tn(ht,""),tn(jl,"");const Wd=tn(Fu,zu),Kr=Hp;var _o={background:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),building:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nconst float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nin lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;\n#endif\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\nuniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}\n#ifdef BUILDING_FAUX_FACADE\nfloat hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;\n#if 0\nif (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;\n#else\nif (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;\n#endif\nreturn out_color;}\n#endif\nvec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;\n#ifdef BUILDING_FAUX_FACADE\nif (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}\n#endif\nvec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;\n#ifdef RENDER_SHADOWS\nshadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nshadowed_lighting_factor=dot(normal,u_lighting_directional_dir);\n#endif\ncolor.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,base_color.rgb,emissive);\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));\n#endif\ncolor.rgb=linearTosRGB(color.rgb);color*=u_opacity;\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_pos.z);\n#endif\nglFragColor=color; \n#ifdef DEBUG_SHOW_NORMALS\ncolor.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nout lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nconst float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#ifdef BUILDING_FAUX_FACADE\nmat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}\n#endif\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive\nvoid main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive\nvec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;\n#ifdef BUILDING_FAUX_FACADE\nv_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}\n#endif\nv_pos=a_pos_3f;\n#ifdef RENDER_CUTOFF\nvec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=v_pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(v_pos);\n#endif\ngl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}'),buildingBloom:tn("in vec4 v_color_emissive;\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\nfloat saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;\n#ifdef HAS_ATTRIBUTE_a_bloom_attenuation\nfloat distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);\n#endif\nglFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}","in vec3 a_pos_3f;\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\nout vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\n#ifdef HAS_ATTRIBUTE_a_part_color_emissive\nvec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);\n#else\nv_color_emissive=vec4(1.0);\n#endif\ngl_Position=u_matrix*vec4(a_pos_3f,1.0);}"),buildingDepth:tn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:tn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:tn('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:tn("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:tn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;\n#endif\nout float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);\n#ifdef PROJECTION_GLOBE_VIEW\n#ifndef PROJECTED_POS_ON_VIEWPORT\nvec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);\n#endif\n#endif\nvec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:tn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:tn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:tn("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:tn("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)\n{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nvec3 color=structure_color.xyz;\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,transformed_normal);\n#endif\ncolor=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nv_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef FLIP_Y\nv_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FLIP_Y\nv_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);\n#ifdef CLIP_ZERO_TO_ONE\ncutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);\n#else\ncutoff=cutoff_opacity(u_cutoff_params,ground.z);\n#endif\nif (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:tn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:tn('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:tn("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:tn("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;\n#ifdef LINE_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LINE_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:tn("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:tn("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:tn('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:tn('#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nin highp float v_z_offset;\n#endif\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef TERRAIN\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#else\nout_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef ELEVATED_ROADS\nin vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nout highp float v_z_offset;\n#endif\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;\n#else\nz+=u_pitch_with_map ? z_offset : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\n#ifdef ELEVATED_ROADS\nvec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\npos=vec3(projected_pos.xy/projected_pos.w+offset,z);\n#endif\n#endif\ngl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#else\n#ifdef RENDER_SHADOWS\nv_z_offset=e;\n#endif\n#endif\n}'),terrainRaster:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:tn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:tn('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Gp),skyboxGradient:tn('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Gp),skyboxCapture:tn("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:tn('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;\n#ifdef FLIP_Y\nT=-T;B=-B;\n#endif\nhighp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));\n#ifdef FLIP_Y\nn=normalize(cross(fdx,fdy));\n#else\nn=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\n#ifdef FEATURE_CUTOUT\nfinalColor=apply_feature_cutout(finalColor,gl_FragCoord);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:tn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:tn("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:tn("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:tn("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:tn("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:tn("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Qn(f,r){const l=f.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let p of l)if(p=p.trim(),"#"===p[0]&&p.includes("if")&&!p.includes("endif")){p=p.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const _=p.split(" ");for(const v of _)r.includes(v)||r.push(v)}}function tn(f,r){const l=/#include\s+"([^"]+)"/g,p=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let _=r.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);_&&(_=_.map(P=>{const R=P.split(" ");return R[R.length-1]}),_=[...new Set(_)]);const v={},b=[],S=[];if(f=f.replace(l,(P,R)=>(S.push(R),"")),(r=r.replace(l,(P,R)=>(b.push(R),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let I=[...qd];Qn(f,I),Qn(r,I);for(const P of[...b,...S])Ir[P]||console.error(`Undefined include: ${P}`),$s[P]||($s[P]=[],Qn(Ir[P],$s[P])),I=[...I,...$s[P]];return{fragmentSource:f=f.replace(p,(P,R,z,L,B)=>(v[B]=!0,"define"===R?`\n#ifndef HAS_UNIFORM_u_${B}\nin ${z} ${L} ${B};\n#else\nuniform ${z} ${L} u_${B};\n#endif\n`:"initialize"===R?`\n#ifdef HAS_UNIFORM_u_${B}\n    ${z} ${L} ${B} = u_${B};\n#endif\n`:"define-attribute"===R?`\n#ifdef HAS_ATTRIBUTE_a_${B}\n    in ${z} ${L} ${B};\n#endif\n`:"initialize-attribute"===R?"":void 0)),vertexSource:r=r.replace(p,(P,R,z,L,B)=>{const H="float"===L?"vec2":L,U=B.match(/color/)?"color":H;return"define-attribute-vertex-shader-only"===R?`\n#ifdef HAS_ATTRIBUTE_a_${B}\nin ${z} ${L} a_${B};\n#endif\n`:v[B]?"define"===R?`\n#ifndef HAS_UNIFORM_u_${B}\nuniform lowp float u_${B}_t;\nin ${z} ${H} a_${B};\nout ${z} ${L} ${B};\n#else\nuniform ${z} ${L} u_${B};\n#endif\n`:"initialize"===R?"vec4"===U?`\n#ifndef HAS_UNIFORM_u_${B}\n    ${B} = a_${B};\n#else\n    ${z} ${L} ${B} = u_${B};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${B}\n    ${B} = unpack_mix_${U}(a_${B}, u_${B}_t);\n#else\n    ${z} ${L} ${B} = u_${B};\n#endif\n`:"define-attribute"===R?`\n#ifdef HAS_ATTRIBUTE_a_${B}\n    in ${z} ${L} a_${B};\n    out ${z} ${L} ${B};\n#endif\n`:"initialize-attribute"===R?`\n#ifdef HAS_ATTRIBUTE_a_${B}\n    ${B} = a_${B};\n#endif\n`:void 0:"define"===R?`\n#ifndef HAS_UNIFORM_u_${B}\nuniform lowp float u_${B}_t;\nin ${z} ${H} a_${B};\n#else\nuniform ${z} ${L} u_${B};\n#endif\n`:"define-instanced"===R?"mat4"===U?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${B}0;\nin vec4 a_${B}1;\nin vec4 a_${B}2;\nin vec4 a_${B}3;\n#else\nuniform ${z} ${L} u_${B};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${z} ${H} a_${B};\n#else\nuniform ${z} ${L} u_${B};\n#endif\n`:"initialize-attribute-custom"===R?`\n#ifdef HAS_ATTRIBUTE_a_${B}\n    ${z} ${L} ${B} = a_${B};\n#endif\n`:"vec4"===U?`\n#ifndef HAS_UNIFORM_u_${B}\n    ${z} ${L} ${B} = a_${B};\n#else\n    ${z} ${L} ${B} = u_${B};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${B}\n    ${z} ${L} ${B} = unpack_mix_${U}(a_${B}, u_${B}_t);\n#else\n    ${z} ${L} ${B} = u_${B};\n#endif\n`}),staticAttributes:_,usedDefines:I,vertexIncludes:b,fragmentIncludes:S}}class Jo{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(r,l,p,_,v,b,S,I){this.context=r;let P=this.boundPaintVertexBuffers.length!==_.length;for(let z=0;!P&&z<_.length;z++)this.boundPaintVertexBuffers[z]!==_[z]&&(P=!0);let R=this.boundDynamicVertexBuffers.length!==S.length;for(let z=0;!R&&z<S.length;z++)this.boundDynamicVertexBuffers[z]!==S[z]&&(R=!0);if(!this.vao||this.boundProgram!==l||this.boundLayoutVertexBuffer!==p||P||R||this.boundIndexBuffer!==v||this.boundVertexOffset!==b)this.freshBind(l,p,_,v,b,S,I);else{r.bindVertexArrayOES.set(this.vao);for(const z of S)z&&(z.bind(),I&&z.instanceCount&&z.setVertexAttribDivisor(r.gl,l,I));v&&v.dynamicDraw&&v.bind()}}freshBind(r,l,p,_,v,b,S){const I=r.numAttributes,P=this.context,R=P.gl;this.vao&&this.destroy(),this.vao=P.gl.createVertexArray(),P.bindVertexArrayOES.set(this.vao),this.boundProgram=r,this.boundLayoutVertexBuffer=l,this.boundPaintVertexBuffers=p,this.boundIndexBuffer=_,this.boundVertexOffset=v,this.boundDynamicVertexBuffers=b,l.enableAttributes(R,r),l.bind(),l.setVertexAttribPointers(R,r,v);for(const z of p)z.enableAttributes(R,r),z.bind(),z.setVertexAttribPointers(R,r,v);for(const z of b)z&&(z.enableAttributes(R,r),z.bind(),z.setVertexAttribPointers(R,r,v),S&&z.instanceCount&&z.setVertexAttribDivisor(R,r,S));_&&_.bind(),P.currentNumAttributes=I}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Pc(f,r){const l=Math.pow(2,r.canonical.z),p=r.canonical.y;return[new u.ac(0,p/l).toLngLat().lat,new u.ac(0,(p+1)/l).toLngLat().lat]}function Fs(f,r,l,p,_,v,b){const S=f.context,I=S.gl,P=l.hillshadeFBO;if(!P)return;f.prepareDrawTile();const R=f.isTileAffectedByFog(r),z=f.getOrCreateProgram("hillshade",{overrideFog:R});S.activeTexture.set(I.TEXTURE0),I.bindTexture(I.TEXTURE_2D,P.colorAttachment.get());const L=((q,G,Y,ee)=>{const ne=Y.paint.get("hillshade-shadow-color"),le="none"===Y.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),de=Y.paint.get("hillshade-highlight-color"),pe="none"===Y.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),ae=Y.paint.get("hillshade-accent-color"),ce="none"===Y.paint.get("hillshade-accent-color-use-theme").constantOr("default"),ue=Y.paint.get("hillshade-emissive-strength");let Me=u.al(Y.paint.get("hillshade-illumination-direction"));if("viewport"===Y.paint.get("hillshade-illumination-anchor"))Me-=q.transform.angle;else if(q.style&&q.style.enable3dLights()&&q.style.directionalLight){const je=q.style.directionalLight.properties.get("direction"),Le=u.d1(je.x,je.y,je.z);Me=u.al(Le[1])}const ye=!q.options.moving;return{u_matrix:ee||q.transform.calculateProjMatrix(G.tileID.toUnwrapped(),ye),u_image:0,u_latrange:Pc(0,G.tileID),u_light:[Y.paint.get("hillshade-exaggeration"),Me],u_shadow:ne.toPremultipliedRenderColor(le?null:Y.lut),u_highlight:de.toPremultipliedRenderColor(pe?null:Y.lut),u_emissive_strength:ue,u_accent:ae.toPremultipliedRenderColor(ce?null:Y.lut)}})(f,l,p,f.terrain?r.projMatrix:null);f.uploadCommonUniforms(S,z,r.toUnwrapped());const{tileBoundsBuffer:B,tileBoundsIndexBuffer:H,tileBoundsSegments:U}=f.getTileBoundsBuffers(l);z.draw(f,I.TRIANGLES,_,v,b,Nt.disabled,L,p.id,B,H,U)}function vf(f,r,l){if(!r.needsDEMTextureUpload)return;const p=f.context,_=p.gl;p.pixelStoreUnpackPremultiplyAlpha.set(!1),r.demTexture=r.demTexture||f.getTileTexture(l.stride);const v=l.getPixels();r.demTexture?r.demTexture.update(v,{premultiply:!1}):r.demTexture=new u.T(p,v,_.R32F,{premultiply:!1}),r.needsDEMTextureUpload=!1}function $p(f,r,l){const p=f.context,_=p.gl;if(!r.dem)return;const v=r.dem;if(p.activeTexture.set(_.TEXTURE1),vf(f,r,v),!r.demTexture)return;r.demTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE);const b=v.dim;p.activeTexture.set(_.TEXTURE0);let S=r.hillshadeFBO;if(!S){const L=new u.T(p,{width:b,height:b,data:null},_.RGBA8);L.bind(_.LINEAR,_.CLAMP_TO_EDGE),S=r.hillshadeFBO=p.createFramebuffer(b,b,!0,"renderbuffer"),S.colorAttachment.set(L.texture)}p.bindFramebuffer.set(S.framebuffer),p.viewport.set([0,0,b,b]);const{tileBoundsBuffer:I,tileBoundsIndexBuffer:P,tileBoundsSegments:R}=f.getMercatorTileBoundsBuffers(),z=[];f.linearFloatFilteringSupported()&&z.push("TERRAIN_DEM_FLOAT_FORMAT"),f.getOrCreateProgram("hillshadePrepare",{defines:z}).draw(f,_.TRIANGLES,bt.disabled,Bt.disabled,an.unblended,Nt.disabled,((L,B)=>{const H=B.stride,U=u.bz();return u.ca(U,0,u.aj,-u.aj,0,0,1),u.bo(U,U,[0,-u.aj,0]),{u_matrix:U,u_image:1,u_dimension:[H,H],u_zoom:L.overscaledZ}})(r.tileID,v),l.id,I,P,R),r.needsHillshadePrepare=!1}class Ii{constructor(r){this.gl=r.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(r){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class sv extends Ii{getDefault(){return u.am.transparent.toNonPremultipliedRenderColor(null)}set(r){const l=this.current;(r.r!==l.r||r.g!==l.g||r.b!==l.b||r.a!==l.a||this.dirty)&&(this.gl.clearColor(r.r,r.g,r.b,r.a),this.current=r,this.dirty=!1)}}class av extends Ii{getDefault(){return 1}set(r){(r!==this.current||this.dirty)&&(this.gl.clearDepth(r),this.current=r,this.dirty=!1)}}class Lr extends Ii{getDefault(){return 0}set(r){(r!==this.current||this.dirty)&&(this.gl.clearStencil(r),this.current=r,this.dirty=!1)}}class Yt extends Ii{getDefault(){return[!0,!0,!0,!0]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||r[2]!==l[2]||r[3]!==l[3]||this.dirty)&&(this.gl.colorMask(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class Jn extends Ii{getDefault(){return!0}set(r){(r!==this.current||this.dirty)&&(this.gl.depthMask(r),this.current=r,this.dirty=!1)}}class Cr extends Ii{getDefault(){return 255}set(r){(r!==this.current||this.dirty)&&(this.gl.stencilMask(r),this.current=r,this.dirty=!1)}}class _s extends Ii{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(r){const l=this.current;(r.func!==l.func||r.ref!==l.ref||r.mask!==l.mask||this.dirty)&&(this.gl.stencilFunc(r.func,r.ref,r.mask),this.current=r,this.dirty=!1)}}class Zd extends Ii{getDefault(){const r=this.gl;return[r.KEEP,r.KEEP,r.KEEP]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||r[2]!==l[2]||this.dirty)&&(this.gl.stencilOp(r[0],r[1],r[2]),this.current=r,this.dirty=!1)}}class Io extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;r?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),this.current=r,this.dirty=!1}}class Ul extends Ii{getDefault(){return[0,1]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||this.dirty)&&(this.gl.depthRange(r[0],r[1]),this.current=r,this.dirty=!1)}}class Ar extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;r?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),this.current=r,this.dirty=!1}}class Ca extends Ii{getDefault(){return this.gl.LESS}set(r){(r!==this.current||this.dirty)&&(this.gl.depthFunc(r),this.current=r,this.dirty=!1)}}class qs extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;r?l.enable(l.BLEND):l.disable(l.BLEND),this.current=r,this.dirty=!1}}class On extends Ii{getDefault(){const r=this.gl;return[r.ONE,r.ZERO,r.ONE,r.ZERO]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||r[2]!==l[2]||r[3]!==l[3]||this.dirty)&&(this.gl.blendFuncSeparate(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class Hl extends Ii{getDefault(){return u.am.transparent.toNonPremultipliedRenderColor(null)}set(r){const l=this.current;(r.r!==l.r||r.g!==l.g||r.b!==l.b||r.a!==l.a||this.dirty)&&(this.gl.blendColor(r.r,r.g,r.b,r.a),this.current=r,this.dirty=!1)}}class Xd extends Ii{getDefault(){return this.gl.FUNC_ADD}set(r){(r!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(r,r),this.current=r,this.dirty=!1)}}class ca extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;r?l.enable(l.CULL_FACE):l.disable(l.CULL_FACE),this.current=r,this.dirty=!1}}class kr extends Ii{getDefault(){return this.gl.BACK}set(r){(r!==this.current||this.dirty)&&(this.gl.cullFace(r),this.current=r,this.dirty=!1)}}class Rc extends Ii{getDefault(){return this.gl.CCW}set(r){(r!==this.current||this.dirty)&&(this.gl.frontFace(r),this.current=r,this.dirty=!1)}}let Oc=class extends Ii{getDefault(){return null}set(f){(f!==this.current||this.dirty)&&(this.gl.useProgram(f),this.current=f,this.dirty=!1)}};class es extends Ii{getDefault(){return this.gl.TEXTURE0}set(r){(r!==this.current||this.dirty)&&(this.gl.activeTexture(r),this.current=r,this.dirty=!1)}}class Gl extends Ii{getDefault(){const r=this.gl;return[0,0,r.drawingBufferWidth,r.drawingBufferHeight]}set(r){const l=this.current;(r[0]!==l[0]||r[1]!==l[1]||r[2]!==l[2]||r[3]!==l[3]||this.dirty)&&(this.gl.viewport(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class Yd extends Ii{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.bindFramebuffer(l.FRAMEBUFFER,r),this.current=r,this.dirty=!1}}class Aa extends Ii{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.bindRenderbuffer(l.RENDERBUFFER,r),this.current=r,this.dirty=!1}}class Ws extends Ii{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.bindTexture(l.TEXTURE_2D,r),this.current=r,this.dirty=!1}}class Za extends Ii{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.bindBuffer(l.ARRAY_BUFFER,r),this.current=r,this.dirty=!1}}class Nu extends Ii{getDefault(){return null}set(r){const l=this.gl;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,r),this.current=r,this.dirty=!1}}class vi extends Ii{getDefault(){return null}set(r){this.gl&&(r!==this.current||this.dirty)&&(this.gl.bindVertexArray(r),this.current=r,this.dirty=!1)}}class lv extends Ii{getDefault(){return 4}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_ALIGNMENT,r),this.current=r,this.dirty=!1}}class $l extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r),this.current=r,this.dirty=!1}}class qp extends Ii{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,r),this.current=r,this.dirty=!1}}class Zs extends Ii{constructor(r,l){super(r),this.context=r,this.parent=l}getDefault(){return null}}class xf extends Zs{setDirty(){this.dirty=!0}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,r,0),this.current=r,this.dirty=!1}}class Lc extends Zs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,this.attachment(),l.RENDERBUFFER,r),this.current=r,this.dirty=!1}}class kc extends Zs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferTexture2D(l.FRAMEBUFFER,this.attachment(),l.TEXTURE_2D,r,0),this.current=r,this.dirty=!1}}class io extends Lc{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Ug=(f,r,l)=>({u_matrix:f,u_image0:0,u_skirt_height:r,u_ground_shadow_factor:l}),Co=(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U)=>({u_proj_matrix:Float32Array.from(f),u_globe_matrix:r,u_normalize_matrix:Float32Array.from(p),u_merc_matrix:l,u_zoom_transition:_,u_merc_center:v,u_image0:0,u_frustum_tl:b,u_frustum_tr:S,u_frustum_br:I,u_frustum_bl:P,u_globe_pos:R,u_globe_radius:z,u_viewport:L,u_grid_matrix:U?Float32Array.from(U):new Float32Array(9),u_skirt_height:B,u_far_z_cutoff:H});function Ao(f,r){return null!=f&&null!=r&&!(!f.hasData()||!r.hasData())&&null!=f.demTexture&&null!=r.demTexture&&f.tileID.key!==r.tileID.key}const Xa=new class{constructor(){this.operations={}}newMorphing(f,r,l,p,_){if(f in this.operations){const v=this.operations[f];v.to.tileID.key!==l.tileID.key&&(v.queued=l)}else this.operations[f]={startTime:p,phase:0,duration:_,from:r,to:l,queued:null}}getMorphValuesForProxy(f){if(!(f in this.operations))return null;const r=this.operations[f];return{from:r.from,to:r.to,phase:r.phase}}update(f){for(const r in this.operations){const l=this.operations[r];for(l.phase=(f-l.startTime)/l.duration;l.phase>=1||!this._validOp(l);)if(!this._nextOp(l,f)){delete this.operations[r];break}}}_nextOp(f,r){return!!f.queued&&(f.from=f.to,f.to=f.queued,f.queued=null,f.phase=0,f.startTime=r,!0)}_validOp(f){return f.from.hasData()&&f.to.hasData()}},ql={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Ya(f,r,l){if(0===r)return 0;const p=r<1&&514===l?.25/r:1;return 6*Math.pow(1.5,22-f)*Math.max(r,1)*p}function ts(f,r){const l=1<<f.z;return!r&&(0===f.x||f.x===l-1)||0===f.y||f.y===l-1}const Bu=f=>({u_matrix:f});function ns(f,r,l,p,_){if(_>0){const v=u.q.now(),b=(v-f.timeAdded)/_,S=r?(v-r.timeAdded)/_:-1,I=l.getSource(),P=p.coveringZoomLevel({tileSize:I.tileSize,roundZoom:I.roundZoom}),R=!r||Math.abs(r.tileID.overscaledZ-P)>Math.abs(f.tileID.overscaledZ-P),z=R&&f.refreshedUponExpiration?1:u.ay(R?b:1-S,0,1);return f.refreshedUponExpiration&&b>=1&&(f.refreshedUponExpiration=!1),r?{opacity:1,mix:1-z}:{opacity:z,mix:0}}return{opacity:1,mix:0}}class Wp extends Do{constructor(r){const l=Su("mock-dem",{type:"raster-dem",maxzoom:r.transform.maxZoom},r.style.dispatcher,r.style);super("mock-dem",l,!1),l.setEventedParent(this),this._sourceLoaded=!0}_loadTile(r,l){r.state="loaded",l(null)}}class Zp extends Do{constructor(r){const l=Su("proxy",{type:"geojson",maxzoom:r.transform.maxZoom},r.style.dispatcher,r.style);super("proxy",l,!1),l.setEventedParent(this),this.map=this.getSource().map=r,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(r,l,p){if(r.freezeTileCoverage)return;this.transform=r;const _=r.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((v,b)=>{if(v[b.key]="",!this._tiles[b.key]){const S=new yc(b,this._source.tileSize*b.overscaleFactor(),r.tileZoom,void 0,void 0,this._source.worldview);S.state="loaded",this._tiles[b.key]=S}return v},{});for(const v in this._tiles)v in _||(this.freeFBO(v),this._tiles[v].unloadVectorData(),delete this._tiles[v])}freeFBO(r){const l=this.proxyCachedFBO[r];if(void 0!==l){const p=Object.values(l);this.renderCachePool.push(...p),delete this.proxyCachedFBO[r]}}deallocRenderCache(){this.renderCache.forEach(r=>r.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Kd extends u.aM{constructor(r,l,p){super(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y),this.proxyTileKey=l,this.projMatrix=p}}class bf extends u.dF{constructor(r,l){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},r.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),r.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),r.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=r,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[p,_,v]=function(I){const P=new u.ba,R=new u.a_,z=131;P.reserve(17161),R.reserve(33800);const L=u.aj/128,B=u.aj+L/2,H=B+L;for(let q=-L;q<H;q+=L)for(let G=-L;G<H;G+=L){const Y=G<0||G>B||q<0||q>B?24575:0,ee=u.ay(Math.round(G),0,u.aj),ne=u.ay(Math.round(q),0,u.aj);P.emplaceBack(ee+Y,ne)}const U=(q,G)=>{const Y=G*z+q;R.emplaceBack(Y+1,Y,Y+z),R.emplaceBack(Y+z,Y+z+1,Y+1)};for(let q=1;q<129;q++)for(let G=1;G<129;G++)U(G,q);return[0,129].forEach(q=>{for(let G=0;G<130;G++)U(G,q),U(q,G)}),[P,R,32768]}(),b=r.context;this.gridBuffer=b.createVertexBuffer(p,u.bc.members),this.gridIndexBuffer=b.createIndexBuffer(_),this.gridSegments=u.bd.simpleSegment(0,0,p.length,_.length),this.gridNoSkirtSegments=u.bd.simpleSegment(0,0,p.length,v),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Zp(l.map),this.orthoMatrix=u.bz(),u.ca(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,u.aj,0,u.aj,0,1);const S=b.gl;this._overlapStencilMode=new Bt({func:S.GEQUAL,mask:255},0,255,S.KEEP,S.KEEP,S.REPLACE),this._previousZoom=r.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=l,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Wp(l.map),this._pendingGroundEffectLayers=[]}set style(r){r.on("data",this._onStyleDataEvent.bind(this)),this._style=r,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(r,l,p){if(r&&r.terrain){this._style!==r&&(this.style=r,this._evaluationZoom=void 0);const _=r.terrain.properties,v=0===r.terrain.drapeRenderMode,b=r.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=u.q.now();const S=r.terrain&&r.terrain.scope,I=_.get("source"),P=v?this._mockSourceCache:r.getSourceCache(I,S);if(!P)return void u.w(`Couldn't find terrain source "${I}".`);if(this.sourceCache=P,this._attenuationRange=r.terrain.getAttenuationRange(),this._exaggeration=b?this.calculateExaggeration(l):_.get("exaggeration"),!l.projection.requiresDraping&&b&&0===this._exaggeration)return void this._disable();this.enabled=!0;const R=()=>{this.sourceCache.used&&u.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const z=this.getScaledDemTileSize();this.sourceCache.update(l,z,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,R(),this._initializing=!0),R(),l.updateElevation(!0,p),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(l),this._emptyDEMTextureDirty=!0,this._previousZoom=l.zoom}else this._disable()}calculateExaggeration(r){if(this._attenuationRange&&r.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(r.zoom);const l=this._previousCameraAltitude,p=r.getFreeCameraOptions().position.z/r.pixelsPerMeter*r.worldSize;this._previousCameraAltitude=p;const _=null!=l?p-l:Number.MAX_VALUE;if(Math.abs(_)<2)return this._exaggeration;const v=r.zoom,b=this._style.terrain;if(!this._previousUpdateTimestamp)return b.getExaggeration(v);let S=v-this._previousZoom;const I=this._previousUpdateTimestamp;let P=v;null!=this._evaluationZoom&&(P=this._evaluationZoom,Math.abs(v-P)>.5&&(S=.5*(v-P+S)),S*_<0&&(P+=S)),this._evaluationZoom=P;const R=b.getExaggeration(P),z=R===b.getExaggeration(Math.max(0,P-.1));if(z&&Math.abs(R-this._exaggeration)<.01)return R;let L=Math.min(.1,.00375*(this._updateTimestamp-I));return(z||R<.1||Math.abs(S)<1e-4)&&(L=Math.min(.2,4*L)),u.ai(this._exaggeration,R,L)}resetTileLookupCache(r){this._findCoveringTileCache[r]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(r){r.coord&&"source"===r.dataType?this._clearRenderCacheForTile(r.sourceCacheId,r.coord):"style"===r.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const r in this._style._mergedSourceCaches)this._style._mergedSourceCaches[r].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(r=>r.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const r=2*this.proxySourceCache.getSource().tileSize;return[r,r]}set useVertexMorphing(r){this._useVertexMorphing=r}updateTileBinding(r){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const l=this.proxySourceCache,p=this.painter.transform;this._initializing&&(this._initializing=0===p._centerAltitude&&-1===this.getAtPointOrZero(u.ac.fromLngLat(p.center),-1),this._emptyDEMTextureDirty=!this._initializing);const _=this.proxyCoords=l.getIds().map(I=>{const P=l.getTileByID(I).tileID;return P.projMatrix=p.calculateProjMatrix(P.toUnwrapped()),P});!function(I,P){const R=P.transform.pointCoordinate(P.transform.getCameraPoint()),z=new u.P(R.x,R.y);I.sort((L,B)=>{if(B.overscaledZ-L.overscaledZ)return B.overscaledZ-L.overscaledZ;const H=new u.P(L.canonical.x+(1<<L.canonical.z)*L.wrap,L.canonical.y),U=new u.P(B.canonical.x+(1<<B.canonical.z)*B.wrap,B.canonical.y),q=z.mult(1<<L.canonical.z);return q.x-=.5,q.y-=.5,q.distSqr(H)-q.distSqr(U)})}(_,this.painter);const v=this.proxyToSource||{};this.proxyToSource={},_.forEach(I=>{this.proxyToSource[I.key]={}}),this.terrainTileForTile={};const b=this._style._mergedSourceCaches;for(const I in b){const P=b[I];if(!P.used||(P!==this.sourceCache&&this.resetTileLookupCache(P.id),this._setupProxiedCoordsForOrtho(P,r[I],v),P.usedForTerrain))continue;const R=r[I];P.getSource().reparseOverscaled&&this._assignTerrainTiles(R)}this.proxiedCoords[l.id]=_.map(I=>new Kd(I,I.key,this.orthoMatrix)),this._assignTerrainTiles(_),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(v),this.renderingToTexture=!1;const S={};this._visibleDemTiles=[];for(const I of this.proxyCoords){const P=this.terrainTileForTile[I.key];if(!P)continue;const R=P.tileID.key;R in S||(this._visibleDemTiles.push(P),S[R]=R)}}_assignTerrainTiles(r){this._initializing||r.forEach(l=>{if(this.terrainTileForTile[l.key])return;const p=this._findTileCoveringTileID(l,this.sourceCache);p&&(this.terrainTileForTile[l.key]=p)})}_prepareDEMTextures(){const r=this.painter.context,l=r.gl;for(const p in this.terrainTileForTile){const _=this.terrainTileForTile[p],v=_.dem;!v||_.demTexture&&!_.needsDEMTextureUpload||(r.activeTexture.set(l.TEXTURE1),vf(this.painter,_,v))}}_prepareDemTileUniforms(r,l,p,_){if(!l||null==l.demTexture)return!1;const v=r.tileID.canonical,b=Math.pow(2,l.tileID.canonical.z-v.z),S=_||"";return p[`u_dem_tl${S}`]=[v.x*b%1,v.y*b%1],p[`u_dem_scale${S}`]=b,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let r=0;const l=this._visibleDemTiles.reduce((p,_)=>{if(!_.dem)return p;const v=_.dem.tree.minimums[0];return v>0&&r++,p+v},0);return r?l/r:0}_updateEmptyDEMTexture(){const r=this.painter.context,l=r.gl;r.activeTexture.set(l.TEXTURE2);const p=this._getLoadedAreaMinimum(),_=new u.dG({width:1,height:1},new Float32Array([p]));this._emptyDEMTextureDirty=!1;let v=this._emptyDEMTexture;return v?v.update(_,{premultiply:!1}):v=this._emptyDEMTexture=new u.T(r,_,l.R32F,{premultiply:!1}),v}setupElevationDraw(r,l,p){const _=this.painter.context,v=_.gl,b={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};b.u_exaggeration=this.exaggeration();let S=null,I=null,P=1;if(p&&p.morphing&&this._useVertexMorphing){const B=p.morphing.srcDemTile,H=p.morphing.dstDemTile;P=p.morphing.phase,B&&H&&(this._prepareDemTileUniforms(r,B,b,"_prev")&&(I=B),this._prepareDemTileUniforms(r,H,b)&&(S=H))}const R=B=>B&&B.demTexture&&this.painter.linearFloatFilteringSupported()?v.LINEAR:v.NEAREST;let z=null;var L;if(this.enabled?I&&S?(z=S.demTexture,_.activeTexture.set(v.TEXTURE4),I.demTexture.bind(R(I),v.CLAMP_TO_EDGE),b.u_dem_lerp=P):(S=this.terrainTileForTile[r.tileID.key],z=this._prepareDemTileUniforms(r,S,b)?S.demTexture:this.emptyDEMTexture):z=this.emptyDEMTexture,_.activeTexture.set(v.TEXTURE2),z&&(b.u_dem_size=1===(L=z).size[0]?1:L.size[0]-2,z.bind(R(S),v.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(p&&p.useDepthForOcclusion,l,b),p&&p.useMeterToDem&&S){const B=(1<<S.tileID.canonical.z)*u.cb(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;b.u_meter_to_dem=B}if(p&&p.labelPlaneMatrixInv&&(b.u_label_plane_matrix_inv=p.labelPlaneMatrixInv),l.setTerrainUniformValues(_,b),"globe"===this.painter.transform.projection.name){const B=this.globeUniformValues(this.painter.transform,r.tileID.canonical,p&&p.useDenormalizedUpVectorScale);l.setGlobeUniformValues(_,B)}}globeUniformValues(r,l,p){const _=r.projection;return{u_tile_tl_up:_.upVector(l,0,0),u_tile_tr_up:_.upVector(l,u.aj,0),u_tile_br_up:_.upVector(l,u.aj,u.aj),u_tile_bl_up:_.upVector(l,0,u.aj),u_tile_up_scale:p?u.dH(1):_.upVectorScale(l,r.center.lat,r.worldSize).metersToTile}}renderToBackBuffer(r){const l=this.painter,p=this.painter.context;0!==r.length&&(p.bindFramebuffer.set(null),p.viewport.set([0,0,l.width,l.height]),l.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(_,v,b,S,I){if("globe"===_.transform.projection.name)!function(P,R,z,L,B){const H=P.context,U=H.gl;let q,G;const Y=P.transform,ee=u.dy(P,H,Y),ne=(je,Le)=>{if(G===Le)return;const Ge=[ql[Le],"PROJECTION_GLOBE_VIEW"];ee&&Ge.push("CUSTOM_ANTIALIASING");const rt=P.isTileAffectedByFog(je);q=P.getOrCreateProgram("globeRaster",{defines:Ge,overrideFog:rt}),G=Le},le=P.colorModeForRenderPass(),de=new bt(U.LEQUAL,bt.ReadWrite,P.depthRangeFor3D);Xa.update(B);const pe=u.dz(Y),ae=[u.aD(Y.center.lng),u.aH(Y.center.lat)],ce=P.globeSharedBuffers,ue=[Y.width*u.q.devicePixelRatio,Y.height*u.q.devicePixelRatio],Me=Float32Array.from(Y.globeMatrix),ye={useDenormalizedUpVectorScale:!0};{const je=P.transform,Le=Ya(je.zoom,R.exaggeration(),R.sourceCache._source.tileSize);G=-1;const Ge=U.TRIANGLES;for(const rt of L){const Se=z.getTile(rt),_e=Bt.disabled,ze=R.prevTerrainTileForTile[rt.key],Re=R.terrainTileForTile[rt.key];Ao(ze,Re)&&Xa.newMorphing(rt.key,ze,Re,B,250),H.activeTexture.set(U.TEXTURE0),Se.texture&&Se.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);const We=Xa.getMorphValuesForProxy(rt.key),Ze=We?1:0;We&&u.L(ye,{morphing:{srcDemTile:We.from,dstDemTile:We.to,phase:u.dx(We.phase)}});const Ye=u.dA(rt.canonical),ct=u.dB(Ye.getCenter().lat),Ct=u.dC(rt.canonical,Ye,ct,je.worldSize/je._pixelsPerMercatorPixel),Lt=u.bh(u.dD(rt.canonical)),vt=Co(je.expandedFarZProjMatrix,Me,pe,Lt,u.ah(je.zoom),ae,je.frustumCorners.TL,je.frustumCorners.TR,je.frustumCorners.BR,je.frustumCorners.BL,je.globeCenterInViewSpace,je.globeRadius,ue,Le,je._farZ,Ct);if(ne(rt,Ze),q&&(R.setupElevationDraw(Se,q,ye),P.uploadCommonUniforms(H,q,rt.toUnwrapped()),ce)){const[Rt,At,qt]=ce.getGridBuffers(ct,0!==Le);q.draw(P,Ge,de,_e,le,Nt.backCCW,vt,"globe_raster",Rt,At,qt)}}}if(ce&&(P.renderDefaultNorthPole||P.renderDefaultSouthPole)){const je=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];ee&&je.push("CUSTOM_ANTIALIASING"),q=P.getOrCreateProgram("globeRaster",{defines:je});for(const Le of L){const{x:Ge,y:rt,z:Se}=Le.canonical,_e=0===rt,ze=rt===(1<<Se)-1,[Re,We,Ze,Ye]=ce.getPoleBuffers(Se,!1);if(Ye&&(_e||ze)){const ct=z.getTile(Le);H.activeTexture.set(U.TEXTURE0),ct.texture&&ct.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);let Ct=u.dE(Se,Ge,Y);const Lt=u.bh(u.dD(Le.canonical)),vt=(Rt,At)=>Rt.draw(P,U.TRIANGLES,de,Bt.disabled,le,Nt.disabled,Co(Y.expandedFarZProjMatrix,Ct,Ct,Lt,0,ae,Y.frustumCorners.TL,Y.frustumCorners.TR,Y.frustumCorners.BR,Y.frustumCorners.BL,Y.globeCenterInViewSpace,Y.globeRadius,ue,0,Y._farZ),"globe_pole_raster",At,Ze,Ye);R.setupElevationDraw(ct,q,ye),P.uploadCommonUniforms(H,q,Le.toUnwrapped()),_e&&P.renderDefaultNorthPole&&vt(q,Re),ze&&P.renderDefaultSouthPole&&(Ct=u.cP(u.bz(),Ct,[1,-1,1]),vt(q,We))}}}}(_,v,b,S,I);else{const P=_.context,R=P.gl;let z,L;const B=_.shadowRenderer,H=mo(_,_.longestCutoffRange),U=le=>{if(L===le)return;const de=[];de.push(ql[le]),H.shouldRenderCutoff&&de.push("RENDER_CUTOFF"),B&&(de.push("RENDER_SHADOWS","DEPTH_TEXTURE"),B.useNormalOffset&&de.push("NORMAL_OFFSET")),z=_.getOrCreateProgram("terrainRaster",{defines:de}),L=le},q=_.colorModeForRenderPass(),G=new bt(R.LEQUAL,bt.ReadWrite,_.depthRangeFor3D);Xa.update(I);const Y=_.transform,ee=Ya(Y.zoom,v.exaggeration(),v.sourceCache._source.tileSize);let ne=[0,0,0];if(B){const le=_.style.directionalLight,de=_.style.ambientLight;le&&de&&(ne=qa(_.style,le,de))}{L=-1;const le=R.TRIANGLES,[de,pe]=[v.gridIndexBuffer,v.gridSegments];for(const ae of S){const ce=b.getTile(ae),ue=Bt.disabled,Me=v.prevTerrainTileForTile[ae.key],ye=v.terrainTileForTile[ae.key];Ao(Me,ye)&&Xa.newMorphing(ae.key,Me,ye,I,250),P.activeTexture.set(R.TEXTURE0),ce.texture&&ce.texture.bind(R.LINEAR,R.CLAMP_TO_EDGE);const je=Xa.getMorphValuesForProxy(ae.key),Le=je?1:0;let Ge;je&&(Ge={morphing:{srcDemTile:je.from,dstDemTile:je.to,phase:u.dx(je.phase)}});const rt=Ug(ae.projMatrix,ts(ae.canonical,Y.renderWorldCopies)?ee/10:ee,ne);if(U(Le),!z)continue;v.setupElevationDraw(ce,z,Ge);const Se=ae.toUnwrapped();B&&B.setupShadows(Se,z),_.uploadCommonUniforms(P,z,Se,null,H),z.draw(_,le,G,ue,q,Nt.backCCW,rt,"terrain_raster",v.gridBuffer,de,pe)}}}}(l,this,this.proxySourceCache,r,this._updateTimestamp),this.renderingToTexture=!0,l.gpuTimingDeferredRenderEnd(),r.splice(0,r.length))}renderBatch(r){if(0===this._drapedRenderBatches.length)return r+1;this.renderingToTexture=!0;const l=this.painter,p=this.painter.context,_=this.proxySourceCache,v=this.proxiedCoords[_.id],b=this._drapedRenderBatches.shift(),S=l.style.order,I=[];let P=0;for(const R of v){const z=_.getTileByID(R.proxyTileKey),L=_.proxyCachedFBO[R.key]?_.proxyCachedFBO[R.key][r]:void 0,B=void 0!==L?_.renderCache[L]:this.pool[P++],H=void 0!==L;if(z.texture=B.tex,H&&!B.dirty){I.push(z.tileID);continue}let U;p.bindFramebuffer.set(B.fb.framebuffer),this.renderedToTile=!1,B.dirty&&(p.clear({color:u.am.transparent,stencil:0}),B.dirty=!1);for(let q=b.start;q<=b.end;++q){const G=l.style._mergedLayers[S[q]];if(G.isHidden(l.transform.zoom))continue;const Y=l.style.getLayerSourceCache(G),ee=Y?this.proxyToSource[R.key][Y.id]:[R];if(!ee)continue;const ne=ee;p.viewport.set([0,0,B.fb.width,B.fb.height]),U!==(Y?Y.id:null)&&(this._setupStencil(B,ee,G,Y),U=Y?Y.id:null),l.renderLayer(l,Y,G,ne)}if(0===this._drapedRenderBatches.length)for(const q of this._pendingGroundEffectLayers){const G=l.style._mergedLayers[S[q]];if(G.isHidden(l.transform.zoom))continue;const Y=l.style.getLayerSourceCache(G),ee=Y?this.proxyToSource[R.key][Y.id]:[R];if(!ee)continue;const ne=ee;p.viewport.set([0,0,B.fb.width,B.fb.height]),U!==(Y?Y.id:null)&&(this._setupStencil(B,ee,G,Y),U=Y?Y.id:null),l.renderLayer(l,Y,G,ne)}this.renderedToTile?(B.dirty=!0,I.push(z.tileID)):H||--P,5===P&&(P=0,this.renderToBackBuffer(I))}return this.renderToBackBuffer(I),this.renderingToTexture=!1,p.bindFramebuffer.set(null),p.viewport.set([0,0,l.width,l.height]),b.end+1}postRender(){}isLayerOrderingCorrect(r){const l=r.order.length;let p=-1,_=l;for(let v=0;v<l;++v)this._style.isLayerDraped(r._mergedLayers[r.order[v]])?p=Math.max(p,v):_=Math.min(_,v);return _>p}getMinElevationBelowMSL(){let r=0;return this._visibleDemTiles.filter(l=>l.dem).forEach(l=>{r=Math.min(r,l.dem.tree.minimums[0])}),0===r?r:(r-30)*this._exaggeration}raycast(r,l,p){if(!this._visibleDemTiles)return null;const _=this._visibleDemTiles.filter(v=>v.dem).map(v=>{const b=v.tileID,S=1<<b.overscaledZ,{x:I,y:P}=b.canonical,R=I/S,z=(I+1)/S,L=P/S,B=(P+1)/S;return{minx:R,miny:L,maxx:z,maxy:B,t:v.dem.tree.raycastRoot(R,L,z,B,r,l,p),tile:v}});_.sort((v,b)=>(null!==v.t?v.t:Number.MAX_VALUE)-(null!==b.t?b.t:Number.MAX_VALUE));for(const v of _){if(null==v.t)return null;const b=v.tile.dem.tree.raycast(v.minx,v.miny,v.maxx,v.maxy,r,l,p);if(null!=b)return b}return null}_createFBO(){const r=this.painter.context,l=r.gl,p=this.drapeBufferSize;r.activeTexture.set(l.TEXTURE0);const _=new u.T(r,{width:p[0],height:p[1],data:null},l.RGBA8);_.bind(l.LINEAR,l.CLAMP_TO_EDGE);const v=r.createFramebuffer(p[0],p[1],!0,null);return v.colorAttachment.set(_.texture),v.depthAttachment=new io(r,v.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=r.createRenderbuffer(r.gl.DEPTH_STENCIL,p[0],p[1]),this._stencilRef=0,v.depthAttachment.set(this._sharedDepthStencil),r.clear({stencil:0})):v.depthAttachment.set(this._sharedDepthStencil),r.extTextureFilterAnisotropic&&l.texParameterf(l.TEXTURE_2D,r.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,r.extTextureFilterAnisotropicMax),{fb:v,tex:_,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const r in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[r].hasTransition())return!0;return this._style.order.some(r=>{const l=this._style._mergedLayers[r],p=l.isHidden(this.painter.transform.zoom);return"hillshade"===l.type||"custom"===l.type?!p&&l.shouldRedrape():!p&&l.hasTransition()})}_clearLineLayersFromRenderCache(){let r=!1;for(const p of this._style.getSources())if(p instanceof Od){r=!0;break}if(!r)return;const l={};for(let p=0;p<this._style.order.length;++p){const _=this._style._mergedLayers[this._style.order[p]],v=this._style.getLayerSourceCache(_);if(v&&!l[v.id]&&!_.isHidden(this.painter.transform.zoom)&&"line"===_.type&&_.widthExpression()instanceof u.ab){l[v.id]=!0;for(const b of this.proxyCoords){const S=this.proxyToSource[b.key][v.id];if(S)for(const I of S)this._clearRenderCacheForTile(v.id,I)}}}}_clearRasterLayersFromRenderCache(){let r=!1;for(const p in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[p]._source instanceof no){r=!0;break}if(!r)return;const l={};for(let p=0;p<this._style.order.length;++p){const _=this._style._mergedLayers[this._style.order[p]],v=this._style.getLayerSourceCache(_);if(!v||l[v.id]||_.isHidden(this.painter.transform.zoom)||"raster"!==_.type)continue;const b=_.paint.get("raster-fade-duration");for(const S of this.proxyCoords){const I=this.proxyToSource[S.key][v.id];if(I)for(const P of I){const R=ns(v.getTile(P),v.findLoadedParent(P,0),v,this.painter.transform,b);(1!==R.opacity||0!==R.mix)&&this._clearRenderCacheForTile(v.id,P)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const r=this._style.order,l=r.length;if(0===l)return;const p=[];this._pendingGroundEffectLayers=[];let _,v=0,b=this._style._mergedLayers[r[v]];for(;!this._style.isLayerDraped(b)&&b.isHidden(this.painter.transform.zoom)&&++v<l;)b=this._style._mergedLayers[r[v]];for(;v<l;++v){const S=this._style._mergedLayers[r[v]];S.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(S)?void 0===_&&(_=v):("fill-extrusion"===S.type&&this._pendingGroundEffectLayers.push(v),void 0!==_&&(p.push({start:_,end:v-1}),_=void 0)))}if(void 0!==_&&p.push({start:_,end:v-1}),0!==p.length){const S=p[p.length-1];this._pendingGroundEffectLayers.every(I=>I>S.end)||u.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=p}_setupRenderCache(r){const l=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,l.renderCache.length>l.renderCachePool.length){const b=Object.values(l.proxyCachedFBO);l.proxyCachedFBO={};for(let S=0;S<b.length;++S){const I=Object.values(b[S]);l.renderCachePool.push(...I)}}return}this._clearRasterLayersFromRenderCache();const p=this.proxyCoords,_=this._tilesDirty;for(let b=p.length-1;b>=0;b--){const S=p[b];if(l.getTileByID(S.key),void 0!==l.proxyCachedFBO[S.key]){const I=r[S.key],P=this.proxyToSource[S.key];let R=0;for(const z in P){const L=P[z],B=I[z];if(!B||B.length!==L.length||L.some((H,U)=>H!==B[U]||_[z]&&_[z].hasOwnProperty(H.key))){R=-1;break}++R}for(const z in l.proxyCachedFBO[S.key])l.renderCache[l.proxyCachedFBO[S.key][z]].dirty=R<0||R!==Object.values(I).length}}const v=[...this._drapedRenderBatches];v.sort((b,S)=>S.end-S.start-(b.end-b.start));for(const b of v)for(const S of p){if(l.proxyCachedFBO[S.key])continue;let I=l.renderCachePool.pop();void 0===I&&l.renderCache.length<50&&(I=l.renderCache.length,l.renderCache.push(this._createFBO())),void 0!==I&&(l.proxyCachedFBO[S.key]={},l.proxyCachedFBO[S.key][b.start]=I,l.renderCache[I].dirty=!0)}this._tilesDirty={}}_setupStencil(r,l,p,_){if(!_||!this._sourceTilesOverlap[_.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const v=this.painter.context,b=v.gl;if(l.length<=1)return void(this._overlapStencilType=!1);let S;if(p.isTileClipped())S=l.length,this._overlapStencilMode.test={func:b.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(l[0].overscaledZ>l[l.length-1].overscaledZ))return void(this._overlapStencilType=!1);S=1,this._overlapStencilMode.test={func:b.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+S>255&&(v.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=S,this._overlapStencilMode.ref=this._stencilRef,p.isTileClipped()&&this._renderTileClippingMasks(l,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(r){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[r.key]),this._overlapStencilMode):Bt.disabled}_renderTileClippingMasks(r,l){const p=this.painter,_=this.painter.context,v=_.gl;p._tileClippingMaskIDs={},_.setColorMode(an.disabled),_.setDepthMode(bt.disabled);const b=p.getOrCreateProgram("clippingMask");for(const S of r){const I=p._tileClippingMaskIDs[S.key]=--l;b.draw(p,v.TRIANGLES,bt.disabled,new Bt({func:v.ALWAYS,mask:0},I,255,v.KEEP,v.KEEP,v.REPLACE),an.disabled,Nt.disabled,Bu(S.projMatrix),"$clipping",p.tileExtentBuffer,p.quadTriangleIndexBuffer,p.tileExtentSegments)}}pointCoordinate(r){const l=this.painter.transform;if(r.x<0||r.x>l.width||r.y<0||r.y>l.height)return null;const p=[r.x,r.y,1,1];u.aA(p,p,l.pixelMatrixInverse),u.cH(p,p,1/p[3]),p[0]/=l.worldSize,p[1]/=l.worldSize;const _=l._camera.position,v=u.cb(1,l.center.lat),b=[_[0],_[1],_[2]/v,0],S=u.d7([],p.slice(0,3),b);u.au(S,S);const I=this.raycast(b,S,this._exaggeration);return null!==I&&I?(u.bE(b,b,S,I),b[3]=b[2],b[2]*=v,b):null}_setupProxiedCoordsForOrtho(r,l,p){if(r.getSource()instanceof u.aP)return this._setupProxiedCoordsForImageSource(r,l,p);this._findCoveringTileCache[r.id]=this._findCoveringTileCache[r.id]||{};const _=this.proxiedCoords[r.id]=[],v=this.proxyCoords;for(let I=0;I<v.length;I++){const P=v[I],R=this._findTileCoveringTileID(P,r);if(R){const z=this._createProxiedId(P,R,p[P.key]&&p[P.key][r.id]);_.push(z),this.proxyToSource[P.key][r.id]=[z]}}let b=!1;const S=new Set;for(let I=0;I<l.length;I++){const P=r.getTile(l[I]);if(!P||!P.hasData())continue;const R=this._findTileCoveringTileID(P.tileID,this.proxySourceCache);if(R&&R.tileID.canonical.z!==P.tileID.canonical.z){const z=this.proxyToSource[R.tileID.key][r.id],L=this._createProxiedId(R.tileID,P,p[R.tileID.key]&&p[R.tileID.key][r.id]);z?z.splice(z.length-1,0,L):this.proxyToSource[R.tileID.key][r.id]=[L];const B=this.proxyToSource[R.tileID.key][r.id];S.has(B)||S.add(B),_.push(L),b=!0}}if(this._sourceTilesOverlap[r.id]=b,b&&this._debugParams.sortTilesHiZFirst)for(const I of S)I.sort((P,R)=>R.overscaledZ-P.overscaledZ)}_setupProxiedCoordsForImageSource(r,l,p){if(!r.getSource().loaded())return;const _=this.proxiedCoords[r.id]=[],v=this.proxyCoords,b=r.getSource(),S=b.tileID;if(!S)return;const I=new u.P(S.x,S.y)._div(1<<S.z),P=b.coordinates.map(u.ac.fromLngLat).reduce((z,L)=>(z.min.x=Math.min(z.min.x,L.x-I.x),z.min.y=Math.min(z.min.y,L.y-I.y),z.max.x=Math.max(z.max.x,L.x-I.x),z.max.y=Math.max(z.max.y,L.y-I.y),z),{min:new u.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new u.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),R=(z,L)=>{const B=z.wrap+z.canonical.x/(1<<z.canonical.z),H=z.canonical.y/(1<<z.canonical.z),U=u.aj/(1<<z.canonical.z),q=L.wrap+L.canonical.x/(1<<L.canonical.z),G=L.canonical.y/(1<<L.canonical.z);return B+U<q+P.min.x||B>q+P.max.x||H+U<G+P.min.y||H>G+P.max.y};for(let z=0;z<v.length;z++){const L=v[z];for(let B=0;B<l.length;B++){const H=r.getTile(l[B]);if(!H||!H.hasData()||R(L,H.tileID))continue;const U=this._createProxiedId(L,H,p[L.key]&&p[L.key][r.id]),q=this.proxyToSource[L.key][r.id];q?q.push(U):this.proxyToSource[L.key][r.id]=[U],_.push(U)}}}_createProxiedId(r,l,p){let _=this.orthoMatrix;if(p){const v=p.find(b=>b.key===l.tileID.key);if(v)return v}if(l.tileID.key!==r.key){const v=r.canonical.z-l.tileID.canonical.z;let b,S,I;_=u.bz();const P=l.tileID.wrap-r.wrap<<r.overscaledZ;v>0?(b=u.aj>>v,S=b*((l.tileID.canonical.x<<v)-r.canonical.x+P),I=b*((l.tileID.canonical.y<<v)-r.canonical.y)):(b=u.aj<<-v,S=u.aj*(l.tileID.canonical.x-(r.canonical.x+P<<-v)),I=u.aj*(l.tileID.canonical.y-(r.canonical.y<<-v))),u.ca(_,0,b,0,b,0,1),u.bo(_,_,[S,I,0])}return new Kd(l.tileID,r.key,_)}_findTileCoveringTileID(r,l){let p=l.getTile(r);if(p&&p.hasData())return p;const _=this._findCoveringTileCache[l.id],v=_[r.key];if(p=v?l.getTileByID(v):null,p&&p.hasData()||null===v)return p;let b=p?p.tileID:r,S=b.overscaledZ;const I=l.getSource().minzoom,P=[];if(!v){const z=l.getSource().maxzoom;if(r.canonical.z>=z){const L=r.canonical.z-z;l.getSource().reparseOverscaled?(S=Math.max(r.canonical.z+2,l.transform.tileZoom),b=new u.aM(S,r.wrap,z,r.canonical.x>>L,r.canonical.y>>L)):0!==L&&(S=z,b=new u.aM(S,r.wrap,z,r.canonical.x>>L,r.canonical.y>>L))}b.key!==r.key&&(P.push(b.key),p=l.getTile(b))}const R=z=>{P.forEach(L=>{_[L]=z}),P.length=0};for(S-=1;S>=I&&(!p||!p.hasData());S--){p&&R(p.tileID.key);const z=b.calculateScaledKey(S);if(p=l.getTileByID(z),p&&p.hasData())break;const L=_[z];if(null===L)break;void 0===L?P.push(z):p=l.getTileByID(L)}return R(p?p.tileID.key:null),p&&p.hasData()?p:null}findDEMTileFor(r){return this.enabled?this._findTileCoveringTileID(r,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(r,l){let p=this._tilesDirty[r];p||(p=this._tilesDirty[r]={}),p[l.key]=!0}}function Hg(f,r,l){const p=function(S,I,P){const R=u.bG(I,S),z=u.bG(P,[.2126,.7152,.0722]),L=(H,U,q)=>(1-q)*H+q*U,B=L(1-.3*Math.min(z,1),1,Math.min(R+1,1));return L(.92,1,Math.asin(u.ay(I[2],-1,1))/Math.PI+.5)*B}(f,[0,0,1],r),_=[0,0,0];u.c1(_,l.slice(0,3),p);const v=[0,0,0];u.c1(v,r.slice(0,3),f[2]);const b=[0,0,0];return u.d5(b,_,v),u.d8(b)}const Gg=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Xp=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Yp{static cacheKey(r,l,p,_){let v=`${l}${_?_.cacheKey:""}`;for(const b of p)r.usedDefines.includes(b)&&(v+=`/${b}`);return v}constructor(r,l,p,_,v,b){const S=r.gl;this.program=S.createProgram(),this.configuration=_,this.name=l,this.fixedDefines=[...b];const I=_?_.getBinderAttributes():[],P=(p.staticAttributes||[]).concat(I);let R=_?_.defines():[];R=R.concat(b.map(q=>`#define ${q}`));const z="#version 300 es\n";let L=z+R.concat("precision mediump float;",Kr,Wd.fragmentSource).join("\n");for(const q of p.fragmentIncludes)L+=`\n${Ir[q]}`;L+=`\n${p.fragmentSource}`;let B=z+R.concat("precision highp float;",Kr,Wd.vertexSource).join("\n");for(const q of p.vertexIncludes)B+=`\n${Ir[q]}`;this.forceManualRenderingForInstanceIDShaders=r.forceManualRenderingForInstanceIDShaders&&-1!==p.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(B+="\nuniform int u_instanceID;\n"),B+=`\n${p.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(B=B.replaceAll("gl_InstanceID","u_instanceID"));const H=S.createShader(S.FRAGMENT_SHADER);if(S.isContextLost())return void(this.failedToCreate=!0);S.shaderSource(H,L),S.compileShader(H),S.attachShader(this.program,H);const U=S.createShader(S.VERTEX_SHADER);if(S.isContextLost())this.failedToCreate=!0;else{S.shaderSource(U,B),S.compileShader(U),S.attachShader(this.program,U),this.attributes={},this.numAttributes=P.length;for(let q=0;q<this.numAttributes;q++)if(P[q]){const G=P[q].startsWith("a_")?P[q]:`a_${P[q]}`;S.bindAttribLocation(this.program,q,G),this.attributes[G]=q}S.linkProgram(this.program),S.deleteShader(U),S.deleteShader(H),this.fixedUniforms=v(r),this.binderUniforms=_?_.getUniforms(r):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms={u_instanceID:new u.cd(r)}),(b.includes("TERRAIN")||-1!==l.indexOf("symbol")||-1!==l.indexOf("circle"))&&(this.terrainUniforms={u_dem:new u.cd(q=r),u_dem_prev:new u.cd(q),u_dem_tl:new u.cg(q),u_dem_scale:new u.cf(q),u_dem_tl_prev:new u.cg(q),u_dem_scale_prev:new u.cf(q),u_dem_size:new u.cf(q),u_dem_lerp:new u.cf(q),u_exaggeration:new u.cf(q),u_depth:new u.cd(q),u_depth_size_inv:new u.cg(q),u_depth_range_unpack:new u.cg(q),u_occluder_half_size:new u.cf(q),u_occlusion_depth_offset:new u.cf(q),u_meter_to_dem:new u.cf(q),u_label_plane_matrix_inv:new u.ch(q)}),b.includes("GLOBE")&&(this.globeUniforms=(q=>({u_tile_tl_up:new u.ce(q),u_tile_tr_up:new u.ce(q),u_tile_br_up:new u.ce(q),u_tile_bl_up:new u.ce(q),u_tile_up_scale:new u.cf(q)}))(r)),b.includes("FOG")&&(this.fogUniforms=(q=>({u_fog_matrix:new u.ch(q),u_fog_range:new u.cg(q),u_fog_color:new u.d0(q),u_fog_horizon_blend:new u.cf(q),u_fog_vertical_limit:new u.cg(q),u_fog_temporal_offset:new u.cf(q),u_frustum_tl:new u.ce(q),u_frustum_tr:new u.ce(q),u_frustum_br:new u.ce(q),u_frustum_bl:new u.ce(q),u_globe_pos:new u.ce(q),u_globe_radius:new u.cf(q),u_globe_transition:new u.cf(q),u_is_globe:new u.cd(q),u_viewport:new u.cg(q)}))(r)),b.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(q=>({u_cutoff_params:new u.d0(q)}))(r)),b.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(q=>({u_lighting_ambient_color:new u.ce(q),u_lighting_directional_dir:new u.ce(q),u_lighting_directional_color:new u.ce(q),u_ground_radiance:new u.ce(q)}))(r)),b.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(q=>({u_light_matrix_0:new u.ch(q),u_light_matrix_1:new u.ch(q),u_fade_range:new u.cg(q),u_shadow_normal_offset:new u.ce(q),u_shadow_intensity:new u.cf(q),u_shadow_texel_size:new u.cf(q),u_shadow_map_resolution:new u.cf(q),u_shadow_direction:new u.ce(q),u_shadow_bias:new u.ce(q),u_shadowmap_0:new u.cd(q),u_shadowmap_1:new u.cd(q)}))(r))}var q}setTerrainUniformValues(r,l){if(!this.terrainUniforms)return;const p=this.terrainUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const _ in l)p[_]&&p[_].set(this.program,_,l[_])}}setGlobeUniformValues(r,l){if(!this.globeUniforms)return;const p=this.globeUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const _ in l)p[_]&&p[_].set(this.program,_,l[_])}}setFogUniformValues(r,l){if(!this.fogUniforms)return;const p=this.fogUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const _ in l)p[_].set(this.program,_,l[_])}}setCutoffUniformValues(r,l){if(!this.cutoffUniforms)return;const p=this.cutoffUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const _ in l)p[_].set(this.program,_,l[_])}}setLightsUniformValues(r,l){if(!this.lightsUniforms)return;const p=this.lightsUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const _ in l)p[_].set(this.program,_,l[_])}}setShadowUniformValues(r,l){if(this.failedToCreate||!this.shadowUniforms)return;const p=this.shadowUniforms;r.program.set(this.program);for(const _ in l)p[_].set(this.program,_,l[_])}_drawDebugWireframe(r,l,p,_,v,b,S,I,P,R){const z=r.options.wireframe;if(!1===z.terrain&&!1===z.layers2D&&!1===z.layers3D)return;const L=r.context;if(!(()=>!(!z.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!z.layers2D||r._terrain&&r._terrain.renderingToTexture||!Gg.includes(this.name))||!(!z.layers3D||!Xp.includes(this.name)))())return;const B=L.gl,H=r.wireframeDebugCache.getLinesFromTrianglesBuffer(r.frameCounter,v,L);if(!H)return;const U=[...this.fixedDefines];U.push("DEBUG_WIREFRAME");const q=r.getOrCreateProgram(this.name,{config:this.configuration,defines:U});L.program.set(q.program);const G=(ne,le,de)=>{if(le[ne]&&de[ne])for(const pe in le[ne])de[ne][pe]&&de[ne][pe].set(de.program,pe,le[ne][pe].current)};P&&P.setUniforms(q.program,L,q.binderUniforms,S,{zoom:I}),G("fixedUniforms",this,q),G("terrainUniforms",this,q),G("globeUniforms",this,q),G("fogUniforms",this,q),G("lightsUniforms",this,q),G("shadowUniforms",this,q),H.bind(),L.setColorMode(new an([B.ONE,B.ONE_MINUS_SRC_ALPHA,B.ZERO,B.ONE],u.am.transparent,[!0,!0,!0,!1])),L.setDepthMode(new bt(l.func===B.LESS?B.LEQUAL:l.func,bt.ReadOnly,l.range)),L.setStencilMode(Bt.disabled);const Y=3*b.primitiveLength*2,ee=3*b.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const ne=R||1;for(let le=0;le<ne;++le)q.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",le),B.drawElements(B.LINES,Y,B.UNSIGNED_SHORT,ee)}else R&&R>1?B.drawElementsInstanced(B.LINES,Y,B.UNSIGNED_SHORT,ee,R):B.drawElements(B.LINES,Y,B.UNSIGNED_SHORT,ee);v.bind(),L.program.set(this.program),L.setDepthMode(l),L.setStencilMode(p),L.setColorMode(_)}checkUniforms(r,l,p){if(this.fixedDefines.includes(l))for(const _ of Object.keys(p))if(!p[_].initialized)throw new Error(`Program '${this.name}', from draw '${r}': uniform ${_} not set but required by ${l} being defined`)}draw(r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q){const G=r.context,Y=G.gl;if(this.failedToCreate)return;G.program.set(this.program),G.setDepthMode(p),G.setStencilMode(_),G.setColorMode(v),G.setCullFace(b);for(const le of Object.keys(this.fixedUniforms))this.fixedUniforms[le].set(this.program,le,S[le]);H&&H.setUniforms(this.program,G,this.binderUniforms,L,{zoom:B});const ee={[Y.POINTS]:1,[Y.LINES]:2,[Y.TRIANGLES]:3,[Y.LINE_STRIP]:1}[l];this.checkUniforms(I,"RENDER_SHADOWS",this.shadowUniforms);const ne=q&&q>0?1:void 0;for(const le of z.get()){const de=le.vaos||(le.vaos={});if((de[I]||(de[I]=new Jo)).bind(G,this,P,H?H.getPaintVertexBuffers():[],R,le.vertexOffset,U||[],ne),this.forceManualRenderingForInstanceIDShaders){const pe=q||1;for(let ae=0;ae<pe;++ae)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ae),R?Y.drawElements(l,le.primitiveLength*ee,Y.UNSIGNED_SHORT,le.primitiveOffset*ee*2):Y.drawArrays(l,le.vertexOffset,le.vertexLength)}else q&&q>1?Y.drawElementsInstanced(l,le.primitiveLength*ee,Y.UNSIGNED_SHORT,le.primitiveOffset*ee*2,q):R?Y.drawElements(l,le.primitiveLength*ee,Y.UNSIGNED_SHORT,le.primitiveOffset*ee*2):Y.drawArrays(l,le.vertexOffset,le.vertexLength);l===Y.TRIANGLES&&R&&this._drawDebugWireframe(r,p,_,v,R,le,L,B,H,q)}}}function Kp(f,r,l=0){const p=Math.pow(2,r.tileID.overscaledZ),_=r.tileSize*Math.pow(2,f.transform.tileZoom)/p,v=_*(r.tileID.canonical.x+r.tileID.wrap*p),b=_*r.tileID.canonical.y;return{u_image:0,u_texsize:r.imageAtlasTexture?r.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/u.aw(r,1,f.transform.tileZoom),u_pixel_coord_upper:[v>>16,b>>16],u_pixel_coord_lower:[65535&v,65535&b],u_pattern_transition:l}}const Vu={terrain:0,flat:1},$g=u.bz(),qg=(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q,G)=>{const Y=r.style.light,ee=Y.properties.get("position"),ne=[ee.x,ee.y,ee.z],le=u.dJ();"viewport"===Y.properties.get("anchor")&&(u.dK(le,-r.transform.angle),u.dL(ne,ne,le));const de=Y.properties.get("color").toPremultipliedRenderColor(null),pe=r.transform,ae={u_matrix:f,u_lightpos:ne,u_lightintensity:Y.properties.get("intensity"),u_lightcolor:[de.r,de.g,de.b],u_vertical_gradient:+l,u_opacity:p,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:$g,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Vu[P],u_base_type:Vu[R],u_ao:_,u_edge_radius:v,u_width_scale:b,u_flood_light_color:H,u_vertical_scale:U,u_flood_light_intensity:q,u_ground_shadow_factor:G};return"globe"===pe.projection.name&&(ae.u_tile_id=[S.canonical.x,S.canonical.y,1<<S.canonical.z],ae.u_zoom_transition=z,ae.u_inv_rot_matrix=B,ae.u_merc_center=L,ae.u_up_dir=pe.projection.upVector(new u.cA(0,0,0),L[0]*u.aj,L[1]*u.aj),ae.u_height_lift=I),ae},cv=(f,r,l,p,_,v)=>({u_matrix:f,u_edge_radius:r,u_width_scale:l,u_vertical_scale:p,u_height_type:Vu[_],u_base_type:Vu[v]}),Qd=(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q,G)=>{const Y=qg(f,r,l,p,_,v,b,S,P,R,z,L,B,H,U,q,1,[0,0,0]),ee={u_height_factor:-Math.pow(2,S.overscaledZ)/I.tileSize/8};return u.h(Y,Kp(r,I,G),ee)},uv=(f,r,l)=>({u_matrix:f,u_emissive_strength:r,u_ground_shadow_factor:l}),dv=(f,r,l,p,_,v=0)=>u.h(uv(f,r,_),Kp(l,p,v)),Wg=(f,r,l,p)=>({u_matrix:f,u_world:l,u_emissive_strength:r,u_ground_shadow_factor:p}),Zg=(f,r,l,p,_,v,b=0)=>u.h(dv(f,r,l,p,v,b),{u_world:_}),Lx=(f,r)=>({u_matrix:f,u_ground_shadow_factor:r}),Qp=(f,r,l,p,_)=>({u_matrix:f,u_camera_pos:[r[0],r[1],r[2]],u_depth_bias:l,u_height_scale:p,u_reset_depth:_}),Xg=(f,r)=>({u_matrix:f,u_normal_matrix:r,u_opacity:1}),Ka=f=>({u_matrix:f}),Qa=f=>({u_matrix:f}),Jd=(f,r,l,p,_,v,b,S)=>{const I=u.aj/v.tileSize;return{u_matrix:f,u_inv_rot_matrix:r,u_camera_to_center_distance:l.getCameraToCenterDistance(S),u_extrude_scale:[l.pixelsToGLUnits[0]/I,l.pixelsToGLUnits[1]/I],u_zoom_transition:p,u_tile_id:b,u_merc_center:_}},Yg=(f,r,l=1)=>({u_matrix:f,u_color:r,u_overlay:0,u_overlay_scale:l}),yo=u.bz(),eh=(f,r,l,p,_,v,b)=>{const S=f.transform,I="globe"===S.projection.name,P=I?u.dM(S.zoom,r.canonical)*S._pixelsPerMercatorPixel:u.aw(l,1,v),R={u_matrix:r.projMatrix,u_extrude_scale:P,u_intensity:b,u_inv_rot_matrix:yo,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(I){R.u_inv_rot_matrix=p,R.u_merc_center=_,R.u_tile_id=[r.canonical.x,r.canonical.y,1<<r.canonical.z],R.u_zoom_transition=u.ah(S.zoom);const z=_[0]*u.aj,L=_[1]*u.aj;R.u_up_dir=S.projection.upVector(new u.cA(0,0,0),z,L)}return R};function is(f,[r,l,p,_],[v,b]){if(v===b)return[0,0,0,0];const S=255*(f-1)/(f*(b-v));return[r*S,l*S,p*S,_*S]}function Ja(f,r,[l,p]){return l===p?0:.5/f+(r-l)*(f-1)/(f*(p-l))}const wf=(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q,G,Y,ee,ne)=>({u_matrix:f,u_normalize_matrix:r,u_globe_matrix:l,u_merc_matrix:p,u_grid_matrix:_,u_tl_parent:v,u_scale_parent:P,u_fade_t:R.mix,u_opacity:R.opacity*z.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:z.paint.get("raster-brightness-min"),u_brightness_high:z.paint.get("raster-brightness-max"),u_saturation_factor:u.dO(z.paint.get("raster-saturation")),u_contrast_factor:u.dN(z.paint.get("raster-contrast")),u_spin_weights:el(z.paint.get("raster-hue-rotate")),u_perspective_transform:L,u_raster_elevation:B,u_zoom_transition:b,u_merc_center:S,u_cutoff_params:I,u_colorization_mix:is(u.dP,U,G),u_colorization_offset:Ja(u.dP,q,G),u_color_ramp:H,u_texture_offset:[ee/(Y+2*ee),Y/(Y+2*ee)],u_texture_res:[Y+2*ee,Y+2*ee],u_emissive_strength:ne});function el(f){f*=Math.PI/180;const r=Math.sin(f),l=Math.cos(f);return[(2*l+1)/3,(-Math.sqrt(3)*r-l+1)/3,(Math.sqrt(3)*r-l+1)/3]}const tl=.05,ju=(f,r,l,p,_,v,b,S,I,P,R,z)=>({u_matrix:f,u_normalize_matrix:r,u_globe_matrix:l,u_merc_matrix:p,u_grid_matrix:_,u_tl_parent:v,u_scale_parent:P,u_fade_t:R.mix,u_opacity:R.opacity,u_image0:0,u_image1:1,u_raster_elevation:z,u_zoom_transition:b,u_merc_center:S,u_cutoff_params:I}),Jp=(f,r,l,p,_,v,b,S,I,P)=>({u_particle_texture:f,u_particle_texture_side_len:r,u_tile_offset:l,u_velocity:p,u_color_ramp:v,u_velocity_res:_,u_max_speed:b,u_uv_offset:S,u_data_scale:[255*I[0],255*I[1]],u_data_offset:P,u_particle_pos_scale:1.1,u_particle_pos_offset:[tl,tl]}),Ef=(f,r,l,p,_,v,b,S,I,P)=>({u_particle_texture:f,u_particle_texture_side_len:r,u_velocity:l,u_velocity_res:p,u_max_speed:_,u_speed_factor:v,u_reset_rate:b,u_rand_seed:Math.random(),u_uv_offset:S,u_data_scale:[255*I[0],255*I[1]],u_data_offset:P,u_particle_pos_scale:1.1,u_particle_pos_offset:[tl,tl]}),Uu=u.bz(),th=(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q,G,Y,ee,ne,le,de,pe)=>{const ae=_.transform,ce={u_is_size_zoom_constant:+("constant"===f||"source"===f),u_is_size_feature_constant:+("constant"===f||"camera"===f),u_size_t:r?r.uSizeT:0,u_size:r?r.uSize:0,u_camera_to_center_distance:ae.getCameraToCenterDistance(Y),u_rotate_symbol:+l,u_aspect_ratio:ae.width/ae.height,u_fade_change:_.options.fadeDuration?_.symbolFadeChange:1,u_matrix:v,u_label_plane_matrix:b,u_coord_matrix:S,u_is_text:+P,u_elevation_from_sea:I?1:0,u_pitch_with_map:+p,u_texsize:R,u_texsize_icon:z,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Uu,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Uu,u_up_vector:[0,-1,0],u_color_adj_mat:le,u_icon_transition:de||0,u_gamma_scale:p?_.transform.getCameraToCenterDistance(Y)*Math.cos(_.terrain?0:_.transform._pitch):1,u_device_pixel_ratio:u.q.devicePixelRatio,u_is_halo:1,u_scale_factor:pe||1,u_ground_shadow_factor:ee,u_inv_matrix:u.bi(u.bz(),b),u_normal_scale:ne};return"globe"===Y.name&&(ce.u_tile_id=[B.canonical.x,B.canonical.y,1<<B.canonical.z],ce.u_zoom_transition=H,ce.u_inv_rot_matrix=q,ce.u_merc_center=U,ce.u_camera_forward=ae._camera.forward(),ce.u_ecef_origin=u.dQ(ae.globeMatrix,B.toUnwrapped()),ce.u_tile_matrix=Float32Array.from(ae.globeMatrix),ce.u_up_vector=G),ce},em=(f,r,l,p)=>({u_matrix:f,u_emissive_strength:r,u_opacity:l,u_color:p}),Tf=(f,r,l,p,_,v,b,S,I)=>u.h(function(P,R,z,L,B,H){const{width:U,height:q}=L.imageManager.getPixelSize(R),G=Math.pow(2,H.tileID.overscaledZ),Y=H.tileSize*Math.pow(2,L.transform.tileZoom)/G,ee=Y*(H.tileID.canonical.x+H.tileID.wrap*G),ne=Y*H.tileID.canonical.y;return{u_image:0,u_pattern_tl:z.tl,u_pattern_br:z.br,u_texsize:[U,q],u_pattern_size:z.displaySize,u_pattern_units_to_pixels:B?[L.transform.width,-1*L.transform.height]:[1/u.aw(H,1,L.transform.tileZoom),1/u.aw(H,1,L.transform.tileZoom)],u_pixel_coord_upper:[ee>>16,ne>>16],u_pixel_coord_lower:[65535&ee,65535&ne]}}(0,v,b,p,S,I),{u_matrix:f,u_emissive_strength:r,u_opacity:l}),Ma=new Float32Array(u.bx([])),Fc=(f,r,l,p,_,v,b,S,I,P,R,z,L,B=[0,0,0],H)=>{const U=_.style.light,q=U.properties.get("position"),G=[-q.x,-q.y,q.z],Y=u.dJ();"viewport"===U.properties.get("anchor")&&(u.dK(Y,-_.transform.angle),u.dL(G,G,Y));const ee="MASK"===R.alphaMode,ne=U.properties.get("color").toNonPremultipliedRenderColor(null),le=L.paint.get("model-ambient-occlusion-intensity"),de=L.paint.get("model-color").constantOr(u.am.white).toNonPremultipliedRenderColor(null);return de.a=L.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:f,u_lighting_matrix:r,u_normal_matrix:l,u_node_matrix:p||Ma,u_lightpos:G,u_lightintensity:U.properties.get("intensity"),u_lightcolor:[ne.r,ne.g,ne.b],u_camera_pos:B,u_opacity:v,u_baseTextureIsAlpha:0,u_alphaMask:+ee,u_alphaCutoff:R.alphaCutoff,u_baseColorFactor:b.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:S.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:I,u_roughnessFactor:P,u_baseColorTexture:Zr.BaseColor,u_metallicRoughnessTexture:Zr.MetallicRoughness,u_normalTexture:Zr.Normal,u_occlusionTexture:Zr.Occlusion,u_emissionTexture:Zr.Emission,u_lutTexture:Zr.LUT,u_color_mix:de.toArray01(),u_aoIntensity:le,u_emissive_strength:z,u_occlusionTextureTransform:H||[0,0,0,0]}},zc=(f,r=Ma,l=Ma)=>({u_matrix:f,u_instance:r,u_node_matrix:l}),tm={fillExtrusion:f=>({u_matrix:new u.ch(f),u_lightpos:new u.ce(f),u_lightintensity:new u.cf(f),u_lightcolor:new u.ce(f),u_vertical_gradient:new u.cf(f),u_opacity:new u.cf(f),u_edge_radius:new u.cf(f),u_width_scale:new u.cf(f),u_ao:new u.cg(f),u_height_type:new u.cd(f),u_base_type:new u.cd(f),u_tile_id:new u.ce(f),u_zoom_transition:new u.cf(f),u_inv_rot_matrix:new u.ch(f),u_merc_center:new u.cg(f),u_up_dir:new u.ce(f),u_height_lift:new u.cf(f),u_flood_light_color:new u.ce(f),u_vertical_scale:new u.cf(f),u_flood_light_intensity:new u.cf(f),u_ground_shadow_factor:new u.ce(f)}),fillExtrusionDepth:f=>({u_matrix:new u.ch(f),u_edge_radius:new u.cf(f),u_width_scale:new u.cf(f),u_vertical_scale:new u.cf(f),u_height_type:new u.cd(f),u_base_type:new u.cd(f)}),fillExtrusionPattern:f=>({u_matrix:new u.ch(f),u_lightpos:new u.ce(f),u_lightintensity:new u.cf(f),u_lightcolor:new u.ce(f),u_vertical_gradient:new u.cf(f),u_height_factor:new u.cf(f),u_edge_radius:new u.cf(f),u_width_scale:new u.cf(f),u_ao:new u.cg(f),u_height_type:new u.cd(f),u_base_type:new u.cd(f),u_tile_id:new u.ce(f),u_zoom_transition:new u.cf(f),u_inv_rot_matrix:new u.ch(f),u_merc_center:new u.cg(f),u_up_dir:new u.ce(f),u_height_lift:new u.cf(f),u_image:new u.cd(f),u_texsize:new u.cg(f),u_pixel_coord_upper:new u.cg(f),u_pixel_coord_lower:new u.cg(f),u_tile_units_to_pixels:new u.cf(f),u_opacity:new u.cf(f),u_pattern_transition:new u.cf(f)}),fillExtrusionGroundEffect:f=>({u_matrix:new u.ch(f),u_opacity:new u.cf(f),u_ao_pass:new u.cf(f),u_meter_to_tile:new u.cf(f),u_ao:new u.cg(f),u_flood_light_intensity:new u.cf(f),u_flood_light_color:new u.ce(f),u_attenuation:new u.cf(f),u_edge_radius:new u.cf(f),u_fb:new u.cd(f),u_fb_size:new u.cf(f),u_dynamic_offset:new u.cf(f)}),fill:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_ground_shadow_factor:new u.ce(f)}),fillPattern:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_image:new u.cd(f),u_texsize:new u.cg(f),u_pixel_coord_upper:new u.cg(f),u_pixel_coord_lower:new u.cg(f),u_tile_units_to_pixels:new u.cf(f),u_ground_shadow_factor:new u.ce(f),u_pattern_transition:new u.cf(f)}),fillOutline:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_world:new u.cg(f),u_ground_shadow_factor:new u.ce(f)}),fillOutlinePattern:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_world:new u.cg(f),u_image:new u.cd(f),u_texsize:new u.cg(f),u_pixel_coord_upper:new u.cg(f),u_pixel_coord_lower:new u.cg(f),u_tile_units_to_pixels:new u.cf(f),u_ground_shadow_factor:new u.ce(f),u_pattern_transition:new u.cf(f)}),building:f=>({u_matrix:new u.ch(f),u_normal_matrix:new u.ch(f),u_opacity:new u.cf(f)}),buildingBloom:f=>({u_matrix:new u.ch(f)}),buildingDepth:f=>({u_matrix:new u.ch(f)}),elevatedStructuresDepth:f=>({u_matrix:new u.ch(f),u_depth_bias:new u.cf(f)}),elevatedStructures:f=>({u_matrix:new u.ch(f),u_ground_shadow_factor:new u.ce(f)}),elevatedStructuresDepthReconstruct:f=>({u_matrix:new u.ch(f),u_camera_pos:new u.ce(f),u_depth_bias:new u.cf(f),u_height_scale:new u.cf(f),u_reset_depth:new u.cf(f)}),circle:u.dT,collisionBox:f=>({u_matrix:new u.ch(f),u_inv_rot_matrix:new u.ch(f),u_camera_to_center_distance:new u.cf(f),u_extrude_scale:new u.cg(f),u_zoom_transition:new u.cf(f),u_merc_center:new u.cg(f),u_tile_id:new u.ce(f)}),collisionCircle:f=>({u_matrix:new u.ch(f),u_inv_matrix:new u.ch(f),u_camera_to_center_distance:new u.cf(f),u_viewport_size:new u.cg(f)}),debug:f=>({u_color:new u.dv(f),u_matrix:new u.ch(f),u_overlay:new u.cd(f),u_overlay_scale:new u.cf(f)}),clippingMask:f=>({u_matrix:new u.ch(f)}),heatmap:f=>({u_extrude_scale:new u.cf(f),u_intensity:new u.cf(f),u_matrix:new u.ch(f),u_inv_rot_matrix:new u.ch(f),u_merc_center:new u.cg(f),u_tile_id:new u.ce(f),u_zoom_transition:new u.cf(f),u_up_dir:new u.ce(f)}),heatmapTexture:f=>({u_image:new u.cd(f),u_color_ramp:new u.cd(f),u_opacity:new u.cf(f)}),hillshade:f=>({u_matrix:new u.ch(f),u_image:new u.cd(f),u_latrange:new u.cg(f),u_light:new u.cg(f),u_shadow:new u.dv(f),u_highlight:new u.dv(f),u_emissive_strength:new u.cf(f),u_accent:new u.dv(f)}),hillshadePrepare:f=>({u_matrix:new u.ch(f),u_image:new u.cd(f),u_dimension:new u.cg(f),u_zoom:new u.cf(f)}),line:u.dS,linePattern:u.dR,raster:f=>({u_matrix:new u.ch(f),u_normalize_matrix:new u.ch(f),u_globe_matrix:new u.ch(f),u_merc_matrix:new u.ch(f),u_grid_matrix:new u.dw(f),u_tl_parent:new u.cg(f),u_scale_parent:new u.cf(f),u_fade_t:new u.cf(f),u_opacity:new u.cf(f),u_image0:new u.cd(f),u_image1:new u.cd(f),u_brightness_low:new u.cf(f),u_brightness_high:new u.cf(f),u_saturation_factor:new u.cf(f),u_contrast_factor:new u.cf(f),u_spin_weights:new u.ce(f),u_perspective_transform:new u.cg(f),u_raster_elevation:new u.cf(f),u_zoom_transition:new u.cf(f),u_merc_center:new u.cg(f),u_cutoff_params:new u.d0(f),u_colorization_mix:new u.d0(f),u_colorization_offset:new u.cf(f),u_color_ramp:new u.cd(f),u_texture_offset:new u.cg(f),u_texture_res:new u.cg(f),u_emissive_strength:new u.cf(f)}),rasterParticle:f=>({u_matrix:new u.ch(f),u_normalize_matrix:new u.ch(f),u_globe_matrix:new u.ch(f),u_merc_matrix:new u.ch(f),u_grid_matrix:new u.dw(f),u_tl_parent:new u.cg(f),u_scale_parent:new u.cf(f),u_fade_t:new u.cf(f),u_opacity:new u.cf(f),u_image0:new u.cd(f),u_image1:new u.cd(f),u_raster_elevation:new u.cf(f),u_zoom_transition:new u.cf(f),u_merc_center:new u.cg(f),u_cutoff_params:new u.d0(f)}),rasterParticleTexture:f=>({u_texture:new u.cd(f),u_opacity:new u.cf(f)}),rasterParticleDraw:f=>({u_particle_texture:new u.cd(f),u_particle_texture_side_len:new u.cf(f),u_tile_offset:new u.cg(f),u_velocity:new u.cd(f),u_color_ramp:new u.cd(f),u_velocity_res:new u.cg(f),u_max_speed:new u.cf(f),u_uv_offset:new u.cg(f),u_data_scale:new u.cg(f),u_data_offset:new u.cf(f),u_particle_pos_scale:new u.cf(f),u_particle_pos_offset:new u.cg(f)}),rasterParticleUpdate:f=>({u_particle_texture:new u.cd(f),u_particle_texture_side_len:new u.cf(f),u_velocity:new u.cd(f),u_velocity_res:new u.cg(f),u_max_speed:new u.cf(f),u_speed_factor:new u.cf(f),u_reset_rate:new u.cf(f),u_rand_seed:new u.cf(f),u_uv_offset:new u.cg(f),u_data_scale:new u.cg(f),u_data_offset:new u.cf(f),u_particle_pos_scale:new u.cf(f),u_particle_pos_offset:new u.cg(f)}),symbol:f=>({u_is_size_zoom_constant:new u.cd(f),u_is_size_feature_constant:new u.cd(f),u_size_t:new u.cf(f),u_size:new u.cf(f),u_camera_to_center_distance:new u.cf(f),u_rotate_symbol:new u.cd(f),u_aspect_ratio:new u.cf(f),u_fade_change:new u.cf(f),u_matrix:new u.ch(f),u_label_plane_matrix:new u.ch(f),u_coord_matrix:new u.ch(f),u_is_text:new u.cd(f),u_elevation_from_sea:new u.cd(f),u_pitch_with_map:new u.cd(f),u_texsize:new u.cg(f),u_texsize_icon:new u.cg(f),u_texture:new u.cd(f),u_texture_icon:new u.cd(f),u_gamma_scale:new u.cf(f),u_device_pixel_ratio:new u.cf(f),u_tile_id:new u.ce(f),u_zoom_transition:new u.cf(f),u_inv_rot_matrix:new u.ch(f),u_merc_center:new u.cg(f),u_camera_forward:new u.ce(f),u_tile_matrix:new u.ch(f),u_up_vector:new u.ce(f),u_ecef_origin:new u.ce(f),u_is_halo:new u.cd(f),u_icon_transition:new u.cf(f),u_color_adj_mat:new u.ch(f),u_scale_factor:new u.cf(f),u_ground_shadow_factor:new u.ce(f),u_inv_matrix:new u.ch(f),u_normal_scale:new u.cf(f)}),background:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_opacity:new u.cf(f),u_color:new u.dv(f)}),backgroundPattern:f=>({u_matrix:new u.ch(f),u_emissive_strength:new u.cf(f),u_opacity:new u.cf(f),u_image:new u.cd(f),u_pattern_tl:new u.cg(f),u_pattern_br:new u.cg(f),u_texsize:new u.cg(f),u_pattern_size:new u.cg(f),u_pixel_coord_upper:new u.cg(f),u_pixel_coord_lower:new u.cg(f),u_pattern_units_to_pixels:new u.cg(f)}),terrainRaster:f=>({u_matrix:new u.ch(f),u_image0:new u.cd(f),u_skirt_height:new u.cf(f),u_ground_shadow_factor:new u.ce(f)}),skybox:f=>({u_matrix:new u.ch(f),u_sun_direction:new u.ce(f),u_cubemap:new u.cd(f),u_opacity:new u.cf(f),u_temporal_offset:new u.cf(f)}),skyboxGradient:f=>({u_matrix:new u.ch(f),u_color_ramp:new u.cd(f),u_center_direction:new u.ce(f),u_radius:new u.cf(f),u_opacity:new u.cf(f),u_temporal_offset:new u.cf(f)}),skyboxCapture:f=>({u_matrix_3f:new u.dw(f),u_sun_direction:new u.ce(f),u_sun_intensity:new u.cf(f),u_color_tint_r:new u.d0(f),u_color_tint_m:new u.d0(f),u_luminance:new u.cf(f)}),globeRaster:f=>({u_proj_matrix:new u.ch(f),u_globe_matrix:new u.ch(f),u_normalize_matrix:new u.ch(f),u_merc_matrix:new u.ch(f),u_zoom_transition:new u.cf(f),u_merc_center:new u.cg(f),u_image0:new u.cd(f),u_grid_matrix:new u.dw(f),u_skirt_height:new u.cf(f),u_far_z_cutoff:new u.cf(f),u_frustum_tl:new u.ce(f),u_frustum_tr:new u.ce(f),u_frustum_br:new u.ce(f),u_frustum_bl:new u.ce(f),u_globe_pos:new u.ce(f),u_globe_radius:new u.cf(f),u_viewport:new u.cg(f)}),globeAtmosphere:f=>({u_frustum_tl:new u.ce(f),u_frustum_tr:new u.ce(f),u_frustum_br:new u.ce(f),u_frustum_bl:new u.ce(f),u_horizon:new u.cf(f),u_transition:new u.cf(f),u_fadeout_range:new u.cf(f),u_color:new u.d0(f),u_high_color:new u.d0(f),u_space_color:new u.d0(f),u_temporal_offset:new u.cf(f),u_horizon_angle:new u.cf(f)}),model:f=>({u_matrix:new u.ch(f),u_lighting_matrix:new u.ch(f),u_normal_matrix:new u.ch(f),u_node_matrix:new u.ch(f),u_lightpos:new u.ce(f),u_lightintensity:new u.cf(f),u_lightcolor:new u.ce(f),u_camera_pos:new u.ce(f),u_opacity:new u.cf(f),u_baseColorFactor:new u.d0(f),u_emissiveFactor:new u.d0(f),u_metallicFactor:new u.cf(f),u_roughnessFactor:new u.cf(f),u_baseTextureIsAlpha:new u.cd(f),u_alphaMask:new u.cd(f),u_alphaCutoff:new u.cf(f),u_baseColorTexture:new u.cd(f),u_metallicRoughnessTexture:new u.cd(f),u_normalTexture:new u.cd(f),u_occlusionTexture:new u.cd(f),u_emissionTexture:new u.cd(f),u_lutTexture:new u.cd(f),u_color_mix:new u.d0(f),u_aoIntensity:new u.cf(f),u_emissive_strength:new u.cf(f),u_occlusionTextureTransform:new u.d0(f)}),modelDepth:f=>({u_matrix:new u.ch(f),u_instance:new u.ch(f),u_node_matrix:new u.ch(f)}),groundShadow:f=>({u_matrix:new u.ch(f),u_ground_shadow_factor:new u.ce(f)}),stars:f=>({u_matrix:new u.ch(f),u_up:new u.ce(f),u_right:new u.ce(f),u_intensity_multiplier:new u.cf(f)}),snowParticle:f=>({u_modelview:new u.ch(f),u_projection:new u.ch(f),u_time:new u.cf(f),u_cam_pos:new u.ce(f),u_velocityConeAperture:new u.cf(f),u_velocity:new u.cf(f),u_horizontalOscillationRadius:new u.cf(f),u_horizontalOscillationRate:new u.cf(f),u_boxSize:new u.cf(f),u_billboardSize:new u.cf(f),u_simpleShapeParameters:new u.cg(f),u_screenSize:new u.cg(f),u_thinningCenterPos:new u.cg(f),u_thinningShape:new u.ce(f),u_thinningAffectedRatio:new u.cf(f),u_thinningParticleOffset:new u.cf(f),u_particleColor:new u.d0(f),u_direction:new u.ce(f)}),rainParticle:f=>({u_modelview:new u.ch(f),u_projection:new u.ch(f),u_time:new u.cf(f),u_cam_pos:new u.ce(f),u_texScreen:new u.cd(f),u_velocityConeAperture:new u.cf(f),u_velocity:new u.cf(f),u_boxSize:new u.cf(f),u_rainDropletSize:new u.cg(f),u_distortionStrength:new u.cf(f),u_rainDirection:new u.ce(f),u_color:new u.d0(f),u_screenSize:new u.cg(f),u_thinningCenterPos:new u.cg(f),u_thinningShape:new u.ce(f),u_thinningAffectedRatio:new u.cf(f),u_thinningParticleOffset:new u.cf(f),u_shapeDirectionalPower:new u.cf(f),u_shapeNormalPower:new u.cf(f),u_mode:new u.cf(f)}),vignette:f=>({u_vignetteShape:new u.ce(f),u_vignetteColor:new u.d0(f)}),occlusion:f=>({u_matrix:new u.ch(f),u_anchorPos:new u.ce(f),u_screenSizePx:new u.cg(f),u_occluderSizePx:new u.cg(f),u_color:new u.d0(f)})};let hv=(()=>{class f{constructor(l,p,_,v){this.id=f.uniqueIdxCounter,f.uniqueIdxCounter++,this.context=l;const b=l.gl;this.buffer=b.createBuffer(),this.dynamicDraw=!!_,this.context.unbindVAO(),l.bindElementBuffer.set(this.buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,p.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||v||p.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(l){this.id=f.uniqueIdxCounter,f.uniqueIdxCounter++;const p=this.context.gl;this.context.unbindVAO(),this.bind(),p.bufferSubData(p.ELEMENT_ARRAY_BUFFER,0,l.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return f.uniqueIdxCounter=0,f})();const Kg={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Qg{constructor(r,l,p,_,v,b){this.length=l.length,this.attributes=p,this.itemSize=l.bytesPerElement,this.dynamicDraw=_,this.instanceCount=b,this.context=r;const S=r.gl;this.buffer=S.createBuffer(),r.bindVertexBuffer.set(this.buffer),S.bufferData(S.ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?S.DYNAMIC_DRAW:S.STATIC_DRAW),this.dynamicDraw||v||l.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(r){const l=this.context.gl;this.bind(),l.bufferSubData(l.ARRAY_BUFFER,0,r.arrayBuffer)}enableAttributes(r,l){for(let p=0;p<this.attributes.length;p++){const _=l.attributes[this.attributes[p].name];void 0!==_&&r.enableVertexAttribArray(_)}}setVertexAttribPointers(r,l,p){for(let _=0;_<this.attributes.length;_++){const v=this.attributes[_],b=l.attributes[v.name];void 0!==b&&r.vertexAttribPointer(b,v.components,r[Kg[v.type]],!1,this.itemSize,v.offset+this.itemSize*(p||0))}}setVertexAttribDivisor(r,l,p){for(let _=0;_<this.attributes.length;_++){const v=l.attributes[this.attributes[_].name];void 0!==v&&this.instanceCount&&this.instanceCount>0&&r.vertexAttribDivisor(v,p)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Nc{constructor(r,l,p,_,v){this.context=r,this.width=l,this.height=p;const b=this.framebuffer=r.gl.createFramebuffer();_&&(this.colorAttachment=new xf(r,b)),v&&(this.depthAttachmentType=v,this.depthAttachment="renderbuffer"===v?new Lc(r,b):new kc(r,b))}destroy(){const r=this.context.gl;if(this.colorAttachment){const l=this.colorAttachment.get();l&&r.deleteTexture(l)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const l=this.depthAttachment.get();l&&r.deleteRenderbuffer(l)}else{const l=this.depthAttachment.get();l&&r.deleteTexture(l)}r.deleteFramebuffer(this.framebuffer)}}class Sf{constructor(r,l){this.gl=r,this.clearColor=new sv(this),this.clearDepth=new av(this),this.clearStencil=new Lr(this),this.colorMask=new Yt(this),this.depthMask=new Jn(this),this.stencilMask=new Cr(this),this.stencilFunc=new _s(this),this.stencilOp=new Zd(this),this.stencilTest=new Io(this),this.depthRange=new Ul(this),this.depthTest=new Ar(this),this.depthFunc=new Ca(this),this.blend=new qs(this),this.blendFunc=new On(this),this.blendColor=new Hl(this),this.blendEquation=new Xd(this),this.cullFace=new ca(this),this.cullFaceSide=new kr(this),this.frontFace=new Rc(this),this.program=new Oc(this),this.activeTexture=new es(this),this.viewport=new Gl(this),this.bindFramebuffer=new Yd(this),this.bindRenderbuffer=new Aa(this),this.bindTexture=new Ws(this),this.bindVertexBuffer=new Za(this),this.bindElementBuffer=new Nu(this),this.bindVertexArrayOES=new vi(this),this.pixelStoreUnpack=new lv(this),this.pixelStoreUnpackPremultiplyAlpha=new $l(this),this.pixelStoreUnpackFlipY=new qp(this),this.options=l?Object.assign({},l):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=r.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=r.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=r.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=r.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=l&&!!l.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=r.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=r.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=r.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this.maxPointSize=r.getParameter(r.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(r,l,p){return new hv(this,r,l,p)}createVertexBuffer(r,l,p,_,v){return new Qg(this,r,l,p,_,v)}createRenderbuffer(r,l,p){const _=this.gl,v=_.createRenderbuffer();return this.bindRenderbuffer.set(v),_.renderbufferStorage(_.RENDERBUFFER,r,l,p),this.bindRenderbuffer.set(null),v}createFramebuffer(r,l,p,_){return new Nc(this,r,l,p,_)}clear({color:r,depth:l,stencil:p,colorMask:_}){const v=this.gl;let b=0;r&&(b|=v.COLOR_BUFFER_BIT,this.clearColor.set(r.toNonPremultipliedRenderColor(null)),this.colorMask.set(_||[!0,!0,!0,!0])),void 0!==l&&(b|=v.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(l),this.depthMask.set(!0)),void 0!==p&&(b|=v.STENCIL_BUFFER_BIT,this.clearStencil.set(p),this.stencilMask.set(255)),v.clear(b)}setCullFace(r){!1===r.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(r.mode),this.frontFace.set(r.frontFace))}setDepthMode(r){r.func!==this.gl.ALWAYS||r.mask?(this.depthTest.set(!0),this.depthFunc.set(r.func),this.depthMask.set(r.mask),this.depthRange.set(r.range)):this.depthTest.set(!1)}setStencilMode(r){r.test.func!==this.gl.ALWAYS||r.mask?(this.stencilTest.set(!0),this.stencilMask.set(r.mask),this.stencilOp.set([r.fail,r.depthFail,r.pass]),this.stencilFunc.set({func:r.test.func,ref:r.ref,mask:r.test.mask})):this.stencilTest.set(!1)}setColorMode(r){u.bv(r.blendFunction,an.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(r.blendFunction),this.blendColor.set(r.blendColor),r.blendEquation?this.blendEquation.set(r.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(r.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Bc;function Df(f,r,l,p,_,v,b){const S=f.context,I=S.gl,P=f.transform,R=[u.aD(P.center.lng),u.aH(P.center.lat)],z=l.layout.get("symbol-placement"),L=l.layout.get("text-variable-anchor"),B="map"===l.layout.get("icon-rotation-alignment"),H="map"===l.layout.get("text-rotation-alignment"),U="point"!==z,q=[];let G=0,Y=0;for(let ce=0;ce<p.length;ce++){const ue=p[ce],Me=r.getTile(ue),ye=Me.getBucket(l);if(!ye)continue;const je=ye.getProjection().createInversionMatrix(P,ue.canonical),Le=[],Ge=nv(ue,ye,P),rt=!b&&B&&U,Se=b&&H&&U,_e=L&&ye.hasTextData(),ze=ye.hasIconTextFit()&&_e&&ye.hasIconData(),Re=rt||Se||b&&_e||ze,We="globe"===ye.projection.name,Ze=We?u.ah(P.zoom):0;We&&(Le.push("PROJECTION_GLOBE_VIEW"),Re&&Le.push("PROJECTED_POS_ON_VIEWPORT"));const Ye=f.getOrCreateProgram("collisionBox",{defines:Le});let ct=Ge;0===_[0]&&0===_[1]||(ct=f.translatePosMatrix(Ge,Me,_,v));const Ct=b?ye.textCollisionBox:ye.iconCollisionBox,Lt=ye.collisionCircleArray;if(Lt.length>0){const Rt=u.bz(),At=ct;u.cM(Rt,ye.placementInvProjMatrix,P.glCoordMatrix),u.cM(Rt,Rt,ye.placementViewportMatrix),q.push({circleArray:Lt,circleOffset:Y,transform:At,invTransform:Rt,projection:ye.getProjection()}),G+=Lt.length/4,Y=G}if(!Ct)continue;f.terrain&&f.terrain.setupElevationDraw(Me,Ye);const vt=We?[ue.canonical.x,ue.canonical.y,1<<ue.canonical.z]:[0,0,0];Ye.draw(f,I.LINES,bt.disabled,Bt.disabled,f.colorModeForRenderPass(),Nt.disabled,Jd(ct,je,P,Ze,R,Me,vt,ye.getProjection()),l.id,Ct.layoutVertexBuffer,Ct.indexBuffer,Ct.segments,null,P.zoom,null,[Ct.collisionVertexBuffer,Ct.collisionVertexBufferExt])}if(!b||!q.length)return;const ee=f.getOrCreateProgram("collisionCircle"),ne=new u.dU;ne.resize(4*G),ne._trim();let le=0;for(const ce of q)for(let ue=0;ue<ce.circleArray.length/4;ue++){const Me=4*ue,ye=ce.circleArray[Me+0],je=ce.circleArray[Me+1],Le=ce.circleArray[Me+2],Ge=ce.circleArray[Me+3];ne.emplace(le++,ye,je,Le,Ge,0),ne.emplace(le++,ye,je,Le,Ge,1),ne.emplace(le++,ye,je,Le,Ge,2),ne.emplace(le++,ye,je,Le,Ge,3)}(!Bc||Bc.length<2*G)&&(Bc=function(ce){const ue=2*ce,Me=new u.a_;Me.resize(ue),Me._trim();for(let ye=0;ye<ue;ye++){const je=6*ye;Me.uint16[je+0]=4*ye+0,Me.uint16[je+1]=4*ye+1,Me.uint16[je+2]=4*ye+2,Me.uint16[je+3]=4*ye+2,Me.uint16[je+4]=4*ye+3,Me.uint16[je+5]=4*ye+0}return Me}(G));const de=S.createIndexBuffer(Bc,!0),pe=S.createVertexBuffer(ne,u.dV.members,!0);for(const ce of q){const ue={u_matrix:ce.transform,u_inv_matrix:ce.invTransform,u_camera_to_center_distance:(ae=P).getCameraToCenterDistance(ce.projection),u_viewport_size:[ae.width,ae.height]};ee.draw(f,I.TRIANGLES,bt.disabled,Bt.disabled,f.colorModeForRenderPass(),Nt.disabled,ue,l.id,pe,de,u.bd.simpleSegment(0,2*ce.circleOffset,ce.circleArray.length,ce.circleArray.length/2),null,P.zoom)}var ae;pe.destroy(),de.destroy()}const nl=u.bz();function nh(f){const r=f._camera.getWorldToCamera(f.worldSize,1),l=u.az([],r,f.globeMatrix);u.bi(l,l);const p=[0,0,0],_=[0,1,0,0];return u.aA(_,_,l),p[0]=_[0],p[1]=_[1],p[2]=_[2],u.au(p,p),p}function ih({width:f,height:r,anchor:l,textOffset:p,textScale:_},v){const{horizontalAlign:b,verticalAlign:S}=u.bZ(l),I=-(b-.5)*f,P=-(S-.5)*r,R=u.b_(l,p);return new u.P((I/_+R[0])*v,(P/_+R[1])*v)}function fv(f,r,l,p,_,v,b,S,I,P){const R=f.text.placedSymbolArray,z=f.text.dynamicLayoutVertexArray,L=f.icon.dynamicLayoutVertexArray,B={},H=f.getProjection(),U=kp(b,H,_),q=_.elevation,G=H.upVectorScale(b.canonical,_.center.lat,_.worldSize).metersToTile;z.clear();for(let Y=0;Y<R.length;Y++){const ee=R.get(Y),{tileAnchorX:ne,tileAnchorY:le,numGlyphs:de}=ee,pe=ee.hidden||!ee.crossTileID||f.allowVerticalPlacement&&!ee.placedOrientation?null:p[ee.crossTileID];if(pe){let ae=0,ce=0,ue=0;if(q){const ze=q?q.getAtTileOffset(b,ne,le):0,[Re,We,Ze]=H.upVector(b.canonical,ne,le);ae=ze*Re*G,ce=ze*We*G,ue=ze*Ze*G}let[Me,ye,je,Le]=_n(ee.projectedAnchorX+ae,ee.projectedAnchorY+ce,ee.projectedAnchorZ+ue,l?U:v);const Ge=zg(_.getCameraToCenterDistance(H),Le);let rt=u.bJ(f.textSizeData,I,ee)*Ge/u.bU;l&&(rt*=f.tilePixelRatio/S);const Se=ih(pe,rt);l?(({x:Me,y:ye,z:je}=H.projectTilePoint(ne+Se.x,le+Se.y,b.canonical)),[Me,ye,je]=_n(Me+ae,ye+ce,je+ue,v)):(r&&Se._rotate(-_.angle),Me+=Se.x,ye+=Se.y,je=0);const _e=f.allowVerticalPlacement&&ee.placedOrientation===u.bI.vertical?Math.PI/2:0;for(let ze=0;ze<de;ze++)u.bL(z,Me,ye,je,_e);P&&ee.associatedIconIndex>=0&&(B[ee.associatedIconIndex]={x:Me,y:ye,z:je,angle:_e})}else Ou(de,z)}if(P){L.clear();const Y=f.icon.placedSymbolArray;for(let ee=0;ee<Y.length;ee++){const ne=Y.get(ee),{numGlyphs:le}=ne,de=B[ee];if(ne.hidden||!de)Ou(le,L);else{const{x:pe,y:ae,z:ce,angle:ue}=de;for(let Me=0;Me<le;Me++)u.bL(L,pe,ae,ce,ue)}}f.icon.dynamicLayoutVertexBuffer.updateData(L)}f.text.dynamicLayoutVertexBuffer.updateData(z)}function Jg(f,r,l,p,_,v,b={}){const S=l.paint.get("icon-translate"),I=l.paint.get("text-translate"),P=l.paint.get("icon-translate-anchor"),R=l.paint.get("text-translate-anchor"),z=l.layout.get("icon-rotation-alignment"),L=l.layout.get("text-rotation-alignment"),B=l.layout.get("icon-pitch-alignment"),H=l.layout.get("text-pitch-alignment"),U=l.layout.get("icon-keep-upright"),q=l.layout.get("text-keep-upright"),G=l.paint.get("icon-color-saturation"),Y=l.paint.get("icon-color-contrast"),ee=l.paint.get("icon-color-brightness-min"),ne=l.paint.get("icon-color-brightness-max"),le="sea"===l.layout.get("symbol-elevation-reference"),de=f.context,pe=de.gl,ae=f.transform,ce="map"===z,ue="map"===L,Me="map"===B,ye="map"===H,je=void 0!==l.layout.get("symbol-sort-key").constantOr(1);let Le=!1;const Ge=f.depthModeForSublayer(0,bt.ReadOnly),rt=new bt(f.context.gl.LEQUAL,bt.ReadOnly,f.depthRangeFor3D),Se=[u.aD(ae.center.lng),u.aH(ae.center.lat)],_e=l.layout.get("text-variable-anchor"),ze="globe"===ae.projection.name,Re=[],We=[0,-1,0];for(const Ze of p){const Ye=r.getTile(Ze),ct=Ye.getBucket(l);if(!ct||"mercator"===ct.projection.name&&ze||ct.fullyClipped)continue;const Ct="globe"===ct.projection.name,Lt=Ct?u.ah(ae.zoom):0,vt=kp(Ze,ct.getProjection(),ae),Rt=ae.calculatePixelsToTileUnitsMatrix(Ye),At=_e&&ct.hasTextData(),qt=ct.hasIconTextFit()&&At&&ct.hasIconData(),Kt=ct.getProjection().createInversionMatrix(ae,Ze.canonical),mn=(1<<Ye.tileID.canonical.z)*u.aj/f.transform.worldSize,Dn=ti=>{let Gn=[0,0,0];if(ti){const Fi=f.style.directionalLight,Mn=f.style.ambientLight;Fi&&Mn&&(Gn=qa(f.style,Fi,Mn))}return Gn},Zt=ti=>{ae.depthOcclusionForSymbolsAndCircles&&(l.hasInitialOcclusionOpacityProperties||f.terrain)&&(ti.push("DEPTH_D24"),ti.push("DEPTH_OCCLUSION"))},An=()=>{const ti=ce&&"point"!==l.layout.get("symbol-placement"),Gn=[];Zt(Gn);const Fi=ti||qt,Mn="road"===ct.elevationType,qn=f.shadowRenderer,ci=Mn&&Me&&!!qn&&qn.enabled,mr=Dn(ci),lr=Mn&&Me&&!f.terrain?rt:Ge,tr=l.paint.get("icon-image-cross-fade");f.terrainRenderModeElevated()&&Me&&Gn.push("PITCH_WITH_MAP_TERRAIN"),Ct&&(Gn.push("PROJECTION_GLOBE_VIEW"),Fi&&Gn.push("PROJECTED_POS_ON_VIEWPORT")),tr>0&&ct.hasAnySecondaryIcon&&Gn.push("ICON_TRANSITION"),!ct.icon.zOffsetVertexBuffer||Mn&&f.terrain||Gn.push("Z_OFFSET"),0===G&&0===Y&&0===ee&&1===ne||Gn.push("COLOR_ADJUSTMENT"),ct.sdfIcons&&Gn.push("RENDER_SDF"),ci&&Gn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Mn&&Me&&!f.terrain&&ct.icon.orientationVertexBuffer&&Gn.push("ELEVATED_ROADS");const Vr=ct.icon.programConfigurations.get(l.id),pa=f.getOrCreateProgram("symbol",{config:Vr,defines:Gn}),Ro=Ye.imageAtlasTexture?Ye.imageAtlasTexture.size:[0,0],Bs=ct.iconSizeData,so=u.bH(Bs,ae.zoom),Ys=Me||!ae.isOrthographic,Ks=Nd(vt,Ye.tileID.canonical,Me,ce,ae,ct.getProjection(),Rt),wo=qr(vt,Ye.tileID.canonical,Me,ce,ae,ct.getProjection(),Rt),Zi=f.translatePosMatrix(wo,Ye,S,P,!0),Ji=f.translatePosMatrix(vt,Ye,S,P),wi=Fi?nl:Ks,vr=ce&&!Me&&!ti;let ao=We;!ze&&!ae.mercatorFromTransition||ce||(ao=nh(ae));const cr=Ct?ao:We,Qs=l.getColorAdjustmentMatrix(G,Y,ee,ne),nd=th(Bs.kind,so,vr,Me,f,Ji,wi,Zi,le,!1,Ro,[0,0],0,Ze,Lt,Se,Kt,cr,ct.getProjection(),mr,mn,Qs,tr,null),Qc=Ye.imageAtlasTexture?Ye.imageAtlasTexture:null,id=1!==l.layout.get("icon-size").constantOr(0)||ct.iconsNeedLinear,ll=ct.sdfIcons||f.options.rotating||f.options.zooming||id||Ys?pe.LINEAR:pe.NEAREST,Ho=ct.sdfIcons&&0!==l.paint.get("icon-halo-width").constantOr(1),ma=f.terrain&&Me&&ti?u.bi(u.bz(),Ks):nl;if(ti&&ct.icon){const Tr=ae.elevation,Es=Tr?Tr.getAtTileOffsetFunc(Ze,ae.center.lat,ae.worldSize,ct.getProjection()):null,Js=Bd(vt,Ye.tileID.canonical,Me,ce,ae,ct.getProjection(),Rt);Mu(ct,vt,f,!1,Js,wo,Me,U,Es,Ze)}return{program:pa,buffers:ct.icon,uniformValues:nd,atlasTexture:Qc,atlasTextureIcon:null,atlasInterpolation:ll,atlasInterpolationIcon:null,isSDF:ct.sdfIcons,hasHalo:Ho,depthMode:lr,tile:Ye,renderWithShadows:ci,labelPlaneMatrixInv:ma}},Ln=()=>{const ti=ue&&"point"!==l.layout.get("symbol-placement"),Gn=[],Fi=ti||_e||qt,Mn="road"===ct.elevationType,qn=f.shadowRenderer,ci=Mn&&ye&&!!qn&&qn.enabled,mr=Dn(ci),lr=Mn&&ye&&!f.terrain?rt:Ge;f.terrainRenderModeElevated()&&ye&&Gn.push("PITCH_WITH_MAP_TERRAIN"),Ct&&(Gn.push("PROJECTION_GLOBE_VIEW"),Fi&&Gn.push("PROJECTED_POS_ON_VIEWPORT")),!ct.text.zOffsetVertexBuffer||Mn&&f.terrain||Gn.push("Z_OFFSET"),ct.iconsInText&&Gn.push("RENDER_TEXT_AND_SYMBOL"),Gn.push("RENDER_SDF"),ci&&Gn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Mn&&ye&&!f.terrain&&ct.text.orientationVertexBuffer&&Gn.push("ELEVATED_ROADS"),Zt(Gn);const tr=ct.text.programConfigurations.get(l.id),Vr=f.getOrCreateProgram("symbol",{config:tr,defines:Gn});let pa,Ro=[0,0],Bs=null;const so=ct.textSizeData;ct.iconsInText&&(Ro=Ye.imageAtlasTexture?Ye.imageAtlasTexture.size:[0,0],Bs=Ye.imageAtlasTexture?Ye.imageAtlasTexture:null,pa=ye||!ae.isOrthographic||f.options.rotating||f.options.zooming||"composite"===so.kind||"camera"===so.kind?pe.LINEAR:pe.NEAREST);const Ys=Ye.glyphAtlasTexture?Ye.glyphAtlasTexture.size:[0,0],Ks=l.layout.get("text-size-scale-range"),wo=u.ay(f.scaleFactor,Ks[0],Ks[1]),Zi=u.bH(so,ae.zoom,wo),Ji=Nd(vt,Ye.tileID.canonical,ye,ue,ae,ct.getProjection(),Rt),wi=qr(vt,Ye.tileID.canonical,ye,ue,ae,ct.getProjection(),Rt),vr=f.translatePosMatrix(wi,Ye,I,R,!0),ao=f.translatePosMatrix(vt,Ye,I,R),cr=Fi?nl:Ji,Qs=ue&&!ye&&!ti;let nd=We;!ze&&!ae.mercatorFromTransition||ue||(nd=nh(ae));const Qc=th(so.kind,Zi,Qs,ye,f,ao,cr,vr,le,!0,Ys,Ro,0,Ze,Lt,Se,Kt,Ct?nd:We,ct.getProjection(),mr,mn,null,null,wo),id=Ye.glyphAtlasTexture?Ye.glyphAtlasTexture:null,ll=pe.LINEAR,Ho=0!==l.paint.get("text-halo-width").constantOr(1),ma=f.terrain&&ye&&ti?u.bi(u.bz(),Ji):nl;if(ti&&ct.text){const Tr=ae.elevation,Es=Tr?Tr.getAtTileOffsetFunc(Ze,ae.center.lat,ae.worldSize,ct.getProjection()):null,Js=Bd(vt,Ye.tileID.canonical,ye,ue,ae,ct.getProjection(),Rt);Mu(ct,vt,f,!0,Js,wi,ye,q,Es,Ze)}return{program:Vr,buffers:ct.text,uniformValues:Qc,atlasTexture:id,atlasTextureIcon:Bs,atlasInterpolation:ll,atlasInterpolationIcon:pa,isSDF:!0,hasHalo:Ho,depthMode:lr,tile:Ye,renderWithShadows:ci,labelPlaneMatrixInv:ma}},ei=ct.icon.segments.get().length,un=ct.text.segments.get().length,kn=ei&&!b.onlyText?An():null,zn=un&&!b.onlyIcons?Ln():null,In=l.paint.get("icon-opacity").constantOr(1),on=l.paint.get("text-opacity").constantOr(1);if(je&&ct.canOverlap){Le=!0;const ti=In&&!b.onlyText?ct.icon.segments.get():[],Gn=on&&!b.onlyIcons?ct.text.segments.get():[];for(const Fi of ti)Re.push({segments:new u.bd([Fi]),sortKey:Fi.sortKey,state:kn});for(const Fi of Gn)Re.push({segments:new u.bd([Fi]),sortKey:Fi.sortKey,state:zn})}else b.onlyText||Re.push({segments:In?ct.icon.segments:new u.bd([]),sortKey:0,state:kn}),b.onlyIcons||Re.push({segments:on?ct.text.segments:new u.bd([]),sortKey:0,state:zn})}Le&&Re.sort((Ze,Ye)=>Ze.sortKey-Ye.sortKey);for(const Ze of Re){const Ye=Ze.state;if(Ye)if(f.terrain?f.terrain.setupElevationDraw(Ye.tile,Ye.program,{useDepthForOcclusion:ae.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Ye.labelPlaneMatrixInv}):f.setupDepthForOcclusion(ae.depthOcclusionForSymbolsAndCircles,Ye.program),de.activeTexture.set(pe.TEXTURE0),Ye.atlasTexture&&Ye.atlasTexture.bind(Ye.atlasInterpolation,pe.CLAMP_TO_EDGE,!0),Ye.atlasTextureIcon&&(de.activeTexture.set(pe.TEXTURE1),Ye.atlasTextureIcon&&Ye.atlasTextureIcon.bind(Ye.atlasInterpolationIcon,pe.CLAMP_TO_EDGE,!0)),Ye.renderWithShadows&&f.shadowRenderer.setupShadows(Ye.tile.tileID.toUnwrapped(),Ye.program,"vector-tile"),f.uploadCommonLightUniforms(f.context,Ye.program),Ye.hasHalo){const ct=Ye.uniformValues;ct.u_is_halo=1,Wl(Ye.buffers,Ze.segments,l,f,Ye.program,Ye.depthMode,_,v,ct,2),ct.u_is_halo=0}else{if(Ye.isSDF){const ct=Ye.uniformValues;Ye.hasHalo&&(ct.u_is_halo=1,Wl(Ye.buffers,Ze.segments,l,f,Ye.program,Ye.depthMode,_,v,ct,1)),ct.u_is_halo=0}Wl(Ye.buffers,Ze.segments,l,f,Ye.program,Ye.depthMode,_,v,Ye.uniformValues,1)}}}function Wl(f,r,l,p,_,v,b,S,I,P){const R=[f.dynamicLayoutVertexBuffer,f.opacityVertexBuffer,f.iconTransitioningVertexBuffer,f.globeExtVertexBuffer,f.zOffsetVertexBuffer,f.orientationVertexBuffer];_.draw(p,p.context.gl.TRIANGLES,v,b,S,Nt.disabled,I,l.id,f.layoutVertexBuffer,f.indexBuffer,r,l.paint,p.transform.zoom,f.programConfigurations.get(l.id),R,P)}function Hu(f,r){const l=1<<f.canonical.z,p=(r.x*l-f.canonical.x-f.wrap*l)*u.aj,_=(r.y*l-f.canonical.y)*u.aj,v=u.e2(r.z,r.y);return u.d2(p,_,v)}function wt(f,r,l,p,_){if(!l.layout||"none"===l.layout.get("fill-elevation-reference"))return;const v=f.context.gl,b=new bt(f.context.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D),S=new bt(f.context.gl.GREATER,bt.ReadWrite,f.depthRangeFor3D),I=function(B){const H=u.cU(B.pitch);let U=.01;return B.isOrthographic&&(U=u.ai(1e-4,U,u.cZ(H>=15?1:H/15))),2*U}(f.transform),P=f.transform.getFreeCameraOptions().position,R="elevatedStructuresDepthReconstruct",z=f.getOrCreateProgram(R,{defines:["DEPTH_RECONSTRUCTION"]}),L=f.getOrCreateProgram(R);for(const B of p){const H=r.getTile(B),U=H.getBucket(l);if(!U)continue;const q=U.elevatedStructures;if(!q)continue;const G=U.elevationBufferData.heightRange,Y=Hu(B.toUnwrapped(),P),ee=f.translatePosMatrix(B.projMatrix,H,l.paint.get("fill-translate"),l.paint.get("fill-translate-anchor"));let ne,le,de,pe;if("initialize"===_){if(!G||G.min>=1||0===q.depthSegments.segments[0].primitiveLength)continue;ne=Qp(ee,Y,I,1,0),le=b,de=q.depthSegments,pe=z}else if("reset"===_){if(!G||G.min>=0||0===q.maskSegments.segments[0].primitiveLength)continue;ne=Qp(ee,Y,0,0,1),le=S,de=q.maskSegments,pe=z}else if("geometry"===_){if(0===q.depthSegments.segments[0].primitiveLength)continue;ne=Qp(ee,Y,I,1,0),le=b,de=q.depthSegments,pe=L}pe.draw(f,v.TRIANGLES,le,Bt.disabled,an.disabled,Nt.disabled,ne,l.id,q.vertexBuffer,q.indexBuffer,de,l.paint,f.transform.zoom)}}function If(f,r,l){const{painter:p,sourceCache:_,layer:v,coords:b,colorMode:S,elevationType:I,terrainEnabled:P,pass:R}=f,z=p.context.gl,L=v.paint.get("fill-pattern"),B=v.paint.get("fill-pattern-cross-fade"),H=L.constantOr(null);let U=I;"road"!==I||r&&!P||(U="none");const q="road"===U,G=f.painter.shadowRenderer,Y=q&&!!G&&G.enabled,ee=new bt(p.context.gl.LEQUAL,bt.ReadOnly,p.depthRangeFor3D);let ne=[0,0,0];if(Y){const pe=p.style.directionalLight,ae=p.style.ambientLight;pe&&ae&&(ne=qa(p.style,pe,ae))}const le=L&&L.constantOr(1),de=(pe,ae)=>{let ce,ue,Me,ye,je;ae?(ce=le&&!v.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Me=z.LINES):(ce=le?"fillPattern":"fill",Me=z.TRIANGLES);for(const Le of b){const Ge=_.getTile(Le);if(le&&!Ge.patternsLoaded())continue;const rt=Ge.getBucket(v);if(!rt)continue;const Se=r?rt.elevationBufferData:rt.bufferData;if(Se.isEmpty())continue;p.prepareDrawTile();const _e=Se.programConfigurations.get(v.id),ze=p.isTileAffectedByFog(Le),Re=[],We=[];q&&(Re.push("ELEVATED_ROADS"),We.push(Se.elevatedLayoutVertexBuffer)),Y&&Re.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),le&&(p.context.activeTexture.set(z.TEXTURE0),Ge.imageAtlasTexture&&Ge.imageAtlasTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),_e.updatePaintBuffers());let Ze=!1;if(H&&Ge.imageAtlas){const vt=Ge.imageAtlas,Rt=u.dZ.from(H),At=Rt.getPrimary().scaleSelf(u.q.devicePixelRatio).toString(),qt=Rt.getSecondary(),Kt=vt.patternPositions.get(At),mn=qt?vt.patternPositions.get(qt.scaleSelf(u.q.devicePixelRatio).toString()):null;Ze=!!Kt&&!!mn,Kt&&_e.setConstantPatternPositions(Kt,mn)}B>0&&(Ze||_e.getPatternTransitionVertexBuffer("fill-pattern"))&&Re.push("FILL_PATTERN_TRANSITION");const Ye=p.getOrCreateProgram(ce,{config:_e,overrideFog:ze,defines:Re}),ct=p.translatePosMatrix(Le.projMatrix,Ge,v.paint.get("fill-translate"),v.paint.get("fill-translate-anchor"));Y&&G.setupShadows(Ge.tileID.toUnwrapped(),Ye,"vector-tile");const Ct=v.paint.get("fill-emissive-strength");if(ae){ye=Se.lineIndexBuffer,je=Se.lineSegments;const vt=p.terrain&&p.terrain.renderingToTexture?p.terrain.drapeBufferSize:[z.drawingBufferWidth,z.drawingBufferHeight];ue="fillOutlinePattern"===ce&&le?Zg(ct,Ct,p,Ge,vt,ne,B):Wg(ct,Ct,vt,ne)}else ye=Se.indexBuffer,je=Se.triangleSegments,ue=le?dv(ct,Ct,p,Ge,ne,B):uv(ct,Ct,ne);p.uploadCommonUniforms(p.context,Ye,Le.toUnwrapped());let Lt=pe;("road"===I&&!P||"offset"===I)&&(Lt=ee),Ye.draw(p,Me,Lt,l||p.stencilModeForClipping(Le),S,Nt.disabled,ue,v.id,Se.layoutVertexBuffer,ye,je,v.paint,p.transform.zoom,_e,We)}};p.renderPass===R&&de(p.depthModeForSublayer(1,"opaque"===p.renderPass?bt.ReadWrite:bt.ReadOnly),!1),"none"===U&&"translucent"===p.renderPass&&v.paint.get("fill-antialias")&&de(p.depthModeForSublayer(v.getPaintProperty("fill-outline-color")?2:0,bt.ReadOnly),!0)}function rh(f,r,l,p,_,v,b,S){l.resetLayerRenderingStats(f);const I=f.context,P=I.gl,R=f.transform,z=l.paint.get("fill-extrusion-pattern"),L=l.paint.get("fill-extrusion-pattern-cross-fade"),B=z.constantOr(null),H=z.constantOr(1),U=l.paint.get("fill-extrusion-opacity"),q=f.style.enable3dLights(),G=l.paint.get(q&&!H?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Y=[l.paint.get("fill-extrusion-ambient-occlusion-intensity"),G],ee=l.layout.get("fill-extrusion-edge-radius"),ne=ee>0&&!l.paint.get("fill-extrusion-rounded-roof"),le=ne?0:ee,de="globe"===R.projection.name?u.e5():0,pe="globe"===R.projection.name,ae=pe?u.ah(R.zoom):0,ce=[u.aD(R.center.lng),u.aH(R.center.lat)],ue="none"===l.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),Me=l.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(ue?null:l.lut).toArray01().slice(0,3),ye=l.paint.get("fill-extrusion-flood-light-intensity"),je=l.paint.get("fill-extrusion-vertical-scale"),Le=0!==l.paint.get("fill-extrusion-line-width").constantOr(1),Ge=l.paint.get("fill-extrusion-height-alignment"),rt=l.paint.get("fill-extrusion-base-alignment"),Se=mo(f,l.paint.get("fill-extrusion-cutoff-fade-range")),_e=[];let ze;pe&&_e.push("PROJECTION_GLOBE_VIEW"),Y[0]>0&&_e.push("FAUX_AO"),ne&&_e.push("ZERO_ROOF_RADIUS"),S&&_e.push("HAS_CENTROID"),ye>0&&_e.push("FLOOD_LIGHT"),Se.shouldRenderCutoff&&_e.push("RENDER_CUTOFF"),Le&&_e.push("RENDER_WALL_MODE");const Re="shadow"===f.renderPass,We=f.shadowRenderer,Ze=Re&&!!We,Ye=Re?Nt.disabled:Nt.backCCW;f.shadowRenderer&&(f.shadowRenderer.useNormalOffset=!0);let ct=[0,0,0];if(We){const vt=f.style.directionalLight,Rt=f.style.ambientLight;vt&&Rt&&(ct=qa(f.style,vt,Rt)),Re||(_e.push("RENDER_SHADOWS","DEPTH_TEXTURE"),We.useNormalOffset&&_e.push("NORMAL_OFFSET")),ze=_e.concat(["SHADOWS_SINGLE_CASCADE"])}const Ct=Ze?"fillExtrusionDepth":H?"fillExtrusionPattern":"fillExtrusion",Lt=l.getLayerRenderingStats();for(const vt of p){const Rt=r.getTile(vt),At=Rt.getBucket(l);if(!At||At.projection.name!==R.projection.name)continue;let qt=!1;We&&(qt=0===We.getMaxCascadeForTile(vt.toUnwrapped()));const Kt=f.isTileAffectedByFog(vt),mn=At.programConfigurations.get(l.id);let Dn=!1;if(B&&Rt.imageAtlas){const zn=Rt.imageAtlas,In=u.dZ.from(B),on=In.getPrimary().scaleSelf(u.q.devicePixelRatio).toString(),ti=In.getSecondary(),Gn=zn.patternPositions.get(on),Fi=ti?zn.patternPositions.get(ti.scaleSelf(u.q.devicePixelRatio).toString()):null;Dn=!!Gn&&!!Fi,Gn&&mn.setConstantPatternPositions(Gn,Fi)}L>0&&(Dn||mn.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&_e.push("FILL_EXTRUSION_PATTERN_TRANSITION");const Zt=f.getOrCreateProgram(Ct,{config:mn,defines:qt?ze:_e,overrideFog:Kt});if(f.terrain&&f.terrain.setupElevationDraw(Rt,Zt,{useMeterToDem:!0}),!At.centroidVertexBuffer){const zn=Zt.attributes.a_centroid_pos;void 0!==zn&&P.vertexAttrib2f(zn,0,0)}!Re&&We&&We.setupShadows(Rt.tileID.toUnwrapped(),Zt,"vector-tile"),H&&(f.context.activeTexture.set(P.TEXTURE0),Rt.imageAtlasTexture&&Rt.imageAtlasTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),mn.updatePaintBuffers());const An=l.paint.get("fill-extrusion-vertical-gradient"),Ln=1/At.tileToMeter;let ei;if(Re&&We){if(Af(Rt.tileID,At.maxHeight,f))continue;const zn=We.calculateShadowPassMatrixFromTile(Rt.tileID.toUnwrapped());ei=cv(zn,le,Ln,je,Ge,rt)}else{const zn=f.translatePosMatrix(vt.expandedProjMatrix,Rt,l.paint.get("fill-extrusion-translate"),l.paint.get("fill-extrusion-translate-anchor")),In=R.projection.createInversionMatrix(R,vt.canonical);ei=H?Qd(zn,f,An,U,Y,le,Ln,vt,Rt,de,Ge,rt,ae,ce,In,Me,je,L):qg(zn,f,An,U,Y,le,Ln,vt,de,Ge,rt,ae,ce,In,Me,je,ye,ct)}f.uploadCommonUniforms(I,Zt,vt.toUnwrapped(),null,Se);let un=At.segments;if("mercator"===R.projection.name&&!Re&&(un=At.getVisibleSegments(Rt.tileID,f.terrain,f.transform.getFrustum(0)),!un.get().length))continue;if(Lt)if(Re)for(const zn of un.get())Lt.numRenderedVerticesInShadowPass+=zn.primitiveLength;else for(const zn of un.get())Lt.numRenderedVerticesInTransparentPass+=zn.primitiveLength;const kn=[];(f.terrain||S)&&kn.push(At.centroidVertexBuffer),pe&&kn.push(At.layoutVertexExtBuffer),Le&&kn.push(At.wallVertexBuffer),Zt.draw(f,I.gl.TRIANGLES,_,v,b,Ye,ei,l.id,At.layoutVertexBuffer,At.indexBuffer,un,l.paint,f.transform.zoom,mn,kn)}f.shadowRenderer&&(f.shadowRenderer.useNormalOffset=!1)}class il{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function jo(f,r,l,p,_,v,b,S,I,P,R,z,L,B,H,U,q,G,Y,ee){const ne=r.context,le=ne.gl,de=r.transform,pe=r.transform.zoom,ae=[],ce=f.translate,ue=f.translateAnchor,Me=f.edgeRadius,ye=mo(r,f.cutoffFadeRange);"clear"===R?(ae.push("CLEAR_SUBPASS"),ee&&(ae.push("CLEAR_FROM_TEXTURE"),ne.activeTexture.set(le.TEXTURE0),ee.bind(le.LINEAR,le.CLAMP_TO_EDGE))):"sdf"===R&&ae.push("SDF_SUBPASS"),G&&ae.push("HAS_CENTROID"),ye.shouldRenderCutoff&&ae.push("RENDER_CUTOFF");const je=(Le,Ge,rt,Se,_e)=>{const ze=Ge.programConfigurations.get(p.id),Re=r.isTileAffectedByFog(Le),We=r.getOrCreateProgram("fillExtrusionGroundEffect",{config:ze,defines:ae,overrideFog:Re}),Ze={u_matrix:Se,u_opacity:z,u_ao_pass:P?1:0,u_meter_to_tile:_e,u_ao:[L,B*_e],u_flood_light_intensity:H,u_flood_light_color:U,u_attenuation:q,u_edge_radius:pe>=17?0:Me*_e,u_fb:0,u_fb_size:ee?ee.size[0]:0,u_dynamic_offset:1},Ye=[];G&&Ye.push(Ge.hiddenByLandmarkVertexBuffer),r.uploadCommonUniforms(ne,We,Le.toUnwrapped(),null,ye),We.draw(r,ne.gl.TRIANGLES,v,b,S,I,Ze,p.id,Ge.vertexBuffer,Ge.indexBuffer,rt,p.paint,pe,ze,Ye)};for(const Le of _){const Ge=l.getTile(Le),rt=Ge.getBucket(p);if(!rt||rt.projection.name!==de.projection.name||!rt.groundEffect||rt.groundEffect&&!rt.groundEffect.hasData())continue;const Se=rt.groundEffect,_e=1/rt.tileToMeter;{const ze=r.translatePosMatrix(Le.projMatrix,Ge,ce,ue),Re=Se.getDefaultSegment();je(Le,Se,Re,ze,_e)}if(Y)for(let ze=0;ze<4;ze++){const Re=u.e3[ze](Le),We=l.getTile(Re);if(!We)continue;const Ze=We.getBucket(p);if(!Ze||Ze.projection.name!==de.projection.name||!Ze.groundEffect||Ze.groundEffect&&!Ze.groundEffect.hasData())continue;const Ye=Ze.groundEffect;let ct,Ct;0===ze?(ct=[-u.aj,0,0],Ct=1):1===ze?(ct=[u.aj,0,0],Ct=0):2===ze?(ct=[0,-u.aj,0],Ct=3):(ct=[0,u.aj,0],Ct=2);const Lt=Ye.regionSegments[Ct];if(!Lt)continue;const vt=new Float32Array(16);u.bo(vt,Le.projMatrix,ct),je(Le,Ye,Lt,r.translatePosMatrix(vt,Ge,ce,ue),_e)}}}function Vt(f,r,l,p,_,v,b){0===p.centroidVertexArray.length&&p.createCentroidsBuffer();const S=v?v.findDEMTileFor(l):null;if(!(S&&S.dem||b))return;v&&S&&S.dem&&p.selfDEMTileTimestamp!==S.dem._timestamp&&(p.borderDoneWithNeighborZ=[-1,-1,-1,-1],p.selfDEMTileTimestamp=S.dem._timestamp);const I=G=>new u.P(Math.ceil((G+u.e7)*u.e8),0),P=G=>{const Y=r.getSource().minzoom,ee=le=>{const de=r.getTileByID(le);if(de&&de.hasData())return de.getBucket(_)},ne=[0,-1,1];for(const le of ne){if(G.overscaledZ+le<Y)continue;const de=ee(G.calculateScaledKey(G.overscaledZ+le));if(de)return de}},R=[0,0,0],z=(G,Y)=>(R[0]=Math.min(G.min.y,Y.min.y),R[1]=Math.max(G.max.y,Y.max.y),R[2]=u.aj-Y.min.x>G.max.x?Y.min.x-u.aj:G.max.x,R),L=(G,Y)=>(R[0]=Math.min(G.min.x,Y.min.x),R[1]=Math.max(G.max.x,Y.max.x),R[2]=u.aj-Y.min.y>G.max.y?Y.min.y-u.aj:G.max.y,R),B=[(G,Y)=>z(G,Y),(G,Y)=>z(Y,G),(G,Y)=>L(G,Y),(G,Y)=>L(Y,G)],H=(G,Y,ee,ne,le,de,pe)=>{if(!v)return 0;const ae=[[de?ee:G,de?G:ee,0],[de?ee:Y,de?Y:ee,0]],ce=pe<0?u.aj+pe:pe,ue=[de?ce:(G+Y)/2,de?(G+Y)/2:ce,0];return 0===ee&&pe<0||0!==ee&&pe>0?v.getForTilePoints(le,[ue],!0,ne):ae.push(ue),v.getForTilePoints(l,ae,!0,S),Math.max(ae[0][2],ae[1][2],ue[2])/v.exaggeration()};for(let G=0;G<4;G++){const Y=p.borderFeatureIndices[G];if(0===Y.length)continue;const ee=u.e3[G](l),ne=P(ee);if(!(ne&&ne instanceof u.e4))continue;const le=v?v.findDEMTileFor(ee):null;if(!(le&&le.dem||b)||(v&&le&&le.dem&&p.borderDEMTileTimestamp[G]!==le.dem._timestamp&&(p.borderDoneWithNeighborZ[G]=-1,p.borderDEMTileTimestamp[G]=le.dem._timestamp),p.borderDoneWithNeighborZ[G]===ne.canonical.z))continue;0===ne.centroidVertexArray.length&&ne.createCentroidsBuffer();const de=(G<2?1:5)-G,pe=ne.borderDoneWithNeighborZ[de]!==p.canonical.z,ae=ne.borderFeatureIndices[de];let ce=0;if(p.canonical.z!==ne.canonical.z){for(const ue of Y)p.showCentroid(p.featuresOnBorder[ue]);if(pe)for(const ue of ae)ne.showCentroid(ne.featuresOnBorder[ue]);p.borderDoneWithNeighborZ[G]=ne.canonical.z,ne.borderDoneWithNeighborZ[de]=p.canonical.z}for(const ue of Y){const Me=p.featuresOnBorder[ue],ye=p.centroidData[Me.centroidDataIndex],je=Me.borders[G];let Le;for(;ce<ae.length;){Le=ne.featuresOnBorder[ae[ce]];const Ge=Le.borders[de];if(Ge[1]>je[0]+3||Ge[0]>je[0]-3)break;ne.showCentroid(Le),ce++}if(Le&&ce<ae.length){const Ge=ce;let rt=0;for(;!(Le.borders[de][0]>je[1]-3)&&(rt++,++ce!==ae.length);)Le=ne.featuresOnBorder[ae[ce]];Le=ne.featuresOnBorder[ae[Ge]];let Se=!1;if(rt>=1){const Re=Le.borders[de];Math.abs(je[0]-Re[0])<3&&Math.abs(je[1]-Re[1])<3&&(rt=1,Se=!0,ce=Ge+1)}else if(0===rt){p.showCentroid(Me);continue}const _e=ne.centroidData[Le.centroidDataIndex];b&&Se&&(((U=ye).flags|(q=_e).flags)&u.e6?(U.flags|=u.e6,q.flags|=u.e6):(U.flags&=~u.e6,q.flags&=~u.e6));const ze=Me.intersectsCount()>1||Le.intersectsCount()>1;if(rt>1)ce=Ge,ye.centroidXY=_e.centroidXY=new u.P(0,0);else if(le&&le.dem&&!ze){const Re=B[G](ye,_e),We=G%2?u.aj-1:0,Ze=H(Re[0],Math.min(u.aj-1,Re[1]),We,le,ee,G<2,Re[2]);ye.centroidXY=_e.centroidXY=I(Ze)}else ze?ye.centroidXY=_e.centroidXY=new u.P(0,0):(ye.centroidXY=p.encodeBorderCentroid(Me),_e.centroidXY=ne.encodeBorderCentroid(Le));p.writeCentroidToBuffer(ye),ne.writeCentroidToBuffer(_e)}else p.showCentroid(Me)}p.borderDoneWithNeighborZ[G]=ne.canonical.z,ne.borderDoneWithNeighborZ[de]=p.canonical.z}var U,q;(p.needsCentroidUpdate||!p.centroidVertexBuffer&&0!==p.centroidVertexArray.length)&&p.uploadCentroid(f)}const Cf=[1,0,0],pv=[0,1,0],kx=[0,0,1];function Af(f,r,l){const p=l.transform,_=l.shadowRenderer;if(!_)return!0;const v=f.toUnwrapped(),b=p.tileSize*_._cascades[l.currentShadowCascade].scale;let S=r;if(p.elevation){const U=p.elevation.getMinMaxForTile(f);U&&(S+=U.max)}const I=[..._.shadowDirection];I[2]=-I[2];const P=_.computeSimplifiedTileShadowVolume(v,S,b,I);if(!P)return!1;const R=[Cf,pv,kx,I,[I[0],0,I[2]],[0,I[1],I[2]]],z="globe"===p.projection.name,L=p.scaleZoom(b),B=u.cy.fromInvProjectionMatrix(p.invProjMatrix,p.worldSize,L,!z),H=_.getCurrentCascadeFrustum();return 0===B.intersectsPrecise(P.vertices,P.planes,R)||0===H.intersectsPrecise(P.vertices,P.planes,R)}function Vc(f){const{painter:r,source:l,layer:p,coords:_}=f,v=f.defines,b=r.context,S="shadow"===r.renderPass,I="light-beam"===r.renderPass,P=r.shadowRenderer;let R;P&&(R=v.concat(["SHADOWS_SINGLE_CASCADE"]));const z=u.e9(r.transform.center.lat,r.transform.zoom);for(const L of _){const B=l.getTile(L),H=B.getBucket(p);if(!H)continue;let U=!1;P&&(U=0===P.getMaxCascadeForTile(L.toUnwrapped()));const q=H.programConfigurations.get(p.id);let G,Y,ee=r.translatePosMatrix(L.expandedProjMatrix,B,[0,0],"map");if(ee=u.cP(u.bz(),ee,[1,1,f.verticalScale]),S&&P){if(Af(B.tileID,H.maxHeight*z,r))continue;let ne=P.calculateShadowPassMatrixFromTile(B.tileID.toUnwrapped());ne=u.cP(u.bz(),ne,[1,1,f.verticalScale]),Y=Qa(ne),G=r.getOrCreateProgram("buildingDepth",{config:q,defines:U?R:v,overrideFog:!1})}else if(I)G=r.getOrCreateProgram("buildingBloom",{config:q,defines:U?R:v,overrideFog:!1}),Y=Ka(ee);else{const ne=r.transform.calculatePosMatrix(L.toUnwrapped(),r.transform.worldSize);u.cP(ne,ne,[1,1,f.verticalScale]);const le=u.bz();u.cP(le,ne,[1,-1,1/z]),u.bi(le,le),u.ea(le,le),Y=Xg(ee,le),G=r.getOrCreateProgram("building",{config:q,defines:U?R:v,overrideFog:!1}),P&&P.setupShadowsFromMatrix(ne,G,!0)}if(r.uploadCommonUniforms(b,G,L.toUnwrapped(),null,null),I){const ne=H.bloomGeometry;G.draw(r,b.gl.TRIANGLES,f.depthMode,Bt.disabled,f.blendMode,Nt.disabled,Y,p.id,ne.layoutVertexBuffer,ne.indexBuffer,ne.segmentsBucket,p.paint,r.transform.zoom,q,[ne.layoutAttenuationBuffer,ne.layoutColorBuffer])}else G.draw(r,b.gl.TRIANGLES,f.depthMode,Bt.disabled,f.blendMode,S?Nt.disabled:Nt.backCW,Y,p.id,H.layoutVertexBuffer,H.indexBuffer,H.segments,p.paint,r.transform.zoom,q,[H.layoutNormalBuffer,H.layoutColorBuffer])}}function nm(f){return[f[0]*u.eb,f[1]*u.eb,f[2]*u.eb,0]}function Mf(f,r,l,p,_,v,b,S,I){const P=p.getSource(),R=l.globeSharedBuffers;if(!R)return;let z,L,B;if(r&&(z=p.getTile(r)),P instanceof u.aP?(L=P.texture,B=u.dE(0,0,l.transform)):z&&r&&(L=z.texture,B=u.dE(r.canonical.z,r.canonical.x,l.transform)),!L||!B)return;f||(B=u.cP(u.bz(),B,[1,-1,1]));const H=l.context,U=H.gl,q="nearest"===_.paint.get("raster-resampling")?U.NEAREST:U.LINEAR,G=l.colorModeForDrapableLayerRenderPass(v),Y=b.defines;Y.push("GLOBE_POLES");const ee=new bt(U.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),ne=Float32Array.from(l.transform.expandedFarZProjMatrix),le=Float32Array.from(u.bh(u.dD(new u.cA(0,0,0))));l.terrain&&l.terrain.prepareDrawTile(),H.activeTexture.set(U.TEXTURE0),L.bind(q,U.CLAMP_TO_EDGE),H.activeTexture.set(U.TEXTURE1),L.bind(q,U.CLAMP_TO_EDGE),"useMipmap"in L&&H.extTextureFilterAnisotropic&&l.transform.pitch>20&&U.texParameterf(U.TEXTURE_2D,H.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,H.extTextureFilterAnisotropicMax);const[de,pe,ae,ce]=r?R.getPoleBuffers(r.canonical.z,!1):R.getPoleBuffers(0,!0),ue=_.paint.get("raster-elevation");let Me;f?(Me=de,l.renderDefaultNorthPole=0!==ue):(Me=pe,l.renderDefaultSouthPole=0!==ue);const ye=nm(b.mix),je=(Ge=ne,rt=le,Se=B,_e=u.ah(l.transform.zoom),Re=_,Ze=ue,ct=ye,Ct=b.offset,Lt=b.range,vt=v,wf(Ge,rt,Se,new Float32Array(16),new Float32Array(9),[0,0],_e,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Re,[0,0],Ze,2,ct,Ct,Lt,1,0,vt)),Le=l.getOrCreateProgram("raster",{defines:Y});var Ge,rt,Se,_e,Re,Ze,ct,Ct,Lt,vt;l.uploadCommonUniforms(H,Le,null),Le.draw(l,U.TRIANGLES,ee,I,G,S,je,_.id,Me,ae,ce)}function mv(f){const r=f._nearZ,l=f.projection.farthestPixelDistance(f),p=l-r,_=.2*f.height,v=r+_;return[r,l,(v-_-r)/p,(v-r)/p]}function e_(f,r,l,p){if(f)return r instanceof Rl&&f instanceof kl?r.getTextureDescriptor(f,l,!0):{texture:f.texture,mix:nm(p.mix),offset:p.offset,buffer:0,tileSize:1}}var rs=u.ec([{name:"a_index",type:"Int16",components:1}]);class im{constructor(r,l,p,_){const v={width:p[0],height:p[1],data:null},b=r.gl;this.targetColorTexture=new u.T(r,v,b.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new u.T(r,v,b.RGBA8,{useMipmap:!1}),this.context=r,this.updateParticleTexture(l,_),this.lastInvalidatedAt=0}updateParticleTexture(r,l){if(this.particleTextureDimension===l.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const p=this.context.gl,_=l.width*l.height;this.particleTexture0=new u.T(this.context,l,p.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new u.T(this.context,l,p.RGBA8,{premultiply:!1,useMipmap:!1});const v=new u.ed;v.reserve(_);for(let b=0;b<_;b++)v.emplaceBack(b);this.particleIndexBuffer=this.context.createVertexBuffer(v,rs.members,!0),this.particleSegment=u.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=l.width}update(r){return!(this.lastInvalidatedAt<r&&(this.lastInvalidatedAt=u.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function vo(f,r,l){if(!f)return null;const p=r.getTextureDescriptor(f,l,!0);if(!p)return null;let{texture:_,mix:v,offset:b,tileSize:S,buffer:I,format:P}=p;if(!_||!P)return null;let R=!1;return"uint32"===P&&(R=!0,v[3]=0,v=is(u.ee,v,[0,l.paint.get("raster-particle-max-speed")]),b=Ja(u.ee,b,[0,l.paint.get("raster-particle-max-speed")])),{texture:_,textureOffset:[I/(S+2*I),S/(S+2*I)],tileSize:S,scalarData:R,scale:v,offset:b,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[P]]}}function Zl(f){const r=f._nearZ,l=f.projection.farthestPixelDistance(f),p=l-r,_=.2*f.height,v=r+_;return[r,l,(v-_-r)/p,(v-r)/p]}const ua=new u.am(1,0,0,1),Pf=new u.am(0,1,0,1),Rf=new u.am(0,0,1,1),ar=new u.am(1,0,1,1),Of=new u.am(0,1,1,1);function zs(f,r,l,p,_,v){for(let b=0;b<l.length;b++)if(_){const P=new u.am(.8*p.r,.8*p.g,.8*p.b,1);Tn(f,r,l[b],p,-1,-1,v),Tn(f,r,l[b],p,-1,1,v),Tn(f,r,l[b],p,1,1,v),Tn(f,r,l[b],p,1,-1,v),Tn(f,r,l[b],P,0,0,v)}else Tn(f,r,l[b],p,0,0,v)}function Tn(f,r,l,p,_,v,b){const S=f.context,I=f.transform,P=S.gl,R="globe"===I.projection.name,z=R?["PROJECTION_GLOBE_VIEW"]:[];let L=u.bw(l.projMatrix);if(R&&u.ah(I.zoom)>0){const ye=u.bg(l.canonical,I),je=u.ef(ye);L=u.az(new Float32Array(16),I.globeMatrix,je),u.az(L,I.projMatrix,L)}const B=u.bz();B[12]+=2*_/(u.q.devicePixelRatio*I.width),B[13]+=2*v/(u.q.devicePixelRatio*I.height),u.az(L,B,L);const H=f.getOrCreateProgram("debug",{defines:z}),U=r.getTileByID(l.key);f.terrain&&f.terrain.setupElevationDraw(U,H);const q=bt.disabled,G=Bt.disabled,Y=f.colorModeForRenderPass();S.activeTexture.set(P.TEXTURE0),f.emptyTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),R?U._makeGlobeTileDebugBuffers(f.context,I):U._makeDebugTileBoundsBuffers(f.context,I.projection);const ne=U._tileDebugBuffer||f.debugBuffer,le=U._tileDebugIndexBuffer||f.debugIndexBuffer,de=U._tileDebugSegments||f.debugSegments;if(H.draw(f,P.LINE_STRIP,q,G,Y,Nt.disabled,Yg(L,p.toPremultipliedRenderColor(null)),"$debug",ne,le,de,null,null,null,[U._globeTileDebugBorderBuffer]),b){const ye=U.latestRawTileData,je=Math.floor((ye&&ye.byteLength||0)/1024);let Le=l.canonical.toString();l.overscaledZ!==l.canonical.z&&(Le+=` => ${l.overscaledZ}`),Le+=` ${U.state}`,Le+=` ${je}kb`,function(Ge,rt){Ge.initDebugOverlayCanvas();const Se=Ge.debugOverlayCanvas,_e=Ge.context.gl,ze=Ge.debugOverlayCanvas.getContext("2d");ze.clearRect(0,0,Se.width,Se.height),ze.shadowColor="white",ze.shadowBlur=2,ze.lineWidth=1.5,ze.strokeStyle="white",ze.textBaseline="top",ze.font="bold 36px Open Sans, sans-serif",ze.fillText(rt,5,5),ze.strokeText(rt,5,5),Ge.debugOverlayTexture.update(Se),Ge.debugOverlayTexture.bind(_e.LINEAR,_e.CLAMP_TO_EDGE)}(f,Le)}const pe=r.getTile(l).tileSize,ae=512/Math.min(pe,512)*(l.overscaledZ/I.zoom)*.5,ce=U._tileDebugTextBuffer||f.debugBuffer,ue=U._tileDebugTextIndexBuffer||f.quadTriangleIndexBuffer,Me=U._tileDebugTextSegments||f.debugSegments;H.draw(f,P.TRIANGLES,q,G,an.alphaBlended,Nt.disabled,Yg(L,u.am.transparent.toPremultipliedRenderColor(null),ae),"$debug",ce,ue,Me,null,null,null,[U._globeTileDebugTextBuffer])}function oh(f,r,l,p){Pa(f,0,r+l/2,f.transform.width,l,p)}function sh(f,r,l,p){Pa(f,r-l/2,0,l,f.transform.height,p)}function Pa(f,r,l,p,_,v){const b=f.context,S=b.gl;S.enable(S.SCISSOR_TEST),S.scissor(r*u.q.devicePixelRatio,l*u.q.devicePixelRatio,p*u.q.devicePixelRatio,_*u.q.devicePixelRatio),b.clear({color:v}),S.disable(S.SCISSOR_TEST)}const ys=u.ec([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:t_}=ys;function Xl(f,r,l,p){f.emplaceBack(r,l,p)}class jc{constructor(r){this.vertexArray=new u.eg,this.indices=new u.a_,Xl(this.vertexArray,-1,-1,1),Xl(this.vertexArray,1,-1,1),Xl(this.vertexArray,-1,1,1),Xl(this.vertexArray,1,1,1),Xl(this.vertexArray,-1,-1,-1),Xl(this.vertexArray,1,-1,-1),Xl(this.vertexArray,-1,1,-1),Xl(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=r.createVertexBuffer(this.vertexArray,t_),this.indexBuffer=r.createIndexBuffer(this.indices),this.segment=u.bd.simpleSegment(0,0,36,12)}}function xo(f,r,l,p,_,v){const b=f.context.gl,S=r.paint.get("sky-atmosphere-color"),I=r.paint.get("sky-atmosphere-halo-color"),P=r.paint.get("sky-atmosphere-sun-intensity"),R=(z=u.ei(u.dJ(),p),L=_,B=P,H=S.toPremultipliedRenderColor(null),U=I.toPremultipliedRenderColor(null),{u_matrix_3f:z,u_sun_direction:L,u_sun_intensity:B,u_color_tint_r:[H.r,H.g,H.b,H.a],u_color_tint_m:[U.r,U.g,U.b,U.a],u_luminance:5e-5});var z,L,B,H,U;b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+v,r.skyboxTexture,0),l.draw(f,b.TRIANGLES,bt.disabled,Bt.disabled,an.unblended,Nt.frontCW,R,"skyboxCapture",r.skyboxGeometry.vertexBuffer,r.skyboxGeometry.indexBuffer,r.skyboxGeometry.segment)}const it=u.ec([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class _t{constructor(r){const l=new u.ej;l.emplaceBack(-1,1,1,0,0),l.emplaceBack(1,1,1,1,0),l.emplaceBack(1,-1,1,1,1),l.emplaceBack(-1,-1,1,0,1);const p=new u.a_;p.emplaceBack(0,1,2),p.emplaceBack(2,3,0),this.vertexBuffer=r.createVertexBuffer(l,it.members),this.indexBuffer=r.createIndexBuffer(p),this.segments=u.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Uc=u.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Wi{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class De{constructor(r){this.colorModeAlphaBlendedWriteRGB=new an([1,771,1,771],u.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new an([1,0,1,0],u.am.transparent,[!1,!1,!1,!0]),this.params=new Wi,this.updateNeeded=!0,r.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),r.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),r.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),r.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(r){const l=r.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new _t(l);const p=this.params.sizeRange,_=this.params.intensityRange,v=function(R){const z=u.el(30),L=[];for(let B=0;B<R;++B){const H=2*Math.PI*z(),U=Math.acos(1-2*z())-.5*Math.PI;L.push(u.d2(Math.cos(U)*Math.cos(H),Math.cos(U)*Math.sin(H),Math.sin(U)))}return L}(this.params.starsCount),b=u.el(300),S=new u.ek,I=new u.a_;let P=0;for(let R=0;R<v.length;++R){const z=u.c1([],v[R],200),L=Math.max(0,1+.01*p*(1*b()-.5)),B=Math.max(0,1+.01*_*(1*b()-.5));S.emplaceBack(z[0],z[1],z[2],-1,-1,L,B),S.emplaceBack(z[0],z[1],z[2],1,-1,L,B),S.emplaceBack(z[0],z[1],z[2],1,1,L,B),S.emplaceBack(z[0],z[1],z[2],-1,1,L,B),I.emplaceBack(P+0,P+1,P+2),I.emplaceBack(P+0,P+2,P+3),P+=4}this.starsVx=l.createVertexBuffer(S,Uc.members),this.starsIdx=l.createIndexBuffer(I),this.starsSegments=u.bd.simpleSegment(0,0,S.length,I.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(r,l){const p=r.context,_=p.gl,v=r.transform,b=new bt(_.LEQUAL,bt.ReadOnly,[0,1]),S=u.ah(v.zoom),I=r.style.getLut(l.scope),P="none"===l.properties.get("color-use-theme"),R=l.properties.get("color").toNonPremultipliedRenderColor(P?null:I).toArray01(),z="none"===l.properties.get("high-color-use-theme"),L=l.properties.get("high-color").toNonPremultipliedRenderColor(z?null:I).toArray01(),B="none"===l.properties.get("space-color-use-theme"),H=l.properties.get("space-color").toNonPremultipliedRenderColor(B?null:I).toArray01(),U=5e-4,q=u.em(l.properties.get("horizon-blend"),0,1,U,.25),G=u.dy(r,p,v)&&q===U?v.worldSize/(2*Math.PI*1.025)-1:v.globeRadius,Y=r.frameCounter/1e3%1,ee=u.ae(v.globeCenterInViewSpace),ne=Math.sqrt(Math.pow(ee,2)-Math.pow(G,2)),le=Math.acos(ne/ee),de=pe=>{const ae="globe"===v.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];pe&&ae.push("ALPHA_PASS");const ce=r.getOrCreateProgram("globeAtmosphere",{defines:ae}),ue={u_frustum_tl:v.frustumCorners.TL,u_frustum_tr:v.frustumCorners.TR,u_frustum_br:v.frustumCorners.BR,u_frustum_bl:v.frustumCorners.BL,u_horizon:v.frustumCorners.horizon,u_transition:S,u_fadeout_range:q,u_color:R,u_high_color:L,u_space_color:H,u_temporal_offset:Y,u_horizon_angle:le};r.uploadCommonUniforms(p,ce);const Me=this.atmosphereBuffer;Me&&ce.draw(r,_.TRIANGLES,b,Bt.disabled,pe?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Nt.backCW,ue,pe?"atmosphere_glow_alpha":"atmosphere_glow",Me.vertexBuffer,Me.indexBuffer,Me.segments)};de(!1),de(!0)}drawStars(r,l){const p=u.ay(l.properties.get("star-intensity"),0,1);if(0===p)return;const _=r.context,v=_.gl,b=r.transform,S=r.getOrCreateProgram("stars"),I=u.c3([]);u.c5(I,I,-b._pitch),u.c4(I,I,-b.angle),u.c5(I,I,u.al(b._center.lat)),u.en(I,I,-u.al(b._center.lng));const P=u.c8(new Float32Array(16),I),R=u.az([],b.starsProjMatrix,P),z=u.ei([],P),L=u.eo([],z),B=[0,1,0];u.dL(B,B,L),u.c1(B,B,this.params.sizeMultiplier);const H=[1,0,0];u.dL(H,H,L),u.c1(H,H,this.params.sizeMultiplier);const U=(q=B,G=H,Y=p,{u_matrix:Float32Array.from(R),u_up:q,u_right:G,u_intensity_multiplier:Y});var q,G,Y;r.uploadCommonUniforms(_,S),this.starsVx&&this.starsIdx&&S.draw(r,v.TRIANGLES,bt.disabled,Bt.disabled,this.colorModeAlphaBlendedWriteRGB,Nt.disabled,U,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class n_{constructor(){this.visibleTiles=[]}updateBorders(r,l){const p=[],_=[],v=r._getRenderableCoordinates(!1,!0);for(const I of v){const P=r.getTile(I);if(!P.hasData())continue;const R=P.getBucket(l);R&&(R.isEmpty()||(p.push(I.key),_.push({bucket:R,tileID:I.canonical})))}let b=p.length!==this.visibleTiles.length;if(!b){p.sort();for(let I=0;I<p.length;I++)if(p[I]!==this.visibleTiles[I]){b=!0;break}}if(!b)return;const S=new Set;this.visibleTiles=p,_.sort((I,P)=>I.tileID.z-P.tileID.z||I.tileID.x-P.tileID.x||I.tileID.y-P.tileID.y);for(const I of _){const P=new Array,R=new Array,z=I.bucket;for(const L of z.featuresOnBorder)S.has(L.featureId)?R.push(L.footprintIndex):(S.add(L.featureId),P.push(L.footprintIndex));z.updateFootprintHiddenFlags(P,u.ep,!1),z.updateFootprintHiddenFlags(R,u.ep,!0)}}}function Sn(f,r){const l=[...f],p=r.cameraWorldSizeForFog/r.worldSize,_=u.bx([]);return u.cP(_,_,[p,p,1]),u.az(l,_,l),u.az(l,r.worldToFogMatrix,l),l}function Gu(f,r,l,p,_){const v=l.material,b=p.context,{baseColorTexture:S,metallicRoughnessTexture:I}=v.pbrMetallicRoughness,{normalTexture:P,occlusionTexture:R,emissionTexture:z}=v;function L(H,U,q){if(H&&(f.push(U),b.activeTexture.set(b.gl.TEXTURE0+q),H.gfxTexture)){const{minFilter:G,magFilter:Y,wrapS:ee,wrapT:ne}=H.sampler;H.gfxTexture.bindExtraParam(G,Y,ee,ne)}}L(S,"HAS_TEXTURE_u_baseColorTexture",Zr.BaseColor),L(I,"HAS_TEXTURE_u_metallicRoughnessTexture",Zr.MetallicRoughness),L(P,"HAS_TEXTURE_u_normalTexture",Zr.Normal),L(R,"HAS_TEXTURE_u_occlusionTexture",Zr.Occlusion),L(z,"HAS_TEXTURE_u_emissionTexture",Zr.Emission),_&&(_.texture||(_.texture=new u.et(p.context,_.image,[_.image.height,_.image.height,_.image.height],b.gl.RGBA8)),b.activeTexture.set(b.gl.TEXTURE0+Zr.LUT),_.texture&&_.texture.bind(b.gl.LINEAR,b.gl.CLAMP_TO_EDGE),f.push("APPLY_LUT_ON_GPU")),l.texcoordBuffer&&(f.push("HAS_ATTRIBUTE_a_uv_2f"),r.push(l.texcoordBuffer)),l.colorBuffer&&(f.push(12===l.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),r.push(l.colorBuffer)),l.normalBuffer&&(f.push("HAS_ATTRIBUTE_a_normal_3f"),r.push(l.normalBuffer)),l.pbrBuffer&&(f.push("HAS_ATTRIBUTE_a_pbr"),f.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),r.push(l.pbrBuffer)),"OPAQUE"!==v.alphaMode&&"MASK"!==v.alphaMode||f.push("UNPREMULT_TEXTURE_IN_SHADER"),v.defined||f.push("DIFFUSE_SHADED");const B=p.shadowRenderer;B&&(f.push("RENDER_SHADOWS","DEPTH_TEXTURE"),B.useNormalOffset&&f.push("NORMAL_OFFSET"))}function ah(f,r,l,p,_,v){const b=l.paint.get("model-opacity").constantOr(1),S=r.context,I=new bt(r.context.gl.LEQUAL,bt.ReadWrite,r.depthRangeFor3D),P=r.transform,R=f.mesh,z=R.material,L=z.pbrMetallicRoughness,B=r.style.fog;let H;H="pixels"===r.transform.projection.zAxisUnit?[...f.nodeModelMatrix]:u.az([],p.zScaleMatrix,f.nodeModelMatrix),u.az(H,p.negCameraPosMatrix,H);const U=u.bi([],H);u.ea(U,U);const q="none"===l.paint.get("model-color-use-theme").constantOr("default"),G=l.paint.get("model-emissive-strength").constantOr(0),Y=Fc(new Float32Array(f.worldViewProjection),new Float32Array(H),new Float32Array(U),null,r,b,L.baseColorFactor,z.emissiveFactor,L.metallicFactor,L.roughnessFactor,z,G,l),ee={defines:[]},ne=[],le=r.shadowRenderer;le&&(le.useNormalOffset=!1),Gu(ee.defines,ne,R,r,q?null:l.lut);let de=null;if(B){const ce=Sn(f.nodeModelMatrix,r.transform);if(de=new Float32Array(ce),"globe"!==P.projection.name){const ue=R.aabb.min,Me=R.aabb.max,[ye,je]=B.getOpacityForBounds(ce,ue[0],ue[1],Me[0],Me[1]);ee.overrideFog=ye>=qe||je>=qe}}const pe=mo(r,l.paint.get("model-cutoff-fade-range"));pe.shouldRenderCutoff&&ee.defines.push("RENDER_CUTOFF");const ae=r.getOrCreateProgram("model",ee);r.uploadCommonUniforms(S,ae,null,de,pe),"shadow"!==r.renderPass&&le&&le.setupShadowsFromMatrix(f.nodeModelMatrix,ae),ae.draw(r,S.gl.TRIANGLES,I,_,v,R.material.doubleSided?Nt.disabled:Nt.backCCW,Y,l.id,R.vertexBuffer,R.indexBuffer,R.segments,l.paint,r.transform.zoom,void 0,ne)}function rm(f,r,l,p,_,v,b){let S;S="globe"===f.projection.name?u.er(l,f):[...l],u.az(S,S,r.matrix);const I=u.az([],p,S);if(r.meshes)for(const P of r.meshes){if("BLEND"!==P.material.alphaMode){b.push({mesh:P,depth:0,modelIndex:_,worldViewProjection:I,nodeModelMatrix:S});continue}const R=u.ad([],P.centroid,I);!f.isOrthographic&&R[2]<=0||v.push({mesh:P,depth:R[2],modelIndex:_,worldViewProjection:I,nodeModelMatrix:S})}if(r.children)for(const P of r.children)rm(f,P,l,p,_,v,b)}function Lf(f,r,l,p){const _=l.shadowRenderer;if(!_)return;const v=_.getShadowPassDepthMode(),b=_.getShadowPassColorMode(),S=_.calculateShadowPassMatrixFromMatrix(r),I=zc(S);l.getOrCreateProgram("modelDepth",{defines:l._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(l,l.context.gl.TRIANGLES,v,Bt.disabled,b,Nt.backCCW,I,p.id,f.vertexBuffer,f.indexBuffer,f.segments,p.paint,l.transform.zoom,void 0,void 0)}function $u(f,r,l){const p=r.updateZoomBasedPaintProperties(),_=function(v,b,S){let I,P,R,z=v.terrain?v.terrain.exaggeration():0;if(v.terrain&&z>0){const L=v.terrain,B=L.findDEMTileFor(S);B&&B.dem?I=u.eu.create(L,S,B):z=0}if(0===z&&(b.terrainElevationMin=0,b.terrainElevationMax=0),z===b.validForExaggeration&&(0===z||I&&I._demTile&&I._demTile.tileID===b.validForDEMTile.id&&I._dem._timestamp===b.validForDEMTile.timestamp))return!1;for(const L in b.instancesPerModel){const B=b.instancesPerModel[L];for(let H=0;H<B.instancedDataArray.length;++H){const U=(I?z*I.getElevationAt(0|B.instancedDataArray.float32[16*H],0|B.instancedDataArray.float32[16*H+1],!0,!0):0)+B.instancesEvaluatedElevation[H];B.instancedDataArray.float32[16*H+6]=U,P=P?Math.min(b.terrainElevationMin,U):U,R=R?Math.max(b.terrainElevationMax,U):U}}return b.terrainElevationMin=P||0,b.terrainElevationMax=R||0,b.validForExaggeration=z,b.validForDEMTile=I&&I._demTile?{id:I._demTile.tileID,timestamp:I._dem._timestamp}:{id:void 0,timestamp:0},!0}(f,r,l);(p||_)&&(r.uploaded=!1,r.upload(f.context))}const da={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new u.d6([0,0,0],[u.aj,u.aj,0])};function qu(f,r){const l=1<<f.canonical.z,p=r.getFreeCameraOptions().position,_=r.elevation,v=f.canonical.x/l,b=(f.canonical.x+1)/l,S=f.canonical.y/l,I=(f.canonical.y+1)/l;let P=r._centerAltitude;if(_){const B=_.getMinMaxForTile(f);B&&B.max>P&&(P=B.max)}const R=u.ay(p.x,v,b)-p.x,z=u.ay(p.y,S,I)-p.y,L=u.cb(P,r.center.lat)-p.z;return r._zoomFromMercatorZ(Math.sqrt(R*R+z*z+L*L))}function om(f,r,l,p,_,v,b){const S=f.context,I="shadow"===f.renderPass,P=f.shadowRenderer,R=I&&P?P.getShadowPassDepthMode():new bt(S.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D),z=f.isTileAffectedByFog(v);if(l.meshes)for(const L of l.meshes){const B=["MODEL_POSITION_ON_GPU"],H=[];let U,q,G;p.instancedDataArray.length>20&&B.push("INSTANCED_ARRAYS");const Y=mo(f,r.paint.get("model-cutoff-fade-range"));if(Y.shouldRenderCutoff&&B.push("RENDER_CUTOFF"),I&&P)U=f.getOrCreateProgram("modelDepth",{defines:B}),q=zc(b.shadowTileMatrix,b.shadowTileMatrix,Float32Array.from(l.matrix)),G=P.getShadowPassColorMode();else{Gu(B,H,L,f,"none"===r.paint.get("model-color-use-theme").constantOr("default")?null:r.lut),U=f.getOrCreateProgram("model",{defines:B,overrideFog:z});const ne=L.material,le=ne.pbrMetallicRoughness,de=r.paint.get("model-opacity").constantOr(1),pe=r.paint.get("model-emissive-strength").constantOr(0);q=Fc(v.expandedProjMatrix,Float32Array.from(l.matrix),new Float32Array(16),null,f,de,le.baseColorFactor,ne.emissiveFactor,le.metallicFactor,le.roughnessFactor,ne,pe,r,_),P&&(b.shadowUniformsInitialized?U.setShadowUniformValues(S,P.getShadowUniformValues()):(P.setupShadows(v.toUnwrapped(),U,"model-tile"),b.shadowUniformsInitialized=!0)),G=Y.shouldRenderCutoff||de<1||"OPAQUE"!==ne.alphaMode?an.alphaBlended:an.unblended}f.uploadCommonUniforms(S,U,v.toUnwrapped(),null,Y);const ee=L.material.doubleSided?Nt.disabled:Nt.backCCW;if(p.instancedDataArray.length>20)H.push(p.instancedDataBuffer),U.draw(f,S.gl.TRIANGLES,R,Bt.disabled,G,ee,q,r.id,L.vertexBuffer,L.indexBuffer,L.segments,r.paint,f.transform.zoom,void 0,H,p.instancedDataArray.length);else{const ne=I?"u_instance":"u_normal_matrix";for(let le=0;le<p.instancedDataArray.length;++le)q[ne]=new Float32Array(p.instancedDataArray.arrayBuffer,64*le,16),U.draw(f,S.gl.TRIANGLES,R,Bt.disabled,G,ee,q,r.id,L.vertexBuffer,L.indexBuffer,L.segments,r.paint,f.transform.zoom,void 0,H)}}if(l.children)for(const L of l.children)om(f,r,L,p,_,v,b)}const kf=[1,-1,1];function sm(f,r,l,p){if(!l.modelManager)return!0;const _=l.modelManager;if(!l.shadowRenderer)return!0;const v=l.shadowRenderer,b=r.aabb;let S=!0,I=f.maxHeight;if(0===I){let R=0;for(const z in f.instancesPerModel){const L=_.getModel(z,p);L?R=Math.max(R,Math.max(Math.max(L.aabb.max[0],L.aabb.max[1]),L.aabb.max[2])):S=!1}I=f.maxScale*R*1.41+f.maxVerticalOffset,S&&(f.maxHeight=I)}b.max[2]=I,b.min[2]+=f.terrainElevationMin,b.max[2]+=f.terrainElevationMax,u.ad(b.min,b.min,r.tileMatrix),u.ad(b.max,b.max,r.tileMatrix);const P=b.intersects(v.getCurrentCascadeFrustum());return 0===l.currentShadowCascade&&(f.isInsideFirstShadowMapFrustum=2===P),0===P}function i_(f,r){const l=f.uniformValues.u_cutoff_params[0],p=f.uniformValues.u_cutoff_params[1],_=f.uniformValues.u_cutoff_params[2],v=f.uniformValues.u_cutoff_params[3];return p===l||v===_?1:u.ay(((r-l)/(p-l)-_)/(v-_),0,1)}function r_(f,r,l,p){if(r.pitch<20)return 1;const _=r.getWorldToCameraMatrix();u.az(_,_,f);const v=u.bR(l.min[0],l.min[1],l.min[2],1);let b=u.aA(u.ev(),v,_),S=b,I=b;v[1]=l.max[1],b=u.aA(u.ev(),v,_),S=b[1]<S[1]?b:S,I=b[1]>I[1]?b:I,v[0]=l.max[0],b=u.aA(u.ev(),v,_),S=b[1]<S[1]?b:S,I=b[1]>I[1]?b:I,v[1]=l.min[1],b=u.aA(u.ev(),v,_),S=b[1]<S[1]?b:S,I=b[1]>I[1]?b:I;const P=u.ay(p[0],0,1),R=100*r.pixelsPerMeter*u.ay(p[1],0,1),z=u.ay(p[2],0,1),L=u.ew(u.ev(),S,I,P),B=Math.tan(.5*r.fovX),H=-L[2]*B;if(0===R)return L[1]<-Math.abs(H)?z:1;const U=(-Math.abs(H)-L[1])/R,q=(Y,ee,ne)=>(1-ne)*Y+ne*ee,G=u.ay(q(1,z,U),z,1);return q(1,G,u.ay((r.pitch-20)/20,0,1))}class It{}class xi{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(r,l,p){{const z=this._storage.get(l.id);if(z)return z.lastUsedFrameIdx=r,z.buf}const _=p.gl,v=_.getBufferParameter(_.ELEMENT_ARRAY_BUFFER,_.BUFFER_SIZE),b=new ArrayBuffer(v),S=new Int16Array(b);_.getBufferSubData(_.ELEMENT_ARRAY_BUFFER,0,new Int16Array(b));const I=new u.ey;for(let z=0;z<v/2;z+=3){const L=S[z],B=S[z+1],H=S[z+2];I.emplaceBack(L,B),I.emplaceBack(B,H),I.emplaceBack(H,L)}const P=p.bindVertexArrayOES.current,R=new It;return R.buf=new hv(p,I),R.lastUsedFrameIdx=r,this._storage.set(l.id,R),p.bindVertexArrayOES.set(P),R.buf}update(r){for(const[l,p]of this._storage)r-p.lastUsedFrameIdx>30&&(p.buf.destroy(),this._storage.delete(l))}destroy(){for(const[r,l]of this._storage)l.buf.destroy(),this._storage.delete(r)}}class Wu{constructor(r){this.occluderSize=30,this.depthOffset=-1e-4,r.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),r.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const o_=u.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Mo{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class bo{constructor(r,l){this.revealStart=11,this.revealRange=2,r.registerParameter(this,[...l,"Reveal"],"revealStart",{min:0,max:17,step:.05}),r.registerParameter(this,[...l,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const lh=u.ec([{type:"Float32",name:"a_pos_2f",components:2}]);class vs{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(r,l){const p=r.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const b=new u.ez,S=new u.a_;b.emplaceBack(-1,-1),b.emplaceBack(1,-1),b.emplaceBack(1,1),b.emplaceBack(-1,1),S.emplaceBack(0,1,2),S.emplaceBack(0,2,3),this.vignetteVx=r.context.createVertexBuffer(b,lh.members),this.vignetteIdx=r.context.createIndexBuffer(S)}const _=u.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){r.uploadCommonUniforms(r.context,p);const b={u_vignetteShape:(v={vignetteShape:[l.start,l.range,Math.pow(10,l.fadePower)],vignetteColor:[l.color.r,l.color.g,l.color.b,l.color.a*l.strength]}).vignetteShape,u_vignetteColor:v.vignetteColor};p.draw(r,r.context.gl.TRIANGLES,bt.disabled,Bt.disabled,an.alphaBlended,Nt.disabled,b,"vignette",this.vignetteVx,this.vignetteIdx,_)}var v}}class bi{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(r,l){const p=r.getFreeCameraOptions().position,_=p.toAltitude(),v=p.toLngLat(),b=u.al(v.lng),S=u.al(v.lat),I=r.pixelsPerMeter/l,P=b*u.eB,R=u.eB*Math.log(Math.tan(Math.PI/4+S/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const z=-this._offsetYPrev+R,L=-this._elevationPrev+_;this._accumulatedOffsetX+=(-this._offsetXPrev+P)*I,this._accumulatedOffsetY+=z*I,this._accumulatedElevation+=L*I,this._offsetXPrev=P,this._offsetYPrev=R,this._elevationPrev=_}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function En(f,r){return[-(f[0]-Math.floor(f[0]/r)*r),-(f[1]-Math.floor(f[1]/r)*r),-(f[2]-Math.floor(f[2]/r)*r)]}function am(f){const r=u.el(1323123451230),l=[];for(let p=0;p<f;++p){const _=2*r()-1,v=2*r()-1,b=2*r()-1;l.push(u.d2(_,v,b))}return l}function xs(f,r,l,p,_){const v=u.ay((_-l)/(p-l),0,1);return(1-v)*f+v*r}class Hc{constructor(r){this._movement=new bi,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new vs,this._ppmScaleFactor=r}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(r,l){const p=r.transform;this._movement.update(p,this._ppmScaleFactor);const _=p.starsProjMatrix,v=u.c3([]);u.c5(v,v,u.al(90)-p._pitch),u.c4(v,v,-p.angle);const b=u.c8(new Float32Array(16),v),S=u.eA(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),I=u.ea([],S),P=u.az([],I,b),R=Date.now()/1e3;return this._accumulatedTimeFromStart+=(R-this._prevTime)*l,this._prevTime=R,{projectionMatrix:_,modelviewMatrix:P}}}class Qr extends Hc{constructor(r){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new bo(r.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(r){const l=r.context;if(!this.particlesVx){const p=am(this.particlesCount),_=new u.eC,v=new u.a_;let b=0;const S=u.el(1323123451230);for(let I=0;I<p.length;++I){const P=p[I],R=[2*S()-1,S(),S(),S()];_.emplaceBack(P[0],P[1],P[2],-1,-1,...R),_.emplaceBack(P[0],P[1],P[2],1,-1,...R),_.emplaceBack(P[0],P[1],P[2],1,1,...R),_.emplaceBack(P[0],P[1],P[2],-1,1,...R),v.emplaceBack(b+0,b+1,b+2),v.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=l.createVertexBuffer(_,o_.members),this.particlesIdx=l.createIndexBuffer(v)}}draw(r){if(!this._params.overrideStyleParameters&&!r.style.rain)return;const l=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},p=r.transform.zoom;if(l.revealStart>p)return;const _=xs(0,1,l.revealStart,l.revealStart+l.revealRange,p);if(!this.particlesVx||!this.particlesIdx)return;const v=structuredClone(this._params);let b=[-v.direction.x,v.direction.y,-100];u.au(b,b);const S=structuredClone(this._vignetteParams);S.strength*=_,v.overrideStyleParameters||(v.intensity=r.style.rain.state.density,v.timeFactor=r.style.rain.state.intensity,v.color=structuredClone(r.style.rain.state.color),b=structuredClone(r.style.rain.state.direction),v.screenThinning.intensity=r.style.rain.state.centerThinning,v.dropletSizeX=r.style.rain.state.dropletSize[0],v.dropletSizeYScale=r.style.rain.state.dropletSize[1]/r.style.rain.state.dropletSize[0],v.distortionStrength=100*r.style.rain.state.distortionStrength,S.strength=1,S.color=structuredClone(r.style.rain.state.vignetteColor));const I=this.updateOnRender(r,v.timeFactor),P=r.context,R=P.gl,z=r.transform;this.screenTexture&&this.screenTexture.size[0]===r.width&&this.screenTexture.size[1]===r.height||(this.screenTexture=new u.T(P,{width:r.width,height:r.height,data:null},R.RGBA8)),v.distortionStrength>0&&(P.activeTexture.set(R.TEXTURE0),this.screenTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),R.copyTexSubImage2D(R.TEXTURE_2D,0,0,0,0,0,r.width,r.height));const L=r.getOrCreateProgram("rainParticle");r.uploadCommonUniforms(P,L),P.activeTexture.set(R.TEXTURE0),this.screenTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE);const B=[v.color.r,v.color.g,v.color.b,v.color.a],H=(U,q)=>{const G=En(this._movement.getPosition(),U),Y=v.dropletSizeX,ee=v.dropletSizeX*v.dropletSizeYScale,ne=r.width/2,le=r.height/2,de=xs(0,v.screenThinning.start,0,1,v.screenThinning.intensity),pe=xs(.001,v.screenThinning.range,0,1,v.screenThinning.intensity),ae=xs(0,v.screenThinning.particleOffset,0,1,v.screenThinning.intensity),ce=(ue={modelview:I.modelviewMatrix,projection:I.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:G,velocityConeAperture:v.velocityConeAperture,velocity:v.velocity,boxSize:U,rainDropletSize:[Y,ee],distortionStrength:v.distortionStrength,rainDirection:b,color:B,screenSize:[z.width,z.height],thinningCenterPos:[ne,le],thinningShape:[de,pe,Math.pow(10,v.screenThinning.fadePower)],thinningAffectedRatio:v.screenThinning.affectedRatio,thinningParticleOffset:ae,shapeDirectionalPower:v.shapeDirPower,shapeNormalPower:v.shapeNormalPower,mode:q?0:1},{u_modelview:Float32Array.from(ue.modelview),u_projection:Float32Array.from(ue.projection),u_time:ue.time,u_cam_pos:ue.camPos,u_texScreen:0,u_velocityConeAperture:ue.velocityConeAperture,u_velocity:ue.velocity,u_boxSize:ue.boxSize,u_rainDropletSize:ue.rainDropletSize,u_distortionStrength:ue.distortionStrength,u_rainDirection:ue.rainDirection,u_color:ue.color,u_screenSize:ue.screenSize,u_thinningCenterPos:ue.thinningCenterPos,u_thinningShape:ue.thinningShape,u_thinningAffectedRatio:ue.thinningAffectedRatio,u_thinningParticleOffset:ue.thinningParticleOffset,u_shapeDirectionalPower:ue.shapeDirectionalPower,u_shapeNormalPower:ue.shapeNormalPower,u_mode:ue.mode});var ue;const Me=Math.round(v.intensity*this.particlesCount),ye=u.bd.simpleSegment(0,0,4*Me,2*Me);L.draw(r,R.TRIANGLES,bt.disabled,Bt.disabled,an.alphaBlended,Nt.disabled,ce,"rain_particles",this.particlesVx,this.particlesIdx,ye)};v.distortionStrength>0&&H(v.boxSize,!0),H(v.boxSize,!1),this._vignette.draw(r,S)}}const os=u.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class Ff extends Hc{constructor(r){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new bo(r.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(r){const l=r.context;if(!this.particlesVx){const p=am(this.particlesCount),_=new u.eD,v=new u.a_;let b=0;const S=u.el(1323123451230);for(let I=0;I<p.length;++I){const P=p[I],R=S(),z=S(),L=S(),B=[I/p.length,R,z,L],H=[S(),S()];_.emplaceBack(P[0],P[1],P[2],-1,-1,...B,...H),_.emplaceBack(P[0],P[1],P[2],1,-1,...B,...H),_.emplaceBack(P[0],P[1],P[2],1,1,...B,...H),_.emplaceBack(P[0],P[1],P[2],-1,1,...B,...H),v.emplaceBack(b+0,b+1,b+2),v.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=l.createVertexBuffer(_,os.members),this.particlesIdx=l.createIndexBuffer(v)}}draw(r){if(!this._params.overrideStyleParameters&&!r.style.snow)return;const l=structuredClone(this._params);let p=[-l.direction.x,l.direction.y,-100];u.au(p,p);const _=structuredClone(this._vignetteParams),v=l.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},b=r.transform.zoom;if(v.revealStart>b)return;const S=xs(0,1,v.revealStart,v.revealStart+v.revealRange,b);_.strength*=S,l.overrideStyleParameters||(l.intensity=r.style.snow.state.density,l.timeFactor=r.style.snow.state.intensity,l.color=structuredClone(r.style.snow.state.color),p=structuredClone(r.style.snow.state.direction),l.screenThinning.intensity=r.style.snow.state.centerThinning,l.billboardSize=2.79*r.style.snow.state.flakeSize,_.strength=1,_.color=structuredClone(r.style.snow.state.vignetteColor));const I=this.updateOnRender(r,l.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const P=r.context,R=P.gl,z=r.transform,L=r.getOrCreateProgram("snowParticle");r.uploadCommonUniforms(P,L),((B,H,U)=>{const q=En(this._movement.getPosition(),B),G=z.width/2,Y=z.height/2,ee=xs(0,U.screenThinning.start,0,1,U.screenThinning.intensity),ne=xs(.001,U.screenThinning.range,0,1,U.screenThinning.intensity),le=xs(0,U.screenThinning.particleOffset,0,1,U.screenThinning.intensity),de=(pe={modelview:I.modelviewMatrix,projection:I.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:q,velocityConeAperture:U.velocityConeAperture,velocity:U.velocity,horizontalOscillationRadius:U.horizontalOscillationRadius,horizontalOscillationRate:U.horizontalOscillationRate,boxSize:B,billboardSize:1*U.billboardSize,simpleShapeParameters:[U.shapeFadeStart,U.shapeFadePower],screenSize:[z.width,z.height],thinningCenterPos:[G,Y],thinningShape:[ee,ne,Math.pow(10,U.screenThinning.fadePower)],thinningAffectedRatio:U.screenThinning.affectedRatio,thinningParticleOffset:le,color:[U.color.r,U.color.g,U.color.b,U.color.a],direction:p},{u_modelview:Float32Array.from(pe.modelview),u_projection:Float32Array.from(pe.projection),u_time:pe.time,u_cam_pos:pe.camPos,u_velocityConeAperture:pe.velocityConeAperture,u_velocity:pe.velocity,u_horizontalOscillationRadius:pe.horizontalOscillationRadius,u_horizontalOscillationRate:pe.horizontalOscillationRate,u_boxSize:pe.boxSize,u_billboardSize:pe.billboardSize,u_simpleShapeParameters:pe.simpleShapeParameters,u_screenSize:pe.screenSize,u_thinningCenterPos:pe.thinningCenterPos,u_thinningShape:pe.thinningShape,u_thinningAffectedRatio:pe.thinningAffectedRatio,u_thinningParticleOffset:pe.thinningParticleOffset,u_particleColor:pe.color,u_direction:pe.direction});var pe;const ae=Math.round(U.intensity*this.particlesCount),ce=u.bd.simpleSegment(0,0,4*ae,2*ae);this.particlesVx&&this.particlesIdx&&L.draw(r,R.TRIANGLES,bt.disabled,Bt.disabled,an.alphaBlended,Nt.disabled,de,"snow_particles",this.particlesVx,this.particlesIdx,ce)})(l.boxSize,0,l),this._vignette.draw(r,_)}}const Yl={symbol:function(f,r,l,p,_){if("translucent"!==f.renderPass)return;const v=Bt.disabled,b=f.colorModeForRenderPass(),S=l.layout.get("text-variable-anchor"),I=l.layout.get("text-size-scale-range"),P=u.ay(f.scaleFactor,I[0],I[1]);S&&function(L,B,H,U,q,G,Y,ee){const ne=B.transform,le="map"===q,de="map"===G;for(const pe of L){const ae=U.getTile(pe),ce=ae.getBucket(H);if(!ce||!ce.text||!ce.text.segments.get().length)continue;const ue=u.bH(ce.textSizeData,ne.zoom,ee),Me=kp(pe,ce.getProjection(),ne),ye=ne.calculatePixelsToTileUnitsMatrix(ae),je=Nd(Me,ae.tileID.canonical,de,le,ne,ce.getProjection(),ye),Le=ce.hasIconTextFit()&&ce.hasIconData();ue&&fv(ce,le,de,Y,ne,je,pe,Math.pow(2,ne.zoom-ae.tileID.overscaledZ),ue,Le)}}(p,f,l,r,l.layout.get("text-rotation-alignment"),l.layout.get("text-pitch-alignment"),_,P);const R=0!==l.paint.get("icon-opacity").constantOr(1),z=0!==l.paint.get("text-opacity").constantOr(1);void 0!==l.layout.get("symbol-sort-key").constantOr(1)&&(R||z)?Jg(f,r,l,p,v,b):(R&&Jg(f,r,l,p,v,b,{onlyIcons:!0}),z&&Jg(f,r,l,p,v,b,{onlyText:!0})),r.map.showCollisionBoxes&&(Df(f,r,l,p,l.paint.get("text-translate"),l.paint.get("text-translate-anchor"),!0),Df(f,r,l,p,l.paint.get("icon-translate"),l.paint.get("icon-translate-anchor"),!1))},circle:function(f,r,l,p){if("translucent"!==f.renderPass)return;const _=l.paint.get("circle-opacity"),v=l.paint.get("circle-stroke-width"),b=l.paint.get("circle-stroke-opacity"),S=void 0!==l.layout.get("circle-sort-key").constantOr(1),I=l.paint.get("circle-emissive-strength");if(0===_.constantOr(1)&&(0===v.constantOr(1)||0===b.constantOr(1)))return;const P=f.context,R=P.gl,z=f.transform,L=!(!f.terrain||!f.terrain.enabled),B=l.layout.get("circle-elevation-reference"),H=f.depthModeForSublayer(0,bt.ReadOnly),U=new bt(f.context.gl.LEQUAL,bt.ReadOnly,f.depthRangeFor3D),q="none"===B||L?H:U,G=Bt.disabled,Y=f.colorModeForDrapableLayerRenderPass(I),ee="globe"===z.projection.name,ne=[u.aD(z.center.lng),u.aH(z.center.lat)],le=[];for(let pe=0;pe<p.length;pe++){const ae=p[pe],ce=r.getTile(ae),ue=ce.getBucket(l);if(!ue||ue.projection.name!==z.projection.name)continue;const Me=ue.programConfigurations.get(l.id),ye=ue.layoutVertexBuffer,je=ue.globeExtVertexBuffer,Le=ue.indexBuffer,Ge=u.dW(l),rt=[je],Se=f.isTileAffectedByFog(ae);ee&&Ge.push("PROJECTION_GLOBE_VIEW"),Ge.push("DEPTH_D24"),f.terrain&&z.depthOcclusionForSymbolsAndCircles&&Ge.push("DEPTH_OCCLUSION"),ue.hasElevation&&!f.terrain&&(Ge.push("ELEVATED_ROADS"),rt.push(ue.elevatedLayoutVertexBuffer));const _e=f.getOrCreateProgram("circle",{config:Me,defines:Ge,overrideFog:Se}),ze=z.projection.createInversionMatrix(z,ae.canonical),Re={programConfiguration:Me,program:_e,layoutVertexBuffer:ye,dynamicBuffers:rt,indexBuffer:Le,uniformValues:u.dX(f,ae,ce,ze,ne,l),tile:ce};if(S){const We=ue.segments.get();for(const Ze of We)le.push({segments:new u.bd([Ze]),sortKey:Ze.sortKey,state:Re})}else le.push({segments:ue.segments,sortKey:0,state:Re})}S&&le.sort((pe,ae)=>pe.sortKey-ae.sortKey);const de={useDepthForOcclusion:z.depthOcclusionForSymbolsAndCircles};for(const pe of le){const{programConfiguration:ae,program:ce,layoutVertexBuffer:ue,dynamicBuffers:Me,indexBuffer:ye,uniformValues:je,tile:Le}=pe.state,Ge=pe.segments;f.terrain&&f.terrain.setupElevationDraw(Le,ce,de),f.uploadCommonUniforms(P,ce,Le.tileID.toUnwrapped()),ce.draw(f,R.TRIANGLES,q,G,Y,Nt.disabled,je,l.id,ue,ye,Ge,l.paint,z.zoom,ae,Me)}},heatmap:function(f,r,l,p){if(0!==l.paint.get("heatmap-opacity"))if("offscreen"===f.renderPass){const _=f.context,v=_.gl,b=Bt.disabled,S=new an([v.ONE,v.ONE,v.ONE,v.ONE],u.am.transparent,[!0,!0,!0,!0]);(function(B,H,U,q){const G=B.gl,Y=H.width*q,ee=H.height*q;B.activeTexture.set(G.TEXTURE1),B.viewport.set([0,0,Y,ee]);let ne=U.heatmapFbo;if(!ne||ne&&(ne.width!==Y||ne.height!==ee)){ne&&ne.destroy();const le=G.createTexture();G.bindTexture(G.TEXTURE_2D,le),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_WRAP_S,G.CLAMP_TO_EDGE),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_WRAP_T,G.CLAMP_TO_EDGE),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_MIN_FILTER,G.LINEAR),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_MAG_FILTER,G.LINEAR),ne=U.heatmapFbo=B.createFramebuffer(Y,ee,!0,null),function(de,pe,ae,ce,ue,Me){const ye=de.gl;ye.texImage2D(ye.TEXTURE_2D,0,de.extRenderToTextureHalfFloat?ye.RGBA16F:ye.RGBA,ue,Me,0,ye.RGBA,de.extRenderToTextureHalfFloat?ye.HALF_FLOAT:ye.UNSIGNED_BYTE,null),ce.colorAttachment.set(ae)}(B,0,le,ne,Y,ee)}else G.bindTexture(G.TEXTURE_2D,ne.colorAttachment.get()),B.bindFramebuffer.set(ne.framebuffer)})(_,f,l,"globe"===f.transform.projection.name?.5:.25),_.clear({color:u.am.transparent});const I=f.transform,P="globe"===I.projection.name,R=P?["PROJECTION_GLOBE_VIEW"]:[],z=P?Nt.frontCCW:Nt.disabled,L=[u.aD(I.center.lng),u.aH(I.center.lat)];for(let B=0;B<p.length;B++){const H=p[B];if(r.hasRenderableParent(H))continue;const U=r.getTile(H),q=U.getBucket(l);if(!q||q.projection.name!==I.projection.name)continue;const G=f.isTileAffectedByFog(H),Y=q.programConfigurations.get(l.id),ee=f.getOrCreateProgram("heatmap",{config:Y,defines:R,overrideFog:G}),{zoom:ne}=f.transform;f.terrain&&f.terrain.setupElevationDraw(U,ee),f.uploadCommonUniforms(_,ee,H.toUnwrapped());const le=I.projection.createInversionMatrix(I,H.canonical);ee.draw(f,v.TRIANGLES,bt.disabled,b,S,z,eh(f,H,U,le,L,ne,l.paint.get("heatmap-intensity")),l.id,q.layoutVertexBuffer,q.indexBuffer,q.segments,l.paint,f.transform.zoom,Y,P?[q.globeExtVertexBuffer]:null)}_.viewport.set([0,0,f.width,f.height])}else"translucent"===f.renderPass&&(f.context.setColorMode(f.colorModeForRenderPass()),function(_,v){const b=_.context,S=b.gl,I=v.heatmapFbo;if(!I)return;b.activeTexture.set(S.TEXTURE0),S.bindTexture(S.TEXTURE_2D,I.colorAttachment.get()),b.activeTexture.set(S.TEXTURE1);let P=v.colorRampTexture;P||(P=v.colorRampTexture=new u.T(b,v.colorRamp,S.RGBA8)),P.bind(S.LINEAR,S.CLAMP_TO_EDGE),_.getOrCreateProgram("heatmapTexture").draw(_,S.TRIANGLES,bt.disabled,Bt.disabled,_.colorModeForRenderPass(),Nt.disabled,{u_image:0,u_color_ramp:1,u_opacity:v.paint.get("heatmap-opacity")},v.id,_.viewportBuffer,_.quadTriangleIndexBuffer,_.viewportSegments,v.paint,_.transform.zoom)}(f,l))},line:function(f,r,l,p){if("translucent"!==f.renderPass)return;const _=l.paint.get("line-opacity"),v=l.paint.get("line-width");if(0===_.constantOr(1)||0===v.constantOr(1))return;const b=l.paint.get("line-emissive-strength"),S=l.paint.get("line-occlusion-opacity"),I=l.layout.get("line-elevation-reference"),P="meters"===l.layout.get("line-width-unit"),R="sea"===I,z=!(!f.terrain||!f.terrain.enabled),L=f.context,B=L.gl;if(l.hasElevatedBuckets&&"globe"===f.transform.projection.name)return;const H=l.layout.get("line-cross-slope"),U=void 0!==H,q=H<1,G=f.colorModeForDrapableLayerRenderPass(b),Y=f.terrain&&f.terrain.renderingToTexture,ee=Y?1:u.q.devicePixelRatio,ne=l.paint.get("line-dasharray"),le=ne.constantOr(1),de=l.layout.get("line-cap"),pe=ne.constantOr(null),ae=de.constantOr(null),ce=l.paint.get("line-pattern"),ue=ce.constantOr(1),Me=l.paint.get("line-pattern-cross-fade"),ye=ce.constantOr(null),je=l.paint.get("line-opacity").constantOr(1);let Le=!ue&&1!==je||f.depthOcclusion&&S>0&&S<1;const Ge=l.paint.get("line-gradient"),rt=ue?"linePattern":"line",Se=u.dY(l);let _e;if(Y&&f.terrain&&f.terrain.clipOrMaskOverlapStencilType()&&(Le=!1),0!==S&&f.depthOcclusion){const Ze=l.paint._values["line-opacity"];Ze&&Ze.value&&"constant"===Ze.value.kind?_e=Ze.value:u.w(`Occlusion opacity for layer ${l.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==v.value.kind&&!1===v.value.isLineProgressConstant&&Se.push("VARIABLE_LINE_WIDTH");const ze=(Ze,Ye,ct,Ct,Lt,vt)=>{for(const Rt of Ze){const At=r.getTile(Rt);if(ue&&!At.patternsLoaded())continue;const qt=At.getBucket(l);if(!qt||"none"!==qt.elevationType&&!Lt||"none"===qt.elevationType&&Lt)continue;f.prepareDrawTile();const Kt=[...Ye],mn=f.shadowRenderer,Dn="road"===qt.elevationType&&!!mn&&mn.enabled;let Zt=[0,0,0];if(Dn){const Mn=f.style.directionalLight,qn=f.style.ambientLight;Mn&&qn&&(Zt=qa(f.style,Mn,qn)),Kt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const An=qt.programConfigurations.get(l.id);let Ln=!1;if(ye&&At.imageAtlas){const Mn=u.dZ.from(ye),qn=Mn.getPrimary().scaleSelf(ee).toString(),ci=At.imageAtlas.patternPositions.get(qn),mr=Mn.getSecondary(),lr=mr?At.imageAtlas.patternPositions.get(mr.scaleSelf(ee).toString()):null;Ln=!!ci&&!!lr,ci&&An.setConstantPatternPositions(ci,lr)}Me>0&&(Ln||An.getPatternTransitionVertexBuffer("line-pattern"))&&Kt.push("LINE_PATTERN_TRANSITION");const ei=f.isTileAffectedByFog(Rt),un=f.getOrCreateProgram(rt,{config:An,defines:Kt,overrideFog:ei});if(!ue&&pe&&ae&&At.lineAtlas){const Mn=At.lineAtlas.getDash(pe,ae);Mn&&An.setConstantPatternPositions(Mn)}Dn&&mn.setupShadows(At.tileID.toUnwrapped(),un,"vector-tile");let[kn,zn]=l.paint.get("line-trim-offset");("round"===ae||"square"===ae)&&kn!==zn&&(0===kn&&(kn-=1),1===zn&&(zn+=1));const In=Y?Rt.projMatrix:null,on=P?1/qt.tileToMeter/u.aw(At,1,f.transform.zoom):1,ti=P?1/qt.tileToMeter/u.aw(At,1,Math.floor(f.transform.zoom)):1,Gn=ue?u.d_(f,At,l,In,ee,on,ti,[kn,zn],Zt,Me):u.d$(f,At,l,In,qt.lineClipsArray.length,ee,on,ti,[kn,zn],Zt);if(Ge){const Mn=qt.gradients[l.id];let qn=Mn.texture;if(l.gradientVersion!==Mn.version){let ci=256;if(l.stepInterpolant){const mr=r.getSource().maxzoom,lr=Rt.canonical.z===mr?Math.ceil(1<<f.transform.maxZoom-Rt.canonical.z):1;ci=u.ay(u.e0(qt.maxLineLength/u.aj*1024*lr),256,L.maxTextureSize)}Mn.gradient=u.e1({expression:l.gradientExpression(),evaluationKey:"lineProgress",resolution:ci,image:Mn.gradient||void 0,clips:qt.lineClipsArray}),Mn.texture?Mn.texture.update(Mn.gradient):Mn.texture=new u.T(L,Mn.gradient,B.RGBA8),Mn.version=l.gradientVersion,qn=Mn.texture}L.activeTexture.set(B.TEXTURE1),qn.bind(l.stepInterpolant?B.NEAREST:B.LINEAR,B.CLAMP_TO_EDGE)}le&&(L.activeTexture.set(B.TEXTURE0),At.lineAtlasTexture&&At.lineAtlasTexture.bind(B.LINEAR,B.REPEAT),An.updatePaintBuffers()),ue&&(L.activeTexture.set(B.TEXTURE0),At.imageAtlasTexture&&At.imageAtlasTexture.bind(B.LINEAR,B.CLAMP_TO_EDGE),An.updatePaintBuffers()),Lt&&!R&&f.terrain.setupElevationDraw(At,un),f.uploadCommonUniforms(L,un,Rt.toUnwrapped());const Fi=Mn=>{null!=_e&&(_e.value=je*S),un.draw(f,B.TRIANGLES,ct,Mn,G,Nt.disabled,Gn,l.id,qt.layoutVertexBuffer,qt.indexBuffer,qt.segments,l.paint,f.transform.zoom,An,[qt.layoutVertexBuffer2,qt.patternVertexBuffer,qt.zOffsetVertexBuffer]),null!=_e&&(_e.value=je)};if(Le&&!Lt){const Mn=f.stencilModeForClipping(Rt).ref;0===Mn&&Y&&L.clear({stencil:0});const qn={func:B.EQUAL,mask:255};Gn.u_alpha_discard_threshold=.8,Fi(new Bt(qn,Mn,255,B.KEEP,B.KEEP,B.INVERT)),Gn.u_alpha_discard_threshold=0,Fi(new Bt(qn,Mn,255,B.KEEP,B.KEEP,B.KEEP))}else Gn.u_alpha_discard_threshold=Le&&Lt&&vt?.8:0,Fi(Lt?Ct:f.stencilModeForClipping(Rt))}};let Re=f.depthModeForSublayer(0,bt.ReadOnly);const We=new bt(f.depthOcclusion?B.GREATER:B.LEQUAL,bt.ReadOnly,f.depthRangeFor3D);if(l.hasNonElevatedBuckets){const Ze=!Y&&f.terrain;0!==S&&Ze?u.w(`Occlusion opacity for layer ${l.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ze?u.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${l.id}.`):ze(p,Se,Re,Bt.disabled,!1,!0)}if(l.hasElevatedBuckets){"hd-road-markup"===I?z||(Re=We,Se.push("ELEVATED_ROADS")):(Se.push("ELEVATED"),Re=We,U&&Se.push(q?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),R&&Se.push("ELEVATION_REFERENCE_SEA"));const Ze=Le?f.stencilModeFor3D():Bt.disabled;f.forceTerrainMode=!0,ze(p,Se,Re,Ze,!0,!0),Le&&ze(p,Se,Re,Ze,!0,!1),f.forceTerrainMode=!1}Le&&(f.resetStencilClippingMasks(),Y&&L.clear({stencil:0})),0===S||f.depthOcclusion||Y||f.layersWithOcclusionOpacity.push(f.currentLayer)},fill:function(f,r,l,p){const _=l.paint.get("fill-color"),v=l.paint.get("fill-opacity");if(0===v.constantOr(1))return;const b=l.paint.get("fill-emissive-strength"),S=f.colorModeForDrapableLayerRenderPass(b),I=l.paint.get("fill-pattern"),P=f.opaquePassEnabledForLayer()&&!I.constantOr(1)&&1===_.constantOr(u.am.transparent).a&&1===v.constantOr(0)?"opaque":"translucent";let R="none";"none"!==l.layout.get("fill-elevation-reference")?R="road":0!==l.paint.get("fill-z-offset").constantOr(1)&&(R="offset");const z=!(!f.terrain||!f.terrain.enabled),L={painter:f,sourceCache:r,layer:l,coords:p,colorMode:S,elevationType:R,terrainEnabled:z,pass:P};if("shadow"!==f.renderPass)if("offset"!==R){if(If(L,!1),"road"===R){const B=!z&&"translucent"===f.renderPass;B&&wt(f,r,l,p,"geometry"),If(L,!0,Bt.disabled),B&&function(H){const{painter:U,sourceCache:q,layer:G,coords:Y,colorMode:ee}=H,ne=U.context.gl,le=H.painter.shadowRenderer,de=!!le&&le.enabled,pe=new bt(U.context.gl.LEQUAL,bt.ReadOnly,U.depthRangeFor3D);let ae=[0,0,0];if(de){const ue=U.style.directionalLight,Me=U.style.ambientLight;ue&&Me&&(ae=qa(U.style,ue,Me))}const ce=ue=>{for(const Me of Y){const ye=q.getTile(Me),je=ye.getBucket(G);if(!je)continue;const Le=je.elevatedStructures;if(!Le)continue;let Ge,rt;if(ue?(Ge=Le.renderableBridgeSegments,rt=Le.bridgeProgramConfigurations.get(G.id)):(Ge=Le.renderableTunnelSegments,rt=Le.tunnelProgramConfigurations.get(G.id)),!Ge||0===Ge.segments[0].primitiveLength)continue;rt.updatePaintBuffers(),U.prepareDrawTile();const Se=U.isTileAffectedByFog(Me),_e=[];de&&_e.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const ze=U.getOrCreateProgram("elevatedStructures",{config:rt,overrideFog:Se,defines:_e}),Re=U.translatePosMatrix(Me.projMatrix,ye,G.paint.get("fill-translate"),G.paint.get("fill-translate-anchor"));de&&le.setupShadows(ye.tileID.toUnwrapped(),ze,"vector-tile");const We=Lx(Re,ae);U.uploadCommonUniforms(U.context,ze,Me.toUnwrapped()),ze.draw(U,ne.TRIANGLES,pe,Bt.disabled,ee,Nt.backCCW,We,G.id,Le.vertexBuffer,Le.indexBuffer,Ge,G.paint,U.transform.zoom,rt,[Le.vertexBufferNormal])}};ce(!0),ce(!1)}(L)}}else If(L,!1,f.stencilModeFor3D());else f.shadowRenderer&&"road"===R&&!z&&function(B){const{painter:H,sourceCache:U,layer:q,coords:G}=B,Y=H.context.gl,ee=B.painter.shadowRenderer;for(const ne of G){const le=U.getTile(ne),de=le.getBucket(q);if(!de)continue;const pe=de.elevatedStructures;if(!pe||!pe.shadowCasterSegments||0===pe.shadowCasterSegments.segments[0].primitiveLength)continue;H.prepareDrawTile();const ae=de.bufferData.programConfigurations.get(q.id),ce=H.isTileAffectedByFog(ne),ue=H.getOrCreateProgram("elevatedStructuresDepth",{config:ae,overrideFog:ce}),Me=ee.calculateShadowPassMatrixFromTile(le.tileID.toUnwrapped());H.uploadCommonUniforms(H.context,ue,ne.toUnwrapped());const ye={u_matrix:Me,u_depth_bias:0};ue.draw(H,Y.TRIANGLES,ee.getShadowPassDepthMode(),Bt.disabled,ee.getShadowPassColorMode(),Nt.disabled,ye,q.id,pe.vertexBuffer,pe.indexBuffer,pe.shadowCasterSegments,q.paint,H.transform.zoom,ae)}}(L)},"fill-extrusion":function(f,r,l,p){const _=l.paint.get("fill-extrusion-opacity"),v=f.context,b=v.gl,S=f.terrain,I=S&&S.renderingToTexture;if(0===_)return;const P=f.conflationActive&&f.style.isLayerClipped(l,r.getSource()),R=f.style.order.indexOf(l.fqid);if(P&&function(z,L,B,H,U){for(const q of H){const G=L.getTile(q).getBucket(B);G&&(G.updateReplacement(q,z.replacementSource,U),G.uploadCentroid(z.context))}}(f,r,l,p,R),S||P)for(const z of p){const L=r.getTile(z).getBucket(l);L&&Vt(f.context,r,z,L,l,S,P)}if("shadow"===f.renderPass&&f.shadowRenderer){const z=f.shadowRenderer;if(S&&_<.65&&l._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof u.ab)return;const L=z.getShadowPassDepthMode(),B=z.getShadowPassColorMode();rh(f,r,l,p,L,Bt.disabled,B,P)}else if("translucent"===f.renderPass){const z=!l.paint.get("fill-extrusion-pattern").constantOr(1),L=l.paint.get("fill-extrusion-color").constantOr(u.am.white);if(!I&&0!==L.a){const B=new bt(f.context.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D);1===_&&z?rh(f,r,l,p,B,Bt.disabled,an.unblended,P):(rh(f,r,l,p,B,Bt.disabled,an.disabled,P),rh(f,r,l,p,B,f.stencilModeFor3D(),f.colorModeForRenderPass(),P),f.resetStencilClippingMasks())}if(f.style.enable3dLights()&&z&&(!S&&"globe"!==f.transform.projection.name||I)){const B=l.paint.get("fill-extrusion-opacity"),H=l.paint.get("fill-extrusion-ambient-occlusion-intensity"),U=l.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),q=l.paint.get("fill-extrusion-flood-light-intensity"),G="none"===l.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),Y=l.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(G?null:l.lut).toArray01().slice(0,3),ee=H>0&&U>0,ne=q>0,le=(ae,ce,ue)=>(1-ue)*ae+ue*ce,de=new il;de.translate=l.paint.get("fill-extrusion-translate"),de.translateAnchor=l.paint.get("fill-extrusion-translate-anchor"),de.edgeRadius=l.layout.get("fill-extrusion-edge-radius"),de.cutoffFadeRange=l.paint.get("fill-extrusion-cutoff-fade-range");const pe=ae=>{const ce=f.depthModeForSublayer(1,bt.ReadOnly,b.LEQUAL,!0),ue=l.paint.get(ae?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Me=le(.1,3,ue),ye=f._showOverdrawInspector;if(!ye){const je=new Bt({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),Le=new an([b.ONE,b.ONE,b.ONE,b.ONE],u.am.transparent,[!1,!1,!1,!0],b.MIN);jo(de,f,r,l,p,ce,je,Le,Nt.disabled,ae,"sdf",B,H,U,q,Y,Me,P,!1)}{const je=ye?Bt.disabled:new Bt({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),Le=ye?f.colorModeForRenderPass():new an([b.ONE_MINUS_DST_ALPHA,b.DST_ALPHA,b.ONE,b.ONE],u.am.transparent,[!0,!0,!0,!0]);jo(de,f,r,l,p,ce,je,Le,Nt.disabled,ae,"color",B,H,U,q,Y,Me,P,!1)}};if(I){const ae=(ce,ue,Me)=>{const ye=f.depthModeForSublayer(1,bt.ReadOnly,b.LEQUAL,!1),je=l.paint.get(ce?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Le=le(.1,3,je);{const Ge=new an([b.ONE,b.ONE,b.ONE,b.ONE],u.am.transparent,[!1,!1,!1,!0]);jo(de,f,r,l,p,ye,Bt.disabled,Ge,Nt.disabled,ce,"clear",B,H,U,q,Y,Le,P,ue)}{const Ge=new Bt({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),rt=new an([b.ONE,b.ONE,b.ONE,b.ONE],u.am.transparent,[!1,!1,!1,!0],b.MIN);jo(de,f,r,l,p,ye,Ge,rt,Nt.disabled,ce,"sdf",B,H,U,q,Y,Le,P,ue)}{const Ge=ce?b.ZERO:b.ONE_MINUS_DST_ALPHA,rt=new Bt({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),Se=new an([Ge,b.DST_ALPHA,b.ONE_MINUS_DST_ALPHA,b.ZERO],u.am.transparent,[!0,!0,!0,!0]);jo(de,f,r,l,p,ye,rt,Se,Nt.disabled,ce,"color",B,H,U,q,Y,Le,P,ue)}{const Ge=new an([b.ONE,b.ONE,b.ONE,ce?b.ZERO:b.ONE],u.am.transparent,[!1,!1,!1,!0],ce?b.FUNC_ADD:b.MAX);jo(de,f,r,l,p,ye,Bt.disabled,Ge,Nt.disabled,ce,"clear",B,H,U,q,Y,Le,P,ue,Me)}};if(ee||ne){let ce;if(f.prepareDrawTile(),S){const ue=S.drapeBufferSize[0],Me=S.drapeBufferSize[1];ce=S.framebufferCopyTexture,ce&&(!ce||ce.size[0]===ue&&ce.size[1]===Me)||(ce&&ce.destroy(),ce=S.framebufferCopyTexture=new u.T(v,new u.r({width:ue,height:Me}),b.RGBA8)),ce.bind(b.LINEAR,b.CLAMP_TO_EDGE),b.copyTexSubImage2D(b.TEXTURE_2D,0,0,0,0,0,ue,Me)}ee&&ae(!0,!1,ce),ne&&ae(!1,!0,ce)}}else ee&&pe(!0),ne&&pe(!1),(ee||ne)&&f.resetStencilClippingMasks()}}},building:function(f,r,l,p){f.currentLayer<f.firstLightBeamLayer&&(f.firstLightBeamLayer=f.currentLayer);const _=l.paint.get("building-ambient-occlusion-ground-intensity"),v=l.paint.get("building-ambient-occlusion-ground-radius"),b=l.paint.get("building-ambient-occlusion-ground-attenuation");let S=_>0&&v>0,I=!0;const P=l.paint.get("building-vertical-scale");P<1&&(I=!1);const R=f.conflationActive&&f.style.isLayerClipped(l,r.getSource()),z=f.style.order.indexOf(l.fqid);if(function(L,B,H,U,q,G){for(const Y of G){const ee=B.getTile(Y).getBucket(H);ee&&(q&&ee.updateReplacement(Y,L.replacementSource,U),ee.uploadUpdatedIndexBuffer(L.context))}}(f,r,l,z,R,p),function(L,B,H,U){for(const q of U){const G=B.getTile(q).getBucket(H);G&&G.needsEvaluation(L,H)&&(G.evaluate(H),G.uploadUpdatedColorBuffer(L.context))}}(f,r,l,p),l.resetLayerRenderingStats(f),f.shadowRenderer&&(f.shadowRenderer.useNormalOffset=!0),"shadow"===f.renderPass&&f.shadowRenderer){const L=f.shadowRenderer,B=[],H=L.getShadowPassDepthMode();Vc({painter:f,source:r,layer:l,coords:p,defines:B,blendMode:L.getShadowPassColorMode(),depthMode:H,verticalScale:P})}else if("translucent"===f.renderPass){S&&function(U,q,G,Y,ee,ne,le,de,pe,ae,ce,ue,Me){const ye=U.context.gl,je=U.depthModeForSublayer(1,bt.ReadOnly,ye.LEQUAL,!0),Le=.1*(1-(Ge=ce))+3*Ge;var Ge;const rt=U._showOverdrawInspector,Se=ue,_e=new il;rt||jo(_e,U,q,G,Y,je,new Bt({func:ye.ALWAYS,mask:255},255,255,ye.KEEP,ye.KEEP,ye.REPLACE),new an([ye.ONE,ye.ONE,ye.ONE,ye.ONE],u.am.transparent,[!1,!1,!1,!0],ye.MIN),Nt.disabled,true,"sdf",1,le,de,0,ae,Le,Se,!1);{const ze=rt?Bt.disabled:new Bt({func:ye.EQUAL,mask:255},255,255,ye.KEEP,ye.DECR,ye.DECR),Re=rt?U.colorModeForRenderPass():new an([ye.ONE_MINUS_DST_ALPHA,ye.DST_ALPHA,ye.ONE,ye.ONE],u.am.transparent,[!0,!0,!0,!0]);jo(_e,U,q,G,Y,je,ze,Re,Nt.disabled,true,"color",1,le,de,0,ae,Le,Se,!1)}}(f,r,l,p,0,0,_,v,0,[0,0,0],b,R);let L=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];I&&(L=L.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),f.shadowRenderer.useNormalOffset&&(L=L.concat("NORMAL_OFFSET"));const B=new bt(f.context.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D),H=f.colorModeForRenderPass();Vc({painter:f,source:r,layer:l,coords:p,defines:L,blendMode:H,depthMode:B,verticalScale:P})}else if("light-beam"===f.renderPass){const L=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],B=new bt(f.context.gl.LEQUAL,bt.ReadOnly,f.depthRangeFor3D);Vc({painter:f,source:r,layer:l,coords:p,defines:L,blendMode:an.alphaBlended,depthMode:B,verticalScale:P})}f.shadowRenderer&&(f.shadowRenderer.useNormalOffset=!1),f.resetStencilClippingMasks()},hillshade:function(f,r,l,p){if("offscreen"!==f.renderPass&&"translucent"!==f.renderPass||f.style.disableElevatedTerrain)return;const _=f.context,v=f.terrain&&f.terrain.renderingToTexture,[b,S]="translucent"!==f.renderPass||v?[{},p]:f.stencilConfigForOverlap(p);for(const I of S){const P=r.getTile(I);if(P.needsHillshadePrepare&&"offscreen"===f.renderPass)$p(f,P,l);else if("translucent"===f.renderPass){const R=f.depthModeForSublayer(0,bt.ReadOnly),z=l.paint.get("hillshade-emissive-strength"),L=f.colorModeForDrapableLayerRenderPass(z),B=v&&f.terrain?f.terrain.stencilModeForRTTOverlap(I):b[I.overscaledZ];Fs(f,I,P,l,R,B,L)}}_.viewport.set([0,0,f.width,f.height]),f.resetStencilClippingMasks()},raster:function(f,r,l,p,_,v){if("translucent"!==f.renderPass||0===l.paint.get("raster-opacity"))return;const b="globe"===f.transform.projection.name,S=0!==l.paint.get("raster-elevation"),I=S&&b;if(f.renderElevatedRasterBackface&&!I)return;const P=f.context,R=P.gl,z=r.getSource(),L=function(de,pe,ae,ce){const ue=pe.paint.get("raster-color"),Me="raster-array"===de.type,ye=[],je=pe.paint.get("raster-resampling"),Le=pe.paint.get("raster-color-mix");let Ge=pe.paint.get("raster-color-range");const rt=[Le[0],Le[1],Le[2],0],Se=Le[3];let _e="nearest"===je?ce.NEAREST:ce.LINEAR;if(Me&&(ye.push("RASTER_ARRAY"),ue||ye.push("RASTER_COLOR"),"linear"===je&&ye.push("RASTER_ARRAY_LINEAR"),_e=ce.NEAREST,!Ge&&de.rasterLayers)){const ze=de.rasterLayers.find(({id:Re})=>Re===pe.sourceLayer);ze&&ze.fields&&ze.fields.range&&(Ge=ze.fields.range)}if(Ge=Ge||[0,1],ue){ye.push("RASTER_COLOR"),ae.activeTexture.set(ce.TEXTURE2),pe.updateColorRamp(Ge);let ze=pe.colorRampTexture;ze||(ze=pe.colorRampTexture=new u.T(ae,pe.colorRamp,ce.RGBA8)),ze.bind(ce.LINEAR,ce.CLAMP_TO_EDGE)}return{mix:rt,range:Ge,offset:Se,defines:ye,resampling:_e}}(z,l,P,R);if(z instanceof u.aP&&!p.length&&!b)return;const B=l.paint.get("raster-emissive-strength"),H=f.colorModeForDrapableLayerRenderPass(B),U=f.terrain&&f.terrain.renderingToTexture,q=!f.options.moving,G="nearest"===l.paint.get("raster-resampling")?R.NEAREST:R.LINEAR;if(z instanceof u.aP&&!p.length&&(z.onNorthPole||z.onSouthPole)){const de=S?f.stencilModeFor3D():Bt.disabled;return void Mf(!!z.onNorthPole,null,f,r,l,B,L,Nt.disabled,de)}if(!p.length)return;const[Y,ee]=z instanceof u.aP||U?[{},p]:f.stencilConfigForOverlap(p),ne=ee[ee.length-1].overscaledZ;I&&L.defines.push("PROJECTION_GLOBE_VIEW"),S&&L.defines.push("RENDER_CUTOFF");const le=(de,pe,ae)=>{for(const ce of de){const ue=ce.toUnwrapped(),Me=r.getTile(ce);if(U&&(!Me||!Me.hasData()))continue;P.activeTexture.set(R.TEXTURE0);const ye=e_(Me,z,l,L);if(!ye||!ye.texture)continue;const{texture:je,mix:Le,offset:Ge,tileSize:rt,buffer:Se}=ye;let _e,ze;U?(_e=bt.disabled,ze=ce.projMatrix):S?(_e=new bt(R.LEQUAL,bt.ReadWrite,f.depthRangeFor3D),ze=b?Float32Array.from(f.transform.expandedFarZProjMatrix):f.transform.calculateProjMatrix(ue,q)):(_e=f.depthModeForSublayer(ce.overscaledZ-ne,1===l.paint.get("raster-opacity")?bt.ReadWrite:bt.ReadOnly,R.LESS),ze=f.transform.calculateProjMatrix(ue,q));const Re=f.terrain&&U?f.terrain.stencilModeForRTTOverlap(ce):Y[ce.overscaledZ],We=v?0:l.paint.get("raster-fade-duration");Me.registerFadeDuration(We);const Ze=r.findLoadedParent(ce,0),Ye=ns(Me,Ze,r,f.transform,We);let ct,Ct;f.terrain&&f.terrain.prepareDrawTile(),P.activeTexture.set(R.TEXTURE0),je.bind(G,R.CLAMP_TO_EDGE),P.activeTexture.set(R.TEXTURE1),Ze?(Ze.texture&&Ze.texture.bind(G,R.CLAMP_TO_EDGE),ct=Math.pow(2,Ze.tileID.overscaledZ-Me.tileID.overscaledZ),Ct=[Me.tileID.canonical.x*ct%1,Me.tileID.canonical.y*ct%1]):je.bind(G,R.CLAMP_TO_EDGE),"useMipmap"in je&&P.extTextureFilterAnisotropic&&f.transform.pitch>20&&R.texParameterf(R.TEXTURE_2D,P.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,P.extTextureFilterAnisotropicMax);const Lt=f.transform;let vt;const Rt=S?mv(Lt):[0,0,0,0];let At,qt,Kt,mn,Dn,Zt=0;if(I&&z instanceof u.aP&&z.coordinates.length>3)At=Float32Array.from(u.bh(u.dD(new u.cA(0,0,0)))),qt=Float32Array.from(Lt.globeMatrix),Kt=Float32Array.from(u.dz(Lt)),mn=[u.aD(Lt.center.lng),u.aH(Lt.center.lat)],vt=z.elevatedGlobePerspectiveTransform,Dn=z.elevatedGlobeGridMatrix||new Float32Array(9);else if(I){const un=u.dA(ce.canonical);Zt=u.dB(un.getCenter().lat),At=Float32Array.from(u.bh(u.dD(ce.canonical))),qt=Float32Array.from(Lt.globeMatrix),Kt=Float32Array.from(u.dz(Lt)),mn=[u.aD(Lt.center.lng),u.aH(Lt.center.lat)],vt=[0,0],Dn=Float32Array.from(u.dC(ce.canonical,un,Zt,Lt.worldSize/Lt._pixelsPerMercatorPixel))}else vt=z instanceof u.aP?z.perspectiveTransform:[0,0],At=new Float32Array(16),qt=new Float32Array(9),Kt=new Float32Array(16),mn=[0,0],Dn=new Float32Array(9);const An=wf(ze,At,qt,Kt,Dn,Ct||[0,0],u.ah(f.transform.zoom),mn,Rt,ct||1,Ye,l,vt,S?l.paint.get("raster-elevation"):0,2,Le,Ge,L.range,rt,Se,B),Ln=f.isTileAffectedByFog(ce),ei=f.getOrCreateProgram("raster",{defines:L.defines,overrideFog:Ln});if(f.uploadCommonUniforms(P,ei,ue),z instanceof u.aP){const un=z.elevatedGlobeVertexBuffer,kn=z.elevatedGlobeIndexBuffer;if(U||!b)z.boundsBuffer&&z.boundsSegments&&ei.draw(f,R.TRIANGLES,_e,Bt.disabled,H,Nt.disabled,An,l.id,z.boundsBuffer,f.quadTriangleIndexBuffer,z.boundsSegments);else if(un&&kn){const zn=Lt.zoom<=u.cX?z.elevatedGlobeSegments:z.getSegmentsForLongitude(Lt.center.lng);zn&&ei.draw(f,R.TRIANGLES,_e,Bt.disabled,H,pe,An,l.id,un,kn,zn)}}else if(I){_e=new bt(R.LEQUAL,bt.ReadOnly,f.depthRangeFor3D);const un=f.globeSharedBuffers;if(un){const[kn,zn,In]=un.getGridBuffers(Zt,!1);ei.draw(f,R.TRIANGLES,_e,ae||Re,f.colorModeForRenderPass(),pe,An,l.id,kn,zn,In)}}else{const{tileBoundsBuffer:un,tileBoundsIndexBuffer:kn,tileBoundsSegments:zn}=f.getTileBoundsBuffers(Me);ei.draw(f,R.TRIANGLES,_e,Re,H,Nt.disabled,An,l.id,un,kn,zn)}}if(!(z instanceof u.aP)&&I)for(const ce of de){const ue=ce.canonical.y===(1<<ce.canonical.z)-1;0===ce.canonical.y&&Mf(!0,ce,f,r,l,B,L,pe,ae||Bt.disabled),ue&&Mf(!1,ce,f,r,l,B,L,pe===Nt.frontCW?Nt.backCW:Nt.frontCW,ae||Bt.disabled)}};I?le(ee,f.renderElevatedRasterBackface?Nt.backCW:Nt.frontCW,f.stencilModeFor3D()):le(ee,Nt.disabled,void 0),f.resetStencilClippingMasks()},"raster-particle":function(f,r,l,p,_,v){"offscreen"===f.renderPass&&function(b,S,I,P){if(!P.length)return;const R=b.context,z=R.gl,L=S.getSource();if(!(L instanceof Rl))return;const B=Math.ceil(Math.sqrt(I.paint.get("raster-particle-count")));let H=I.particlePositionRGBAImage;if(!H||H.width!==B){const ee=function(ne){const le=ne*ne,de=new Uint8Array(4*le),pe=function(ce){return ce|=0,ce=Math.imul(2747636419^ce,2654435769),ce=Math.imul(ce^ce>>>16,2654435769),((ce=Math.imul(ce^ce>>>16,2654435769))>>>0)/4294967296},ae=1/1.1;for(let ce=0;ce<le;ce++){const ue=ae*(pe(2*ce+0)+tl),Me=ae*(pe(2*ce+1)+tl),ye=255*ue%1,je=255*Me%1,Le=ye,Ge=Me-je/255,rt=je;de[4*ce+0]=255*(ue-ye/255),de[4*ce+1]=255*Le,de[4*ce+2]=255*Ge,de[4*ce+3]=255*rt}return de}(B);H=I.particlePositionRGBAImage=new u.r({width:B,height:B},ee)}let U=I.particleFramebuffer;U?U.width!==B&&(U.destroy(),U=I.particleFramebuffer=R.createFramebuffer(B,B,!0,null)):U=I.particleFramebuffer=R.createFramebuffer(B,B,!0,null);const q=[];for(const ee of P){const ne=S.getTile(ee);if(!(ne instanceof kl))continue;const le=vo(ne,L,I);if(!le)continue;const de=[ne.tileSize,ne.tileSize];let pe=I.tileFramebuffer;pe||(pe=I.tileFramebuffer=R.createFramebuffer(de[0],de[1],!0,null));let ae=ne.rasterParticleState;ae||(ae=ne.rasterParticleState=new im(R,ee,de,H));const ce=ae.update(I.lastInvalidatedAt);ae.particleTextureDimension!==B&&ae.updateParticleTexture(ee,H);const ue=ae.targetColorTexture;ae.targetColorTexture=ae.backgroundColorTexture,ae.backgroundColorTexture=ue;const Me=ae.particleTexture0;ae.particleTexture0=ae.particleTexture1,ae.particleTexture1=Me,q.push([ee,le,ae,ce])}if(0===q.length)return;const G=u.q.now(),Y=I.previousDrawTimestamp?.001*(G-I.previousDrawTimestamp):.0167;if(I.previousDrawTimestamp=G,I.hasColorMap()){R.activeTexture.set(z.TEXTURE0+2);let ee=I.colorRampTexture;ee||(ee=I.colorRampTexture=new u.T(R,I.colorRamp,z.RGBA8)),ee.bind(z.LINEAR,z.CLAMP_TO_EDGE)}R.bindFramebuffer.set(I.tileFramebuffer.framebuffer),function(ee,ne,le){const de=ee.context,pe=de.gl,ae=ne.tileFramebuffer;de.activeTexture.set(pe.TEXTURE0);const ce={u_texture:0,u_opacity:1.05*(Me=ne.paint.get("raster-particle-fade-opacity-factor"))/(Me+.05)},ue=ee.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Me;for(const ye of le){const[,,je,Le]=ye;ae.colorAttachment.set(je.targetColorTexture.texture),de.viewport.set([0,0,ae.width,ae.height]),de.clear({color:u.am.transparent}),Le&&(je.backgroundColorTexture.bind(pe.NEAREST,pe.CLAMP_TO_EDGE),ue.draw(ee,pe.TRIANGLES,bt.disabled,Bt.disabled,an.alphaBlended,Nt.disabled,ce,ne.id,ee.viewportBuffer,ee.quadTriangleIndexBuffer,ee.viewportSegments))}}(b,I,q),function(ee,ne,le,de){const pe=ee.context,ae=pe.gl,ce=le.tileFramebuffer,ue="globe"===ee.transform.projection.name,Me=le.paint.get("raster-particle-max-speed");for(const ye of de){const[je,Le,Ge]=ye;pe.activeTexture.set(ae.TEXTURE0+0),Le.texture.bind(ae.LINEAR,ae.CLAMP_TO_EDGE),ce.colorAttachment.set(Ge.targetColorTexture.texture);const rt=ee.getOrCreateProgram("rasterParticleDraw",{defines:Le.defines,overrideFog:!1});pe.activeTexture.set(ae.TEXTURE0+1);const Se=Le.scalarData?[]:[0,1,2,3].map(Re=>u.e3[Re](je));Se.push(je);const _e=je.canonical.x,ze=je.canonical.y;for(const Re of Se){const We=ne.getTile(ue?Re.wrapped():Re);if(!We)continue;const Ze=We.rasterParticleState;if(!Ze)continue;const Ye=Re.canonical.x+(1<<Re.canonical.z)*(Re.wrap-je.wrap),ct=Re.canonical.y;Ze.particleTexture0.bind(ae.NEAREST,ae.CLAMP_TO_EDGE);const Ct=Jp(1,Ze.particleTexture0.size[0],[Ye-_e,ct-ze],0,Le.texture.size,2,Me,Le.textureOffset,Le.scale,Le.offset);rt.draw(ee,ae.POINTS,bt.disabled,Bt.disabled,an.alphaBlended,Nt.disabled,Ct,le.id,Ze.particleIndexBuffer,void 0,Ze.particleSegment)}}}(b,S,I,q),R.bindFramebuffer.set(I.particleFramebuffer.framebuffer),function(ee,ne,le,de){const pe=ee.context,ae=pe.gl,ce=ne.paint.get("raster-particle-max-speed"),ue=de*ne.paint.get("raster-particle-speed-factor")*.15,Me=(je=.01+1*ne.paint.get("raster-particle-reset-rate-factor"),Math.pow(je,6)),ye=ne.particleFramebuffer;var je;pe.viewport.set([0,0,ye.width,ye.height]);for(const je of le){const[,Le,Ge]=je;pe.activeTexture.set(ae.TEXTURE0+0),Le.texture.bind(ae.LINEAR,ae.CLAMP_TO_EDGE),pe.activeTexture.set(ae.TEXTURE0+1);const rt=Ge.particleTexture0;rt.bind(ae.NEAREST,ae.CLAMP_TO_EDGE);const Se=Ef(1,rt.size[0],0,Le.texture.size,ce,ue,Me,Le.textureOffset,Le.scale,Le.offset);ye.colorAttachment.set(Ge.particleTexture1.texture),pe.clear({color:u.am.transparent}),ee.getOrCreateProgram("rasterParticleUpdate",{defines:Le.defines}).draw(ee,ae.TRIANGLES,bt.disabled,Bt.disabled,an.unblended,Nt.disabled,Se,ne.id,ee.viewportBuffer,ee.quadTriangleIndexBuffer,ee.viewportSegments)}}(b,I,q,Y)}(f,r,l,p),"translucent"===f.renderPass&&(function(b,S,I,P,R){const z=b.context,L=z.gl,B=S.getSource().tileSize,H=5*(1-u.af(u.cI,u.cI+1,b.transform.zoom))*B+I.paint.get("raster-particle-elevation"),U=!b.options.moving,q="globe"===b.transform.projection.name;if(!P.length)return;const[G,Y]=b.stencilConfigForOverlap(P),ee=[];q&&ee.push("PROJECTION_GLOBE_VIEW");const ne=b.stencilModeFor3D();for(const le of Y){const de=le.toUnwrapped(),pe=S.getTile(le);if(!pe.rasterParticleState)continue;const ae=pe.rasterParticleState,ce=100;pe.registerFadeDuration(ce);const ue=S.findLoadedParent(le,0),Me=ns(pe,ue,S,b.transform,ce);let ye,je;b.terrain&&b.terrain.prepareDrawTile(),z.activeTexture.set(L.TEXTURE0),ae.targetColorTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),z.activeTexture.set(L.TEXTURE1),ue&&ue.rasterParticleState?(ue.rasterParticleState.targetColorTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),ye=Math.pow(2,ue.tileID.overscaledZ-pe.tileID.overscaledZ),je=[pe.tileID.canonical.x*ye%1,pe.tileID.canonical.y*ye%1]):ae.targetColorTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE);const Le=q?Float32Array.from(b.transform.expandedFarZProjMatrix):b.transform.calculateProjMatrix(de,U),Ge=b.transform,rt=Zl(Ge),Se=u.dA(le.canonical),_e=u.dB(Se.getCenter().lat);let ze,Re,We,Ze,Ye;q?(ze=Float32Array.from(u.bh(u.dD(le.canonical))),Re=Float32Array.from(Ge.globeMatrix),We=Float32Array.from(u.dz(Ge)),Ze=[u.aD(Ge.center.lng),u.aH(Ge.center.lat)],Ye=Float32Array.from(u.dC(le.canonical,Se,_e,Ge.worldSize/Ge._pixelsPerMercatorPixel))):(ze=new Float32Array(16),Re=new Float32Array(9),We=new Float32Array(16),Ze=[0,0],Ye=new Float32Array(9));const ct=ju(Le,ze,Re,We,Ye,je||[0,0],u.ah(b.transform.zoom),Ze,rt,ye||1,Me,H),Ct=b.isTileAffectedByFog(le),Lt=b.getOrCreateProgram("rasterParticle",{defines:ee,overrideFog:Ct});if(b.uploadCommonUniforms(z,Lt,de),q){const vt=new bt(L.LEQUAL,bt.ReadOnly,b.depthRangeFor3D),Rt=0,At=b.globeSharedBuffers;if(At){const[qt,Kt,mn]=At.getGridBuffers(_e,0!==Rt);Lt.draw(b,L.TRIANGLES,vt,ne,an.alphaBlended,b.renderElevatedRasterBackface?Nt.frontCCW:Nt.backCCW,ct,I.id,qt,Kt,mn)}}else{const vt=b.depthModeForSublayer(0,bt.ReadOnly),Rt=G[le.overscaledZ],{tileBoundsBuffer:At,tileBoundsIndexBuffer:qt,tileBoundsSegments:Kt}=b.getTileBoundsBuffers(pe);Lt.draw(b,L.TRIANGLES,vt,Rt,an.alphaBlended,Nt.disabled,ct,I.id,At,qt,Kt)}}b.resetStencilClippingMasks()}(f,r,l,p),f.style.map.triggerRepaint())},background:function(f,r,l,p){const _=l.paint.get("background-color"),v="none"===l.paint.get("background-color-use-theme").constantOr("default"),b=l.paint.get("background-opacity"),S=l.paint.get("background-emissive-strength"),I="viewport"===l.paint.get("background-pitch-alignment");if(0===b)return;const P=f.context,R=P.gl,z=f.transform,L=z.tileSize,B=l.paint.get("background-pattern");let H;if(void 0!==B&&(null===B||(H=f.imageManager.getPattern(u.I.from(B.toString()),l.scope,f.style.getLut(l.scope)),!H)))return;const U=!B&&1===_.a&&1===b&&f.opaquePassEnabledForLayer()?"opaque":"translucent";if(f.renderPass!==U)return;const q=Bt.disabled,G=f.depthModeForSublayer(0,"opaque"===U?bt.ReadWrite:bt.ReadOnly),Y=f.colorModeForDrapableLayerRenderPass(S),ee=B?"backgroundPattern":"background";let ne,le=p;if(le||(ne=f.getBackgroundTiles(),le=Object.values(ne).map(de=>de.tileID)),B&&(P.activeTexture.set(R.TEXTURE0),f.imageManager.bind(f.context,l.scope)),I){const de=f.getOrCreateProgram(ee,{overrideFog:!1,overrideRtt:!0}),pe=new Float32Array(u.bx([])),ae=new u.aM(0,0,0,0,0),ce=B?Tf(pe,S,b,f,0,l.scope,H,I,{tileID:ae,tileSize:L}):em(pe,S,b,_.toPremultipliedRenderColor(v?null:l.lut));de.draw(f,R.TRIANGLES,G,q,Y,Nt.disabled,ce,l.id,f.viewportBuffer,f.quadTriangleIndexBuffer,f.viewportSegments)}else for(const de of le){const pe=f.isTileAffectedByFog(de),ae=f.getOrCreateProgram(ee,{overrideFog:pe}),ce=de.toUnwrapped(),ue=p?de.projMatrix:f.transform.calculateProjMatrix(ce);f.prepareDrawTile();const Me=r?r.getTile(de):ne?ne[de.key]:new yc(de,L,z.zoom,f),ye=B?Tf(ue,S,b,f,0,l.scope,H,I,{tileID:de,tileSize:L}):em(ue,S,b,_.toPremultipliedRenderColor(v?null:l.lut));f.uploadCommonUniforms(P,ae,ce);const{tileBoundsBuffer:je,tileBoundsIndexBuffer:Le,tileBoundsSegments:Ge}=f.getTileBoundsBuffers(Me);ae.draw(f,R.TRIANGLES,G,q,Y,Nt.disabled,ye,l.id,je,Le,Ge)}},sky:function(f,r,l){const p=f._atmosphere?u.ah(f.transform.zoom):1,_=l.paint.get("sky-opacity")*p;if(0===_)return;const v=f.context,b=l.paint.get("sky-type"),S=new bt(v.gl.LEQUAL,bt.ReadOnly,[0,1]),I=f.frameCounter/1e3%1;"atmosphere"===b?"offscreen"===f.renderPass?l.needsSkyboxCapture(f)&&(function(P,R,z,L){const B=P.context,H=B.gl;let U=R.skyboxFbo;if(!U){U=R.skyboxFbo=B.createFramebuffer(32,32,!0,null),R.skyboxGeometry=new jc(B),R.skyboxTexture=B.gl.createTexture(),H.bindTexture(H.TEXTURE_CUBE_MAP,R.skyboxTexture),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MIN_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MAG_FILTER,H.LINEAR);for(let ee=0;ee<6;++ee)H.texImage2D(H.TEXTURE_CUBE_MAP_POSITIVE_X+ee,0,H.RGBA,32,32,0,H.RGBA,H.UNSIGNED_BYTE,null)}B.bindFramebuffer.set(U.framebuffer),B.viewport.set([0,0,32,32]);const q=R.getCenter(P,!0),G=P.getOrCreateProgram("skyboxCapture"),Y=new Float64Array(16);u.bx(Y),u.eh(Y,Y,.5*-Math.PI),xo(P,R,G,Y,q,0),u.bx(Y),u.eh(Y,Y,.5*Math.PI),xo(P,R,G,Y,q,1),u.bx(Y),u.cR(Y,Y,.5*-Math.PI),xo(P,R,G,Y,q,2),u.bx(Y),u.cR(Y,Y,.5*Math.PI),xo(P,R,G,Y,q,3),u.bx(Y),xo(P,R,G,Y,q,4),u.bx(Y),u.eh(Y,Y,Math.PI),xo(P,R,G,Y,q,5),B.viewport.set([0,0,P.width,P.height])}(f,l),l.markSkyboxValid(f)):"sky"===f.renderPass&&function(P,R,z,L,B){const H=P.context,U=H.gl,q=P.transform,G=P.getOrCreateProgram("skybox");H.activeTexture.set(U.TEXTURE0),U.bindTexture(U.TEXTURE_CUBE_MAP,R.skyboxTexture);const Y={u_matrix:q.skyboxMatrix,u_sun_direction:R.getCenter(P,!1),u_cubemap:0,u_opacity:L,u_temporal_offset:B};P.uploadCommonUniforms(H,G),G.draw(P,U.TRIANGLES,z,Bt.disabled,P.colorModeForRenderPass(),Nt.backCW,Y,"skybox",R.skyboxGeometry.vertexBuffer,R.skyboxGeometry.indexBuffer,R.skyboxGeometry.segment)}(f,l,S,_,I):"gradient"===b&&"sky"===f.renderPass&&function(P,R,z,L,B){const H=P.context,U=H.gl,q=P.transform,G=P.getOrCreateProgram("skyboxGradient");R.skyboxGeometry||(R.skyboxGeometry=new jc(H)),H.activeTexture.set(U.TEXTURE0);let Y=R.colorRampTexture;Y||(Y=R.colorRampTexture=new u.T(H,R.colorRamp,U.RGBA8)),Y.bind(U.LINEAR,U.CLAMP_TO_EDGE);const ee=(ne=q.skyboxMatrix,le=R.getCenter(P,!1),de=R.paint.get("sky-gradient-radius"),pe=L,ae=B,{u_matrix:ne,u_color_ramp:0,u_center_direction:le,u_radius:u.al(de),u_opacity:pe,u_temporal_offset:ae});var ne,le,de,pe,ae;P.uploadCommonUniforms(H,G),G.draw(P,U.TRIANGLES,z,Bt.disabled,P.colorModeForRenderPass(),Nt.backCW,ee,"skyboxGradient",R.skyboxGeometry.vertexBuffer,R.skyboxGeometry.indexBuffer,R.skyboxGeometry.segment)}(f,l,S,_,I)},custom:function(f,r,l,p){const _=f.context,v=l.implementation;if(!f.transform.projection.unsupportedLayers||!f.transform.projection.unsupportedLayers.includes("custom")||f.terrain&&(f.terrain.renderingToTexture||"offscreen"===f.renderPass)&&l.isDraped(r)){if("offscreen"===f.renderPass){const b=v.prerender;if(b){if(f.setCustomLayerDefaults(),_.setColorMode(f.colorModeForRenderPass()),"globe"===f.transform.projection.name){const S=f.transform.pointMerc;b.call(v,_.gl,f.transform.customLayerMatrix(),f.transform.getProjection(),f.transform.globeToMercatorMatrix(),u.ah(f.transform.zoom),[S.x,S.y],f.transform.pixelsPerMeterRatio)}else b.call(v,_.gl,f.transform.customLayerMatrix());_.setDirty(),f.setBaseState()}}else if("translucent"===f.renderPass){if(f.terrain&&f.terrain.renderingToTexture){const S=v.renderToTile;if(S){const I=p[0].canonical,P={x:I.x+p[0].wrap*(v.wrapTileId?0:1<<I.z),y:I.y,z:I.z};_.setDepthMode(bt.disabled),_.setStencilMode(Bt.disabled),_.setColorMode(f.colorModeForRenderPass()),f.setCustomLayerDefaults(),S.call(v,_.gl,P),_.setDirty(),f.setBaseState()}return}f.setCustomLayerDefaults(),_.setColorMode(f.colorModeForRenderPass()),_.setStencilMode(Bt.disabled);const b="3d"===v.renderingMode?new bt(f.context.gl.LEQUAL,bt.ReadWrite,f.depthRangeFor3D):f.depthModeForSublayer(0,bt.ReadOnly);if(_.setDepthMode(b),"globe"===f.transform.projection.name){const S=f.transform.pointMerc;v.render(_.gl,f.transform.customLayerMatrix(),f.transform.getProjection(),f.transform.globeToMercatorMatrix(),u.ah(f.transform.zoom),[S.x,S.y],f.transform.pixelsPerMeterRatio)}else v.render(_.gl,f.transform.customLayerMatrix());_.setDirty(),f.setBaseState(),_.bindFramebuffer.set(null)}}else u.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(f,r,l,p){if("opaque"===f.renderPass)return;const _=l.paint.get("model-opacity").constantOr(1);if(0===_)return;const v=l.paint.get("model-cast-shadows");if("shadow"===f.renderPass&&(!v||f.terrain&&_<.65&&l._transitionablePaint._values["model-opacity"].value.expression instanceof u.ab))return;const b=f.shadowRenderer,S=l.paint.get("model-receive-shadows");b&&(b.useNormalOffset=!0,S||(b.enabled=!1));const I=()=>{b&&(b.useNormalOffset=!0,S||(b.enabled=!0))},P=r.getSource();if("light-beam"===f.renderPass&&"batched-model"!==P.type)return;if("vector"===P.type||"geojson"===P.type)return function(G,Y,ee,ne,le){const de=G.transform;if("mercator"!==de.projection.name)return void u.w(`Drawing 3D models for ${de.projection.name} projection is not yet implemented`);const pe=de.getFreeCameraOptions().position;if(!G.modelManager)return;const ae=G.modelManager;ee.modelManager=ae;const ce=G.shadowRenderer;if(!ee._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ue=ee._unevaluatedLayout._values["model-id"],Me=Object.assign({},ee.layout.get("model-id").parameters),ye=G.style.order.indexOf(ee.fqid);for(const je of ne){const Le=Y.getTile(je).getBucket(ee);if(!Le||Le.projection.name!==de.projection.name)continue;const Ge=Le.getModelUris();Ge&&!Le.modelsRequested&&(ae.addModelsFromBucket(Ge,le),Le.modelsRequested=!0);const rt=qu(je,de);Me.zoom=rt;const Se=ue.possiblyEvaluate(Me);if($u(G,Le,je),da.shadowUniformsInitialized=!1,da.useSingleShadowCascade=!!ce&&0===ce.getMaxCascadeForTile(je.toUnwrapped()),"shadow"===G.renderPass&&ce){if(1===G.currentShadowCascade&&Le.isInsideFirstShadowMapFrustum)continue;const Re=de.calculatePosMatrix(je.toUnwrapped(),de.worldSize);if(da.tileMatrix.set(Re),da.shadowTileMatrix=Float32Array.from(ce.calculateShadowPassMatrixFromMatrix(Re)),da.aabb.min.fill(0),da.aabb.max[0]=da.aabb.max[1]=u.aj,da.aabb.max[2]=0,sm(Le,da,G,ee.scope))continue}const _e=1<<je.canonical.z,ze=[((pe.x-je.wrap)*_e-je.canonical.x)*u.aj,(pe.y*_e-je.canonical.y)*u.aj,pe.z*_e*u.aj];G.conflationActive&&Object.keys(Le.instancesPerModel).length>0&&G.style.isLayerClipped(ee,Y.getSource())&&Le.updateReplacement(je,G.replacementSource,ye,le)&&(Le.uploaded=!1,Le.upload(G.context));for(let Re in Le.instancesPerModel){const We=Le.instancesPerModel[Re];We.features.length>0&&(Re=Se.evaluate(We.features[0].feature,{}));const Ze=ae.getModel(Re,le);if(Ze||ae.hasURLBeenRequested(Re)||Le.modelUris.includes(Re)||(Le.modelUris.push(Re),Le.modelsRequested=!1),Ze&&Ze.uploaded)for(const Ye of Ze.nodes)om(G,ee,Ye,We,ze,je,da)}}}(f,r,l,p,"vector"===P.type?l.scope:""),void I();if(!P.loaded())return;if("batched-model"===P.type)return function(G,Y,ee,ne){ee.resetLayerRenderingStats(G);const le=G.context,de=G.transform,pe=G.style.fog,ae=G.shadowRenderer;if("mercator"!==de.projection.name)return void u.w(`Drawing 3D landmark models for ${de.projection.name} projection is not yet implemented`);const ce=G.transform.getFreeCameraOptions().position,ue=u.c1([],[ce.x,ce.y,ce.z],G.transform.worldSize),Me=u.eq([],ue),ye=u.bx([]),je=u.e9(de.center.lat,de.zoom),Le=u.bn([],[1,1,1/je]);u.bo(ye,ye,Me);const Ge=ee.paint.get("model-opacity").constantOr(1),rt=new bt(le.gl.LEQUAL,bt.ReadWrite,G.depthRangeFor3D),Se=new bt(le.gl.LEQUAL,bt.ReadOnly,G.depthRangeFor3D),_e=new u.d6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),ze="shadow"===G.renderPass,Re=ze&&ae?ae.getCurrentCascadeFrustum():de.getFrustum(de.scaleZoom(de.worldSize)),We=ee.paint.get("model-front-cutoff"),Ze=We[2]<1,Ye=mo(G,ee.paint.get("model-cutoff-fade-range")),ct=ee.getLayerRenderingStats();(function(Ct,Lt,vt,Rt){const At=Ct.terrain?Ct.terrain.exaggeration():0,qt=Ct.transform.zoom;for(const Kt of Rt){const mn=Lt.getTile(Kt).getBucket(vt);mn&&(mn.setFilter(vt.filter),Ct.conflationActive&&mn.updateReplacement(Kt,Ct.replacementSource),mn.evaluateTransform(Ct,vt),Ct.terrain&&At>0&&mn.elevationUpdate(Ct.terrain,At,Kt,vt.source),mn.needsReEvaluation(Ct,qt,vt)&&mn.evaluate(vt))}})(G,Y,ee,ne),function(){let Ct,Lt,vt;Ze?(Ct=ne.length-1,Lt=-1,vt=-1):(Ct=0,Lt=ne.length,vt=1);const Rt=new Float64Array(16),At=u.cx(),qt=new u.P(0,0);for(let Kt=Ct;Kt!==Lt;Kt+=vt){const mn=ne[Kt],Dn=Y.getTile(mn).getBucket(ee);if(!Dn||!Dn.uploaded)continue;let Zt=!1;ae&&(Zt=0===ae.getMaxCascadeForTile(mn.toUnwrapped()));const An=de.calculatePosMatrix(mn.toUnwrapped(),de.worldSize),Ln=Dn.modelTraits;!ze&&Ze&&(u.bi(Rt,An),u.ad(At,ue,Rt),qt.x=At[0],qt.y=At[1]);const ei=[];Dn.setFilter(ee.filter);for(const un of Dn.getNodesInfo()){if(un.hiddenByReplacement||!un.node.meshes)continue;const kn=un.node;let zn=0;G.terrain&&kn.elevation&&(zn=kn.elevation*G.terrain.exaggeration());const In=(()=>{const Vr=un.aabb;return _e.min=[...Vr.min],_e.max=[...Vr.max],_e.min[2]+=zn,_e.max[2]+=zn,u.ad(_e.min,_e.min,An),u.ad(_e.max,_e.max,An),_e})(),on=un.evaluatedScale;if(on[0]<=1&&on[1]<=1&&on[2]<=1&&0===In.intersects(Re))continue;if(!ze&&Ze){const Vr=.16666666666666666;un.cameraCollisionOpacity=ue[0]>In.min[0]&&ue[0]<In.max[0]&&ue[1]>In.min[1]&&ue[1]<In.max[1]&&ue[2]*je<In.max[2]&&kn.footprint&&u.bY(qt,kn.footprint)?Math.max(un.cameraCollisionOpacity-Vr,0):Math.min(1,un.cameraCollisionOpacity+Vr)}const ti=[...An],Gn=1/u.d4(mn.canonical),Fi=kn.anchor?kn.anchor[0]:0,Mn=kn.anchor?kn.anchor[1]:0;u.bo(ti,ti,[Fi*(on[0]-1)+un.evaluatedTranslation[0]*Gn,Mn*(on[1]-1)+un.evaluatedTranslation[1]*Gn,zn+un.evaluatedTranslation[2]]),u.cn(on,u.es)||u.cP(ti,ti,on);const qn=u.az([],ti,kn.matrix),ci=u.az([],de.expandedFarZProjMatrix,qn),mr=u.az([],de.expandedFarZProjMatrix,ti),lr=u.aA([],[Fi,Mn,zn,1],ci)[2];kn.hidden=!1;let tr=Ge;ze||(Ze&&(tr*=un.cameraCollisionOpacity,tr*=r_(ti,de,un.aabb,We)),tr*=i_(Ye,lr)),0!==tr?ei.push({nodeInfo:un,depth:lr,opacity:tr,wvpForNode:ci,wvpForTile:mr,nodeModelMatrix:qn,tileModelMatrix:ti}):kn.hidden=!0}ze||ei.sort((un,kn)=>!Ze||1===un.opacity&&1===kn.opacity?un.depth<kn.depth?-1:1:1===un.opacity?-1:1===kn.opacity?1:un.depth>kn.depth?-1:1);for(const un of ei){const kn=un.nodeInfo,zn=kn.node;let In=u.az([],Le,un.tileModelMatrix);u.az(In,ye,In);const on=u.bi([],In);u.ea(on,on),u.cP(on,on,kf),In=u.az(In,In,zn.matrix);const ti="light-beam"===G.renderPass,Gn="none"===ee.paint.get("model-color-use-theme").constantOr("default"),Fi=Ln&u.ex.HasMapboxMeshFeatures,Mn=Fi?0:kn.evaluatedRMEA[0][2];for(let qn=0;qn<zn.meshes.length;++qn){const ci=zn.meshes[qn],mr=qn===zn.lightMeshIndex;let lr=un.wvpForNode;if(mr){if(!ti&&!G.terrain&&G.shadowRenderer){G.currentLayer<G.firstLightBeamLayer&&(G.firstLightBeamLayer=G.currentLayer);continue}lr=un.wvpForTile}else if(ti)continue;const tr={defines:[]},Vr=[];if(!ze&&ae&&(ae.useNormalOffset=!!ci.normalBuffer),Gu(tr.defines,Vr,ci,G,Gn?null:ee.lut),Fi||tr.defines.push("DIFFUSE_SHADED"),Zt&&tr.defines.push("SHADOWS_SINGLE_CASCADE"),ct&&(ze?ct.numRenderedVerticesInShadowPass+=ci.vertexArray.length:ct.numRenderedVerticesInTransparentPass+=ci.vertexArray.length),ze){Lf(ci,un.nodeModelMatrix,G,ee);continue}let pa=null;if(pe){const wo=Sn(un.nodeModelMatrix,G.transform);if(pa=new Float32Array(wo),"globe"!==de.projection.name){const Zi=ci.aabb.min,Ji=ci.aabb.max,[wi,vr]=pe.getOpacityForBounds(wo,Zi[0],Zi[1],Ji[0],Ji[1]);tr.overrideFog=wi>=qe||vr>=qe}}const Ro=ci.material;let Bs;Ro.occlusionTexture&&Ro.occlusionTexture.offsetScale&&(Bs=Ro.occlusionTexture.offsetScale,tr.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const so=G.getOrCreateProgram("model",tr);!ze&&ae&&ae.setupShadowsFromMatrix(un.tileModelMatrix,so,ae.useNormalOffset),G.uploadCommonUniforms(le,so,null,pa);const Ys=Ro.pbrMetallicRoughness;Ys.metallicFactor=.9,Ys.roughnessFactor=.5;const Ks=Fc(new Float32Array(lr),new Float32Array(In),new Float32Array(on),new Float32Array(zn.matrix),G,un.opacity,Ys.baseColorFactor,Ro.emissiveFactor,Ys.metallicFactor,Ys.roughnessFactor,Ro,Mn,ee,[0,0,0],Bs);!mr&&(kn.hasTranslucentParts||un.opacity<1)&&so.draw(G,le.gl.TRIANGLES,rt,Bt.disabled,an.disabled,Nt.backCCW,Ks,ee.id,ci.vertexBuffer,ci.indexBuffer,ci.segments,ee.paint,G.transform.zoom,void 0,Vr),so.draw(G,le.gl.TRIANGLES,mr?Se:rt,Bt.disabled,mr||un.opacity<1||kn.hasTranslucentParts?an.alphaBlended:an.unblended,Nt.backCCW,Ks,ee.id,ci.vertexBuffer,ci.indexBuffer,ci.segments,ee.paint,G.transform.zoom,void 0,Vr)}}}}()}(f,r,l,p),void I();if("model"!==P.type)return;const R=P.getModels(),z=[],L=f.transform.getFreeCameraOptions().position,B=u.c1([],[L.x,L.y,L.z],f.transform.worldSize);u.eq(B,B);const H=[],U=[];let q=0;for(const G of R){const Y=l.paint.get("model-rotation").constantOr(null),ee=l.paint.get("model-scale").constantOr(null),ne=l.paint.get("model-translation").constantOr(null);G.computeModelMatrix(f,Y,ee,ne,!0,!0,!1);const le=u.bx([]),de=u.e9(G.position.lat,f.transform.zoom),pe=u.bn([],[1,1,1/de]);u.bo(le,le,B),z.push({zScaleMatrix:pe,negCameraPosMatrix:le});for(const ae of G.nodes)rm(f.transform,ae,G.matrix,f.transform.expandedFarZProjMatrix,q,H,U);q++}if(H.sort((G,Y)=>Y.depth-G.depth),"shadow"!==f.renderPass){if(1===_)for(const G of U)ah(G,f,l,z[G.modelIndex],Bt.disabled,f.colorModeForRenderPass());else{for(const G of U)ah(G,f,l,z[G.modelIndex],Bt.disabled,an.disabled);for(const G of U)ah(G,f,l,z[G.modelIndex],f.stencilModeFor3D(),f.colorModeForRenderPass());f.resetStencilClippingMasks()}for(const G of H)ah(G,f,l,z[G.modelIndex],Bt.disabled,f.colorModeForRenderPass());I()}else{for(const G of U)Lf(G.mesh,G.nodeModelMatrix,f,l);for(const G of H)Lf(G.mesh,G.nodeModelMatrix,f,l);I()}}},Xs={line:function(f,r,l){if(f.hasElevatedBuckets=!1,f.hasNonElevatedBuckets=!1,void 0!==f._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==f._unevaluatedLayout.getValue("line-z-offset")){if(r){const p=r.getVisibleCoordinates();for(const _ of p){const v=r.getTile(_).getBucket(f);if(v&&("none"!==v.elevationType?f.hasElevatedBuckets=!0:f.hasNonElevatedBuckets=!0,f.hasElevatedBuckets&&f.hasNonElevatedBuckets))break}}}else f.hasNonElevatedBuckets=!0},model:function(f,r,l){const p=r.getSource();if(!p.loaded())return;if("vector"===p.type||"geojson"===p.type)return void(l.modelManager&&l.modelManager.upload(l,"vector"===p.type?f.scope:""));if("batched-model"===p.type||"model"!==p.type)return;const _=p.getModels();for(const v of _)v.upload(l.context)},raster:function(f,r,l){const p=r.getSource();if(!(p instanceof Rl&&p.loaded()))return;const _=f.sourceLayer||p.rasterLayerIds&&p.rasterLayerIds[0];if(!_)return;const v=f.paint.get("raster-array-band")||p.getInitialBand(_);if(null==v)return;const b=r.getIds().map(S=>r.getTileByID(S));for(const S of b)S.updateNeeded(f.id,v)&&p.prepareTile(S,_,f.id,v)},"raster-particle":function(f,r,l){const p=r.getSource();if(!(p instanceof Rl&&p.loaded()))return;const _=f.sourceLayer||p.rasterLayerIds&&p.rasterLayerIds[0];if(!_)return;const v=f.paint.get("raster-particle-array-band")||p.getInitialBand(_);if(null==v)return;const b=r.getIds().map(S=>r.getTileByID(S));for(const S of b)S.updateNeeded(f.id,v)&&p.prepareTile(S,_,f.id,v)}},zf={fill:wt},bs={fill:function(f,r,l,p){if(!l.layout||"none"===l.layout.get("fill-elevation-reference"))return;const _=f.context.gl,v=new bt(_.LEQUAL,bt.ReadOnly,f.depthRangeFor3D),b=new Bt({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),S=f.transform.getFreeCameraOptions().position,I=f.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const P of p){const R=r.getTile(P),z=R.getBucket(l);if(!z)continue;const L=z.elevatedStructures;if(!L||0===L.depthSegments.segments[0].primitiveLength)continue;const B=Hu(P.toUnwrapped(),S),H=f.translatePosMatrix(P.projMatrix,R,l.paint.get("fill-translate"),l.paint.get("fill-translate-anchor")),U=Qp(H,B,0,1,0);I.draw(f,_.TRIANGLES,v,b,an.disabled,Nt.disabled,U,l.id,L.vertexBuffer,L.indexBuffer,L.depthSegments,l.paint,f.transform.zoom)}}};class Kl{constructor(r,l,p,_,v,b){this.context=new Sf(r,l),this.transform=p,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=v,this._timeStamp=u.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const S=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const P of S)this._debugParams.enabledLayers[P]=!0;v.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),v.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),v.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),v.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),v.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),v.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const P of S)v.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],P);this.occlusionParams=new Wu(v),this.setup(),this.numSublayers=Do.maxUnderzooming+Do.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new u.eE,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Hi(this),this._wireframeDebugCache=new xi,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const I=new u.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new u.T(this.context,I,r.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=_,this.worldview=b}updateTerrain(r,l){const p=!!r&&!!r.terrain&&this.transform.projection.supportsTerrain;if(!(p||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new bf(this,r));const _=this._terrain;this.transform.elevation=p?_:null,_.update(r,this.transform,l),this.transform.elevation&&!_.enabled&&(this.transform.elevation=null)}_updateFog(r){const l=r.fog;if(!l||"globe"===this.transform.projection.name||l.getOpacity(this.transform.pitch)<1||l.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[p,_]=l.getFovAdjustedRange(this.transform._fov);if(p>_)return void(this.transform.fogCullDistSq=null);const v=p+.78*(_-p);this.transform.fogCullDistSq=v*v}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(r){r&&!this._terrain&&(this._terrain=new bf(this,this.style)),this._forceTerrainMode=r}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(r,l){if(this.width=r*u.q.devicePixelRatio,this.height=l*u.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const p of this.style.order)this.style._mergedLayers[p].resize()}setup(){const r=this.context,l=new u.ba;l.emplaceBack(0,0),l.emplaceBack(u.aj,0),l.emplaceBack(0,u.aj),l.emplaceBack(u.aj,u.aj),this.tileExtentBuffer=r.createVertexBuffer(l,u.bc.members),this.tileExtentSegments=u.bd.simpleSegment(0,0,4,2);const p=new u.ba;p.emplaceBack(0,0),p.emplaceBack(u.aj,0),p.emplaceBack(0,u.aj),p.emplaceBack(u.aj,u.aj),this.debugBuffer=r.createVertexBuffer(p,u.bc.members),this.debugSegments=u.bd.simpleSegment(0,0,4,5);const _=new u.ba;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(-1,1),_.emplaceBack(1,1),this.viewportBuffer=r.createVertexBuffer(_,u.bc.members),this.viewportSegments=u.bd.simpleSegment(0,0,4,2);const v=new u.aZ;v.emplaceBack(0,0,0,0),v.emplaceBack(u.aj,0,u.aj,0),v.emplaceBack(0,u.aj,0,u.aj),v.emplaceBack(u.aj,u.aj,u.aj,u.aj),this.mercatorBoundsBuffer=r.createVertexBuffer(v,u.bf.members),this.mercatorBoundsSegments=u.bd.simpleSegment(0,0,4,2);const b=new u.a_;b.emplaceBack(0,1,2),b.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=r.createIndexBuffer(b);const S=new u.bb;for(const P of[0,1,3,2,0])S.emplaceBack(P);this.debugIndexBuffer=r.createIndexBuffer(S),this.emptyTexture=new u.T(r,new u.r({width:1,height:1},Uint8Array.of(0,0,0,0)),r.gl.RGBA8),this.identityMat=u.bz();const I=this.context.gl;this.stencilClearMode=new Bt({func:I.ALWAYS,mask:0},0,255,I.ZERO,I.ZERO,I.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(r){return r._makeTileBoundsBuffers(this.context,this.transform.projection),r._tileBoundsBuffer?{tileBoundsBuffer:r._tileBoundsBuffer,tileBoundsIndexBuffer:r._tileBoundsIndexBuffer,tileBoundsSegments:r._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const r=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,r.TRIANGLES,bt.disabled,this.stencilClearMode,an.disabled,Nt.disabled,Bu(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(r,l,p){if(!l||this.currentStencilSource===l.id||!r.isTileClipped()||!p||0===p.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let S=!1;for(const I of p)if(void 0===this._tileClippingMaskIDs[I.key]){S=!0;break}if(!S)return}this.currentStencilSource=l.id;const _=this.context,v=_.gl;this.nextStencilID+p.length>256&&this.clearStencil(),_.setColorMode(an.disabled),_.setDepthMode(bt.disabled);const b=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const S of p){const I=l.getTile(S),P=this._tileClippingMaskIDs[S.key]=this.nextStencilID++,{tileBoundsBuffer:R,tileBoundsIndexBuffer:z,tileBoundsSegments:L}=this.getTileBoundsBuffers(I);b.draw(this,v.TRIANGLES,bt.disabled,new Bt({func:v.ALWAYS,mask:0},P,255,v.KEEP,v.KEEP,v.REPLACE),an.disabled,Nt.disabled,Bu(S.projMatrix),"$clipping",R,z,L)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const r=this.nextStencilID++,l=this.context.gl;return new Bt({func:l.NOTEQUAL,mask:255},r,255,l.KEEP,l.KEEP,l.REPLACE)}stencilModeForClipping(r){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(r);const l=this.context.gl;return new Bt({func:l.EQUAL,mask:255},this._tileClippingMaskIDs[r.key],0,l.KEEP,l.KEEP,l.REPLACE)}stencilConfigForOverlap(r){const l=this.context.gl,p=r.sort((b,S)=>S.overscaledZ-b.overscaledZ),_=p[p.length-1].overscaledZ,v=p[0].overscaledZ-_+1;if(v>1){this.currentStencilSource=void 0,this.nextStencilID+v>256&&this.clearStencil();const b={};for(let S=0;S<v;S++)b[S+_]=new Bt({func:l.GEQUAL,mask:255},S+this.nextStencilID,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID+=v,[b,p]}return[{[_]:Bt.disabled},p]}colorModeForRenderPass(){const r=this.context.gl;return this._showOverdrawInspector?new an([r.CONSTANT_COLOR,r.ONE,r.CONSTANT_COLOR,r.ONE],new u.am(.125,.125,.125,0),[!0,!0,!0,!0]):"opaque"===this.renderPass?an.unblended:an.alphaBlended}colorModeForDrapableLayerRenderPass(r){const l=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new an([l.ONE,l.ONE_MINUS_SRC_ALPHA,l.CONSTANT_ALPHA,l.ONE_MINUS_SRC_ALPHA],new u.am(0,0,0,void 0===r?0:r),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(r,l,p,_=!1){if(this.depthOcclusion)return new bt(this.context.gl.GREATER,bt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!_)return bt.disabled;const v=1-((1+this.currentLayer)*this.numSublayers+r)*this.depthEpsilon;return new bt(p||this.context.gl.LEQUAL,l,[v,v])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const r=this.context.gl,l=Math.ceil(this.width),p=Math.ceil(this.height),_=this.context.bindFramebuffer.get(),v=r.getParameter(r.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===l&&this.depthFBO.height===p||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==l&&0!==p&&(this.depthFBO=new Nc(this.context,l,p,!1,"texture"),this.depthTexture=new u.T(this.context,{width:l,height:p,data:null},r.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(_),r.bindTexture(r.TEXTURE_2D,v),this.depthFBO&&(r.bindFramebuffer(r.READ_FRAMEBUFFER,null),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),r.blitFramebuffer(0,0,l,p,0,0,l,p,r.DEPTH_BUFFER_BIT,r.NEAREST),r.bindFramebuffer(r.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((r,l)=>r+l/this._fpsHistory.length,0))}render(r,l){const p=u.q.now();this._dt=p-this._timeStamp,this._timeStamp=p,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=r.map.repaint,this.style=r,this.options=l;const _=this.style._mergedLayers,v=!(!this.terrain||!this.terrain.enabled),b=()=>this.style._getOrder(v).filter(Se=>{const _e=_[Se];return!(_e.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[_e.type]});let S=b(),I=!1,P=!1,R=null;for(const Se of S){const _e=_[Se];"circle"===_e.type?I=!0:"building"===_e.type?R=_e:"symbol"===_e.type&&(_e.hasInitialOcclusionOpacityProperties?P=!0:I=!0)}let z=S.map(Se=>_[Se]);const L=this.style._mergedSourceCaches;this.imageManager=r.imageManager,this.modelManager=r.modelManager,this.symbolFadeChange=r.placement.symbolFadeChange(u.q.now()),this.imageManager.beginFrame();let B=0,H=!1;for(const Se in L){const _e=L[Se];_e.used&&(_e.prepare(this.context),_e.getSource().usedInConflation&&++B)}let U=!1;for(const Se of z)Se.isHidden(this.transform.zoom)||("clip"===Se.type&&(U=!0),this.prepareLayer(Se));const q={},G={},Y={},ee={},ne={};for(const Se in L){const _e=L[Se];q[Se]=_e.getVisibleCoordinates(),G[Se]=q[Se].slice().reverse(),Y[Se]=_e.getVisibleCoordinates(!0).reverse(),ee[Se]=_e.getShadowCasterCoordinates(),ne[Se]=_e.sortCoordinatesByDistance(q[Se])}const le=Se=>{const _e=this.style.getLayerSourceCache(Se);return _e&&_e.used?_e.getSource():null};if(B||U||this._clippingActiveLastFrame){const Se=[],_e=[];let ze=0;for(const Re of z)this.isSourceForClippingOrConflation(Re,le(Re))&&(Se.push(Re),_e.push(ze)),ze++;if(Se&&(U||Se.length>1)||this._clippingActiveLastFrame){U=!1;const Re=[];for(let We=0;We<Se.length;We++){const Ze=Se[We],Ye=_e[We],ct=this.style.getLayerSourceCache(Ze);if(!ct||!ct.used||!ct.getSource().usedInConflation&&"clip"!==Ze.type&&"building"!==Ze.type)continue;let Ct=u.eF,Lt=u.bW.None;const vt=[];let Rt=!0;if("building"===Ze.type)Ct=u.eH;else if("clip"===Ze.type){Ct=Ye;for(const At of Ze.layout.get("clip-layer-types"))Lt|="model"===At?u.bW.Model:"symbol"===At?u.bW.Symbol:u.bW.FillExtrusion;for(const At of Ze.layout.get("clip-layer-scope"))vt.push(At);Ze.isHidden(this.transform.zoom)?Rt=!1:U=!0}Rt&&Re.push({layer:Ze.fqid,cache:ct,order:Ct,clipMask:Lt,clipScope:vt})}this.replacementSource.setSources(Re),H=!0}}this._clippingActiveLastFrame=U,H||this.replacementSource.clear(),this.conflationActive=H,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Se=0;Se<z.length;Se++){const _e=z[Se],ze=_e.cutoffRange();if(this.longestCutoffRange=Math.max(ze,this.longestCutoffRange),ze>0){const Re=le(_e);Re&&(this.minCutoffZoom=Math.max(Re.minzoom,this.minCutoffZoom)),_e.minzoom&&(this.minCutoffZoom=Math.max(_e.minzoom,this.minCutoffZoom))}_e.is3D(v)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Se),this._lastOcclusionLayer=Se)}const de=this.style&&this.style.fog;de?(this._fogVisible=0!==de.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=de.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Y),this.opaquePassCutoff=0,S=b(),z=S.map(Se=>_[Se]));const pe=this._shadowRenderer;if(pe){pe.updateShadowParameters(this.transform,this.style.directionalLight);for(const Se in L)for(const _e of q[Se]){let ze={min:0,max:0};this.terrain&&(ze=this.terrain.getMinMaxForTile(_e)||ze),pe.addShadowReceiver(_e.toUnwrapped(),ze.min,ze.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new u.eG(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new De(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const ae=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),ce=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(ae&&!this._snow&&(this._snow=new Ff(this)),!ae&&this._snow&&(this._snow.destroy(),delete this._snow),ce&&!this._rain&&(this._rain=new Qr(this)),!ce&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),R){this.buildingTileBorderManager||(this.buildingTileBorderManager=new n_);const Se=this.style.getLayerSourceCache(R);this.buildingTileBorderManager.updateBorders(Se,R)}if(!js.has(this.context.gl))return;this.renderPass="offscreen";for(const Se of z){const _e=r.getLayerSourceCache(Se);if(!Se.hasOffscreenPass()||Se.isHidden(this.transform.zoom))continue;const ze=_e?G[_e.id]:void 0;("custom"===Se.type||"raster"===Se.type||"raster-particle"===Se.type||Se.isSky()||ze&&ze.length)&&this.renderLayer(this,_e,Se,ze)}this.depthRangeFor3D=[0,1-(z.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,ee)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ue="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),Me=(()=>{if(l.showOverdrawInspector)return u.am.black;const Se=this.style.fog;if(Se&&this.transform.projection.supportsFog){const _e=this.style.getLut(Se.scope);if(!ue){const ze="none"===Se.properties.get("color-use-theme"),Re=Se.properties.get("color").toNonPremultipliedRenderColor(ze?null:_e).toArray01();return new u.am(...Re)}if(ue){const ze="none"===Se.properties.get("space-color-use-theme"),Re=Se.properties.get("space-color").toNonPremultipliedRenderColor(ze?null:_e).toArray01();return new u.am(...Re)}}return u.am.transparent})();if(this.context.clear({color:Me,depth:1}),this.clearStencil(),this._showOverdrawInspector=l.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ue&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=S.length-1;this.currentLayer>=0;this.currentLayer--){const Se=z[this.currentLayer],_e=r.getLayerSourceCache(Se);if(Se.isSky())continue;const ze=_e?(Se.is3D(v)?ne:G)[_e.id]:void 0;this._renderTileClippingMasks(Se,_e,ze),this.renderLayer(this,_e,Se,ze)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ue&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||u.ah(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<S.length;this.currentLayer++){const Se=z[this.currentLayer],_e=r.getLayerSourceCache(Se);Se.isSky()&&this.renderLayer(this,_e,Se,_e?G[_e.id]:void 0)}function ye(Se,_e){let ze;return _e&&(ze=("symbol"===Se.type?Y:Se.is3D(v)?ne:G)[_e.id]),ze}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<S.length;){const Se=z[this.currentLayer];if("raster"===Se.type||"raster-particle"===Se.type){const _e=r.getLayerSourceCache(Se);this.renderLayer(this,_e,Se,ye(Se,_e))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let je=0;pe&&(je=pe.getShadowCastingLayerCount());let Le=!1,Ge=-1;for(let Se=0;Se<S.length;++Se){const _e=z[Se];_e.isHidden(this.transform.zoom)||_e.is3D(v)&&(Ge=Se)}P&&-1===Ge&&(I=!0);let rt=!1;for(;this.currentLayer<S.length;){const Se=z[this.currentLayer],_e=r.getLayerSourceCache(Se);if(Se.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Se)){if(Se.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!rt&&Se.is3D(v)&&!v){const ze=this.currentLayer,Re=We=>{for(this.currentLayer=0;this.currentLayer<z.length;this.currentLayer++){const Ze=z[this.currentLayer];if(zf[Ze.type]){const Ye=this.style.getLayerSourceCache(Ze);zf[Ze.type](this,Ye,Ze,ye(Ze,Ye),We)}}};Re("initialize"),Re("reset"),this.currentLayer=ze,rt=!0}if(I&&!Le&&this.terrain&&!this.transform.isOrthographic&&(Le=!0,this.blitDepth()),P&&-1!==Ge&&this.currentLayer===Ge+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(Se,_e,_e?q[_e.id]:void 0),this.renderLayer(this,_e,Se,ye(Se,_e)),!this.terrain&&pe&&je>0&&Se.hasShadowPass()&&0==--je){{this.clearStencil(),this.resetStencilClippingMasks();const ze=this.currentLayer;for(this.currentLayer=0;this.currentLayer<z.length;this.currentLayer++){const Re=z[this.currentLayer];if(bs[Re.type]){const We=this.style.getLayerSourceCache(Re);bs[Re.type](this,We,Re,ye(Re,We))}}this.currentLayer=ze}if(pe.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const ze=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=ze;this.currentLayer++){const Re=z[this.currentLayer];if(!Re.hasLightBeamPass())continue;const We=r.getLayerSourceCache(Re);this.renderLayer(this,We,Re,We?G[We.id]:void 0)}this.currentLayer=ze,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const ze=this.currentLayer;this.depthOcclusion=!0;for(const Re of this.layersWithOcclusionOpacity){this.currentLayer=Re;const We=z[this.currentLayer],Ze=r.getLayerSourceCache(We),Ye=Ze?G[Ze.id]:void 0;this.terrain||this._renderTileClippingMasks(We,Ze,Ze?q[Ze.id]:void 0),this.renderLayer(this,Ze,We,Ye)}this.depthOcclusion=!1,this.currentLayer=ze,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Se=null;z.forEach(_e=>{const ze=r.getLayerSourceCache(_e);ze&&!_e.isHidden(this.transform.zoom)&&ze.getVisibleCoordinates().length&&(!Se||Se.getSource().maxzoom<ze.getSource().maxzoom)&&(Se=ze)}),Se&&this.options.showTileBoundaries&&zs(this,Se,Se.getVisibleCoordinates(),u.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&zs(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new u.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Se){const _e=Se.transform.padding;oh(Se,Se.transform.height-(_e.top||0),3,ua),oh(Se,_e.bottom||0,3,Pf),sh(Se,_e.left||0,3,Rf),sh(Se,Se.transform.width-(_e.right||0),3,ar);const ze=Se.transform.centerPoint;var Re,We,Ze,Ye;Pa(Re=Se,(We=ze.x)-1,(Ze=Se.transform.height-ze.y)-10,2,20,Ye=Of),Pa(Re,We-10,Ze-1,20,2,Ye)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),H||(this.conflationActive=!1)}prepareLayer(r){this.gpuTimingStart(r);const{unsupportedLayers:l}=this.transform.projection,p=!l||!l.includes(r.type);if(Xs[r.type]&&(p||this.terrain&&"custom"===r.type)){const _=this.style.getLayerSourceCache(r);Xs[r.type](r,_,this)}this.gpuTimingEnd()}renderLayer(r,l,p,_){p.isHidden(this.transform.zoom)||("background"===p.type||"sky"===p.type||"custom"===p.type||"model"===p.type||"raster"===p.type||"raster-particle"===p.type||_&&_.length)&&(this.id=p.id,this.gpuTimingStart(p),r.transform.projection.unsupportedLayers&&r.transform.projection.unsupportedLayers.includes(p.type)&&(!r.terrain||"custom"!==p.type)||"clip"===p.type||Yl[p.type](r,l,p,_,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(r){if(!this.options.gpuTiming)return;const l=this.context.extTimerQuery,p=this.context.gl;let _=this.gpuTimers[r.id];_||(_=this.gpuTimers[r.id]={calls:0,cpuTime:0,query:p.createQuery()}),_.calls++,p.beginQuery(l.TIME_ELAPSED_EXT,_.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const r=this.context.extTimerQuery,l=this.context.gl,p=l.createQuery();this.deferredRenderGpuTimeQueries.push(p),l.beginQuery(r.TIME_ELAPSED_EXT,p)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const r=this.gpuTimers;return this.gpuTimers={},r}collectDeferredRenderGpuQueries(){const r=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],r}queryGpuTimers(r){const l={};for(const p in r){const _=r[p],v=this.context.extTimerQuery,b=v.getQueryParameter(_.query,this.context.gl.QUERY_RESULT)/1e6;v.deleteQueryEXT(_.query),l[p]=b}return l}queryGpuTimeDeferredRender(r){if(!this.options.gpuTimingDeferredRender)return 0;const l=this.context.gl;let p=0;for(const _ of r)p+=l.getQueryParameter(_,l.QUERY_RESULT)/1e6,l.deleteQuery(_);return p}translatePosMatrix(r,l,p,_,v){if(!p[0]&&!p[1])return r;const b=v?"map"===_?this.transform.angle:0:"viewport"===_?-this.transform.angle:0;if(b){const P=Math.sin(b),R=Math.cos(b);p=[p[0]*R-p[1]*P,p[0]*P+p[1]*R]}const S=[v?p[0]:u.aw(l,p[0],this.transform.zoom),v?p[1]:u.aw(l,p[1],this.transform.zoom),0],I=new Float32Array(16);return u.bo(I,r,S),I}saveTileTexture(r){if(r.context!==this.context)return;const l=r.size[0],p=this._tileTextures[l];p?p.push(r):this._tileTextures[l]=[r]}getTileTexture(r){const l=this._tileTextures[r];return l&&l.length>0?l.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(r,l,p){const _=void 0===p?this.terrain&&this.terrain.renderingToTexture:p,v=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===r||"terrainRaster"===r?(v.push("LIGHTING_3D_MODE"),v.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):_||v.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||v.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(v.push("TERRAIN"),this.linearFloatFilteringSupported()&&v.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&v.push("GLOBE"),!this._fogVisible||_||void 0!==l&&!l||v.push("FOG","FOG_DITHERING"),_&&v.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&v.push("OVERDRAW_INSPECTOR"),v}getOrCreateProgram(r,l){this.cache=this.cache||{};const p=l&&l.defines||[],_=l&&l.config,v=this.currentGlobalDefines(r,l&&l.overrideFog,l&&l.overrideRtt).concat(p),b=Yp.cacheKey(_o[r],r,v,_);return this.cache[b]||(this.cache[b]=new Yp(this.context,r,_o[r],_,tm[r],v)),this.cache[b]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const r=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(r.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new u.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(r,l){if(this.style.enable3dLights()){const p=this.style.directionalLight,_=this.style.ambientLight;if(p&&_){const v=((b,S,I)=>{const P=b.properties.get("direction"),R="none"===b.properties.get("color-use-theme"),z=b.properties.get("color").toNonPremultipliedRenderColor(R?null:I.getLut(b.scope)).toArray01(),L=b.properties.get("intensity"),B="none"===S.properties.get("color-use-theme"),H=S.properties.get("color").toNonPremultipliedRenderColor(B?null:I.getLut(S.scope)).toArray01(),U=S.properties.get("intensity"),q=[P.x,P.y,P.z],G=u.dI(H,U),Y=u.dI(z,L);return{u_lighting_ambient_color:G,u_lighting_directional_dir:q,u_lighting_directional_color:Y,u_ground_radiance:Hg(q,Y,G)}})(p,_,this.style);l.setLightsUniformValues(r,v)}}}uploadCommonUniforms(r,l,p,_,v){if(this.uploadCommonLightUniforms(r,l),this.terrain&&this.terrain.renderingToTexture)return;const b=this.style.fog;if(b){const S=b.getOpacity(this.transform.pitch),I=((P,R,z,L,B,H,U,q,G,Y,ee,ne)=>{const le=P.transform,de="none"===R.properties.get("color-use-theme"),pe=R.properties.get("color").toNonPremultipliedRenderColor(de?null:P.style.getLut(R.scope)).toArray01();pe[3]=L;const ae=P.frameCounter/1e3%1,[ce,ue]=R.properties.get("vertical-range");return{u_fog_matrix:z?le.calculateFogTileMatrix(z):ne||P.identityMat,u_fog_range:R.getFovAdjustedRange(le._fov),u_fog_color:pe,u_fog_horizon_blend:R.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(ce,ue),ue],u_fog_temporal_offset:ae,u_frustum_tl:B,u_frustum_tr:H,u_frustum_br:U,u_frustum_bl:q,u_globe_pos:G,u_globe_radius:Y,u_viewport:ee,u_globe_transition:u.ah(le.zoom),u_is_globe:+("globe"===le.projection.name)}})(this,b,p,S,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*u.q.devicePixelRatio,this.transform.height*u.q.devicePixelRatio],_);l.setFogUniformValues(r,I)}v&&l.setCutoffUniformValues(r,v.uniformValues)}setTileLoadedFlag(r){this.tileLoaded=r}saveCanvasCopy(){const r=this.canvasCopy();r&&(this.frameCopies.push(r),this.tileLoaded=!1)}canvasCopy(){const r=this.context.gl,l=r.createTexture();return r.bindTexture(r.TEXTURE_2D,l),r.copyTexImage2D(r.TEXTURE_2D,0,r.RGBA,0,0,r.drawingBufferWidth,r.drawingBufferHeight,0),l}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const r=this.style&&this.style.fog;return!!r&&0!==r.getOpacity(this.transform.pitch)}getBackgroundTiles(){const r=this._backgroundTiles,l=this._backgroundTiles={},p=this.transform.coveringTiles({tileSize:512});for(const _ of p)l[_.key]=r[_.key]||new yc(_,512,this.transform.tileZoom,this,void 0,this.worldview);return l}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(r,l){return!(!r.is3D(!(!this.terrain||!this.terrain.enabled))||"clip"!==r.type&&"building"!==r.type&&(r.minzoom&&r.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==r.sourceLayer&&"procedural_buildings"!==r.sourceLayer)&&(!l||"batched-model"!==l.type)))}isTileAffectedByFog(r){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let l=this._cachedTileFogOpacities[r.key];return l||(this._cachedTileFogOpacities[r.key]=l=this.style.fog.getOpacityForTile(r)),l[0]>=qe||l[1]>=qe}setupDepthForOcclusion(r,l,p){const _=this.context,v=_.gl,b=!!p;var S;p||(p={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),_.activeTexture.set(v.TEXTURE3),r&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(v.NEAREST,v.CLAMP_TO_EDGE),p.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],p.u_depth_range_unpack=[2/((S=this.depthRangeFor3D)[1]-S[0]),-1-2*S[0]/(S[1]-S[0])],p.u_occluder_half_size=.5*this.occlusionParams.occluderSize,p.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(v.NEAREST,v.CLAMP_TO_EDGE),_.activeTexture.set(v.TEXTURE0),b||l.setTerrainUniformValues(_,p)}}function Zu(f,r){let l=!1,p=null;const _=()=>{p=null,l&&(f(),p=setTimeout(_,r),l=!1)};return()=>(l=!0,p||_(),p)}class Xu{constructor(r){this._hashName=r&&encodeURIComponent(r),u.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Zu(this._updateHashUnthrottled.bind(this),300)}addTo(r){return this._map=r,window.addEventListener("hashchange",this._onHashChange,!1),r.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const r=this._map;if(!r)return"";const l=Yu(r);if(this._hashName){const p=this._hashName;let _=!1;const v=location.hash.slice(1).split("&").map(b=>{const S=b.split("=")[0];return S===p?(_=!0,`${S}=${l}`):b}).filter(b=>b);return _||v.push(`${p}=${l}`),`#${v.join("&")}`}return`#${l}`}_getCurrentHash(){const r=location.hash.replace("#","");if(this._hashName){let l;return r.split("&").map(p=>p.split("=")).forEach(p=>{p[0]===this._hashName&&(l=p)}),(l&&l[1]||"").split("/")}return r.split("/")}_onHashChange(){const r=this._map;if(!r)return!1;const l=this._getCurrentHash();if(l.length>=3&&!l.some(p=>isNaN(Number(p)))){const p=r.dragRotate.isEnabled()&&r.touchZoomRotate.isEnabled()?+(l[3]||0):r.getBearing();return r.jumpTo({center:[+l[2],+l[1]],zoom:+l[0],bearing:p,pitch:+(l[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Yu(f,r){const l=f.getCenter(),p=Math.round(100*f.getZoom())/100,_=Math.ceil((p*Math.LN2+Math.log(512/360/.5))/Math.LN10),v=Math.pow(10,_),b=Math.round(l.lng*v)/v,S=Math.round(l.lat*v)/v,I=f.getBearing(),P=f.getPitch();let R=r?`/${b}/${S}/${p}`:`${p}/${S}/${b}`;return(I||P)&&(R+="/"+Math.round(10*I)/10),P&&(R+=`/${Math.round(P)}`),R}const Gc={linearity:.3,easing:u.eI(0,0,.3,1)},Ra=u.h({deceleration:2500,maxSpeed:1400},Gc),lm=u.h({deceleration:20,maxSpeed:1400},Gc),ha=u.h({deceleration:1e3,maxSpeed:360},Gc),ch=u.h({deceleration:1e3,maxSpeed:90},Gc);class uh{constructor(r){this._map=r,this.clear()}clear(){this._inertiaBuffer=[]}record(r){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:u.q.now(),settings:r})}_drainInertiaBuffer(){const r=this._inertiaBuffer,l=u.q.now();for(;r.length>0&&l-r[0].time>160;)r.shift()}_onMoveEnd(r){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const l={zoom:0,bearing:0,pitch:0,pan:new u.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:v}of this._inertiaBuffer)l.zoom+=v.zoomDelta||0,l.bearing+=v.bearingDelta||0,l.pitch+=v.pitchDelta||0,v.panDelta&&l.pan._add(v.panDelta),v.around&&(l.around=v.around),v.pinchAround&&(l.pinchAround=v.pinchAround);const p=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,_={};if(l.pan.mag()){const v=qc(l.pan.mag(),p,u.h({},Ra,r||{}));_.offset=l.pan.mult(v.amount/l.pan.mag()),_.center=this._map.transform.center,$c(_,v)}if(l.zoom){const v=qc(l.zoom,p,lm);_.zoom=this._map.transform.zoom+v.amount,$c(_,v)}if(l.bearing){const v=qc(l.bearing,p,ha);_.bearing=this._map.transform.bearing+u.ay(v.amount,-179,179),$c(_,v)}if(l.pitch){const v=qc(l.pitch,p,ch);_.pitch=this._map.transform.pitch+v.amount,$c(_,v)}if(_.zoom||_.bearing){const v=void 0===l.pinchAround?l.around:l.pinchAround;_.around=v?this._map.unproject(v):this._map.getCenter()}return this.clear(),_.noMoveStart=!0,_}}function $c(f,r){(!f.duration||f.duration<r.duration)&&(f.duration=r.duration,f.easing=r.easing)}function qc(f,r,l){const{maxSpeed:p,linearity:_,deceleration:v}=l,b=u.ay(f*_/(r/1e3),-p,p),S=Math.abs(b)/(v*_);return{easing:l.easing,duration:1e3*S,amount:b*(S/2)}}class Mi extends u.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,l,p,_={}){const v=ra(l.getCanvasContainer(),p),b=l.unproject(v);super(r,u.h({point:v,lngLat:b,originalEvent:p},_)),this._defaultPrevented=!1,this.target=l}}class Ql extends u.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,l,p){const _="touchend"===r?p.changedTouches:p.touches,v=ba(l.getCanvasContainer(),_),b=v.map(I=>l.unproject(I)),S=v.reduce((I,P,R,z)=>I.add(P.div(z.length)),new u.P(0,0));super(r,{points:v,point:S,lngLats:b,lngLat:l.unproject(S),originalEvent:p}),this._defaultPrevented=!1}}class cm extends u.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,l){super("wheel",{originalEvent:l}),this._defaultPrevented=!1}}class um{constructor(r,l){this._map=r,this._clickTolerance=l.clickTolerance}reset(){this._mousedownPos=void 0}wheel(r){return this._firePreventable(new cm(this._map,r))}mousedown(r,l){return this._mousedownPos=l,this._firePreventable(new Mi(r.type,this._map,r))}mouseup(r){this._map.fire(new Mi(r.type,this._map,r))}preclick(r){const l=u.h({},r);l.type="preclick",this._map.fire(new Mi(l.type,this._map,l))}click(r,l){this._mousedownPos&&this._mousedownPos.dist(l)>=this._clickTolerance||(this.preclick(r),this._map.fire(new Mi(r.type,this._map,r)))}dblclick(r){return this._firePreventable(new Mi(r.type,this._map,r))}mouseover(r){this._map.fire(new Mi(r.type,this._map,r))}mouseout(r){this._map.fire(new Mi(r.type,this._map,r))}touchstart(r){return this._firePreventable(new Ql(r.type,this._map,r))}touchmove(r){this._map.fire(new Ql(r.type,this._map,r))}touchend(r){this._map.fire(new Ql(r.type,this._map,r))}touchcancel(r){this._map.fire(new Ql(r.type,this._map,r))}_firePreventable(r){if(this._map.fire(r),r.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Br{constructor(r){this._map=r}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(r){this._map.fire(new Mi(r.type,this._map,r))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Mi("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(r){this._delayContextMenu?this._contextMenuEvent=r:this._map.fire(new Mi(r.type,this._map,r)),this._map.listens("contextmenu")&&r.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class rl{constructor(r,l){this._map=r,this._el=r.getCanvasContainer(),this._container=r.getContainer(),this._clickTolerance=l.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(r,l){this.isEnabled()&&r.shiftKey&&0===r.button&&(fs(),this._startPos=this._lastPos=l,this._active=!0)}mousemoveWindow(r,l){if(!this._active)return;const p=l,_=this._startPos,v=this._lastPos;if(!_||!v||v.equals(p)||!this._box&&p.dist(_)<this._clickTolerance)return;this._lastPos=p,this._box||(this._box=fn("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",r));const b=Math.min(_.x,p.x),S=Math.max(_.x,p.x),I=Math.min(_.y,p.y),P=Math.max(_.y,p.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${b}px,${I}px)`,this._box.style.width=S-b+"px",this._box.style.height=P-I+"px")})}mouseupWindow(r,l){if(!this._active)return;const p=this._startPos,_=l;if(p&&0===r.button){if(this.reset(),Cl(),p.x!==_.x||p.y!==_.y)return this._map.fire(new u.A("boxzoomend",{originalEvent:r})),{cameraAnimation:v=>v.fitScreenCoordinates(p,_,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",r)}}keydown(r){this._active&&27===r.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",r))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Vs(),delete this._startPos,delete this._lastPos}_fireEvent(r,l){return this._map.fire(new u.A(r,{originalEvent:l}))}}function fr(f,r){const l={};for(let p=0;p<f.length;p++)l[f[p].identifier]=r[p];return l}class dm{constructor(r){this.reset(),this.numTouches=r.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(r,l,p){(this.centroid||p.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=r.timeStamp),p.length===this.numTouches&&(this.centroid=function(_){const v=new u.P(0,0);for(const b of _)v._add(b);return v.div(_.length)}(l),this.touches=fr(p,l)))}touchmove(r,l,p){if(this.aborted||!this.centroid)return;const _=fr(p,l);for(const v in this.touches){const b=_[v];(!b||b.dist(this.touches[v])>30)&&(this.aborted=!0)}}touchend(r,l,p){if((!this.centroid||r.timeStamp-this.startTime>500)&&(this.aborted=!0),0===p.length){const _=!this.aborted&&this.centroid;if(this.reset(),_)return _}}}class Jl{constructor(r){this.singleTap=new dm(r),this.numTaps=r.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(r,l,p){this.singleTap.touchstart(r,l,p)}touchmove(r,l,p){this.singleTap.touchmove(r,l,p)}touchend(r,l,p){const _=this.singleTap.touchend(r,l,p);if(_){const v=r.timeStamp-this.lastTime<500,b=!this.lastTap||this.lastTap.dist(_)<30;if(v&&b||this.reset(),this.count++,this.lastTime=r.timeStamp,this.lastTap=_,this.count===this.numTaps)return this.reset(),_}}}class hm{constructor(){this._zoomIn=new Jl({numTouches:1,numTaps:2}),this._zoomOut=new Jl({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(r,l,p){this._zoomIn.touchstart(r,l,p),this._zoomOut.touchstart(r,l,p)}touchmove(r,l,p){this._zoomIn.touchmove(r,l,p),this._zoomOut.touchmove(r,l,p)}touchend(r,l,p){const _=this._zoomIn.touchend(r,l,p),v=this._zoomOut.touchend(r,l,p);return _?(this._active=!0,r.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()+1,around:b.unproject(_)},{originalEvent:r})}):v?(this._active=!0,r.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()-1,around:b.unproject(v)},{originalEvent:r})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const fm={0:1,2:2},dh={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Wc{constructor(r){this.reset(),this._clickTolerance=r.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(r,l){return!1}_move(r,l){return{}}mousedown(r,l){if(this._lastPoint)return;const p=tf(r);this._correctButton(r,p)&&(this._lastPoint=l,this._eventButton=p)}mousemoveWindow(r,l){const p=this._lastPoint;if(p)if(r.preventDefault(),null!=this._eventButton&&function(_,v){const b=fm[v];return void 0===_.buttons||(_.buttons&b)!==b}(r,this._eventButton))this.reset();else if(this._moved||!(l.dist(p)<this._clickTolerance))return this._moved=!0,this._lastPoint=l,this._move(p,l)}mouseupWindow(r){this._lastPoint&&tf(r)===this._eventButton&&(this._moved&&Cl(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ku extends Wc{mousedown(r,l){super.mousedown(r,l),this._lastPoint&&(this._active=!0)}_correctButton(r,l){return 0===l&&!r.ctrlKey}_move(r,l){return{around:l,panDelta:l.sub(r)}}}class fa extends Wc{constructor(r){super(r),this._pitchRotateKey=r.pitchRotateKey?dh[r.pitchRotateKey]:void 0}_correctButton(r,l){return this._pitchRotateKey?0===l&&r[this._pitchRotateKey]:0===l&&r.ctrlKey||2===l}_move(r,l){const p=.8*(l.x-r.x);if(p)return this._active=!0,{bearingDelta:p}}contextmenu(r){this._pitchRotateKey||r.preventDefault()}}class pm extends Wc{constructor(r){super(r),this._pitchRotateKey=r.pitchRotateKey?dh[r.pitchRotateKey]:void 0}_correctButton(r,l){return this._pitchRotateKey?0===l&&r[this._pitchRotateKey]:0===l&&r.ctrlKey||2===l}_move(r,l){const p=-.5*(l.y-r.y);if(p)return this._active=!0,{pitchDelta:p}}contextmenu(r){this._pitchRotateKey||r.preventDefault()}}class hh{constructor(r,l){this._map=r,this._el=r.getCanvasContainer(),this._minTouches=1,this._clickTolerance=l.clickTolerance||1,this.reset(),u.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new u.P(0,0)}touchstart(r,l,p){return this._calculateTransform(r,l,p)}touchmove(r,l,p){if(this._active&&!(p.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===p.length&&!u.eJ())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return r.cancelable&&r.preventDefault(),this._calculateTransform(r,l,p)}}touchend(r,l,p){this._calculateTransform(r,l,p),this._active&&p.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(r,l,p){p.length>0&&(this._active=!0);const _=fr(p,l),v=new u.P(0,0),b=new u.P(0,0);let S=0;for(const P in _){const R=_[P],z=this._touches[P];z&&(v._add(R),b._add(R.sub(z)),S++,_[P]=R)}if(this._touches=_,S<this._minTouches||!b.mag())return;const I=b.div(S);return this._sum._add(I),this._sum.mag()<this._clickTolerance?void 0:{around:v.div(S),panDelta:I}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=fn("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Zc{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(r){}_move(r,l,p){return{}}touchstart(r,l,p){this._firstTwoTouches||p.length<2||(this._firstTwoTouches=[p[0].identifier,p[1].identifier],this._start([l[0],l[1]]))}touchmove(r,l,p){const _=this._firstTwoTouches;if(!_)return;r.preventDefault();const[v,b]=_,S=ec(p,l,v),I=ec(p,l,b);if(!S||!I)return;const P=this._aroundCenter?null:S.add(I).div(2);return this._move([S,I],P,r)}touchend(r,l,p){if(!this._firstTwoTouches)return;const[_,v]=this._firstTwoTouches,b=ec(p,l,_),S=ec(p,l,v);b&&S||(this._active&&Cl(),this.reset())}touchcancel(){this.reset()}enable(r){this._enabled=!0,this._aroundCenter=!!r&&"center"===r.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function ec(f,r,l){for(let p=0;p<f.length;p++)if(f[p].identifier===l)return r[p]}function fh(f,r){return Math.log(f/r)/Math.LN2}class mm extends Zc{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(r){this._startDistance=this._distance=r[0].dist(r[1])}_move(r,l){const p=this._distance;if(this._distance=r[0].dist(r[1]),this._active||!(Math.abs(fh(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:fh(this._distance,p),pinchAround:l}}}function Nf(f,r){return 180*f.angleWith(r)/Math.PI}class s_ extends Zc{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(r){this._startVector=this._vector=r[0].sub(r[1]),this._minDiameter=r[0].dist(r[1])}_move(r,l){const p=this._vector;if(this._vector=r[0].sub(r[1]),p&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Nf(this._vector,p),pinchAround:l}}_isBelowThreshold(r){this._minDiameter=Math.min(this._minDiameter,r.mag());const l=25/(Math.PI*this._minDiameter)*360,p=this._startVector;if(!p)return!1;const _=Nf(r,p);return Math.abs(_)<l}}function ol(f){return Math.abs(f.y)>Math.abs(f.x)}class Qu extends Zc{constructor(r){super(),this._map=r}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(r){this._lastPoints=r,ol(r[0].sub(r[1]))&&(this._valid=!1)}_move(r,l,p){const _=this._lastPoints;if(!_)return;const v=r[0].sub(_[0]),b=r[1].sub(_[1]);return this._map._cooperativeGestures&&!u.eJ()&&p.touches.length<3||(this._valid=this.gestureBeginsVertically(v,b,p.timeStamp),!this._valid)?void 0:(this._lastPoints=r,this._active=!0,{pitchDelta:(v.y+b.y)/2*-.5})}gestureBeginsVertically(r,l,p){if(void 0!==this._valid)return this._valid;const _=r.mag()>=2,v=l.mag()>=2;if(!_&&!v)return;if(!_||!v)return null==this._firstMove&&(this._firstMove=p),p-this._firstMove<100&&void 0;const b=r.y>0==l.y>0;return ol(r)&&ol(l)&&b}}const a_={panStep:100,bearingStep:15,pitchStep:10};class gv{constructor(){const r=a_;this._panStep=r.panStep,this._bearingStep=r.bearingStep,this._pitchStep=r.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(r){if(r.altKey||r.ctrlKey||r.metaKey)return;let l=0,p=0,_=0,v=0,b=0;switch(r.keyCode){case 61:case 107:case 171:case 187:l=1;break;case 189:case 109:case 173:l=-1;break;case 37:r.shiftKey?p=-1:(r.preventDefault(),v=-1);break;case 39:r.shiftKey?p=1:(r.preventDefault(),v=1);break;case 38:r.shiftKey?_=1:(r.preventDefault(),b=-1);break;case 40:r.shiftKey?_=-1:(r.preventDefault(),b=1);break;default:return}return this._rotationDisabled&&(p=0,_=0),{cameraAnimation:S=>{const I=S.getZoom();S.easeTo({duration:300,easeId:"keyboardHandler",easing:Bf,zoom:l?Math.round(I)+l*(r.shiftKey?2:1):I,bearing:S.getBearing()+p*this._bearingStep,pitch:S.getPitch()+_*this._pitchStep,offset:[-v*this._panStep,-b*this._panStep],center:S.getCenter()},{originalEvent:r})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Bf(f){return f*(2-f)}const _v=4.000244140625;class vv{constructor(r,l){this._map=r,this._el=r.getCanvasContainer(),this._handler=l,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,u.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(r){this._defaultZoomRate=r}setWheelZoomRate(r){this._wheelZoomRate=r}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(r){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!r&&"center"===r.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(r){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(r.ctrlKey||r.metaKey||this.isZooming()||u.eJ()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let l=r.deltaMode===WheelEvent.DOM_DELTA_LINE?40*r.deltaY:r.deltaY;const p=u.q.now(),_=p-(this._lastWheelEventTime||0);this._lastWheelEventTime=p,0!==l&&l%_v==0?this._type="wheel":0!==l&&Math.abs(l)<4?this._type="trackpad":_>400?(this._type=null,this._lastValue=l,this._timeout=window.setTimeout(this._onTimeout,40,r)):this._type||(this._type=Math.abs(_*l)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,l+=this._lastValue)),r.shiftKey&&l&&(l/=4),this._type&&(this._lastWheelEvent=r,this._delta-=l,this._active||this._start(r)),r.preventDefault()}_onTimeout(r){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(r)}_start(r){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const l=ra(this._el,r);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:l,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const r=this._map.transform;"wheel"===this._type&&r.projection.wrap&&(r._center.lng>=180||r._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const l=()=>r._terrainEnabled()&&this._aroundCoord?r.computeZoomRelativeTo(this._aroundCoord):r.zoom;if(0!==this._delta){const P="wheel"===this._type&&Math.abs(this._delta)>_v?this._wheelZoomRate:this._defaultZoomRate;let R=2/(1+Math.exp(-Math.abs(this._delta*P)));this._delta<0&&0!==R&&(R=1/R);const z=l(),L=Math.pow(2,z),B="number"==typeof this._targetZoom?r.zoomScale(this._targetZoom):L;this._targetZoom=Math.min(r.maxZoom,Math.max(r.minZoom,r.scaleZoom(B*R))),"wheel"===this._type&&(this._startZoom=z,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const p="number"==typeof this._targetZoom?this._targetZoom:l(),_=this._startZoom,v=this._easing;let b,S=!1;if("wheel"===this._type&&_&&v){const P=Math.min((u.q.now()-this._lastWheelEventTime)/200,1),R=v(P);b=u.ai(_,p,R),P<1?this._frameId||(this._frameId=!0):S=!0}else b=p,S=!0;this._active=!0,S&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let I=b-l();return I*this._lastDelta<0&&(I=0),{noInertia:!0,needsRenderFrame:!S,zoomDelta:I,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(r){let l=u.eK;if(this._prevEase){const p=this._prevEase,_=(u.q.now()-p.start)/p.duration,v=p.easing(_+.01)-p.easing(_),b=.27/Math.sqrt(v*v+1e-4)*.01,S=Math.sqrt(.0729-b*b);l=u.eI(b,S,.25,1)}return this._prevEase={start:u.q.now(),duration:r,easing:l},l}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=fn("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Gi{constructor(r,l){this._clickZoom=r,this._tapZoom=l}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class xv{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(r,l){return r.preventDefault(),{cameraAnimation:p=>{p.easeTo({duration:300,zoom:p.getZoom()+(r.shiftKey?-1:1),around:p.unproject(l)},{originalEvent:r})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class gm{constructor(){this._tap=new Jl({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(r,l,p){this._swipePoint||(this._tapTime&&r.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?p.length>0&&(this._swipePoint=l[0],this._swipeTouch=p[0].identifier):this._tap.touchstart(r,l,p))}touchmove(r,l,p){if(this._tapTime){if(this._swipePoint){if(p[0].identifier!==this._swipeTouch)return;const _=l[0],v=_.y-this._swipePoint.y;return this._swipePoint=_,r.preventDefault(),this._active=!0,{zoomDelta:v/128}}}else this._tap.touchmove(r,l,p)}touchend(r,l,p){this._tapTime?this._swipePoint&&0===p.length&&this.reset():this._tap.touchend(r,l,p)&&(this._tapTime=r.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Xc{constructor(r,l,p){this._el=r,this._mousePan=l,this._touchPan=p}enable(r){this._inertiaOptions=r||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class bv{constructor(r,l,p){this._pitchWithRotate=r.pitchWithRotate,this._mouseRotate=l,this._mousePitch=p}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class sl{constructor(r,l,p,_){this._el=r,this._touchZoom=l,this._touchRotate=p,this._tapDragZoom=_,this._rotationDisabled=!1,this._enabled=!0}enable(r){this._touchZoom.enable(r),this._rotationDisabled||this._touchRotate.enable(r),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Yc=f=>f.zoom||f.drag||f.pitch||f.rotate;class Ju extends u.A{}class _m{constructor(){this.constants=[1,1,.01],this.radius=0}setup(r,l){const p=u.at([],l,r);this.radius=u.ae(p[2]<0?u.eM([],p,this.constants):[p[0],p[1],0])}projectRay(r){u.eM(r,r,this.constants),u.au(r,r),u.eN(r,r,this.constants);const l=u.c1([],r,this.radius);if(l[2]>0){const p=u.c1([],[0,0,1],u.bG(l,[0,0,1])),_=u.c1([],u.au([],[l[0],l[1],0]),this.radius),v=u.d5([],l,u.c1([],u.at([],u.d5([],_,p),l),2));l[0]=v[0],l[1]=v[1]}return l}}function Ns(f){return f.panDelta&&f.panDelta.mag()||f.zoomDelta||f.bearingDelta||f.pitchDelta}class ph{constructor(r,l){this._map=r,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new uh(r),this._bearingSnap=l.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new _m,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(l),u.aV(["handleEvent","handleWindowEvent"],this);const p=this._el;this._listeners=[[p,"touchstart",{passive:!0}],[p,"touchmove",{passive:!1}],[p,"touchend",void 0],[p,"touchcancel",void 0],[p,"mousedown",void 0],[p,"mousemove",void 0],[p,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[p,"mouseover",void 0],[p,"mouseout",void 0],[p,"dblclick",void 0],[p,"click",void 0],[p,"keydown",{capture:!1}],[p,"keyup",void 0],[p,"wheel",{passive:!1}],[p,"contextmenu",void 0],[window,"blur",void 0]];for(const[_,v,b]of this._listeners){const S=_===document?this.handleWindowEvent:this.handleEvent;_.addEventListener(v,S,b)}}destroy(){for(const[r,l,p]of this._listeners){const _=r===document?this.handleWindowEvent:this.handleEvent;r.removeEventListener(l,_,p)}}_addDefaultHandlers(r){const l=this._map,p=l.getCanvasContainer();this._add("mapEvent",new um(l,r));const _=l.boxZoom=new rl(l,r);this._add("boxZoom",_);const v=new hm,b=new xv;l.doubleClickZoom=new Gi(b,v),this._add("tapZoom",v),this._add("clickZoom",b);const S=new gm;this._add("tapDragZoom",S);const I=l.touchPitch=new Qu(l);this._add("touchPitch",I);const P=new fa(r),R=new pm(r);l.dragRotate=new bv(r,P,R),this._add("mouseRotate",P,["mousePitch"]),this._add("mousePitch",R,["mouseRotate"]);const z=new Ku(r),L=new hh(l,r);l.dragPan=new Xc(p,z,L),this._add("mousePan",z),this._add("touchPan",L,["touchZoom","touchRotate"]);const B=new s_,H=new mm;l.touchZoomRotate=new sl(p,H,B,S),this._add("touchRotate",B,["touchPan","touchZoom"]),this._add("touchZoom",H,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Br(l));const U=l.scrollZoom=new vv(l,this);this._add("scrollZoom",U,["mousePan"]);const q=l.keyboard=new gv;this._add("keyboard",q);for(const G of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])r.interactive&&r[G]&&l[G].enable(r[G])}_add(r,l,p){this._handlers.push({handlerName:r,handler:l,allowed:p}),this._handlersById[r]=l}stop(r){if(!this._updatingCamera){for(const{handler:l}of this._handlers)l.reset();this._inertia.clear(),this._fireEvents({},{},r),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:r}of this._handlers)if(r.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Yc(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(r,l,p){for(const _ in r)if(_!==p&&(!l||l.indexOf(_)<0))return!0;return!1}handleWindowEvent(r){this.handleEvent(r,`${r.type}Window`)}_getMapTouches(r){const l=[];for(const p of r)this._el.contains(p.target)&&l.push(p);return l}handleEvent(r,l){this._updatingCamera=!0;const p="renderFrame"===r.type,_=p?void 0:r,v={needsRenderFrame:!1},b={},S={},I=r.touches?this._getMapTouches(r.touches):void 0,P=I?ba(this._el,I):p?void 0:ra(this._el,r);for(const{handlerName:L,handler:B,allowed:H}of this._handlers){if(!B.isEnabled())continue;let U;this._blockedByActive(S,H,L)?B.reset():B[l||r.type]&&(U=B[l||r.type](r,P,I),this.mergeHandlerResult(v,b,U,L,_),U&&U.needsRenderFrame&&this._triggerRenderFrame()),(U||B.isActive())&&(S[L]=B)}const R={};for(const L in this._previousActiveHandlers)S[L]||(R[L]=_);this._previousActiveHandlers=S,(Object.keys(R).length||Ns(v))&&(this._changes.push([v,b,R]),this._triggerRenderFrame()),(Object.keys(S).length||Ns(v))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:z}=v;z&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],z(this._map))}mergeHandlerResult(r,l,p,_,v){if(!p)return;u.h(r,p);const b={handlerName:_,originalEvent:p.originalEvent||v};void 0!==p.zoomDelta&&(l.zoom=b),void 0!==p.panDelta&&(l.drag=b),void 0!==p.pitchDelta&&(l.pitch=b),void 0!==p.bearingDelta&&(l.rotate=b)}_applyChanges(){const r={},l={},p={};for(const[_,v,b]of this._changes)_.panDelta&&(r.panDelta=(r.panDelta||new u.P(0,0))._add(_.panDelta)),_.zoomDelta&&(r.zoomDelta=(r.zoomDelta||0)+_.zoomDelta),_.bearingDelta&&(r.bearingDelta=(r.bearingDelta||0)+_.bearingDelta),_.pitchDelta&&(r.pitchDelta=(r.pitchDelta||0)+_.pitchDelta),void 0!==_.around&&(r.around=_.around),void 0!==_.aroundCoord&&(r.aroundCoord=_.aroundCoord),void 0!==_.pinchAround&&(r.pinchAround=_.pinchAround),_.noInertia&&(r.noInertia=_.noInertia),u.h(l,v),u.h(p,b);this._updateMapTransform(r,l,p),this._changes=[]}_updateMapTransform(r,l,p){const _=this._map,v=_.transform,b=Y=>[Y.x,Y.y,Y.z];if((Y=>{const ee=this._eventsInProgress.drag;return ee&&!this._handlersById[ee.handlerName].isActive()})()&&!Ns(r)){const Y=v.zoom;v.cameraElevationReference="sea",null!=this._originalZoom&&v._orthographicProjectionAtLowPitch&&"globe"!==v.projection.name&&0===v.pitch?(v.cameraElevationReference="ground",v.zoom=this._originalZoom):(v.recenterOnTerrain(),v.cameraElevationReference="ground"),Y!==v.zoom&&this._map._update(!0)}if(v._isCameraConstrained&&_._stop(!0),!Ns(r))return void this._fireEvents(l,p,!0);let{panDelta:S,zoomDelta:I,bearingDelta:P,pitchDelta:R,around:z,aroundCoord:L,pinchAround:B}=r;v._isCameraConstrained&&(I>0&&(I=0),v._isCameraConstrained=!1),void 0!==B&&(z=B),(I||(Y=>l[Y]&&!this._eventsInProgress[Y])("drag"))&&z&&(this._dragOrigin=b(v.pointCoordinate3D(z)),this._originalZoom=v.zoom,this._trackingEllipsoid.setup(v._camera.position,this._dragOrigin)),v.cameraElevationReference="sea",_._stop(!0),z=z||_.transform.centerPoint,P&&(v.bearing+=P),R&&(v.pitch+=R),v._updateCameraState();const H=[0,0,0];if(S)if("mercator"===v.projection.name){const Y=this._trackingEllipsoid.projectRay(v.screenPointToMercatorRay(z).dir),ee=this._trackingEllipsoid.projectRay(v.screenPointToMercatorRay(z.sub(S)).dir);H[0]=ee[0]-Y[0],H[1]=ee[1]-Y[1]}else{const Y=v.pointCoordinate(z);if("globe"===v.projection.name){S=S.rotate(-v.angle);const ee=v._pixelsPerMercatorPixel/v.worldSize;H[0]=-S.x*u.eL(u.aY(Y.y))*ee,H[1]=-S.y*u.eL(v.center.lat)*ee}else{const ee=v.pointCoordinate(z.sub(S));Y&&ee&&(H[0]=ee.x-Y.x,H[1]=ee.y-Y.y)}}const U=v.zoom,q=[0,0,0];if(I){const Y=b(L||v.pointCoordinate3D(z)),ee={dir:u.au([],u.at([],Y,v._camera.position))};if(ee.dir[2]<0){const ne=v.zoomDeltaToMovement(Y,I);u.c1(q,ee.dir,ne)}}const G=u.d5(H,H,q);v._translateCameraConstrained(G),I&&Math.abs(v.zoom-U)>1e-4&&v.recenterOnTerrain(),v.cameraElevationReference="ground",this._map._update(),r.noInertia||this._inertia.record(r),this._fireEvents(l,p,!0)}_fireEvents(r,l,p){const _=Yc(this._eventsInProgress),v=Yc(r),b={};for(const R in r){const{originalEvent:z}=r[R];this._eventsInProgress[R]||(b[`${R}start`]=z),this._eventsInProgress[R]=r[R]}!_&&v&&this._fireEvent("movestart",v.originalEvent);for(const R in b)this._fireEvent(R,b[R]);v&&this._fireEvent("move",v.originalEvent);for(const R in r){const{originalEvent:z}=r[R];this._fireEvent(R,z)}const S={};let I;for(const R in this._eventsInProgress){const{handlerName:z,originalEvent:L}=this._eventsInProgress[R];this._handlersById[z].isActive()||(delete this._eventsInProgress[R],I=l[z]||L,S[`${R}end`]=I)}for(const R in S)this._fireEvent(R,S[R]);const P=Yc(this._eventsInProgress);if(p&&(_||v)&&!P){this._updatingCamera=!0;const R=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),z=L=>0!==L&&-this._bearingSnap<L&&L<this._bearingSnap;R?(z(R.bearing||this._map.getBearing())&&(R.bearing=0),this._map.easeTo(R,{originalEvent:I})):(this._map.fire(new u.A("moveend",{originalEvent:I})),z(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(r,l){this._map.fire(new u.A(r,l?{originalEvent:l}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(r=>{this._frameId=void 0,this.handleEvent(new Ju("renderFrame",{timeStamp:r})),this._applyChanges()})}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const pr="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class ro extends u.E{constructor(r,l){super(),this._moving=!1,this._zooming=!1,this.transform=r,this._bearingSnap=l.bearingSnap,this._respectPrefersReducedMotion=!1!==l.respectPrefersReducedMotion,u.aV(["_renderFrameCallback"],this)}getCenter(){return new u.ci(this.transform.center.lng,this.transform.center.lat)}setCenter(r,l){return this.jumpTo({center:r},l)}panBy(r,l,p){return r=u.P.convert(r).mult(-1),this.panTo(this.transform.center,u.h({offset:r},l),p)}panTo(r,l,p){return this.easeTo(u.h({center:r},l),p)}getZoom(){return this.transform.zoom}setZoom(r,l){return this.jumpTo({zoom:r},l),this}zoomTo(r,l,p){return this.easeTo(u.h({zoom:r},l),p)}zoomIn(r,l){return this.zoomTo(this.getZoom()+1,r,l),this}zoomOut(r,l){return this.zoomTo(this.getZoom()-1,r,l),this}getBearing(){return this.transform.bearing}setBearing(r,l){return this.jumpTo({bearing:r},l),this}getPadding(){return this.transform.padding}setPadding(r,l){return this.jumpTo({padding:r},l),this}rotateTo(r,l,p){return this.easeTo(u.h({bearing:r},l),p)}resetNorth(r,l){return this.rotateTo(0,u.h({duration:1e3},r),l),this}resetNorthPitch(r,l){return this.easeTo(u.h({bearing:0,pitch:0,duration:1e3},r),l),this}snapToNorth(r,l){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(r,l):this}getPitch(){return this.transform.pitch}setPitch(r,l){return this.jumpTo({pitch:r},l),this}cameraForBounds(r,l){r=u.aG.convert(r);const p=l&&l.bearing||0,_=l&&l.pitch||0,v=r.getNorthWest(),b=r.getSouthEast();return this._cameraForBounds(this.transform,v,b,p,_,l)}_extendPadding(r){const l={top:0,right:0,bottom:0,left:0};return null==r?u.h({},l,this.transform.padding):"number"==typeof r?{top:r,bottom:r,right:r,left:r}:u.h({},l,r)}_extendCameraOptions(r){return(r=u.h({offset:[0,0],maxZoom:this.transform.maxZoom},r)).padding=this._extendPadding(r.padding),r}_minimumAABBFrustumDistance(r,l){const p=l.max[0]-l.min[0],_=l.max[1]-l.min[1];return p/_>r.aspect?p/(2*Math.tan(.5*r.fovX)*r.aspect):_/(2*Math.tan(.5*r.fovY)*r.aspect)}_cameraForBoundsOnGlobe(r,l,p,_,v,b){const S=r.clone(),I=this._extendCameraOptions(b);S.bearing=_,S.pitch=v;const P=u.ci.convert(l),R=u.ci.convert(p),z=.5*(P.lat+R.lat),L=.5*(P.lng+R.lng),B=u.eO(z,L),H=u.au([],B),U=u.au([],u.bF([],H,[0,1,0])),q=u.bF([],U,H),G=[U[0],U[1],U[2],0,q[0],q[1],q[2],0,H[0],H[1],H[2],0,0,0,0,1],Y=[B,u.eO(P.lat,P.lng),u.eO(R.lat,P.lng),u.eO(R.lat,R.lng),u.eO(P.lat,R.lng),u.eO(z,P.lng),u.eO(z,R.lng),u.eO(P.lat,L),u.eO(R.lat,L)];let ee=u.d6.fromPoints(Y.map(Re=>[u.bG(U,Re),u.bG(q,Re),u.bG(H,Re)]));const ne=u.ad([],ee.center,G);0===u.eP(ne)&&u.eQ(ne,0,0,1),u.au(ne,ne),u.c1(ne,ne,u.aB),S.center=u.eR(ne);const le=S.getWorldToCameraMatrix(),de=u.bi(new Float64Array(16),le);ee=u.d6.applyTransform(ee,u.az([],le,G));const pe=this._extendAABB(ee,S,I,_);if(!pe)return void u.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ee=pe,u.ad(ne,ne,le);const ae=.5*(ee.max[2]-ee.min[2]),ce=this._minimumAABBFrustumDistance(S,ee),ue=u.c1([],[0,0,1],ae),Me=u.d5(ue,ne,ue),ye=ce+(0===S.pitch?0:u.bD(ne,Me)),je=S.globeCenterInViewSpace,Le=u.at([],ne,[je[0],je[1],je[2]]);u.au(Le,Le),u.c1(Le,Le,ye);const Ge=u.d5([],ne,Le);u.ad(Ge,Ge,de);const rt=u.eB/u.aB,Se=u.ae(Ge),_e=u.cb(Math.max(Se*rt-u.eB,Number.EPSILON),0),ze=Math.min(S.zoomFromMercatorZAdjusted(_e),I.maxZoom);return ze>.5*(u.cX+u.cI)?(S.setProjection({name:"mercator"}),S.zoom=ze,this._cameraForBounds(S,l,p,_,v,b)):{center:S.center,zoom:ze,bearing:_,pitch:v}}_extendAABB(r,l,p,_){const v=.5*((p.padding.left||0)+(p.padding.right||0)),b=.5*((p.padding.top||0)+(p.padding.bottom||0)),S=b,I=v,P=v,R=b,z=l.width-(I+P),L=l.height-(S+R),B=u.at([],r.max,r.min),H=Math.min(z/B[0],L/B[1]),U=Math.min(l.scaleZoom(l.scale*H),p.maxZoom);if(isNaN(U))return null;const q=l.scale/l.zoomScale(U),G=new u.d6([r.min[0]-I*q,r.min[1]-R*q,r.min[2]],[r.max[0]+P*q,r.max[1]+S*q,r.max[2]]),Y=("number"==typeof p.offset.x&&"number"==typeof p.offset.y?new u.P(p.offset.x,p.offset.y):u.P.convert(p.offset)).rotate(-u.al(_));return G.center[0]-=Y.x*q,G.center[1]+=Y.y*q,G}queryTerrainElevation(r,l){const p=this.transform.elevation;return p?(l=u.h({},{exaggerated:!0},l),p.getAtPoint(u.ac.fromLngLat(r),null,l.exaggerated)):null}_cameraForBounds(r,l,p,_,v,b){if("globe"===r.projection.name)return this._cameraForBoundsOnGlobe(r,l,p,_,v,b);const S=r.clone(),I=this._extendCameraOptions(b);S.bearing=_,S.pitch=v;const P=u.ci.convert(l),R=u.ci.convert(p),z=new u.ci(P.lng,R.lat),L=new u.ci(R.lng,P.lat),B=S.project(P),H=S.project(R),U=this.queryTerrainElevation(P),q=this.queryTerrainElevation(R),G=this.queryTerrainElevation(z),Y=this.queryTerrainElevation(L),ee=[[B.x,B.y,Math.min(U||0,q||0,G||0,Y||0)],[H.x,H.y,Math.max(U||0,q||0,G||0,Y||0)]];let ne=u.d6.fromPoints(ee);const le=S.getWorldToCameraMatrix(),de=u.bi(new Float64Array(16),le);ne=u.d6.applyTransform(ne,le);const pe=this._extendAABB(ne,S,I,_);if(!pe)return void u.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ne=pe;const ae=.5*u.at([],ne.max,ne.min)[2],ce=this._minimumAABBFrustumDistance(S,ne),ue=[0,0,1,0];u.aA(ue,ue,le),u.eS(ue,ue);const Me=u.c1([],ue,ce+ae),ye=u.d5([],ne.center,Me);u.ad(ne.center,ne.center,de),u.ad(ye,ye,de);const je=S.unproject(new u.P(ne.center[0],ne.center[1])),Le=u.eT(S.projection,je),Ge=Math.pow(2,Le),rt=Math.min(S._zoomFromMercatorZ(ye[2]*S.pixelsPerMeter*Ge/S.worldSize),I.maxZoom);return S.mercatorFromTransition&&rt<.5*(u.cX+u.cI)?(S.setProjection({name:"globe"}),S.zoom=rt,this._cameraForBounds(S,l,p,_,v,b)):{center:je,zoom:rt,bearing:_,pitch:v}}fitBounds(r,l,p){const _=this.cameraForBounds(r,l);return this._fitInternal(_,l,p)}fitScreenCoordinates(r,l,p,_,v){const b=u.P.convert(r),S=u.P.convert(l),I=new u.P(Math.min(b.x,S.x),Math.min(b.y,S.y)),P=new u.P(Math.max(b.x,S.x),Math.max(b.y,S.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(b,S))return this;const R=this.transform.pointLocation3D(I),z=this.transform.pointLocation3D(P),L=this.transform.pointLocation3D(new u.P(I.x,P.y)),B=this.transform.pointLocation3D(new u.P(P.x,I.y)),H=[Math.min(R.lng,z.lng,L.lng,B.lng),Math.min(R.lat,z.lat,L.lat,B.lat)],U=[Math.max(R.lng,z.lng,L.lng,B.lng),Math.max(R.lat,z.lat,L.lat,B.lat)],q=_&&_.pitch?_.pitch:this.getPitch(),G=this._cameraForBounds(this.transform,H,U,p,q,_);return this._fitInternal(G,_,v)}_fitInternal(r,l,p){return r?(l=u.h(r,l)).linear?this.easeTo(l,p):this.flyTo(l,p):this}jumpTo(r,l){this.stop();const p=r.preloadOnly?this.transform.clone():this.transform;let _=!1,v=!1,b=!1;"zoom"in r&&p.zoom!==+r.zoom&&(_=!0,p.zoom=+r.zoom),void 0!==r.center&&(p.center=u.ci.convert(r.center)),"bearing"in r&&p.bearing!==+r.bearing&&(v=!0,p.bearing=+r.bearing),"pitch"in r&&p.pitch!==+r.pitch&&(b=!0,p.pitch=+r.pitch);const S="number"==typeof r.padding?this._extendPadding(r.padding):r.padding;if(null!=r.padding&&!p.isPaddingEqual(S))if(!1===r.retainPadding){const I=p.clone();I.padding=S,p.setLocationAtPoint(p.center,I.centerPoint)}else p.padding=S;return r.preloadOnly?(this._preloadTiles(p),this):(this.fire(new u.A("movestart",l)).fire(new u.A("move",l)),_&&this.fire(new u.A("zoomstart",l)).fire(new u.A("zoom",l)).fire(new u.A("zoomend",l)),v&&this.fire(new u.A("rotatestart",l)).fire(new u.A("rotate",l)).fire(new u.A("rotateend",l)),b&&this.fire(new u.A("pitchstart",l)).fire(new u.A("pitch",l)).fire(new u.A("pitchend",l)),this.fire(new u.A("moveend",l)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||u.w(pr),this.transform.getFreeCameraOptions()}setFreeCameraOptions(r,l){const p=this.transform;if(!p.projection.supportsFreeCamera)return u.w(pr),this;this.stop();const _=p.zoom,v=p.pitch,b=p.bearing;p.setFreeCameraOptions(r);const S=_!==p.zoom,I=v!==p.pitch,P=b!==p.bearing;return this.fire(new u.A("movestart",l)).fire(new u.A("move",l)),S&&this.fire(new u.A("zoomstart",l)).fire(new u.A("zoom",l)).fire(new u.A("zoomend",l)),P&&this.fire(new u.A("rotatestart",l)).fire(new u.A("rotate",l)).fire(new u.A("rotateend",l)),I&&this.fire(new u.A("pitchstart",l)).fire(new u.A("pitch",l)).fire(new u.A("pitchend",l)),this.fire(new u.A("moveend",l)),this}easeTo(r,l){this._stop(!1,r.easeId),(!1===(r=u.h({offset:[0,0],duration:500,easing:u.eK},r)).animate||this._prefersReducedMotion(r))&&(r.duration=0);const p=this.transform,_=this.getZoom(),v=this.getBearing(),b=this.getPitch(),S=this.getPadding(),I="zoom"in r?+r.zoom:_,P="bearing"in r?this._normalizeBearing(r.bearing,v):v,R="pitch"in r?+r.pitch:b,z=this._extendPadding(r.padding),L=u.P.convert(r.offset);let B,H,U;if("globe"===p.projection.name){const ue=u.ac.fromLngLat(p.center),Me=L.rotate(-p.angle);ue.x+=Me.x/p.worldSize,ue.y+=Me.y/p.worldSize;const ye=ue.toLngLat(),je=u.ci.convert(r.center||ye);this._normalizeCenter(je),B=p.centerPoint.add(Me),H=new u.P(ue.x,ue.y).mult(p.worldSize),U=new u.P(u.aD(je.lng),u.aH(je.lat)).mult(p.worldSize).sub(H)}else{B=p.centerPoint.add(L);const ue=p.pointLocation(B),Me=u.ci.convert(r.center||ue);this._normalizeCenter(Me),H=p.project(ue),U=p.project(Me).sub(H)}const q=p.zoomScale(I-_);let G,Y;r.around&&(G=u.ci.convert(r.around),Y=p.locationPoint(G));const ee=this._zooming||I!==_,ne=this._rotating||v!==P,le=this._pitching||R!==b,de=!p.isPaddingEqual(z),pe=!1===r.retainPadding?p.clone():p,ae=ue=>Me=>{if(ee&&(ue.zoom=u.ai(_,I,Me)),ne&&(ue.bearing=u.ai(v,P,Me)),le&&(ue.pitch=u.ai(b,R,Me)),de&&(pe.interpolatePadding(S,z,Me),B=pe.centerPoint.add(L)),G)ue.setLocationAtPoint(G,Y);else{const ye=ue.zoomScale(ue.zoom-_),je=I>_?Math.min(2,q):Math.max(.5,q),Le=Math.pow(je,1-Me),Ge=ue.unproject(H.add(U.mult(Me*Le)).mult(ye));ue.setLocationAtPoint(ue.renderWorldCopies?Ge.wrap():Ge,B)}return r.preloadOnly||this._fireMoveEvents(l),ue};if(r.preloadOnly){const ue=this._emulate(ae,r.duration,p);return this._preloadTiles(ue),this}const ce={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=ee,this._rotating=ne,this._pitching=le,this._padding=de,this._easeId=r.easeId,this._prepareEase(l,r.noMoveStart,ce),this._ease(ae(p),ue=>{"sea"===p.cameraElevationReference&&p.recenterOnTerrain(),this._afterEase(l,ue)},r),this}_prepareEase(r,l,p={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),l||p.moving||this.fire(new u.A("movestart",r)),this._zooming&&!p.zooming&&this.fire(new u.A("zoomstart",r)),this._rotating&&!p.rotating&&this.fire(new u.A("rotatestart",r)),this._pitching&&!p.pitching&&this.fire(new u.A("pitchstart",r))}_fireMoveEvents(r){this.fire(new u.A("move",r)),this._zooming&&this.fire(new u.A("zoom",r)),this._rotating&&this.fire(new u.A("rotate",r)),this._pitching&&this.fire(new u.A("pitch",r))}_afterEase(r,l){if(this._easeId&&l&&this._easeId===l)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const p=this._zooming,_=this._rotating,v=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,p&&this.fire(new u.A("zoomend",r)),_&&this.fire(new u.A("rotateend",r)),v&&this.fire(new u.A("pitchend",r)),this.fire(new u.A("moveend",r))}flyTo(r,l){if(this._prefersReducedMotion(r)){const Re=u.aF(r,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Re,l)}this.stop(),r=u.h({offset:[0,0],speed:1.2,curve:1.42,easing:u.eK},r);const p=this.transform,_=this.getZoom(),v=this.getBearing(),b=this.getPitch(),S=this.getPadding(),I="zoom"in r?u.ay(+r.zoom,p.minZoom,p.maxZoom):_,P="bearing"in r?this._normalizeBearing(r.bearing,v):v,R="pitch"in r?+r.pitch:b,z=this._extendPadding(r.padding),L=p.zoomScale(I-_),B=u.P.convert(r.offset);let H=p.centerPoint.add(B);const U=p.pointLocation(H),q=u.ci.convert(r.center||U);this._normalizeCenter(q);const G=p.project(U),Y=p.project(q).sub(G);let ee=r.curve;const ne=Math.max(p.width,p.height),le=ne/L,de=Y.mag();if("minZoom"in r){const Re=u.ay(Math.min(r.minZoom,_,I),p.minZoom,p.maxZoom),We=ne/p.zoomScale(Re-_);ee=Math.sqrt(We/de*2)}const pe=ee*ee;function ae(Re){const We=(le*le-ne*ne+(Re?-1:1)*pe*pe*de*de)/(2*(Re?le:ne)*pe*de);return Math.log(Math.sqrt(We*We+1)-We)}function ce(Re){return(Math.exp(Re)-Math.exp(-Re))/2}function ue(Re){return(Math.exp(Re)+Math.exp(-Re))/2}const Me=ae(0);let ye=function(Re){return ue(Me)/ue(Me+ee*Re)},je=function(Re){return ne*((ue(Me)*(ce(We=Me+ee*Re)/ue(We))-ce(Me))/pe)/de;var We},Le=(ae(1)-Me)/ee;if(Math.abs(de)<1e-6||!isFinite(Le)){if(Math.abs(ne-le)<1e-6)return this.easeTo(r,l);const Re=le<ne?-1:1;Le=Math.abs(Math.log(le/ne))/ee,je=function(){return 0},ye=function(We){return Math.exp(Re*ee*We)}}r.duration="duration"in r?+r.duration:1e3*Le/("screenSpeed"in r?+r.screenSpeed/ee:+r.speed),r.maxDuration&&r.duration>r.maxDuration&&(r.duration=0);const Ge=v!==P,rt=R!==b,Se=!p.isPaddingEqual(z),_e=!1===r.retainPadding?p.clone():p,ze=Re=>We=>{const Ze=We*Le,Ye=1/ye(Ze);Re.zoom=1===We?I:_+Re.scaleZoom(Ye),Ge&&(Re.bearing=u.ai(v,P,We)),rt&&(Re.pitch=u.ai(b,R,We)),Se&&(_e.interpolatePadding(S,z,We),H=_e.centerPoint.add(B));const ct=1===We?q:Re.unproject(G.add(Y.mult(je(Ze))).mult(Ye));return Re.setLocationAtPoint(Re.renderWorldCopies?ct.wrap():ct,H),Re._updateCameraOnTerrain(),r.preloadOnly||this._fireMoveEvents(l),Re};if(r.preloadOnly){const Re=this._emulate(ze,r.duration,p);return this._preloadTiles(Re),this}return this._zooming=!0,this._rotating=Ge,this._pitching=rt,this._padding=Se,this._prepareEase(l,!1),this._ease(ze(p),()=>this._afterEase(l),r),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(r){}_cancelRenderFrame(r){}_stop(r,l){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const p=this._onEaseEnd;this._onEaseEnd=void 0,p.call(this,l)}if(!r){const p=this.handlers;p&&p.stop(!1)}return this}_ease(r,l,p){!1===p.animate||0===p.duration?(r(1),l()):(this._easeStart=u.q.now(),this._easeOptions=p,this._onEaseFrame=r,this._onEaseEnd=l,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const r=Math.min((u.q.now()-this._easeStart)/this._easeOptions.duration,1),l=this._onEaseFrame;l&&l(this._easeOptions.easing(r)),r<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(r,l){r=u.bQ(r,-180,180);const p=Math.abs(r-l);return Math.abs(r-360-l)<p&&(r-=360),Math.abs(r+360-l)<p&&(r+=360),r}_normalizeCenter(r){const l=this.transform;if(l.maxBounds||"globe"!==l.projection.name&&!l.renderWorldCopies)return;const p=r.lng-l.center.lng;r.lng+=p>180?-360:p<-180?360:0}_prefersReducedMotion(r){return this._respectPrefersReducedMotion&&u.q.prefersReducedMotion&&!(r&&r.essential)}_emulate(r,l,p){const _=Math.ceil(15*l/1e3),v=[],b=r(p.clone());for(let S=0;S<=_;S++){const I=b(S/_);v.push(I.clone())}return v}_preloadTiles(r,l){}}class ed{constructor(r={}){this.options=r,u.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(r){const l=this.options&&this.options.compact,p=r._getUIString("AttributionControl.ToggleAttribution");this._map=r,this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=fn("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",p);const _=fn("span","mapboxgl-ctrl-icon",this._compactButton);return _.setAttribute("aria-hidden","true"),_.setAttribute("title",p),this._innerContainer=fn("div","mapboxgl-ctrl-attrib-inner",this._container),l&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===l&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let r=this._editLink;r||(r=this._editLink=this._container.querySelector(".mapbox-improve-map"));const l=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||u.e.ACCESS_TOKEN}];if(r){const p=l.reduce((_,v,b)=>(v.value&&(_+=`${v.key}=${v.value}${b<l.length-1?"&":""}`),_),"?");r.href=`${u.e.FEEDBACK_URL}/${p}#${Yu(this._map,!0)}`,r.rel="noopener nofollow"}}_updateData(r){!r||"metadata"!==r.sourceDataType&&"visibility"!==r.sourceDataType&&"style"!==r.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let r=[];if(this._map.style.stylesheet){const _=this._map.style.stylesheet;this.styleOwner=_.owner,this.styleId=_.id}const l=this._map.style._mergedSourceCaches;for(const _ in l){const v=l[_];if(v.used){const b=v.getSource();b.attribution&&r.indexOf(b.attribution)<0&&r.push(b.attribution)}}r.sort((_,v)=>_.length-v.length),r=r.filter((_,v)=>{for(let b=v+1;b<r.length;b++)if(r[b].indexOf(_)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?r=[...this.options.customAttribution,...r]:r.unshift(this.options.customAttribution));const p=r.join(" | ");p!==this._attribHTML&&(this._attribHTML=p,r.length?(this._innerContainer.innerHTML=p,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class tc{constructor(){u.aV(["_updateLogo","_updateCompact"],this)}onAdd(r){this._map=r,this._container=fn("div","mapboxgl-ctrl");const l=fn("a","mapboxgl-ctrl-logo");return l.target="_blank",l.rel="noopener nofollow",l.href="https://www.mapbox.com/",l.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),l.setAttribute("rel","noopener nofollow"),this._container.appendChild(l),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(r){r&&"metadata"!==r.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const r=this._map.style._sourceCaches;if(0===Object.entries(r).length)return!0;for(const l in r){const p=r[l].getSource();if(p.hasOwnProperty("mapbox_logo")&&!p.mapbox_logo)return!1}return!0}_updateCompact(){const r=this._container.children;if(r.length){const l=r[0];this._map.getCanvasContainer().offsetWidth<250?l.classList.add("mapboxgl-compact"):l.classList.remove("mapboxgl-compact")}}}class mh{constructor(){u.aV(["_onIndoorUpdate"],this)}onAdd(r){return this._map=r,this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("indoorupdate",l=>this._onIndoorUpdate({selectedFloorId:l.selectedFloorId,floors:l.floors})),this._container}_createButton(r,l){const p=fn("button",r,this._container);return p.type="button",p.addEventListener("click",l),p}_setButtonTitle(r,l){this._map&&(r.setAttribute("aria-label",l),r.innerHTML=`<strong>${l}</strong>`,r.firstElementChild&&r.firstElementChild.setAttribute("title",l))}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("indoorupdate",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(r){if(!r||!r.floors)return void(this._container.style.display="none");const l=this._model;this._model=r,this._container.style.display="inline-block";const p=r.floors.sort((_,v)=>_.levelOrder-v.levelOrder);l?(Array.from(this._container.children).forEach(_=>_.remove()),this.addCurrentFloors(p)):this.addCurrentFloors(p)}addCurrentFloors(r){for(const l of r){const p=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(l.id),Array.from(this._container.children).forEach(_=>{_.classList.remove("mapboxgl-ctrl-level-button-selected")}),p.classList.add("mapboxgl-ctrl-level-button-selected")});this._setButtonTitle(p,l.shortName),this._model&&l.id===this._model.selectedFloorId&&(this._map._selectIndoorFloor(l.id),p.classList.add("mapboxgl-ctrl-level-button-selected")),this._container.append(p)}}}class ym{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(r){const l=++this._id;return this._queue.push({callback:r,id:l,cancelled:!1}),l}remove(r){const l=this._currentlyRunning,p=l?this._queue.concat(l):this._queue;for(const _ of p)if(_.id===r)return void(_.cancelled=!0)}run(r=0){const l=this._currentlyRunning=this._queue;this._queue=[];for(const p of l)if(!p.cancelled&&(p.callback(r),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class nc{constructor(r){this.jumpTo(r)}getValue(r){if(r<=this._startTime)return this._start;if(r>=this._endTime)return this._end;const l=u.dx((r-this._startTime)/(this._endTime-this._startTime));return this._start*(1-l)+this._end*l}isEasing(r){return r>=this._startTime&&r<=this._endTime}jumpTo(r){this._startTime=-1/0,this._endTime=-1/0,this._start=r,this._end=r}easeTo(r,l,p){this._start=this.getValue(l),this._end=r,this._startTime=l,this._endTime=l+p}}const vm={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class l_ extends u.A{constructor(r,l,p,_){const{point:v,lngLat:b,originalEvent:S,target:I}=r;super(r.type,{point:v,lngLat:b,originalEvent:S,target:I}),this.preventDefault=()=>{r.preventDefault()},this.id=l,this.interaction=p,this.feature=_}}class Vf{constructor(r){this.map=r,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(r,l){if(this.typeById.has(r))throw new Error(`Interaction id "${r}" already exists.`);const p=l.filter;let _=l.type;p&&this.filters.set(r,u.b3(p)),"mouseover"===_&&(_="mouseenter"),"mouseout"===_&&(_="mouseleave");const v=this.interactionsByType.get(_)||new Map;"mouseenter"===_||"mouseleave"===_?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(r,l)):0===v.size&&this.map.on(_,this.handleType),0===v.size&&this.interactionsByType.set(_,v),v.set(r,l),this.typeById.set(r,_)}get(r){const l=this.typeById.get(r);if(!l)return;const p=this.interactionsByType.get(l);return p?p.get(r):void 0}remove(r){const l=this.typeById.get(r);if(!l)return;this.typeById.delete(r),this.filters.delete(r);const p=this.interactionsByType.get(l);p&&(p.delete(r),"mouseenter"===l||"mouseleave"===l?(this.delegatedInteractions.delete(r),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===p.size&&this.map.off(l,this.handleType))}queryTargets(r,l){const p=[];for(const[_,v]of l)v.target&&p.push({targetId:_,target:v.target,filter:this.filters.get(_)});return this.map.style.queryRenderedTargets(r,p,this.map.transform)}handleMove(r){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const l=this.queryTargets(r.point,Array.from(this.delegatedInteractions).reverse());l.length&&(r.type="mouseenter",this.handleType(r,l));const p=new Map;for(const[_,{feature:v}]of this.prevHoveredFeatures)this.hoveredFeatures.has(_)||p.set(v.id,v);p.size&&(r.type="mouseleave",this.handleType(r,Array.from(p.values())))}handleOut(r){const l=Array.from(this.hoveredFeatures.values()).map(({feature:p})=>p);l.length&&(r.type="mouseleave",this.handleType(r,l)),this.hoveredFeatures.clear()}handleType(r,l){const p="mouseenter"===r.type;if(p&&!this.interactionsByType.has(r.type))return void u.w("mouseenter interaction required for mouseleave to work.");const _=Array.from(this.interactionsByType.get(r.type)).reverse(),v=!!l;l=l||this.queryTargets(r.point,_);let b=!1;const S=new Set;for(const I of l){for(const[P,R]of _){if(!R.target)continue;const z=I.variants?I.variants[P]:null;if(z){for(const L of z){if(lf(L,I,S,P))continue;const B=new u.dr(I,L),H=Ld(L,I,P);v&&(B.state=this.map.getFeatureState(B));const U=p?this.prevHoveredFeatures.get(H):null,q=new l_(r,P,R,B),G=U?U.stop:R.handler(q);if(p&&this.hoveredFeatures.set(H,{feature:I,stop:G}),!1!==G){b=!0;break}}if(b)break}}if(b)break}if(!b)for(const[I,P]of _){const{handler:R,target:z}=P;if(!z&&!1!==R(new l_(r,I,P,null)))break}}}function jf(f,r){if(Array.isArray(f)&&Array.isArray(r)){const l=new Set(f),p=new Set(r);return l.size===p.size&&f.every(_=>p.has(_))}return u.bv(f,r)}const td={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Kc={showCompass:!0,showZoom:!0,visualizePitch:!1};class al{constructor(r,l,p=!1){this._clickTolerance=10,this.element=l,this.mouseRotate=new fa({clickTolerance:r.dragRotate._mouseRotate._clickTolerance}),this.map=r,p&&(this.mousePitch=new pm({clickTolerance:r.dragRotate._mousePitch._clickTolerance})),u.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),l.addEventListener("mousedown",this.mousedown),l.addEventListener("touchstart",this.touchstart,{passive:!1}),l.addEventListener("touchmove",this.touchmove),l.addEventListener("touchend",this.touchend),l.addEventListener("touchcancel",this.reset)}down(r,l){this.mouseRotate.mousedown(r,l),this.mousePitch&&this.mousePitch.mousedown(r,l),fs()}move(r,l){const p=this.map,_=this.mouseRotate.mousemoveWindow(r,l),v=_&&_.bearingDelta;if(v&&p.setBearing(p.getBearing()+v),this.mousePitch){const b=this.mousePitch.mousemoveWindow(r,l),S=b&&b.pitchDelta;S&&p.setPitch(p.getPitch()+S)}}off(){const r=this.element;r.removeEventListener("mousedown",this.mousedown),r.removeEventListener("touchstart",this.touchstart),r.removeEventListener("touchmove",this.touchmove),r.removeEventListener("touchend",this.touchend),r.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Vs(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(r){this.down(u.h({},r,{ctrlKey:!0,preventDefault:()=>r.preventDefault()}),ra(this.element,r)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(r){this.move(r,ra(this.element,r))}mouseup(r){this.mouseRotate.mouseupWindow(r),this.mousePitch&&this.mousePitch.mouseupWindow(r),this.offTemp()}touchstart(r){1!==r.targetTouches.length?this.reset():(this._startPos=this._lastPos=ba(this.element,r.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>r.preventDefault()},this._startPos))}touchmove(r){1!==r.targetTouches.length?this.reset():(this._lastPos=ba(this.element,r.targetTouches)[0],this.move({preventDefault:()=>r.preventDefault()},this._lastPos))}touchend(r){0===r.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function ss(f,r,l){if(f=new u.ci(f.lng,f.lat),r){const p=new u.ci(f.lng-360,f.lat),_=new u.ci(f.lng+360,f.lat),v=360*Math.ceil(Math.abs(f.lng-l.center.lng)/360),b=l.locationPoint3D(f).distSqr(r),S=r.x<0||r.y<0||r.x>l.width||r.y>l.height;l.locationPoint3D(p).distSqr(r)<b&&(S||Math.abs(p.lng-l.center.lng)<v)?f=p:l.locationPoint3D(_).distSqr(r)<b&&(S||Math.abs(_.lng-l.center.lng)<v)&&(f=_)}for(;Math.abs(f.lng-l.center.lng)>180;){const p=l.locationPoint3D(f);if(p.x>=0&&p.y>=0&&p.x<=l.width&&p.y<=l.height)break;f.lng>l.center.lng?f.lng-=360:f.lng+=360}return f}const oo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},Uo={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class ws extends u.E{constructor(r,l){super(),(r instanceof HTMLElement||l)&&(r=u.h({element:r},l)),u.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:p="center",color:_="#3FB1CE",scale:v=1,draggable:b=!1,clickTolerance:S=0,rotation:I=Uo.rotation,rotationAlignment:P=Uo.rotationAlignment,pitchAlignment:R=Uo.pitchAlignment,occludedOpacity:z=Uo.occludedOpacity,altitude:L=Uo.altitude}=r||{};this._anchor=p,this._color=_,this._scale=v,this._draggable=b,this._clickTolerance=S,this._rotation=I,this._rotationAlignment=P,this._pitchAlignment=R,this._occludedOpacity=z,this._altitude=L,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),r&&r.element?(this._element=r.element,this._offset=u.P.convert(r&&r.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=u.P.convert(r&&r.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",U=>{U.preventDefault()}),this._element.addEventListener("mousedown",U=>{U.preventDefault()});const B=this._element.classList;for(const U in oo)B.remove(`mapboxgl-marker-anchor-${U}`);B.add(`mapboxgl-marker-anchor-${this._anchor}`);const H=r&&r.className?r.className.trim().split(/\s+/):[];B.add(...H),this._popup=null}_createDefaultMarker(){const r=fn("div"),l=Zo("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},r);if(0===this._altitude){const p=Zo("radialGradient",{id:"shadowGradient"},Zo("defs",{},l));Zo("stop",{offset:"10%","stop-opacity":.4},p),Zo("stop",{offset:"100%","stop-opacity":.05},p),Zo("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},l)}return Zo("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},l),Zo("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},l),Zo("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},l),r}addTo(r){return r===this._map||(this.remove(),this._map=r,r.getCanvasContainer().appendChild(this._element),r.on("move",this._updateMoving),r.on("moveend",this._update),r.on("remove",this._clearFadeTimer),r._addMarker(this),this.setDraggable(this._draggable),this._update(),r.on("click",this._onMapClick)),this}remove(){const r=this._map;return r&&(r.off("click",this._onMapClick),r.off("move",this._updateMoving),r.off("moveend",this._update),r.off("mousedown",this._addDragHandler),r.off("touchstart",this._addDragHandler),r.off("mouseup",this._onUp),r.off("touchend",this._onUp),r.off("mousemove",this._onMove),r.off("touchmove",this._onMove),r.off("remove",this._clearFadeTimer),r._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(r){return this._lngLat=u.ci.convert(r),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(r){return r===this._altitude||(this._defaultMarker&&(0===this._altitude&&0!==r||0!==this._altitude&&0===r)&&(this._element=this._createDefaultMarker()),this._altitude=r||Uo.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(r){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),r){if(!("offset"in r.options)){const _=Math.sqrt(Math.pow(13.5,2)/2);r.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[_,-1*(24.6+_)],"bottom-right":[-_,-1*(24.6+_)],left:[13.5,-24.6],right:[-13.5,-24.6]}:this._offset}this._popup=r,r._marker=this,r._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(r){const l=r.code,p=r.charCode||r.keyCode;"Space"!==l&&"Enter"!==l&&32!==p&&13!==p||this.togglePopup()}_onMapClick(r){const l=r.originalEvent.target,p=this._element;this._popup&&(l===p||p.contains(l))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const r=this._popup;return r?(r.isOpen()?(r.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(r.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const r=this._map,l=this._pos;if(!r||!l)return!1;const p=r.unproject(l,this._altitude),_=r.getFreeCameraOptions();if(!_.position)return!1;const v=_.position.toLngLat();return v.distanceTo(p)<.9*v.distanceTo(this._lngLat)}_evaluateOpacity(){const r=this._map;if(!r)return;const l=this._pos;if(!l||l.x<0||l.x>r.transform.width||l.y<0||l.y>r.transform.height)return void this._clearFadeTimer();const p=r.unproject(l,this._altitude);let _;r._showingGlobe()&&u.eW(r.transform,this._lngLat)?_=0:(_=1-r._queryFogOpacity(p),r.transform._terrainEnabled()&&r.getTerrain()&&this._behindTerrain()&&(_*=this._occludedOpacity)),this._element.style.opacity=`${_}`,this._element.style.pointerEvents=_>0?"auto":"none",this._popup&&this._popup._setOpacity(_),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const r=this._pos;if(!r||!this._map)return;const l=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${r.x}px,${r.y}px)\n            ${oo[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${l.x}px,${l.y}px)\n        `}_calculateXYTransform(){const r=this._pos,l=this._map,p=this.getPitchAlignment();if(!l||!r||"map"!==p)return"";if(!l._showingGlobe()){const I=l.getPitch();return I?`rotateX(${I}deg)`:""}const _=u.cU(u.eX(l.transform,this._lngLat)),v=r.sub(u.eY(l.transform)),b=Math.abs(v.x)+Math.abs(v.y);if(0===b)return"";const S=_/b;return`rotateX(${-v.y*S}deg) rotateY(${v.x*S}deg)`}_calculateZTransform(){const r=this._pos,l=this._map;if(!l||!r)return"";let p=0;const _=this.getRotationAlignment();if("map"===_)if(l._showingGlobe()){const v=l.project(new u.ci(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),b=l.project(new u.ci(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(v);p=u.cU(Math.atan2(b.y,b.x))-90}else p=-l.getBearing();else if("horizon"===_){const v=u.af(4,6,l.getZoom()),b=u.eY(l.transform);b.y+=v*l.transform.height;const S=r.sub(b),I=u.cU(Math.atan2(S.y,S.x));p=(I>90?I-270:I+90)*(1-v)}return p+=this._rotation,p?`rotateZ(${p}deg)`:""}_update(r){cancelAnimationFrame(this._updateFrameId);const l=this._map;l&&(l.transform.renderWorldCopies&&(this._lngLat=ss(this._lngLat,this._pos,l.transform)),this._pos=l.project(this._lngLat,this._altitude),!0===r?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),l._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(l._showingGlobe()||l.getTerrain()||l.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(r){return this._offset=u.P.convert(r),this._update(),this}addClassName(r){return this._element.classList.add(r),this}removeClassName(r){return this._element.classList.remove(r),this}toggleClassName(r){return this._element.classList.toggle(r)}_onMove(r){const l=this._map;if(!l)return;const p=this._pointerdownPos,_=this._positionDelta;if(p&&_){if(!this._isDragging){const v=this._clickTolerance||l._clickTolerance;if(r.point.dist(p)<v)return;this._isDragging=!0}this._pos=r.point.sub(_),this._lngLat=l.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new u.A("dragstart"))),this.fire(new u.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const r=this._map;r&&(r.off("mousemove",this._onMove),r.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new u.A("dragend")),this._state="inactive"}_addDragHandler(r){const l=this._map,p=this._pos;l&&p&&this._element.contains(r.originalEvent.target)&&(r.preventDefault(),this._positionDelta=r.point.sub(p),this._pointerdownPos=r.point,this._state="pending",l.on("mousemove",this._onMove),l.on("touchmove",this._onMove),l.once("mouseup",this._onUp),l.once("touchend",this._onUp))}setDraggable(r){this._draggable=!!r;const l=this._map;return l&&(r?(l.on("mousedown",this._addDragHandler),l.on("touchstart",this._addDragHandler)):(l.off("mousedown",this._addDragHandler),l.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(r){return this._rotation=r||Uo.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(r){return this._rotationAlignment=r||Uo.rotationAlignment,this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(r){return this._pitchAlignment=r||Uo.pitchAlignment,this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(r){return this._occludedOpacity=r||Uo.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const c_={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},gh={maxWidth:100,unit:"metric"},wv={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},as={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},u_=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Po(f=new u.P(0,0),r="bottom"){if("number"==typeof f){const l=Math.round(Math.sqrt(.5*Math.pow(f,2)));switch(r){case"top":return new u.P(0,f);case"top-left":return new u.P(l,l);case"top-right":return new u.P(-l,l);case"bottom":return new u.P(0,-f);case"bottom-left":return new u.P(l,-l);case"bottom-right":return new u.P(-l,-l);case"left":return new u.P(f,0);case"right":return new u.P(-f,0)}return new u.P(0,0)}return f instanceof u.P||Array.isArray(f)?u.P.convert(f):u.P.convert(f[r]||[0,0])}return{version:Ki,supported:Dl.supported,setRTLTextPlugin:u.f0,getRTLTextPluginStatus:u.e$,Map:class extends ro{constructor(f){xa.mark(Ni.create);const r=f;if(null!=(f=u.h({},td,f)).minZoom&&null!=f.maxZoom&&f.minZoom>f.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=f.minPitch&&null!=f.maxPitch&&f.minPitch>f.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=f.minPitch&&f.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=f.maxPitch&&f.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(f.antialias&&u.eU(window)&&(f.antialias=!1,u.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Np(f.minZoom,f.maxZoom,f.minPitch,f.maxPitch,f.renderWorldCopies,null,null),f),this._repaint=!!f.repaint,this._interactive=f.interactive,this._minTileCacheSize=f.minTileCacheSize,this._maxTileCacheSize=f.maxTileCacheSize,this._failIfMajorPerformanceCaveat=f.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=f.preserveDrawingBuffer,this._antialias=f.antialias,this._trackResize=f.trackResize,this._bearingSnap=f.bearingSnap,this._refreshExpiredTiles=f.refreshExpiredTiles,this._fadeDuration=f.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=f.crossSourceCollisions,this._collectResourceTiming=f.collectResourceTiming,this._language=this._parseLanguage(f.language),this._worldview=f.worldview,this._renderTaskQueue=new ym,this._domRenderTaskQueue=new ym,this._controls=[],this._markers=[],this._popups=[],this._mapId=u.a$(),this._locale=u.h({},vm,f.locale),this._clickTolerance=f.clickTolerance,this._cooperativeGestures=f.cooperativeGestures,this._performanceMetricsCollection=f.performanceMetricsCollection,this._tessellationStep=f.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=f.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new nc(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=f.scaleFactor,this._requestManager=new dr(f.transformRequest,f.accessToken,f.testMode),this._silenceAuthErrors=!!f.testMode,this._contextCreateOptions=f.contextCreateOptions?Object.assign({},f.contextCreateOptions):{},"string"==typeof f.container){const l=document.getElementById(f.container);if(!l)throw new Error(`Container '${f.container.toString()}' not found.`);this._container=l}else{if(!(f.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=f.container}if(this._container.childNodes.length>0&&u.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),f.maxBounds&&this.setMaxBounds(f.maxBounds),this._spriteFormat=f.spriteFormat,u.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Mo),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new ph(this,f),this._localFontFamily=f.localFontFamily,this._localIdeographFontFamily=f.localIdeographFontFamily,(f.style||!f.testMode)&&this.setStyle(f.style||u.e.DEFAULT_STYLE,{config:f.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),f.projection&&this.setProjection(f.projection),this.indoor=new Vg(this),f.hash&&(this._hash=new Xu("string"==typeof f.hash&&f.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==r.center&&null==r.zoom||(this.transform._unmodified=!1),this.jumpTo({center:f.center,zoom:f.zoom,bearing:f.bearing,pitch:f.pitch});const l=f.bounds;l&&(this.resize(),this.fitBounds(l,u.h({},f.fitBoundsOptions,{duration:0})))}this.resize(),f.attributionControl&&this.addControl(new ed({customAttribution:f.customAttribution})),this._logoControl=new tc,this.addControl(this._logoControl,f.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",l=>{this._update("style"===l.dataType),this.fire(new u.A(`${l.dataType}data`,l))}),this.on("dataloading",l=>{this.fire(new u.A(`${l.dataType}dataloading`,l))}),this._interactions=new Vf(this)}_getMapId(){return this._mapId}addControl(f,r){if(void 0===r&&(r=f.getDefaultPosition?f.getDefaultPosition():"top-right"),!f||!f.onAdd)return this.fire(new u.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const l=f.onAdd(this);this._controls.push(f);const p=this._controlPositions[r];return-1!==r.indexOf("bottom")?p.insertBefore(l,p.firstChild):p.appendChild(l),this}removeControl(f){if(!f||!f.onRemove)return this.fire(new u.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const r=this._controls.indexOf(f);return r>-1&&this._controls.splice(r,1),f.onRemove(this),this}hasControl(f){return this._controls.indexOf(f)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(f){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const r=!this._moving;return r&&this.fire(new u.A("movestart",f)).fire(new u.A("move",f)),this.fire(new u.A("resize",f)),r&&this.fire(new u.A("moveend",f)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(f){return this.transform.setMaxBounds(u.aG.convert(f)),this._update()}setMinZoom(f){if((f=f??-2)>=-2&&f<=this.transform.maxZoom)return this.transform.minZoom=f,this._update(),this.getZoom()<f?this.setZoom(f):this.fire(new u.A("zoomstart")).fire(new u.A("zoom")).fire(new u.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(f){if((f=f??22)>=this.transform.minZoom)return this.transform.maxZoom=f,this._update(),this.getZoom()>f?this.setZoom(f):this.fire(new u.A("zoomstart")).fire(new u.A("zoom")).fire(new u.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(f){if((f=f??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(f>=0&&f<=this.transform.maxPitch)return this.transform.minPitch=f,this._update(),this.getPitch()<f?this.setPitch(f):this.fire(new u.A("pitchstart")).fire(new u.A("pitch")).fire(new u.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(f){if((f=f??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(f>=this.transform.minPitch)return this.transform.maxPitch=f,this._update(),this.getPitch()>f?this.setPitch(f):this.fire(new u.A("pitchstart")).fire(new u.A("pitch")).fire(new u.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(f){return this._scaleFactor=f,this.painter.scaleFactor=f,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(r=>"symbol"===r.type),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(f){return this.transform.renderWorldCopies=f,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(f){return"auto"===f?navigator.language:Array.isArray(f)?0===f.length?void 0:f.map(r=>"auto"===r?navigator.language:r):f}setLanguage(f){const r=this._parseLanguage(f);if(!this.style||r===this._language)return this;this._language=r,this.style.reloadSources();for(const l of this._controls)l._setLanguage&&l._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(f){return this.style&&f!==this._worldview?(this._worldview=f,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(f){return this._lazyInitEmptyStyle(),f?"string"==typeof f&&(f={name:f}):f=null,this._useExplicitProjection=!!f,this._prioritizeAndUpdateProjection(f,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const f=this.transform,r=f.projection.name;let l;"globe"===r&&f.zoom>=u.cI?(f.setMercatorFromTransition(),l=!0):"mercator"===r&&f.zoom<u.cI&&(f.setProjection({name:"globe"}),l=!0),l&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(f,r){return this._updateProjection(f||r||{name:"mercator"})}_updateProjection(f){let r;return r="globe"===f.name&&this.transform.zoom>=u.cI?this.transform.setMercatorFromTransition():this.transform.setProjection(f),this.style.applyProjectionUpdate(),r&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(f,r){return this.transform.locationPoint3D(u.ci.convert(f),r)}unproject(f,r){return this.transform.pointLocation3D(u.P.convert(f),r)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(f,r,l){const p=_=>{let v=[];if(Array.isArray(r)){const b=r.filter(S=>this.getLayer(S));v=b.length?this.queryRenderedFeatures(_,{layers:b}):[]}else v=this.queryRenderedFeatures(_,{target:r});return v};if("mouseenter"===f||"mouseover"===f){let _=!1;return{listener:l,targets:r,delegates:{mousemove:b=>{const S=p(b.point);S.length?_||(_=!0,l.call(this,new Mi(f,this,b.originalEvent,{features:S}))):_=!1},mouseout:()=>{_=!1}}}}if("mouseleave"===f||"mouseout"===f){let _=!1;return{listener:l,targets:r,delegates:{mousemove:S=>{p(S.point).length?_=!0:_&&(_=!1,l.call(this,new Mi(f,this,S.originalEvent)))},mouseout:S=>{_&&(_=!1,l.call(this,new Mi(f,this,S.originalEvent)))}}}}{const _=v=>{const b=p(v.point);b.length&&(v.features=b,l.call(this,v),delete v.features)};return{listener:l,targets:r,delegates:{[f]:_}}}}on(f,r,l){if("function"==typeof r||void 0===l)return super.on(f,r);if("string"==typeof r&&(r=[r]),!this._areTargetsValid(r))return this;const p=this._createDelegatedListener(f,r,l);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[f]=this._delegatedListeners[f]||[],this._delegatedListeners[f].push(p);for(const _ in p.delegates)this.on(_,p.delegates[_]);return this}once(f,r,l){if("function"==typeof r||void 0===l)return super.once(f,r);if("string"==typeof r&&(r=[r]),!this._areTargetsValid(r))return this;const p=this._createDelegatedListener(f,r,l);for(const _ in p.delegates)this.once(_,p.delegates[_]);return this}off(f,r,l){if("function"==typeof r||void 0===l)return super.off(f,r);if("string"==typeof r&&(r=[r]),!this._areTargetsValid(r))return this;const p=this._delegatedListeners?this._delegatedListeners[f]:void 0;return p&&(_=>{for(let v=0;v<_.length;v++){const b=_[v];if(b.listener===l&&jf(b.targets,r)){for(const S in b.delegates)this.off(S,b.delegates[S]);return _.splice(v,1),this}}})(p),this}queryRenderedFeatures(f,r){if(!this.style)return[];if(void 0===f||f instanceof u.P||Array.isArray(f)||void 0!==r||(r=f,f=void 0),f=f||[[0,0],[this.transform.width,this.transform.height]],!r){const v=this.style.queryRenderedFeatures(f,void 0,this.transform),b=this.style.queryRenderedFeatureset(f,void 0,this.transform);return v.concat(b)}let l=!0;if(r.target&&(l=this._isTargetValid(r.target),l&&!r.layers))return this.style.queryRenderedFeatureset(f,r,this.transform);let p=!0;if(r.layers&&Array.isArray(r.layers)){for(const v of r.layers)if(!this._isValidId(v)){p=!1;break}if(p&&!r.target)return this.style.queryRenderedFeatures(f,r,this.transform)}let _=[];return p&&(_=_.concat(this.style.queryRenderedFeatures(f,r,this.transform))),l&&(_=_.concat(this.style.queryRenderedFeatureset(f,r,this.transform))),_}querySourceFeatures(f,r){return!f||"string"==typeof f&&!this._isValidId(f)?[]:this.style.querySourceFeatures(f,r)}isPointOnSurface(f){const{name:r}=this.transform.projection;return"globe"!==r&&"mercator"!==r&&u.w(`${r} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(u.P.convert(f))}addInteraction(f,r){return this._interactions.add(f,r),this}removeInteraction(f){return this._interactions.remove(f),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(f){return this._cooperativeGestures=f,this}setStyle(f,r){return r=u.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},r),this.style&&f&&!1!==r.diff&&r.localFontFamily===this._localFontFamily&&r.localIdeographFontFamily===this._localIdeographFontFamily&&!r.config?(this.style._diffStyle(f,(l,p)=>{if(l){const _="string"==typeof l?l:l instanceof Error?l.message:l.error;u.w(`Unable to perform style diff: ${_}. Rebuilding the style from scratch.`),this._updateStyle(f,r)}else p&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=r.localIdeographFontFamily,this._localFontFamily=r.localFontFamily,this._updateStyle(f,r))}_getUIString(f){const r=this._locale[f];if(null==r)throw new Error(`Missing UI string '${f}'`);return r}_updateStyle(f,r){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),f){const l=u.h({},r);r&&r.config&&(l.initialConfig=r.config,delete l.config),this.style=new Ls(this,l).load(f),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Ls(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(u.w("There is no style added to the map."),!1)}_isValidId(f){return null==f?(this.fire(new u.z(new Error("IDs can't be empty."))),!1):!u.dk(f)||(this.fire(new u.z(new Error(`IDs can't contain special symbols: "${f}".`))),!1)}_isTargetValid(f){return"featuresetId"in f?this._isValidId("importId"in f?f.importId:f.featuresetId):"layerId"in f&&this._isValidId(f.layerId)}_areTargetsValid(f){if(Array.isArray(f)){for(const r of f)if(!this._isValidId(r))return!1;return!0}return this._isTargetValid(f)}addSource(f,r){return this._isValidId(f)?(this._lazyInitEmptyStyle(),this.style.addSource(f,r),this._update(!0)):this}isSourceLoaded(f){return!!this._isValidId(f)&&!!this.style&&this.style._isSourceCacheLoaded(f)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(f,r,l){this._lazyInitEmptyStyle(),this.style.addSourceType(f,r,l)}removeSource(f){return this._isValidId(f)?(this.style.removeSource(f),this._updateTerrain(),this._update(!0)):this}getSource(f){return this._isValidId(f)?this.style.getOwnSource(f):null}addImage(f,r,{pixelRatio:l=1,sdf:p=!1,stretchX:_,stretchY:v,content:b}={}){this._lazyInitEmptyStyle();const S=u.I.from(f);if(r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap){const{width:I,height:P,data:R}=u.q.getImageData(r);this.style.addImage(S,{data:new u.r({width:I,height:P},R),pixelRatio:l,stretchX:_,stretchY:v,content:b,sdf:p,version:0,usvg:!1})}else if(void 0===r.width||void 0===r.height)this.fire(new u.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:I,height:P}=r,R=r;this.style.addImage(S,{data:new u.r({width:I,height:P},new Uint8Array(R.data)),pixelRatio:l,stretchX:_,stretchY:v,content:b,sdf:p,usvg:!1,version:0,userImage:R}),R.onAdd&&R.onAdd(this,f)}}updateImage(f,r){this._lazyInitEmptyStyle();const l=u.I.from(f),p=this.style.getImage(l);if(!p)return void this.fire(new u.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const _=r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap?u.q.getImageData(r):r,{width:v,height:b,data:S}=_;if(void 0===v||void 0===b)return void this.fire(new u.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(v!==(p.usvg?p.icon.usvg_tree.width:p.data.width)||b!==(p.usvg?p.icon.usvg_tree.height:p.data.height))return void this.fire(new u.z(new Error(`The width and height of the updated image (${v}, ${b})\n                must be that same as the previous version of the image\n                (${p.data.width}, ${p.data.height})`)));const I=!(r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap);let P=!1;p.usvg?(p.data=new u.r({width:v,height:b},new Uint8Array(S)),p.usvg=!1,p.icon=void 0,P=!0):p.data.replace(S,I),this.style.updateImage(l,p,P)}hasImage(f){return f?!!this.style&&!!this.style.getImage(u.I.from(f)):(this.fire(new u.z(new Error("Missing required image id"))),!1)}removeImage(f){this.style.removeImage(u.I.from(f))}loadImage(f,r){u.o(this._requestManager.transformRequest(f,u.R.Image),(l,p)=>{r(l,p instanceof HTMLImageElement?u.q.getImageData(p):p)})}listImages(){return this.style.listImages().map(f=>f.name)}addModel(f,r){this._lazyInitEmptyStyle(),this.style.addModel(f,r)}hasModel(f){return f?this.style.hasModel(f):(this.fire(new u.z(new Error("Missing required model id"))),!1)}removeModel(f){this.style.removeModel(f)}listModels(){return this.style.listModels()}addLayer(f,r){return this._isValidId(f.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(f,r),this._update(!0)):this}getSlot(f){const r=this.getLayer(f);return r&&r.slot||null}setSlot(f,r){return this.style.setSlot(f,r),this.style.mergeLayers(),this._update(!0)}addImport(f,r){return this.style.addImport(f,r).catch(l=>this.fire(new u.z(new Error("Failed to add import",l)))),this}updateImport(f,r){return"string"!=typeof r&&r.id!==f?(this.removeImport(f),this.addImport(r)):(this.style.updateImport(f,r),this._update(!0))}removeImport(f){return this.style.removeImport(f),this}moveImport(f,r){return this.style.moveImport(f,r),this._update(!0)}moveLayer(f,r){return this._isValidId(f)?(this.style.moveLayer(f,r),this._update(!0)):this}removeLayer(f){return this._isValidId(f)?(this.style.removeLayer(f),this._update(!0)):this}getLayer(f){if(!this._isValidId(f))return null;const r=this.style.getOwnLayer(f);return r?"custom"===r.type?r.implementation:r.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(f,r,l){return this._isValidId(f)?(this.style.setLayerZoomRange(f,r,l),this._update(!0)):this}setFilter(f,r,l={}){return this._isValidId(f)?(this.style.setFilter(f,r,l),this._update(!0)):this}getFilter(f){return this._isValidId(f)?this.style.getFilter(f):null}setPaintProperty(f,r,l,p={}){return this._isValidId(f)?(this.style.setPaintProperty(f,r,l,p),this._update(!0)):this}getPaintProperty(f,r){return this._isValidId(f)?this.style.getPaintProperty(f,r):null}setLayoutProperty(f,r,l,p={}){return this._isValidId(f)?(this.style.setLayoutProperty(f,r,l,p),this._update(!0)):this}getLayoutProperty(f,r){return this._isValidId(f)?this.style.getLayoutProperty(f,r):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(f){return this.style.setGlyphsUrl(f),this._update(!0)}getSchema(f){return this.style.getSchema(f)}setSchema(f,r){return this.style.setSchema(f,r),this._update(!0)}getConfig(f){return this.style.getConfig(f)}setConfig(f,r){return this.style.setConfig(f,r),this._update(!0)}getConfigProperty(f,r){return this.style.getConfigProperty(f,r)}setConfigProperty(f,r,l){return this.style.setConfigProperty(f,r,l),this._update(!0)}getFeaturesetDescriptors(f){return this.style.getFeaturesetDescriptors(f)}setLights(f){if(this._lazyInitEmptyStyle(),f&&1===f.length&&"flat"===f[0].type){const r=f[0];r.properties?this.style.setFlatLight(r.properties,r.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(f),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const f=this.style.getLights()||[];return 0===f.length&&f.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),f}setLight(f,r={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:f}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(f){return this._lazyInitEmptyStyle(),!f&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(f),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(f){return this._lazyInitEmptyStyle(),this.style.setFog(f),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(f){return this._lazyInitEmptyStyle(),this.style.setSnow(f),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(f){return this._lazyInitEmptyStyle(),this.style.setRain(f),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(f){return this._lazyInitEmptyStyle(),this.style.setColorTheme(f),this._update(!0)}setImportColorTheme(f,r){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(f,r),this._update(!0)}setCamera(f){return this.style.setCamera(f),this._triggerCameraUpdate(f)}_triggerCameraUpdate(f){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===f["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(f){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(u.ci.convert(f),this.transform):0}setFeatureState(f,r){return f.source&&!this._isValidId(f.source)?this:(this.style.setFeatureState(f,r),this._update())}removeFeatureState(f,r){return f.source&&!this._isValidId(f.source)?this:(this.style.removeFeatureState(f,r),this._update())}getFeatureState(f){return f.source&&!this._isValidId(f.source)?null:this.style.getFeatureState(f)}_selectIndoorFloor(f){this.indoor.selectFloor(f)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new mh),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const f=this._container.getBoundingClientRect().width||400,r=this._container.getBoundingClientRect().height||300;let l,p,_,v=this._container;for(;v&&(!p||!_);){const b=window.getComputedStyle(v).transform;b&&"none"!==b&&(l=b.match(/matrix.*\((.+)\)/)[1].split(", "),l[0]&&"0"!==l[0]&&"1"!==l[0]&&(p=l[0]),l[3]&&"0"!==l[3]&&"1"!==l[3]&&(_=l[3])),v=v.parentElement}this._containerWidth=p?Math.abs(f/p):f,this._containerHeight=_?Math.abs(r/_):r}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&u.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const f=this._container;f.classList.add("mapboxgl-map"),(this._missingCSSCanary=fn("div","mapboxgl-canary",f)).style.visibility="hidden",this._detectMissingCSS();const r=this._canvasContainer=fn("div","mapboxgl-canvas-container",f);this._canvas=fn("canvas","mapboxgl-canvas",r),this._interactive&&(r.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const l=this._controlContainer=fn("div","mapboxgl-control-container",f),p=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(_=>{p[_]=fn("div",`mapboxgl-ctrl-${_}`,l)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(f,r){const l=u.q.devicePixelRatio||1;this._canvas.width=l*Math.ceil(f),this._canvas.height=l*Math.ceil(r),this._canvas.style.width=`${f}px`,this._canvas.style.height=`${r}px`}_addMarker(f){this._markers.push(f)}_removeMarker(f){const r=this._markers.indexOf(f);-1!==r&&this._markers.splice(r,1)}_addPopup(f){this._popups.push(f)}_removePopup(f){const r=this._popups.indexOf(f);-1!==r&&this._popups.splice(r,1)}_setupPainter(){const f=u.h({},Dl.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),r=this._canvas.getContext("webgl2",f);r?(Ea(r,!0),this.painter=new Kl(r,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",l=>{"source"===l.dataType&&this.painter.setTileLoadedFlag(!0)}),u.l.testSupport(r)):this.fire(new u.z(new Error("Failed to initialize WebGL")))}_contextLost(f){f.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new u.A("webglcontextlost",{originalEvent:f}))}_contextRestored(f){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new u.A("webglcontextrestored",{originalEvent:f}))}_onMapScroll(f){if(f.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(f){return this.style?(this._styleDirty=this._styleDirty||f,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(f){return this._update(),this._renderTaskQueue.add(f)}_cancelRenderFrame(f){this._renderTaskQueue.remove(f)}_requestDomTask(f){!this.loaded()||this.loaded()&&!this.isMoving()?f():this._domRenderTaskQueue.add(f)}_render(f){let r;this.fire(new u.A("renderstart")),++this._frameId;const l=this.painter.context.extTimerQuery,p=u.q.now(),_=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(r=_.createQuery(),_.beginQuery(l.TIME_ELAPSED_EXT,r)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(f),this._domRenderTaskQueue.run(f),this._removed)return;this._updateProjectionTransition();const v=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const P=this.transform.zoom,R=this.transform.pitch,z=u.q.now(),L=new u.aa(P,{now:z,fadeDuration:v,pitch:R,transition:this.style.transition,worldview:this._worldview});this.style.update(L)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let b=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),b=this._updateAverageElevation(p),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):b=this._updateAverageElevation(p);const S=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,v,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),S&&(this._placementDirty=S.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:v,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new u.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,xa.mark(Ni.load),this.fire(new u.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),r){const P=u.q.now()-p;_.endQuery(l.TIME_ELAPSED_EXT),setTimeout(()=>{const R=_.getQueryParameter(r,_.QUERY_RESULT)/1e6;_.deleteQuery(r),this.fire(new u.A("gpu-timing-frame",{cpuTime:P,gpuTime:R}))},50)}if(this.listens("gpu-timing-layer")){const P=this.painter.collectGpuTimers();setTimeout(()=>{const R=this.painter.queryGpuTimers(P);this.fire(new u.A("gpu-timing-layer",{layerTimes:R}))},50)}if(this.listens("gpu-timing-deferred-render")){const P=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const R=this.painter.queryGpuTimeDeferredRender(P);this.fire(new u.A("gpu-timing-deferred-render",{gpuTime:R}))},50)}const I=this._sourcesDirty||this._styleDirty||this._placementDirty||b;if(I||this._repaint)this.triggerRepaint();else{const P=this.idle();if(P&&(b=this._updateAverageElevation(p,!0)),b)this.triggerRepaint();else if(this._triggerFrame(!1),P&&(this.fire(new u.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const R=this._calculateSpeedIndex();this.fire(new u.A("speedindexcompleted",{speedIndex:R})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||I||(this._fullyLoaded=!0,xa.mark(Ni.fullLoad),this._performanceMetricsCollection&&yi(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(f){for(const r of this._markers)f&&!this.getRenderWorldCopies()&&(r._lngLat=r._lngLat.wrap()),r._update();for(const r of this._popups)!f||this.getRenderWorldCopies()||r._trackPointer||(r._lngLat=r._lngLat.wrap()),r._update()}_updateAverageElevation(f,r=!1){const l=_=>(this.transform.averageElevation=_,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&l(0);const p=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(p||(r||f-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(f)){const _=this.transform.averageElevation;let v=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(v)?v=0:this._averageElevationLastSampledAt=f;const b=Math.abs(_-v);if(b>1){if(this._isInitialLoad||p)return this._averageElevation.jumpTo(v),l(v);this._averageElevation.easeTo(v,f,300)}else if(b>1e-4)return this._averageElevation.jumpTo(v),l(v)}return!!this._averageElevation.isEasing(f)&&l(this._averageElevation.getValue(f))}_authenticate(){rr(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,f=>{if(f&&(f.message===uo||401===f.status)){const r=this.painter.context.gl;Ea(r,!1),this._logoControl instanceof tc&&this._logoControl._updateLogo(),r&&r.clear(r.DEPTH_BUFFER_BIT|r.COLOR_BUFFER_BIT|r.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new u.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),rf(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Ai(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const f=this._isDragging();this.painter.updateTerrain(this.style,f)}_calculateSpeedIndex(){const f=this.painter.canvasCopy(),r=this.painter.getCanvasCopiesAndTimestamps();r.timeStamps.push(performance.now());const l=this.painter.context.gl,p=l.createFramebuffer();function _(v){l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,v,0);const b=new Uint8Array(l.drawingBufferWidth*l.drawingBufferHeight*4);return l.readPixels(0,0,l.drawingBufferWidth,l.drawingBufferHeight,l.RGBA,l.UNSIGNED_BYTE,b),b}return l.bindFramebuffer(l.FRAMEBUFFER,p),this._canvasPixelComparison(_(f),r.canvasCopies.map(_),r.timeStamps)}_canvasPixelComparison(f,r,l){let p=l[1]-l[0];const _=f.length/4;for(let v=0;v<r.length;v++){const b=r[v];let S=0;for(let I=0;I<b.length;I+=4)b[I]===f[I]&&b[I+1]===f[I+1]&&b[I+2]===f[I+2]&&b[I+3]===f[I+3]&&(S+=1);p+=(l[v+2]-l[v+1])*(1-S/_)}return p}remove(){this._hash&&this._hash.remove();for(const r of this._controls)r.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const f=this.painter.context.gl.getExtension("WEBGL_lose_context");f&&f.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),js.delete(this.painter.context.gl),er.remove(),xu.remove(),this._removed=!0,this.fire(new u.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(f){this._renderNextFrame=this._renderNextFrame||f,this.style&&!this._frame&&(this._frame=u.q.frame(r=>{const l=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,l&&this._render(r)}))}_preloadTiles(f){const r=this.style?this.style.getSourceCaches():[];return u.bt(r,(l,p)=>l._preloadTiles(f,p),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(f){this._trackResize&&this.resize({originalEvent:f})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(f){this._showTileBoundaries!==f&&(this._showTileBoundaries=f,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(f){this._showParseStatus!==f&&(this._showParseStatus=f,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(f){this._showTerrainWireframe!==f&&(this._showTerrainWireframe=f,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(f){this._showLayers2DWireframe!==f&&(this._showLayers2DWireframe=f,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(f){this._showLayers3DWireframe!==f&&(this._showLayers3DWireframe=f,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(f){this._speedIndexTiming!==f&&(this._speedIndexTiming=f,this._update())}get showPadding(){return!!this._showPadding}set showPadding(f){this._showPadding!==f&&(this._showPadding=f,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(f){this._showCollisionBoxes!==f&&(this._showCollisionBoxes=f,this._tp.refreshUI(),f?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(f){this._showOverdrawInspector!==f&&(this._showOverdrawInspector=f,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(f){this._repaint!==f&&(this._repaint=f,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(f){this._vertices=f,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(f){this._showTileAABBs!==f&&(this._showTileAABBs=f,this._tp.refreshUI(),f&&this._update())}_setCacheLimits(f,r){u.eV(f,r)}get version(){return Ki}},NavigationControl:class{constructor(f={}){this.options=u.h({},Kc,f),this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",r=>r.preventDefault()),this.options.showZoom&&(u.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",r=>{this._map&&this._map.zoomIn({},{originalEvent:r})}),fn("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",r=>{this._map&&this._map.zoomOut({},{originalEvent:r})}),fn("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(u.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",r=>{const l=this._map;l&&(this.options.visualizePitch?l.resetNorthPitch({},{originalEvent:r}):l.resetNorth({},{originalEvent:r}))}),this._compassIcon=fn("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const f=this._map;if(!f)return;const r=f.getZoom(),l=r===f.getMaxZoom(),p=r===f.getMinZoom();this._zoomInButton.disabled=l,this._zoomOutButton.disabled=p,this._zoomInButton.setAttribute("aria-disabled",l.toString()),this._zoomOutButton.setAttribute("aria-disabled",p.toString())}_rotateCompassArrow(){const f=this._map;if(!f)return;const r=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(f.transform.pitch*(Math.PI/180)),.5)}) rotateX(${f.transform.pitch}deg) rotateZ(${f.transform.angle*(180/Math.PI)}deg)`:`rotate(${f.transform.angle*(180/Math.PI)}deg)`;f._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=r)})}onAdd(f){return this._map=f,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),f.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&f.on("pitch",this._rotateCompassArrow),f.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new al(f,this._compass,this.options.visualizePitch)),this._container}onRemove(){const f=this._map;f&&(this._container.remove(),this.options.showZoom&&f.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&f.off("pitch",this._rotateCompassArrow),f.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(f,r){const l=fn("button",f,this._container);return l.type="button",l.addEventListener("click",r),l}_setButtonTitle(f,r){if(!this._map)return;const l=this._map._getUIString(`NavigationControl.${r}`);f.setAttribute("aria-label",l),f.firstElementChild&&f.firstElementChild.setAttribute("title",l)}},GeolocateControl:class extends u.E{constructor(f={}){super();const r=navigator.geolocation;this.options=u.h({geolocation:r},c_,f),u.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Zu(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(f){return this._map=f,this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(f){const r=(l=!!this.options.geolocation)=>{this._supportsGeolocation=l,f(l)};void 0!==this._supportsGeolocation?f(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then(l=>r("denied"!==l.state)).catch(()=>r()):r()}_isOutOfMapMaxBounds(f){const r=this._map.getMaxBounds(),l=f.coords;return!!r&&(l.longitude<r.getWest()||l.longitude>r.getEast()||l.latitude<r.getSouth()||l.latitude>r.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(f){if(this._map){if(this._isOutOfMapMaxBounds(f))return this._setErrorState(),this.fire(new u.A("outofmaxbounds",f)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=f,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(f),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(f),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new u.A("geolocate",f)),this._finish()}}_updateCamera(f){const r=new u.ci(f.coords.longitude,f.coords.latitude),l=f.coords.accuracy,p=this._map.getBearing(),_=u.h({bearing:p},this.options.fitBoundsOptions);this._map.fitBounds(r.toBounds(l),_,{geolocateSource:!0})}_updateMarker(f){if(f){const r=new u.ci(f.coords.longitude,f.coords.latitude);this._accuracyCircleMarker.setLngLat(r).addTo(this._map),this._userLocationDotMarker.setLngLat(r).addTo(this._map),this._accuracy=f.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const f=this._map.transform,r=u.cb(1,f._center.lat)*f.worldSize,l=Math.ceil(2*this._accuracy*r);this._circleElement.style.width=`${l}px`,this._circleElement.style.height=`${l}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(f){if(this._map){if(this.options.trackUserLocation)if(1===f.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const r=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===f.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new u.A("error",f)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(f){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",r=>r.preventDefault()),this._geolocateButton=fn("button","mapboxgl-ctrl-geolocate",this._container),fn("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===f){u.w("Geolocation support is not available so the GeolocateControl will be disabled.");const r=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r)}else{const r=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=fn("div","mapboxgl-user-location"),this._dotElement.appendChild(fn("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(fn("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ws({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=fn("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ws({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",r=>{r.geolocateSource||"ACTIVE_LOCK"!==this._watchState||r.originalEvent&&"resize"===r.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new u.A("trackuserlocationend")))})}}_onDeviceOrientation(f){this._userLocationDotMarker&&(f.webkitCompassHeading?this._heading=f.webkitCompassHeading:!0===f.absolute&&(this._heading=-1*f.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return u.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new u.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new u.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new u.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let f;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(f={maximumAge:6e5,timeout:0},this._noTimeout=!0):(f=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,f),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const f=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(r=>{"granted"===r&&f()}).catch(console.error):f()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:ed,ScaleControl:class{constructor(f={}){this.options=u.h({},gh,f),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),u.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const f=this.options.maxWidth||100,r=this._map,l=r._containerHeight/2,p=r._containerWidth/2-f/2,_=r.unproject([p,l]),v=r.unproject([p+f,l]),b=_.distanceTo(v);if("imperial"===this.options.unit){const S=3.2808*b;S>5280?this._setScale(f,S/5280,"mile"):this._setScale(f,S,"foot")}else"nautical"===this.options.unit?this._setScale(f,b/1852,"nautical-mile"):b>=1e3?this._setScale(f,b/1e3,"kilometer"):this._setScale(f,b,"meter")}_setScale(f,r,l){this._map._requestDomTask(()=>{const p=function(v){const b=Math.pow(10,`${Math.floor(v)}`.length-1);let S=v/b;return S=S>=10?10:S>=5?5:S>=3?3:S>=2?2:S>=1?1:function(I){const P=Math.pow(10,Math.ceil(-Math.log(I)/Math.LN10));return Math.round(I*P)/P}(S),b*S}(r),_=p/r;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==l?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:l}).format(p):`${p}&nbsp;${wv[l]}`,this._container.style.width=f*_+"px"})}onAdd(f){return this._map=f,this._language=f.getLanguage(),this._container=fn("div","mapboxgl-ctrl mapboxgl-ctrl-scale",f.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(f){this._language=f,this._update()}setUnit(f){this.options.unit=f,this._update()}},FullscreenControl:class{constructor(f={}){this._fullscreen=!1,f&&f.container&&(f.container instanceof HTMLElement?this._container=f.container:u.w("Full screen control 'container' must be a DOM element.")),u.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(f){return this._map=f,this._container||(this._container=this._map.getContainer()),this._controlContainer=fn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",u.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const f=this._fullscreenButton=fn("button","mapboxgl-ctrl-fullscreen",this._controlContainer);fn("span","mapboxgl-ctrl-icon",f).setAttribute("aria-hidden","true"),f.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const f=this._getTitle();this._fullscreenButton.setAttribute("aria-label",f),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",f)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:mh,Popup:class extends u.E{constructor(f){super(),this.options=u.h(Object.create(as),f),this._altitude=this.options.altitude,u.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(f&&f.className?f.className.trim().split(/\s+/):[])}addTo(f){return this._map&&this.remove(),this._map=f,this.options.closeOnClick&&f.on("preclick",this._onClose),this.options.closeOnMove&&f.on("move",this._onClose),f.on("remove",this.remove),this._update(),f._addPopup(this),this._focusFirstElement(),this._trackPointer?(f.on("mousemove",this._onMouseEvent),f.on("mouseup",this._onMouseEvent),f._canvasContainer.classList.add("mapboxgl-track-pointer")):f.on("move",this._update),this.fire(new u.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const f=this._map;return f&&(f.off("move",this._update),f.off("move",this._onClose),f.off("preclick",this._onClose),f.off("click",this._onClose),f.off("remove",this.remove),f.off("mousemove",this._onMouseEvent),f.off("mouseup",this._onMouseEvent),f.off("drag",this._onMouseEvent),f._canvasContainer&&f._canvasContainer.classList.remove("mapboxgl-track-pointer"),f._removePopup(this),this._map=void 0),this.fire(new u.A("close")),this}getLngLat(){return this._lngLat}setLngLat(f){this._lngLat=u.ci.convert(f),this._pos=null,this._trackPointer=!1,this._update();const r=this._map;return r&&(r.on("move",this._update),r.off("mousemove",this._onMouseEvent),r._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(f){return this._altitude=f,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const f=this._map;return f&&(f.off("move",this._update),f.on("mousemove",this._onMouseEvent),f.on("drag",this._onMouseEvent),f._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(f){return this.setDOMContent(document.createTextNode(f))}setHTML(f){const r=document.createDocumentFragment(),l=document.createElement("body");let p;for(l.innerHTML=f;p=l.firstChild,p;)r.appendChild(p);return this.setDOMContent(r)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(f){return this.options.maxWidth=f,this._update(),this}setDOMContent(f){let r=this._content;if(r)for(;r.hasChildNodes();)r.firstChild&&r.removeChild(r.firstChild);else r=this._content=fn("div","mapboxgl-popup-content",this._container||void 0);if(r.appendChild(f),this.options.closeButton){const l=this._closeButton=fn("button","mapboxgl-popup-close-button",r);l.type="button",l.setAttribute("aria-label","Close popup"),l.innerHTML='<span aria-hidden="true">&#215;</span>',l.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(f){return this._classList.add(f),this._updateClassList(),this}removeClassName(f){return this._classList.delete(f),this._updateClassList(),this}setOffset(f){return this.options.offset=f,this._update(),this}toggleClassName(f){let r;return this._classList.delete(f)?r=!1:(this._classList.add(f),r=!0),this._updateClassList(),r}_onMouseEvent(f){this._update(f.point)}_getAnchor(f){if(this.options.anchor)return this.options.anchor;const r=this._map,l=this._container,p=this._pos;if(!r||!l||!p)return"bottom";const _=l.offsetWidth,v=l.offsetHeight,b=p.x<_/2,S=p.x>r.transform.width-_/2;if(p.y+f<v)return b?"top-left":S?"top-right":"top";if(p.y>r.transform.height-v){if(b)return"bottom-left";if(S)return"bottom-right"}return b?"left":S?"right":"bottom"}_updateClassList(){const f=this._container;if(!f)return;const r=[...this._classList];r.push("mapboxgl-popup"),this._anchor&&r.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&r.push("mapboxgl-popup-track-pointer"),f.className=r.join(" ")}_update(f){const r=this._map,l=this._content;if(!r||!this._lngLat&&!this._trackPointer||!l)return;let p=this._container;if(p||(p=this._container=fn("div","mapboxgl-popup",r.getContainer()),this._tip=fn("div","mapboxgl-popup-tip",p),p.appendChild(l)),this.options.maxWidth&&p.style.maxWidth!==this.options.maxWidth&&(p.style.maxWidth=this.options.maxWidth),r.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=ss(this._lngLat,this._pos,r.transform)),!this._trackPointer||f){const _=this._pos=this._trackPointer&&f instanceof u.P?f:r.project(this._lngLat,this._altitude),v=Po(this.options.offset),b=this._anchor=this._getAnchor(v.y),S=Po(this.options.offset,b),I=_.add(S).round();r._requestDomTask(()=>{this._container&&b&&(this._container.style.transform=`${oo[b]} translate(${I.x}px,${I.y}px)`)})}if(!this._marker&&r._showingGlobe()){const _=u.eW(r.transform,this._lngLat)?0:1;this._setOpacity(_)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const f=this._container.querySelector(u_);f&&f.focus()}_onClose(){this.remove()}_setOpacity(f){this._container&&(this._container.style.opacity=`${f}`),this._content&&(this._content.style.pointerEvents=f?"auto":"none")}},Marker:ws,Style:Ls,LngLat:u.ci,LngLatBounds:u.aG,Point:u.P,MercatorCoordinate:u.ac,FreeCameraOptions:Ud,Evented:u.E,config:u.e,prewarm:u.e_,clearPrewarmedResources:u.eZ,get accessToken(){return u.e.ACCESS_TOKEN},set accessToken(f){u.e.ACCESS_TOKEN=f},get baseApiUrl(){return u.e.API_URL},set baseApiUrl(f){u.e.API_URL=f},get workerCount(){return u.f7.workerCount},set workerCount(f){u.f7.workerCount=f},get maxParallelImageRequests(){return u.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(f){u.e.MAX_PARALLEL_IMAGE_REQUESTS=f},clearStorage(f){u.f6(f)},get workerUrl(){return u.f5.workerUrl},set workerUrl(f){u.f5.workerUrl=f},get workerClass(){return u.f5.workerClass},set workerClass(f){u.f5.workerClass=f},get workerParams(){return u.f5.workerParams},set workerParams(f){u.f5.workerParams=f},get dracoUrl(){return u.f4()},set dracoUrl(f){u.f3(f)},get meshoptUrl(){return u.f2()},set meshoptUrl(f){u.f1(f)},setNow:u.q.setNow,restoreNow:u.q.restoreNow}}),Yi}()}},ev=>{ev(ev.s=129)}]);